<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png"><link rel="mask-icon" href="/images/favicon/favicon.ico" color="#222"><meta name="google-site-verification" content="LMcddVW6xLBS7X1htGQ3duOIEmVp4ljku8sd3UuIcBg"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Sans+KR:300,300italic,400,400italic,700,700italic%7CPretendard-Bold:300,300italic,400,400italic,700,700italic%7CPretendard-Medium:300,300italic,400,400italic,700,700italic%7CJetbrains+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-loading-bar.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"kdevkr.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.13.2","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"width":240,"scrollpercent":true,"b2t":true},"copycode":{"enable":false,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script><meta name="description" content="안녕하세요 Mambo 입니다. 이번 글의 주제는 쿠버네티스 클러스터 구성하기입니다. IT 인프라에 대한 전문 인력이 아닌 일반 개발자가 컨테이너 환경을 위한 쿠버네티스 클러스터를 이해하고 구성하기까지는 생각보다 많은 시간이 소요되는 것 같습니다. 단순히 도커를 사용하여 컨테이너를 실행하는 것은 어렵지 않아서 도커 컴포즈 문서를 정의해서 여러가지 인스턴스를"><meta property="og:type" content="website"><meta property="og:title" content="쿠버네티스 클러스터 구성하기"><meta property="og:url" content="https://kdevkr.github.io/archive/setup-kubernetes-cluster.html"><meta property="og:site_name" content="Mambo"><meta property="og:description" content="안녕하세요 Mambo 입니다. 이번 글의 주제는 쿠버네티스 클러스터 구성하기입니다. IT 인프라에 대한 전문 인력이 아닌 일반 개발자가 컨테이너 환경을 위한 쿠버네티스 클러스터를 이해하고 구성하기까지는 생각보다 많은 시간이 소요되는 것 같습니다. 단순히 도커를 사용하여 컨테이너를 실행하는 것은 어렵지 않아서 도커 컴포즈 문서를 정의해서 여러가지 인스턴스를"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://kdevkr.github.io/images/posts/setup-kubernetes-cluster/setup-kubernetes-cluster-01.png"><meta property="og:image" content="https://kdevkr.github.io/images/posts/setup-kubernetes-cluster/setup-kubernetes-cluster-02.png"><meta property="og:image" content="https://kdevkr.github.io/images/posts/setup-kubernetes-cluster/setup-kubernetes-cluster-03.png"><meta property="og:image" content="https://kdevkr.github.io/images/posts/setup-kubernetes-cluster/control-kubernetes-cluster-03.png"><meta property="og:image" content="https://kdevkr.github.io/images/posts/setup-kubernetes-cluster/control-kubernetes-cluster-04.png"><meta property="og:image" content="https://kdevkr.github.io/images/posts/setup-kubernetes-cluster/control-kubernetes-cluster-05.png"><meta property="og:image" content="https://kdevkr.github.io/images/posts/setup-kubernetes-cluster/control-kubernetes-cluster-06.png"><meta property="og:image" content="https://kdevkr.github.io/images/posts/setup-kubernetes-cluster/control-kubernetes-cluster-07.png"><meta property="og:image" content="https://kdevkr.github.io/images/posts/setup-kubernetes-cluster/access-kubernetes-dashboard-02.png"><meta property="og:image" content="https://kdevkr.github.io/images/posts/setup-kubernetes-cluster/access-kubernetes-dashboard-01.png"><meta property="og:image" content="https://kdevkr.github.io/images/posts/setup-kubernetes-cluster/access-kubernetes-dashboard-02.png"><meta property="og:image" content="https://kdevkr.github.io/images/posts/setup-kubernetes-cluster/access-kubernetes-dashboard-03.png"><meta property="og:image" content="https://kdevkr.github.io/images/posts/setup-kubernetes-cluster/access-kubernetes-dashboard-04.png"><meta property="og:image" content="https://kdevkr.github.io/images/posts/setup-kubernetes-cluster/access-kubernetes-dashboard-05.png"><meta property="og:image" content="https://kdevkr.github.io/images/posts/setup-kubernetes-cluster/access-kubernetes-dashboard-06.png"><meta property="article:published_time" content="2021-07-26T15:00:00.000Z"><meta property="article:modified_time" content="2024-08-09T15:01:37.948Z"><meta property="article:author" content="Mambo"><meta property="article:tag" content="Kubernetes"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://kdevkr.github.io/images/posts/setup-kubernetes-cluster/setup-kubernetes-cluster-01.png"><link rel="canonical" href="https://kdevkr.github.io/archive/setup-kubernetes-cluster"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":false,"lang":"en","comments":true,"permalink":"https://kdevkr.github.io/archive/setup-kubernetes-cluster.html","path":"archive/setup-kubernetes-cluster.html","title":"쿠버네티스 클러스터 구성하기"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>쿠버네티스 클러스터 구성하기 | Mambo</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-V8LF04VMBF"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-V8LF04VMBF","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="Mambo" type="application/atom+xml">
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope itemtype="http://schema.org/WebPage"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Mambo</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Today I Learned 🔥</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fas fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fas fa-archive fa-fw"></i>Archives<span class="badge">154</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fas fa-user fa-fw"></i>About</a></li></ul></nav></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0"><span class="nav-number">1.</span> <span class="nav-text">쿠버네티스 클러스터</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EA%B5%AC%EC%84%B1%EC%9D%98-%EC%96%B4%EB%A0%A4%EC%9B%80"><span class="nav-number">1.1.</span> <span class="nav-text">클러스터 구성의 어려움</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EB%B0%B0%ED%8F%AC-%EB%8F%84%EA%B5%AC"><span class="nav-number">1.2.</span> <span class="nav-text">쿠버네티스 클러스터 배포 도구</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88-%EC%9D%B8%ED%94%84%EB%9D%BC-%ED%99%98%EA%B2%BD%EC%9D%98-%EA%B0%80%EC%9A%A9%EC%84%B1"><span class="nav-number">1.3.</span> <span class="nav-text">컨테이너 인프라 환경의 가용성</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-DNS-%EC%84%9C%EB%B2%84"><span class="nav-number">1.4.</span> <span class="nav-text">쿠버네티스 클러스터 DNS 서버</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0"><span class="nav-number">2.</span> <span class="nav-text">쿠버네티스 클러스터 시작하기</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EA%B5%AC%EC%84%B1-%ED%98%B8%EC%8A%A4%ED%8A%B8%EC%97%90-%EB%8C%80%ED%95%9C-%EC%82%AC%EC%A0%84-%EC%9E%91%EC%97%85"><span class="nav-number">2.1.</span> <span class="nav-text">클러스터 구성 호스트에 대한 사전 작업</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EC%BB%A8%ED%8A%B8%EB%A1%A4-%ED%94%8C%EB%A0%88%EC%9D%B8-%EB%85%B8%EB%93%9C-%EC%B4%88%EA%B8%B0%ED%99%94"><span class="nav-number">2.2.</span> <span class="nav-text">컨트롤 플레인 노드 초기화</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%ED%94%8C%EB%9F%AC%EA%B7%B8%EC%9D%B8-%EC%84%A4%EC%B9%98"><span class="nav-number">2.3.</span> <span class="nav-text">네트워크 플러그인 설치</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EC%9B%8C%EC%BB%A4-%EB%85%B8%EB%93%9C-%EC%B6%94%EA%B0%80"><span class="nav-number">2.4.</span> <span class="nav-text">쿠버네티스 클러스터 워커 노드 추가</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EC%A0%9C%EC%96%B4%ED%95%98%EA%B8%B0"><span class="nav-number">3.</span> <span class="nav-text">쿠버네티스 클러스터 제어하기</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EC%99%B8%EB%B6%80-%ED%98%B8%EC%8A%A4%ED%8A%B8%EB%A5%BC-%EC%9C%84%ED%95%9C-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EC%A0%91%EA%B7%BC-%EA%B5%AC%EC%84%B1-%ED%8C%8C%EC%9D%BC-%EC%A0%95%EC%9D%98"><span class="nav-number">3.1.</span> <span class="nav-text">외부 호스트를 위한 클러스터 접근 구성 파일 정의</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EC%99%B8%EB%B6%80-%ED%98%B8%EC%8A%A4%ED%8A%B8%EB%A5%BC-%EC%9C%84%ED%95%9C-%EC%82%AC%EC%9A%A9%EC%9E%90-%EB%B0%8F-%EC%9D%B8%EC%A6%9D%EC%84%9C-%EB%B0%9C%ED%96%89"><span class="nav-number">3.2.</span> <span class="nav-text">외부 호스트를 위한 사용자 및 인증서 발행</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EA%B4%80%EB%A6%AC%ED%95%98%EA%B8%B0"><span class="nav-number">4.</span> <span class="nav-text">쿠버네티스 클러스터 관리하기</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EC%9D%B8%EC%A6%9D%EC%84%9C-%EA%B0%B1%EC%8B%A0%ED%95%98%EA%B8%B0"><span class="nav-number">4.1.</span> <span class="nav-text">클러스터 인증서 갱신하기</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EC%9D%B8%EC%A6%9D%EC%84%9C-%EB%A7%8C%EB%A3%8C%EC%9D%BC%EC%9E%90-%EC%A1%B0%ED%9A%8C%ED%95%98%EA%B8%B0"><span class="nav-number">4.2.</span> <span class="nav-text">클러스터 인증서 만료일자 조회하기</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EC%9D%B8%EC%A6%9D%EC%84%9C-%EC%88%98%EB%8F%99-%EA%B0%B1%EC%8B%A0"><span class="nav-number">4.3.</span> <span class="nav-text">클러스터 인증서 수동 갱신</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%EB%8C%80%EC%8B%9C%EB%B3%B4%EB%93%9C-%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0"><span class="nav-number">5.</span> <span class="nav-text">쿠버네티스 대시보드 설치하기</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%EB%8C%80%EC%8B%9C%EB%B3%B4%EB%93%9C-%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%9C%A0%ED%98%95-%EB%B3%80%EA%B2%BD%ED%95%98%EA%B8%B0"><span class="nav-number">5.1.</span> <span class="nav-text">쿠버네티스 대시보드 서비스 유형 변경하기</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%EB%8C%80%EC%8B%9C%EB%B3%B4%EB%93%9C-%EB%A1%9C%EA%B7%B8%EC%9D%B8%ED%95%98%EA%B8%B0"><span class="nav-number">5.2.</span> <span class="nav-text">쿠버네티스 대시보드 로그인하기</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%EB%8C%80%EC%8B%9C%EB%B3%B4%EB%93%9C%EC%97%90%EC%84%9C-%EB%A7%A4%ED%8A%B8%EB%A6%AD-%EC%84%9C%EB%B2%84-%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0"><span class="nav-number">5.3.</span> <span class="nav-text">쿠버네티스 대시보드에서 매트릭 서버 설치하기</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Mambo" src="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4"><p class="site-author-name" itemprop="name">Mambo</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">154</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-tags"><span class="site-state-item-count">239</span> <span class="site-state-item-name">tags</span></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/kdevkr" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kdevkr" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:kdevkr@gmail.com" title="E-Mail → mailto:kdevkr@gmail.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a></span></div><div class="cc-license site-overview-item animated" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ko" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div><div class="back-to-top animated" role="button" aria-label="Back to top"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div class="sidebar-dimmer"></div></header><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner page posts-expand"><div class="post-block" lang="en"><header class="post-header"><h1 class="post-title" itemprop="name headline">쿠버네티스 클러스터 구성하기</h1><div class="post-meta-container"></div></header><div class="post-body"><p>안녕하세요 Mambo 입니다.</p><p>이번 글의 주제는 <strong>쿠버네티스 클러스터 구성하기</strong>입니다. IT 인프라에 대한 전문 인력이 아닌 일반 개발자가 컨테이너 환경을 위한 쿠버네티스 클러스터를 이해하고 구성하기까지는 생각보다 많은 시간이 소요되는 것 같습니다. 단순히 도커를 사용하여 컨테이너를 실행하는 것은 어렵지 않아서 도커 컴포즈 문서를 정의해서 여러가지 인스턴스를 별다른 설정없이 간단하게 실행해왔습니다. 하지만, 애플리케이션을 배포하고 운영하기 위하여 컨테이너 인프라 환경을 쿠버네티스 클러스터로 구성하는 것은 IT 인프라에 대한 전문 지식이 필요합니다.</p><p>현재 다니고 있는 회사의 소속팀에서는 애플리케이션을 아마존 웹 서비스의 빈스톡(Beanstalk)을 사용하여 배포하고 운영하기 때문에 컨테이너 환경의 쿠버네티스 클러스터에 대한 학습이 필요하진 않았습니다.</p><blockquote><p>물론, 쿠버네티스 클러스터 도입을 시도하긴 했습니다만… 현재 애플리케이션 규모 상 배보다 배꼽이 더 크다는 결과를 가진다고 판단하여 도입을 취소했습니다.</p></blockquote><p>그러나 2021년 클라우드 플래그십 프로젝트 중 에너지 분야에 참여함으로써 현재 운영중인 애플리케이션을 클라우드 환경에서 컨테이너 환경으로 배포하고 운영하기 위하여 모놀리식 아키텍처로 개발된 애플리케이션의 일정 부분을 마이크로서비스 아키텍처로 변경하여 기능적으로 분리하는 작업을 진행중입니다. 이렇게 마이크로서비스 아키텍처로 분리되는 애플리케이션들은 나무기술의 <strong>칵테일 클라우드</strong>라고하는 PaaS를 통해 배포되고 운영될 예정입니다.</p><p>쿠버네티스 클러스터를 직접 구성하여 운영 및 관리를 수행하는 것은 아니지만 쿠버네티스 클러스터 기반의 컨테이너 인프라 환경을 이해하기 위해 쿠버네티스 클러스터를 직접 구성해보고 간단한 애플리케이션을 배포해보는 것을 학습하고 이 글을 통해 공유하고자합니다.</p><h2 id="쿠버네티스-클러스터"><a href="#쿠버네티스-클러스터" class="headerlink" title="쿠버네티스 클러스터"></a>쿠버네티스 클러스터</h2><p>쿠버네티스는 분산형 코디네이터인 주키퍼처럼 다수의 호스트가 서로 통신하여 클러스터를 구성하게되며 컨트롤 플레인 노드의 API 서버가 동작하게 되는 마스터 노드와 컨테이너를 실행하는 환경이 되는 워커 노드로 구분됩니다. 우리는 워커 노드와는 통신할 필요가 없으며 마스터 노드의 API 서버와 통신하여 클러스터를 제어하고 애플리케이션을 배포하게됩니다.</p><h3 id="클러스터-구성의-어려움"><a href="#클러스터-구성의-어려움" class="headerlink" title="클러스터 구성의 어려움"></a>클러스터 구성의 어려움</h3><p>쿠버네티스 클러스터를 구성하는게 어려운 이유는 IT 인프라 지식 뿐만 아니라 클러스터 구성을 위해 여러가지 오픈소스 기술이 사용된다는 점입니다. 쿠버네티스 클러스터 구성에 대한 서비스를 PaaS로 제공하는 <a target="_blank" rel="noopener" href="https://paas-ta.kr/intro/guideInstall">파스-타(PaaS-TA)</a> 또는 <a target="_blank" rel="noopener" href="https://www.cocktailcloud.io/main.do">칵테일 클라우드</a>도 <strong>kubespray, istio</strong> 등 여러가지 오픈소스를 결합한 솔루션을 만들어 제공하는 것입니다. 또한, 쿠버네티스 클러스터 운영 관리의 어려움으로 인하여 쿠버네티스 클러스터를 쉽게 구성하고 관리할 수 있는 AWS의 <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html">Amazon EKS</a> 또는 구글 클라우드 플랫폼의 GKE와 같이 클라우드 서비스에서 쉽게 쿠버네티스 클러스터를 구성할 수 있는 서비스를 제공하는 이유이기도 합니다.</p><h3 id="쿠버네티스-클러스터-배포-도구"><a href="#쿠버네티스-클러스터-배포-도구" class="headerlink" title="쿠버네티스 클러스터 배포 도구"></a>쿠버네티스 클러스터 배포 도구</h3><p>쿠버네티스 클러스터를 구성할 수 있는 도구는 <strong>kubeadm, kops, kubespray</strong> 뿐만 아니라 IoT를 목적으로 경량화된 클러스터 구성을 목적으로하는 <a target="_blank" rel="noopener" href="https://k3s.io/">k3s</a>, <a target="_blank" rel="noopener" href="https://microk8s.io/">MicroK8s</a>등 여러가지 오픈소스가 존재합니다. 저는 쿠버네티스 공식 문서에서도 가이드를 제공하고 온-프레미스 환경에서 일반적으로 많이 사용될 수 있는 기본적인 배포 도구인 <code>kubeadm</code>을 사용하여 쿠버네티스 클러스터를 구성하겠습니다.</p><blockquote><p>본 글에서는 쿠버네티스 클러스터를 데비안 계열의 배포판인 우분투 리눅스를 사용합니다.</p></blockquote><pre class="language-bash" data-language="bash"><div class="caption"><span>우분투 kubeadm 패키지 설치</span></div><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> apt-transport-https ca-certificates <span class="token function">curl</span>

<span class="token function">sudo</span> <span class="token function">curl</span> <span class="token parameter variable">-fsSLo</span> /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
<span class="token builtin class-name">echo</span> <span class="token string">"deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/kubernetes.list

<span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> kubelet kubeadm kubectl
<span class="token function">sudo</span> apt-mark hold kubelet kubeadm kubectl</code></pre><p>위 명령어에 의해 설치된 패키지는 다음의 역할을 수행하게 되며 클러스터를 구성하는 모든 호스트에 설치해야합니다.</p><table><thead><tr><th>패키지</th><th>용도</th></tr></thead><tbody><tr><td>kubeadm</td><td>쿠버네티스 클러스터 배포</td></tr><tr><td>kubelet</td><td>컨트롤 플레인 노드와 통신하여 컨테이너가 파드에 실행될 수 있도록 도와주는 에이전트</td></tr><tr><td>kubectl</td><td>쿠버네티스 클러스터에 명령을 내리기 위해 사용하는 CLI</td></tr></tbody></table><blockquote><p>본 글에서는 최신 버전의 <strong>쿠버네티스 클러스터 1.21+</strong> 를 사용합니다.<br>쿠버네티스 클러스터를 안정적으로 유지하기 위하여 주기적으로 쿠버네티스 클러스터의 버전을 업그레이드하는 것을 권장한다고 합니다.</p></blockquote><h3 id="컨테이너-인프라-환경의-가용성"><a href="#컨테이너-인프라-환경의-가용성" class="headerlink" title="컨테이너 인프라 환경의 가용성"></a>컨테이너 인프라 환경의 가용성</h3><p>쿠버네티스 클러스터 구성 가이드에 따르면 클러스터를 구성하게 되는 모든 호스트가 컨테이너 인프라 환경을 구성할 수 있는지 가용성을 확인해야합니다. 따라서, 이미 사용하고 있는 호스트 보다는 쿠버네티스 클러스터를 구성을 위한 별도의 호스트를 사용하는게 좋습니다.</p><h4 id="메모리-스왑-기능-비활성화"><a href="#메모리-스왑-기능-비활성화" class="headerlink" title="메모리 스왑 기능 비활성화"></a>메모리 스왑 기능 비활성화</h4><p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/enhancements/issues/2400">Node swap support</a>와 같이 쿠버네티스 클러스터에서 스왑 기능을 활성화하기 위한 작업을 진행중이지만 현재로선 <strong>kubelet</strong>이 정상적으로 동작하기 위해서는 반드시 우분투 리눅스의 메모리 스왑 기능을 비활성화 해야합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>우분투 메모리 스왑 비활성화</span></div><code class="language-bash"><span class="token function">sudo</span> swapoff <span class="token parameter variable">-a</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'/ swap / s/^\(.*\)$/#\1/g'</span> /etc/fstab</code></pre><h4 id="클러스터-노드의-고유-주소-확인"><a href="#클러스터-노드의-고유-주소-확인" class="headerlink" title="클러스터 노드의 고유 주소 확인"></a>클러스터 노드의 고유 주소 확인</h4><p>쿠버네티스 클러스터를 구성하는 호스트들이 서로 통신할 수 있도록 네트워크 환경에서 고유한 주소를 가지고 있는지 확인해야합니다. 쿠버네티스 클러스터에서는 각 노드를 <strong>호스트의 MAC 주소</strong> 및 <strong>product_uuid</strong>를 기준으로 구분한다고 합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>MAC 주소 및 product_uuid 조회</span></div><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> net-tools
<span class="token function">sudo</span> <span class="token function">ifconfig</span> <span class="token parameter variable">-a</span>
<span class="token function">sudo</span> <span class="token function">cat</span> /sys/class/dmi/id/product_uuid</code></pre><p>그리고 쿠버네티스 클러스터를 구성하는 호스트의 역할에 맞게 사용해야될 포트를 점유하고 있는지 확인해야합니다.</p><p><img data-src="/images/posts/setup-kubernetes-cluster/setup-kubernetes-cluster-01.png"></p><h4 id="컨테이너-런타임-선택하기"><a href="#컨테이너-런타임-선택하기" class="headerlink" title="컨테이너 런타임 선택하기"></a>컨테이너 런타임 선택하기</h4><p>쿠버네티스 클러스터에서 파드 안에 컨테이너를 실행하기 위해 사용하게 될 컨테이너 런타임을 선택하고 설치해야합니다. 쿠버네티스 클러스터를 구성하는 많은 글에서 도커를 컨테이너 런타임으로 사용하는 것으로 소개하고있지만 앞으로 최신 쿠버네티스 클러스터 버전에서는 <a target="_blank" rel="noopener" href="https://kubernetes.io/blog/2020/12/02/dont-panic-kubernetes-and-docker/">컨테이너 런타임 인터페이스를 준수하지 않는 도커</a>를 컨테이너 런타임으로 지원하지 않을 예정입니다. 따라서, 저는 <a target="_blank" rel="noopener" href="https://cri-o.io/">CRI-O</a>를 컨테이너 런타임으로 선택하고 설치하겠습니다.</p><p>CRI-O를 설치하기 전에 우분투의 iptables가 브릿지된 트래픽을 바라보도록 설정해야합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>오버레이 네트워크 및 iptables 브릿지 트래픽 활성화</span></div><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/modules-load.d/crio.conf</span>
overlay
br_netfilter
EOF</span>

<span class="token function">sudo</span> modprobe overlay
<span class="token function">sudo</span> modprobe br_netfilter

<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/sysctl.d/99-kubernetes-cri.conf</span>
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF</span>

<span class="token function">sudo</span> <span class="token function">sysctl</span> <span class="token parameter variable">--system</span></code></pre><p>위 작업이 완료되었다면 다음의 명령어로 CRI-O 관련 패키지를 설치합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>CRI-O 관련 패키지 설치</span></div><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_20.04/ /"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list
<span class="token builtin class-name">echo</span> <span class="token string">"deb http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/1.21/xUbuntu_20.04/ /"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/devel:kubic:libcontainers:stable:cri-o:1.21.list

<span class="token function">curl</span> <span class="token parameter variable">-L</span> https://download.opensuse.org/repositories/devel:kubic:libcontainers:stable:cri-o:1.21/xUbuntu_20.04/Release.key <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -
<span class="token function">curl</span> <span class="token parameter variable">-L</span> https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_20.04/Release.key <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -

<span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> cri-o cri-o-runc
<span class="token function">sudo</span> apt-mark hold cri-o cri-o-runc
<span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> crio <span class="token parameter variable">--now</span></code></pre><h4 id="파드-네트워크-플러그인-결정하기"><a href="#파드-네트워크-플러그인-결정하기" class="headerlink" title="파드 네트워크 플러그인 결정하기"></a>파드 네트워크 플러그인 결정하기</h4><p>쿠버네티스 클러스터에 실행되는 파드에서 컨테이너 간 통신을 위해서 <a target="_blank" rel="noopener" href="https://github.com/containernetworking/cni">컨테이너 네트워크 인터페이스(CNI)</a>를 사용하게 됩니다. 다양한 CNI 오픈소스 중에서 파드 네트워크 플러그인을 선택해야하며 파드 네트워크 플러그인에 따라 쿠버네티스 클러스터를 시작할 때 CIDR 블록을 지정해야할 수 있습니다.</p><p>예를 들어, <a target="_blank" rel="noopener" href="https://github.com/flannel-io/flannel">플라넬(Flannel)</a>을 CNI로 사용하는 경우 쿠버네티스 클러스터 시작 시 <strong>10.244.0.0&#x2F;16</strong>를 파드 네트워크 CIDR 블록으로 지정해야합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>플라넬을 파드 네트워크 플러그인으로 사용하는 클러스터 시작 예시</span></div><code class="language-bash"><span class="token function">sudo</span> kubeadm init --pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16
<span class="token function">sudo</span> kubectl apply <span class="token parameter variable">-f</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</code></pre><h4 id="네트워크-정책-플러그인"><a href="#네트워크-정책-플러그인" class="headerlink" title="네트워크 정책 플러그인"></a>네트워크 정책 플러그인</h4><p>파드 네트워크 플러그인으로 결정한 <strong>플라넬</strong>이라는 CNI는 네트워크 정책 기능을 포함하고 있지 않는 순수하게 네트워크 통신을 목적으로 만들어진 오픈소스입니다. 만약, 우리의 쿠버네티스 클러스터의 파드에 대한 트래픽 제어를 위해서 인그레스 또는 이그레스와 같은 기능을 적용해야한다면 <strong>네트워크 정책</strong> 기능이 포함된 플러그인을 파드 네트워크 플러그인으로 사용해야합니다.</p><p>일반적으로 구현 방식의 차이가 있지만 다음과 같은 네트워크 정책을 포함하는 플러그인을 사용합니다.</p><ul><li><a target="_blank" rel="noopener" href="https://github.com/antrea-io/antrea">Antrea</a></li><li><a target="_blank" rel="noopener" href="https://github.com/projectcalico/calico">Calico</a></li><li><a target="_blank" rel="noopener" href="https://github.com/weaveworks/weave">Weave Net</a></li><li><a target="_blank" rel="noopener" href="https://docs.projectcalico.org/getting-started/kubernetes/flannel/flannel">Canal</a></li></ul><p>예를 들어, 플라넬을 CNI로 사용하고 싶다면 캘리코(Calico)를 네트워크 정책 공급자로 사용할 수 있는 <strong>카날(Canal)</strong> 을 선택하면 됩니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>카날을 사용하는 클러스터 시작 예시</span></div><code class="language-bash"><span class="token function">sudo</span> kubeadm init --pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16
<span class="token function">sudo</span> kubectl apply <span class="token parameter variable">-f</span> https://docs.projectcalico.org/manifests/canal.yaml</code></pre><blockquote><p>카날은 플라넬을 CNI로 사용하므로 플라넬의 파드 네트워크 CIDR 블록을 지정합니다.</p></blockquote><h3 id="쿠버네티스-클러스터-DNS-서버"><a href="#쿠버네티스-클러스터-DNS-서버" class="headerlink" title="쿠버네티스 클러스터 DNS 서버"></a>쿠버네티스 클러스터 DNS 서버</h3><p>쿠버네티스 클러스터에 서비스 디스커버리를 적용하기 위하여 DNS 서버를 설치해야합니다. 쿠버네티스 클러스터 1.11+ 부터는 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/dns">kube-dns</a> 보다는 <a target="_blank" rel="noopener" href="https://coredns.io/">CoreDNS</a>을 권장하고 우리가 클러스터 시작 시 사용하게 될 kubeadm은 기본적으로 <strong>CoreDNS</strong>를 포함하고 있습니다. 기본적으로 포함되는 CoreDNS는 <strong>대기 상태</strong>에 있다가 우리가 쿠버네티스 클러스터에 파드 네트워크 플러그인을 설치하면 자동으로 실행됩니다.</p><h2 id="쿠버네티스-클러스터-시작하기"><a href="#쿠버네티스-클러스터-시작하기" class="headerlink" title="쿠버네티스 클러스터 시작하기"></a>쿠버네티스 클러스터 시작하기</h2><p>쿠버네티스 클러스터 구성을 위해 확인해야할 몇가지 항목에 대해서 알아보았습니다. 이제 저와 함께 쿠버네티스 클러스터를 구성할 호스트를 준비하고 쿠버네티스 배포 도구인 <strong>kubeadm</strong>을 사용하여 쿠버네티스 클러스터를 시작해보겠습니다.</p><p>먼저, 아마존 웹 서비스의 EC2 인스턴스를 <strong>우분투 20.04 LTS</strong> 로 시작하겠습니다.</p><p><img data-src="/images/posts/setup-kubernetes-cluster/setup-kubernetes-cluster-02.png"></p><p>그리고 kubeadm는 클러스터 시작을 위해 <strong>CPU 2코어 이상, 메모리 2GB 이상</strong> 을 요구하므로 t2.medium 인스턴스를 선택했습니다.</p><p><img data-src="/images/posts/setup-kubernetes-cluster/setup-kubernetes-cluster-03.png"></p><p>쿠버네티스 클러스터 구성을 위한 학습을 목적으로 하므로 <strong>마스터 노드와 함께 1개 이상의 워커 노드를 구성</strong>하기 위하여 <strong>최소 2개의 우분투 인스턴스</strong>를 준비합니다.</p><h3 id="클러스터-구성-호스트에-대한-사전-작업"><a href="#클러스터-구성-호스트에-대한-사전-작업" class="headerlink" title="클러스터 구성 호스트에 대한 사전 작업"></a>클러스터 구성 호스트에 대한 사전 작업</h3><p>우리가 준비한 우분투 인스턴스에 쿠버네티스 인프라 환경을 구성하기 위한 사전작업을 수행합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>메모리 스왑 기능 비활성화</span></div><code class="language-bash"><span class="token function">sudo</span> swapoff <span class="token parameter variable">-a</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'/ swap / s/^\(.*\)$/#\1/g'</span> /etc/fstab

<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/modules-load.d/crio.conf</span>
overlay
br_netfilter
EOF</span>

<span class="token function">sudo</span> modprobe overlay
<span class="token function">sudo</span> modprobe br_netfilter

<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/sysctl.d/99-kubernetes-cri.conf</span>
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF</span>

<span class="token function">sudo</span> <span class="token function">sysctl</span> <span class="token parameter variable">--system</span></code></pre><pre class="language-bash" data-language="bash"><div class="caption"><span>CRI-O 컨테이너 런타임 설치하기</span></div><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_20.04/ /"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list
<span class="token builtin class-name">echo</span> <span class="token string">"deb http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/1.21/xUbuntu_20.04/ /"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/devel:kubic:libcontainers:stable:cri-o:1.21.list

<span class="token function">curl</span> <span class="token parameter variable">-L</span> https://download.opensuse.org/repositories/devel:kubic:libcontainers:stable:cri-o:1.21/xUbuntu_20.04/Release.key <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -
<span class="token function">curl</span> <span class="token parameter variable">-L</span> https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_20.04/Release.key <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -

<span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> cri-o cri-o-runc
<span class="token function">sudo</span> apt-mark hold cri-o cri-o-runc
<span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> crio <span class="token parameter variable">--now</span></code></pre><h3 id="컨트롤-플레인-노드-초기화"><a href="#컨트롤-플레인-노드-초기화" class="headerlink" title="컨트롤 플레인 노드 초기화"></a>컨트롤 플레인 노드 초기화</h3><p>이제 쿠버네티스 클러스터를 시작하기 위해서 <strong>kubeadm init</strong> 명령어를 사용하여 <strong>컨트롤 플레인 노드를 초기화</strong> 합니다. 컨트롤 플레인 노드가 형성된 호스트를 <strong>마스터 노드</strong>라고 부르게 됩니다.</p><p>쿠버네티스 클러스터에서 파드 네트워크 플러그인을 플라넬을 사용할 예정이므로 컨트롤 플레인 노드 시작 시 <strong>파드 네트워크 CIDR 블록</strong>을 <code>10.244.0.0/16</code>으로 지정해야합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>컨트롤 플레인 노드를 초기화하여 클러스터 시작</span></div><code class="language-bash"><span class="token function">sudo</span> kubeadm init --pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16

<span class="token punctuation">..</span>.
Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span>

To start using your cluster, you need to run the following as a regular user:

  <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config

Alternatively, <span class="token keyword">if</span> you are the root user, you can run:

  <span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:

kubeadm <span class="token function">join</span> <span class="token number">172.31</span>.11.193:6443 <span class="token parameter variable">--token</span> oov7g6.bi85jo3kv15oeryf <span class="token punctuation">\</span>
--discovery-token-ca-cert-hash sha256:08874017445a8ddf06dde3e9e7be79097c470883f0384c046290e207ec3342bd</code></pre><p>컨트롤 플레인 노드가 성공적으로 초기화되었으니 파드 네트워크 플러그인으로 플라넬을 설치해야합니다. 플라넬을 설치하기 위해서는 쿠버네티스 클러스터를 제어하는데 사용하는 <strong>큐브컨트롤(kubectl)</strong> 에 클러스터 접근을 위한 설정을 진행해야합니다. 컨트롤 플레인 노드 초기화 시 출력된 다음의 명령어를 실행합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>큐브컨트롤에 클러스터 접근 설정</span></div><code class="language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube
<span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config</code></pre><p>위 명령어를 수행하고 나면 큐브컨트롤이 <strong>$HOME&#x2F;.kube</strong> 경로에 있는 클러스터 접근 구성파일이라고 하는 <code>kubeconfig</code>를 참조하여 클러스터에 접근하여 명령을 수행합니다. 클러스터 접근 구성파일에 대해서는 자세히 알아볼 필요가 없으므로 넘어가겠습니다.</p><p>쿠버네티스 클러스터에 실행된 모든 파드를 조회하기 위하여 다음의 명령어를 실행합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>클러스터의 모든 네임스페이스에 대한 파드 조회</span></div><code class="language-bash">kubectl get pods --all-namespaces
<span class="token punctuation">..</span>.
NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE
kube-system   coredns-558bd4d5db-b9t9v                   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          106s
kube-system   coredns-558bd4d5db-bkhc4                   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          106s
kube-system   etcd-ip-172-31-11-193                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          117s
kube-system   kube-apiserver-ip-172-31-11-193            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          117s
kube-system   kube-controller-manager-ip-172-31-11-193   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m4s
kube-system   kube-proxy-gm8tr                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>          106s
kube-system   kube-scheduler-ip-172-31-11-193            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m5s</code></pre><p>앞서 쿠버네티스 클러스터 DNS 서버 관련해서 CoreDNS는 파드 네트워크 플러그인이 설치되기까지 대기 상태에 있다고 하였습니다. 플라넬을 파드 네트워크 플러그인으로 설치하고나서 CoreDNS가 실행되는지 확인해보겠습니다.</p><h3 id="네트워크-플러그인-설치"><a href="#네트워크-플러그인-설치" class="headerlink" title="네트워크 플러그인 설치"></a>네트워크 플러그인 설치</h3><p>파드 네트워크 플러그인으로 플라넬을 사용하면서 네트워크 정책 기능을 추가하기 위해 네트워크 정책 플러그인으로 캘리코를 사용하는 카날(Canal)을 쿠버네티스 클러스터에 설치하겠습니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>카날 네트워크 플러그인 설치</span></div><code class="language-bash">kubectl apply <span class="token parameter variable">-f</span> https://docs.projectcalico.org/manifests/canal.yaml
<span class="token punctuation">..</span>.

kubectl get pods <span class="token parameter variable">-A</span>
<span class="token punctuation">..</span>.
NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE
kube-system   calico-kube-controllers-78d6f96c7b-ltz89   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          22s
kube-system   canal-2mmz5                                <span class="token number">2</span>/2     Running   <span class="token number">0</span>          23s
kube-system   coredns-558bd4d5db-t4w4s                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          94s
kube-system   coredns-558bd4d5db-wg7zg                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          94s
kube-system   etcd-ip-172-31-11-193                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          102s
kube-system   kube-apiserver-ip-172-31-11-193            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          109s
kube-system   kube-controller-manager-ip-172-31-11-193   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          102s
kube-system   kube-proxy-gmp4q                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>          93s
kube-system   kube-scheduler-ip-172-31-11-193            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          102s</code></pre><p>카날을 설치하고나서 파드 조회 명령어를 실행하니 대기중이었던 <strong>CoreDNS</strong>가 실행되었음을 확인할 수 있습니다.</p><blockquote><p>눈치채신 분들도 계시겠지만 큐브컨트롤로 모든 네임스페이스에 대해서 조회하기 위해서 사용하는 <strong>–all-namespaces</strong> 옵션 대신에 <strong>-A</strong>를 대신 사용할 수 있습니다.<br>이렇게 큐브컨트롤을 사용할 때 긴 이름을 대신할 수 있는 축약어를 지원하니 여러가지 축약 형태를 찾아보세요.</p></blockquote><h3 id="쿠버네티스-클러스터-워커-노드-추가"><a href="#쿠버네티스-클러스터-워커-노드-추가" class="headerlink" title="쿠버네티스 클러스터 워커 노드 추가"></a>쿠버네티스 클러스터 워커 노드 추가</h3><p>앞선 작업까지 수행하면 쿠버네티스 클러스터 시작이 완료되었다고 볼 수 있습니다. 이제 쿠버네티스 클러스터 구성을 완료하기 위하여 클러스터가 파드에 컨테이너를 실행하는 환경이 되는 워커 노드를 참여시켜야합니다. 쿠버네티스 클러스터에 다른 호스트를 워커 노드로 참여시키기 위해서는 컨트롤 플레인 노드를 초기화하고 나서 출력되는 다음의 명령어를 워커 노드가 될 호스트에서 실행해야합니다.</p><blockquote><p>클러스터를 구성하는 모든 호스트에 kubectl, kubelet을 설치하는 것이 이러한 이유입니다.</p></blockquote><pre class="language-bash" data-language="bash"><div class="caption"><span>쿠버네티스 클러스터에 워커 노드 참여</span></div><code class="language-bash">kubeadm <span class="token function">join</span> <span class="token number">172.31</span>.11.193:6443 <span class="token parameter variable">--token</span> oov7g6.bi85jo3kv15oeryf <span class="token punctuation">\</span>
--discovery-token-ca-cert-hash sha256:08874017445a8ddf06dde3e9e7be79097c470883f0384c046290e207ec3342bd 
<span class="token punctuation">..</span>.
This <span class="token function">node</span> has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run <span class="token string">'kubectl get nodes'</span> on the control-plane to see this <span class="token function">node</span> <span class="token function">join</span> the cluster.</code></pre><p>마지막 문장에 따라 컨트롤 플레인 노드가 있는 마스터 노드에서 <strong>kubectl get nodes</strong> 명령어를 실행해봅니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>쿠버네티스 클러스터의 노드 조회</span></div><code class="language-bash"><span class="token comment"># kubectl get [nodes/node/no]</span>
kubectl get no
<span class="token punctuation">..</span>.
NAME               STATUS   ROLES                  AGE     VERSION
ip-172-31-11-193   Ready    control-plane,master   3m18s   v1.21.3
ip-172-31-41-106   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 42s     v1.21.3</code></pre><p>저는 클러스터를 구성하는 노드를 조회하는 명령어를 축약 형태로 실행했습니다. 이렇게 큐브컨트롤로 명령어를 실행할 때 쿠버네티스 리소스를 <strong>복수형, 단수형, 축약형</strong>을 모두 사용할 수 있습니다. 이렇게 쿠버네티스 배포 도구로 클러스터를 시작하고 워커 노드를 참여시켜 쿠버네티스 클러스터 구성을 완료했습니다.</p><blockquote><p>위 명령어 수행결과에서 워커 노드에 ROLES가 없는 것이 문제가 안되지만 정확한 구분을 위해 worker를 추가하고 싶다면 다음의 명령어를 실행하시면 됩니다.</p></blockquote><pre class="language-bash" data-language="bash"><div class="caption"><span>워커 노드에 worker ROLE 레이블 추가</span></div><code class="language-bash">kubectl label <span class="token function">node</span> ip-172-31-41-106 node-role.kubernetes.io/worker<span class="token operator">=</span>worker</code></pre><h2 id="쿠버네티스-클러스터-제어하기"><a href="#쿠버네티스-클러스터-제어하기" class="headerlink" title="쿠버네티스 클러스터 제어하기"></a>쿠버네티스 클러스터 제어하기</h2><p>쿠버네티스 클러스터를 제어하기 위해서는 마스터 노드인 호스트에 접속하여 큐브컨트롤으로 명령어를 실행해야합니다. 그러나, 반드시 쿠버네티스 클러스터 제어를 위해서 마스터 노드에서 수행할 필요는 없습니다. 그 이유는 <strong>큐브컨트롤(kubectl)</strong> 이 쿠버네티스 클러스터 접근을 위해서 <strong>클러스터 접근 구성 파일(kubeconfig)</strong> 을 참조해서 클러스터에 접근하기 때문입니다.</p><p>쿠버네티스 클러스터의 마스터 노드가 아닌 <strong>로컬 컴퓨터(외부 호스트)</strong> 에서 큐브컨트롤을 사용하여 쿠버네티스 클러스터에 명령어를 실행하기 위해서 <a target="_blank" rel="noopener" href="https://kubernetes.io/ko/docs/concepts/configuration/organize-cluster-access-kubeconfig">클러스터 접근 구성 파일을 정의</a>하고 <a target="_blank" rel="noopener" href="https://kubernetes.io/ko/docs/tasks/administer-cluster/kubeadm/kubeadm-certs">쿠버네티스 클러스터에서 사용중인 인증서를 갱신</a>하는 작업을 수행해야합니다.</p><h3 id="외부-호스트를-위한-클러스터-접근-구성-파일-정의"><a href="#외부-호스트를-위한-클러스터-접근-구성-파일-정의" class="headerlink" title="외부 호스트를 위한 클러스터 접근 구성 파일 정의"></a>외부 호스트를 위한 클러스터 접근 구성 파일 정의</h3><p>먼저, 마스터 노드에서 사용중인 클러스터 접근 구성파일을 외부 호스트인 로컬 컴퓨터에 복사하여 로컬 컴퓨터에 설치된 큐브컨트롤로 쿠버네티스 클러스터에 접근할 수 있는지 확인합니다.</p><blockquote><p>마스터 노드인 호스트의 외부 아이피는 54.180.137.161 입니다.</p></blockquote><pre class="language-ps" data-language="ps"><div class="caption"><span>외부 호스트에서 클러스터 접근 구성파일 복사</span></div><code class="language-ps">mkdir .kube
scp -i .\keypair\mambo.pem ubuntu@54.180.137.161:.kube&#x2F;config .kube&#x2F;config</code></pre><p>로컬 컴퓨터에서 큐브컨트롤이 참조하는 클러스터 접근 구성정보를 조회해보면 마스터 노드에서 사용하던 클러스터 접근 구성 파일이기 때문에 클러스터의 주소가 마스터 노드의 내부 아이피인 것을 확인할 수 있습니다.</p><p><img data-src="/images/posts/setup-kubernetes-cluster/control-kubernetes-cluster-03.png" alt="클러스터 주소가 마스터 노드의 내부 아이피"></p><p>클러스터 주소를 외부 아이피로 변경하기 위해서 다음의 명령어를 수행합니다.</p><pre class="language-ps" data-language="ps"><div class="caption"><span>클러스터 접근 구성 파일의 클러스터 주소 변경</span></div><code class="language-ps">kubectl config --kubeconfig&#x3D;config set-cluster kubernetes --server&#x3D;https:&#x2F;&#x2F;54.180.137.161:6443 </code></pre><p>다시 큐브컨트롤이 참조하는 클러스터 접근 구성 정보를 조회해보면 다음과 같이 클러스터 주소가 외부 아이피로 변경된 것을 확인할 수 있습니다.</p><p><img data-src="/images/posts/setup-kubernetes-cluster/control-kubernetes-cluster-04.png" alt="외부 아이피로 변경된 클러스터 주소"></p><p>이제 로컬 컴퓨터에서 큐브컨트롤이 클러스터에 접근할 수 있게 접근 구성 파일을 정의했습니다. (수정이지만…?) 큐브컨트롤로 클러스터의 모든 네임스페이스에 대한 파드를 조회해봅니다.</p><pre class="language-ps" data-language="ps"><div class="caption"><span>외부 호스트에서 클러스터의 모든 네임스페이스에 대한 파드 조회</span></div><code class="language-ps">kubectl get po -A
...
Unable to connect to the server: x509: certificate is valid for 10.96.0.1, 172.31.6.192, not 54.180.137.16</code></pre><p>위와 같이 X509 인증서 관련 오류가 발생한 이유는 우리가 입력한 쿠버네티스 클러스터 주소인 54.180.137.161이 접근 구성 파일에 있는 인증서 정보에 포함되어있지 않기 때문입니다. 기본적으로 쿠버네티스 클러스터 시작 시 컨트롤 플레인 노드를 초기화할 때 API 서버에서 사용할 인증서를 생성하는 과정에서 내부 아이피만을 인증서에 포함시키기 때문입니다.</p><p>마스터 노드로 돌아가서 쿠버네티스 클러스터 시작 시 인증서에 외부아이피를 포함시키기 위해서 힘들게 구성하였던 클러스터를 초기화시키겠습니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>쿠버네티스 클러스터 초기화</span></div><code class="language-bash"><span class="token function">sudo</span> kubeadm reset
<span class="token function">rm</span> <span class="token environment constant">$HOME</span>/.kube/config</code></pre><p>쿠버네티스 클러스터 시작 시 외부 아이피를 API 서버에 대한 인증서에 포함하도록 <strong>--apiserver-cert-extra-sans</strong> 파라미터 옵션을 추가합니다.</p><p><img data-src="/images/posts/setup-kubernetes-cluster/control-kubernetes-cluster-05.png"></p><p>위와 같이 쿠버네티스 클러스터 시작 시 출력되는 정보를 통해 우리가 파라미터로 입력한 <strong>외부 아이피(54.180.137.161)가 인증서에 포함됨</strong> 을 확인할 수 있었습니다. 쿠버네티스 클러스터를 시작하여 컨트롤 플레인 노드가 초기화되었으면 kubeconfig 파일을 로컬 컴퓨터로 복사하고 큐브컨트롤으로 파드 조회를 시도해봅니다.</p><p><img data-src="/images/posts/setup-kubernetes-cluster/control-kubernetes-cluster-06.png"></p><p>쿠버네티스 클러스터에서 인증서에 포함된 외부 아이피를 확인하여 클러스터 접근을 허용하여 모든 네임스페이스에 대한 파드가 조회되었습니다.</p><h3 id="외부-호스트를-위한-사용자-및-인증서-발행"><a href="#외부-호스트를-위한-사용자-및-인증서-발행" class="headerlink" title="외부 호스트를 위한 사용자 및 인증서 발행"></a>외부 호스트를 위한 사용자 및 인증서 발행</h3><p>앞서 확인한 내용은 클러스터 접근 구성파일을 통해 외부 호스트에서 클러스터에 접근할 수 있는 것입니다. 그런데 우리가 마스터 노드에서 사용하던 클러스터 접근 구성파일에는 쿠버네티스 클러스터를 제어하기 위한 kubernetes-admin 사용자의 인증정보가 포함되어있습니다. 쿠버네티스 클러스터 관리 담당자는 클러스터에 대한 모든 권한을 가지는 접근 구성파일을 내보내지않고 클러스터에 접근할 수 있으며 특정 네임스페이스 권한이 부여된 사용자를 만들고 쿠버네티스 클러스터의 루트 CA 인증서를 기반으로 사용자의 인증서를 발행하여 클러스터 접근 구성 파일을 정의할 수 있게 지원하는 게 좋습니다.</p><p>쿠버네티스 클러스터에는 사용자라는 오브젝트는 없지만 인증서에 포함되는 주체를 통해 그룹과 사용자 개념을 사용해서 인증을 수행합니다. 따라서, 우리는 쿠버네티스 클러스터의 루트 CA 인증서를 기반으로 하위 인증서 발행하고 하위 인증서에 포함된 주체에 대한 RBAC 기반의 Role을 쿠버네티스 클러스터에 생성해야합니다.</p><p>먼저, 루트 CA 인증서를 기반으로 하위 인증서를 발행하기 위하여 클라우드플레어에서 만든 cfssl 설치합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>마스터 노드에 cfssl 패키지 설치</span></div><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-L</span> https://github.com/cloudflare/cfssl/releases/download/v1.5.0/cfssl_1.5.0_linux_amd64 <span class="token parameter variable">-o</span> cfssl
<span class="token function">curl</span> <span class="token parameter variable">-L</span> https://github.com/cloudflare/cfssl/releases/download/v1.5.0/cfssljson_1.5.0_linux_amd64 <span class="token parameter variable">-o</span> cfssljson
<span class="token function">curl</span> <span class="token parameter variable">-L</span> https://github.com/cloudflare/cfssl/releases/download/v1.5.0/cfssl-certinfo_1.5.0_linux_amd64 <span class="token parameter variable">-o</span> cfssl-certinfo

<span class="token function">chmod</span> +x cfssl* 
<span class="token function">sudo</span> <span class="token function">mv</span> cfssl* /usr/bin/</code></pre><p>cfssl이 설치되었으면 사용자 인증서가 발행될 폴더를 만들고나서 쿠버네티스 클러스터가 사용중인 루트 CA 인증서 파일을 복사합니다. 루트 CA 인증서 파일은 일반적으로 <strong>&#x2F;etc&#x2F;kubernetes&#x2F;pki</strong> 폴더에 있습니다.</p><p>인증서 발행을 위해 다음의 명령어를 차례대로 실행합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>인증서 발행 폴더 이동 및 쿠버네티스 클러스터 루트 CA 인증서 복사</span></div><code class="language-bash"><span class="token function">mkdir</span> cert <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> cert
<span class="token function">sudo</span> <span class="token function">cp</span> /etc/kubernetes/pki/ca* ./</code></pre><pre class="language-bash" data-language="bash"><div class="caption"><span>하위 인증서 발행 정보 및 서명 요청 정의</span></div><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">tee</span> mambo-config.json</span>
&#123;
  "signing": &#123;
    "default": &#123;
      "expiry": "8760h"
    &#125;,
    "profiles": &#123;
      "mambo": &#123;
        "usages": [
          "signing",
          "key encipherment",
          "server auth",
          "client auth"
        ],
        "expiry": "8760h"
      &#125;
    &#125;
  &#125;
&#125;
EOF</span>

<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">tee</span> mambo-csr.json</span>
&#123;
  "CN": "mambo",
  "key": &#123;
    "algo": "rsa",
    "size": 2048
  &#125;,
  "names":[
    &#123;
      "O": "system:masters"
    &#125;
  ]
&#125;
EOF</span></code></pre><pre class="language-bash" data-language="bash"><div class="caption"><span>사용자 인증서 발행</span></div><code class="language-bash"><span class="token function">sudo</span> cfssl gencert <span class="token parameter variable">-ca</span><span class="token operator">=</span>ca.crt -ca-key<span class="token operator">=</span>ca.key <span class="token parameter variable">-config</span><span class="token operator">=</span>mambo-config.json <span class="token parameter variable">-profile</span><span class="token operator">=</span>mambo mambo-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> mambo

ll
-rw-r--r-- <span class="token number">1</span> mambo mambo <span class="token number">1066</span> Jul <span class="token number">28</span> <span class="token number">15</span>:04 ca.crt
-rw------- <span class="token number">1</span> root  root  <span class="token number">1679</span> Jul <span class="token number">28</span> <span class="token number">15</span>:04 ca.key
-rw-rw-r-- <span class="token number">1</span> mambo mambo  <span class="token number">277</span> Jul <span class="token number">28</span> <span class="token number">15</span>:02 mambo-config.json
-rw-r--r-- <span class="token number">1</span> mambo mambo  <span class="token number">920</span> Jul <span class="token number">28</span> <span class="token number">15</span>:08 mambo.csr
-rw-rw-r-- <span class="token number">1</span> mambo mambo  <span class="token number">129</span> Jul <span class="token number">28</span> <span class="token number">15</span>:02 mambo-csr.json
-rw------- <span class="token number">1</span> mambo mambo <span class="token number">1675</span> Jul <span class="token number">28</span> <span class="token number">15</span>:08 mambo-key.pem
-rw-rw-r-- <span class="token number">1</span> mambo mambo <span class="token number">1204</span> Jul <span class="token number">28</span> <span class="token number">15</span>:08 mambo.pem</code></pre><p>이렇게 만들어진 인증서를 기반으로 큐브컨트롤을 사용하여 클러스터 접근 구성 파일(kubeconfig)를 정의합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>사용자 클러스터 접근 구성 파일 정의</span></div><code class="language-bash">kubectl config <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>mambo-config set-cluster kubernetes <span class="token parameter variable">--server</span><span class="token operator">=</span>https://54.180.137.161:6443 --certificate-authority<span class="token operator">=</span>ca.crt
kubectl config <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>mambo-config set-credentials mambo --client-certificate<span class="token operator">=</span>mambo.pem --client-key<span class="token operator">=</span>mambo-key.pem
kubectl config <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>mambo-config set-context kubernetes-master <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token parameter variable">--user</span><span class="token operator">=</span>mambo
kubectl config <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>mambo-config use-context kubernetes-master</code></pre><p>만들어진 클러스터 접근 구성 정보를 조회하고 파드를 조회합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>클러스터 접근 구성 정보 조회</span></div><code class="language-bash">kubectl config view <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>mambo-config
apiVersion: v1
clusters:
- cluster:
    certificate-authority: ca.crt
    server: https://54.180.137.161:6443
  name: kubernetes
contexts:
- context:
    cluster: kubernetes
    user: mambo
  name: kubernetes-master
current-context: kubernetes-master
kind: Config
preferences: <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
users:
- name: mambo
  user:
    client-certificate: mambo.pem
    client-key: mambo-key.pem</code></pre><p>우리는 mambo 사용자에 대한 Role을 쿠버네티스 클러스터에 생성하지 않았지만 파드가 조회가 가능한 이유는 인증서 발행 시 <strong>system:masters</strong> 라고 지정하였기 때문입니다. 쿠버네티스 클러스터에는 미리 정의된 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#user-facing-roles">Role</a>이 존재하는데 그 중에서 <code>system:masters</code>는 모든 권한을 가지는 사용자 그룹(cluster-admin)을 가리키게되어 mambo라는 사용자는 모든 권한을 보유한 것으로 처리된 것입니다.</p><blockquote><p>결국 mambo 라는 사용자는 모든 권한을 가지는 사용자 kubernetes-admin과 같습니다.</p></blockquote><p>우리는 모든 권한을 가지는 사용자가 아니라 특정 권한을 가지는 사용자를 만들고 인증해야하므로 기존에 만들었던 인증서를 삭제하고 특정 권한을 가지는 인증서를 다시 발행해야합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>인증서 서명 요청 파일 수정 및 인증서 재발행</span></div><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">tee</span> mambo-csr.json</span>
&#123;
  "CN": "mambo",
  "key": &#123;
    "algo": "rsa",
    "size": 2048
  &#125;,
  "names":[
    &#123;
      "O": "admin:mambo"
    &#125;
  ]
&#125;
EOF</span>

<span class="token function">sudo</span> cfssl gencert <span class="token parameter variable">-ca</span><span class="token operator">=</span>ca.crt -ca-key<span class="token operator">=</span>ca.key <span class="token parameter variable">-config</span><span class="token operator">=</span>mambo-config.json <span class="token parameter variable">-profile</span><span class="token operator">=</span>mambo mambo-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> mambo</code></pre><p>이제 다시 큐브컨트롤을 사용하여 클러스터의 파드를 조회합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>클러스터 파드 조회</span></div><code class="language-bash">kubectl get po <span class="token parameter variable">-n</span> kube-system <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>config
Error from server <span class="token punctuation">(</span>Forbidden<span class="token punctuation">)</span>: pods is forbidden: User <span class="token string">"mambo"</span> cannot list resource <span class="token string">"pods"</span> <span class="token keyword">in</span> API group <span class="token string">""</span> <span class="token keyword">in</span> the namespace <span class="token string">"kube-system"</span></code></pre><p><strong>system:masters</strong>을 지정했던것과 다르게 mambo 사용자는 kube-system 네임스페이스에 대한 파드 조회를 수행할 수 없게되었습니다. 이것은 우리가 아직 쿠버네티스 클러스터에 mambo 사용자에 대한 Role을 생성하지 않았기 때문입니다. 이제 다음과 같이 쿠버네티스 클러스터에 Mambo 사용자가 파드 조회를 위한 권한을 가지도록 Role을 생성합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>사용자 Role 및 Rolebinding 생성</span></div><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">tee</span> mambo-rbac.yaml</span>
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: kube-system
  name: mambo-rbac-role
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "watch", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  namespace: kube-system
  name: mambo-rbac-rolebinding
subjects:
- kind: User
  name: mambo
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: mambo-rbac-role
  apiGroup: rbac.authorization.k8s.io
EOF</span>

kubectl create <span class="token parameter variable">-f</span> mambo-rbac.yaml
role.rbac.authorization.k8s.io/mambo-rbac-role created
rolebinding.rbac.authorization.k8s.io/mambo-rbac-rolebinding created</code></pre><pre class="language-bash" data-language="bash"><div class="caption"><span>클러스터 파드 조회</span></div><code class="language-bash">kubectl get po <span class="token parameter variable">-n</span> kube-system <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>mambo-config
<span class="token punctuation">..</span>.
NAME                                      READY   STATUS    RESTARTS   AGE
coredns-558bd4d5db-kvfhl                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4h33m
coredns-558bd4d5db-z7kf7                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4h33m
etcd-ip-172-31-6-192                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h54m
kube-apiserver-ip-172-31-6-192            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h54m
kube-controller-manager-ip-172-31-6-192   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h54m
kube-flannel-ds-dh2xp                     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4h23m
kube-proxy-tbm76                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4h33m
kube-scheduler-ip-172-31-6-192            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h54m</code></pre><p>신규 사용자에 대한 인증서를 발행하고 Role을 만들어 사용자에게 바인딩함으로써 쿠버네티스 클러스터에 동작중인 파드를 조회할 수 있게 되었습니다.</p><h2 id="쿠버네티스-클러스터-관리하기"><a href="#쿠버네티스-클러스터-관리하기" class="headerlink" title="쿠버네티스 클러스터 관리하기"></a>쿠버네티스 클러스터 관리하기</h2><p>쿠버네티스 클러스터 시작 시 발행되는 인증서는 기본적으로 1년동안 사용할 수 있게 만료일자가 설정됩니다. 따라서, 쿠버네티스 클러스터가 시작된 지 1년이 지나게되면 쿠버네티스 클러스터 동작이 정상적이지 않을 수 있습니다. 그래서 우리는 쿠버네티스 클러스터에서 사용중인 인증서가 만료되기전에 인증서를 갱신할 수 있어야합니다.</p><h3 id="클러스터-인증서-갱신하기"><a href="#클러스터-인증서-갱신하기" class="headerlink" title="클러스터 인증서 갱신하기"></a>클러스터 인증서 갱신하기</h3><p>앞서 우리는 클러스터 외부 호스트에서 접근할 수 있도록 쿠버네티스 클러스터 시작 시 외부 아이피를 파라미터 옵션으로 추가했습니다. 하지만, 쿠버네티스 클러스터를 운영하고 있는 도중에는 클러스터를 초기화하고 다시 시작할 수 없습니다. 그래서 쿠버네티스 클러스터에서 사용중인 인증서를 다시 발행하기 위해서는 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init-phase/#cmd-phase-certs">kubeadm init phase certs</a> 명령어를 사용해야합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>Terminal</span></div><code class="language-bash"><span class="token builtin class-name">cd</span> /etc/kubernetes/pki
<span class="token comment"># 기존 인증서 삭제 또는 백업</span>
<span class="token function">sudo</span> <span class="token function">cp</span> apiserver.crt apiserver.crt.old
<span class="token function">sudo</span> <span class="token function">cp</span> apiserver.key apiserver.key.old
<span class="token function">sudo</span> <span class="token function">rm</span> apiserver.crt apiserver.key

<span class="token function">sudo</span> kubeadm init phase certs apiserver --apiserver-advertise-address<span class="token operator">=</span><span class="token number">172.31</span>.6.192 --apiserver-cert-extra-sans<span class="token operator">=</span><span class="token number">54.180</span>.137.161
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> Generating <span class="token string">"apiserver"</span> certificate and key
<span class="token punctuation">[</span>certs<span class="token punctuation">]</span> apiserver serving cert is signed <span class="token keyword">for</span> DNS names <span class="token punctuation">[</span>ip-172-31-6-192 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local<span class="token punctuation">]</span> and IPs <span class="token punctuation">[</span><span class="token number">10.96</span>.0.1 <span class="token number">172.31</span>.6.192 <span class="token number">54.180</span>.137.161<span class="token punctuation">]</span>

<span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config</code></pre><p>쿠버네티스 시작 시 수행하는 과정 중 일부를 수행하여 API 서버에 대한 인증서를 발행하면서 외부 아이피가 포함된 것을 확인할 수 있습니다.</p><p><img data-src="/images/posts/setup-kubernetes-cluster/control-kubernetes-cluster-07.png"></p><p>위와 같이 외부 호스트인 로컬 컴퓨터에서도 클러스터에 접근할 수 있게 됩니다.</p><h3 id="클러스터-인증서-만료일자-조회하기"><a href="#클러스터-인증서-만료일자-조회하기" class="headerlink" title="클러스터 인증서 만료일자 조회하기"></a>클러스터 인증서 만료일자 조회하기</h3><p>쿠버네티스 클러스터에서 사용중인 인증서를 발행할 수 있는 방법을 알았지만 인증서가 언제 만료되는지도 알아야합니다. <strong>kubeadm certs check-expiration</strong> 명령어를 사용하면 쿠버네티스 클러스터에서 사용중인 인증서의 만료일자를 조회할 수 있습니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>클러스터 인증서 만료일자 조회</span></div><code class="language-bash"><span class="token function">sudo</span> kubeadm certs check-expiration
<span class="token punctuation">[</span>check-expiration<span class="token punctuation">]</span> Reading configuration from the cluster<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>check-expiration<span class="token punctuation">]</span> FYI: You can <span class="token function">look</span> at this config <span class="token function">file</span> with <span class="token string">'kubectl -n kube-system get cm kubeadm-config -o yaml'</span>

CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:17 UTC   364d                                    no
apiserver                  Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:17 UTC   364d            ca                      no
apiserver-etcd-client      Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:17 UTC   364d            etcd-ca                 no
apiserver-kubelet-client   Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:17 UTC   364d            ca                      no
controller-manager.conf    Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:17 UTC   364d                                    no
etcd-healthcheck-client    Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:17 UTC   364d            etcd-ca                 no
etcd-peer                  Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:17 UTC   364d            etcd-ca                 no
etcd-server                Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:17 UTC   364d            etcd-ca                 no
front-proxy-client         Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:17 UTC   364d            front-proxy-ca          no
scheduler.conf             Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:17 UTC   364d                                    no

CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
ca                      Jul <span class="token number">26</span>, <span class="token number">2031</span> <span class="token number">11</span>:17 UTC   9y              no
etcd-ca                 Jul <span class="token number">26</span>, <span class="token number">2031</span> <span class="token number">11</span>:17 UTC   9y              no
front-proxy-ca          Jul <span class="token number">26</span>, <span class="token number">2031</span> <span class="token number">11</span>:17 UTC   9y              no</code></pre><h3 id="클러스터-인증서-수동-갱신"><a href="#클러스터-인증서-수동-갱신" class="headerlink" title="클러스터 인증서 수동 갱신"></a>클러스터 인증서 수동 갱신</h3><p>쿠버네티스 클러스터에서 사용중인 인증서를 갱신하는 방법에는 쿠버네티스 클러스터 버전을 업그레이드하여 자동으로 갱신되게하거나 사용중인 인증서를 수동으로 갱신하는 명령어를 실행해야합니다. <strong>kubeadm certs renew all</strong> 명령어를 실행하면 쿠버네티스 클러스터에서 사용중인 인증서를 수동으로 갱신할 수 있습니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>Terminal</span></div><code class="language-bash"><span class="token function">sudo</span> kubeadm certs renew all
<span class="token punctuation">[</span>renew<span class="token punctuation">]</span> Reading configuration from the cluster<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>renew<span class="token punctuation">]</span> FYI: You can <span class="token function">look</span> at this config <span class="token function">file</span> with <span class="token string">'kubectl -n kube-system get cm kubeadm-config -o yaml'</span>

certificate embedded <span class="token keyword">in</span> the kubeconfig <span class="token function">file</span> <span class="token keyword">for</span> the admin to use and <span class="token keyword">for</span> kubeadm itself renewed
certificate <span class="token keyword">for</span> serving the Kubernetes API renewed
certificate the apiserver uses to access etcd renewed
certificate <span class="token keyword">for</span> the API server to connect to kubelet renewed
certificate embedded <span class="token keyword">in</span> the kubeconfig <span class="token function">file</span> <span class="token keyword">for</span> the controller manager to use renewed
certificate <span class="token keyword">for</span> liveness probes to healthcheck etcd renewed
certificate <span class="token keyword">for</span> etcd nodes to communicate with each other renewed
certificate <span class="token keyword">for</span> serving etcd renewed
certificate <span class="token keyword">for</span> the front proxy client renewed
certificate embedded <span class="token keyword">in</span> the kubeconfig <span class="token function">file</span> <span class="token keyword">for</span> the scheduler manager to use renewed

Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the new certificates.</code></pre><p>마지막에 출력된 정보에 따라 갱신된 인증서를 사용할 수 있도록 kube-apiserver, kube-controller-manager, kube-scheduler, etcd 파드를 다시 실행해야하므로 큐브컨트롤을 사용하여 파드 삭제 명령을 실행하면 쿠버네티스 클러스터는 파드를 제거한 뒤 다시 실행하게 됩니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>인증서를 갱신한 파드를 삭제하여 재실행</span></div><code class="language-bash"><span class="token comment"># 삭제할 파드 조회</span>
kubectl get po <span class="token parameter variable">-n</span> kube-system
NAME                                   READY   STATUS    RESTARTS   AGE
coredns-558bd4d5db-6fqm2               <span class="token number">1</span>/1     Running   <span class="token number">0</span>          33m
coredns-558bd4d5db-kgdfs               <span class="token number">1</span>/1     Running   <span class="token number">0</span>          33m
etcd-mambo-master                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          33m
kube-apiserver-mambo-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          33m
kube-controller-manager-mambo-master   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          33m
kube-flannel-ds-g59bl                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          23m
kube-flannel-ds-nf4xt                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          23m
kube-flannel-ds-q5hkb                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          32m
kube-proxy-7j5b6                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          33m
kube-proxy-8f47j                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          23m
kube-proxy-rflgf                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          23m
kube-scheduler-mambo-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          33m

<span class="token comment"># 인증서가 갱신된 파드를 삭제</span>
kubectl delete po kube-apiserver-mambo-master kube-controller-manager-mambo-master kube-scheduler-mambo-master etcd-mambo-master <span class="token parameter variable">-n</span> kube-system
pod <span class="token string">"kube-apiserver-mambo-master"</span> deleted
pod <span class="token string">"kube-controller-manager-mambo-master"</span> deleted
pod <span class="token string">"kube-scheduler-mambo-master"</span> deleted
pod <span class="token string">"etcd-mambo-master"</span> deleted

<span class="token comment"># 삭제한 파드가 다시 실행되었는지 조회</span>
kubectl get po <span class="token parameter variable">-n</span> kube-system
NAME                                   READY   STATUS    RESTARTS   AGE
coredns-558bd4d5db-6fqm2               <span class="token number">1</span>/1     Running   <span class="token number">0</span>          38m
coredns-558bd4d5db-kgdfs               <span class="token number">1</span>/1     Running   <span class="token number">0</span>          38m
etcd-mambo-master                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11s
kube-apiserver-mambo-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11s
kube-controller-manager-mambo-master   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11s
kube-flannel-ds-g59bl                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          29m
kube-flannel-ds-nf4xt                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          29m
kube-flannel-ds-q5hkb                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          38m
kube-proxy-7j5b6                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          38m
kube-proxy-8f47j                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          29m
kube-proxy-rflgf                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          29m
kube-scheduler-mambo-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11s</code></pre><p>쿠버네티스 클러스터에서 사용중인 인증서에 대한 만료일자를 다시 조회합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>Terminal</span></div><code class="language-bash"><span class="token function">sudo</span> kubeadm certs check-expiration
<span class="token punctuation">[</span>check-expiration<span class="token punctuation">]</span> Reading configuration from the cluster<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>check-expiration<span class="token punctuation">]</span> FYI: You can <span class="token function">look</span> at this config <span class="token function">file</span> with <span class="token string">'kubectl -n kube-system get cm kubeadm-config -o yaml'</span>

CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:45 UTC   364d                                    no
apiserver                  Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:45 UTC   364d            ca                      no
apiserver-etcd-client      Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:45 UTC   364d            etcd-ca                 no
apiserver-kubelet-client   Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:45 UTC   364d            ca                      no
controller-manager.conf    Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:45 UTC   364d                                    no
etcd-healthcheck-client    Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:45 UTC   364d            etcd-ca                 no
etcd-peer                  Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:45 UTC   364d            etcd-ca                 no
etcd-server                Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:45 UTC   364d            etcd-ca                 no
front-proxy-client         Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:45 UTC   364d            front-proxy-ca          no
scheduler.conf             Jul <span class="token number">28</span>, <span class="token number">2022</span> <span class="token number">11</span>:45 UTC   364d                                    no

CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
ca                      Jul <span class="token number">26</span>, <span class="token number">2031</span> <span class="token number">11</span>:17 UTC   9y              no
etcd-ca                 Jul <span class="token number">26</span>, <span class="token number">2031</span> <span class="token number">11</span>:17 UTC   9y              no
front-proxy-ca          Jul <span class="token number">26</span>, <span class="token number">2031</span> <span class="token number">11</span>:17 UTC   9y              no</code></pre><p>쿠버네티스 클러스터의 만료일자가 갱신되었음을 확인할 수 있습니다.</p><h2 id="쿠버네티스-대시보드-설치하기"><a href="#쿠버네티스-대시보드-설치하기" class="headerlink" title="쿠버네티스 대시보드 설치하기"></a>쿠버네티스 대시보드 설치하기</h2><p>쿠버네티스 대시보드 애드온은 쿠버네티스 클러스터를 웹 UI 기반으로 제어하고 클러스터에 대한 정보를 조회하고 모니터링할 수 있는 기능을 제공합니다. 쿠버네티스 대시보드를 클러스터에 추가하기 위하여 다음의 명령어를 실행합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>쿠버네티스 대시보드 애드온 설치</span></div><code class="language-bash">kubectl create <span class="token parameter variable">-f</span> https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml
---
namespace/kubernetes-dashboard created
serviceaccount/kubernetes-dashboard created
service/kubernetes-dashboard created
secret/kubernetes-dashboard-certs created
secret/kubernetes-dashboard-csrf created
secret/kubernetes-dashboard-key-holder created
configmap/kubernetes-dashboard-settings created
role.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created
rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
deployment.apps/kubernetes-dashboard created
service/dashboard-metrics-scraper created
deployment.apps/dashboard-metrics-scraper created

kubectl get deploy <span class="token parameter variable">-n</span> kubernetes-dashboard
---
NAME                        READY   UP-TO-DATE   AVAILABLE   AGE
dashboard-metrics-scraper   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           24s
kubernetes-dashboard        <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           24s</code></pre><p>쿠버네티스 대시보드를 설치했지만 서비스를 조회해보면 다음과 같이 <strong>ClusterIP</strong> 유형인 것을 확인할 수 있습니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>쿠버네티스 대시보드 서비스 조회</span></div><code class="language-bash">kubectl get svc <span class="token parameter variable">-n</span> kubernetes-dashboard
NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
dashboard-metrics-scraper   ClusterIP   <span class="token number">10.108</span>.18.117   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">8000</span>/TCP   74s
kubernetes-dashboard        ClusterIP   <span class="token number">10.100</span>.36.145   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>/TCP    74s</code></pre><p>쿠버네티스 대시보드에 대한 서비스는 기본적으로 ClusterIP 유형으로 되어있으므로 쿠버네티스 클러스터 환경에서만 접근할 수 있습니다. 마스터 노드에서 큐브컨트롤로 쿠버네티스 클러스터에 프록시를 활성화하고나서 로컬 컴퓨터에서 마스터 노드에 대해서 SSH 터널링을 통해 쿠버네티스 대시보드에 접근할 수 있습니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>쿠버네티스 클러스터 프록시 및 SSH 터널링</span></div><code class="language-bash">kubectl cluster-info
Kubernetes control plane is running at https://192.168.0.5:6443
CoreDNS is running at https://192.168.0.5:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

kubectl proxy
Starting to serve on <span class="token number">127.0</span>.0.1:8001
<span class="token comment"># http://127.0.0.1:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</span>

<span class="token function">ssh</span> <span class="token parameter variable">-L</span> <span class="token number">8001</span>:localhost:8001 mambo@192.168.0.5</code></pre><p>이제 로컬 컴퓨터에서 <a target="_blank" rel="noopener" href="http://127.0.0.1:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/%EB%A1%9C">http://127.0.0.1:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/로</a> 접속하면 쿠버네티스 대시보드 로그인 화면이 표시됩니다.</p><p><img data-src="/images/posts/setup-kubernetes-cluster/access-kubernetes-dashboard-02.png"></p><p>하지만, 이렇게 SSH 터널링으로 쿠버네티스 대시보드로 접근하는 방식은 불편한점이 있기 때문에 쿠버네티스 대시보드를 외부에서 직접 접근할 수 있으면 좋겠습니다. 외부에서 접근하기 위해서는 쿠버네티스 대시보드를 외부로 노출할 수 있도록 쿠버네티스 대시보드 서비스의 유형을 ClusterIP 에서 <strong>NodePort</strong>로 변경해야합니다.</p><h3 id="쿠버네티스-대시보드-서비스-유형-변경하기"><a href="#쿠버네티스-대시보드-서비스-유형-변경하기" class="headerlink" title="쿠버네티스 대시보드 서비스 유형 변경하기"></a>쿠버네티스 대시보드 서비스 유형 변경하기</h3><pre class="language-bash" data-language="bash"><div class="caption"><span>쿠버네티스 대시보드 서비스 변경</span></div><code class="language-bash">kubectl edit svc kubernetes-dashboard <span class="token parameter variable">-n</span> kubernetes-dashboard

apiVersion: v1
kind: Service
metadata:
  creationTimestamp: <span class="token string">"2021-07-30T10:47:00Z"</span>
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
  resourceVersion: <span class="token string">"240375"</span>
  uid: ae974cb2-d0af-46be-8036-4a9d33c9afbd
spec:
  clusterIP: <span class="token number">10.100</span>.36.145
  clusterIPs:
  - <span class="token number">10.100</span>.36.145
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - port: <span class="token number">443</span>
    protocol: TCP
    targetPort: <span class="token number">8443</span>
  selector:
    k8s-app: kubernetes-dashboard
  sessionAffinity: None
  type: NodePort
status:
  loadBalancer: <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token comment"># kubectl get service kubernetes-dashboard -n kubernetes-dashboard -o jsonpath="&#123;.spec.ports[0].nodePort&#125;" | awk '&#123;print $1&#125;'</span>
kubectl get svc kubernetes-dashboard <span class="token parameter variable">-n</span> kubernetes-dashboard
NAME                   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>         AGE
kubernetes-dashboard   NodePort   <span class="token number">10.100</span>.36.145   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>:31532/TCP   21m</code></pre><p>쿠버네티스 대시보드가 31532 포트로 노출되었으니 <strong><a target="_blank" rel="noopener" href="https://192.168.0.5:31532/">https://192.168.0.5:31532</a></strong>으로 접속합니다.</p><p><img data-src="/images/posts/setup-kubernetes-cluster/access-kubernetes-dashboard-01.png"></p><p>쿠버네티스 클러스터에서 사용하는 루트 CA 인증서가 현재 브라우저에 신뢰할 수 있는 CA 인증서로 등록되어있지 않기 때문에 <strong>안전하지 않음으로 이동</strong>을 눌러 쿠버네티스 대시보드로 들어갑니다.</p><h3 id="쿠버네티스-대시보드-로그인하기"><a href="#쿠버네티스-대시보드-로그인하기" class="headerlink" title="쿠버네티스 대시보드 로그인하기"></a>쿠버네티스 대시보드 로그인하기</h3><p><img data-src="/images/posts/setup-kubernetes-cluster/access-kubernetes-dashboard-02.png"></p><p>쿠버네티스 대시보드 서비스 어카운트의 토큰으로 쿠버네티스 대시보드에 로그인할 수 있습니다. 큐브컨트롤로 다음의 명령어를 실행하여 쿠버네티스 대시보드 사용자의 토큰을 조회합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>쿠버네티스 대시보드 사용자 토큰 조회</span></div><code class="language-bash"><span class="token comment"># kubectl get secret -n kubernetes-dashboard $(kubectl get sa kubernetes-dashboard -n kubernetes-dashboard -o jsonpath="&#123;.secrets[0].name&#125;") -o jsonpath="&#123;.data.token&#125;" | base64 --decode | awk '&#123;print $1&#125;'</span>

kubectl describe secret <span class="token variable"><span class="token variable">$(</span>kubectl get secret <span class="token parameter variable">-n</span> kubernetes-dashboard <span class="token operator">|</span> <span class="token function">grep</span> kubernetes-dashboard-token <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1&#125;'</span><span class="token variable">)</span></span> <span class="token parameter variable">-n</span> kubernetes-dashboard

Name:         kubernetes-dashboard-token-4qs2r
Namespace:    kubernetes-dashboard
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">></span>
Annotations:  kubernetes.io/service-account.name: kubernetes-dashboard
              kubernetes.io/service-account.uid: 52ab8346-d0ce-465a-b170-1a240cbcbf83

Type:  kubernetes.io/service-account-token

Data
<span class="token operator">==</span><span class="token operator">==</span>
namespace:  <span class="token number">20</span> bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6InhrcWdOeEV2RFh2ajZES0Z1b0lLb3F2TmtuSUVnLVdFbktadk9SWjNYXzQifQ<span class="token punctuation">..</span><span class="token punctuation">..</span>
ca.crt:     <span class="token number">1066</span> bytes</code></pre><p>쿠버네티스 대시보드 사용자의 토큰을 복사해서 쿠버네티스 대시보드에 로그인합니다.</p><p><img data-src="/images/posts/setup-kubernetes-cluster/access-kubernetes-dashboard-03.png"></p><p>토큰을 사용하여 로그인되었지만 이 서비스 어카운트는 쿠버네티스 클러스터에 대한 권한을 가지고 있지 않아서 어떠한 정보도 표시되지 않습니다.</p><p><img data-src="/images/posts/setup-kubernetes-cluster/access-kubernetes-dashboard-04.png"></p><p>우리는 쿠버네티스 클러스터에 대한 권한을 쿠버네티스 대시보드 사용자에게 부여해야합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>Terminal</span></div><code class="language-bash">kubectl delete clusterrole kubernetes-dashboard <span class="token parameter variable">-n</span> kubernetes-dashboard
kubectl delete clusterrolebinding kubernetes-dashboard <span class="token parameter variable">-n</span> kubernetes-dashboard

<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">tee</span> dashboard-admin.yaml</span>
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
  - kind: ServiceAccount
    name: kubernetes-dashboard
    namespace: kubernetes-dashboard
EOF</span>

kubectl create <span class="token parameter variable">-f</span> dashboard-admin.yaml
clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</code></pre><p>쿠버네티스 대시보드 사용자에게 모든 권한을 부여하는 <strong>ClusterRole</strong>과 <strong>ClusterRoleBinding</strong>을 다시 만들었으니 쿠버네티스 대시보드에 다시 로그인해보겠습니다.</p><p><img data-src="/images/posts/setup-kubernetes-cluster/access-kubernetes-dashboard-05.png"></p><p>쿠버네티스 대시보드의 서비스 어카운트가 클러스터 권한을 가지게 되었으므로 대시보드에 <strong>모든 네임스페이스</strong>에 대한 워크로드 상태를 조회할 수 있습니다.</p><h3 id="쿠버네티스-대시보드에서-매트릭-서버-설치하기"><a href="#쿠버네티스-대시보드에서-매트릭-서버-설치하기" class="headerlink" title="쿠버네티스 대시보드에서 매트릭 서버 설치하기"></a>쿠버네티스 대시보드에서 매트릭 서버 설치하기</h3><p>쿠버네티스 대시보드에서 클러스터 제어가 가능한지 검증하기 위해서 대시보드를 통해 클러스터에 매트릭 서버(metrics-server)를 설치해보도록 하겠습니다.</p><p><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml">https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</a></p><p>위 YAML 파일을 다운받아서 아래 화면과 같이 <strong>kubelet-insecure-tls</strong> 옵션을 추가하여 업로드 버튼을 선택합니다.</p><p><img data-src="/images/posts/setup-kubernetes-cluster/access-kubernetes-dashboard-06.png"></p><p>매트릭 서버가 설치되었으므로 큐브컨트롤으로 매트릭을 조회할 수 있는지 확인합니다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>Terminal</span></div><code class="language-bash">kubectl <span class="token function">top</span> no --use-protocol-buffers

NAME              CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   CPU%   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>   MEMORY%
mambo-master      136m         <span class="token number">13</span>%    1275Mi          <span class="token number">67</span>%
mambo-worker-01   22m          <span class="token number">2</span>%     710Mi           <span class="token number">37</span>%
mambo-worker-02   33m          <span class="token number">3</span>%     815Mi           <span class="token number">43</span>%</code></pre><p>이렇게 쿠버네티스 대시보드를 통해서도 클러스터를 제어할 수 있음을 확인했습니다. 그러나, 쿠버네티스 대시보드는 클러스터 외부에 노출되어있으므로 사용자의 토큰이 유출되지 않도록 잘 관리해야합니다. 저는 학습 목적으로 기본으로 제공하는 쿠버네티스 대시보드 사용자가 모든 권한을 가지게 하였지만 클러스터에 대한 모든 권한을 가지는게 아니라 쿠버네티스 대시보드에 로그인할 사용자를 별도로 만들어서 특정 네임스페이스와 리소스에 대한 권한을 개별적으로 지정하는게 좋습니다.</p><p>이상으로 쿠버네티스 클러스터에 대한 학습을 마칩니다.</p></div></div><div class="comments giscus-container"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Mambo</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script src="/js/third-party/fancybox.js"></script><script src="/js/third-party/pace.js"></script><script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script><script>var options={bottom:"unset",right:"15px",left:"unset",time:"0.5s",mixColor:"transparent",backgroundColor:"transparent",buttonColorDark:"#100f2c",buttonColorLight:"#fff",saveInCookies:!0,label:"🌗",autoMatchOsTheme:!0};const darkmode=new Darkmode(options);window.darkmode=darkmode,darkmode.showWidget()</script><script class="next-config" data-name="giscus" type="application/json">{"enable":true,"repo":"kdevkr/kdevkr.github.io","repo_id":"MDEwOlJlcG9zaXRvcnkxNTQxNjA4OTA=","category":"Announcements","category_id":"DIC_kwDOCTBO-s4CYmQM","mapping":"pathname","reactions_enabled":1,"emit_metadata":1,"theme":"light","lang":"ko","crossorigin":"anonymous","input_position":"bottom","loading":"lazy"}</script><script>document.addEventListener("page:loaded",()=>{CONFIG.page.comments&&NexT.utils.loadComments(".giscus-container").then(()=>NexT.utils.getScript("https://giscus.app/client.js",{attributes:{async:!0,crossOrigin:"anonymous","data-repo":CONFIG.giscus.repo,"data-repo-id":CONFIG.giscus.repo_id,"data-category":CONFIG.giscus.category,"data-category-id":CONFIG.giscus.category_id,"data-mapping":CONFIG.giscus.mapping,"data-reactions-enabled":CONFIG.giscus.reactions_enabled,"data-emit-metadata":CONFIG.giscus.emit_metadata,"data-theme":CONFIG.giscus.theme,"data-lang":CONFIG.giscus.lang,"data-input-position":CONFIG.giscus.input_position,"data-loading":CONFIG.giscus.loading},parentNode:document.querySelector(".giscus-container")}))})</script></body></html>