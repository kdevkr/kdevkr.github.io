<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png"><link rel="mask-icon" href="/images/favicon/favicon.ico" color="#222"><meta name="google-site-verification" content="LMcddVW6xLBS7X1htGQ3duOIEmVp4ljku8sd3UuIcBg"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Sans+KR:300,300italic,400,400italic,700,700italic%7CPretendard-Bold:300,300italic,400,400italic,700,700italic%7CPretendard-Medium:300,300italic,400,400italic,700,700italic%7CJetbrains+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-loading-bar.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"kdevkr.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.13.2","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"width":240,"scrollpercent":true,"b2t":true},"copycode":{"enable":false,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script><meta name="description" content="현재 회사는 빠른 업무 처리를 위해서 간단한 방식을 취해왔고 이로 인해 최근에는 제품 품질 강화를 고민하는 상황이 발생했다. 조직에서 당장 나에게 요구하는 것은 테스트 환경에 대한 방안에 대한 도입하는 것이다. 작은 조직으로써 간단한 방식을 취했기 때문에 제품 코드에 대한 단위 테스트를 작성한 부분이 생각보다 많지 않다. 조직 내의 개발자들은 테스트 코드"><meta property="og:type" content="website"><meta property="og:title" content="Testcontainers for Java"><meta property="og:url" content="https://kdevkr.github.io/archive/testcontainers-java.html"><meta property="og:site_name" content="Mambo"><meta property="og:description" content="현재 회사는 빠른 업무 처리를 위해서 간단한 방식을 취해왔고 이로 인해 최근에는 제품 품질 강화를 고민하는 상황이 발생했다. 조직에서 당장 나에게 요구하는 것은 테스트 환경에 대한 방안에 대한 도입하는 것이다. 작은 조직으로써 간단한 방식을 취했기 때문에 제품 코드에 대한 단위 테스트를 작성한 부분이 생각보다 많지 않다. 조직 내의 개발자들은 테스트 코드"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2023-01-13T15:00:00.000Z"><meta property="article:modified_time" content="2023-10-01T12:58:43.212Z"><meta property="article:author" content="Mambo"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://kdevkr.github.io/archive/testcontainers-java"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":false,"lang":"en","comments":true,"permalink":"https://kdevkr.github.io/archive/testcontainers-java.html","path":"archive/testcontainers-java.html","title":"Testcontainers for Java"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Testcontainers for Java | Mambo</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-V8LF04VMBF"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-V8LF04VMBF","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="Mambo" type="application/atom+xml">
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope itemtype="http://schema.org/WebPage"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Mambo</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Today I Learned 🔥</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fas fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fas fa-archive fa-fw"></i>Archives<span class="badge">96</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fas fa-user fa-fw"></i>About</a></li></ul></nav></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-overview-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Mambo" src="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4"><p class="site-author-name" itemprop="name">Mambo</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">96</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-tags"><span class="site-state-item-count">141</span> <span class="site-state-item-name">tags</span></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/kdevkr" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kdevkr" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:kdevkr@gmail.com" title="E-Mail → mailto:kdevkr@gmail.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a></span></div><div class="cc-license site-overview-item animated" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ko" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div><div class="back-to-top animated" role="button" aria-label="Back to top"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div class="sidebar-dimmer"></div></header><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner page posts-expand"><div class="post-block" lang="en"><header class="post-header"><h1 class="post-title" itemprop="name headline">Testcontainers for Java</h1><div class="post-meta-container"></div></header><div class="post-body"><p>현재 회사는 빠른 업무 처리를 위해서 간단한 방식을 취해왔고 이로 인해 최근에는 제품 품질 강화를 고민하는 상황이 발생했다. 조직에서 당장 나에게 요구하는 것은 테스트 환경에 대한 방안에 대한 도입하는 것이다. 작은 조직으로써 간단한 방식을 취했기 때문에 제품 코드에 대한 단위 테스트를 작성한 부분이 생각보다 많지 않다. 조직 내의 개발자들은 테스트 코드 작성을 강제하지 않기 때문에 스스로 중요하다고 생각하지 않는다면 굳이 작성하지 않는 편이었고 개발자마다 다른 방식으로 테스트를 수행하도록 코드가 작성되어 있었다. 아무튼 테스트 코드가 작성되지 않았는데 테스트 환경을 준비하는 것에 의아한 부분이 있긴 하지만 요구하므로 시도해보기로 한다.</p><h4 id="기술-스택"><a href="#기술-스택" class="headerlink" title="기술 스택"></a>기술 스택</h4><p>현재 조직에서 만드는 제품에서 사용되는 기술 스택은 대부분의 회사들에서도 도입하는 일반적인 기술들이다.</p><ul><li>Spring Boot 2.3 (JDK 11)</li><li>Postgresql 12.3</li><li>Elasticsearch 7.3.2</li><li>Redis 5.0.3</li><li>KDB+ 4.0</li></ul><p>시간이 많이 흘러서 지금은 버전이 많이 낮지만 생각보다 기술 스택은 나쁘지 않다고 생각된다. 사용하는 대부분의 기술 스택에 대해서는 <a target="_blank" rel="noopener" href="https://www.testcontainers.org/">Testcontainers</a>에서 테스트 컨테이너 모듈이나 예제를 제공하고 있다. 그러나, 상용 시계열 데이터베이스로 사용중인 KDB+에 대한 의존성으로 인해 테스트 환경을 준비하는게 생각보다 까다롭지만 KDB+에 대한 도커 컴포즈 환경을 만든다면 <a target="_blank" rel="noopener" href="https://www.testcontainers.org/modules/docker_compose/">도커 컴포즈 모듈</a>로 실행할 수 있다는 것이다.</p><h4 id="요구사항"><a href="#요구사항" class="headerlink" title="요구사항"></a>요구사항</h4><p><a target="_blank" rel="noopener" href="https://www.testcontainers.org/supported_docker_environment/">Docker v17.0.3+</a> 버전을 요구하며 <a target="_blank" rel="noopener" href="https://www.testcontainers.org/test_framework_integration/junit_5/">Jupiter&#x2F;JUnit 5</a> 프레임워크를 지원하므로 테스트 코드에 대한 작성은 JUnit5로 작성되도록 가이드하면 될 것 같다.</p><h4 id="예제"><a href="#예제" class="headerlink" title="예제"></a>예제</h4><p>기본적으로 <a target="_blank" rel="noopener" href="https://github.com/testcontainers/testcontainers-java/tree/main/examples">testcontainers-java&#x2F;examples</a>를 제공하며 본 글을 작성하면서 확인해본 예제는 <a target="_blank" rel="noopener" href="https://github.com/kdevkr/spring-demo-testcontainers">kdevkr&#x2F;spring-demo-testcontainers</a>에서 확인할 수 있다.</p><h4 id="트러블슈팅"><a href="#트러블슈팅" class="headerlink" title="트러블슈팅"></a>트러블슈팅</h4><h5 id="1-PostgreSQL-컨테이너가-중복으로-실행된-문제"><a href="#1-PostgreSQL-컨테이너가-중복으로-실행된-문제" class="headerlink" title="1. PostgreSQL 컨테이너가 중복으로 실행된 문제"></a>1. PostgreSQL 컨테이너가 중복으로 실행된 문제</h5><p>JDBC 테스트를 위해 PostgreSQL 컨테이너를 적용해보는 과정에서 <a target="_blank" rel="noopener" href="https://github.com/kdevkr/spring-demo-testcontainers/pull/8#issuecomment-1374673165">max_connections 옵션 설정</a>이 되지 않는 현상이 있었는데 <a target="_blank" rel="noopener" href="https://github.com/testcontainers/testcontainers-java/discussions/6398">Discussions를 통한 문의</a>를 통해 Testcontainers의 개발자분에게 도움을 받았다. 내가 잘못한 부분은 <a target="_blank" rel="noopener" href="https://www.testcontainers.org/modules/databases/jdbc/">Database containers launched via JDBC URL scheme</a>으로 자동 생성되는 컨테이너 방식과 수동으로 생성하는 것을 혼용하고 있었던 것이다. JDBC URL 방식으로 테스트 컨테이너를 실행할 것이 아니라면 PostgreSQL 컨테이너를 생성하고 일반적인 JDBC URL을 사용하면 된다.</p><h5 id="2-테스트-컨테이너-공유"><a href="#2-테스트-컨테이너-공유" class="headerlink" title="2. 테스트 컨테이너 공유"></a>2. 테스트 컨테이너 공유</h5><p>여러개의 테스트 함수를 포함하는 클래스에서 테스트 컨테이너를 공유하고자 한다면 @Testcontainers와 @Container를 활용하면 된다.</p><h5 id="3-테스트-컨테이너에-대한-로그백-설정"><a href="#3-테스트-컨테이너에-대한-로그백-설정" class="headerlink" title="3. 테스트 컨테이너에 대한 로그백 설정"></a>3. 테스트 컨테이너에 대한 로그백 설정</h5><p><a target="_blank" rel="noopener" href="https://www.testcontainers.org/supported_docker_environment/logging_config/">Recommended logback configuration</a>를 제공하므로 스프링 부트에서 기본적으로 제공하는 로그백에 대한 설정을 참고할 수 있다. 로그백에 대한 설정을 하지 않는다면 불필요하게 컨테이너 실행에 대한 로그가 출력될 것이다. 테스트 컨테이너에 대한 이슈가 발생할 경우에만 아래와 같은 패키지의 로그 레벨을 DEBUG로 설정하자.</p><pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>logger</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.testcontainers<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>DEBUG<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></code></pre><h5 id="4-테스트-컨테이너-환경에-대한-프로퍼티-적용"><a href="#4-테스트-컨테이너-환경에-대한-프로퍼티-적용" class="headerlink" title="4. 테스트 컨테이너 환경에 대한 프로퍼티 적용"></a>4. 테스트 컨테이너 환경에 대한 프로퍼티 적용</h5><p>JUnit5 테스트 코드를 제대로 작성하지 않다보니 테스트 프로파일에 대한 파일을 만들고 환경 변수를 통해 프로파일을 지정하였으나 테스트 컨테이너를 실행하는 경우 컨테이너의 호스트와 포트가 원래 포트와 달라지는 부분으로 인하여 아래와 같은 유틸 클래스들을 사용해야했다.</p><ul><li><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework/blob/main/spring-test/src/main/java/org/springframework/test/context/DynamicPropertySource.java">@DynamicPropertySource</a></li><li><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework/blob/main/spring-test/src/main/java/org/springframework/test/context/DynamicPropertyRegistry.java">DynamicPropertyRegistry</a></li></ul><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Container</span>
<span class="token keyword">static</span> <span class="token class-name">GenericContainer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> redis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericContainer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token class-name">DockerImageName</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"redis:6.2-alpine"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token annotation punctuation">@DynamicPropertySource</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerRedisProperties</span><span class="token punctuation">(</span><span class="token class-name">DynamicPropertyRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    registry<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"spring.redis.host"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> redis<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    registry<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"spring.redis.port"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> redis<span class="token punctuation">.</span><span class="token function">getMappedPort</span><span class="token punctuation">(</span><span class="token constant">REDIS_PORT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre></div></div><div class="comments giscus-container"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Mambo</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script src="/js/third-party/fancybox.js"></script><script src="/js/third-party/pace.js"></script><script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script><script>var options={bottom:"unset",right:"15px",left:"unset",time:"0.5s",mixColor:"transparent",backgroundColor:"transparent",buttonColorDark:"#100f2c",buttonColorLight:"#fff",saveInCookies:!0,label:"🌗",autoMatchOsTheme:!0};const darkmode=new Darkmode(options);window.darkmode=darkmode,darkmode.showWidget()</script><script class="next-config" data-name="giscus" type="application/json">{"enable":true,"repo":"kdevkr/kdevkr.github.io","repo_id":"MDEwOlJlcG9zaXRvcnkxNTQxNjA4OTA=","category":"Announcements","category_id":"DIC_kwDOCTBO-s4CYmQM","mapping":"pathname","reactions_enabled":1,"emit_metadata":1,"theme":"light","lang":"ko","input_position":"bottom","loading":"lazy"}</script><script>document.addEventListener("page:loaded",()=>{CONFIG.page.comments&&NexT.utils.loadComments(".giscus-container").then(()=>NexT.utils.getScript("https://giscus.app/client.js",{attributes:{async:!0,crossOrigin:"anonymous","data-repo":CONFIG.giscus.repo,"data-repo-id":CONFIG.giscus.repo_id,"data-category":CONFIG.giscus.category,"data-category-id":CONFIG.giscus.category_id,"data-mapping":CONFIG.giscus.mapping,"data-reactions-enabled":CONFIG.giscus.reactions_enabled,"data-emit-metadata":CONFIG.giscus.emit_metadata,"data-theme":CONFIG.giscus.theme,"data-lang":CONFIG.giscus.lang,"data-input-position":CONFIG.giscus.input_position,"data-loading":CONFIG.giscus.loading},parentNode:document.querySelector(".giscus-container")}))})</script></body></html>