<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Mambo</title>
  
  <subtitle>Today I Learned 🔥</subtitle>
  <link href="https://kdevkr.github.io/atom.xml" rel="self"/>
  
  <link href="https://kdevkr.github.io/"/>
  <updated>2021-12-29T14:23:25.031Z</updated>
  <id>https://kdevkr.github.io/</id>
  
  <author>
    <name>Mambo</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>롬복 어노테이션 프로세서</title>
    <link href="https://kdevkr.github.io/lombok-annotation-processor/"/>
    <id>https://kdevkr.github.io/lombok-annotation-processor/</id>
    <published>2021-12-29T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.031Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 인텔리제이에서 롬복 라이브러리를 적용하는 방법을 알아가기 위한 내용을 공유하고자 합니다.</p><h2 id="Lombok"><a href="#Lombok" class="headerlink" title="Lombok"></a>Lombok</h2><p><a href="https://projectlombok.org/">롬복 라이브러리</a>는 자바 프로젝트에서 필수적으로 사용될만큼 편리하고 유용한 기능을 제공합니다. 롬복 라이브러리는 <a href="https://docs.oracle.com/javase/7/docs/technotes/guides/apt/GettingStarted.html">APT(Annotation Processing Tool)</a>를 통해 어노테이션 프로세서(Annotation Processor)로 컴파일 단계에서 수행하게 됩니다. 따라서, 롬복 라이브러리를 사용하기 위해서는 프로젝트에서 어노테이션 프로세서를 동작시키기 위한 설정을 해야합니다.</p><h3 id="인텔리제이-어노테이션-프로세서"><a href="#인텔리제이-어노테이션-프로세서" class="headerlink" title="인텔리제이 어노테이션 프로세서"></a>인텔리제이 어노테이션 프로세서</h3><p>인텔리제이에서는 클래스패스에 있는 어노테이션 프로세서를 구성하기 위한 <a href="https://www.jetbrains.com/help/idea/annotation-processors-support.html">어노테이션 프로세싱 기능</a>을 지원합니다. 이 어노테이션 프로세싱 기능이 활성화되면 클래스패스에 있는 어노테이션 프로세서를 자동으로 등록하게 됩니다.</p><h4 id="그래들-프로젝트"><a href="#그래들-프로젝트" class="headerlink" title="그래들 프로젝트"></a>그래들 프로젝트</h4><p>인텔리제이는 그래들 프로젝트에 있는 기본 그래들 래퍼를 사용하여 프로젝트를 빌드하고 실행하도록 설정되어있습니다. Build Tools &gt; Gradle 메뉴에서 기본 그래들 래퍼가 아닌 인텔리제이 자체로 빌드하고 실행되도록 변경할 수 있습니다. 인텔리제이 자체적으로는 롬복 플러그인을 번들에 포함하고 있으므로 롬복 어노테이션 프로세서가 클래스패스에 위치하기 때문에 어노테이션 프로세싱 기능이 활성화되어있다면 롬복에 대한 어노테이션 프로세서가 자동으로 등록되게 됩니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    compileOnly <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><em>인텔리제이는 친절하게도 롬복 라이브러리가 클래스패스에 있지만 어노테이션 프로세싱 기능이 비활성화되어있으면 이벤트 로그에 기능 활성화를 묻는 알림을 제공합니다.</em><br><em>또한, 인텔리제이를 사용하도록 선택한 환경에서는 별다른 설정없이도 클래스패스에 롬복 라이브러리가 있으면 어노테이션 프로세서가 동작함을 확인할 수 있습니다.</em></p></blockquote><h4 id="그래들-어노테이션-프로세서-구성"><a href="#그래들-어노테이션-프로세서-구성" class="headerlink" title="그래들 어노테이션 프로세서 구성"></a>그래들 어노테이션 프로세서 구성</h4><p>프로젝트의 기본 설정은 프로젝트의 그래들 래퍼로 실행하는 환경이라고 하였습니다. 이 경우에는 롬복 라이브러리에 대한 어노테이션 프로세서를 그래들 구성 파일에 정의해야합니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    compileOnly <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class="line">    annotationProcessor <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>그래들의 annotationProcessor를 통해 롬복 라이브러리의 어노테이션 프로세서가 어노테이션 프로세서가 위치하는 클래스패스에 등록됨에 따라 인텔리제이는 어노테이션 프로세싱 기능 활성화 여부를 확인하고 활성화에 대한 알림을 제공합니다. </p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">configurations &#123;</span><br><span class="line">   compileOnly &#123;</span><br><span class="line">       extendsFrom annotationProcessor</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>그래들 기반의 스프링 부트 프로젝트를 시작할 때 롬복을 추가하면 위 구문이 포함되는 것을 확인하실 수 있습니다. 이 구문의 역할이 무엇인지 궁금하지 않으신가요? 인텔리제이는 그래들 설정 팡리에 위 구문이 포함되는 경우 <code>Gradle Imported</code>라는 이름의 프로파일로써 롬복 라이브러리를 어노테이션 프로세서로 등록하기 위한 어노테이션 프로세싱 기능을 활성화하는 것을 자동으로 구성하게 됩니다.</p><blockquote><p><em>인텔리제이는 기본 프로파일에 대해 어노테이션 프로세싱 기능이 활성화되어있지 않으면 이벤트 로그를 통해 롬복을 위한 어노테이션 프로세싱 기능 활성화를 안내하는 것 같습니다.</em></p></blockquote><h3 id="롬복-어노테이션-프로세서"><a href="#롬복-어노테이션-프로세서" class="headerlink" title="롬복 어노테이션 프로세서"></a>롬복 어노테이션 프로세서</h3><p>다시 내용을 정리해보자면, 롬복 라이브러리를 적용하기 위해서는 롬복 라이브러리의 어노테이션 프로세서를 등록하기 위한 설정을 수행해야합니다.</p><ul><li>인텔리제이 어노테이션 프로세싱 활성화(Enable annotation processing)</li><li>그래들 어노테이션 프로세서 구성</li></ul><h4 id="그래들-어노테이션-프로세서-구성-1"><a href="#그래들-어노테이션-프로세서-구성-1" class="headerlink" title="그래들 어노테이션 프로세서 구성"></a>그래들 어노테이션 프로세서 구성</h4><p>인텔리제이를 사용하는 개발 환경에서는 인텔리제이 어노테이션 프로세싱 활성화 기능을 통해 클래스패스에 있는 어노테이션 프로세서를 자동으로 등록할 수 있습니다만, 젠킨스와 같은 빌드 환경에서 그래들로 어노테이션 프로세서를 등록하기 위해서는 이를 위한 구성을 해야합니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">configurations &#123;</span><br><span class="line">    compileOnly &#123;</span><br><span class="line">        extendsFrom annotationProcessor</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">dependencies &#123;</span><br><span class="line">    compileOnly <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class="line">    annotationProcessor <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class="line">    testCompileOnly <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class="line">    testAnnotationProcessor <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>그리고 위 구성은 간단하게 그래들 롬복 플러그인으로 대체할 수 있는데 플러그인을 사용하는 것은 공식 홈페이지에서도 추천하는 방식입니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">   id <span class="string">&quot;io.freefair.lombok&quot;</span> version <span class="string">&quot;6.3.0&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 인텔리제이에서 롬복 라이브러리를 적용하는 방법을 알아가기 위한 내용을 공유하고자 합니다.&lt;/p&gt;
&lt;h2 id=&quot;Lombok&quot;&gt;&lt;a href=&quot;#Lombok&quot; class=&quot;headerlink&quot; ti</summary>
      
    
    
    
    
    <category term="IntelliJ" scheme="https://kdevkr.github.io/tags/IntelliJ/"/>
    
    <category term="Lombok" scheme="https://kdevkr.github.io/tags/Lombok/"/>
    
    <category term="Annotation Processor" scheme="https://kdevkr.github.io/tags/Annotation-Processor/"/>
    
  </entry>
  
  <entry>
    <title>Webpack 5 기반의 Vue 개발 환경</title>
    <link href="https://kdevkr.github.io/webpack5-for-vue/"/>
    <id>https://kdevkr.github.io/webpack5-for-vue/</id>
    <published>2021-12-28T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.035Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 <strong>Webpack 5 기반의 Vue 개발 환경</strong>에 대해서 알아보는 시간을 가져보도록 하겠습니다.<br>본 글에서 설명한 내용에 대한 코드는 <a href="https://github.com/kdevkr/webpack5">kdevkr/webpack5</a>에서 제공합니다.</p><h2 id="Webpack"><a href="#Webpack" class="headerlink" title="Webpack"></a>Webpack</h2><p>반드시 그런 것은 아니지만 많은 분들이 <a href="https://create-react-app.dev/">Create React App</a> 또는 <a href="https://cli.vuejs.org/">Vue CLI</a>라는 도구를 통해서 프론트엔드 개발 환경에 대한 기본 프리셋을 기반으로 학습을 시작하거나 개발 환경을 구축합니다. 이 도구들은 여러가지 사항에 대한 웹팩 구성을 기본적으로 제공함으로써 웹팩에 대한 내용을 알지 못하더라도 쉽게 리액트 또는 뷰에 대한 학습을 진행할 수 있게 도와주는 유용한 도구입니다. </p><p>그럼에도 불구하고, 실무 환경에서는 이 도구들을 사용하지 않고 직접 웹팩 설정에 대해 구성하여 사용합니다. 또한, Vue CLI는 안타깝게도 웹팩 4에 대한 구성을 제공하므로 이 도구로 만들어지는 환경은 무조건 웹팩 4로 제한되는 문제점을 가지고 있습니다. <a href="https://webpack.js.org/blog/2020-10-10-webpack-5-release/">2020년 10월에 릴리즈된 웹팩 5</a> 기반의 개발 환경을 만들기 위해서는 직접 웹팩 구성을 수행할 수 있어야만 합니다.</p><h3 id="요구사항"><a href="#요구사항" class="headerlink" title="요구사항"></a>요구사항</h3><p>시작하기에 앞서, 웹팩 5는 노드 10.13.0 이상의 버전을 요구하며 함께 개발 프록시 서버로 활용할 수 있는 webpack-dev-server@4 에서는 노드 12.13.0 이상을 요구합니다. </p><ul><li>Webpack5 required v10.13.0+</li><li>webpack-dev-server@4 v12.13.0+</li></ul><h4 id="프로젝트-노드-버전-제한"><a href="#프로젝트-노드-버전-제한" class="headerlink" title="프로젝트 노드 버전 제한"></a>프로젝트 노드 버전 제한</h4><p>위 요구사항에 따라 프로젝트에서 사용할 수 있는 노드 버전을 제한하는 것이 좋습니다. 제가 이전에 공유한 <a href="https://kdevkr.github.io/strict-nodejs-version-for-project/">프로젝트의 노드 버전 제한하기</a>를 참고하여 노드 엔진 버전을 12.13.0 이상으로 설정해두는 것을 추천하는 바입니다.</p><h3 id="커밋별로-확인하는-구성"><a href="#커밋별로-확인하는-구성" class="headerlink" title="커밋별로 확인하는 구성"></a>커밋별로 확인하는 구성</h3><p>각 커밋 단위의 Browser Files를 통해 어떻게 구성이 변화하는지를 참고하시면 좋습니다.</p><h4 id="Add-webpack-config-js-for-default-configuration"><a href="#Add-webpack-config-js-for-default-configuration" class="headerlink" title="Add webpack.config.js for default configuration"></a><a href="https://github.com/kdevkr/webpack5/commit/3f858c2702720088b8647bdb55a9f830d54a8d91">Add webpack.config.js for default configuration</a></h4><p>기본 구성을 위한 webpack.config.js 파일을 만들고 node-env 값에 따라 번들 파일명을 다르게 지정할 수 있음을 보여줍니다.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npx webpack --node-env production <span class="comment"># 모드를 지정하지 않았지만 node-env 값에 의해 처리됩니다.</span></span><br></pre></td></tr></table></figure><h4 id="Add-vue-loader"><a href="#Add-vue-loader" class="headerlink" title="Add vue-loader"></a><a href="https://github.com/kdevkr/webpack5/commit/3ca2fc1de5573ae339b0271ea482a73bf3dac397">Add vue-loader</a></h4><p>Vue SFC 파일을 처리하기 위한 vue-loader를 추가하고 Vue 개발 환경을 준비하고 간단한 샘플 HTML 파일을 만들어서 Vue 코드가 정상적으로 변환되었음을 확인합니다.</p><h4 id="Add-sass-postcss"><a href="#Add-sass-postcss" class="headerlink" title="Add sass, postcss"></a><a href="https://github.com/kdevkr/webpack5/commit/68ffce2b18c64e67b944a383b216c2e6fe784396">Add sass, postcss</a></h4><p>Vue SFC의 스타일 블록의 언어를 SCSS로 사용하기 위해서 sass 및 postcss에 대한 설정을 추가합니다. </p><h4 id="Add-stylelint"><a href="#Add-stylelint" class="headerlink" title="Add stylelint"></a><a href="https://github.com/kdevkr/webpack5/commit/7e1e00735738e9106033c6df675977846b159552">Add stylelint</a></h4><p>반드시 필요한 설정은 아니지만 CSS에 대한 린트를 적용하기 위해 stylelint를 postcss 플러그인으로 추가합니다.</p><h4 id="Add-eslint"><a href="#Add-eslint" class="headerlink" title="Add eslint"></a><a href="https://github.com/kdevkr/webpack5/commit/f7f566314fd675e18d3f7b3dd35283317c5891ae">Add eslint</a></h4><p>자바스크립트에 대한 린트를 적용하기 위해 eslint를 추가합니다.</p><h4 id="Add-babel"><a href="#Add-babel" class="headerlink" title="Add babel"></a><a href="https://github.com/kdevkr/webpack5/commit/c5211b28ab8176e8c5c9fb39c755083679cb24df">Add babel</a></h4><p>ES6+ 문법을 지원하지 않는 브라우저를 위해 ES5 문법으로 변환하기 위한 babel을 추가합니다. babel 7 부터는 폴리필 적용 방식이 변경되었음을 주의해야합니다. 바벨 폴리필에 대해서는 다음의 두 링크를 참고하시면 좋습니다.</p><ul><li><a href="https://poiemaweb.com/babel-polyfill">폐지된 @babel/polyfill 대신 @babel/plugin-transform-runtime을 사용해 폴리필 추가하기</a></li><li><a href="https://tech.kakao.com/2020/12/01/frontend-growth-02/">Babel7과 corejs3 설정으로 전역 오염 없는 폴리필 사용하기</a></li></ul><h4 id="Add-browserslist"><a href="#Add-browserslist" class="headerlink" title="Add browserslist"></a><a href="https://github.com/kdevkr/webpack5/commit/c911ef73aa85ebde4d9c738c07999300c05bfaf8">Add browserslist</a></h4><p>postcss의 autoprefixer 또는 babel에서 참고할 타겟 정보를 위해 browserslist를 추가합니다.</p><h4 id="Add-prettierrc"><a href="#Add-prettierrc" class="headerlink" title="Add prettierrc"></a><a href="https://github.com/kdevkr/webpack5/commit/b5c8e20ebdb2224f1268b431aafb82a6b49e7b3a">Add prettierrc</a></h4><p>불필요한 포맷팅을 방지하기 위한 prettier 옵션을 조정합니다.</p><h4 id="Add-asset"><a href="#Add-asset" class="headerlink" title="Add asset"></a><a href="https://github.com/kdevkr/webpack5/commit/1ba05ff066806fb2c7b59eace748e04e73756243">Add asset</a></h4><p>이미지 또는 폰트 등을 위한 에셋 모듈을 추가합니다.</p><h4 id="Apply-strict-npm-engines"><a href="#Apply-strict-npm-engines" class="headerlink" title="Apply strict npm engines"></a><a href="https://github.com/kdevkr/webpack5/commit/1b768c5881db9d8348d54f926a11e537a50050ac">Apply strict npm engines</a></h4><p>지금까지 설치된 패키지에서 최소로 요구하는 노드 버전을 명시하고 제한되도록 설정합니다.</p><h4 id="Apply-settings-for-vscode"><a href="#Apply-settings-for-vscode" class="headerlink" title="Apply settings for vscode"></a><a href="https://github.com/kdevkr/webpack5/commit/9008824470873ce172e52294ddac7eee8304c256">Apply settings for vscode</a></h4><p>VSCode를 사용하는 경우 저장될 때 ESLint가 동작하도록 설정합니다.</p><h4 id="Add-project-version-in-output-filename"><a href="#Add-project-version-in-output-filename" class="headerlink" title="Add project version in output filename"></a><a href="https://github.com/kdevkr/webpack5/commit/769171d627bb1f4bfbb4bacce62dc067ff9b617a">Add project version in output filename</a></h4><p>(Optional) package.json에 정의된 프로젝트 버전을 번들 파일명에 포함시킬 수 있음을 보여줍니다.</p><h4 id="Apply-optimization"><a href="#Apply-optimization" class="headerlink" title="Apply optimization"></a><a href="https://github.com/kdevkr/webpack5/commit/bab1505c643b4ae3ea5e7a86bdc90317f4afe470">Apply optimization</a></h4><p>프로덕션 환경을 위한 최적화 구성을 조정합니다.</p><h4 id="Add-manifest"><a href="#Add-manifest" class="headerlink" title="Add manifest"></a><a href="https://github.com/kdevkr/webpack5/commit/7d0cd27b85a8f1df757e16c3ddb6ad32b8f7b39e">Add manifest</a></h4><p>매니페스트 파일이 생성할 수 있도록 플러그인을 추가합니다. </p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npx webpack --node-env production --env manifest</span><br></pre></td></tr></table></figure><h4 id="Add-bootstrap-vue"><a href="#Add-bootstrap-vue" class="headerlink" title="Add bootstrap-vue"></a><a href="https://github.com/kdevkr/webpack5/commit/c3da5f586c6ec368778e2c90478196e4af037a82">Add bootstrap-vue</a></h4><p>BootstrapVue를 추가해보고 <a href="https://kdevkr.github.io/no-emit-deprecation-warnings-of-dart-sass/">최신 버전의 Sass에서 출력되는 Deprecation 경고가 출력되지 않도록</a> 설정합니다.</p><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 &lt;strong&gt;Webpack 5 기반의 Vue 개발 환경&lt;/strong&gt;에 대해서 알아보는 시간을 가져보도록 하겠습니다.&lt;br&gt;본 글에서 설명한 내용에 대한 코드는 &lt;a href=&quot;https://</summary>
      
    
    
    
    
    <category term="Webpack5" scheme="https://kdevkr.github.io/tags/Webpack5/"/>
    
  </entry>
  
  <entry>
    <title>특정 디펜던시에 대한 Dart Sass의 Deprecation 경고 제외하기</title>
    <link href="https://kdevkr.github.io/no-emit-deprecation-warnings-of-dart-sass/"/>
    <id>https://kdevkr.github.io/no-emit-deprecation-warnings-of-dart-sass/</id>
    <published>2021-12-27T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.031Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 특정 디펜던시에 대한 Dart Sass의 Deprecation 경고를 제외하는 방법에 대해서 공유하려고 합니다.</p><h2 id="Deprecation-Warnings"><a href="#Deprecation-Warnings" class="headerlink" title="Deprecation Warnings"></a>Deprecation Warnings</h2><p>최신 웹팩에서 사용하는 sass-loader에서는 sass(Dart Sass)를 사용하는 것을 권장합니다. 다만, Dart Sass 버전에 따라 다음과 같이 Dart Sass 2.0에서부터 지원되지 않는 문법에 대한 경고 로그가 출력될 수 있습니다.</p><p><em>Deprecation Using / for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0</em></p><h3 id="Bootstrap"><a href="#Bootstrap" class="headerlink" title="Bootstrap"></a>Bootstrap</h3><p>부트스트랩의 변수를 오버라이딩하여 테마를 구성하고자 하는 경우 여러분의 SCSS 파일에서 부트스트랩에서 제공하는 SCSS 파일을 불러오게되면 아래처럼 경고 로그가 출력될 수 있습니다.</p><figure class="highlight ps"><table><tr><td class="code"><pre><span class="line">LOG from ./node_modules/sass<span class="literal">-loader</span>/dist/cjs.js sass<span class="literal">-loader</span> ./node_modules/css<span class="literal">-loader</span>/dist/cjs.js??clonedRule<span class="built_in">Set-2</span>[<span class="number">0</span>].rules[<span class="number">0</span>].use[<span class="number">1</span>]!./node_modules/postcss<span class="literal">-loader</span>/dist/cjs.js!./node_modules/<span class="built_in">resolve-url</span><span class="literal">-loader</span>/index.js!./node_modules/sass<span class="literal">-loader</span>/dist/cjs.js??clonedRule<span class="built_in">Set-2</span>[<span class="number">0</span>].rules[<span class="number">0</span>].use[<span class="number">4</span>]!./src/scss/bootstrap.scss</span><br><span class="line">&lt;w&gt; Deprecation <span class="keyword">Using</span> / for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0.</span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; Recommendation: math.div(<span class="variable">$b</span><span class="literal">-custom</span><span class="literal">-control</span><span class="literal">-indicator</span><span class="literal">-size</span><span class="literal">-lg</span>, <span class="number">2</span>) or calc(<span class="variable">$b</span><span class="literal">-custom</span><span class="literal">-control</span><span class="literal">-indicator</span><span class="literal">-size</span><span class="literal">-lg</span> / <span class="number">2</span>)</span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; More info and automated migrator: https://sass<span class="literal">-lang</span>.com/d/slash<span class="literal">-div</span></span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; node_modules\bootstrap<span class="literal">-vue</span>\src\_variables.scss <span class="number">33</span>:<span class="number">46</span>  @import</span><br><span class="line">&lt;w&gt; node_modules\bootstrap<span class="literal">-vue</span>\src\index.scss <span class="number">7</span>:<span class="number">9</span>         @import</span><br><span class="line">&lt;w&gt; src\scss\bootstrap.scss <span class="number">11</span>:<span class="number">9</span>                          root stylesheet</span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; Deprecation <span class="keyword">Using</span> / for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0.</span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; Recommendation: math.div(<span class="variable">$b</span><span class="literal">-custom</span><span class="literal">-control</span><span class="literal">-indicator</span><span class="literal">-size</span><span class="literal">-sm</span>, <span class="number">2</span>) or calc(<span class="variable">$b</span><span class="literal">-custom</span><span class="literal">-control</span><span class="literal">-indicator</span><span class="literal">-size</span><span class="literal">-sm</span> / <span class="number">2</span>)</span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; More info and automated migrator: https://sass<span class="literal">-lang</span>.com/d/slash<span class="literal">-div</span></span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; node_modules\bootstrap<span class="literal">-vue</span>\src\_variables.scss <span class="number">34</span>:<span class="number">46</span>  @import</span><br><span class="line">&lt;w&gt; node_modules\bootstrap<span class="literal">-vue</span>\src\index.scss <span class="number">7</span>:<span class="number">9</span>         @import</span><br><span class="line">&lt;w&gt; src\scss\bootstrap.scss <span class="number">11</span>:<span class="number">9</span>                          root stylesheet</span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; Deprecation <span class="keyword">Using</span> / for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0.</span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; Recommendation: math.div(<span class="variable">$font</span><span class="literal">-size</span><span class="literal">-lg</span> * <span class="variable">$line</span><span class="literal">-height</span><span class="literal">-lg</span> - <span class="variable">$b</span><span class="literal">-custom</span><span class="literal">-control</span><span class="literal">-indicator</span><span class="literal">-size</span><span class="literal">-lg</span>, <span class="number">2</span>) or calc((<span class="variable">$font</span><span class="literal">-size</span><span class="literal">-lg</span> * <span class="variable">$line</span><span class="literal">-height</span><span class="literal">-lg</span> - <span class="variable">$b</span><span class="literal">-custom</span><span class="literal">-control</span><span class="literal">-indicator</span><span class="literal">-size</span><span class="literal">-lg</span>) / <span class="number">2</span>)</span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; More info and automated migrator: https://sass<span class="literal">-lang</span>.com/d/slash<span class="literal">-div</span></span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; node_modules\bootstrap<span class="literal">-vue</span>\src\components\form<span class="literal">-checkbox</span>\_form<span class="literal">-checkbox</span>.scss <span class="number">10</span>:<span class="number">10</span>  @import</span><br><span class="line">&lt;w&gt; node_modules\bootstrap<span class="literal">-vue</span>\src\components\form<span class="literal">-checkbox</span>\index.scss <span class="number">1</span>:<span class="number">9</span>             @import</span><br><span class="line">&lt;w&gt; node_modules\bootstrap<span class="literal">-vue</span>\src\components\index.scss <span class="number">5</span>:<span class="number">9</span>                           @import</span><br><span class="line">&lt;w&gt; node_modules\bootstrap<span class="literal">-vue</span>\src\index.scss <span class="number">14</span>:<span class="number">9</span>                                     @import</span><br><span class="line">&lt;w&gt; src\scss\bootstrap.scss <span class="number">11</span>:<span class="number">9</span>                                                       root stylesheet</span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; Deprecation <span class="keyword">Using</span> / for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0.</span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; Recommendation: math.div(<span class="variable">$font</span><span class="literal">-size</span><span class="literal">-lg</span> * <span class="variable">$line</span><span class="literal">-height</span><span class="literal">-lg</span> - <span class="variable">$b</span><span class="literal">-custom</span><span class="literal">-control</span><span class="literal">-indicator</span><span class="literal">-size</span><span class="literal">-lg</span>, <span class="number">2</span>) or calc((<span class="variable">$font</span><span class="literal">-size</span><span class="literal">-lg</span> * <span class="variable">$line</span><span class="literal">-height</span><span class="literal">-lg</span> - <span class="variable">$b</span><span class="literal">-custom</span><span class="literal">-control</span><span class="literal">-indicator</span><span class="literal">-size</span><span class="literal">-lg</span>) / <span class="number">2</span>)</span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; More info and automated migrator: https://sass<span class="literal">-lang</span>.com/d/slash<span class="literal">-div</span></span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; node_modules\bootstrap<span class="literal">-vue</span>\src\components\form<span class="literal">-checkbox</span>\_form<span class="literal">-checkbox</span>.scss <span class="number">18</span>:<span class="number">10</span>  @import</span><br><span class="line">&lt;w&gt; node_modules\bootstrap<span class="literal">-vue</span>\src\components\form<span class="literal">-checkbox</span>\index.scss <span class="number">1</span>:<span class="number">9</span>             @import</span><br><span class="line">&lt;w&gt; node_modules\bootstrap<span class="literal">-vue</span>\src\components\index.scss <span class="number">5</span>:<span class="number">9</span>                           @import</span><br><span class="line">&lt;w&gt; node_modules\bootstrap<span class="literal">-vue</span>\src\index.scss <span class="number">14</span>:<span class="number">9</span>                                     @import</span><br><span class="line">&lt;w&gt; src\scss\bootstrap.scss <span class="number">11</span>:<span class="number">9</span>                                                       root stylesheet</span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; Deprecation <span class="keyword">Using</span> / for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0.</span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; Recommendation: math.div(<span class="variable">$font</span><span class="literal">-size</span><span class="literal">-sm</span> * <span class="variable">$line</span><span class="literal">-height</span><span class="literal">-sm</span> - <span class="variable">$b</span><span class="literal">-custom</span><span class="literal">-control</span><span class="literal">-indicator</span><span class="literal">-size</span><span class="literal">-sm</span>, <span class="number">2</span>) or calc((<span class="variable">$font</span><span class="literal">-size</span><span class="literal">-sm</span> * <span class="variable">$line</span><span class="literal">-height</span><span class="literal">-sm</span> - <span class="variable">$b</span><span class="literal">-custom</span><span class="literal">-control</span><span class="literal">-indicator</span><span class="literal">-size</span><span class="literal">-sm</span>) / <span class="number">2</span>)</span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; More info and automated migrator: https://sass<span class="literal">-lang</span>.com/d/slash<span class="literal">-div</span></span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; node_modules\bootstrap<span class="literal">-vue</span>\src\components\form<span class="literal">-checkbox</span>\_form<span class="literal">-checkbox</span>.scss <span class="number">33</span>:<span class="number">10</span>  @import</span><br><span class="line">&lt;w&gt; node_modules\bootstrap<span class="literal">-vue</span>\src\components\form<span class="literal">-checkbox</span>\index.scss <span class="number">1</span>:<span class="number">9</span>             @import</span><br><span class="line">&lt;w&gt; node_modules\bootstrap<span class="literal">-vue</span>\src\components\index.scss <span class="number">5</span>:<span class="number">9</span>                           @import</span><br><span class="line">&lt;w&gt; node_modules\bootstrap<span class="literal">-vue</span>\src\index.scss <span class="number">14</span>:<span class="number">9</span>                                     @import</span><br><span class="line">&lt;w&gt; src\scss\bootstrap.scss <span class="number">11</span>:<span class="number">9</span>                                                       root stylesheet</span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; <span class="number">17</span> repetitive deprecation warnings omitted.</span><br><span class="line">&lt;w&gt;</span><br><span class="line">&lt;w&gt; null</span><br></pre></td></tr></table></figure><p>부트스트랩에서 사용중인 문법을 어떻게 바꾸라고 안내하지만 의존성에서 제공하는 파일을 수정할 수는 없습니다. 그래서 위 경고 로그를 출력하지 않게 하는 방법이 필요합니다.</p><h3 id="Dart-Sass-quietDeps"><a href="#Dart-Sass-quietDeps" class="headerlink" title="Dart Sass - quietDeps"></a>Dart Sass - quietDeps</h3><p>다행스럽게도 Dart Sass 에서는 <a href="https://sass-lang.com/documentation/cli/dart-sass#quiet-deps">quietDeps</a>옵션을 제공하여 의존성에 대한 Deprecation 경고 출력을 하지 않도록 지원합니다.<br>만약, 웹팩에서 sass-loader를 사용한다면 다음과 같이 <strong>sassOptions</strong> 속성으로 위 옵션을 적용할 수 있습니다.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.s[ac]ss$/i</span>,</span><br><span class="line">        use: [</span><br><span class="line">          <span class="comment">// ...</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&quot;sass-loader&quot;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">              <span class="attr">sourceMap</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">sassOptions</span>: &#123;</span><br><span class="line">                <span class="attr">quietDeps</span>: [<span class="string">&quot;node_modules/bootstrap/**/*.scss&quot;</span>],</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>이제 부트스트랩의 SCSS 파일을 임포트하더라도 더이상 경고 로그는 출력되지 않게 되었습니다.<br>감사합니다.</p><h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul><li><a href="https://sass-lang.com/documentation/cli/dart-sass#quiet-deps">Dart Sass - quiet-deps</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 특정 디펜던시에 대한 Dart Sass의 Deprecation 경고를 제외하는 방법에 대해서 공유하려고 합니다.&lt;/p&gt;
&lt;h2 id=&quot;Deprecation-Warnings&quot;&gt;&lt;a href=&quot;#De</summary>
      
    
    
    
    
    <category term="Dart Sass" scheme="https://kdevkr.github.io/tags/Dart-Sass/"/>
    
    <category term="quietDeps" scheme="https://kdevkr.github.io/tags/quietDeps/"/>
    
  </entry>
  
  <entry>
    <title>프로젝트의 노드 버전 제한하기</title>
    <link href="https://kdevkr.github.io/strict-nodejs-version-for-project/"/>
    <id>https://kdevkr.github.io/strict-nodejs-version-for-project/</id>
    <published>2021-12-26T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.035Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 함께 일하는 개발자들이 프로젝트마다 사용해야하는 노드 버전을 제한하는 방법에 대하여 공유하려고 해요.</p><h2 id="프로젝트-노드-버전-제한"><a href="#프로젝트-노드-버전-제한" class="headerlink" title="프로젝트 노드 버전 제한"></a>프로젝트 노드 버전 제한</h2><p>프로젝트에서 사용하는 패키지마다 지원하는 최소 노드 버전이 다를 수 있습니다. 예를 들어, 다음과 같이 패키지 버전이 업데이트되면서 요구하는 노드 버전이 변경될 수 있습니다.</p><ul><li><a href="https://webpack.js.org/blog/2020-10-10-webpack-5-release/#minimum-nodejs-version">webpack@5.0.0</a> minimum supported Node.js version is 10.13.0</li><li><a href="https://github.com/webpack-contrib/style-loader/releases/tag/v3.0.0">style-loader@3.0.0</a> minimum supported Node.js version is 12.13.0</li><li><a href="https://github.com/webpack/webpack-dev-server/blob/master/CHANGELOG.md#400-beta3-2021-05-06">webpack-dev-server@4.0.0-beta.3</a> minimum supported Node.js version is 12.13.0</li></ul><h3 id="Package-json"><a href="#Package-json" class="headerlink" title="Package.json"></a>Package.json</h3><p>Package.json 파일의 <code>engines</code> 속성으로 프로젝트에서 사용하는 NPM 또는 노드 버전을 명시할 수 있습니다.</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;engines&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;npm&quot;</span>: <span class="string">&quot;&gt;=6.4.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;node&quot;</span>: <span class="string">&quot;&gt;=12.13.0&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="엔진-제한-옵션-활성화"><a href="#엔진-제한-옵션-활성화" class="headerlink" title="엔진 제한 옵션 활성화"></a>엔진 제한 옵션 활성화</h3><p>Package.json 파일에 노드 버전을 명시하더라도 사용자의 엔진을 제한할 수는 없습니다. 이를 별도로 제한하기 위해서는 프로젝트 폴더에 .npmrc 파일을 만들고 <code>engine-strict</code> 옵션을 활성화해야합니다.</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">engine-strict</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure><h3 id="노드-엔진-제한-여부-확인"><a href="#노드-엔진-제한-여부-확인" class="headerlink" title="노드 엔진 제한 여부 확인"></a>노드 엔진 제한 여부 확인</h3><p>노드 버전을 명시하고 엔진 제한 옵션을 활성화하였으므로 실제로 노드 엔진이 제한되는지 확인해보겠습니다.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm i</span><br><span class="line">npm ERR! code ENOTSUP</span><br><span class="line">npm ERR! notsup Unsupported engine <span class="keyword">for</span> @1.0.0: wanted: &#123;<span class="string">&quot;npm&quot;</span>:<span class="string">&quot;&gt;=6.4.1&quot;</span>,<span class="string">&quot;node&quot;</span>:<span class="string">&quot;&gt;=12.13.0&quot;</span>&#125; (current: &#123;<span class="string">&quot;node&quot;</span>:<span class="string">&quot;10.23.0&quot;</span>,<span class="string">&quot;npm&quot;</span>:<span class="string">&quot;6.14.8&quot;</span>&#125;)</span><br><span class="line">npm ERR! notsup Not compatible with your version of node/npm: @1.0.0</span><br><span class="line">npm ERR! notsup Not compatible with your version of node/npm: @1.0.0</span><br><span class="line">npm ERR! notsup Required: &#123;<span class="string">&quot;npm&quot;</span>:<span class="string">&quot;&gt;=6.4.1&quot;</span>,<span class="string">&quot;node&quot;</span>:<span class="string">&quot;&gt;=12.13.0&quot;</span>&#125;</span><br><span class="line">npm ERR! notsup Actual:   &#123;<span class="string">&quot;npm&quot;</span>:<span class="string">&quot;6.14.8&quot;</span>,<span class="string">&quot;node&quot;</span>:<span class="string">&quot;10.23.0&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>현재 사용중인 노드 버전은 10.23.0 이지만 프로젝트에서 요구하는 버전은 12.13.0 이상이므로 오류가 발생하였습니다.</p><p>이상으로 프로젝트에서 지원하는 최소 노드 엔진 버전을 명시하고 프로젝트에 참여하는 모든 개발자들이 알맞은 노드 버전을 사용하도록 안내할 수 있게 되었습니다.</p><p>감사합니다.</p><h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul><li><a href="https://medium.com/@fabian.illner/force-correct-node-js-version-with-npm-a2a57fd12fa">Force correct Node.js version with npm</a>  </li><li><a href="https://www.geeksforgeeks.org/how-to-define-the-required-node-js-version-in-package-json/">How to define the required Node.js version in package.json?</a>  </li><li><a href="https://reactgo.com/specify-node-version/">Specifying a required Node.js version in Package.json file</a>  </li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 함께 일하는 개발자들이 프로젝트마다 사용해야하는 노드 버전을 제한하는 방법에 대하여 공유하려고 해요.&lt;/p&gt;
&lt;h2 id=&quot;프로젝트-노드-버전-제한&quot;&gt;&lt;a href=&quot;#프로젝트-노드-버전-제한&quot; </summary>
      
    
    
    
    
    <category term="package.json" scheme="https://kdevkr.github.io/tags/package-json/"/>
    
    <category term="npmrc" scheme="https://kdevkr.github.io/tags/npmrc/"/>
    
    <category term="engines" scheme="https://kdevkr.github.io/tags/engines/"/>
    
  </entry>
  
  <entry>
    <title>Unsupported allowDuplicateContentLengths in Spring Cloud Gateway of Hoxton Version</title>
    <link href="https://kdevkr.github.io/unsupported-allowduplicatecontentlength-in-spring-cloud-gateway-of-hoxton-version/"/>
    <id>https://kdevkr.github.io/unsupported-allowduplicatecontentlength-in-spring-cloud-gateway-of-hoxton-version/</id>
    <published>2021-12-19T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.035Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 스프링 클라우드 게이트웨이에서 발생하는 Content-Length 헤더의 값이 단일이 아닌 복수로 지정될 때 발생하는 오류에 대해 다루어보려고 합니다.</p><h2 id="RFC-7230"><a href="#RFC-7230" class="headerlink" title="RFC 7230"></a>RFC 7230</h2><p><a href="https://datatracker.ietf.org/doc/html/rfc7230#section-3.3.2">RFC 7230 - 3.3.2. Content-Length</a>를 참고해보면 다른 헤더들과는 다르게 Content-Length 헤더는 단일로 구성되어야 한다고 규정합니다. 다만, 다음과 내용을 통해 Content-Length 헤더 값이 복수로 구성되는 경우는 수신자가 오류로 처리하거나 단일 값으로 처리해야한다고 설명하고 있습니다.</p><blockquote><p>If a message is received that has multiple Content-Length header fields with field-values consisting of the same decimal value, or a single Content-Length header field with a field value containing a list of identical decimal values (e.g., “Content-Length: 42, 42”), indicating that duplicate Content-Length header fields have been generated or combined by an upstream message processor, then the recipient MUST either reject the message as invalid or replace the duplicated field-values with a single valid Content-Length field containing that decimal value prior to determining the message body length or forwarding the message.</p></blockquote><h2 id="오류-및-원인-분석"><a href="#오류-및-원인-분석" class="headerlink" title="오류 및 원인 분석"></a>오류 및 원인 분석</h2><p>스프링 클라우드 게이트웨이에서 발생한 오류에 대한 내용은 <a href="https://github.com/spring-cloud/spring-cloud-gateway/issues/2465">Multiple Content-Length values found: [229455, 229455]</a>에서 확인할 수 있습니다.</p><p>모든 스프링 클라우드 게이트웨이 버전에서 발생하는 상황은 아니었으며 스프링 부트 2.3.x와 호환성이 검증된 스프링 클라우드 Hoxton 릴리즈 트레인으로 관리되는 스프링 클라우드 게이트웨이 서버에서 발생하였습니다. Content-Length 헤더 값이 복수로 지정되는 것은 브라우저에서 실행간으한 wav, mp3, webm 파일을 요청할 때 발생한 것으로 일반적인 curl 또는 Postman을 통해서는 정상적으로 응답이 수행되었습니다.</p><h3 id="HttpUtil-normalizeAndGetContentLength"><a href="#HttpUtil-normalizeAndGetContentLength" class="headerlink" title="HttpUtil#normalizeAndGetContentLength"></a>HttpUtil#normalizeAndGetContentLength</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java.lang.IllegalArgumentException: Multiple Content-Length values found: [<span class="number">229455</span>, <span class="number">229455</span>]</span><br><span class="line">at io.netty.handler.codec.http.HttpUtil.normalizeAndGetContentLength(HttpUtil.java:<span class="number">595</span>) ~[netty-codec-http-<span class="number">4.1</span><span class="number">.65</span>.Final.jar:<span class="number">4.1</span><span class="number">.65</span>.Final]</span><br><span class="line">Suppressed: reactor.core.publisher.FluxOnAssembly$OnAssemblyException: </span><br><span class="line"><span class="function">Error has been observed at the following <span class="title">site</span><span class="params">(s)</span>:</span></span><br></pre></td></tr></table></figure><p>위 스택트레이스 내용에 따르면 Netty 라이브러리의 netty-codec-http 모듈에서 HttpUtil.normalizeAndGetContentLength 함수로 처리될 때 오류가 던져졌음을 확인할 수 있습니다. 또한, netty-codec-http 모듈의 <a href="https://github.com/netty/netty/blob/c08beb543a6b8db0c7f3cee225042361b4025e4c/codec-http/src/main/java/io/netty/handler/codec/http/HttpUtil.java#L555-L560">HttpUtil#normarlizeAndGetContentLength</a>에는 allowDuplicateContentLengths 파라미터를 통해 복수의 동일한 값이 지정되더라도 단일 값으로 처리되도록 구현되어있는 상태입니다.</p><h3 id="Reactor-Netty-HttpDecoderSpec"><a href="#Reactor-Netty-HttpDecoderSpec" class="headerlink" title="Reactor Netty - HttpDecoderSpec"></a>Reactor Netty - HttpDecoderSpec</h3><p>이미 allowDuplicateContentLengths 옵션을 지원하는데도 불구하고 스프링 클라우드 Hoxton 버전에서 의존하는 reactor-netty:0.9.x.RELEASE 에서는 HttpDecoderSpec 클래스가 allowDuplicateContentLengths 옵션을 지원하지 않았습니다.</p><p>더 자세한 정보를 찾아본 결과 HttpDecoderSpec에서 allowDuplicateContentLengths 옵션이 지원되는 것은 <a href="https://github.com/reactor/reactor-netty/pull/1638/commits/978ba8a737f26376d1caab4806e25420e7aac7b7">Add HttpDecoderSpec#allowDuplicateContentLengths(boolean) #1638</a>으로 처리되었으며 <a href="https://github.com/reactor/reactor-netty/releases/tag/v1.0.8">Reactor Netty 1.0.8</a>에서부터 추가되어 반영되었음을 확인할 수 있었습니다. 그러나 위 반영 내용은 Reactor Netty 0.9.x 사용자들을 위한 Dysprosium 릴리즈 트레인에서 <a href="https://github.com/reactor/reactor-netty/releases/tag/v0.9.25.RELEASE">Reactor Netty 0.9.25.RELEASE</a>로 릴리즈 계획이 종료되기까지 반영되지 않은 사항입니다. </p><blockquote><p>Reactor Netty 0.9.x 사용자들을 위해 allowDuplicateContentLengths 옵션 지원을 반영할 수 있는지 <a href="https://github.com/reactor/reactor-netty/issues/1942">allowDuplicateContentLengths for Reactor Netty 0.9.x users #1942</a> 이슈를 등록해두었습니다. 이 이슈가 처리되기전까지는 HttpDecoderSpec에서 allowDuplicateContentLengths 파라미터를 활성화할 수 없습니다.</p></blockquote><h2 id="해결방안"><a href="#해결방안" class="headerlink" title="해결방안"></a>해결방안</h2><p>Content-Length 헤더에 중복된 동일한 값이 설정되는 문제를 해결하기 위해서는 allowDuplicateContentLengths 옵션이 적용될 수 있도록 해야만합니다. 스프링 클라우드 게이트웨이 서버 스타터에서 자동 구성할 때 HttpClient에 대한 HttpClientCustomizer를 지원함에도 불구하고 의존하고 있는 HttpDecoderSpec에서 allowDuplicateContentLengths를 적용할 수 있어야만 합니다. 따라서, Reactor Netty 의존성 버전을 1.0.8 이상으로 변경할 수 밖에 없습니다.</p><h3 id="첫번째-시도-Reactor-Bom-변경"><a href="#첫번째-시도-Reactor-Bom-변경" class="headerlink" title="첫번째 시도 - Reactor Bom 변경"></a>첫번째 시도 - Reactor Bom 변경</h3><p>혹시나 Reactor Netty 의존성 버전을 변경하여 가능할지도 모른다는 생각으로 버전 업그레이드를 시도해보았습니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">ext &#123;</span><br><span class="line">    set(<span class="string">&#x27;springCloudVersion&#x27;</span>, <span class="string">&#x27;Hoxton.SR12&#x27;</span>),</span><br><span class="line">    set(<span class="string">&#x27;reactorNettyVersion&#x27;</span>, <span class="string">&#x27;2020.0.8&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line">dependencyManagement &#123;</span><br><span class="line">    imports &#123;</span><br><span class="line">        mavenBom <span class="string">&quot;org.springframework.cloud:spring-cloud-dependencies:$&#123;springCloudVersion&#125;&quot;</span></span><br><span class="line">        mavenBom <span class="string">&quot;io.projectreactor:reactor-bom:$&#123;reactorNettyVersion&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Reactor Netty 버전을 변경하기 위해 Reactor Bom을 적용해본 결과 다음과 같이 reactor.netty.tcp.ProxyProvider를 클래스로더에서 찾을 수 없는 상태가 되었습니다.</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Caused by: java.lang.NoClassDefFoundError: reactor/netty/tcp/ProxyProvider$Builder</span><br><span class="line">at java.base/java.lang.Class.getDeclaredMethods0(Native Method) ~[na:na]</span><br><span class="line">at java.base/java.lang.Class.privateGetDeclaredMethods(Class.java:<span class="number">3166</span>) ~[na:na]</span><br><span class="line">at java.base/java.lang.Class.getDeclaredMethods(Class.java:<span class="number">2309</span>) ~[na:na]</span><br><span class="line">at org.springframework.util.ReflectionUtils.getDeclaredMethods(ReflectionUtils.java:<span class="number">463</span>) ~[spring-core-<span class="number">5.2</span><span class="number">.15</span>.RELEASE.jar:<span class="number">5.2</span><span class="number">.15</span>.RELEASE]</span><br><span class="line">... <span class="number">19</span> common frames omitted</span><br><span class="line">Caused by: java.lang.ClassNotFoundException: reactor.netty.tcp.ProxyProvider$Builder</span><br><span class="line">at java.base/jdk.internal.loader.BuiltinClassLoader.loadClass(BuiltinClassLoader.java:<span class="number">581</span>) ~[na:na]</span><br><span class="line">at java.base/jdk.internal.loader.ClassLoaders$AppClassLoader.loadClass(ClassLoaders.java:<span class="number">178</span>) ~[na:na]</span><br><span class="line">at java.base/java.lang.ClassLoader.loadClass(ClassLoader.java:<span class="number">522</span>) ~[na:na]</span><br><span class="line">... <span class="number">23</span> common frames omitted</span><br></pre></td></tr></table></figure><p>이러한 문제가 발생하는 이유는 <a href="https://github.com/reactor/reactor-netty/releases/tag/v1.0.0">Reactor Netty 1.0.0</a>에서부터 reactor.netty.tcp.ProxyProvider가 reactor.netty.transport.ProxyProvider로 변경되었기 때문입니다. 스프링 클라우드 Hoxton에서는 Reactor Netty 0.9.x의 클래스들을 사용하기 때문에 단순하게 Reactor Netty 의존성 버전을 변경할 수는 없습니다.</p><h3 id="두번째-시도-Spring-Cloud-버전-업그레이드"><a href="#두번째-시도-Spring-Cloud-버전-업그레이드" class="headerlink" title="두번째 시도 - Spring Cloud 버전 업그레이드"></a>두번째 시도 - Spring Cloud 버전 업그레이드</h3><p>Reactor Netty 1.0.8을 사용하기 위해서는 스프링 클라우드 2020.0.x aka Ilford 릴리즈 트레인의 스프링 클라우드와 함께 스프링 부트 2.4.x로 업그레이드해야합니다. 테스트 중인 프로젝트에서는 그래들 멀티 프로젝트로 구성되어 스프링 클라우드 게이트웨이 서버와 애플리케이션 서버가 동일한 스프링 부트 버전을 사용하고 있었습니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;rog.springframework.boot&#x27;</span> version <span class="string">&#x27;2.4.13&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">ext &#123;</span><br><span class="line">    set(<span class="string">&#x27;springCloudVersion&#x27;</span>, <span class="string">&#x27;2020.0.0&#x27;</span>),</span><br><span class="line">    set(<span class="string">&#x27;reactorNettyVersion&#x27;</span>, <span class="string">&#x27;2020.0.8&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line">dependencyManagement &#123;</span><br><span class="line">    imports &#123;</span><br><span class="line">        mavenBom <span class="string">&quot;org.springframework.cloud:spring-cloud-dependencies:$&#123;springCloudVersion&#125;&quot;</span></span><br><span class="line">        mavenBom <span class="string">&quot;io.projectreactor:reactor-bom:$&#123;reactorNettyVersion&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>스프링 부트 2.4 부터 변경된 사항에 대해서 검토하여야합니다.</p></blockquote><p>아쉽게도 스프링 부트 버전과 스프링 클라우드 버전을 업그레이드 하고나서는 Content-Length에 복수로 설정되던 파일들이 정상적으로 단일 값으로 처리되어 allowDuplicateContentLengths 적용이 필요하지 않은 상태가 되었습니다. 만약, allowDuplicateContentLengths 적용이 필요하다면 다음과 같이 HttpClientCustomzier를 통해 구성할 수 있습니다.</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyHttpClientCustomizer</span> <span class="keyword">implements</span> <span class="title">HttpClientCustomizer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpClient <span class="title">customize</span><span class="params">(HttpClient httpClient)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> httpClient.httpResponseDecoder(decoderSpec -&gt; </span><br><span class="line">            decoderSpec</span><br><span class="line">                .allowDuplicateContentLengths(<span class="keyword">true</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이 내용은 Okky 커뮤니티에 <a href="https://okky.kr/article/1122985">Spring Cloud Hoxton의 Spring Cloud Gateway에서는 allowDuplicateContentLengths을 지원하지 않음</a>로 공유되었음을 알려드리며 마치도록 하겠습니다.</p><p>감사합니다.</p><blockquote><p><a href="https://github.com/reactor/reactor-netty/issues/1942">https://github.com/reactor/reactor-netty/issues/1942</a><br>Reactor Netty 측에 0.9.x 사용자들을 위해 수정 요청하였으나 업데이트 중단된 버전인 사유로 거부되었습니다.</p></blockquote><h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul><li><a href="https://datatracker.ietf.org/doc/html/rfc7230">RFC 7230</a>  </li><li><a href="https://spring.io/projects/spring-cloud">Spring Cloud Release train Spring Boot compatibility</a></li><li><a href="https://github.com/spring-cloud/spring-cloud-gateway">spring-cloud/spring-cloud-gateway</a></li><li><a href="https://github.com/reactor/reactor-netty/releases/tag/v1.0.8">Reactor Netty 1.0.8 Release</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 스프링 클라우드 게이트웨이에서 발생하는 Content-Length 헤더의 값이 단일이 아닌 복수로 지정될 때 발생하는 오류에 대해 다루어보려고 합니다.&lt;/p&gt;
&lt;h2 id=&quot;RFC-7230&quot;&gt;&lt;a</summary>
      
    
    
    
    
    <category term="Spring Cloud Gateway" scheme="https://kdevkr.github.io/tags/Spring-Cloud-Gateway/"/>
    
    <category term="RFC 7230" scheme="https://kdevkr.github.io/tags/RFC-7230/"/>
    
    <category term="Reactor Netty" scheme="https://kdevkr.github.io/tags/Reactor-Netty/"/>
    
  </entry>
  
  <entry>
    <title>그래들 멀티 모듈 프로젝트</title>
    <link href="https://kdevkr.github.io/gradle-multi-module-project/"/>
    <id>https://kdevkr.github.io/gradle-multi-module-project/</id>
    <published>2021-12-10T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.031Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 그래들 멀티 모듈 프로젝트의 디펜던시 공유에 대하여 이야기 해보려고 합니다. </p><h2 id="그래들-멀티-모듈"><a href="#그래들-멀티-모듈" class="headerlink" title="그래들 멀티 모듈"></a>그래들 멀티 모듈</h2><p>서비스의 규모가 어느정도 커지게되면 모놀리식 아키텍처로써 서비스에 대한 모든 기능이 하나의 애플리케이션에 구현하는 것을 마이크로서비스 아키텍처를 참고하여 일부 기능을 수행하는 별도의 애플리케이션로 독립시키기도 합니다. 현재 다니고 있는 회사에서는 모놀리식 아키텍처로 개발하고 있는 애플리케이션을 여러 고객들의 환경에 맞는 배포 또는 별도의 커스텀 기능을 지원하기 위하여 <strong>그래들 멀티 모듈 프로젝트</strong>로 전환하였습니다.</p><h3 id="Java-라이브러리-플러그인"><a href="#Java-라이브러리-플러그인" class="headerlink" title="Java 라이브러리 플러그인"></a>Java 라이브러리 플러그인</h3><p>공용 모듈에서 사용하는 디펜던시를 상위 모듈에서도 사용하기 위해서는 자바 플러그인 대신 자바 라이브러리 플러그인을 적용하고 <code>api</code>를 사용하여 지정된 디펜던시를 외부 모듈의 컴파일 클래스패스에 노출시켜야합니다. Gradle 7 부터는 <code>compile</code>을 지원하지 않으며 <code>implementation</code>은 지정한 디펜던시를 외부 모듈에 노출시키지 않습니다.</p><blockquote><p>The compile and runtime configurations have been removed with Gradle 7.0. Please refer to the upgrade guide how to migrate to implementation and api configurations`.</p></blockquote><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">// module-common/build.gradle</span></span><br><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;java-library&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;io.spring.dependency-management&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    api <span class="string">&#x27;com.google.code.gson:gson&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>common 모듈의 gson 라이브러리는 api를 통해 상위 모듈의 클래스패스에 노출되어 상위 모듈에서도 사용이 가능해집니다. 기본적으로 implementation을 사용하는 경우 외부 모듈 클래스패스에 노출시키지 않는 이유는 빠른 컴파일과 클래스패스 사이즈를 줄이기 위함이며 api 보다는 implementation을 선호해야한다고 합니다.</p><h3 id="Common-Module"><a href="#Common-Module" class="headerlink" title="Common Module"></a>Common Module</h3><p><a href="https://github.com/kdevkr/gradle-multi-module">gradle-multi-module</a> 처럼 그래들 멀티 모듈 프로젝트에 공용으로 적용되는 코드를 가지는 Common 모듈이 있을때 다음과 같이 공통으로 적용되어야하는 설정을 수행할 수 있습니다.</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Jackson2ObjectMapperBuilderCustomizer <span class="title">objectMapperBuilderCustomizer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> builder -&gt; builder</span><br><span class="line">                .featuresToEnable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS)</span><br><span class="line">                .featuresToDisable(SerializationFeature.WRITE_DATE_TIMESTAMPS_AS_NANOSECONDS)</span><br><span class="line">                .modules(List.of(<span class="keyword">new</span> Jdk8Module(), <span class="keyword">new</span> JavaTimeModule()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위 코드에서는 Date 또는 Timestamp와 같은 클래스에 대하여 Long 값으로 변환하는 기능을 활성화하기 위하여 SerializationFeature.WRITE_DATES_AS_TIMESTAMPS를 적용하였습니다. </p><h4 id="Common-Dependencies"><a href="#Common-Dependencies" class="headerlink" title="Common Dependencies"></a>Common Dependencies</h4><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;java-library&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    api <span class="string">&#x27;org.springframework.boot:spring-boot-starter-security&#x27;</span></span><br><span class="line">    api <span class="string">&#x27;com.google.code.gson:gson&#x27;</span></span><br><span class="line">    api <span class="string">&#x27;com.fasterxml.jackson.core:jackson-databind&#x27;</span></span><br><span class="line">    api <span class="string">&#x27;org.hibernate.validator:hibernate-validator&#x27;</span></span><br><span class="line">    api <span class="string">&#x27;org.apache.commons:commons-lang3&#x27;</span></span><br><span class="line">    api <span class="string">&#x27;org.apache.commons:commons-collections4:4.4&#x27;</span></span><br><span class="line">    api <span class="string">&#x27;com.google.guava:guava:31.0.1-jre&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위 설정처럼 implementation 대신에 api를 사용하면 동일한 버전의 디펜던시를 다른 외부 모듈에서도 사용할 수 있도록 클래스패스에 노출할 수 있습니다. 이를 통해 각 모듈에서 사용되는 디펜던시 버전이 달라서 발생할 수 있는 문제를 방지할 수 있게 됩니다.</p><h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul><li><a href="https://docs.gradle.org/current/userguide/dependency_management_for_java_projects.html">Managing Dependencies of JVM Projects</a>  </li><li><a href="https://docs.gradle.org/current/userguide/java_library_plugin.html#sec:java_library_configurations_graph">The Java Library Plugin</a>  </li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 그래들 멀티 모듈 프로젝트의 디펜던시 공유에 대하여 이야기 해보려고 합니다. &lt;/p&gt;
&lt;h2 id=&quot;그래들-멀티-모듈&quot;&gt;&lt;a href=&quot;#그래들-멀티-모듈&quot; class=&quot;headerlink&quot; ti</summary>
      
    
    
    
    
    <category term="Gradle" scheme="https://kdevkr.github.io/tags/Gradle/"/>
    
  </entry>
  
  <entry>
    <title>KDB+</title>
    <link href="https://kdevkr.github.io/kdbplus/"/>
    <id>https://kdevkr.github.io/kdbplus/</id>
    <published>2021-11-05T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.031Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>이 글은 KDB+라는 시계열 데이터베이스를 활용하면서 국내 레퍼런스를 찾아볼 수 없는 문제로 인하여 별도로 정리한 내용입니다. 따라서, 전문적으로 활용하는 수준은 아니므로 잘못된 정보가 포함되어있을 수 있음을 알려드립니다. KDB+에 대한 더 자세한 내용은 <a href="https://github.com/kdevkr/kdb%EB%A5%BC">https://github.com/kdevkr/kdb를</a> 참고하시기 바랍니다.</p></blockquote><h2 id="KDB"><a href="#KDB" class="headerlink" title="KDB+"></a>KDB+</h2><p><a href="https://kx.com/">KDB+</a>는 KxSystems라는 회사에서 개발하고 제공하는 상용 시계열 데이터베이스입니다. 메모리 엔진을 사용하므로 데이터를 넣거나 연산을 수행하는 시간이 굉장히 짧습니다. 그러나 q 라는 자체적으로 고안한 언어에 대해서 이해해야해서 러닝커브에 대한 단점이 있습니다. 예를 들어, 다음은 KxSystems에서 권장하는 <a href="https://github.com/KxSystems/kdb-tick/blob/master/tick.q">Tickerplant라는 아키텍처의 스크립트 일부분</a>입니다.</p><figure class="highlight q"><table><tr><td class="code"><pre><span class="line">ld:&#123;if[<span class="built_in">not</span> <span class="built_in">type</span> <span class="built_in">key</span> L::`$(<span class="number">-10</span>_string L),<span class="built_in">string</span> x;.[L;();:;()]];i::j::<span class="number">-11</span>!(<span class="number">-2</span>;L);if[<span class="number">0</span>&lt;=<span class="built_in">type</span> i;<span class="number">-2</span> (<span class="built_in">string</span> L),<span class="string">&quot; is a corrupt log. Truncate to length &quot;</span>,(<span class="built_in">string</span> last i),<span class="string">&quot; and restart&quot;</span>;exit <span class="number">1</span>];<span class="built_in">hopen</span> L&#125;;</span><br><span class="line">tick:&#123;init[];if[<span class="built_in">not</span> <span class="built_in">min</span>(<span class="type">`time</span>`sym~<span class="number">2</span>#<span class="built_in">key</span> <span class="built_in">flip</span> <span class="built_in">value</span>@)<span class="built_in">each</span> t;&#x27;`timesym];@[;`sym;`g#]<span class="built_in">each</span> t;d::.z.D;if[l::<span class="built_in">count</span> y;L::`$<span class="string">&quot;:&quot;</span>,y,<span class="string">&quot;/&quot;</span>,x,<span class="number">10</span>#<span class="string">&quot;.&quot;</span>;l::ld d]&#125;;</span><br><span class="line"></span><br><span class="line">endofday:&#123;end d;d+:<span class="number">1</span>;if[l;<span class="built_in">hclose</span> l;l::<span class="number">0</span>(`.u.ld;d)]&#125;;</span><br><span class="line">ts:&#123;if[d&lt;x;if[d&lt;x<span class="number">-1</span>;<span class="built_in">system</span><span class="string">&quot;t 0&quot;</span>;&#x27;<span class="string">&quot;more than one day?&quot;</span>];endofday[]]&#125;;</span><br><span class="line"></span><br><span class="line">if[<span class="built_in">system</span><span class="string">&quot;t&quot;</span>;</span><br><span class="line"> .z.ts:&#123;pub&#x27;[t;<span class="built_in">value</span> <span class="built_in">each</span> t];@[`.;t;@[;`sym;`g#]<span class="number">0</span>#];i::j;ts .z.D&#125;;</span><br><span class="line"> upd:&#123;[t;x]</span><br><span class="line"> if[<span class="built_in">not</span> <span class="number">-16</span>=<span class="built_in">type</span> <span class="built_in">first</span> <span class="built_in">first</span> x;if[d&lt;<span class="string">&quot;d&quot;</span>$a:.z.P;.z.ts[]];a:<span class="string">&quot;n&quot;</span>$a;x:$[<span class="number">0</span>&gt;<span class="built_in">type</span> <span class="built_in">first</span> x;a,x;(<span class="built_in">enlist</span>(<span class="built_in">count</span> <span class="built_in">first</span> x)#a),x]];</span><br><span class="line"> t insert x;if[l;l <span class="built_in">enlist</span> (`upd;t;x);j+:<span class="number">1</span>];&#125;];</span><br><span class="line"></span><br><span class="line">if[<span class="built_in">not</span> <span class="built_in">system</span><span class="string">&quot;t&quot;</span>;<span class="built_in">system</span><span class="string">&quot;t 1000&quot;</span>;</span><br><span class="line"> .z.ts:&#123;ts .z.D&#125;;</span><br><span class="line"> upd:&#123;[t;x]ts<span class="string">&quot;d&quot;</span>$a:.z.P;</span><br><span class="line"> if[<span class="built_in">not</span> <span class="number">-16</span>=<span class="built_in">type</span> <span class="built_in">first</span> <span class="built_in">first</span> x;a:<span class="string">&quot;n&quot;</span>$a;x:$[<span class="number">0</span>&gt;<span class="built_in">type</span> <span class="built_in">first</span> x;a,x;(<span class="built_in">enlist</span>(<span class="built_in">count</span> <span class="built_in">first</span> x)#a),x]];</span><br><span class="line"> f:<span class="built_in">key</span> <span class="built_in">flip</span> <span class="built_in">value</span> t;pub[t;$[<span class="number">0</span>&gt;<span class="built_in">type</span> <span class="built_in">first</span> x;<span class="built_in">enlist</span> f!x;<span class="built_in">flip</span> f!x]];if[l;l <span class="built_in">enlist</span> (`upd;t;x);i+:<span class="number">1</span>];&#125;];</span><br></pre></td></tr></table></figure><p>KDB+에서는 q라는 언어로 작성된 스크립트를 사용합니다. 위처럼 KxSystems에서 제공하는 샘플 스크립트가 존재하기는 하지만 코드에 대한 설명이 없으므로 위 코드를 이해하는 건 전부 사용자인 개발자의 몫이며 이로 인하여 러닝커브가 높을 수 있습니다. 저는 Q 언어에 대한 튜토리얼을 제공할 의도가 아니므로 공식 레퍼런스에서 제공하는 정보를 참고하면서 알게되거나 느낀점을 공유해보려고 합니다.</p><blockquote><p>Q 언어에 대해서 궁금하시다면 <a href="https://code.kx.com/q/basics/by-topic/">Q language resources by topic</a>를 참고하세요.</p></blockquote><h3 id="q-프로세스"><a href="#q-프로세스" class="headerlink" title="q 프로세스"></a>q 프로세스</h3><p>KDB+/q 프로세스는 Windows, Mac OSX, Linux 운영체제에서 사용할 수 있도록 지원합니다. 운영체제에 따라 사용할 수 있는 기능이 몇가지 부분에 대해서 다를 수는 있습니다. 예를 들어, 리눅스 운영체제에서는 <a href="https://code.kx.com/q4m3/11_IO/#116-interprocess-communication">프로세스 통신</a>을 위해 TCP/IP를 사용할 때 유닉스 도메인 소켓 방식을 사용할 수 있습니다.</p><h4 id="실행-환경-변수"><a href="#실행-환경-변수" class="headerlink" title="실행 환경 변수"></a>실행 환경 변수</h4><p>KDB+의 q 프로세스는 실행되는 시점에 QHOME, QLIC, QINIT 환경 변수를 참조합니다. </p><ul><li>QHOME: KDB 프로세스를 실행하기 위하여 부트스트랩할 q.k 파일을 찾는 경로입니다.</li><li>QLIC: KDB 프로세스에서 사용할 라이센스 파일을 지정합니다. 기본적으로 QHOME 경로에서 kc.lic 파일을 요구합니다.</li><li>QINIT: q.k 파일이 부트스트랩된 이후에 루트 컨텍스트 위치에서 실행될 스크립트 파일입니다. 이 환경변수가 정의되지 않으면 QHOME 위치에서 q.q 파일을 실행합니다.</li></ul><h4 id="프로세스-실행-인수"><a href="#프로세스-실행-인수" class="headerlink" title="프로세스 실행 인수"></a>프로세스 실행 인수</h4><p>공식 문서의 <a href="https://code.kx.com/q/basics/cmdline/">커맨드 라인 옵션</a>을 참고하면 프로세스 실행 시 적용할 수 있는 인수 옵션을 확인할 수 있습니다. 일반적으로 프로세스를 실행할 때 지정하는 옵션은 아래와 같습니다.</p><figure class="highlight q"><table><tr><td class="code"><pre><span class="line"><span class="comment">// -p: 수신 포트</span></span><br><span class="line"><span class="comment">// -s: 병렬 처리 시 사용될 보조 스레드</span></span><br><span class="line">q script.q -p <span class="number">5000</span> -s <span class="number">8</span></span><br></pre></td></tr></table></figure><p>프로세스 실행 시 보조 스레드 옵션을 지정해야 스레드가 활성화되며 REPL에서만 동작합니다. 따라서, 백그라운드 데몬 프로세스를 실행하는 경우 보조 스레드 수를 동적으로 변경할 수 없습니다. 아래와 같이 클라이언트를 통해 q 프로세스에 보조 스레드 수를 변경하기 위한 시스템 명령을 전달하는 경우 오류가 발생합니다.</p><figure class="highlight q"><table><tr><td class="code"><pre><span class="line">q)\s <span class="number">4</span></span><br><span class="line">&#x27;enable secondary threads via cmd line -s only</span><br></pre></td></tr></table></figure><h4 id="프로세스-종료"><a href="#프로세스-종료" class="headerlink" title="프로세스 종료"></a>프로세스 종료</h4><p>REPL 세션 또는 연결된 클라이언트에서 <a href="https://code.kx.com/q/basics/syscmds/#quit">\</a>를 입력하거나 <a href="https://code.kx.com/q/ref/exit/">exit 0</a>을 입력해서 프로세스를 종료할 수 있습니다. </p><figure class="highlight q"><table><tr><td class="code"><pre><span class="line">\\\</span><br><span class="line">exit <span class="number">0</span></span><br><span class="line">sublime-q &gt;&gt; 현재 연결은 원격 호스트에 의해 연결이 강제로 끊겼습니다.</span><br></pre></td></tr></table></figure><h3 id="스크립트-파일"><a href="#스크립트-파일" class="headerlink" title="스크립트 파일"></a>스크립트 파일</h3><p>REPL인 q 세션에서는 멀티 라인 표현식을 지원하지 않습니다. 따라서, <a href="https://code.kx.com/q/learn/tour/scripts/">스크립트 파일</a>을 작성하는게 더 효율적이며 서브라임 텍스트의 <a href="https://github.com/komsit37/sublime-q">sublime-q</a>와 같은 패키지를 활용하면 쉽게 q 프로세스와 통신하여 상호작용이 가능합니다. 또한, 스크립트 파일을 작성해두면 q 프로세스를 실행할 때 해당 스크립트 파일을 불러올 수 있도록 추가할 수 있습니다.</p><figure class="highlight q"><table><tr><td class="code"><pre><span class="line">q script.q -p <span class="number">5000</span></span><br><span class="line">KDB+ <span class="number">4.0</span> <span class="number">2021.07</span><span class="number">.12</span> Copyright (C) <span class="number">1993</span><span class="number">-2021</span> Kx Systems</span><br><span class="line">w64/ <span class="number">12</span>(<span class="number">16</span>)core <span class="number">32700</span>MB Mambo desktop-ojj4tb3 <span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span> EXPIRE <span class="number">2022.11</span><span class="number">.01</span> kdevkr@gmail.com KOD #<span class="number">5006323</span></span><br><span class="line"></span><br><span class="line"><span class="number">2021.11</span><span class="number">.04</span>T22:<span class="number">38</span>:<span class="number">41.153</span> [INFO] KDB+ Version: <span class="number">4</span></span><br><span class="line"><span class="number">2021.11</span><span class="number">.04</span>T22:<span class="number">38</span>:<span class="number">41.153</span> [INFO] KDB+ ProcessID: <span class="number">24388</span></span><br><span class="line"><span class="number">2021.11</span><span class="number">.04</span>T22:<span class="number">38</span>:<span class="number">41.153</span> [INFO] KDB+ License: <span class="number">16</span> <span class="number">2022.11</span><span class="number">.01</span> <span class="number">2022.11</span><span class="number">.01</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> kdevkr@gmail.com KOD #<span class="number">5006323</span> <span class="number">0</span></span><br><span class="line">The script file loaded after q.q file.</span><br></pre></td></tr></table></figure><blockquote><p>QINIT 또는 q.q 파일에 정의된 스크립트는 무조건 실행되므로 공통으로 적용되어야하는 사항은 QINIT 스크립트 파일에 작성하는 것이 좋습니다.</p></blockquote><h4 id="스크립트-내-프로세스-통신"><a href="#스크립트-내-프로세스-통신" class="headerlink" title="스크립트 내 프로세스 통신"></a>스크립트 내 프로세스 통신</h4><p>스크립트 내에서 프로세스 통신을 위해 <a href="https://code.kx.com/q/basics/handles/">Connection handles</a>를 사용하는 경우 일반적인 문자열 형태의 q 표현식을 전달하는 것보다는 <a href="https://code.kx.com/q/learn/startingkdb/ipc/">람다 함수와 파라미터</a>를 보내는 메시지 형식을 사용하는 것이 더 효율적입니다.</p><figure class="highlight q"><table><tr><td class="code"><pre><span class="line">h: <span class="built_in">hopen</span> `::<span class="number">5011</span>;</span><br><span class="line">h(&#123;trades&#125;;::)</span><br></pre></td></tr></table></figure><p>위와 같이 함수와 파라미터를 전달하는 경우 IDE에서 지원하는 구문 강조가 적용되어 원하는 바를 더 명확하게 확인할 수 있다는 장점도 제공됩니다.</p><h4 id="커맨드-라인-파라미터"><a href="#커맨드-라인-파라미터" class="headerlink" title="커맨드 라인 파라미터"></a>커맨드 라인 파라미터</h4><p>프로세스에서 실행할 스크립트를 작성할 때 프로세스 실행 시 입력해야할 정보가 필요할 수 있습니다. KDB에서 제공하는 미리 정의된 네임스페이스를 통해 커맨드 라인에서 입력한 파라미터를 스크립트에서 가져올 수 있습니다.</p><figure class="highlight q"><table><tr><td class="code"><pre><span class="line">q -p <span class="number">5000</span> -pidfile q.pid</span><br></pre></td></tr></table></figure><figure class="highlight q"><table><tr><td class="code"><pre><span class="line"><span class="comment">// .z.x를 사용하여 커맨드 라인 옵션을 제외한 인수를 파라미터로 가져올 수 있다.</span></span><br><span class="line">.z.x</span><br><span class="line"><span class="string">&quot;-pidfile&quot;</span></span><br><span class="line"><span class="string">&quot;q.pid&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// .Q.opt를 사용하여 커맨드 라인 파라미터를 Dict로 변경할 수 있다.</span></span><br><span class="line">.Q.opt .z.x</span><br><span class="line">pidfile| <span class="string">&quot;q.pid&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// .Q.def를 사용하여 커맨드 라인 파라미터에 대한 기본값을 정의할 수 있다.</span></span><br><span class="line">.Q.def[`whoami`logdst`pidfile!(`mambo;`$(<span class="string">&quot;logs/q.log&quot;</span>);`)].Q.opt .z.x</span><br><span class="line">whoami | mambo</span><br><span class="line">logdst | logs/q.log</span><br><span class="line">pidfile| q.pid</span><br></pre></td></tr></table></figure><h3 id="사용자-및-패스워드"><a href="#사용자-및-패스워드" class="headerlink" title="사용자 및 패스워드"></a>사용자 및 패스워드</h3><p><a href="https://code.kx.com/q/basics/cmdline/#-u-usr-pwd">사용자에 대한 패스워드를 정의한 파일을 지정</a>하여 q 프로세스와의 연결을 제한할 수 있습니다. 비밀번호는 평문, MD5, SHA-1을 지원합니다. 단, 사용자와 비밀번호 암호 방식은 유일해야하므로 평문을 사용하는 사용자와 SHA-1 해시가 적용된 사용자를 같이 구성할 수 없습니다. q 프로세스를 실행할 때 -u 옵션에 패스워드 파일을 지정하면 프로세스 실행 후에도 패스워드 파일을 수정하고 \u 명령어로 프로세스를 중단하지 않고 사용자 및 패스워드를 적용할 수 있습니다. 이와 같은 정보를 토대로 다음과 같은 방식으로도 사용자 및 패스워드를 적용할 수 있습니다.</p><p><strong>익명 사용자에 대한 패스워드 파일 생성</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">:</span><br></pre></td></tr></table></figure><p><strong>q 프로세스 실행 시 패스워드 파일 적용</strong></p><figure class="highlight q"><table><tr><td class="code"><pre><span class="line">q -p <span class="number">5000</span> -u userpass.txt</span><br></pre></td></tr></table></figure><p><strong>신규 사용자의 패스워드 해시 생성</strong></p><figure class="highlight q"><table><tr><td class="code"><pre><span class="line"><span class="comment">// raze string md5 &quot;mambo&quot;</span></span><br><span class="line"><span class="comment">// &quot;dfa67b75dc3d5868c3e88c83774c0d01&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">raze</span> <span class="built_in">string</span> <span class="number">-33</span>!<span class="string">&quot;mambo&quot;</span></span><br><span class="line"><span class="string">&quot;78492a38605bdf6e691c4e2f77c69c4a0904c647&quot;</span></span><br></pre></td></tr></table></figure><p><strong>신규 사용자 및 패스워드 적용 후 저장</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mambo:78492a38605bdf6e691c4e2f77c69c4a0904c647</span><br></pre></td></tr></table></figure><p><strong>사용자 및 패스워드 정보 갱신</strong></p><figure class="highlight q"><table><tr><td class="code"><pre><span class="line">\u</span><br><span class="line"></span><br><span class="line"><span class="built_in">hopen</span> `:localhost:<span class="number">5000</span>:mambo:mambo</span><br></pre></td></tr></table></figure><blockquote><p>패스워드 파일에 사용자 이름을 생략함으로써 익명 사용자에 대한 비밀번호도 적용할 수 있습니다.</p></blockquote><h3 id="아키텍처"><a href="#아키텍처" class="headerlink" title="아키텍처"></a>아키텍처</h3><p>학습 단계에서는 KDB+를 단일 q 프로세스로 실행하여 사용하지만 실제로 운용되는 환경에서는 KxSystems에서 권장하는 <a href="https://code.kx.com/q/architecture/">Tickerplant 아키텍처</a>를 구성합니다. q 프로세스에서 사용할 메모리가 부족해지면 <strong>`wsfull</strong> 오류가 발생하고 프로세스가 종료되는 문제점을 가지고 있습니다. Tickerplant는 FeedHandler에서 전송되는 데이터를 수신하는 TP 프로세스와 TP 프로세스로 들어온 데이터를 가져가는 RDB(Realtime DB) 프로세스, 날짜 또는 시간 단위로 저장하는 HDB(Historical DB) 프로세스로 분리하게 됩니다. 각 프로세스의 역할이 구분되어있으므로 현재 날짜 또는 시간에 대한 데이터를 메모리에 저장하는 RDB 프로세스가 예기치 못한 상황에 종료되더라도 TP 프로세스는 지속적으로 데이터를 수신할 수 있게 됩니다.</p><blockquote><p><a href="https://code.kx.com/q/learn/startingkdb/tick/">Realtime database</a><br>As a minimum, it is recommended to have RAM of at least 4× expected data size, so for 5 GB data per day, the RDB machine should have at least 20 GB RAM. In practice, much larger RAM might be used.</p></blockquote><p>위 내용에 따르면 날짜별로 파티셔닝되는 구조를 가지는 경우에 RDB 프로세스에 5GB 규모의 데이터를 보유하고 있어야한다면 시스템적으로 최소한 20GB 만큼의 메모리가 준비되어야합니다. 또한, 시스템 자원을 준비할 수 있지 않아 날짜가 아닌 시간 단위로 파티셔닝하는 경우 무수히 많은 폴더가 만들어지므로 긴 범위의 기간에 대한 연산을 수행하여야하는 경우 I/O 성능이 좋은 디스크를 사용해야할 수 있습니다.</p><h4 id="데이터-관리"><a href="#데이터-관리" class="headerlink" title="데이터 관리"></a>데이터 관리</h4><p>Tickerplant는 KDB+에서 권장되는 아키텍처이지만 데이터 관리에 대한 문제점을 가지고 있습니다. 일반적으로 사용되는 증권 시장의 경우 데이터가 순차적으로 발생한다는 것이 보장되며 지난 기간에 대한 데이터가 현재 시간에 들어오지 않는다는 것을 기준으로 하기 때문에 사업 분야와 고객의 요구사항으로 인하여 현재 시점에 지난 기간에 대한 데이터를 등록하는 경우 RDB 프로세스에서 메모리에 저장된 데이터를 파일로 저장하는 시점에 해당 파티션 폴더에는 지난 기간에 대한 파티션 데이터가 포함되어있게 됩니다.</p><p>q 프로세스에서 파티션 테이블에 대해서는 각 파티션에 맞는 데이터만 존재해야함을 보장해야합니다. 그 이유는 데이터 연산 시 파티셔닝의 기준이 되는 특수한 컬럼을 통해 전체 파티션을 조회하지 않고도 빠르게 필요한 파티션의 데이터를 메모리에 로드할 수 있기 때문입니다. 결국에는 RDB 프로세스가 저장한 파티션 폴더의 데이터를 확인하고 올바른 파티션에 데이터를 병합해야하는 작업을 수행해야합니다.</p><p>데이터베이스를 운용하면서 데이터 병합 과정을 거치고 난 후 파티셔닝된 폴더가 순차적으로 나열되지 않을 수 있을 수 있습니다. 이러한 문제가 발생하는 경우 q 프로세스는 정확한 파티션을 확인할 수 없으므로 일부 조회가 불가능한 상태가 될 가능성이 있습니다. 다행히도 KDB+에서 제공하는 몇가지 함수를 이용해서 잘못된 파티셔닝을 바로 잡도록 작업을 수행해볼 수 있습니다.</p><ul><li><a href="https://code.kx.com/q/ref/dotq/#qchk-fill-hdb">.Q.chk (fill HDB)</a></li><li><a href="https://code.kx.com/q/ref/dotq/#qbv-build-vp">.Q.bv (build vp)</a></li><li><a href="https://code.kx.com/q/ref/dotq/#qvp-missing-partitions">.Q.vp (missing partitions)</a></li></ul><figure class="highlight q"><table><tr><td class="code"><pre><span class="line">.Q.bv[]</span><br><span class="line">.Q.vp</span><br><span class="line"></span><br><span class="line">.Q.chk[]</span><br></pre></td></tr></table></figure><h3 id="제한-및-오류"><a href="#제한-및-오류" class="headerlink" title="제한 및 오류"></a>제한 및 오류</h3><p>KDB+의 q 프로세스에 존재하는 몇가지 제한 사항에 대해서 알아보겠습니다.</p><h4 id="라이센스-코어-제한"><a href="#라이센스-코어-제한" class="headerlink" title="라이센스 코어 제한"></a>라이센스 코어 제한</h4><p>먼저, 상업용 라이센스를 구매하더라도 라이센스에 지정된 코어 수를 넘어가게되는 시스템을 사용하려는 경우 q 프로세스 실행 시 <strong>`cores</strong> 라는 오류가 발생합니다. 이는 q 프로세스가 해당 코어 수를 사용할 수 있도록 허용되지 않기 때문이므로 프로세스를 실행할 때 리눅스의  <strong>taskset</strong>을 활용하여 프로세스가 사용할 수 있는 CPU를 지정해야합니다.</p><h4 id="함수-파라미터-개수-제한"><a href="#함수-파라미터-개수-제한" class="headerlink" title="함수 파라미터 개수 제한"></a>함수 파라미터 개수 제한</h4><p>공식 문서의 <a href="https://code.kx.com/q/basics/errors/">Errors</a>를 참고하면 q 프로세스에서 발생하는 오류에 대해서 검토할 수 있습니다. 특히, 함수 파라미터 개수는 최대 8개로 제한되어있는 특징이 있습니다. 따라서, 스크립트에 정의하는 함수 또는 람다에서 사용되는 파라미터 개수가 8개보다 많아지는 경우 Dict를 활용해야할 수 있습니다. 이외에도 다음의 제한된 사항이 있습니다.</p><ul><li>conn: Too many connections (1022 max)</li><li>elim: Too many enumerations (max: 57)</li><li>globals: Too many global variables</li><li>limit: Too many constants</li><li>locals: Too many local variables</li><li>params: Too many parameters (8 max)</li></ul><h3 id="느낀점"><a href="#느낀점" class="headerlink" title="느낀점"></a>느낀점</h3><p>현재 조직에서는 KDB+ 시계열 데이터베이스를 사용중이지만 이와 관련한 국내 레퍼런스는 찾아볼 수 없으므로 다른 회사로 이직하게되면 더이상 관심가지지않을 것 같습니다. 컬럼형 시계열 데이터베이스이면서 빠른 속도를 제공하는 것은 맞지만 그에 따른 라이센스 비용과 어떻게 사용하는 것이 좋거나 문제가 발생했을때의 해결방안을 찾고 원하는 결과를 가지기 위해서 Q 언어와 함께 qSQL이라고하는 SQL과 비슷하지만 다른 쿼리를 작성하는 것이 효율적이다라고 볼 수 없는 것 같습니다.</p><p>기본적으로 메모리에 데이터를 저장하고 파일로 저장된 데이터는 연산 시 메모리에 불러오게되므로 데이터 규모에 따라 프로세스를 실행하는 시스템 자원이 보장되어야한다는 문제점도 있습니다. 시스템 메모리 자원을 확보할 수 없는 경우 파티션으로 저장되는 구조를 지원하지만 다수의 폴더로 분산하여 데이터를 저장하기 때문에 디스크 I/O 성능도 고려해야합니다. 결국 예상되는 규모에 따라 안정적으로 운용될 수 있도록 시스템 자원을 준비해야합니다.</p><p>조직내에서는 어쩔 수 없이 사용하고 있지만 개인적으로 학습하는 것은 추천하지 않을 것 같습니다.</p><h2 id="레퍼런스"><a href="#레퍼런스" class="headerlink" title="레퍼런스"></a>레퍼런스</h2><ul><li><a href="https://code.kx.com/">code.kx</a></li><li><a href="https://community.kx.com/">community.kx</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;이 글은 KDB+라는 시계열 데이터베이스를 활용하면서 국내 레퍼런스를 찾아볼 수 없는 문제로 인하여 별도로 정리한 내용입니다. 따라서, 전문적으로 활용하는 수준은 아니므로 잘못된 정보가 포함되어있을 수 있음을 알려드립니다.</summary>
      
    
    
    
    
    <category term="Kx" scheme="https://kdevkr.github.io/tags/Kx/"/>
    
    <category term="KDB+" scheme="https://kdevkr.github.io/tags/KDB/"/>
    
  </entry>
  
  <entry>
    <title>그래들 빌드 라이프사이클</title>
    <link href="https://kdevkr.github.io/gradle-build-lifecycle/"/>
    <id>https://kdevkr.github.io/gradle-build-lifecycle/</id>
    <published>2021-10-30T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.031Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘 알아볼 내용은 그래들 빌드의 라이프사이클입니다. </p><p>얼마전에 단일 애플리케이션 프로젝트에서 다양한 배포 환경에 대한 기능을 별도로 지원해야하는 요구사항으로 인하여 그래들 멀티 모듈 프로젝트로 전환하게 되면서 배포 과정에서 문제가 발생하였었는데요. 그 문제는 크리티컬한 이슈는 아니지만 태스크 수행 후 만들어진 압축 파일에 프로젝트 버전이 포함되지 않는 상황이었습니다. 이러한 문제가 발생한 이유는 그래들 태스크를 정의할 때 <strong>그래들 빌드 라이프사이클</strong>을 고려하지 않았기 때문입니다.</p><h2 id="그래들-태스크"><a href="#그래들-태스크" class="headerlink" title="그래들 태스크"></a>그래들 태스크</h2><p>먼저 기존에 정의된 태스크는 <a href="https://github.com/kdevkr/beanstalk-deploy-sample/blob/main/build.gradle">beanstalk-deploy-sample의 build.gradle에 정의된 zipBeanstalk 태스크</a>와 같이 Zip 유형의 태스크로 작성되어있습니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">task zipBeanstalk(<span class="attr">type:</span> Zip, <span class="attr">dependsOn:</span> <span class="string">&#x27;procfile&#x27;</span>) &#123;</span><br><span class="line">    from (<span class="string">&#x27;.ebextensions&#x27;</span>) &#123; into <span class="string">&#x27;.ebextensions&#x27;</span> &#125;</span><br><span class="line">    from (<span class="string">&#x27;.platform&#x27;</span>) &#123; into <span class="string">&#x27;.platform&#x27;</span> &#125;</span><br><span class="line"></span><br><span class="line">    from (<span class="string">&#x27;build/libs&#x27;</span>) &#123;</span><br><span class="line">        println bootWar.archiveName</span><br><span class="line">        include(bootWar.archiveName)</span><br><span class="line">        include(<span class="string">&quot;Procfile&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    baseName = <span class="string">&#x27;beanstalk&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위 샘플 태스크처럼 단일 애플리케이션 프로젝트에서 정의된 태스크는 문제가 발생할 가능성이 적습니다. 그 이유는 배포를 위해서 여러가지 태스크를 정의하지 않기 때문인데요. 그러면 위 태스크를 수행하면 어떤 결과를 제공하는지 한번 확인해볼까요?</p><h3 id="태스크-결과"><a href="#태스크-결과" class="headerlink" title="태스크 결과"></a>태스크 결과</h3><p>프로젝트 폴더에 있는 Gradle Wrapper를 사용하여 zipBeanstalk 태스크를 수행하면서 프로젝트 버전을 명시해보겠습니다.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">./gradlew clean zipBeanstalk -x <span class="built_in">test</span> -Pversion=1.0.0-hotfix.11</span><br></pre></td></tr></table></figure><p><img data-src="/images/posts/gradle-build-lifecycle/gradle-01.png"></p><p>패키징된 WAR 파일과 zipBeanstalk 태스크에 의해 만들어지는 아카이브 파일에 프로젝트 버전이 포함됨을 확인할 수 있습니다.</p><h3 id="수동-배포-환경을-위한-태스크"><a href="#수동-배포-환경을-위한-태스크" class="headerlink" title="수동 배포 환경을 위한 태스크"></a>수동 배포 환경을 위한 태스크</h3><p>사실 zipBeanstalk 태스크는 아마존 웹 서비스의 빈스톡 환경으로 배포하기 위한 애플리케이션 번들 파일을 만드는 태스크입니다. 만약, 수동으로 배포하여야하는 환경이 추가된다면 빈스톡 환경에서 사용하는 Procfile과 환경 구성 파일들은 포함할 필요가 없으며 특정 환경을 위한 프로퍼티 파일만 별도로 추가하면 됩니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">task zipManually(<span class="attr">type:</span> Zip, <span class="attr">dependsOn:</span> <span class="string">&#x27;bootWar&#x27;</span>) &#123;</span><br><span class="line">    println <span class="string">&#x27;Build Version: &#x27;</span> + project.version</span><br><span class="line"></span><br><span class="line">    from (<span class="string">&#x27;.conf&#x27;</span>) &#123; into <span class="string">&#x27;application-prod.yml&#x27;</span>&#125;</span><br><span class="line">    from (<span class="string">&#x27;build/libs&#x27;</span>) &#123;</span><br><span class="line">        include(bootWar.archiveName)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    baseName = <span class="string">&#x27;app-bundle&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>zipManually 태스크에는 application-prod.yml을 패키징된 애플리케이션 WAR 파일과 함께 포함시키도록 정의했습니다. 아시는 분들도 있겠지만 스프링 부트 애플리케이션은 <strong>WAR 파일과 동일한 위치에 있는 애플리케이션 프로퍼티 파일</strong>을 읽을 수 있습니다. 만약, 모르시는 분들이라면 프로퍼티 구성 우선 순위에 대한 문서를 확인하시기 바랍니다.</p><p>동일하게 zipManually 태스크를 실행해보도록 하겠습니다.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">./gradlew clean zipManually -x <span class="built_in">test</span> -Pversion=1.0.0-hotfix.11</span><br><span class="line"></span><br><span class="line">&gt; Configure project :</span><br><span class="line">JDK info: 11</span><br><span class="line">Build Version: 1.0.0-hotfix.11</span><br><span class="line">Build Version: 1.0.0-hotfix.11</span><br><span class="line"></span><br><span class="line">&gt; Task :bootBuildInfo</span><br><span class="line">&gt; Task :compileJava UP-TO-DATE</span><br><span class="line">&gt; Task :processResources UP-TO-DATE</span><br><span class="line">&gt; Task :classes</span><br><span class="line">&gt; Task :bootWarMainClassName</span><br><span class="line">&gt; Task :bootWar</span><br><span class="line">&gt; Task :procfile</span><br><span class="line">&gt; Task :zipManually</span><br></pre></td></tr></table></figure><p><img data-src="/images/posts/gradle-build-lifecycle/gradle-02.png"></p><p>zipManually 태스크 결과는 정상으로 보입니다만… 이상한 부분을 눈치채신분들이 있으시겠죠? <strong>바로 Build Version이 두번 출력되었다는 점</strong>인데요. 우리는 분명히 별도의 태스크로 정의하고 태스크 블록 내에서 현재 Build Version을 출력하도록 작성했습니다. 이렇게 Build Version 버전이 두번 출력되는 이유는 이 글의 주요 내용인 그래들 빌드 라이프사이클에 대한 개념과 관련이 있습니다.</p><h2 id="그래들-빌드-라이프사이클"><a href="#그래들-빌드-라이프사이클" class="headerlink" title="그래들 빌드 라이프사이클"></a>그래들 빌드 라이프사이클</h2><p>사실 상 이러한 문제를 경험하는 이유는 그래들의 빌드 라이프사이클에 대한 개념을 모르기 때문인데요. 20년차이신 팀장님 조차도 잘 모르는 부분이었다고 할 수 있습니다. 빌드 라이프사이클 존재를 모르는 상황이었기에 이렇게 되는 이유를 검색하고 팀장님께서 <a href="https://stackoverflow.com/a/23485085">Gradle executes all tasks?</a>이라는 스택오버플로우 질문을 공유해주셨습니다.</p><p>이 질문에 대한 답변에서는 그래들에는 configuration 단계와 execution 단계가 있고 이것은 중요한 개념이라고 설명하고 있었습니다. 그러면 그래들 공식 문서에 있는 <a href="https://docs.gradle.org/current/userguide/build_lifecycle.html">Build Lifecycle</a>를 살펴보도록 하겠습니다.</p><blockquote><p>Gradle builds the complete dependency graph before any task is executed.<br>… Your build scripts configure this dependency graph.</p></blockquote><p>그래들은 태스크를 수행하기 전에 의존성 그래프를 빌드하고 빌드 스크립트는 의존성 그래프를 구성한다고 설명하며 빌드 단계에 대해서 설명합니다.</p><h3 id="빌드-단계"><a href="#빌드-단계" class="headerlink" title="빌드 단계"></a>빌드 단계</h3><p>그래들의 빌드 단계는 3가지로 구분된다고 하며 초기화(Initialization), 구성(Configuration), 수행(Execution)입니다. </p><blockquote><p><strong>Initialization</strong><br>Gradle supports single and multi-project builds. During the initialization phase, Gradle determines which projects are going to take part in the build, and creates a Project instance for each of these projects.</p><p><strong>Configuration</strong><br>During this phase the project objects are configured. The build scripts of all projects which are part of the build are executed.</p><p><strong>Execution</strong><br>Gradle determines the subset of the tasks, created and configured during the configuration phase, to be executed. The subset is determined by the task name arguments passed to the gradle command and the current directory. Gradle then executes each of the selected tasks.</p></blockquote><p>세가지의 단계 중 구성 단계에서는 모든 프로젝트의 빌드 스크립트가 실행된다는 설명이 있습니다. 이 부분이 제가 경험한 문제의 원인이라고 할 수 있는데 태스크 내에서 작성하는 코드는 구성 단계에 포함되며 doFirst와 doLast 블록이 수행 단계에 포함되기 때문입니다.</p><p>저도 모르는 부분이었고 생각보다 많은 블로그에서는 그래들 태스크 정의를 설명할 때 구성 단계에 해당되는 곳에 println을 작성하는 예시를 보여주는데요. 생각보다 많은 분들이 이 개념에 대해서 모른다고 할 수 있습니다. 물론 단일 애플리케이션 프로젝트에서는 몰라도 상관없다고 할 수 있겠네요.</p><h3 id="테스트를-위한-태스크"><a href="#테스트를-위한-태스크" class="headerlink" title="테스트를 위한 태스크"></a>테스트를 위한 태스크</h3><p>그러면 어떻게 하였기에 프로젝트 버전이 포함되지 않았을 지 다음의 태스크를 살펴보도록 하겠습니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">task zipBeanstalk(<span class="attr">type:</span> Zip, <span class="attr">dependsOn:</span> <span class="string">&#x27;procfile&#x27;</span>) &#123;&#125;</span><br><span class="line">task zipManually(<span class="attr">type:</span> Zip, <span class="attr">dependsOn:</span> <span class="string">&#x27;bootWar&#x27;</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">task k8sbuild(<span class="attr">dependsOn:</span> bootWar) &#123;</span><br><span class="line">    project.version <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>추가한 k8sbuild 태스크는 쿠버네티스 배포 환경 테스트를 위해 패키징된 애플리케이션 WAR 파일에 포함되는 프로젝트 버전을 생략하기 위해서 project.version을 빈 값으로 설정하도록 작성한게 화근이었습니다. 이 상태로 zipManually 태스크를 다시 한번 수행하면 어떻게 되는지 확인해봅시다.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">./gradlew clean zipManually -x <span class="built_in">test</span> -Pversion=1.0.0-hotfix.11</span><br></pre></td></tr></table></figure><p><img data-src="/images/posts/gradle-build-lifecycle/gradle-03.png"></p><p>k8sbuild 태스크에 작성된 project.version을 설정하는 행위는 구성 단계에 해당하기 때문에 모든 태스크를 수행하기 이전에 적용되어 zipManually 태스크를 수행했음에도 불구하고 프로젝트 버전이 포함되지 않았음을 보여줍니다.</p><h3 id="해결방안"><a href="#해결방안" class="headerlink" title="해결방안"></a>해결방안</h3><p>그러면 어떻게 해결하는게 좋을지 방안을 찾아보도록 하겠습니다. </p><h4 id="프로젝트-버전-재정의하는-경우"><a href="#프로젝트-버전-재정의하는-경우" class="headerlink" title="프로젝트 버전 재정의하는 경우"></a>프로젝트 버전 재정의하는 경우</h4><p>k8sbuild 태스크처럼 특정 태스크에서 프로젝트 버전을 재정의 하고싶은 경우에는 doFirst와 같은 클로저를 활용해야합니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">task k8sbuild(<span class="attr">dependsOn:</span> bootWar) &#123;</span><br><span class="line">    doFirst &#123;</span><br><span class="line">        project.version <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="프로젝트-버전을-확인하고-싶은-경우"><a href="#프로젝트-버전을-확인하고-싶은-경우" class="headerlink" title="프로젝트 버전을 확인하고 싶은 경우"></a>프로젝트 버전을 확인하고 싶은 경우</h4><p>zipBeanstalk와 zipManually 태스크처럼 애플리케이션을 WAR로 패키징하는 경우 현재 프로젝트 버전을 출력하고 싶은 경우 gradle.taskGraph.whenReady를 활용함으로써 해결할 수 있습니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">task zipBeanstalk(<span class="attr">type:</span> Zip, <span class="attr">dependsOn:</span> <span class="string">&#x27;procfile&#x27;</span>) &#123;</span><br><span class="line">    from (<span class="string">&#x27;.ebextensions&#x27;</span>) &#123; into <span class="string">&#x27;.ebextensions&#x27;</span> &#125;</span><br><span class="line">    from (<span class="string">&#x27;.platform&#x27;</span>) &#123; into <span class="string">&#x27;.platform&#x27;</span> &#125;</span><br><span class="line"></span><br><span class="line">    from (<span class="string">&#x27;build/libs&#x27;</span>) &#123;</span><br><span class="line">        include(bootWar.archiveName)</span><br><span class="line">        include(<span class="string">&quot;Procfile&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    baseName = <span class="string">&#x27;beanstalk&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task zipManually(<span class="attr">type:</span> Zip, <span class="attr">dependsOn:</span> <span class="string">&#x27;bootWar&#x27;</span>) &#123;</span><br><span class="line">    from (<span class="string">&#x27;.conf&#x27;</span>) &#123; into <span class="string">&#x27;application-prod.yml&#x27;</span>&#125;</span><br><span class="line">    from (<span class="string">&#x27;build/libs&#x27;</span>) &#123;</span><br><span class="line">        include(bootWar.archiveName)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    baseName = <span class="string">&#x27;app-bundle&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gradle.taskGraph.whenReady &#123; graph -&gt;</span><br><span class="line">    <span class="keyword">if</span> (graph.hasTask(bootWar)) &#123;</span><br><span class="line">        println <span class="string">&#x27;Build Version: &#x27;</span> + project.version</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="불필요한-파일을-제거해야하는-경우"><a href="#불필요한-파일을-제거해야하는-경우" class="headerlink" title="불필요한 파일을 제거해야하는 경우"></a>불필요한 파일을 제거해야하는 경우</h4><p>경우에 따라서는 프로젝트 빌드 시 패키징된 애플리케이션 WAR 파일에 포함되지 않도록 해야할 수 있습니다. 예를 들어, 로컬 환경에서 사용하는 애플리케이션 프로퍼티 파일이나 특정 도메인에 대한 인증서 또는 인증키를 포함하지않도록 제외해야할 수 있습니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">gradle.taskGraph.whenReady &#123; graph -&gt;</span><br><span class="line">    <span class="keyword">if</span> (graph.hasTask(build_for_customer)) &#123;</span><br><span class="line">        processResources &#123;</span><br><span class="line">            exclude(<span class="string">&#x27;**/config/**.yml&#x27;</span>)</span><br><span class="line">            exclude(<span class="string">&#x27;**/certs/**&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위 예시는 구성 단계에서 의존성 그래프 구성이 완료된 이후에 build_for_customer 태스크가 수행되는 경우에 고객 환경으로 배포하는 애플리케이션 WAR 파일에 자체적으로 사용하는 애플리케이션 프로퍼티 파일들과 인증서를 포함하지 않도록 processResources를 재정의함을 보여줍니다.</p><p>그래들 빌드 라이프사이클 개념과 함께 경험하였던 문제에 대하여 어떻게 해결할 수 있는지 알아보았습니다. 어떤 기술을 사용함에 있어서 주요 개념을 이해하고 있는 것이 중요함을 다시한번 깨닫게 되는 좋은 경험이었습니다. 여러분의 그래들 빌드 스크립트에서도 수행 단계에서 수행되어야할 코드를 구성 단계에서 동작하도록 작성되지 않았는지 검토해보시기를 바랍니다.</p><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘 알아볼 내용은 그래들 빌드의 라이프사이클입니다. &lt;/p&gt;
&lt;p&gt;얼마전에 단일 애플리케이션 프로젝트에서 다양한 배포 환경에 대한 기능을 별도로 지원해야하는 요구사항으로 인하여 그래들 멀티 모듈 프로젝</summary>
      
    
    
    
    
    <category term="Gradle" scheme="https://kdevkr.github.io/tags/Gradle/"/>
    
    <category term="Lifecycle" scheme="https://kdevkr.github.io/tags/Lifecycle/"/>
    
  </entry>
  
  <entry>
    <title>SonarQube와 Github Action으로 수행하는 정적 분석</title>
    <link href="https://kdevkr.github.io/static-analysis-performed-by-sonarqube-and-github-action/"/>
    <id>https://kdevkr.github.io/static-analysis-performed-by-sonarqube-and-github-action/</id>
    <published>2021-10-11T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.035Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 SonarQube와 Github Action을 통해 정적 분석을 수행하기 위한 과정을 알아보려고 합니다.</p><h2 id="SonarQube"><a href="#SonarQube" class="headerlink" title="SonarQube"></a>SonarQube</h2><p><a href="https://www.sonarqube.org/">소나큐브</a>는 다양한 언어에 대한 코드 품질을 분석하고 취약점을 파악할 수 있는 정적 분석 도구입니다. 회사에서 정적 분석을 수행하고 싶다는 요구사항이 있어 제가 SonarQube를 도입하고 월요일과 금요일마다 프로젝트 코드에 대한 정적 분석을 수행하고 있습니다. 제가 정적 분석을 위해서 소나큐브를 도입한 이유는 다음과 같습니다.</p><p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-00.png" alt="소나큐브 라이센스"></p><ol><li>GPLv3 라이센스 기반의 오픈소스 버전 지원</li><li>IntelliJ 또는 VSCode와 같은 IDE를 위한 SonarLint 지원</li><li>소나큐브에 대한 공식 도커 이미지 지원</li><li>다양한 언어와 커뮤니티 기반의 규칙 지원</li></ol><p>회사 개발자들이 주로 사용하는 인텔리제이 IDEA 또는 VSCode에서 사용할 수 있는 SonarLint를 제공하여 별도의 서버 없이도 간단하게 자체적으로 정적 분석을 수행하고 결과를 확인할 수 있으며 공식 도커 이미지를 통해 별다른 설정 없이도 간단하게 소나큐브 시스템을 구성할 수 있습니다.</p><h3 id="소나큐브-시스템-구성"><a href="#소나큐브-시스템-구성" class="headerlink" title="소나큐브 시스템 구성"></a>소나큐브 시스템 구성</h3><p>소나큐브는 <a href="https://docs.sonarqube.org/latest/setup/install-server/">직접 설치</a>할 수도 있으며 도커 이미지와 함께 제공하는 도커 컴포즈 문서를 활용할 수 있습니다.</p><p><a href="https://github.com/SonarSource/docker-sonarqube/blob/master/example-compose-files/sq-with-postgres/docker-compose.yml">sq-with-postgres/docker-compose.yml</a></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">sonarqube:9.1.0-community</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sonarnet</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SONAR_JDBC_URL:</span> <span class="string">jdbc:postgresql://db:5432/sonar</span></span><br><span class="line">      <span class="attr">SONAR_JDBC_USERNAME:</span> <span class="string">sonar</span></span><br><span class="line">      <span class="attr">SONAR_JDBC_PASSWORD:</span> <span class="string">sonar</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sonarqube_data:/opt/sonarqube/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sonarqube_extensions:/opt/sonarqube/extensions</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sonarqube_logs:/opt/sonarqube/logs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sonarqube_temp:/opt/sonarqube/temp</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sonarqube_bundled-plugins:/opt/sonarqube/lib/bundled-plugins</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">nproc:</span> <span class="number">65535</span></span><br><span class="line">      <span class="attr">nofile:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">262144</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">262144</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sonarnet</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">sonar</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">sonar</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgresql:/var/lib/postgresql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgresql_data:/var/lib/postgresql/data</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">sonarnet:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">sonarqube_data:</span></span><br><span class="line">  <span class="attr">sonarqube_extensions:</span></span><br><span class="line">  <span class="attr">sonarqube_logs:</span></span><br><span class="line">  <span class="attr">sonarqube_temp:</span></span><br><span class="line">  <span class="attr">sonarqube_bundled-plugins:</span></span><br><span class="line">  <span class="attr">postgresql:</span></span><br><span class="line">  <span class="attr">postgresql_data:</span></span><br></pre></td></tr></table></figure><h4 id="WSL-vm-max-map-count"><a href="#WSL-vm-max-map-count" class="headerlink" title="WSL vm.max_map_count"></a>WSL vm.max_map_count</h4><p>윈도우 환경에서 WSL로 도커 컨테이너를 실행하는 경우 vm.max_map_count로 인하여 소나큐브에서 실행하는 Elasticsearch가 실행되지 않을 수 있습니다. 이 경우 윈도우 터미널에서 WSL로 도커 컨테이너로 접속 후 다음의 명령어를 실행하여 Elasticsearch에서 요구하는 수치로 변경하시면 됩니다.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</span></span><br><span class="line">wsl -d docker-desktop</span><br><span class="line">sysctl -w vm.max_map_count=262144</span><br></pre></td></tr></table></figure><blockquote><p>소나큐브의 관리자 계정과 초기 비밀번호는 admin/admin 입니다.</p></blockquote><h3 id="소나큐브-프로젝트-생성"><a href="#소나큐브-프로젝트-생성" class="headerlink" title="소나큐브 프로젝트 생성"></a>소나큐브 프로젝트 생성</h3><p>소나큐브에 접속하였다면 정적 분석을 수행할 프로젝트를 생성해야합니다. 저는 깃허브 리파지토리 이름을 그대로 사용하는 편입니다.</p><p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-01.png" alt="spring5-web-example 프로젝트"></p><p>그리고 소나큐브에 로그인할 수 있는 토큰을 발행합니다. </p><p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-02.png"></p><p>토큰 용도를 구분하기 위한 이름을 지정하는데 저는 Github Action에서 사용할 예정이므로 GITHUB_ACTION을 지정하였습니다.</p><p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-03.png"></p><p>저는 로컬 컴퓨터에 소나큐브를 실행하였고 필요할때만 포트포워딩을 수행할 예정이므로 토큰을 공개하겠습니다. (어차피 학습 후에 지움…)</p><h3 id="소나큐브-관련-코드-추가"><a href="#소나큐브-관련-코드-추가" class="headerlink" title="소나큐브 관련 코드 추가"></a>소나큐브 관련 코드 추가</h3><p>소나큐브 시스템에 프로젝트를 생성하고 토큰을 발급하였기 때문에 소나큐브와 연계할 수 있도록 프로젝트 폴더에 소나큐브와 관련된 코드를 추가하겠습니다.</p><h4 id="build-gradle"><a href="#build-gradle" class="headerlink" title="build.gradle"></a>build.gradle</h4><p>만약, 그래들을 통해 소나큐브와 연동하고 싶다면 build.gradle에 SonarQube 플러그인을 추가해야합니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&quot;org.sonarqube&quot;</span> version <span class="string">&#x27;3.3&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;jacoco&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sonarqube &#123;</span><br><span class="line">  properties &#123;</span><br><span class="line">    property <span class="string">&quot;sonar.projectKey&quot;</span>, <span class="string">&quot;spring5-web-example&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="sonar-project-properties"><a href="#sonar-project-properties" class="headerlink" title="sonar-project.properties"></a>sonar-project.properties</h4><p>sonar-project.properties 파일은 소나큐브에서 참조하게 되는 설정 파일입니다.</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">sonar.projectKey=spring5-web-example</span></span><br><span class="line"><span class="string">sonar.projectName=spring5-web-example</span></span><br><span class="line"><span class="string">sonar.java.source=1.11</span></span><br><span class="line"><span class="string">sonar.sources=src/main/java</span></span><br><span class="line"><span class="comment">#sonar.tests=src/main/test</span></span><br><span class="line"><span class="string">sonar.java.binaries=build/classes/java/main/com/example</span></span><br><span class="line"><span class="string">sonar.sourceEncoding=UTF-8</span></span><br><span class="line"><span class="string">sonar.exclusions=</span></span><br></pre></td></tr></table></figure><h2 id="Github-Action"><a href="#Github-Action" class="headerlink" title="Github Action"></a>Github Action</h2><p><a href="https://github.com/kitabisa/sonarqube-action">SonarQube GitHub Action</a>은 Github Action을 통해 소나큐브로 정적 분석을 수행할 수 있도록 지원합니다.</p><h3 id="소나큐브-워크플로우-코드-추가"><a href="#소나큐브-워크플로우-코드-추가" class="headerlink" title="소나큐브 워크플로우 코드 추가"></a>소나큐브 워크플로우 코드 추가</h3><p><strong>.github/workflows/sonarqube.yml</strong></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="comment"># schedule:</span></span><br><span class="line">    <span class="comment"># - cron: &#x27;0 * * * 1&#x27;</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">SonarQube</span> <span class="string">Workflow</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Build</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">JDK</span> <span class="number">1.11</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">AdoptOpenJDK/install-jdk@v1</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">&#x27;11&#x27;</span></span><br><span class="line">        <span class="attr">architecture:</span> <span class="string">x64</span></span><br><span class="line">        <span class="attr">targets:</span> <span class="string">&#x27;JAVA_HOME&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Grant</span> <span class="string">execute</span> <span class="string">permission</span> <span class="string">for</span> <span class="string">gradlew</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">chmod</span> <span class="string">+x</span> <span class="string">gradlew</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">with</span> <span class="string">Gradle</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">./gradlew</span> <span class="string">build</span> <span class="string">-x</span> <span class="string">test</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">build</span> <span class="string">artifact</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/upload-artifact@v2</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">build</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">build/classes</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">sonarQube:</span></span><br><span class="line">    <span class="attr">needs:</span> <span class="string">build</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">SonarQube</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Donwload</span> <span class="string">build</span> <span class="string">artifact</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/download-artifact@v2</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">build</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">build/classes</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SonarQube</span> <span class="string">Scan</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">kitabisa/sonarqube-action@master</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.SONAR_HOST</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">login:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.SONAR_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">projectBaseDir:</span> <span class="string">&#x27;/github/workspace&#x27;</span></span><br></pre></td></tr></table></figure><p>소나큐브 워크플로우 파일을 깃허브 리파지토리의 메인 또는 마스터 브랜치에 반영하면 깃허브에서 워크플로우를 등록합니다.</p><p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-04.png"></p><h3 id="소나큐브-관련-시크릿-생성"><a href="#소나큐브-관련-시크릿-생성" class="headerlink" title="소나큐브 관련 시크릿 생성"></a>소나큐브 관련 시크릿 생성</h3><p>소나큐브 워크플로우에서 사용하는 두가지 시크릿을 깃허브 리파지토리에 설정해야합니다.</p><ul><li>SONAR_HOST : 소나큐브 호스트 주소</li><li>SONAR_TOKEN : 소나큐브에서 발급한 토큰 정보</li></ul><p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-05.png"></p><h3 id="소나큐브-워크플로우-실행"><a href="#소나큐브-워크플로우-실행" class="headerlink" title="소나큐브 워크플로우 실행"></a>소나큐브 워크플로우 실행</h3><p>소나큐브 워크플로우 설정이 완료되었으므로 메인 브랜치를 기준으로 워크플로우를 실행합니다.</p><p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-06.png"></p><p>프로젝트 코드에 대한 빌드가 정상적으로 수행되고 소나큐브 서버를 통해 정적 분석을 수행되었다면 다음과 같이 워크플로우가 정상적으로 완료됩니다.</p><p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-07.png"></p><h2 id="정적-분석-결과"><a href="#정적-분석-결과" class="headerlink" title="정적 분석 결과"></a>정적 분석 결과</h2><p>소나큐브 시스템에 접속하여 소나큐브 워크플로우를 실행한 프로젝트의 정적 분석 결과를 확인합니다.</p><p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-08.png"></p><p>빌드 테스트는 수행하지 않았기 때문에 코드 커버리지는 분석할 수 없었으나 10개의 코드 악취가 발견되었습니다.</p><h3 id="코드-악취-검토-및-개선"><a href="#코드-악취-검토-및-개선" class="headerlink" title="코드 악취 검토 및 개선"></a>코드 악취 검토 및 개선</h3><p>정적 분석 결과로 검출된 코드 악취에 대한 내용을 검토하고 이를 개선해보겠습니다.</p><h4 id="코드-악취"><a href="#코드-악취" class="headerlink" title="코드 악취"></a>코드 악취</h4><p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-09.png"></p><p>첫번째 검출 항목은 연속된 라인을 주석으로 처리한 부분을 제거해야한다는 것입니다. </p><p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-10.png"></p><p>만약, 이렇게 주석되어있는 것이 남아있어야 한다고 가정하면 다음과 같이 프로젝트에 대한 검출 규칙을 변경할 수 있습니다.</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Ignore Rules</span></span><br><span class="line"><span class="meta">sonar.issue.ignore.multicriteria</span>=<span class="string">e1,e2</span></span><br><span class="line"><span class="meta">sonar.issue.ignore.multicriteria.e1.ruleKey</span>=<span class="string">java:S125</span></span><br><span class="line"><span class="meta">sonar.issue.ignore.multicriteria.e1.resourceKey</span>=<span class="string">**/*.java</span></span><br><span class="line"><span class="meta">sonar.issue.ignore.multicriteria.e2.ruleKey</span>=<span class="string">java:S1192</span></span><br><span class="line"><span class="meta">sonar.issue.ignore.multicriteria.e2.resourceKey</span>=<span class="string">**/*.java</span></span><br></pre></td></tr></table></figure><p>java:S125는 블록으로 된 주석을 남기고 있다는 악취이며 java:S1192는 동일한 문자열을 상수로 취급하지 않는다는 악취입니다. 저는 이것을 악취로 보지 않기 위해서 위와 같이 설정하고 소나큐브 워크플로우를 다시 수행해보겠습니다.</p><p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-11.png"></p><p>기존에 검출되었던 코드 악취 중 java:S125와 java:S1192에 해당하는 부분이 제외되어 3개의 코드 악취가 줄어들었음을 확인할 수 있습니다. 이렇게 회사 또는 개발팀에서 프로젝트 코드에 대한 규칙을 검토하는 과정을 거쳐야합니다만 저희 회사는 정작 그러지 않고 있어 아쉬움이 많습니다. 체계가 없다보니 무언가 도입을 원하지만 실제로는 제대로 활용하지 않는게 많은 것 같아요.</p><p>아무튼 나머지 코드 악취에 대해서도 리팩토링을 수행하여 없애보도록 하면서 마치겠습니다.</p><p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-12.png"></p><h4 id="SuppressWarnings"><a href="#SuppressWarnings" class="headerlink" title="@SuppressWarnings"></a>@SuppressWarnings</h4><p>sonar-project.properties에서 제외되도록 정의한 규칙이 패턴에 의한 것이라면 특정 클래스 또는 함수 단위로 규칙을 제외하고 싶은 경우 @SuppressWarnings을 사용할 수 있습니다. </p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&#123;&quot;squid:S125&quot;,&quot;squid:S1192&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 SonarQube와 Github Action을 통해 정적 분석을 수행하기 위한 과정을 알아보려고 합니다.&lt;/p&gt;
&lt;h2 id=&quot;SonarQube&quot;&gt;&lt;a href=&quot;#SonarQube&quot; class=</summary>
      
    
    
    
    
    <category term="SonarQube" scheme="https://kdevkr.github.io/tags/SonarQube/"/>
    
    <category term="Github Action" scheme="https://kdevkr.github.io/tags/Github-Action/"/>
    
  </entry>
  
  <entry>
    <title>리눅스에서 프로세스 실행 유지하기</title>
    <link href="https://kdevkr.github.io/maintaining-process-execution-in-linux/"/>
    <id>https://kdevkr.github.io/maintaining-process-execution-in-linux/</id>
    <published>2021-10-10T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.031Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>서버에서 실행중인 애플리케이션은 언제든지 <strong>예기치 않은 상황</strong>으로 중단될 수 있습니다. 예를 들어, 일시적으로 전력이 차단되어 서버 장비가 다시 시작되거나 애플리케이션 프로세스가 서버 자원을 많이 사용해서 프로세스가 중단되는 상황이 발생할 수 있습니다. </p><p>그래서 오늘 알아볼 내용은 리눅스에서 예기치 않은 상황으로 인하여 프로세스가 중단되었을 경우 자동으로 프로세스를 다시 실행시킴으로써 프로세스 실행 상태를 유지하기 위한 방법입니다.</p><h2 id="프로세스-실행-유지"><a href="#프로세스-실행-유지" class="headerlink" title="프로세스 실행 유지"></a>프로세스 실행 유지</h2><p>먼저, 스프링 부트 애플리케이션을 다음과 같이 실행할 수 있다고 가정 하겠습니다.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">nohup java -jar -Xmx500m demo.war 1&gt; app.log 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="comment"># [1] 227</span></span><br><span class="line"></span><br><span class="line">ls -l</span><br><span class="line"><span class="comment"># total 21M</span></span><br><span class="line"><span class="comment"># -rw-r--r-- 1 ec2-user ec2-user 2.0K Oct  8 15:19 app.log</span></span><br><span class="line"><span class="comment"># -rw-r--r-- 1 ec2-user ec2-user    3 Oct  8 15:19 app.pid</span></span><br><span class="line"><span class="comment"># -rwxr-xr-x 1 ec2-user ec2-user  20M Oct  8 12:28 demo.war*</span></span><br><span class="line"></span><br><span class="line">cat app.pid</span><br><span class="line"><span class="comment"># 227</span></span><br></pre></td></tr></table></figure><p>위 예시에서 nohup 명령어를 사용하고 출력된 프로세스 아이디와 스프링 부트 애플리케이션에서 ApplicationPidWriter에 의해 생성된 프로세스 아이디 파일이 동일한 것을 확인할 수 있습니다.</p><h3 id="프로세스-아이디-확인하기"><a href="#프로세스-아이디-확인하기" class="headerlink" title="프로세스 아이디 확인하기"></a>프로세스 아이디 확인하기</h3><p>앞서 스프링 부트 애플리케이션처럼 애플리케이션 자체적으로 현재 실행중인 프로세스 아이디를 저장할 수 있는 기능을 포함하고 있다면 좋겠지만 그렇지 않을 수 있습니다. 그래서 이미 실행중인 프로세스 아이디를 확인하고 가져올 수 있는 방법을 알아야 합니다.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># echo $!</span></span><br><span class="line">nohup java -jar -Xmx500m demo.war 1&gt; app.log 2&gt;&amp;1 &amp; <span class="built_in">echo</span> $! &gt; app.pid</span><br><span class="line"></span><br><span class="line"><span class="comment"># JPS(JVM Process Status)</span></span><br><span class="line">jps -v | grep war | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ps -ef</span></span><br><span class="line">ps -ef | grep java | grep -v grep | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># netstat -tnlp</span></span><br><span class="line">netstat -tnlp | grep java | awk <span class="string">&#x27;&#123;print $7&#125;&#x27;</span> | awk -F <span class="string">&#x27;/&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pgrep</span></span><br><span class="line">pgrep java</span><br></pre></td></tr></table></figure><p>첫번째 방식에 사용된 <strong>echo $!</strong> 는 마지막으로 백그라운드에서 실행된 명령어에 대한 PID값을 출력할 수 있는 명령어입니다.</p><h3 id="Crontab으로-프로세스-유지하기"><a href="#Crontab으로-프로세스-유지하기" class="headerlink" title="Crontab으로 프로세스 유지하기"></a>Crontab으로 프로세스 유지하기</h3><p>일반적으로 사용되는 고전적인 방식은 앞서 다양한 방식으로 추출된 프로세스 아이디에 대한 프로세스 실행 상태를 체크하는 스크립트를 Crontab을 통해 주기적으로 실행하는 것입니다.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">PID_FILE=<span class="string">&quot;app.pid&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">autorun</span></span> () &#123;</span><br><span class="line">  <span class="comment"># ... &amp; echo $! &gt; app.pid</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$PID_FILE</span>&quot;</span> ] &amp;&amp; [ ! -z `cat <span class="string">&quot;<span class="variable">$PID_FILE</span>&quot;</span>` ]; <span class="keyword">then</span></span><br><span class="line">  PID=$(cat <span class="variable">$PID_FILE</span>)</span><br><span class="line">  <span class="keyword">if</span> ps -p <span class="variable">$PID</span> &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$PID_FILE</span>(<span class="variable">$PID</span>) is running&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    autorun</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  autorun</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><h3 id="SystemD"><a href="#SystemD" class="headerlink" title="SystemD"></a>SystemD</h3><p>더 효율적인 방식은 Nginx와 같은 패키지를 APT 또는 YUM으로 설치할 때 SystemD 서비스에 자동으로 등록하는 것처럼  애플리케이션을 실행하는 명령어 또는 스크립트를 SystemD 서비스로 등록하는 것입니다. </p><p><strong>/etc/systemd/system/demo.service</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Demo</span><br><span class="line">After=syslog.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=ec2-user</span><br><span class="line">WorkingDirectory=/home/ec2-user</span><br><span class="line">ExecStart=/usr/bin/java -jar -Xmx500m demo.war</span><br><span class="line">ExecStop=kill -9 `cat app.pid`</span><br><span class="line">SuccessExitStatus=143</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>위와 같이 스크립트를 정의했다면 다음과 같이 서버가 실행될 때 서비스가 시작되도록 활성화하거나 직접 서비스를 실행하고 종료할 수 있습니다.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> demo.service</span><br><span class="line">sudo systemctl start demo.service</span><br></pre></td></tr></table></figure><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;서버에서 실행중인 애플리케이션은 언제든지 &lt;strong&gt;예기치 않은 상황&lt;/strong&gt;으로 중단될 수 있습니다. 예를 들어, 일시적으로 전력이 차단되어 서버 장비가 다시 시작되거나 애플리케이션 프로세스</summary>
      
    
    
    
    
    <category term="Linux" scheme="https://kdevkr.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>AWS IAM 사용자 리전 제한하기</title>
    <link href="https://kdevkr.github.io/limit-region-aws-iam-user/"/>
    <id>https://kdevkr.github.io/limit-region-aws-iam-user/</id>
    <published>2021-10-03T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.031Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>회사에 있던 책들 중 <strong>탄력적 개발로 이끄는 AWS 실천 기술</strong>이라는 책을 읽어보고 관련된 정보를 찾으면서 AWS 활용 방안에 대해 공부하고 있습니다.</p><p>AWS 프리 티어 또는 AWS 서비스를 학습하는 사람이라면 모든 권한을 가지고 있는 루트 사용자 계정을 사용하는 경우가 많을겁니다. 실무 환경에서는 회사의 루트 사용자 계정이 아닌 IAM을 통해 직무 또는 특정 권한을 가지는 사용자를 만들어서 사용하도록 구성하겠죠. 보안 등급이 높거나 체계적인 회사라면 AWS 리소스에 대한 정책을 검토하고 부여하겠지만 제가 다니고 있는 회사의 팀에서도 모든 권한을 부여한 사용자를 만들어서 사용하고 있는 것을 보았고 직원마다 권한을 부여할 수 있도록 사용자를 발급해달라고 요청하여 사용하고는 있습니다.</p><blockquote><p>루트 사용자 계정을 사용하지 않는다고 해도 권한 정책을 검토하고 부여하는 것이 귀찮은 건 맞습니다. 결국 사용자에게 모든 권한을 가지는 정책을 연결하여 사용할 수도 있습니다.</p></blockquote><p>AWS와 같은 클라우드 서비스는 다양한 지역에 존재하는 데이터 센터에 자원을 생성하고 사용할 수 있도록 지원하기 때문에 사용자 계정 정보가 유출된다면 주로 사용하는 리전이 아닌 곳에 AWS 리소스가 생성되고 요금이 발생하는 문제가 생길 수 있습니다. 일부 요금 폭탄 문제가 생기는 분들도 주로 사용하는 서울 리전에 대한 리소스만 체크한 상태로 있다가 전혀 사용하지 않고 있는 리전에 실행된 AWS 리소스로 인하여 발생하는 요금으로 당황하는 경우도 많은 것 같습니다. </p><p>이 글에서는 IAM 사용자의 계정 정보가 유출되더라도 주로 사용하는 리전만 접근할 수 있도록 제한하여 불필요한 리전에 AWS 리소스가 나도 모르게 생성되지 않도록 방지하는 대책을 설정할 수 있는 방법을 알려드립니다.</p><h2 id="AWS-IAM"><a href="#AWS-IAM" class="headerlink" title="AWS IAM"></a>AWS IAM</h2><p>IAM(Identity and Access Management)은 사용자의 신원을 확인하거나 리소스에 대한 액세스 권한을 통합적으로 관리하는 기능을 말합니다. AWS IAM도 마찬가지로 조직을 구성하거나 장기 또는 임시적으로 AWS 리소스 권한을 부여하는 기능을 제공합니다.</p><h3 id="IAM-사용자"><a href="#IAM-사용자" class="headerlink" title="IAM 사용자"></a>IAM 사용자</h3><p>AWS IAM의 사용자는 AWS 리소스에 대한 장기적인 권한을 가지도록 구성하는 장기 자격 증명입니다. </p><p>먼저, 테스트를 위한 IAM 사용자인 pika를 만들겠습니다. pika는 <strong>모든 권한을 가지는 직무 정책인 AdminisratorAccess</strong>를 가진다고 가정하겠습니다.</p><p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-01.png"></p><p>pika는 AWS에서 기본적으로 제공하는 관리형 정책인 AdministratorAccess와 IAMUserChangePassword을 가지게 되었습니다.</p><p>그러면 pika 사용자의 비밀번호가 유출되어 누군가가 AWS 콘솔에 접속할 수 있게 된다면 수 많은 리전에 VPC를 생성하거나 EC2 인스턴스를 실행할 수 있는 상태가 됩니다.</p><p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-02.png"></p><h3 id="IAM-사용자-리전-제한"><a href="#IAM-사용자-리전-제한" class="headerlink" title="IAM 사용자 리전 제한"></a>IAM 사용자 리전 제한</h3><p>만약 pika라는 사용자가 애플리케이션을 운영하기 위한 구성을 서울(ap-northeast-2) 리전에서만 사용한다고 가정해본다면 다른 리전에 대한 권한을 불필요하게 주고 있는 상태가 됩니다. </p><h4 id="aws-RequestedRegion"><a href="#aws-RequestedRegion" class="headerlink" title="aws:RequestedRegion"></a>aws:RequestedRegion</h4><p>IAM 정책을 정의할 때 aws:RequestedRegion는 글로벌 조건 키를 사용하면 특정 리전에 대해서만 권한을 가지도록 제한할 수 있습니다.</p><p>만약, 서울 리전만 권한을 부여하고 싶다면 다음과 같이 조건절을 정의하면 됩니다.</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;Action&quot;</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;Condition&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;StringEquals&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;aws:RequestedRegion&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;ap-northeast-2&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>기존에 연결하였던 AdministratorAccess라는 직무 정책을 해제하고 AdministratorAccessOnlySeoul이라는 정책을 만들어서 연결하겠습니다.</p><p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-03.png"></p><h3 id="리전-제한-확인"><a href="#리전-제한-확인" class="headerlink" title="리전 제한 확인"></a>리전 제한 확인</h3><p>pika 사용자는 서울 리전에 대한 권한만 가지도록 제한되었기 때문에 정말로 그러한 상태가 되는지 확인해보겠습니다.</p><p>연결되지 않은 탄력적 IP는 요금을 지불해야하므로 탄력적 IP를 생성하려고 시도했지만 불가능합니다. </p><p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-04.png"></p><p>EC2 인스턴스를 생성하기 위해서 서울 리전에서 사용가능한 AMI 유형을 조회할 수 없기 때문에 진행할 수 없습니다.</p><p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-05.png"></p><p>도쿄 리전에 대한 페이지는 접속할 수 있지만 AWS 리소스를 생성하는 것은 동일하게 AWS API를 사용하기 때문에 서울 리전외에는 권한 오류가 발생하게 됩니다.</p><p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-06.png"></p><p>심지어는 글로벌 리전 서비스인 S3에서도 권한 오류가 발생합니다. 이는 S3 서비스로 이동할 때 현재 리전 파라미터를 전달하기 때문인데 서울 리전으로 변경하거나 제거하시면 됩니다.</p><p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-07.png"></p><h3 id="경계-설정으로-리전-제한"><a href="#경계-설정으로-리전-제한" class="headerlink" title="경계 설정으로 리전 제한"></a>경계 설정으로 리전 제한</h3><p>앞서 pika 사용자는 AdministratorAccess라는 직무 정책과 동일하게 모든 권한을 가지는 AdministratorAccessOnlySeoul이라는 정책을 만들어서 연결하여 제한하였습니다. 그러나 사용자마다 부여된 권한이 다를 수 있기 때문에 매번 리전을 제한하는 정책을 만들어서 연결하기에는 불편함이 있습니다. 이 경우에는 정책을 권한 경계(Permissions boundary)로 설정하면 모든 사용자마다 부여된 정책에 대하여 리전을 제한할 수 있습니다.</p><h4 id="특정-서비스에-대한-권한을-가진-사용자"><a href="#특정-서비스에-대한-권한을-가진-사용자" class="headerlink" title="특정 서비스에 대한 권한을 가진 사용자"></a>특정 서비스에 대한 권한을 가진 사용자</h4><p>제가 사용하는 mambo라는 사용자는 VPC, EC2, S3에 대한 모든 권한을 가지도록 정책을 연결하였습니다.</p><p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-08.png"></p><h4 id="서울-리전을-경계로-제한"><a href="#서울-리전을-경계로-제한" class="headerlink" title="서울 리전을 경계로 제한"></a>서울 리전을 경계로 제한</h4><p>이전과 동일하게 서울 리전만을 사용할 수 있도록 제한하기 위해 정책을 만들어서 권한 경계로 설정하겠습니다.</p><p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-09.png"></p><p>mambo 사용자는 RDS에 대한 권한이 없기 때문에 서울 리전에서도 RDS를 사용하여 데이터베이스를 생성할 수 없습니다.</p><p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-10.png"></p><p>EC2 서비스에 대한 권한을 가지고 있지만 경계 설정으로 인하여 서울 리전이 아니면 권한이 없게 됩니다.</p><p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-11.png"></p><h4 id="글로벌-서비스-리전"><a href="#글로벌-서비스-리전" class="headerlink" title="글로벌 서비스 리전"></a>글로벌 서비스 리전</h4><p>CloudFront, Route53, IAM과 같은 글로벌 서비스는 미국 동부 (us-east-1) 리전의 엔드포인트를 사용하기 때문에 이에 대한 권한을 별도로 설정하여야합니다.</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;Action&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;cloudfront:*&quot;</span>,</span><br><span class="line">        <span class="string">&quot;route53:*&quot;</span>,</span><br><span class="line">        <span class="string">&quot;iam:*&quot;</span>,</span><br><span class="line">        <span class="string">&quot;support:*&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;Resource&quot;</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;Condition&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;StringEquals&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;aws:RequestedRegion&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;us-east-1&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="끝마치며"><a href="#끝마치며" class="headerlink" title="끝마치며"></a>끝마치며</h2><p>IAM 사용자가 사용할 수 있는 리전을 제한함으로써 비록 계정 정보가 유출되더라도 서울 리전에서만 AWS 리소스를 마음대로 생성할 수 있도록 방지할 수 있게 되었습니다. 이 방법을 적용하더라도 IAM 사용자의 비밀번호와 액세스 키는 주기적으로 갱신하는 것은 반드시 필요합니다.</p><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;회사에 있던 책들 중 &lt;strong&gt;탄력적 개발로 이끄는 AWS 실천 기술&lt;/strong&gt;이라는 책을 읽어보고 관련된 정보를 찾으면서 AWS 활용 방안에 대해 공부하고 있습니다.&lt;/p&gt;
&lt;p&gt;AWS 프리</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>EC2 인스턴스에서 S3 버킷 액세스하기</title>
    <link href="https://kdevkr.github.io/ec2-instance-access-s3-bucket/"/>
    <id>https://kdevkr.github.io/ec2-instance-access-s3-bucket/</id>
    <published>2021-10-02T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.031Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 EC2 인스턴스에서 S3 버킷에 액세스할 수 있도록 구성하는 방법에 대해 알아봅니다.</p><p>최근 회사에서 진행하고 있는 프로젝트 중에는 보안 정책에 의해 고객이 구성한 EC2 인스턴스에 대한 접근 정보만을 제공받아 애플리케이션 실행해야하는 요구사항이 생겼습니다. 현재 애플리케이션에서 사용중인 데이터베이스 중에는 EC2 인스턴스에 직접 설치하여 사용하고 있는 상용 시계열 데이터베이스가 있습니다. 이 데이터베이스의 데이터를 주기적으로 백업하기 위하여 매일 1시에 파일로 저장된 데이터를 압축하여 S3로 저장하는 스크립트를 수행하고 있습니다. 고객이 보유한 EC2 인스턴스에서 이 데이터베이스의 백업 파일을 저장하기 위한 S3 버킷에 대한 권한을 지정해주도록 유도할 예정입니다.</p><h2 id="S3-버킷-정책"><a href="#S3-버킷-정책" class="headerlink" title="S3 버킷 정책"></a>S3 버킷 정책</h2><p>S3에서 버킷을 만들면 기본적으로 <strong>모든 퍼블릭 액세스 차단</strong>됩니다.</p><p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-01.png"></p><p>그리고 <strong>버킷 정책</strong>을 통해 버킷 또는 버킷에 저장된 오브젝트에 대한 액세스 권한을 부여할 수 있습니다. </p><h3 id="버킷-정책-생성"><a href="#버킷-정책-생성" class="headerlink" title="버킷 정책 생성"></a>버킷 정책 생성</h3><p>버킷 정책을 생성할 때는 아마존 웹 서비스에서 제공하는 <a href="http://awspolicygen.s3.amazonaws.com/policygen.html">AWS Policy Generator</a>를 사용하는 것이 좋습니다.</p><p>다음은 특정 IP에 대해서 버킷에 대한 조회, 읽기, 쓰기 권한을 부여하는 정책을 생성한 예시입니다.</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;Action&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;s3:ListBucket&quot;</span>,</span><br><span class="line">                <span class="string">&quot;s3:GetObject&quot;</span>,</span><br><span class="line">                <span class="string">&quot;s3:PutObject&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::mambo.kr&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::mambo.kr/*&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;Condition&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;IpAddress&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;aws:SourceIp&quot;</span>: <span class="string">&quot;218.156.190.x/32&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>버킷 정책을 정의하는 JSON의 크기는 20kB로 제한됩니다.</p></blockquote><p>버킷 정책에 대한 더 자세한 내용은 <a href="https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/example-bucket-policies.html">버킷 정책 예제</a> 문서를 참고하세요.</p><h2 id="EC2-인스턴스"><a href="#EC2-인스턴스" class="headerlink" title="EC2 인스턴스"></a>EC2 인스턴스</h2><p>아마존 리눅스 AMI로 EC2 인스턴스를 실행하면 AWS CLI가 기본으로 설치되어있습니다. 따라서, AWS CLI를 사용해서 S3 서비스에 작업을 수행할 수 있습니다.</p><h3 id="IAM-역할-생성"><a href="#IAM-역할-생성" class="headerlink" title="IAM 역할 생성"></a>IAM 역할 생성</h3><p>S3 버킷 권한 설정에서 버킷 정책을 설정할 수 있으나 IAM 역할을 만들고 인라인 정책으로 적용할 수도 있습니다. 우리는 EC2 인스턴스에서 접근해야하므로 EC2 서비스에 대한 IAM 역할을 만들어서 인스턴스 프로파일로 등록하겠습니다.</p><p>먼저, EC2 인스턴스에서 AWS CLI로 버킷을 조회해보겠습니다.</p><p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-02.png"></p><p>현재 EC2 인스턴스에는 IAM 인스턴스 프로파일이 지정되어있지 않기 때문에 오류가 발생합니다.</p><p>IAM 메뉴에서 신규로 역할을 생성합니다.</p><p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-03.png"></p><p>S3 버킷에 대한 권한을 인라인 정책으로 정의할 것이므로 관리형 정책은 설정하지않습니다.</p><p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-04.png"></p><p>생성한 IAM 역할을 EC2 인스턴스 프로파일로 지정합니다.</p><p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-05.png"></p><p>IAM 역할에 어떠한 정책을 적용하지 않고 버킷을 조회해보겠습니다.</p><p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-06.png"></p><p>IAM 역할을 지정하였기에 AWS CLI를 사용할 수 있게 되었지만 mambo.kr 이라는 버킷에 대한 ListObjectsV2 작업은 Access Denied 오류가 발생했습니다.</p><h3 id="인라인-정책"><a href="#인라인-정책" class="headerlink" title="인라인 정책"></a>인라인 정책</h3><p>우리가 생성한 IAM 역할에는 어떠한 정책도 연결하지 않았기 때문에 접근 권한을 가지지 않는게 당연합니다. 다시 IAM 메뉴로 돌아가서 <strong>인라인 정책 추가</strong>를 선택합니다.</p><p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-07.png"></p><p>버킷 정책 예제를 참고해서 다음과 같이 JSON 형식으로 버킷 정책을 정의합니다.</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;Sid&quot;</span>: <span class="string">&quot;Mannual&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;Action&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;s3:ListBucket&quot;</span>,</span><br><span class="line">                <span class="string">&quot;s3:GetObject&quot;</span>,</span><br><span class="line">                <span class="string">&quot;s3:PutObject&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::mambo.kr&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::mambo.kr/*&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-08.png"></p><h3 id="버킷-조회"><a href="#버킷-조회" class="headerlink" title="버킷 조회"></a>버킷 조회</h3><p>S3 버킷에 대한 정책이 IAM 인라인 정책으로 연결되었으니 버킷에 대한 접근 권한이 가지게 되었는지 확인합니다.</p><p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-09.png"></p><p>EC2 인스턴스에서 사용자 계정의 보유한 S3 버킷에 대한 목록은 권한이 없어서 조회할 수 없으나 인라인 정책으로 정의된 mambo.kr 버킷에 대해서는 조회되었습니다.</p><p>만약, S3 버킷 목록을 조회하고 싶다면 다음과 같이 Statement를 추가하시면 됩니다.</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;Sid&quot;</span>: <span class="string">&quot;Mannual&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;Action&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;s3:ListBucket&quot;</span>,</span><br><span class="line">                <span class="string">&quot;s3:GetObject&quot;</span>,</span><br><span class="line">                <span class="string">&quot;s3:PutObject&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::mambo.kr&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::mambo.kr/*&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;Sid&quot;</span>: <span class="string">&quot;Mannual-2&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;Action&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;s3:ListBucket&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::*/*&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>빈 텍스트 파일을 만들어서 버킷에 업로드하고 가져올 수 있는지 확인해보겠습니다.</p><p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-10.png"></p><p>S3에 저장할 수 있는 크기에 대한 제한은 없으나 PUT 요청으로 업로드 가능한 크기는 최대 5GB입니다. AWS CLI의 S3 명령어를 사용하는 경우 일정 크기 이상이라면 멀티파트 업로드를 수행하므로 알고 계시고 신경쓰지 않아도 됩니다.</p><h2 id="마치며"><a href="#마치며" class="headerlink" title="마치며"></a>마치며</h2><p>퍼블릭 IP가 할당되지 않는 EC2 인스턴스라면 AWS PrivateLink로 구성되는 VPC 인터페이스 엔드포인트를 사용하여 <a href="https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/privatelink-interface-endpoints.html">S3 서비스와 통신할 수 있도록 설정</a>해야합니다. 그리고 다른 사용자 계정의 ARN을 제공받아서 접근할 수 있게 구성할 수도 있으니 공식 문서에서 제공하는 다양한 정책 예제를 참고해봅시다.</p><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 EC2 인스턴스에서 S3 버킷에 액세스할 수 있도록 구성하는 방법에 대해 알아봅니다.&lt;/p&gt;
&lt;p&gt;최근 회사에서 진행하고 있는 프로젝트 중에는 보안 정책에 의해 고객이 구성한 EC2 인스턴스에 대</summary>
      
    
    
    
    
    <category term="EC2" scheme="https://kdevkr.github.io/tags/EC2/"/>
    
    <category term="S3" scheme="https://kdevkr.github.io/tags/S3/"/>
    
  </entry>
  
  <entry>
    <title>EC2 인스턴스 연결(콘솔) 허용하기</title>
    <link href="https://kdevkr.github.io/allow-ec2-instance-connect/"/>
    <id>https://kdevkr.github.io/allow-ec2-instance-connect/</id>
    <published>2021-09-26T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.031Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘 알아볼 내용은 EC2 인스턴스 연결(EC2 Instance Connect) 기능입니다. 일반적으로 EC2 인스턴스에 접속하기 위해서는 SSH 클라이언트를 사용합니다. 아마존 EC2 콘솔은 SSH 클라이언트를 사용하지 않고도 EC2 인스턴스에 연결할 수 있는 기능을 제공하고 있습니다. 어떻게 해야 EC2 콘솔을 통해 EC2 인스턴스에 연결할 수 있는지 알아봅시다.</p><h2 id="EC2-인스턴스-연결"><a href="#EC2-인스턴스-연결" class="headerlink" title="EC2 인스턴스 연결"></a>EC2 인스턴스 연결</h2><p><strong>EC2 인스턴스 연결</strong>은 아마존 EC2 콘솔을 통해 퍼블릭 IPv4 주소가 할당된 인스턴스에 연결할 수 있는 기능입니다. EC2 인스턴스 연결에 대한 자세한 내용은 <a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/ec2-instance-connect-methods.html#ec2-instance-connect-connecting-console">EC2 Instance Connect를 사용한 연결</a> 문서에서 확인할 수 있습니다.</p><p>퍼블릭 IPv4 주소가 할당된 Amazon Linux 2 또는 Ubuntu 16.04 이상의 인스턴스라면 아마존 EC2 콘솔에서 제공하는 EC2 인스턴스 연결 기능을 사용하여 인스턴스에 접속할 수 있습니다.</p><h3 id="인바운드-SSH-트래픽-허용"><a href="#인바운드-SSH-트래픽-허용" class="headerlink" title="인바운드 SSH 트래픽 허용"></a>인바운드 SSH 트래픽 허용</h3><p>기본으로 제공하는 보안 그룹에는 SSH 트래픽을 수신하는 것을 허용하지 않습니다. EC2 인스턴스 연결을 사용하기 위해서는 <strong>EC2_INSTANCE_CONNECT라는 서비스가 사용하는 IP 대역에 대하여 SSH 트래픽을 수신하도록 허용</strong>해야합니다.</p><p>EC2_INSTANCE_CONNECT 서비스가 사용하는 IP 대역은 <a href="https://ip-ranges.amazonaws.com/ip-ranges.json">AWSIP 주소 범위</a>에서 EC2_INSTANCE_CONNECT 서비스와 VPC가 생성된 region에 대하여 필터링을 해야합니다.</p><p><img data-src="/images/posts/allow-ec2-instance-connect/ec2-instance-connect-01.png"></p><p>다행히도 다른 서비스와 다르게 EC2_INSTANCE_CONNECT는 리전별로 하나이므로 <strong>13.209.1.56/29</strong> IP 대역을 SSH 트래픽으로 수신하도록 허용하면 됩니다.</p><p>회사에서 지급받은 구형 맥북에서 <a href="https://aws.amazon.com/ko/premiumsupport/knowledge-center/ec2-instance-connect-troubleshooting/">AWS 문서에서 알려주는 다음의 명령어</a>를 쳐봐도 하나만 나옵니다.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -s https://ip-ranges.amazonaws.com/ip-ranges.json| jq -r <span class="string">&#x27;.prefixes[] | select(.region==&quot;us-east-1&quot;) | select(.service==&quot;EC2_INSTANCE_CONNECT&quot;) | .ip_prefix&#x27;</span></span><br><span class="line">13.209.1.56/29</span><br></pre></td></tr></table></figure><p><img data-src="/images/posts/allow-ec2-instance-connect/ec2-instance-connect-02.png"></p><p>위와 같이 13.209.1.56/29 대역에 대한 SSH 트래픽을 수신할 수 있도록 허용하였으니 이제 이 보안그룹을 인스턴스에 추가하면 됩니다.</p><h3 id="샘플-인스턴스-생성"><a href="#샘플-인스턴스-생성" class="headerlink" title="샘플 인스턴스 생성"></a>샘플 인스턴스 생성</h3><p><img data-src="/images/posts/allow-ec2-instance-connect/ec2-instance-connect-03.png"></p><p>샘플 인스턴스는 기본으로 제공하는 보안 그룹을 지정하였습니다. 따라서 SSH 트래픽에 대해서 허용하지 않은 상태이므로 다음과 같이 EC2 인스턴스 연결을 시도하면 실패하게 됩니다.</p><p><img data-src="/images/posts/allow-ec2-instance-connect/ec2-instance-connect-04.png"></p><p>이제 샘플 인스턴스에 ec2-instance-connect 보안그룹을 추가하겠습니다.</p><p><img data-src="/images/posts/allow-ec2-instance-connect/ec2-instance-connect-05.png"></p><p>다시 아마존 EC2 콘솔의 EC2 인스턴스 연결으로 샘플 인스턴스에 접속해보겠습니다.</p><p><img data-src="/images/posts/allow-ec2-instance-connect/ec2-instance-connect-06.png"></p><p>EC2_INSTANCE_CONNECT 서비스의 IP 대역을 허용하였기 때문에 정상적으로 접속되었습니다.</p><p><img data-src="/images/posts/allow-ec2-instance-connect/complete.gif"></p><p>보안을 중요시하는 회사라면 모든 IP 대역에 대하여 SSH 접속을 허용하지 않고 <strong>EC2_INSTANCE_CONNECT 서비스와 회사에서 사용되는 IP 대역을 허용하시는 것을 권장</strong>합니다.</p><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘 알아볼 내용은 EC2 인스턴스 연결(EC2 Instance Connect) 기능입니다. 일반적으로 EC2 인스턴스에 접속하기 위해서는 SSH 클라이언트를 사용합니다. 아마존 EC2 콘솔은 SSH 클</summary>
      
    
    
    
    
    <category term="AWS" scheme="https://kdevkr.github.io/tags/AWS/"/>
    
    <category term="EC2" scheme="https://kdevkr.github.io/tags/EC2/"/>
    
  </entry>
  
  <entry>
    <title>엔진엑스로 알아보는 리버스 프록시</title>
    <link href="https://kdevkr.github.io/reverse-proxy-using-nginx/"/>
    <id>https://kdevkr.github.io/reverse-proxy-using-nginx/</id>
    <published>2021-09-25T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.031Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p><img data-src="https://digital.com/wp-content/uploads/what-is-nginx.png"></p><p>오늘은 웹 서비스 인프라에서 리버스 프록시 구성을 위해 사용되는 Nginx와 함께 리버스 프록시에 대해 알아보고자 합니다.</p><h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><p>Nginx는 정적 파일을 배포할 수 있는 HTTP 웹 서버입니다. 최근 애플리케이션 서버를 배포하는 경우 단독으로 구성하지 않고 Nginx를 함께 사용합니다. 아마존 웹 서비스의 Elastic Beanstalk 환경에서는 리버스 프록시 구성을 위하여 Nginx를 기본적으로 제공하고 있습니다. 이렇게 애플리케이션 서버 앞에서 먼저 트래픽을 처리하도록 구성하는 리버스 프록시를 사용하는 이유는 무엇일까요?</p><h3 id="리버스-프록시"><a href="#리버스-프록시" class="headerlink" title="리버스 프록시"></a>리버스 프록시</h3><p>리버스 프록시는 <strong>사용자의 요청에 대한 사후처리를 수행하여 애플리케이션 서버로 트래픽을 전달되도록 하는 것</strong>을 말합니다. 리버스 프록시 구성의 장점은 사용자에게 애플리케이션 서버가 실행되는 아이피 또는 포트를 공개하지 않거나 잘못된 요청을 애플리케이션 서버까지 전달되지 않도록하여 보호할 수 있습니다. </p><h3 id="로드-밸런싱"><a href="#로드-밸런싱" class="headerlink" title="로드 밸런싱"></a>로드 밸런싱</h3><p>리버스 프록시를 구성함으로써 사용자는 특정 애플리케이션 서버로 직접 요청하는 구조가 아니므로 동시에 발생하는 수 많은 웹 요청을 1개 이상으로 실행된 다수의 애플리케이션 서버로 <strong>로드밸런싱(트래픽을 분산)</strong> 함으로써 애플리케이션 서버에 대한 부하를 줄일 수 있습니다.</p><p>물론, 에픽 게임즈의 <a href="https://www.epicgames.com/fortnite/ko/news/postmortem-of-service-outage-at-3-4m-ccu">340만 동접자 이후 서비스 다운 관련 사후 분석 내용</a>처럼 리버스 프록시를 구성한다고해서 모든 트래픽을 감당할 수 있는 것은 아닙니다.</p><h3 id="SSL-오프로드"><a href="#SSL-오프로드" class="headerlink" title="SSL 오프로드"></a>SSL 오프로드</h3><p>Nginx로 리버스 프록시를 구성함으로써 수행할 수 있는 사후처리 중 하나는 <strong>SSL 오프로드</strong>입니다. 리버스 프록시를 수행하는 웹 서버에서 SSL 인증서를 관리하고 <a href="https://www.f5.com/services/resources/glossary/ssl-termination">SSL Termination</a>을 수행함으로써 애플리케이션 서버가 트래픽 암호화를 위해 수행하던 부하와 관리 포인트를 줄일 수 있습니다.</p><h3 id="정적-파일-캐시"><a href="#정적-파일-캐시" class="headerlink" title="정적 파일 캐시"></a>정적 파일 캐시</h3><p>애플리케이션 서버가 배포하는 정적 파일에 대해서 Nginx 자체적으로 캐시하여 정적 파일을 응답할 수 있습니다. 애플리케이션 서버로 전달되는 트래픽이 많아질 경우 정적 파일을 응답하기 위한 요청을 처리하는 것도 부담이 될 수 있습니다. 많은 트래픽을 적은 리소스를 사용하여 처리할 수 있는 웹 서버에서 정적 파일에 대한 요청을 처리하여 애플리케이션 서버의 부담을 줄일 수 있게 됩니다.</p><p>창천향로님의 <a href="https://jojoldu.tistory.com/60">Nginx Cache 문제 해결 시리즈</a>처럼 캐시를 잘 구성해야할 수 있습니다.</p><h2 id="Nginx-도커-컨테이너-학습"><a href="#Nginx-도커-컨테이너-학습" class="headerlink" title="Nginx 도커 컨테이너 학습"></a>Nginx 도커 컨테이너 학습</h2><p>도커는 어떠한 기술을 학습하기 위한 환경을 구성하기에 적합한 도구입니다. 도커를 사용하여 애플리케이션 서버와 함께 리버스 프록시를 구성하는 Nginx를 설정해보며 학습해보도록 하겠습니다.</p><p>저의 학습 환경은 다음과 같습니다. 환경이 다른 경우 다른 부분이 존재할 수 있으니 주의해야합니다. </p><ul><li>Docker version 20.10.8, build 3967b7d  </li><li>Nginx 1.21.3  </li><li>Amazon Corretto 11  </li></ul><p>그리고 학습에 활용된 파일들은 <a href="https://github.com/kdevkr/nginx.conf">깃허브</a>에 공유되어있으니 참고하셔도 좋습니다.</p><h3 id="기본-컨테이너-환경"><a href="#기본-컨테이너-환경" class="headerlink" title="기본 컨테이너 환경"></a>기본 컨테이너 환경</h3><p>도커 컴포즈를 활용하여 스프링 부트 애플리케이션과 Nginx가 구동되도록 컨테이너 환경을 구성했습니다.</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span> </span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.21.3-alpine</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">443</span><span class="string">:443</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">amazoncorretto:11-alpine</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:8080</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&#x27;java -jar /etc/app.jar&#x27;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./demo-0.0.1-SNAPSHOT.jar:/etc/app.jar</span></span><br></pre></td></tr></table></figure><p>도커 컴포즈 명령어로 컨테이너 환경을 실행합니다.</p><figure class="highlight ps"><table><tr><td class="code"><pre><span class="line">docker compose up <span class="literal">-d</span></span><br><span class="line">[+] Running <span class="number">3</span>/<span class="number">3</span></span><br><span class="line"> - Network nginx_default    Created</span><br><span class="line"> - Container nginx_nginx_1  Started</span><br><span class="line"> - Container nginx_app_1    Started</span><br></pre></td></tr></table></figure><p>제 컴퓨터 <strong>호스트 파일에 127.0.0.1에 대하여 mambo.kr가 지정</strong>되어있으므로 다음과 같이 Nginx가 80포트에 대한 요청에 대해 기본 페이지를 응답하였습니다.</p><p><img data-src="/images/posts/reverse-proxy-using-nginx/nginx-02.png"></p><h3 id="기본-Nginx-설정"><a href="#기본-Nginx-설정" class="headerlink" title="기본 Nginx 설정"></a>기본 Nginx 설정</h3><p>도커 컴포즈 명령어로 컨테이너 진입 후 기본으로 적용되어있는 Nginx 설정을 확인해보도록 하겠습니다.</p><figure class="highlight ps"><table><tr><td class="code"><pre><span class="line">docker compose exec nginx sh</span><br><span class="line">/ <span class="comment"># cat /etc/nginx/nginx.conf</span></span><br></pre></td></tr></table></figure><p><img data-src="/images/posts/reverse-proxy-using-nginx/nginx-03.png"></p><p>80포트를 수신하는 웹 서버 설정은 <strong>/etc/nginx/conf.d/default.conf</strong>에 위치하고 있었습니다. 다음은 default.conf에 정의된 내용 중 일부입니다.</p><figure class="highlight ps"><table><tr><td class="code"><pre><span class="line">/etc/nginx/conf.d <span class="comment"># cat default.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       <span class="number">80</span>;</span><br><span class="line">    listen  [::]:<span class="number">80</span>;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#access_log  /var/log/nginx/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>server 블록을 통해 80포트를 수신(listen)하였고 루트 경로(/)에 대한 요청을 <strong>/usr/share/nginx/html에 위치한 index.html</strong>이라는 정적 파일을 응답하도록 정의되어있습니다. </p><h3 id="사용자-정의-Nginx-설정"><a href="#사용자-정의-Nginx-설정" class="headerlink" title="사용자 정의 Nginx 설정"></a>사용자 정의 Nginx 설정</h3><p>기본으로 적용되어있는 nginx.conf를 볼륨으로 지정하여 사용자 정의할 수 있도록 해보겠습니다. 도커 컴포즈 문서에 Nginx 서비스에 볼륨을 지정하여 로컬 파일로 저장되어있는 nginx.conf를 지정하겠습니다.</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span> </span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.21.3-alpine</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">443</span><span class="string">:443</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line">  <span class="comment">#app:</span></span><br><span class="line">  <span class="comment">#  ...</span></span><br></pre></td></tr></table></figure><p>호스트의 443포트를 Nginx 서비스에 바인딩하였으므로 443포트를 수신하도록 정의해보겠습니다.</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">        <span class="attribute">server_name</span> localhost <span class="number">127.0.0.1</span> mambo.kr;</span><br><span class="line">        <span class="attribute">ssl_certificate</span> /etc/nginx/server.crt;</span><br><span class="line">        <span class="attribute">ssl_certificate_key</span> /etc/nginx/server.key;</span><br><span class="line">        <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">        <span class="attribute">ssl_ciphers</span> HIGH:!aNULL:!MD5;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://app:8080;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>도커 컴포즈로 컨테이너 환경을 다시 실행하면 정상적으로…</p><figure class="highlight ps"><table><tr><td class="code"><pre><span class="line">nginx: [<span class="type">emerg</span>] no <span class="string">&quot;events&quot;</span> section <span class="keyword">in</span> configuration</span><br></pre></td></tr></table></figure><p>오류가 발생했네요. nginx.conf에 events 블록은 필수로 존재해야하는 듯 합니다.</p><h4 id="프로세스-및-처리-옵션"><a href="#프로세스-및-처리-옵션" class="headerlink" title="프로세스 및 처리 옵션"></a>프로세스 및 처리 옵션</h4><p>Nginx는 마스터 프로세스와 워커 프로세스로 구성되어 실제로 요청을 처리하는 것은 워커 프로세스가 담당합니다. 사용가능한 CPU 코어 수 만큼 워커 프로세스를 할당하는게 좋으며 워커 프로세스별로 사용할 수 있는 최대 열린 파일 개수 제한을 설정하는 것이 좋습니다.</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"><span class="attribute">worker_cpu_affinity</span> auto;</span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">65536</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">    <span class="attribute">multi_accept</span> <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img data-src="/images/posts/reverse-proxy-using-nginx/nginx-01.png" alt="Optimizations - Event Models"></p><p>운영체제별 <a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/optimizations/#event-models">효율적인 연결 처리 방식</a>이 있으며 리눅스 커널 2.6+에서는 <strong>epoll</strong>을 사용할 수 있습니다.</p><p>Nginx 서비스 컨테이너가 정상적으로 실행되지 않은 상태이므로 도커 컴포즈로 컨테이너 환경을 실행해야합니다.</p><figure class="highlight ps"><table><tr><td class="code"><pre><span class="line">docker compose up <span class="literal">-d</span></span><br><span class="line">[+] Running <span class="number">2</span>/<span class="number">2</span></span><br><span class="line"> - Container nginx_nginx_1  Started</span><br><span class="line"> - Container nginx_app_1    Running</span><br></pre></td></tr></table></figure><p>잘 실행된것으로 보이니 <a href="https://mambo.kr으로/">https://mambo.kr으로</a> 접속해보도록 하겠습니다.</p><p><img data-src="/images/posts/reverse-proxy-using-nginx/nginx-04.png"></p><p>443 포트로 요청된 트래픽이 Nginx를 경유하여 8080포트로 실행된 애플리케이션 서버로 전달되고 응답을 받았습니다. 바로 이것을 <strong>리버스 프록시</strong>라고 합니다.</p><h4 id="리버스-프록시-1"><a href="#리버스-프록시-1" class="headerlink" title="리버스 프록시"></a>리버스 프록시</h4><p>리버스 프록시를 구성하면 애플리케이션 서버는 어디서 요청했는지에 대한 정보를 알 수 없습니다. 그래서 Nginx와 같은 리버시 프록시를 구성하는 웹 서버에서는 프록시 관련 헤더를 함께 전달하여 어디서 요청되었는지를 전달할 수 있도록 설정할 수 있습니다.</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">        <span class="attribute">server_name</span> localhost <span class="number">127.0.0.1</span> mambo.kr;</span><br><span class="line">        <span class="attribute">ssl_certificate</span> /etc/nginx/server.crt;</span><br><span class="line">        <span class="attribute">ssl_certificate_key</span> /etc/nginx/server.key;</span><br><span class="line">        <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">        <span class="attribute">ssl_ciphers</span> HIGH:!aNULL:!MD5;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://app:8080;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host $host;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP $remote_addr;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="웹소켓-프록시"><a href="#웹소켓-프록시" class="headerlink" title="웹소켓 프록시"></a>웹소켓 프록시</h4><p>HTTP 1.1 프로토콜은 Hop-By-Hop이라고 하는 Upgrade 헤더를 사용하여 커넥션을 변경하는 매커니즘을 제공합니다. <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Protocol_upgrade_mechanism#upgrading_to_a_websocket_connection">Upgrading to a WebSocket connection</a>과 <a href="http://nginx.org/en/docs/http/websocket.html">WebSocket proxying</a> 문서를 참고하여 다음과 같이 웹소켓 프록시에 대한 설정을 구성할 수 있습니다.</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">location</span> /ws/ &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade $http_upgrade;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line">        <span class="attribute">proxy_read_timeout</span> <span class="number">65s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>프록시 서버는 기본적으로 60초 이내에 전달되는 데이터가 없는 경우 연결을 해지합니다. 예를 들어, 1분마다 웹소켓으로 전달되는 데이터가 있는 경우를 위해 proxy_read_timeout을 조정해야합니다.</p></blockquote><h4 id="이벤트-스트림-프록시"><a href="#이벤트-스트림-프록시" class="headerlink" title="이벤트 스트림 프록시"></a>이벤트 스트림 프록시</h4><p>리버스 프록시 구성에서 SSE(Server Sent Event)와 같은 이벤트 스트림을 사용하는 경우 버퍼링 옵션을 비활성화 해야합니다.</p><ul><li><a href="https://stackoverflow.com/questions/13672743/eventsource-server-sent-events-through-nginx">EventSource / Server-Sent Events through Nginx</a></li><li><a href="https://serverfault.com/questions/801628/for-server-sent-events-sse-what-nginx-proxy-configuration-is-appropriate">For Server-Sent Events (SSE) what Nginx proxy configuration is appropriate?</a></li></ul><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_buffering</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_cache</span> <span class="literal">off</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="HTTPS-리다이렉트"><a href="#HTTPS-리다이렉트" class="headerlink" title="HTTPS 리다이렉트"></a>HTTPS 리다이렉트</h4><p>일반 HTTP를 사용하여 80포트로 요청한 것을 HTTPS를 사용하도록 유도하기 위해서 HTTPS 리다이렉트 응답을 적용할 수 있습니다.</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> _;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://$host$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="정적-파일-배포"><a href="#정적-파일-배포" class="headerlink" title="정적 파일 배포"></a>정적 파일 배포</h4><p>추가적으로 정적 파일이 포함된 폴더를 볼륨으로 지정하여 Nginx에서 정적 파일을 응답할 수 있도록 설정하겠습니다.</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span> </span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.21.3-alpine</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">443</span><span class="string">:443</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./server.crt:/etc/nginx/server.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./server.key:/etc/nginx/server.key</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./static:/etc/nginx/static</span></span><br></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"><span class="attribute">worker_cpu_affinity</span> auto;</span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">65536</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">    <span class="attribute">multi_accept</span> <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> _;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://$host$request_uri;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">        <span class="attribute">server_name</span> localhost <span class="number">127.0.0.1</span> mambo.kr;</span><br><span class="line">        <span class="attribute">ssl_certificate</span> /etc/nginx/server.crt;</span><br><span class="line">        <span class="attribute">ssl_certificate_key</span> /etc/nginx/server.key;</span><br><span class="line">        <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">        <span class="attribute">ssl_ciphers</span> HIGH:!aNULL:!MD5;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://app:8080;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host $host;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP $remote_addr;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> /dist/ &#123;</span><br><span class="line">            <span class="attribute">alias</span> /etc/nginx/static/;</span><br><span class="line">            <span class="attribute">limit_except</span> GET &#123;</span><br><span class="line">                <span class="attribute">deny</span> all;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img data-src="/images/posts/reverse-proxy-using-nginx/nginx-05.png"></p><p>정적 파일까지 응답할 수 있도록 설정하였습니다.</p><h3 id="Nginx-설정-최적화"><a href="#Nginx-설정-최적화" class="headerlink" title="Nginx 설정 최적화"></a>Nginx 설정 최적화</h3><p>사용자 정의한 Nginx 설정만으로도 리버스 프록시 및 정적 파일을 배포하는데에는 문제가 없습니다. 그러나 Nginx에서는 더 효율적으로 동작할 수 있도록 다양한 옵션을 제공합니다. 여러가지 옵션들을 적용해보면서 최적화해보도록 합시다.</p><p>Nginx 설정 최적화에 대해서는 다음의 글을 참고하면 좋습니다.</p><ul><li><a href="https://github.com/denji/nginx-tuning/blob/master/README.md">NGINX Tuning For Best Performance</a>  </li><li><a href="https://couplewith.tistory.com/m/entry/%EA%BF%80%ED%8C%81-%EA%B3%A0%EC%84%B1%EB%8A%A5-Nginx%EB%A5%BC%EC%9C%84%ED%95%9C-%ED%8A%9C%EB%8B%9D-1-%EB%94%94%EC%8A%A4%ED%81%AC%EC%9D%98-IO-%EB%B3%91%EB%AA%A9-%EC%A4%84%EC%9D%B4%EA%B8%B0?category=212810">[꿀팁] 고성능 Nginx를위한 튜닝</a></li></ul><h4 id="TCP-옵션"><a href="#TCP-옵션" class="headerlink" title="TCP 옵션"></a>TCP 옵션</h4><p><a href="https://thoughts.t37.net/nginx-optimization-understanding-sendfile-tcp-nodelay-and-tcp-nopush-c55cdd276765">Nginx Optimization: understanding sendfile, tcp_nodelay and tcp_nopush</a>에서는 TCP 옵션을 지정하는 이유에 대해서 설명합니다. 네트워크 환경이 빠른 경우 TCP 스택에서 Nagle 알고리즘을 사용하는 것이 비효율적일 수 있다고 합니다.</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">sendfile</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nopush</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="압축-옵션"><a href="#압축-옵션" class="headerlink" title="압축 옵션"></a>압축 옵션</h4><p>웹 요청에 대한 응답 데이터를 압축하는 것은 네트워크 비용을 줄이고 빠르게 응답할 수 있는 좋은 방법입니다. 서버 성능에 따라 압축 레벨을 최대한으로 지정하는 것이 좋습니다. 또한, 작은 크기에 데이터에 대하여 압축을 시도하는 것도 비효율적입니다.</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">gzip_min_length</span> <span class="number">1k</span>;</span><br><span class="line">    <span class="attribute">gzip_comp_level</span> <span class="number">9</span>;</span><br><span class="line">    <span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">gzip_disable</span> msie6;</span><br><span class="line">    <span class="attribute">gzip_proxied</span> expired <span class="literal">no</span>-cache <span class="literal">no</span>-store private auth;</span><br><span class="line">    <span class="attribute">gzip_types</span></span><br><span class="line">        <span class="comment"># text/html is always compressed by HttpGzipModule</span></span><br><span class="line">        text/css</span><br><span class="line">        text/javascript</span><br><span class="line">        text/xml</span><br><span class="line">        text/plain</span><br><span class="line">        application/javascript</span><br><span class="line">        application/json</span><br><span class="line">        application/xml</span><br><span class="line">        font/truetype</span><br><span class="line">        font/opentype</span><br><span class="line">        application/vnd.ms-fontobject</span><br><span class="line">        image/svg+xml;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>일반적으로 텍스트 유형의 데이터를 압축하도록 지정합니다.</p><h4 id="로그-옵션"><a href="#로그-옵션" class="headerlink" title="로그 옵션"></a>로그 옵션</h4><p>모든 요청에 대해 액세스 로그를 저장하는 것은 비효율적으로 I/O를 발생시킬 수 있습니다.</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">error_log</span> /var/log/nginx/error.log <span class="literal">crit</span>;</span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">access_log</span> /var/log/nginx/access.log;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="보안-옵션"><a href="#보안-옵션" class="headerlink" title="보안 옵션"></a>보안 옵션</h4><p>많은 사람들이 server_tokens 옵션을 비활성화하여 응답 헤더에 Nginx 버전을 명시하지 않도록 권장합니다. 공격자는 Nginx의 특정 버전을 알 수 없으므로 더 많은 취약점에 대한 공격을 시도해야합니다.</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">server_tokens</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="클라이언트-옵션"><a href="#클라이언트-옵션" class="headerlink" title="클라이언트 옵션"></a>클라이언트 옵션</h4><p>연결 유지 클라이언트 수와 최대 유지 시간 그리고 클라이언트 요청 크기를 조정할 수 있습니다.</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span> <span class="number">65</span>;</span><br><span class="line">    <span class="attribute">keepalive_requests</span> <span class="number">10000</span>;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">100m</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="리눅스-커널-파라미터"><a href="#리눅스-커널-파라미터" class="headerlink" title="리눅스 커널 파라미터"></a>리눅스 커널 파라미터</h4><p>Nginx 옵션을 지정하더라도 실제로 허용할 수 있는지 리눅스 커널 파라미터를 검토해야할 수 있습니다. </p><ul><li><a href="https://ma.ttias.be/linux-increase-ip_local_port_range-tcp-port-range/">Linux increase ip_local_port_range TCP port range</a></li><li><a href="https://couplewith.tistory.com/entry/%EA%BF%80%ED%8C%81-%EA%B3%A0%EC%84%B1%EB%8A%A5-Nginx%EB%A5%BC%EC%9C%84%ED%95%9C-%ED%8A%9C%EB%8B%9D-3-TCP-%EA%B4%80%EB%A0%A8-%EC%B2%98%EB%A6%AC%EB%9F%89-%EB%8A%98%EB%A6%AC%EA%B8%B0-%EB%A6%AC%EB%88%85%EC%8A%A4%EC%BB%A4%EB%84%90%ED%8A%9C%EB%8B%9D">TCP 관련 처리량 늘리기 - 리눅스 커널 튜닝</a></li></ul><h3 id="Nginx-설정-마무리"><a href="#Nginx-설정-마무리" class="headerlink" title="Nginx 설정 마무리"></a>Nginx 설정 마무리</h3><p>알아본 내용을 조합하면 다음과 같이 Nginx 설정을 정의할 수 있게 됩니다.</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">user</span> nginx;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 프로세스 옵션</span></span><br><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"><span class="attribute">worker_cpu_affinity</span> auto;</span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">65536</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">    <span class="attribute">multi_accept</span> <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">pid</span> /var/run/nginx.pid;</span><br><span class="line"><span class="attribute">error_log</span> /var/log/nginx/error.log <span class="literal">crit</span>;</span><br><span class="line"><span class="comment">#thread_pool backend threads=32 max_queue=65536;</span></span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/mime.types;</span><br><span class="line">    <span class="attribute">default_type</span> application/octet-stream;</span><br><span class="line">    <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">10m</span>;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">upstream</span> backend &#123;</span><br><span class="line">        <span class="attribute">server</span> app:<span class="number">8080</span>;</span><br><span class="line">        <span class="attribute">keepalive</span> <span class="number">128</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># HTTPS 리다이렉트</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span> _;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://$host$request_uri;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># HTTPS 및 HTTP2 지원</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">        <span class="attribute">server_name</span> localhost <span class="number">127.0.0.1</span> mambo.kr;</span><br><span class="line">        <span class="attribute">ssl_certificate</span> /etc/nginx/server.crt;</span><br><span class="line">        <span class="attribute">ssl_certificate_key</span> /etc/nginx/server.key;</span><br><span class="line">        <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">        <span class="attribute">ssl_ciphers</span> HIGH:!aNULL:!MD5;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 리버스 프록시</span></span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">            <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">            <span class="attribute">proxy_buffering</span> <span class="literal">off</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host $host;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP $remote_addr;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">            <span class="comment">#aio threads=backend;</span></span><br><span class="line">            <span class="attribute">access_log</span> /var/log/nginx/access.log;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 리버스 웹소켓 프록시</span></span><br><span class="line">        <span class="attribute">location</span> /ws/ &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host $host;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP $remote_addr;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            <span class="comment"># hop-by-hop</span></span><br><span class="line">            <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Upgrade $http_upgrade;</span><br><span class="line">            <span class="attribute">proxy_read_timeout</span> <span class="number">65s</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> /dist/ &#123;</span><br><span class="line">            <span class="attribute">alias</span> /etc/nginx/static/;</span><br><span class="line">            <span class="attribute">limit_except</span> GET &#123;</span><br><span class="line">                <span class="attribute">deny</span> all;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Optimization</span></span><br><span class="line">    <span class="attribute">server_tokens</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive_timeout</span> <span class="number">65s</span>;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">100m</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># TCP 옵션</span></span><br><span class="line">    <span class="attribute">sendfile</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nopush</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Gzip 압축 옵션</span></span><br><span class="line">    <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">gzip_min_length</span> <span class="number">10k</span>;</span><br><span class="line">    <span class="attribute">gzip_comp_level</span> <span class="number">9</span>;</span><br><span class="line">    <span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">gzip_disable</span> msie6;</span><br><span class="line">    <span class="attribute">gzip_proxied</span> expired <span class="literal">no</span>-cache <span class="literal">no</span>-store private auth;</span><br><span class="line">    <span class="attribute">gzip_types</span></span><br><span class="line">        <span class="comment"># text/html is always compressed</span></span><br><span class="line">        text/css</span><br><span class="line">        text/javascript</span><br><span class="line">        text/xml</span><br><span class="line">        text/plain</span><br><span class="line">        application/javascript</span><br><span class="line">        application/json</span><br><span class="line">        application/xml</span><br><span class="line">        font/truetype</span><br><span class="line">        font/opentype</span><br><span class="line">        application/vnd.ms-fontobject</span><br><span class="line">        image/svg+xml;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 파일 리스트 비활성화</span></span><br><span class="line">    <span class="attribute">autoindex</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>도커 컴포즈를 사용하여 실행되어있는 Nginx 프로세스에 변경된 설정을 반영하면서 마치도록 하겠습니다.</p><figure class="highlight ps"><table><tr><td class="code"><pre><span class="line">docker compose exec nginx nginx <span class="literal">-t</span></span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line"></span><br><span class="line">docker compose exec nginx nginx <span class="literal">-s</span> reload</span><br><span class="line"><span class="number">2021</span>/<span class="number">09</span>/<span class="number">25</span> <span class="number">09</span>:<span class="number">38</span>:<span class="number">03</span> [<span class="type">notice</span>] <span class="number">34</span><span class="comment">#34: signal process started</span></span><br></pre></td></tr></table></figure><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&quot;https://digital.com/wp-content/uploads/what-is-nginx.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;오늘은 웹 서비스 인프라에서 리버스 프록시 구성을 위해 사</summary>
      
    
    
    
    
    <category term="Nginx" scheme="https://kdevkr.github.io/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>갑자기 애플리케이션 배포에 실패한 이유</title>
    <link href="https://kdevkr.github.io/why-fail-deploy-application/"/>
    <id>https://kdevkr.github.io/why-fail-deploy-application/</id>
    <published>2021-09-24T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.035Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 얼마전까지만 해도 잘 동작하던 배포 프로세스가 갑자기 실패하는 이유에 대해서 이야기 해보려고 합니다.</p><h2 id="빌드-및-배포-환경"><a href="#빌드-및-배포-환경" class="headerlink" title="빌드 및 배포 환경"></a>빌드 및 배포 환경</h2><p>회사에서 운영중인 서비스는 Elastic Beanstalk 환경의 자바 SE 플랫폼으로 스프링 부트 애플리케이션을 배포하고 있습니다. 자바 SE 플랫폼에서는 <strong>애플리케이션을 실행가능한 WAR 파일로 패키징하여 Procfile을 통해 실행</strong>할 수 있도록 구성할 수 있습니다. 예를 들어, 다음과 같이 실행가능하도록 패키징된 애플리케이션 파일을 실행하도록 Procfile을 만들고 Beanstalk 환경을 확장하기 위한 설정 파일들을 하나의 애플리케이션 소스 번들로 만들 수 있습니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">task procfile(<span class="attr">dependsOn:</span> bootJar) &#123;</span><br><span class="line">    doFirst &#123;</span><br><span class="line">        project.file(<span class="string">&quot;build/libs/Procfile&quot;</span>).text = <span class="string">&quot;web: java -Xmx3g -Dfile.encoding=UTF-8 -jar $&#123;bootJar.archiveFileName&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">task awsbuild(<span class="attr">type:</span> Zip, <span class="attr">dependsOn:</span> procfile) &#123;</span><br><span class="line">    println(<span class="string">&#x27;Build Version: &#x27;</span> + rootProject.version)</span><br><span class="line"></span><br><span class="line">    from (<span class="string">&#x27;beanstalk/.ebextensions&#x27;</span>) &#123; into <span class="string">&#x27;.ebextensions&#x27;</span> &#125;</span><br><span class="line">    from (<span class="string">&#x27;beanstalk/.platform&#x27;</span>) &#123;into <span class="string">&#x27;.platform&#x27;</span> &#125;</span><br><span class="line">    from (<span class="string">&#x27;build/libs&#x27;</span>) &#123;</span><br><span class="line">        include <span class="string">&#x27;Procfile&#x27;</span></span><br><span class="line">        include <span class="string">&quot;$&#123;bootJar.archiveFileName&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    archiveBaseName.set(<span class="string">&#x27;beanstalk&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="실패한-이유-1"><a href="#실패한-이유-1" class="headerlink" title="실패한 이유 1"></a>실패한 이유 1</h3><p>그런데 오늘 갑자기 정상적으로 수행되던 배포 프로세스 과정에서 다음과 같이 오류가 발생하여 애플리케이션 배포가 실패하였습니다.</p><p><img data-src="/images/posts/why-fail-deploy-application/reason-01.png"></p><p>위 오류가 발생하였을 때 태스크는 다음과 같이 작성되어있었습니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">task awsbuild(<span class="attr">type:</span> Zip, <span class="attr">dependsOn:</span> procfile) &#123;</span><br><span class="line">    from (<span class="string">&#x27;beanstalk/.ebextensions&#x27;</span>) &#123; into <span class="string">&#x27;.ebextensions&#x27;</span> &#125;</span><br><span class="line">    from (<span class="string">&#x27;beanstalk/.platform&#x27;</span>) &#123;into <span class="string">&#x27;.platform&#x27;</span> &#125;</span><br><span class="line">    from (<span class="string">&#x27;build/libs&#x27;</span>) &#123;</span><br><span class="line">        include(<span class="string">&#x27;Procfile&#x27;</span>)</span><br><span class="line">        include(bootJar.archiveName)</span><br><span class="line">    &#125;</span><br><span class="line">    baseName = <span class="string">&#x27;beanstalk&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>그런데 최종적으로 만들어지는 애플리케이션 소스 번들을 확인해보니 <strong>bootJar.archiveName</strong>으로 포함시킨 애플리케이션 패키징 파일이 존재하지 않았습니다. 갑자기 왜 포함되지 않는 것 일까요? 이것저것 확인해보던 중 해결방법은 아주 간단하였는데요. 바로 다음과 같이 include 코드를 수정하는 것이었습니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">task awsbuild(<span class="attr">type:</span> Zip, <span class="attr">dependsOn:</span> procfile) &#123;</span><br><span class="line">    from (<span class="string">&#x27;beanstalk/.ebextensions&#x27;</span>) &#123; into <span class="string">&#x27;.ebextensions&#x27;</span> &#125;</span><br><span class="line">    from (<span class="string">&#x27;beanstalk/.platform&#x27;</span>) &#123;into <span class="string">&#x27;.platform&#x27;</span> &#125;</span><br><span class="line">    from (<span class="string">&#x27;build/libs&#x27;</span>) &#123;</span><br><span class="line">        include <span class="string">&#x27;Procfile&#x27;</span></span><br><span class="line">        include <span class="string">&quot;$&#123;bootJar.archiveName&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    baseName = <span class="string">&#x27;beanstalk&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>아무리봐도 무슨 차이인지는 모르겠으나 간단히 해결되었습니다. 한가지 의심이 되는 부분은 Gradle Warpper 버전이 <strong>gradle-7.1-all</strong>로 변경되었다는 것 입니다. </p><h3 id="실패한-이유-2"><a href="#실패한-이유-2" class="headerlink" title="실패한 이유 2"></a>실패한 이유 2</h3><p>간신히 패키징된 애플리케이션 파일을 애플리케이션 소스 번들에 포함하여 다시 배포 프로세스를 수행했지만 다시 다음과 같은 오류가 발생하면서 배포가 실패했습니다.</p><p><img data-src="/images/posts/why-fail-deploy-application/reason-02.png"></p><p>애플리케이션 소스 번들은 비어있거나 524288000 바이트를 넘을 수 없다는 오류입니다. 실제로 Elastic Beanstalk 문서에는 다음과 같이 애플리케이션 소스 번들은 최대 512MB로 제한된다는 내용이 있습니다.</p><p><img data-src="/images/posts/why-fail-deploy-application/reason-03.png"></p><p>만들어진 애플리케이션 소스 번들이 비어있을 이유가 없었기에 용량을 확인해보니 560MB를 넘고 있었습니다. 애플리케이션 소스 번들의 파일이 이렇게 클 이유가 없었는데 의아했습니다. 패키징된 애플리케이션 파일 자체 용량이 520MB를 넘고 있음을 확인하고 패키징된 애플리케이션 파일을 풀어서 내용을 살펴보니 다음과 같이 라이브러리가 포함된 폴더의 용량이 상당한 것을 확인했습니다.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">total 964904</span><br><span class="line">-rw-r--r--  1 user  staff    14M Sep 24 11:31 ec2-2.17.29.jar</span><br><span class="line">-rw-r--r--  1 user  staff    11M Aug  9 12:29 elasticsearch-7.3.2.jar</span><br><span class="line">-rw-r--r--  1 user  staff   7.8M Aug  9 12:30 poi-ooxml-lite-5.0.0.jar</span><br><span class="line">-rw-r--r--  1 user  staff   7.2M Sep 24 11:31 sagemaker-2.17.29.jar</span><br><span class="line">-rw-r--r--  1 user  staff   5.7M Aug  9 12:30 bcprov-jdk15on-1.68.jar</span><br><span class="line">-rw-r--r--  1 user  staff   5.3M Sep 24 11:31 iot-2.17.29.jar</span><br><span class="line">-rw-r--r--  1 user  staff   5.1M Aug  9 12:30 org.eclipse.persistence.core-2.7.4.jar</span><br><span class="line">-rw-r--r--  1 user  staff   4.7M Sep 24 11:31 ssm-2.17.29.jar</span><br><span class="line">-rw-r--r--  1 user  staff   4.3M Aug  9 12:30 groovy-2.4.8.jar</span><br><span class="line">-rw-r--r--  1 user  staff   4.2M Sep 24 11:31 glue-2.17.29.jar</span><br><span class="line">-rw-r--r--  1 user  staff   4.2M Sep 24 11:31 rds-2.17.29.jar</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>패키징에 포함된 라이브러리와 연관된 파일이 모두 <strong>964904개</strong>로 출력되었습니다. 어떤 의존성 때문에 이렇게 많은 라이브러리 파일들이 포함되었을까요? 의심되는 부분은 <strong>sagemaker-2.17.29.jar와 같이 실제로는 사용하지 않는 라이브러리</strong> 였습니다. <strong>gradle dependencies</strong> 명령어를 수행하면 의존성 목록을 확인할 수 있다는 팀장님의 말씀을 듣고 검토해보니 다음과 같이 아마존 SDK에 대한 의존성이었습니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation <span class="string">&#x27;software.amazon.awssdk:aws-sdk-java:2.17.45&#x27;</span></span><br><span class="line">    implementation <span class="string">&#x27;com.amazonaws:aws-java-sdk:1.12.73&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>com.amazonaws:aws-java-sdk 기존에 가지고 있던 <strong>아마존 SDK v1에 대한 의존성</strong>으로 확인되었고 software.amazon.awssdk:aws-sdk-java는 신규 기능 및 전환을 위해 새롭게 개발하고 테스트 중인 <strong>아마존 SDK v2에 대한 의존성</strong>입니다. </p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dependencyManagement &#123;</span><br><span class="line">    imports &#123;</span><br><span class="line">        mavenBom <span class="string">&#x27;com.amazonaws:aws-java-sdk-bom:1.12.73&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line"><span class="comment">//    implementation &#x27;com.amazonaws:aws-java-sdk:1.12.73&#x27;</span></span><br><span class="line">    implementation <span class="string">&#x27;com.amazonaws:aws-java-sdk-s3&#x27;</span></span><br><span class="line">    implementation <span class="string">&#x27;com.amazonaws:aws-java-sdk-sqs&#x27;</span></span><br><span class="line">    implementation <span class="string">&#x27;com.amazonaws:aws-java-sdk-cognitoidentity&#x27;</span></span><br><span class="line">    implementation <span class="string">&#x27;com.amazonaws:aws-java-sdk-lambda&#x27;</span></span><br><span class="line">    implementation <span class="string">&#x27;com.amazonaws:aws-java-sdk-autoscaling&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>개인적으로 공부할 때는 아마존 SDK 전체를 의존성으로 추가하지 않았기에 아마존 SDK 전체를 추가하는 경우와 실제로 사용하는 라이브러리만 추가한 경우를 비교해보니 다음과 같이 요약되었습니다.</p><table><thead><tr><th>의존성</th><th>용량</th></tr></thead><tbody><tr><td>아마존 SDK v1 전체</td><td>214MB</td></tr><tr><td>아마존 SDK v1 개별</td><td>15.8MB</td></tr><tr><td>아마존 SDK v2 전체</td><td>268MB</td></tr><tr><td>아마존 SDK v2 개별</td><td>25.1MB</td></tr><tr><td>아마존 SDK v1 + v2 전체</td><td>471MB</td></tr><tr><td>아마존 SDK v1 + v2 개별</td><td>32.4MB</td></tr></tbody></table><p>위 상황처럼 아마존 SDK v1과 v2 모두를 의존성에 추가하는 경우 무려 <strong>471MB</strong>라는 어마어마한 용량을 가지게 되는 것을 확인할 수 있었습니다. 사용하지도 않는 라이브러리를 포함하여 쓸데없이 애플리케이션만 무거워졌던 것이죠. </p><p><img data-src="/images/posts/why-fail-deploy-application/reason-04.png"></p><p>패키징된 애플리케이션 파일 용량이 줄어들어 정상적으로 배포 프로세스가 수행되었습니다. 그리고 이러한 사항에 대해 개발팀에 아마존 SDK 추가 시 사용하려는 라이브러리를 추가하는 것이 좋다고 전달하였습니다. 이 글을 보시는 분들도 아마존 SDK 전체를 추가한 상태라면 실제로 사용하는 라이브러리를 개별적으로 추가하시기 바랍니다.</p><h3 id="그래들-태스크-개선"><a href="#그래들-태스크-개선" class="headerlink" title="그래들 태스크 개선"></a>그래들 태스크 개선</h3><p>Deprecated된 속성 또는 함수를 사용하는 것을 추가적으로 개선해 보았습니다.</p><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">task procfile(<span class="attr">dependsOn:</span> bootJar) &#123;</span><br><span class="line">    doFirst &#123;</span><br><span class="line">        project.file(<span class="string">&quot;build/libs/Procfile&quot;</span>).text = <span class="string">&quot;web: java -Xmx3g -Dfile.encoding=UTF-8 -jar $&#123;bootJar.archiveFileName&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task awsbuild(<span class="attr">type:</span> Zip, <span class="attr">dependsOn:</span> procfile) &#123;</span><br><span class="line">    from (<span class="string">&#x27;beanstalk/.ebextensions&#x27;</span>) &#123; into <span class="string">&#x27;.ebextensions&#x27;</span> &#125;</span><br><span class="line">    from (<span class="string">&#x27;beanstalk/.platform&#x27;</span>) &#123;into <span class="string">&#x27;.platform&#x27;</span> &#125;</span><br><span class="line">    from (<span class="string">&#x27;build/libs&#x27;</span>) &#123;</span><br><span class="line">        include <span class="string">&#x27;Procfile&#x27;</span></span><br><span class="line">        include <span class="string">&quot;$&#123;bootJar.archiveFileName&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    archiveBaseName.set(<span class="string">&#x27;beanstalk&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 얼마전까지만 해도 잘 동작하던 배포 프로세스가 갑자기 실패하는 이유에 대해서 이야기 해보려고 합니다.&lt;/p&gt;
&lt;h2 id=&quot;빌드-및-배포-환경&quot;&gt;&lt;a href=&quot;#빌드-및-배포-환경&quot; class=</summary>
      
    
    
    
    
    <category term="Spring Boot" scheme="https://kdevkr.github.io/tags/Spring-Boot/"/>
    
    <category term="Beanstalk" scheme="https://kdevkr.github.io/tags/Beanstalk/"/>
    
    <category term="Gradle" scheme="https://kdevkr.github.io/tags/Gradle/"/>
    
  </entry>
  
  <entry>
    <title>ED25519</title>
    <link href="https://kdevkr.github.io/ed25519/"/>
    <id>https://kdevkr.github.io/ed25519/</id>
    <published>2021-09-17T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.031Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 보안 관련 기술인 타원곡선 암호 알고리즘을 기반으로 하는 <strong>ED25519</strong>라는 것에 대해 알아보려고 합니다. </p><p>아마존 웹 서비스에서는 2021년 8월 17일부터 EC2 인스턴스 접근을 위해 <a href="https://aws.amazon.com/about-aws/whats-new/2021/08/amazon-ec2-customers-ed25519-keys-authentication/">ED25519 형식의 키로 SSH 연결을 수행할 수 있도록 지원</a>하였으며 2021년 9월 1일에는 깃허브에서도 DSA 형식의 키를 제거하고 <a href="https://github.blog/2021-09-01-improving-git-protocol-security-github/">ECDSA와 ED25519 형식의 키를 추가</a>하기로 결정하였습니다. </p><p>공통으로 언급되고 있는 ED25519라는 것을 모르시는 분이라면 저와 함께 알아보도록 합시다. </p><p><img data-src="/images/posts/ed25519/ed25519-00.gif"></p><h2 id="ED25519"><a href="#ED25519" class="headerlink" title="ED25519"></a>ED25519</h2><p>ED25519(Ed25519)는 ECC(Elliptic Curve Cryptography) 알고리즘으로 수행하도록 구현된 전자서명입니다. 타원곡선 암호 알고리즘을 사용하는 공개키 암호화 방식은 <strong>기존의 RSA와 비교해서 동일한 안정성을 가지면서도 상대적으로 더 적은 길이의 키</strong>를 가진다고 합니다. 컴퓨터 연산 속도가 발전함에 따라 일반적으로 사용되는 RSA의 권장되는 키 길이가 길어짐으로 인하여 일반 컴퓨터 또는 디바이스에서는 연산 속도가 느려지는 단점을 가지게 되고 상대적으로 작은 키 길이를 사용할 수 있으면서 동일한 안정성을 보여주므로 권장되는 공개키 암호화 방식이라고 할 수 있습니다.</p><blockquote><p>RSA와 비교해서 보안적으로 우수하다고 볼 순 없지만 상대적으로 비교하여 효율적이라는 것을 이해하셔야합니다.</p></blockquote><h3 id="타원-곡선"><a href="#타원-곡선" class="headerlink" title="타원 곡선"></a>타원 곡선</h3><p>ED25519는 어떤 타원 곡선을 사용하여 구현된 전자서명일지 궁금해집니다. 다음은 암호화에 적합하다고 판단되어 표준으로 정의된 타원 곡선들입니다.</p><ul><li>secp256k1</li><li>secp256r1</li><li>prime256v1</li><li>Curve25519</li></ul><p>미국 국립표준연구소(NIST) 또는 <a href="https://www.secg.org/">표준 암호화 그룹(SECG)</a>에서는 효율적인 타원 곡선들에 이름을 부여했습니다. 예를 들어, ECC NIST P-256은 SECG에서 정의한 secp256r1과 prime256v1를 지칭한 것과 같습니다. </p><p>표준으로 정의된 다양한 타원 곡선들에 대한 자세한 내용은 다음의 두 문서를 통해 확인할 수 있습니다.</p><ul><li><a href="https://www.secg.org/sec2-v2.pdf">SEC 2: Recommended Elliptic Curve Domain Parameters</a></li><li><a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.186-4.pdf">Digital Signature Standard (DSS)</a></li></ul><p>저로서는 이해하기 힘든 부분이라고 생각하여 설명은 생략하며 간단하게 말해서 여러가지 타원 곡선 형태를 <strong>도메인 파라미터로 정의</strong>하여 이름을 부여한 것 입니다. NIST P-256은 NIST에서 정의한 소수 기반의 타원 곡선 방정식을 말하며 <a href="https://en.bitcoin.it/wiki/Secp256k1">secp256k1</a>는 SECG에서 정의한 Koblitz curve 기반의 타원 곡선 방정식을 말합니다. </p><blockquote><p>비트코인과 이더리움에서도 secp256k1 라는 타원곡선을 사용한다고…</p></blockquote><h3 id="키-교환과-전자-서명"><a href="#키-교환과-전자-서명" class="headerlink" title="키 교환과 전자 서명"></a>키 교환과 전자 서명</h3><p>타원 곡선을 사용하여 디피-헬먼 키 교환을 구현한 알고리즘을 ECDH라고 하며 타원 곡선 암호를 사용해서 <a href="https://ko.wikipedia.org/wiki/%EB%94%94%EC%A7%80%ED%84%B8_%EC%84%9C%EB%AA%85_%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98">전자서명 알고리즘(DSA)</a>를 구현한 것을 <strong>ECDSA</strong>라고 합니다. ECDSA는 지난 <a href="../ssl-certificate">SSL 인증서</a> 글에서 TLS 핸드쉐이크 과정에서 ECDHE_ECDSA와 같은 타원 곡선 암호 방식을 사용하는 것을 통해 이미 확인한 개념인데 기억하시는 분이 계실지 모르겠습니다.</p><p>타원 곡선 기반의 전자 서명 알고리즘에는 <a href="https://en.wikipedia.org/wiki/EdDSA">EdDSA</a>도 있으며 <strong>Twisted Edwards curve</strong>와 <strong>Schnorr 서명 방식</strong>을 사용하도록 구현된 DSA 입니다.</p><h3 id="X25519-그리고-Ed25519"><a href="#X25519-그리고-Ed25519" class="headerlink" title="X25519 그리고 Ed25519"></a>X25519 그리고 Ed25519</h3><p>앞서 언급된 타원 곡선 중 Curve25519는 키 교환 알고리즘인 디피-헬먼과 같이 사용하도록 고안된 타원 곡선입니다. Curve25519를 기반으로하여 ECDH로 키 교환을 수행하는 것을 X25519라고 하게 됩니다. 그리고 Curve25519과 함께 SHA-512와 같은 <strong>해시 함수</strong>를 사용하는 구현된 EdDSA를 <strong>Ed25519</strong>라는 이름으로 부르게 됩니다. </p><ul><li>ECDSA : 타원 곡선 기반의 전자 서명 알고리즘</li><li>X25519 : Curve25519를 사용하는 타원 곡선 키 교환 알고리즘</li><li>Ed25519 : Curve25519를 사용하는 타원 곡선 전자 서명 알고리즘 </li></ul><p><img data-src="/images/posts/ed25519/ed25519-04.gif" alt="머리속에 정리가 잘 되셨나요?"></p><h3 id="ED25519-키-페어"><a href="#ED25519-키-페어" class="headerlink" title="ED25519 키 페어"></a>ED25519 키 페어</h3><p>지금부터는 ED25519 형식의 키 페어를 만들고 EC2 인스턴스에 접근해보는 것을 따라해보겠습니다. </p><h4 id="키-페어-생성하기"><a href="#키-페어-생성하기" class="headerlink" title="키 페어 생성하기"></a>키 페어 생성하기</h4><p>먼저, ED25519 형식의 키 페어는 OpenSSH를 통해 만들 수도 있고 아마존 웹 서비스를 통해 ED25519 형식의 키 페어를 생성할 수 있습니다. </p><p><img data-src="/images/posts/ed25519/ed25519-01.png"></p><blockquote><p>2021년 8월 17일 부터는 콘솔을 통해 ED25119 키 페어를 사용하여 EC2 인스턴스 연결이 가능하다고 했는데 우측 제약사항에는 아직 업데이트되지 않은 듯 합니다.</p></blockquote><p>아래와 같이 AWS CLI의 create-key-pair 명령어를 통해서도 ED25519 키 페어를 생성할 수 있습니다.</p><figure class="highlight ps"><table><tr><td class="code"><pre><span class="line">aws ec2 create<span class="literal">-key</span><span class="literal">-pair</span> -<span class="literal">-key</span><span class="literal">-name</span> mambo -<span class="literal">-key</span><span class="literal">-type</span> ed25519 -<span class="literal">-query</span> <span class="string">&quot;KeyMaterial&quot;</span> -<span class="literal">-output</span> text &gt; aws<span class="literal">-mambo</span>.pem</span><br><span class="line">aws ec2 describe<span class="literal">-key</span><span class="literal">-pairs</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;KeyPairs&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;KeyPairId&quot;</span>: <span class="string">&quot;###&quot;</span>,</span><br><span class="line">            <span class="string">&quot;KeyFingerprint&quot;</span>: <span class="string">&quot;###&quot;</span>,</span><br><span class="line">            <span class="string">&quot;KeyName&quot;</span>: <span class="string">&quot;mambo&quot;</span>,</span><br><span class="line">            <span class="string">&quot;KeyType&quot;</span>: <span class="string">&quot;ed25519&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Tags&quot;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>아마존 웹 서비스에 키 페어가 생성되었으면 VPC에 EC2 인스턴스를 시작할 때 SSH 접속 시 사용될 ED25519 키 페어를 선택할 수 있습니다. </p><p><img data-src="/images/posts/ed25519/ed25519-02.png"></p><p>EC2 인스턴스가 실행되었으면 아마존 웹 서비스 콘솔의 EC2 인스턴스 연결 기능을 통해 인스턴스에 접속해보겠습니다.</p><p><img data-src="/images/posts/ed25519/ed25519-03.png"></p><p>ED25519 키 페어를 사용해서 EC2 인스턴스 연결에 성공하였습니다. 그런데 말이죠, 아마존 웹 서비스에서 생성된 ED25519 키 페어를 윈도우 10에서 지원하는 SSH 클라이언트에서 사용해보면 잘못된 형식이라고 로그가 출력되고 EC2 인스턴스에 연결할 수 없음을 확인했습니다.</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh -i &quot;aws-mambo.pem&quot; ec2-user@ec2-3-36-96-111.ap-northeast-2.compute.amazonaws.com</span><br><span class="line"></span><br><span class="line">The authenticity of host &#x27;ec2-3-36-96-111.ap-northeast-2.compute.amazonaws.com (3.36.96.111)&#x27; can&#x27;t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:gvSJ/qfnIlB8bkTE78QY65HO4px3YpoYvsyAv90LsTE.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &#x27;ec2-3-36-96-111.ap-northeast-2.compute.amazonaws.com,3.36.96.111&#x27; (ECDSA) to the list of known hosts.</span><br><span class="line">Load key &quot;aws-mambo.pem&quot;: invalid format</span><br><span class="line">ec2-user@ec2-3-36-96-111.ap-northeast-2.compute.amazonaws.com: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).</span><br></pre></td></tr></table></figure><p>아마존 웹 서비스가 만들어주는 ED25519 형식의 키 페어를 사용하지 않고 직접 윈도우 10에서 ssh-keygen을 통해 ED25519 형식의 키 페어를 생성하고 아마존 웹 서비스에 퍼블릭 키를 추가하면 정상적으로 EC2 인스턴스 연결할 수 있습니다. </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t ed25519 -m PEM -f ./mambo.pem</span><br></pre></td></tr></table></figure><p>이처럼 아마존 웹 서비스에서 만들어주는 ED25519 형식의 키 페어는 윈도우에서 사용할 수 없기 때문에 주의해야할 것 같습니다.</p><p>타원곡선 암호에 대해서 더 자세히 알고 싶다면 다음의 글들을 참고해보시기를 추천드립니다.</p><ul><li><a href="https://medium.com/humanscape-tech/blockchain-elliptic-curve-cryptography-ecc-49e6d7d9a50a">[Blockchain] Elliptic Curve Cryptography(ECC)</a></li><li><a href="https://naleejang.tistory.com/218">보안 그리고 암호화 알고리즘</a></li></ul><p>감사합니다.</p><h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul><li><a href="https://datatracker.ietf.org/doc/html/rfc4492">Elliptic Curve Cryptography (ECC) Cipher Suites for Transport Layer Security (TLS)</a></li><li><a href="https://datatracker.ietf.org/doc/html/rfc7748">Elliptic Curves for Security</a></li><li><a href="https://datatracker.ietf.org/doc/html/rfc8032">Edwards-Curve Digital Signature Algorithm (EdDSA)</a></li><li><a href="https://ed25519.cr.yp.to/">Ed25519: high-speed high-security signatures</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 보안 관련 기술인 타원곡선 암호 알고리즘을 기반으로 하는 &lt;strong&gt;ED25519&lt;/strong&gt;라는 것에 대해 알아보려고 합니다. &lt;/p&gt;
&lt;p&gt;아마존 웹 서비스에서는 2021년 8월 17일</summary>
      
    
    
    
    
    <category term="ECC" scheme="https://kdevkr.github.io/tags/ECC/"/>
    
    <category term="Ed25519" scheme="https://kdevkr.github.io/tags/Ed25519/"/>
    
  </entry>
  
  <entry>
    <title>파이썬 도커 이미지 최적화</title>
    <link href="https://kdevkr.github.io/python-docker-image-optimization/"/>
    <id>https://kdevkr.github.io/python-docker-image-optimization/</id>
    <published>2021-09-09T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.031Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 파이썬 도커 이미지에 대한 최적화에 대해서 알아봅니다. 회사에서 운영중인 서비스의 분석 서버는 파이썬으로 작성된 플래스크 기반의 웹 애플리케이션입니다. 여러가지 방식으로 배포하던 애플리케이션을 Elastic Beanstalk 환경을 통해 배포하는 구조로 통합하기 위해서 파이썬 애플리케이션을 Elastic Beanstalk의 도커 플랫폼으로 전환하기 위한 작업을 진행했습니다. 파이썬 플랫폼이 아닌 도커 플랫폼을 활용하는 이유는 도커 이미지로 구동하는 쿠버네티스 환경을 준비하고 있기 때문으로 동일하게 도커 이미지를 사용하여 애플리케이션을 배포하고자 결정하였습니다.</p><h2 id="파이썬-도커-이미지"><a href="#파이썬-도커-이미지" class="headerlink" title="파이썬 도커 이미지"></a>파이썬 도커 이미지</h2><p>파이썬으로 작성된 애플리케이션을 도커 이미지화하는 과정에서 발견한 문제에 대하여 몇가지 개선 작업을 진행한 것을 공유하고자 합니다. </p><h3 id="로컬-환경의-Dockerfile"><a href="#로컬-환경의-Dockerfile" class="headerlink" title="로컬 환경의 Dockerfile"></a>로컬 환경의 Dockerfile</h3><p>먼저, 로컬 환경에서 애플리케이션을 구동해보기 위해서 간단하게 작성하여 사용중이던 Dockerfile을 다시 만들어야 했습니다.</p><figure class="highlight docker"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.7</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> ./src /www</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /www</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span></span><br><span class="line"><span class="keyword">ENV</span> <span class="keyword">ENV</span> <span class="string">&quot;dev&quot;</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> python3 -m venv .venv</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod +x ./.venv/bin/activate</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ./.venv/bin/activate</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> python3 -m pip install --upgrade pip</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install -r requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install Flask</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> gunicorn main:app -b 0.0.0.0:5000 -w 1 -t=50 -k gevent --preload</span></span><br></pre></td></tr></table></figure><p>Dockerfile이 정리되어있지 않고 불필요한 명령어를 수행하는 것도 있지만 제일 크다고 생각한 문제점은 <a href="https://gunicorn.org/">Gunicorn WSGI 서버</a>에 대해 다양한 옵션을 적용하기 힘들다는 점이었습니다. 웹 요청을 애플리케이션 마스터 프로세스에 전달하는 워커 프로세스의 개수를 지정하는 옵션 만큼은 이미지를 빌드하는 시점 이후에도 쉽게 변경할 수 있게 적용하는게 좋을 것 같았습니다.</p><figure class="highlight docker"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /app/logs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> PORT=<span class="number">8000</span></span><br><span class="line"><span class="keyword">ARG</span> MAIN=application</span><br><span class="line"><span class="keyword">ARG</span> MAIN_APP=application</span><br><span class="line"><span class="keyword">ARG</span> WORKERS=application</span><br><span class="line"><span class="keyword">ARG</span> WORKERS=<span class="number">2</span></span><br><span class="line"><span class="keyword">ARG</span> WORKERCLASS=gevent</span><br><span class="line"><span class="keyword">ARG</span> TIMEOUT=<span class="number">60</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> PORT $&#123;PORT&#125;</span><br><span class="line"><span class="keyword">ENV</span> MAIN $&#123;MAIN&#125;</span><br><span class="line"><span class="keyword">ENV</span> MAIN_APP $&#123;MAIN_APP&#125;</span><br><span class="line"><span class="comment"># This number should generally be between 2-4 workers per core in the server.</span></span><br><span class="line"><span class="keyword">ENV</span> WORKERS $&#123;WORKERS&#125;</span><br><span class="line"><span class="comment"># one of sync, eventlet, gevent, tornado, gthread</span></span><br><span class="line"><span class="keyword">ENV</span> WORKERCLASS $&#123;WORKERCLASS&#125;</span><br><span class="line"><span class="keyword">ENV</span> TIMEOUT $&#123;TIMEOUT&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> entrypoint.sh entrypoint.sh</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> src/ .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install -r requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install gunicorn gevent</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> $&#123;PORT&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://docs.gunicorn.org/en/stable/run.html</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> [<span class="string">&quot;chmod&quot;</span>, <span class="string">&quot;+x&quot;</span>, <span class="string">&quot;./entrypoint.sh&quot;</span>]</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> <span class="string">&quot;./entrypoint.sh&quot;</span></span></span><br></pre></td></tr></table></figure><p>다시 작성한 Dockerfile에서는 <strong>ARG 키워드로 빌드 시점에 옵션을 적용</strong>하고 <strong>ENV 키워드를 사용하여 도커 컨테이너를 실행하는 시점</strong>에 환경 변수로 다양한 옵션을 적용할 수 있도록 하였습니다.</p><h3 id="터무니없는-빌드된-이미지-크기"><a href="#터무니없는-빌드된-이미지-크기" class="headerlink" title="터무니없는 빌드된 이미지 크기"></a>터무니없는 빌드된 이미지 크기</h3><p>Dockerfile을 다시 작성하면서 꽤 깔끔해졌지만 또 다른 문제가 내재되어있었습니다. 그것은 빌드된 이미지의 크기가 3.7GB라는 터무니 없는 크기를 가지고 있던 것이었습니다. </p><p><img data-src="/images/posts/python-docker-image-optimization/python-docker-image-optimization-01.png" alt="3.71GB"></p><p>분석 서버를 개발하시는 실장님도 파이썬을 전문으로 하는 개발자가 아니었기 때문에 이러한 이미지 크기가 정상적인 것 같다고 하셨으나 <strong>requirements.txt에 정의된 패키지에 의해 설치된 용량이 무려 2.8GB</strong>인 것을 확인하고 requirements.txt에 <strong>정의된 패키지 중 사용하지 않는 패키지들을 제거</strong>하는 작업을 수행하고보니 <strong>97개의 패키지가 39개로 축소</strong>되었습니다.</p><p><img data-src="/images/posts/python-docker-image-optimization/python-docker-image-optimization-02.png" alt="1.28GB"></p><p>축소된 requirements.txt에 의해 설치된 패키지의 용량은 2.8GB에서 368MB로 줄어든 것으로 확인되었습니다.</p><h3 id="파이썬-기반-이미지-변경"><a href="#파이썬-기반-이미지-변경" class="headerlink" title="파이썬 기반 이미지 변경"></a>파이썬 기반 이미지 변경</h3><p>그럼에도 불구하고 아직 1.28GB라는 상당히 무거운 이미지 사이즈를 가지고 있었습니다. 그 이유는 기본 파이썬 이미지에서 이미 많은 패키지가 설치되기 때문입니다.</p><p><img data-src="/images/posts/python-docker-image-optimization/python-docker-image-optimization-03.png"></p><p>일반적으로 도커 이미지를 줄이기 위해서 알파인 리눅스 기반으로 만들어진 이미지를 사용하는 것으로 변경합니다. 그런데 알파인 리눅스로 된 파이썬 이미지를 사용하면 <a href="https://jonnung.dev/docker/2020/04/08/optimizing-docker-images/">도커 이미지 잘 만드는 방법</a>에서 확인할 수 있듯이 <strong>빌드 소요시간이 15분 이상 걸리는 현상</strong>을 보였습니다.</p><figure class="highlight docker"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.8</span>-slim-buster</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="bash"> gcc libpq-dev</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>결국 알파인 리눅스 기반 이미지 대신에 <code>3.8-slim-buster</code>을 기반의 이미지로 변경하였고 PostgreSQL 모듈을 설치할 때 오류가 발생하여 gcc 와 libpg-dev 패키지를 설치하였습니다.</p><p><img data-src="/images/posts/python-docker-image-optimization/python-docker-image-optimization-04.png"></p><p><strong>1.28GB의 도커 이미지가 655MB의 용량을 가지는 이미지로 축소</strong>되었습니다. 결과적으로 약 3.14GB의 크기를 줄이게 되었고 <strong>캐시되지 않은 상태에서 약 40초 정도의 시간이 소요됨</strong>을 확인했습니다. </p><h3 id="Dockerfile-키워드-순서-변경"><a href="#Dockerfile-키워드-순서-변경" class="headerlink" title="Dockerfile 키워드 순서 변경"></a>Dockerfile 키워드 순서 변경</h3><p><strong>도커 이미지 잘 만드는 방법</strong>을 참고하면 애플리케이션 소스는 패키지를 설치하고나서 복사하는 것이 빌드 시간을 단축한다는 것을 보고 COPY 키워드 순서를 변경하였습니다.</p><figure class="highlight docker"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> src/requirements.txt requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install -r requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install gunicorn gevent</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> entrypoint.sh entrypoint.sh</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> src/ .</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>먼저, requirements.txt을 우선적으로 복사하고 패키지를 설치한 뒤 애플리케이션 실행을 위한 엔트리포인트 스크립트 파일과 애플리케이션 소스 폴더를 복사하도록 변경했습니다.</p><h3 id="Gunicorn-설정-개선"><a href="#Gunicorn-설정-개선" class="headerlink" title="Gunicorn 설정 개선"></a>Gunicorn 설정 개선</h3><p>다시 작성한 Dockerfile을 살펴보니 ARG와 ENV 키워드가 많아 쓸데없이 파일이 지저분해보였습니다. ARG와 ENV 키워드들은 용량을 차지하지 않으므로 이미지 크기에 영향을 주지는 않으나 Gunicorn의 여러가지 옵션을 하나의 환경 변수로 지원하도록 추가 개선하였습니다.</p><figure class="highlight docker"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.8</span>-slim-buster</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="bash"> gcc libpq-dev</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /app/logs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build Arguments</span></span><br><span class="line"><span class="keyword">ARG</span> PORT=<span class="number">8000</span></span><br><span class="line"><span class="keyword">ARG</span> MAIN=application</span><br><span class="line"><span class="keyword">ARG</span> MAIN_APP=application</span><br><span class="line"><span class="keyword">ARG</span> GUNICORN_ARGS=--preload</span><br><span class="line"></span><br><span class="line"><span class="comment"># Environoment Variables</span></span><br><span class="line"><span class="keyword">ARG</span> PORT $&#123;PORT&#125;</span><br><span class="line"><span class="keyword">ENV</span> MAIN $&#123;MAIN&#125;</span><br><span class="line"><span class="keyword">ENV</span> MAIN_APP $&#123;MAIN_APP&#125;</span><br><span class="line"><span class="keyword">ENV</span> GUNICORN_ARGS $&#123;GUNICORN_ARGS&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> requirements.txt requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install -r requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install gunicorn gevent</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> gunicorn.conf.py gunicorn.conf.py</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> entrypoint.sh entrypoint.sh</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> src/ .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> $&#123;PORT&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://docs.gunicorn.org/en/stable/run.html</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> [<span class="string">&quot;chmod&quot;</span>, <span class="string">&quot;+x&quot;</span>, <span class="string">&quot;./entrypoint.sh&quot;</span>]</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> <span class="string">&quot;./entrypoint.sh&quot;</span></span></span><br></pre></td></tr></table></figure><p>다음과 같이 기본 옵션이 정의된 <strong>gunicorn.conf.py</strong> 파일을 적용하였습니다.</p><figure class="highlight py"><figcaption><span>gunicorn.conf.py</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://docs.gunicorn.org/en/stable/settings.html</span></span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"></span><br><span class="line">bind = <span class="string">&#x27;0.0.0.0:8000&#x27;</span></span><br><span class="line">workers = multiprocessing.cpu_count() * <span class="number">2</span> + <span class="number">1</span></span><br><span class="line">worker_connections = <span class="number">1000</span></span><br><span class="line">worker_class = <span class="string">&#x27;gevent&#x27;</span></span><br><span class="line">threads = <span class="number">1</span></span><br><span class="line">max_requests = <span class="number">0</span></span><br><span class="line">timeout = <span class="number">30</span></span><br><span class="line">keepalive = <span class="number">2</span></span><br></pre></td></tr></table></figure><p>그리고 기본으로 적용된 옵션을 하나로 통합된 <strong>GUNICORN_ARGS</strong> 환경 변수를 통해 자유롭게 옵션을 재정의하도록 하였습니다.</p><p><strong>requirements.txt에 정의된 패키지 정리</strong>하고 <strong>slim-buster 기반의 이미지로 변경</strong> 그리고 <strong>Dockerfile 키워드 순서를 변경</strong>함으로써 파이썬 애플리케이션에 대한 도커 이미지를 최적화하는 것을 알아보았습니다. 결과적으로 도커 이미지 사이즈를 많이 줄이게되어 이미지 용량에 대한 부담과 빌드 및 배포하기까지의 시간을 단축하게되어 다행이라고 생각합니다.</p><p>감사합니다.</p><h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul><li><a href="http://blog.hwahae.co.kr/all/tech/tech-tech/5567/">gunicorn 설정의 A to Z</a></li><li><a href="https://jonnung.dev/docker/2020/04/08/optimizing-docker-images/">도커 이미지 잘 만드는 방법</a>  </li><li><a href="https://kimeuichan.github.io/posts/deploy-docker-more-faster/">자주 변경되는 도커 이미지 빠르게 배포하기</a>  </li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 파이썬 도커 이미지에 대한 최적화에 대해서 알아봅니다. 회사에서 운영중인 서비스의 분석 서버는 파이썬으로 작성된 플래스크 기반의 웹 애플리케이션입니다. 여러가지 방식으로 배포하던 애플리케이션을 E</summary>
      
    
    
    
    
    <category term="Docker" scheme="https://kdevkr.github.io/tags/Docker/"/>
    
    <category term="Python" scheme="https://kdevkr.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Elastic Beanstalk Docker Platform</title>
    <link href="https://kdevkr.github.io/elastic-beanstalk-docker-with-python/"/>
    <id>https://kdevkr.github.io/elastic-beanstalk-docker-with-python/</id>
    <published>2021-09-06T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.031Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 아마존 웹 서비스의 <strong>Elastic Beanstalk에서 지원하는 도커 컨테이너 환경을 통해 애플리케이션을 배포하는 방법</strong>에 대하여 알아봅니다. 이 글에서는 애플리케이션을 도커 이미지화하고 사설 도커 레지스트리 서버에 저장된 도커 이미지를 기반으로 Elastic Beanstalk 환경에서 도커 컴포즈를 활용해 애플리케이션을 실행하는 것을 설명합니다.</p><h2 id="도커-플랫폼"><a href="#도커-플랫폼" class="headerlink" title="도커 플랫폼"></a>도커 플랫폼</h2><p>Elastic Beanstalk의 <a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/docker.html">도커 플랫폼</a>은 도커 컨테이너 환경에서 애플리케이션을 실행하는 기능을 지원합니다. 도커 플랫폼을 사용해 애플리케이션을 배포하기 위해서는 도커 컨테이너와 Elastic Beanstalk에 대한 이해가 필요합니다. 도커 플랫폼에서는 Dockerfile을 사용하여 직접 도커 이미지를 빌드하여 도커 컨테이너를 실행하거나 <strong>Dockerrun.aws.json</strong> 파일로 컨테이너 환경을 정의할 수 있도록 지원합니다. 또한, <a href="https://docs.docker.com/registry/deploying/">도커 레지스트리 서버</a>에 저장된 이미지를 기반으로 컨테이너를 구성할 수 있는 <strong>도커 컴포즈</strong> 방식도 사용할 수 있습니다.</p><p>도커 플랫폼에서 도커 이미지화된 애플리케이션을 도커 컴포즈로 배포하기 위해서는 다음의 항목들을 작성해야합니다.</p><ul><li>애플리케이션 도커 이미지</li><li>플랫폼 확장 및 환경 구성 파일</li><li>도커 컴포즈 문서</li><li>도커 레지스트리 서버 인증 파일</li><li>도커 구성 파일</li></ul><blockquote><p>이 글에서는 도커 레지스트리 서버가 구축되어있다고 가정합니다.</p></blockquote><h3 id="애플리케이션-도커-이미지"><a href="#애플리케이션-도커-이미지" class="headerlink" title="애플리케이션 도커 이미지"></a>애플리케이션 도커 이미지</h3><p>Python으로 작성된 간단한 Flask 웹 애플리케이션을 작성하고 도커 이미지로 빌드하기 위한 <strong>Dockerfile</strong> 파일을 정의합니다. </p><figure class="highlight python"><figcaption><span>application.py</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line"><span class="comment"># print a nice greeting.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span>(<span class="params">username = <span class="string">&quot;World&quot;</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;p&gt;Hello %s!&lt;/p&gt;\n&#x27;</span> % username</span><br><span class="line"></span><br><span class="line"><span class="comment"># EB looks for an &#x27;application&#x27; callable by default.</span></span><br><span class="line">application = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add a rule for the index page.</span></span><br><span class="line">application.add_url_rule(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;index&#x27;</span>, (<span class="keyword">lambda</span>: say_hello()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># run the app.</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># Setting debug to True enables debug output. This line should be</span></span><br><span class="line">    <span class="comment"># removed before deploying a production app.</span></span><br><span class="line">    application.debug = <span class="literal">True</span></span><br><span class="line">    application.run()</span><br></pre></td></tr></table></figure><blockquote><p>저는 파이썬을 다루지 않는 개발자이므로 파이썬을 설치하고 가상 환경을 시작하는 것은 생략하겠습니다.</p></blockquote><p>PIP 명령어를 사용하여 Python 애플리케이션에서 사용하는 패키지를 설치하기 위한 <strong>requirements.txt</strong>을 준비합니다.</p><figure class="highlight plaintext"><figcaption><span>requirements.txt</span></figcaption><table><tr><td class="code"><pre><span class="line">click==8.0.1</span><br><span class="line">Flask==1.1.2</span><br><span class="line">itsdangerous==2.0.1</span><br><span class="line">Jinja2==3.0.1</span><br><span class="line">MarkupSafe==2.0.1</span><br><span class="line">Werkzeug==2.0.1</span><br></pre></td></tr></table></figure><p>그리고 도커 허브에 등록된 Python 이미지를 기반으로 requirements.txt을 기준의 패키지를 설치하는 <strong>Dockerfile</strong>을 정의합니다. </p><figure class="highlight dockerfile"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> PORT=<span class="number">8000</span></span><br><span class="line"><span class="keyword">ARG</span> MAIN=application</span><br><span class="line"><span class="keyword">ARG</span> MAIN_APP=application</span><br><span class="line"><span class="keyword">ARG</span> WORKERS=application</span><br><span class="line"><span class="keyword">ARG</span> WORKERS=<span class="number">2</span></span><br><span class="line"><span class="keyword">ARG</span> WORKERCLASS=gevent</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> PORT $&#123;PORT&#125;</span><br><span class="line"><span class="keyword">ENV</span> MAIN $&#123;MAIN&#125;</span><br><span class="line"><span class="keyword">ENV</span> MAIN_APP $&#123;MAIN_APP&#125;</span><br><span class="line"><span class="keyword">ENV</span> WORKERS $&#123;WORKERS&#125;</span><br><span class="line"><span class="keyword">ENV</span> WORKERCLASS $&#123;WORKERCLASS&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> requirements.txt requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install -r requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install gunicorn</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> $&#123;PORT&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> [<span class="string">&quot;chmod&quot;</span>, <span class="string">&quot;+x&quot;</span>, <span class="string">&quot;./entrypoint.sh&quot;</span>]</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> <span class="string">&quot;./entrypoint.sh&quot;</span></span></span><br></pre></td></tr></table></figure><p>마지막으로 <a href="https://docs.gunicorn.org/en/stable/">Gunicorn WSGI 서버</a>를 사용하여 Flask 웹 애플리케이션을 실행하는 <strong>엔트리포인트</strong>를 작성합니다.</p><figure class="highlight sh"><figcaption><span>entrypoint.sh</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">source</span> venv/bin/activate</span><br><span class="line">gunicorn <span class="variable">$&#123;MAIN&#125;</span>:<span class="variable">$&#123;MAIN_APP&#125;</span> -b 0.0.0.0:<span class="variable">$&#123;PORT&#125;</span> -w <span class="variable">$&#123;WORKERS&#125;</span></span><br></pre></td></tr></table></figure><p>Dockerfile을 기반으로 애플리케이션을 도커 이미지로 생성하고 도커 레지스트리 서버에 빌드된 이미지를 저장합니다.</p><figure class="highlight zsh"><figcaption><span>Terminal</span></figcaption><table><tr><td class="code"><pre><span class="line">docker login https://registry.mambo.kr:5000</span><br><span class="line">Username: mambo</span><br><span class="line">Password:</span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line">docker build -t registry.mambo.kr:5000/mambo-py:<span class="built_in">test</span></span><br><span class="line">docker push registry.mambo.kr:5000/mambo-py:<span class="built_in">test</span></span><br><span class="line">docker <span class="built_in">logout</span> registry.mambo.kr:5000/mambo-py:<span class="built_in">test</span></span><br></pre></td></tr></table></figure><h3 id="플랫폼-확장-구성-파일"><a href="#플랫폼-확장-구성-파일" class="headerlink" title="플랫폼 확장 구성 파일"></a>플랫폼 확장 구성 파일</h3><p>Elastic Beanstalk에서도 Nginx 프록시 옵션을 설정할 수 있지만 도커 컴포즈를 사용하여 도커 컨테이너 환경을 구성하는 경우 Nginx 프록시 옵션을 활성화되어 있더라도 무시됩니다. Nginx 프록시 옵션을 무시한다는 의미는 애플리케이션 소스 번들에 도커 컴포즈 문서와 함께 <strong>.platform 폴더를 포함시키더라도 Nginx 구성 파일로 복사하여 확장하지 않는다</strong>는 이야기입니다.</p><p>하지만 애플리케이션 소스 번들에 포함시킨 <strong>.platform 폴더는 /var/app/current에 추출</strong>되므로 도커 컴포즈 문서에 도커 컨테이너에 볼륨을 지정하여 전달할 수 있습니다.</p><figure class="highlight nginx"><figcaption><span>docker-nginx.conf</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attribute">user</span>                    nginx;</span><br><span class="line"><span class="attribute">error_log</span>               /var/log/nginx/error.log <span class="literal">warn</span>;</span><br><span class="line"><span class="attribute">pid</span>                     /var/run/nginx.pid;</span><br><span class="line"><span class="attribute">worker_processes</span>        auto;</span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span>    <span class="number">32768</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">use</span>  <span class="literal">epoll</span>;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>         /etc/nginx/mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>    application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">log_format</span>      main    <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                            <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                            <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">map</span> $http_upgrade $connection_upgrade &#123;</span><br><span class="line">      <span class="attribute">default</span>     <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">      <span class="attribute">listen</span>                <span class="number">80</span> default_server;</span><br><span class="line">      <span class="attribute">access_log</span>            /var/log/nginx/access.log main;</span><br><span class="line"></span><br><span class="line">      <span class="attribute">client_header_timeout</span> <span class="number">60</span>;</span><br><span class="line">      <span class="attribute">client_body_timeout</span>   <span class="number">60</span>;</span><br><span class="line">      <span class="attribute">keepalive_timeout</span>     <span class="number">60</span>;</span><br><span class="line">      <span class="attribute">gzip</span>                  <span class="literal">off</span>;</span><br><span class="line">      <span class="attribute">gzip_comp_level</span>       <span class="number">4</span>;</span><br><span class="line">      <span class="attribute">gzip_types</span>            text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript;</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Include the Elastic Beanstalk generated locations</span></span><br><span class="line">      <span class="attribute">include</span> conf.d/elasticbeanstalk/<span class="regexp">*.conf</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">           <span class="attribute">listen</span>                   <span class="number">443</span> ssl default_server;</span><br><span class="line">           <span class="attribute">server_name</span>              mambo.kr;</span><br><span class="line">           <span class="attribute">ssl_certificate</span>          /etc/nginx/cert/server-ca-bundle.pem;</span><br><span class="line">           <span class="attribute">ssl_certificate_key</span>      /etc/nginx/cert/server.key;</span><br><span class="line">           <span class="attribute">ssl_protocols</span>            TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">           <span class="attribute">ssl_ciphers</span>              HIGH:!aNULL:!MD5;</span><br><span class="line">           <span class="attribute">ssl_verify_client</span>        optional_no_ca;</span><br><span class="line"></span><br><span class="line">           <span class="attribute">location</span> / &#123;</span><br><span class="line">               <span class="attribute">proxy_pass</span>          http://app:8000;</span><br><span class="line">               <span class="attribute">proxy_http_version</span>  <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">               <span class="attribute">proxy_set_header</span>    Connection          $connection_upgrade;</span><br><span class="line">               <span class="attribute">proxy_set_header</span>    Upgrade             $http_upgrade;</span><br><span class="line">               <span class="attribute">proxy_set_header</span>    Host                $host;</span><br><span class="line">               <span class="attribute">proxy_set_header</span>    X-Real-IP           $remote_addr;</span><br><span class="line">               <span class="attribute">proxy_set_header</span>    X-Forwarded-For     $proxy_add_x_forwarded_for;</span><br><span class="line">               <span class="attribute">proxy_set_header</span>    X-SSL-CERT          $ssl_client_escaped_cert;</span><br><span class="line">               <span class="attribute">proxy_buffering</span>     <span class="literal">off</span>;</span><br><span class="line">           &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>단일 컨테이너를 구성하고 ELB로 전달되는 트래픽을 애플리케이션 컨테이너에 직접 전달할 수 있지만 도커 컴포즈를 사용하여 컨테이너 구성하더라도 직접 Nginx 컨테이너를 함께 구성할 수 있음을 보여줍니다. 위 Nginx 구성 파일은 일반적인 Elastic Beanstalk의 다양한 언어로 지원하는 플랫폼에서 제공하는 Nginx 확장 구성 파일과 동일하지만 <strong>애플리케이션과 Nginx가 별도의 독립적인 컨테이너로 실행되므로 호스트 이름으로 접근해야함</strong>을 보여줍니다.</p><h3 id="도커-컴포즈-문서"><a href="#도커-컴포즈-문서" class="headerlink" title="도커 컴포즈 문서"></a>도커 컴포즈 문서</h3><p>애플리케이션과 Nginx 컨테이너를 구성하는 도커 컴포즈 문서를 정의합니다. </p><figure class="highlight yaml"><figcaption><span>docker-compose.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.21.1</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.platform/nginx/conf.d/elasticbeanstalk:/etc/nginx/conf.d/elasticbeanstalk</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.platform/nginx/docker-nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/nginx/cert:/etc/nginx/cert</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;$&#123;EB_LOG_BASE_DIR&#125;/nginx:/var/log/nginx&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;80:80&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;443:443&#x27;</span></span><br><span class="line">    <span class="attr">networks:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">nginx_app</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.mambo.kr:5000/mambo-py:test</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">networks:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">nginx_app</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">nginx_app:</span></span><br></pre></td></tr></table></figure><p>Elastic Beanstalk 환경 구성 파일에 의해 가져온 Nginx 인증서와 애플리케이션 소스 번들에 포함된 플랫폼 확장 파일을 Nginx 컨테이너 볼륨에 연결합니다. 그리고 애플리케이션 로드 밸런서 또는 네트워크 로드 밸런서에서 전달되는 트래픽은 Nginx 컨테이너로 경유하여 애플리케이션 컨테이너로 전달되므로 애플리케이션에 대한 포트는 호스트로 노출하지 않도록 하여 직접 접근이 불가능하도록 합니다.</p><h4 id="컨테이너-환경-변수"><a href="#컨테이너-환경-변수" class="headerlink" title="컨테이너 환경 변수"></a>컨테이너 환경 변수</h4><p>Beanstalk 콘솔에서 설정하는 환경 변수는 애플리케이션 소스 번들이 추출되는 /var/app/current 경로에 .env 파일에 환경 변수가 정의됩니다. 그리고 이 파일을 도커 컨테이너의 환경 변수 참조 파일로 추가할 수 있습니다.</p><blockquote><p>도커 컴포즈 문서에 정의한 환경 변수가 우선 순위를 갖습니다. 도커 컴포즈 문서에 설정된 환경 변수를 Beanstalk 환경 변수로 설정하더라도 무시되니 주의하셔야합니다.</p></blockquote><h3 id="도커-레지스트리-서버-인증-파일"><a href="#도커-레지스트리-서버-인증-파일" class="headerlink" title="도커 레지스트리 서버 인증 파일"></a>도커 레지스트리 서버 인증 파일</h3><p>도커 레지스트리 서버에서 도커 이미지를 받아오기 위해서는 레지스트리 서버에 대한 인증 파일이 필요합니다. 만약, 기본 도커 레지스트리 서버인 도커 허브를 사용하는 것이 아니라 직접 구축한 도커 레지스트리 서버과 통신해야한다면 <strong>TLS 통신을 위한 인증서 파일이 필요</strong>합니다.</p><p>예를 들어, 도커 레지스트리 서버에 대한 인증서는 다음과 같이 참조하게 됩니다.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">/etc/docker/certs.d/         &lt;-- Certificate directory</span><br><span class="line">└── registry.mambo.kr:5000   &lt;-- Hostname:port</span><br><span class="line">    ├── client.cert          &lt;-- Client certificate</span><br><span class="line">    ├── client.key           &lt;-- Client key</span><br><span class="line">    └── ca.crt               &lt;-- Certificate authority that signed the registry certificate</span><br></pre></td></tr></table></figure><blockquote><p>윈도우와 MacOS 에서는 $USER/.docker/certs.d 입니다.</p></blockquote><p>도커 레지스트리 서버에 로그인하면 <strong>.dockercfg</strong> 파일에 크레덴셜 정보가 저장됩니다.</p><figure class="highlight json"><figcaption><span>.dockercfg</span></figcaption><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;https://registry.mambo.kr:5000&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;auth&quot;</span>: <span class="string">&quot;[Base64]username:password&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>윈도우 또는 Mac OS에서는 <strong>윈도우 자격 증명 관리자</strong> 또는 <strong>OSX Keychain</strong>에 크레덴셜을 저장할 수 있는데요. 이 경우에는 <strong>.dockercfg 또는 config.json</strong> 파일을 살펴보더라도 크레덴셜을 확인할 수 없습니다. 도커 로그인 시 사용되는 크레덴셜은 사용자 이름과 패스워드(username:password)를 <a href="https://codebeautify.org/base64-encode">Base64로 인코딩</a>한 값이기 때문에 <strong>직접 Base64로 인코딩</strong>하고 위와 같이 <strong>도커 레지스트리 서버에 대한 .dockercfg를 정의</strong>하시기 바랍니다.</p><h3 id="환경-구성-파일"><a href="#환경-구성-파일" class="headerlink" title="환경 구성 파일"></a>환경 구성 파일</h3><p>도커 레지스트리 서버에 대한 인증서 파일들을 S3 버킷에서 가져오는 구성 파일을 정의합니다. 지난 <a href="../elastic-beanstalk-s3-auth">Elastic Beanstalk S3 Authentication</a>를 참고하여 다음과 같이 작성하였습니다.</p><figure class="highlight yaml"><figcaption><span>.ebextensions/registry-cert.config</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">Resources:</span></span><br><span class="line">    <span class="attr">AWSEBAutoScalingGroup:</span></span><br><span class="line">        <span class="attr">Metadata:</span></span><br><span class="line">            <span class="attr">AWS::CloudFormation::Authentication:</span></span><br><span class="line">                <span class="attr">S3Auth:</span></span><br><span class="line">                    <span class="attr">type:</span> <span class="string">S3</span></span><br><span class="line">                    <span class="attr">buckets:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">mambo-cert</span></span><br><span class="line">                    <span class="attr">roleName:</span></span><br><span class="line">                        <span class="attr">Fn::GetOptionSetting:</span></span><br><span class="line">                            <span class="attr">Namespace:</span> <span class="string">aws:autoscaling:launchconfiguration</span></span><br><span class="line">                            <span class="attr">OptionName:</span> <span class="string">IamInstanceProfile</span></span><br><span class="line">                            <span class="attr">DefaultValue:</span> <span class="string">aws-elasticbeanstalk-ec2-role</span></span><br><span class="line"><span class="attr">files:</span></span><br><span class="line">    <span class="string">&quot;/etc/docker/certs.d/registry.mambo.kr:5000/client.cert&quot;</span><span class="string">:</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&quot;000400&quot;</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">source:</span> <span class="string">https://mambo-cert.s3.ap-northeast-2.amazonaws.com/registry/client.cert</span></span><br><span class="line">        <span class="attr">authentication:</span> <span class="string">S3Auth</span></span><br><span class="line">    <span class="string">&quot;/etc/docker/certs.d/registry.mambo.kr:5000/client.key&quot;</span><span class="string">:</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&quot;000400&quot;</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">source:</span> <span class="string">https://mambo-cert.s3.ap-northeast-2.amazonaws.com/registry/client.key</span></span><br><span class="line">        <span class="attr">authentication:</span> <span class="string">S3Auth</span></span><br><span class="line">    <span class="string">&quot;/etc/docker/certs.d/registry.mambo.kr:5000/ca.crt&quot;</span><span class="string">:</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&quot;000400&quot;</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">source:</span> <span class="string">https://mambo-cert.s3.ap-northeast-2.amazonaws.com/registry/ca.crt</span></span><br><span class="line">        <span class="attr">authentication:</span> <span class="string">S3Auth</span></span><br><span class="line"></span><br><span class="line"><span class="attr">commands:</span></span><br><span class="line">    <span class="attr">99-remove-bak:</span></span><br><span class="line">        <span class="attr">cwd:</span> <span class="string">/etc/docker/certs.d/registry.mambo.kr:5000</span></span><br><span class="line">        <span class="attr">command:</span> <span class="string">rm</span> <span class="string">-f</span> <span class="string">*.bak</span></span><br></pre></td></tr></table></figure><h3 id="도커-구성-파일"><a href="#도커-구성-파일" class="headerlink" title="도커 구성 파일"></a>도커 구성 파일</h3><p>로컬 환경에서는 도커의 로그인 명령어를 사용하여 도커 레지스트리 서버에 인증하고 이미지를 등록하거나 가져올 수 있습니다. 그러나 Elastic Beanstalk 환경에서는 직접 로그인 명령어를 사용하는 것이 아니므로 도커에서 도커 레지스트리 서버에 대한 인증 파일을 사용할 수 있도록 앞서 알아본 <strong>.dockercfg</strong> 파일을 가져와야 합니다.</p><figure class="highlight json"><figcaption><span>Dockerrun.aws.json</span></figcaption><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;AWSEBDockerrunVersion&quot;</span>: <span class="string">&quot;3&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;Authentication&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;bucket&quot;</span>: <span class="string">&quot;mambo-cert&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;registry/.dockercfg&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>도커 컴포즈 문서와 함께 애플리케이션 소스 번들에 포함되는 위 도커 구성 파일은 Dockerrun.aws.json v3을 사용하며 <strong>mambo-cert/registry/.dockercfg</strong> 파일을 <strong>/root/.docker/config.json</strong>에 크레덴셜 정보를 복사합니다.</p><blockquote><p>EC2 인스턴스의 IAM Role이 S3 버킷에 대한 읽기 권한을 가져야합니다.</p></blockquote><h3 id="애플리케이션-소스-번들"><a href="#애플리케이션-소스-번들" class="headerlink" title="애플리케이션 소스 번들"></a>애플리케이션 소스 번들</h3><p>Elastic Beanstalk의 도커 플랫폼 환경에 배포할 애플리케이션 소스 번들에는 다음과 같은 파일들이 포함됩니다. </p><ul><li>docker-compose.yml</li><li>Dockerrun.aws.json</li><li>.platform</li><li>.ebextensions</li></ul><p>위 파일들을 <strong>zip 명령어로 애플리케이션 소스 번들 파일을 생성</strong>합니다.</p><figure class="highlight sh"><figcaption><span>Terminal</span></figcaption><table><tr><td class="code"><pre><span class="line">zip app-bundle.zip -r docker-compose.yml Dockerrun.aws.json .platform .ebextensions</span><br></pre></td></tr></table></figure><p>이제 애플리케이션 소스 번들 파일을 업로드하면 다음과 같이 Hello World가 표시되는 것을 확인할 수 있습니다.</p><p><img data-src="/images/posts/beanstalk-docker-platform/web.png"></p><p>이렇게해서 애플리케이션을 도커 이미지로 만들고 사설로 구축한 도커 레지스트리 서버에 등록된 이미지를 통해 Elastic Beanstalk의 도커 플랫폼을 활용하여 애플리케이션을 배포해보았습니다.</p><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 아마존 웹 서비스의 &lt;strong&gt;Elastic Beanstalk에서 지원하는 도커 컨테이너 환경을 통해 애플리케이션을 배포하는 방법&lt;/strong&gt;에 대하여 알아봅니다. 이 글에서는 애플리케이션</summary>
      
    
    
    
    
    <category term="Beanstalk" scheme="https://kdevkr.github.io/tags/Beanstalk/"/>
    
    <category term="Docker" scheme="https://kdevkr.github.io/tags/Docker/"/>
    
    <category term="Python" scheme="https://kdevkr.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>IP 대역 그리고 위치추적</title>
    <link href="https://kdevkr.github.io/ip-band-and-location-tracking/"/>
    <id>https://kdevkr.github.io/ip-band-and-location-tracking/</id>
    <published>2021-09-05T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.031Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 IT 인프라를 구성하는 IP 대역과 NAT 그리고 IP를 활용한 위치 추적에 대해서 알아봅니다. </p><h2 id="IP-대역"><a href="#IP-대역" class="headerlink" title="IP 대역"></a>IP 대역</h2><p>IT 인프라에서 IP는 퍼블릭 IP 그리고 프라이빗 IP로 구분되어집니다. <strong>퍼블릭 IP</strong>는 인터넷에 접속할 수 있는 공인 IP를 말하며 <strong>프라이빗 IP</strong>는 개인적으로 구성한 네트워크 망에서 사용하는 사설 IP를 말합니다. 따라서, <strong>사설망 IP로는 외부 인터넷 접속을 통해 구글 또는 네이버 사이트에 접근할 수 없습니다.</strong></p><h3 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h3><p><a href="https://datatracker.ietf.org/doc/html/rfc1631">NAT(IP Network Address Translator)</a>는 IPv4 주소체계의 한계로 인하여 IP 주소가 부족해지는 현상을 보완하기 위해 사용하는 기술입니다. NAT는 <strong>내부 사설망 IP를 가지고 외부 네트워크망에 접속할 수 있도록 공인 IP로 변환</strong>하는 기능을 수행합니다. 일반적으로 사용하는 공유기에는 NAT 기능을 포함하고 있기 때문에 공유기에서 192.168.0.2와 같은 주소를 할당하더라도 외부 인터넷에 접속할 경우에는 공인 IP로 변환하여 요청하게 됩니다.</p><p>이러한 차이로 윈도우 컴퓨터의 명령프롬프트에서 <strong>ifconfig</strong> 명령어를 실행하면 <strong>공유기에서 할당한 사설 IP</strong>를 확인할 수 있지만 아이피 정보를 확인할 수 있는 <a href="https://ipconfig.io/">ipconfig.io</a>, <a href="https://ifconfig.io/">ifconfig.io</a>, <a href="https://ifconfig.me/">ifconfig.me</a>에 접속해보면 사설 IP가 아닌 <strong>공인 IP</strong>를 확인할 수 있습니다.</p><p><img data-src="/images/posts/ip-band-and-location-tracking/ipconfig-01.png" alt="내부 아이피 조회"></p><p><img data-src="/images/posts/ip-band-and-location-tracking/ipconfig-02.png" alt="외부 아이피 조회"></p><h3 id="IP-위치-조회"><a href="#IP-위치-조회" class="headerlink" title="IP 위치 조회"></a>IP 위치 조회</h3><p>위에서 확인한 공인 IP에 대해서 위치추적 사이트라는 곳에서 조회를 해보면 실제로 살고있는 곳 보다는 터무니없는 곳을 보여주는 경우가 많습니다. 이렇게 위치추적 사이트에서 IP에 대한 위치 조회가 정확하지 않은 이유는 <strong>인터넷 서비스 사업자(ISP)인 KT 인터넷과 같은 업체에서 지역을 정해서 IP 대역을 할당</strong>하고 그 지역내에서 DHCP를 통해 동적으로 할당하기 때문입니다. 예를 들어, 한국인터넷진흥원에서 제공하는 <a href="https://후이즈검색.한국/">WHOIS</a> 서비스를 통해 IP를 조회해보면 조금 더 상세한 지역을 안내해줍니다.</p><p><img data-src="/images/posts/ip-band-and-location-tracking/ipconfig-03.png" alt="WHOIS 조회"></p><p>실제로 제가 살고 있는 경기도 양주시에서 사용중인 IP라고 안내해주었습니다. 이렇게 한국인터넷진흥원에서 보다 정확한 위치를 확인할 수 있는 이유는 <strong>KT 인터넷과 같은 인터넷 서비스 사업자에서 한국인터넷진흥원에 지역에 대한 IP 대역 정보를 등록</strong>하기 때문입니다.</p><p>공인 IP 대역의 <strong>218.152.0.0부터 218.159.255.255는 KT 인터넷에서 사용중인 IP 대역</strong>이며 그 중에서 218.156.190.X에 대한 IP 대역은 경기도 양주시에서 사용하도록 할당하는 것을 알 수 있습니다. 위치 추적 사이트에서 인터넷 서비스 사업자의 IP 대역은 알 수 있지만 <strong>특정 IP가 실제로 KT 인터넷이 어떤 지역에 할당했는지에 대한 정보가 없기 때문에</strong> KT 인터넷에 대한 본사 또는 지역적으로 퍼져있는 KT 인터넷 장비의 위치 정보를 대신 표시해주는 것 입니다.</p><blockquote><p>인터넷 서비스 사업자는 지역에 대하여 IP 대역을 형성하기 때문에 특정 IP 대역에서 트래픽 과부화가 발생하면 인터넷 속도를 제한하는 락을 걸기도 합니다. 실제로 인터넷 속도가 충분하게 나오지 않아서 인터넷 기사를 불러 확인해보면 주변 장비에 대한 정보를 확인하고 락 해제를 요청하는 걸 많이 경험했습니다.</p><p>지난 4월에 난리였던 <a href="https://www.seoul.co.kr/news/newsView.php?id=20210420500154">KT ‘10기가 인터넷’ 속도저하 논란에 방통위 조사 나선다</a>와 같은 경우도 트래픽 규모에 따라 제한을 둔 것인데 기술적으로 결함이 있지 않았나 싶네요.</p></blockquote><h3 id="현실과-영화는-다르다"><a href="#현실과-영화는-다르다" class="headerlink" title="현실과 영화는 다르다"></a>현실과 영화는 다르다</h3><p>아무튼, 영화에서는 IP 정보를 알게되면 해당 IP를 사용하는 범죄자의 위치를 정확히 아는 것처럼 나오는 경우가 많습니다. 실제로는 경찰이 필요에 의해 웹 서비스 회사에 특정 아이디에 대한 IP 이력 정보를 요구하는 공조 요청을 하게 되고 <strong>제공받은 IP를 다시 인터넷 서비스 사업자인 KT 본사에게 IP 대역에 대한 정보를 요청</strong>하게 됩니다. 그래서 최종적으로는 <strong>정확한 위치는 아니더라도 대략적으로 읍면동까지</strong>는 알게됩니다.</p><p>범죄자가 사용하는 IP가 해외에서 사용하는 공인 IP 정보로 조회되는 경우에는 더 까다로워지는 것은 맞습니다. 해당 IP 대역을 할당하는 인터넷 서비스 업체에게 공조 요청을 하는게 아니라 <strong>국제형사사법 공조법에 의거</strong>해서 국가 간 공조 요청을 하고 제공받아야합니다. 경찰분들이 담당하는 사건들이 하나가 아니기 때문에 해외 IP에 대한 추적을 꺼려하는게 어찌보면 당연할 수 있습니다. </p><p>그럼에도 불구하고 <a href="https://www.youtube.com/watch?v=aWqK1b5w9Yo">성 착취 영상물을 유포한 사건</a>의 용의자도 집요한 추적 끝에 잡아내기도 하죠. 해외 VPN 서버를 사용하면 추적할 수 없다는 이야기를 하는 사람들이 많은데 <strong>사실은 추적은 되지만 귀찮을 수 있다</strong>라고 봐야겠죠.</p><h2 id="실무-환경에서의-IP"><a href="#실무-환경에서의-IP" class="headerlink" title="실무 환경에서의 IP"></a>실무 환경에서의 IP</h2><p>그러면 실무 환경인 회사에서 사용하는 IP에 대해서 알아보도록 하겠습니다. 회사에서도 자체 내부 사설망을 구축하여 회사 내부에서 근무하는 직원들이 사용할 수 있는 IP를 할당하게 됩니다. 이러한 것은 회사 네트워크를 관리하는 네트워크 담당자가 수행합니다. </p><h3 id="NAT-아이피"><a href="#NAT-아이피" class="headerlink" title="NAT 아이피"></a>NAT 아이피</h3><p>일반적으로 라우터 장비로부터 DHCP로 동적으로 할당받는 내부 아이피를 사용하여 인터넷을 사용하지만 경우에 따라서는 외부 인터넷망에서 회사 네트워크 대역에 접근할 수 있도록 NAT 아이피를 요청해야하는 경우도 있습니다.</p><p style="text-align:center; font-weight:bold;">"외부에서 접근하기 위한 NAT 아이피가 필요합니다."</p><p>그러면 네트워크 담당자는 NAT 아이피가 필요한 사유를 검토하고 NAT 아이피와 함께 외부에서 접근 가능한 도메인 주소와 포트 정보를 전달해줍니다. 회사 라우터 장비에서는 외부 트래픽의 도메인과 포트를 확인하고 연결된 NAT 아이피로 트래픽을 전달해줌으로써 내부 사설망에서 실행중인 애플리케이션에 접근할 수 있게 됩니다.</p><h3 id="VPN"><a href="#VPN" class="headerlink" title="VPN"></a>VPN</h3><p>코로나 19로 인하여 <strong>대부분의 IT 기업들이 재택근무를 허용</strong>하게 되었습니다. 필요에 의해 회사로 출근하기도 하지만 대부분의 업무는 집에서 수행합니다. 하지만, 개발 조직에서는 개발 환경에서 사용하는 많은 인스턴스를 외부에서 접근이 불가능한 회사 내부 사설망 서버에 구축합니다. 그리고 아마존 웹 서비스와 같은 클라우드 환경을 사용한다고 하더라도 <strong>SSH를 통한 인스턴스 접근은 회사에서 사용중인 아이피 대역에 대해서만 허용</strong>하는 경우가 많습니다.</p><p>집에서 사용하는 공인 IP는 회사에서 사용하는 아이피 대역이 아니므로 SSH 접근이 불가능합니다. 그렇기 때문에 회사 외부에서도 회사에서 사용하는 아이피 대역처럼 사용할 수 있는 VPN을 활용하게 됩니다. 제가 다니고 있는 회사에서는 <strong>TLS 프로토콜을 적용하여 통신하는 OpenVPN을 사용</strong>하고 있으며 여자친구가 일하는 회사에서는 Pulse Secure와 함께 <a href="https://vip.symantec.com/">VIP Access</a>을 사용하여 2단계 인증까지 요구하기도 합니다.</p><p>이 글을 보신 여러분들도 인터넷 접속을 위해 할당받은 외부 아이피를 확인해보고 한국인터넷진흥원의 WHOIS 서비스를 통해 어느 지역까지 추적되는지 경험해보시기 바랍니다.</p><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 IT 인프라를 구성하는 IP 대역과 NAT 그리고 IP를 활용한 위치 추적에 대해서 알아봅니다. &lt;/p&gt;
&lt;h2 id=&quot;IP-대역&quot;&gt;&lt;a href=&quot;#IP-대역&quot; class=&quot;headerlink&quot;</summary>
      
    
    
    
    
    <category term="IP Band" scheme="https://kdevkr.github.io/tags/IP-Band/"/>
    
    <category term="NAT" scheme="https://kdevkr.github.io/tags/NAT/"/>
    
    <category term="Location Tracking" scheme="https://kdevkr.github.io/tags/Location-Tracking/"/>
    
  </entry>
  
  <entry>
    <title>Elastic Beanstalk S3 Authentication</title>
    <link href="https://kdevkr.github.io/elastic-beanstalk-s3-auth/"/>
    <id>https://kdevkr.github.io/elastic-beanstalk-s3-auth/</id>
    <published>2021-09-02T00:00:00.000Z</published>
    <updated>2021-12-29T14:23:25.031Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 Elastic Beanstalk 구성 시 S3 프라이빗 저장소에서 파일을 받아오는 것을 알아보고자 합니다. 지난 <a href="../tls-offload">TLS 오프로드</a>에서 Nginx 에서 사용할 SSL 인증서를 Beanstalk 환경 구성 파일의 <a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/customize-containers-ec2.html#linux-files">파일 키</a>를 사용하여 생성했었습니다. 하지만, 보안을 중요시하는 회사라면 애플리케이션 소스 번들에 인증서와 개인키를 포함시키는 것을 허용하지 않을 수 있습니다. 그렇기 때문에 애플리케이션 소스 번들에 인증서를 포함하지 않고 애플리케이션 배포 단계에서 가져올 수 있는 방안을 마련해야합니다.</p><h2 id="Beanstalk-S3-Auth"><a href="#Beanstalk-S3-Auth" class="headerlink" title="Beanstalk S3 Auth"></a>Beanstalk S3 Auth</h2><p>Beanstalk 확장 구성 파일에서 CloudFormation의 <a href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/aws-resource-authentication.html">AWS::CloudFormation::Authentication</a> 리소스를 사용하여 S3 버킷에 대한 자격 증명을 지정할 수 있고 인증을 수행하여 S3 저장소에 등록되어있는 인증서를 가져올 수 있습니다. <a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/https-storingprivatekeys.html">프라이빗 키를 Amazon S3에 안전하게 저장</a>에서 알려주는 대로 Beanstalk 구성 시 <a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/ebextensions-functions.html#ebextensions-functions-getoptionsetting">Fn::GetOptionSetting</a> 함수를 활용하면 됩니다.</p><h3 id="S3-Bucket-Policy"><a href="#S3-Bucket-Policy" class="headerlink" title="S3 Bucket Policy"></a>S3 Bucket Policy</h3><p>먼저, <strong>AWS::CloudFormation::Authentication</strong> 리소스로 S3 버킷에 대한 자격 증명을 가질 수 있도록 S3 버킷에 보안 정책을 설정해야 합니다. 일반적으로 Beanstalk으로 애플리케이션을 배포하는 경우 <strong>aws-elasticbeanstalk-ec2-role</strong>을 인스턴스 프로파일로 가지게 됩니다. 인증서 파일이 저장된 S3 버킷은 퍼블릭 액세스가 차단되어있으므로 EC2 인스턴스가 <a href="https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/add-bucket-policy.html">버킷에 대한 권한을 가지도록 정책을 추가</a>합니다.</p><p><img data-src="/images/posts/elastic-beanstalk-s3-auth-01.png"></p><h3 id="Extend-Nginx"><a href="#Extend-Nginx" class="headerlink" title="Extend Nginx"></a>Extend Nginx</h3><p>이제 이전에 작성하였던 SSL 인증서를 만들어내는 구성 파일을 S3에서 받아오도록 작성해야합니다. files 키의 <strong>content</strong> 항목을 제거하고 다음의 항목을 추가합니다.</p><ul><li>source : S3 인증서 오브젝트 URL</li><li>authentication : 인증 속성 이름</li></ul><figure class="highlight yaml"><figcaption><span>.ebextensions/nginx-cert.config</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">Resources:</span></span><br><span class="line">    <span class="attr">AWSEBAutoScalingGroup:</span></span><br><span class="line">        <span class="attr">Metadata:</span></span><br><span class="line">            <span class="attr">AWS::CloudFormation::Authentication:</span></span><br><span class="line">                <span class="attr">S3Auth:</span></span><br><span class="line">                    <span class="attr">type:</span> <span class="string">S3</span></span><br><span class="line">                    <span class="attr">buckets:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">mambo-cert</span></span><br><span class="line">                    <span class="attr">roleName:</span></span><br><span class="line">                        <span class="attr">Fn::GetOptionSetting:</span></span><br><span class="line">                            <span class="attr">Namespace:</span> <span class="string">aws:autoscaling:launchconfiguration</span></span><br><span class="line">                            <span class="attr">OptionName:</span> <span class="string">IamInstanceProfile</span></span><br><span class="line">                            <span class="attr">DefaultValue:</span> <span class="string">aws-elasticbeanstalk-ec2-role</span></span><br><span class="line"><span class="attr">files:</span></span><br><span class="line">    <span class="string">&quot;/etc/nginx/cert/server.crt&quot;</span><span class="string">:</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&quot;000400&quot;</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">source:</span> <span class="string">https://mambo-cert.s3.ap-northeast-2.amazonaws.com/server.crt</span></span><br><span class="line">        <span class="attr">authentication:</span> <span class="string">S3Auth</span></span><br><span class="line">    <span class="string">&quot;/etc/nginx/cert/server.key&quot;</span><span class="string">:</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&quot;000400&quot;</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">source:</span> <span class="string">https://mambo-cert.s3.ap-northeast-2.amazonaws.com/server.key</span></span><br><span class="line">        <span class="attr">authentication:</span> <span class="string">S3Auth</span></span><br><span class="line">    <span class="string">&quot;/etc/nginx/cert/server.ca-bundle&quot;</span><span class="string">:</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">&quot;000400&quot;</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">source:</span> <span class="string">https://mambo-cert.s3.ap-northeast-2.amazonaws.com/server-ca-bundle</span></span><br><span class="line">        <span class="attr">authentication:</span> <span class="string">S3Auth</span></span><br><span class="line"></span><br><span class="line"><span class="attr">commands:</span></span><br><span class="line">    <span class="attr">00-chain-ca-bundle:</span></span><br><span class="line">        <span class="attr">cwd:</span> <span class="string">/etc/nginx/cert</span></span><br><span class="line">        <span class="attr">command:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            cat server.crt server.ca-bundle &gt; server-ca.pem</span></span><br><span class="line"><span class="string">            chown nginx:nginx server-ca.pem</span></span><br><span class="line"><span class="string">            chmod 400 server-ca.pem</span></span><br><span class="line"><span class="string"></span>    <span class="attr">99-remove-bak:</span></span><br><span class="line">        <span class="attr">cwd:</span> <span class="string">/etc/nginx/cert</span></span><br><span class="line">        <span class="attr">command:</span> <span class="string">rm</span> <span class="string">-f</span> <span class="string">*.bak</span></span><br></pre></td></tr></table></figure><h3 id="Beanstalk-Resources"><a href="#Beanstalk-Resources" class="headerlink" title="Beanstalk Resources"></a>Beanstalk Resources</h3><p>아마존 웹 서비스의 리소스들은 CloudFormation으로 만들어지며 Elastic Beanstalk 환경도 <strong>CloudFormation 스택을 구성</strong>하여 만들어지게 됩니다.</p><figure class="highlight yaml"><figcaption><span>.ebextensions/nginx-cert.config</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">Resources:</span></span><br><span class="line">    <span class="attr">AWSEBAutoScalingGroup:</span></span><br><span class="line">        <span class="attr">Metadata:</span></span><br><span class="line">            <span class="attr">AWS::CloudFormation::Authentication:</span></span><br><span class="line">                <span class="attr">S3Auth:</span></span><br><span class="line">                    <span class="attr">type:</span> <span class="string">S3</span></span><br><span class="line">                    <span class="attr">buckets:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">mambo-cert</span></span><br><span class="line">                    <span class="attr">roleName:</span></span><br><span class="line">                        <span class="attr">Fn::GetOptionSetting:</span></span><br><span class="line">                            <span class="attr">Namespace:</span> <span class="string">aws:autoscaling:launchconfiguration</span></span><br><span class="line">                            <span class="attr">OptionName:</span> <span class="string">IamInstanceProfile</span></span><br><span class="line">                            <span class="attr">DefaultValue:</span> <span class="string">aws-elasticbeanstalk-ec2-role</span></span><br></pre></td></tr></table></figure><p>그래서 구성 파일의 리소스 키를 정의하는 것은 CloudFormation 템플릿에 리소스를 추가하는 것과 같습니다. 위 예시에서는 Beanstalk 환경 시작 시 만들어지는 CloudFormation 스택에 미리 정의된 웹 서버 환경의 리소스 항목인 <a href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/aws-properties-as-group.html">AWSEBAutoScalingGroup</a>을 사용했습니다. </p><p>그리고 AWSEBAutoScalingGroup에는 <a href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/aws-properties-as-launchconfig.html">LaunchConfiguration(AWS::AutoScaling::LaunchConfiguration)</a>라는 EC2 인스턴스에 대한 시작 구성을 정의하는 항목이 있으며 시작 구성에 정의된 내용 중에는 <a href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/aws-properties-as-launchconfig.html#cfn-as-launchconfig-iaminstanceprofile">IamInstanceProfile</a> 속성이 있습니다. IamInstanceProfile 속성은 EC2 인스턴스에 대한 인스턴스 프로파일로 지정된 <strong>IAM Role</strong>에 대한 이름을 제공합니다.</p><p>따라서, Beanstalk 환경 구성 시 선택한 IAM Role을 가져와서 <strong>AWS::CloudFormation::Authentication</strong> 리소스를 활용해 S3 버킷에 대한 자격 증명을 지정한 것입니다. 우리는 앞서 aws-elasticbeanstalk-ec2-role이라는 IAM Role이 인증서가 저장된 S3 버킷에 읽기 권한을 부여했기 때문에 파일 키에 정의된 파일을 생성할 때 외부 소스(S3 저장소)에서 가져올 수 있게된 것입니다. 이렇게 해서 우리는 애플리케이션 소스 번들에 인증서를 포함시키지 않고 EC2 인스턴스에서만 접근할 수 있는 S3 버킷에 인증서를 저장하고 사용할 수 있는 구성을 할 수 있게 되었습니다.</p><p>이 글을 보시는 분들이 인증서의 개인키와 같은 민감한 파일들을 애플리케이션 소스 번들에 포함하고 있다면 프라이빗 S3 저장소에 저장하여 더 안전한 방식으로 애플리케이션을 배포하는 것을 고려해보시기 바랍니다.</p><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 Elastic Beanstalk 구성 시 S3 프라이빗 저장소에서 파일을 받아오는 것을 알아보고자 합니다. 지난 &lt;a href=&quot;../tls-offload&quot;&gt;TLS 오프로드&lt;/a&gt;에서 Nginx </summary>
      
    
    
    
    
    <category term="S3" scheme="https://kdevkr.github.io/tags/S3/"/>
    
    <category term="Beanstalk" scheme="https://kdevkr.github.io/tags/Beanstalk/"/>
    
  </entry>
  
</feed>
