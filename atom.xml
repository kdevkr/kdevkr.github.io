<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Mambo</title>
  
  <subtitle>Today I Learned 🔥</subtitle>
  <link href="https://kdevkr.github.io/atom.xml" rel="self"/>
  
  <link href="https://kdevkr.github.io/"/>
  <updated>2024-08-07T14:07:29.521Z</updated>
  <id>https://kdevkr.github.io/</id>
  
  <author>
    <name>Mambo</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>유효성 검증</title>
    <link href="https://kdevkr.github.io/validation/"/>
    <id>https://kdevkr.github.io/validation/</id>
    <published>2024-08-07T13:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.521Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>서버 애플리케이션에서 좋은 REST API를 설계하는 것에는 잘못된 요청에 대해 유효성 검사를 포함하여 올바르게 예외를 처리하는 것도 포함됩니다.</p></blockquote><p>자바 애플리케이션에서 <strong>유효성 검증(Validation)</strong> 은 JSR-303 과 스프링 프레임워크에서 제공하는 추상화를 통해 쉽고 유연하게 유효성 검증을 수행할 수 있다. 아래의 스프링 부트 스타터를 추가하면 <strong>hibernate-validator</strong> 가 포함되어있다.</p><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">implementation <span class="token string">'org.springframework.boot:spring-boot-starter-validation'</span></code></pre><h4 id="올바르지-않은-요청에-대한-예외-목록"><a href="#올바르지-않은-요청에-대한-예외-목록" class="headerlink" title="올바르지 않은 요청에 대한 예외 목록"></a>올바르지 않은 요청에 대한 예외 목록</h4><p>유효성 검사를 포함하여 잘못된 요청에 대해서 발생하는 예외는 아래와 같다.</p><ul><li>MissingPathVariableException - 경로 변수가 지정된 파라미터가 없거나 경로 변수에 빈 값이 주어진 경우</li><li>MethodArgumentTypeMismatchException - 바인딩 데이터를 파라미터로 변환할 수 없는 경우</li><li>HttpMessageNotReadableException - 요청 바디를 올바르게 처리할 수 없는 경우</li><li>MissingServletRequestParameterException - 필수 파라미터가 포함되지 않은 경우</li><li>MethodArgumentNotValidException - 폼 데이터 또는 요청 바디가 유효성 검사에 통과하지 못한 경우</li><li>ConstraintViolationException - 경로 변수 또는 요청 파라미터가 유효성 검사에 통과하지 못한 경우</li><li>HttpRequestMethodNotSupportedException - 지원하지 않는 HTTP 함수로 요청한 경우</li></ul><blockquote><p>UnexpectedTypeException는 유효성 검사를 위해 잘못된 유형을 지정하였을 경우에 발생하므로 잘못된 요청이 아닌 서버 오류에 해당됩니다.<br>예를 들어, Integer 또는 Long과 같은 파라미터에 @NotBlank를 선언했을때 확인할 수 있습니다.</p></blockquote><h4 id="유효성-검사-예외-메시지를-확인하는-속성"><a href="#유효성-검사-예외-메시지를-확인하는-속성" class="headerlink" title="유효성 검사 예외 메시지를 확인하는 속성"></a>유효성 검사 예외 메시지를 확인하는 속성</h4><p>스프링 부트 애플리케이션에서 기본적인 오류 응답에 유효성 검사에 대한 메시지를 포함하여 확인하고 싶다면 아래와 같이 <code>server.error</code> 속성을 설정하면 된다.</p><pre class="language-yaml" data-language="yaml"><div class="caption"><span>application.yml</span></div><code class="language-yaml"><span class="token key atrule">server.error</span><span class="token punctuation">:</span>  <span class="token key atrule">include-exception</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">include-binding-errors</span><span class="token punctuation">:</span> always  <span class="token key atrule">include-message</span><span class="token punctuation">:</span> always  <span class="token key atrule">include-stacktrace</span><span class="token punctuation">:</span> never</code></pre><h4 id="Valid-그리고-Validated"><a href="#Valid-그리고-Validated" class="headerlink" title="Valid 그리고 Validated"></a>Valid 그리고 Validated</h4><p>기본적으로 JSR-303 표준의 유효성 검사를 위한 어노테이션은 @Valid 이다. REST API 뿐만 아니라 비즈니스 레이어에서도 유효성 검사를 수행하고 싶은 경우에는 @Validated를 활용하여야 한다. 또한, <strong>@Validated</strong>는 groups 속성을 통해 동일한 모델에 대해서 상황에 따라 유효성 검증 유무를 선택할 수 있어 더 유연하게 처리할 수 있다. <strong>PathVariable</strong> 과 <strong>RequestParam</strong> 에 대해서 유효성 검사를 수행하고자 하는 경우에는 @Validated를 컨트롤러 클래스에 추가해야한다.</p><h4 id="Cascaded-Validation"><a href="#Cascaded-Validation" class="headerlink" title="Cascaded Validation"></a>Cascaded Validation</h4><p>모델 빈 클래스에 하위 객체로 구성된 필드에 대해서 유효성 검증을 적용하고자하는 경우에는 필드에 <strong>@Valid</strong>를 선언하면 된다. 그렇지 않은 경우 하위 모델에 대해서는 기본적으로 유효성 검사를 자동으로 수행하지 않는다. 다음은 리스트로 구성된 필드에 개별 유효성 검사를 수행하는 케이스를 보여준다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Account</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@NotBlank</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>    <span class="token annotation punctuation">@NotBlank</span>    <span class="token annotation punctuation">@Size</span><span class="token punctuation">(</span>min <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token annotation punctuation">@Valid</span> <span class="token class-name">Contact</span><span class="token operator">></span> contacts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Data</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Contact</span> <span class="token punctuation">&#123;</span>        <span class="token annotation punctuation">@Size</span><span class="token punctuation">(</span>max <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">)</span>        <span class="token annotation punctuation">@NotEmpty</span>        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>        <span class="token annotation punctuation">@Email</span>        <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>        <span class="token annotation punctuation">@Pattern</span><span class="token punctuation">(</span>regexp <span class="token operator">=</span> <span class="token string">"^\\+?[1-9]\\d&#123;0,2&#125;[\\s\\d]&#123;1,14&#125;$"</span><span class="token punctuation">)</span> <span class="token comment">// NOTE: E.164</span>        <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="ConstraintValidator"><a href="#ConstraintValidator" class="headerlink" title="ConstraintValidator"></a>ConstraintValidator</h4><p>JSR-303 또는 JSR-380 표준의 어노테이션으로 커버하지 못하는 입력값에 대한 유효성 검증을 위해서 <strong>ConstraintValidator</strong> 인터페이스를 구현하여 시스템 요구사항에 맞는 유효성 검증을 수행할 수 있도록 구현할 수 있다. 예를 들어, 앞선 예시에서는 전화번호 입력 필드에 대해서 E.164를 검증하기 위해서 정규식을 사용했지만 더 유연하게 입력할 수 있도록 지원하기 위해서 <a href="https://github.com/google/libphonenumber">google&#x2F;libphonenumber</a>에서 제공하는 유틸을 사용한 유효성 검증을 구현할 수 있다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Documented</span><span class="token annotation punctuation">@Constraint</span><span class="token punctuation">(</span>validatedBy <span class="token operator">=</span> <span class="token class-name">PhoneConstraintValidator</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">FIELD</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">ANNOTATION_TYPE</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">CONSTRUCTOR</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">PARAMETER</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE_USE</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Phone</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> <span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"Invalid E.164 format: '$&#123;validatedValue&#125;'"</span><span class="token punctuation">;</span>    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">groups</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Payload</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PhoneConstraintValidator</span> <span class="token keyword">implements</span> <span class="token class-name">ConstraintValidator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Phone</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">Phone</span> constraintAnnotation<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ConstraintValidator</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>constraintAnnotation<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isValid</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">ConstraintValidatorContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">PhoneNumberUtil</span> phoneUtil <span class="token operator">=</span> <span class="token class-name">PhoneNumberUtil</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Phonenumber<span class="token punctuation">.</span>PhoneNumber</span> number <span class="token operator">=</span> phoneUtil<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">Phonenumber<span class="token punctuation">.</span>PhoneNumber<span class="token punctuation">.</span>CountryCodeSource</span><span class="token punctuation">.</span><span class="token constant">UNSPECIFIED</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> phoneUtil<span class="token punctuation">.</span><span class="token function">isPossibleNumber</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="유효성-검증-예외에-대한-오류-처리"><a href="#유효성-검증-예외에-대한-오류-처리" class="headerlink" title="유효성 검증 예외에 대한 오류 처리"></a>유효성 검증 예외에 대한 오류 처리</h4><p>유효성 검증 실패 시 데이터 바인딩 방식과 유효성 검증 어노테이션에 따라 예외가 발생한다. <strong>ExceptionHandler</strong>를 통해 공통 오류 응답을 구현하고자 한다면 최소한 <strong>ConstraintViolationException</strong>과 <strong>MethodArgumentNotValidException</strong> 에 대해서는 유효성 검사에 대한 메시지가 올바르게 포함되도록 작성하도록 하자.</p><ul><li>PathVariable, RequestParam + Validated → ConstraintViolationException</li><li>RequestBody + Validated → MethodArgumentNotValidException</li></ul><h4 id="참고-링크"><a href="#참고-링크" class="headerlink" title="참고 링크"></a>참고 링크</h4><ul><li><a href="https://jakarta.ee/specifications/bean-validation/3.0/jakarta-bean-validation-spec-3.0.html">Jakarta Bean Validation specification</a></li><li><a href="https://meetup.nhncloud.com/posts/223">Validation 어디까지 해봤니?</a></li><li><a href="https://www.baeldung.com/spring-valid-vs-validated">Differences in @Valid and @Validated Annotations in Spring</a></li><li><a href="https://www.youtube.com/watch?v=GdKuxmtA65I">Bean Validation 2.0 - you’ve put your annotations everywhere! by Gunnar Morling</a></li><li><a href="https://www.baeldung.com/java-validation">Java Bean Validation Basics</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;서버 애플리케이션에서 좋은 REST API를 설계하는 것에는 잘못된 요청에 대해 유효성 검사를 포함하여 올바르게 예외를 처리하는 것도 포함됩니다.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;자바 애플리케이션에서 &lt;strong&gt;유</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>뉴렐릭 인프라 에이전트 설치가 되지 않을때</title>
    <link href="https://kdevkr.github.io/install-newrelic-infra-agent/"/>
    <id>https://kdevkr.github.io/install-newrelic-infra-agent/</id>
    <published>2024-08-01T13:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.513Z</updated>
    
    <content type="html"><![CDATA[<p><img data-src="/images/posts/install-newrelic-infra-agent/01.png"></p><p>뉴렐릭은 무료 플랜을 제공하는 SaaS APM 솔루션으로 웹 UI에서 원하는 에이전트를 쉽게 설치할 수 있도록 명령어를 제공하고 있다. 그런데, 아래와 같이 gzip 관련 명령어가 수행될 때 오류가 발생하는 것을 경험할 수 있다.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-Ls</span> https://download.newrelic.com/install/newrelic-cli/scripts/install.sh <span class="token operator">|</span> <span class="token function">bash</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token assign-left variable">NEW_RELIC_API_KEY</span><span class="token operator">=</span>NRAK-XXXX <span class="token assign-left variable">NEW_RELIC_ACCOUNT_ID</span><span class="token operator">=</span>45XXXXX /usr/local/bin/newrelic <span class="token function">install</span>Installing New Relic CLI v0.92.0gzip: stdin: unexpected end of <span class="token function">file</span>tar: Child returned status <span class="token number">1</span>tar: Error is not recoverable: exiting nowAn error occurred installing the tool.The contents of the directory /tmp/tmp.ROXuwOdosK have been left <span class="token keyword">in</span> place to <span class="token builtin class-name">help</span> to debug the issue.</code></pre><p>위와 같은 오류가 발생하는 경우의 원인은 루트 권한으로 수행하지 않았기 때문이며 루트 계정으로 사용자를 전환하여 설치하도록 하자.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">su</span> -<span class="token function">curl</span> <span class="token parameter variable">-Ls</span> https://download.newrelic.com/install/newrelic-cli/scripts/install.sh <span class="token operator">|</span> <span class="token function">bash</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token assign-left variable">NEW_RELIC_API_KEY</span><span class="token operator">=</span>NRAK-XXXX <span class="token assign-left variable">NEW_RELIC_ACCOUNT_ID</span><span class="token operator">=</span>45XXXXX /usr/local/bin/newrelic <span class="token function">install</span>Installing New Relic CLI v0.92.0Installing to /usr/local/bin<span class="token punctuation">..</span>.</code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img data-src=&quot;/images/posts/install-newrelic-infra-agent/01.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;뉴렐릭은 무료 플랜을 제공하는 SaaS APM 솔루션으로 웹 UI에서 원하는 에이전트를 쉽게 설치할 수 있도록 명</summary>
      
    
    
    
    
    <category term="Newrelic CLI" scheme="https://kdevkr.github.io/tags/Newrelic-CLI/"/>
    
    <category term="Infrastructure Agent" scheme="https://kdevkr.github.io/tags/Infrastructure-Agent/"/>
    
  </entry>
  
  <entry>
    <title>2차 인증 설정을 위한 QR 코드</title>
    <link href="https://kdevkr.github.io/mfa-qrcode/"/>
    <id>https://kdevkr.github.io/mfa-qrcode/</id>
    <published>2024-07-20T03:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.513Z</updated>
    
    <content type="html"><![CDATA[<p>오늘은 2차 인증 설정 과정에서 OTP 앱으로 스캔할 수 있도록 코드 대신에 제공하는 QR 코드에 대해서 알아보려고 한다.</p><h4 id="RFC-6238"><a href="#RFC-6238" class="headerlink" title="RFC 6238"></a>RFC 6238</h4><p>Google Authenticator, Microsoft Authenticator 그리고 Authy와 같은 OTP 인증 앱들은 <a href="https://datatracker.ietf.org/doc/html/rfc6238">RFC6238</a>로 정의된 TOTP 표준에 따라 구현되어있고 QR 코드에 포함되는 텍스트는 <a href="https://github.com/google/google-authenticator/wiki/Key-Uri-Format">Key Uri Format</a>로 구성되어야 읽을 수 있다.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># otpauth://TYPE/LABEL?PARAMETERS</span>otpauth://totp/Mambo:kdevkr@email.com?secret<span class="token operator">=</span>HXDMVJECJJWSRB3HWIZR4IFUGFTMXBOZ<span class="token operator">&amp;</span><span class="token assign-left variable">issuer</span><span class="token operator">=</span>Mambo<span class="token operator">&amp;</span><span class="token assign-left variable">algorithm</span><span class="token operator">=</span>SHA1<span class="token operator">&amp;</span><span class="token assign-left variable">digits</span><span class="token operator">=</span><span class="token number">6</span><span class="token operator">&amp;</span><span class="token assign-left variable">period</span><span class="token operator">=</span><span class="token number">30</span></code></pre><h4 id="TOTP-QR-코드-이미지-만들기"><a href="#TOTP-QR-코드-이미지-만들기" class="headerlink" title="TOTP QR 코드 이미지 만들기"></a>TOTP QR 코드 이미지 만들기</h4><p>QR 코드 이미지를 만들기 위해서 <a href="https://github.com/samdjstevens/java-totp">java-totp</a> 라이브러리를 사용하려고 한다. 이 라이브러리는 비밀키 발급부터 QR 코드를 HTML에서 사용하기 위한 <a href="https://developer.mozilla.org/ko/docs/Web/HTTP/Basics_of_HTTP/Data_URLs">Data URI</a>로 변환하는 <strong>Utils.getDataUriForImage</strong> 함수도 제공해주고 있다.</p><pre class="language-groovy" data-language="groovy"><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    implementation <span class="token string">'dev.samstevens.totp:totp:1.7.1'</span>    implementation <span class="token string">'com.google.zxing:javase:3.5.3'</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">SecretGenerator</span> secretGenerator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSecretGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> secret <span class="token operator">=</span> secretGenerator<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">QrData</span> qrData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QrData<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">label</span><span class="token punctuation">(</span><span class="token string">"kdevkr@gmail.com"</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">secret</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">issuer</span><span class="token punctuation">(</span><span class="token string">"Mambo"</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">algorithm</span><span class="token punctuation">(</span><span class="token class-name">HashingAlgorithm</span><span class="token punctuation">.</span><span class="token constant">SHA1</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">digits</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">period</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ZxingPngQrGenerator</span> qrGenerator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZxingPngQrGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>qrGenerator<span class="token punctuation">.</span><span class="token function">setImageSize</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> qrImageBytes <span class="token operator">=</span> qrGenerator<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>qrData<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> qrDataUri <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">getDataUriForImage</span><span class="token punctuation">(</span>qrImageBytes<span class="token punctuation">,</span> qrGenerator<span class="token punctuation">.</span><span class="token function">getImageMimeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>qrDataUri<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p><a href="https://zxing.org/w/decode.jspx">Zxing Decoder Online</a>을 사용하여 올바르게 이미지가 만들어졌는지 <a href="https://zxing.org/w/decode?u=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPoAAAD6AQAAAACgl2eQAAACoUlEQVR4Xu2YTW6rUAyFHWXAMEtgJ2VjSInExmAnLIEhA4Tf+Wzy01bqNNZT7oCSm68Sdo6PfTH/e432c+fH+gC5PkCuKsBmWn1r3WLWTD7MPl5uLZttIUB/l6sLuHrjPrhPeccXdQA7LX27fumxAeZmWnQ3KrJygJ3c57VbevPdFEVFAClsFsBql6EegB7m9eQ302UzfXf+LZg3A1lZUsHr5XfpvRU4lhFFArvK/9itAiiK7v7Y+m5rV7OzjOqphxJAM17c49mRwuyUv4IaHlEUAMLoW98vnvYkQB4wLedSQIPHW6fPbIuSMpDHPdUFAPSq8pcHqG86yvhS5uVW9yhqAOth9NE8e4xqwKOeUbwf2BCAcbnOyrcyrwlEqWavEKDcantCFNyF5Tsf6wCuZ9dvv3YYAeUVyojmWQjgt48x04/mia96Wn4VQG5/H+NU/sj3tDDaXfjfMkDLrG7olfKXVEd1J/82JpUATGOS9CoV6E5B6fKt9AoAWVm7nl1ZPmP56pumvUqASkktfY9SypYUHVRoGSBWDkf4vkQxUWih4TLAlueLzK2kKqPSIUhBvfwWFYBOzytAJ0ltM3wModxnFG8HnAmz51Sh8uqUatyeDnU30hqAKn8gt7c8nVNZNKdKQNonwxF6yPIy7h56KADQgzzOFzGGKBTyrQurCrCR2z67OVNxNCdmpUpABDAwK13x0A1RXOVWGpILATPdkntewfAeYcQDYq8OwNrIMlKV5TuhHPKtAuQTZ6p9j6kuPOrZWCsArfNGS41IY2aHPTGBMHqWAjjzkuDjjZGOFvSlh2jLAL0uhzPNAegrhVINUF+6GaMn5s9oVwzwtE9CifJXm/fmpbIqABbb0kO8wDTGpBtttBLw5/oAuT5Arv8E+AcOAIqU2Few9gAAAABJRU5ErkJggg==">확인</a>해볼 수 있습니다.</p></blockquote><h4 id="보안-이슈"><a href="#보안-이슈" class="headerlink" title="보안 이슈"></a>보안 이슈</h4><p>2차 인증 설정을 위해서 제공하는 QR 코드에는 암호화되지 않은 상태의 보안키가 포함되어있다. 서드 파티인 OTP 앱은 QR 코드를 스캔하여 포함된 텍스트에서 정보를 추출해야하므로 보안키를 암호화 할수는 없다. 아래와 같이 <a href="https://github.com/j256/two-factor-auth/blob/d28c4da7cbe593774a7420a86257b803b67c8f5a/src/main/java/com/j256/twofactorauth/TimeBasedOneTimePasswordUtil.java#L474-L480">two-factor-auth</a>처럼 QR 코드 이미지 생성을 위해서 외부 주소에 의존하는 것은 좋지 않다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">qrImageUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyId<span class="token punctuation">,</span> <span class="token class-name">String</span> secret<span class="token punctuation">,</span> <span class="token keyword">int</span> numDigits<span class="token punctuation">,</span> <span class="token keyword">int</span> imageDimension<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"https://chart.googleapis.com/chart?chs="</span> <span class="token operator">+</span> imageDimension <span class="token operator">+</span> <span class="token string">"x"</span> <span class="token operator">+</span> imageDimension <span class="token operator">+</span> <span class="token string">"&amp;cht=qr&amp;chl="</span>            <span class="token operator">+</span> imageDimension <span class="token operator">+</span> <span class="token string">"x"</span> <span class="token operator">+</span> imageDimension <span class="token operator">+</span> <span class="token string">"&amp;chld=M|0&amp;cht=qr&amp;chl="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">addOtpAuthPart</span><span class="token punctuation">(</span>keyId<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> sb<span class="token punctuation">,</span> numDigits<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>구글에서 QR 이미지 생성을 제공했던 주소는 제거되었고 대체할 수 있는 주소가 있지만 외부 주소에 보안키를 전달하는 것은 권장하지 않습니다.</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;오늘은 2차 인증 설정 과정에서 OTP 앱으로 스캔할 수 있도록 코드 대신에 제공하는 QR 코드에 대해서 알아보려고 한다.&lt;/p&gt;
&lt;h4 id=&quot;RFC-6238&quot;&gt;&lt;a href=&quot;#RFC-6238&quot; class=&quot;headerlink&quot; title=&quot;</summary>
      
    
    
    
    
    <category term="2FA" scheme="https://kdevkr.github.io/tags/2FA/"/>
    
    <category term="TOTP" scheme="https://kdevkr.github.io/tags/TOTP/"/>
    
    <category term="QRCode" scheme="https://kdevkr.github.io/tags/QRCode/"/>
    
  </entry>
  
  <entry>
    <title>패스키 로그인 고도화</title>
    <link href="https://kdevkr.github.io/passkey-login-advanced/"/>
    <id>https://kdevkr.github.io/passkey-login-advanced/</id>
    <published>2024-07-15T14:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.513Z</updated>
    
    <content type="html"><![CDATA[<h4 id="패스키-생성-알고리즘"><a href="#패스키-생성-알고리즘" class="headerlink" title="패스키 생성 알고리즘"></a>패스키 생성 알고리즘</h4><p>패스키 등록 시 PublicKeyCredentialCreationOptions의 pubKeyCredParams 를 통해 RP 서버에서 선호하는 공개키 알고리즘 목록을 제공할 수 있는데요. 이때 공개키 알고리즘 목록에는 ES256과 RS256은 반드시 포함하는게 좋습니다. 그 이유는 <a href="https://github.com/w3c/webauthn/issues/1757#issuecomment-1169035781">대부분 ES256를 지원하고 일부는 RS256를 지원</a>한다고 하기 때문입니다.</p><h4 id="패스키-제공업체-표시"><a href="#패스키-제공업체-표시" class="headerlink" title="패스키 제공업체 표시"></a>패스키 제공업체 표시</h4><p><a href="https://web.dev/articles/webauthn-aaguid?hl=ko">Determine the passkey provider with AAGUID</a>에서 소개하는 <a href="https://github.com/passkeydeveloper/passkey-authenticator-aaguids">Passkey Provider AAGUIDs</a>에는 일부 인증 기기에 대한 이름과 아이콘 정보를 포함하고 있습니다. <a href="https://passkeydeveloper.github.io/passkey-authenticator-aaguids/explorer/">Passkeys Authenticator AAGUID Explorer</a>를 살펴보면 대부분의 사용자는 주로 아래의 인증 기기를 사용할 것 같습니다.</p><table><thead><tr><th>Authenticator</th><th>AAGUID</th></tr></thead><tbody><tr><td>Google Password Manager</td><td>ea9b8d66-4d01-1d21-3ce4-b6b48cb575d4</td></tr><tr><td>Chrome on Mac</td><td>adce0002-35bc-c60a-648b-0b25f1f05503</td></tr><tr><td>iCloud Keychain</td><td>fbfc3007-154e-4ecc-8c0b-6e020557d7bd</td></tr><tr><td>Samsung Pass</td><td>53414d53-554e-4700-0000-000000000000</td></tr></tbody></table><h5 id="AAGUID-UUID-문자열"><a href="#AAGUID-UUID-문자열" class="headerlink" title="AAGUID UUID 문자열"></a>AAGUID UUID 문자열</h5><p><a href="https://github.com/Yubico/java-webauthn-server">java-webauthn-server</a> 라이브러리의 AAGUID 클래스를 통해 ByteArray로 구성된 aaguid를 RFC4122 표준의 UUID 형식의 문자열로 변환하여 저장할 수 있습니다. 패스키 등록 이후에 변하지 않는 항목이므로 패스키 등록 과정에서 Base64URL 보다는 UUID 형태로 저장해두는게 프론트엔드에서 사용하기에는 더 편할 것 같네요. 아래와 같이 AAGUID의 asGuidString 함수를 호출해서 가져올 수 있습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">RegistrationResult</span> result <span class="token operator">=</span> relyingParty<span class="token punctuation">.</span><span class="token function">finishRegistration</span><span class="token punctuation">(</span>        <span class="token class-name">FinishRegistrationOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>publicKeyCredentialCreationOptions<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span>publicKeyCredential<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> aaguid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AAGUID</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getAaguid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asGuidString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="패스키-식별-가능한-이름-설정"><a href="#패스키-식별-가능한-이름-설정" class="headerlink" title="패스키 식별 가능한 이름 설정"></a>패스키 식별 가능한 이름 설정</h4><p><img data-src="/images/posts/passkey-login/02.png"></p><p>위 화면은 깃허브에서 패스키 등록 시 패스키에 대한 이름을 입력하도록 요구하는 단계입니다. 이와 같이 패스키 등록 시 사용자에게 등록하려는 인증 기기에 대한 이름을 입력하도록 요구하거나 사용자에게 기기에 대한 이름을 별도로 입력하지 않고 <strong>Authenticator 1</strong> 과 같이 현재 등록된 기기의 수를 토대로 기본값을 제공하고 사용자가 별도로 이름을 수정할 수 있도록 하는게 좋습니다.</p><h4 id="패스키-등록-수-제한"><a href="#패스키-등록-수-제한" class="headerlink" title="패스키 등록 수 제한"></a>패스키 등록 수 제한</h4><p>일반적으로 패스키로 등록할 수 있는 기기에 대한 제약은 필요하지 않습니다만 사용자가 너무 많은 패스키를 등록하는 것은 오히려 보안 상 좋지 않을 수 있습니다. 기본적으로 사용자에 대한 패스키는 10개 이내로 제한하고 정말로 사용자가 요구할 때 확장하는 것을 권장합니다. 예를 들어, 저와 같은 사용자는 삼성 갤럭시 스마트폰의 삼성 패스만 사용하여 패스키를 등록할 수 있습니다.</p><p><a href="https://www.corbado.com/assets/Passkeys-Developer-Cheatsheet.pdf">Passkeys Cheat Sheet for Developers</a>에서 사용자에게 더 나은 패스키를 제공하기 위한 방법에 대해서 찾아보세요.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;패스키-생성-알고리즘&quot;&gt;&lt;a href=&quot;#패스키-생성-알고리즘&quot; class=&quot;headerlink&quot; title=&quot;패스키 생성 알고리즘&quot;&gt;&lt;/a&gt;패스키 생성 알고리즘&lt;/h4&gt;&lt;p&gt;패스키 등록 시 PublicKeyCredentialCreati</summary>
      
    
    
    
    
    <category term="Passkey" scheme="https://kdevkr.github.io/tags/Passkey/"/>
    
    <category term="WebAuthn" scheme="https://kdevkr.github.io/tags/WebAuthn/"/>
    
  </entry>
  
  <entry>
    <title>패스키 로그인</title>
    <link href="https://kdevkr.github.io/passkey-login/"/>
    <id>https://kdevkr.github.io/passkey-login/</id>
    <published>2024-07-14T03:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.513Z</updated>
    
    <content type="html"><![CDATA[<p>패스키 로그인은 사용자 계정에 대한 비밀번호를 입력하지 않고 사용자 계정에 대해 지문이나 얼굴 인식 그리고 보안키 등을 사용해서 미리 인증 정보를 등록해놓고 사용자의 인증 기기를 사용해서 로그인을 수행하도록 제공하는 걸 말합니다. 패스키는 로그인 뿐만 아니라 <a href="https://aws.amazon.com/ko/about-aws/whats-new/2024/06/aws-identity-access-management-passkey-authentication-factor/?nc1=h_ls">아마존 웹 서비스</a>와 <a href="https://docs.github.com/ko/authentication/authenticating-with-a-passkey/signing-in-with-a-passkey">깃허브</a>처럼 2차 인증을 위해서도 도입될 수 있습니다. 이 글을 작성해보는 이유는 패스키 로그인에 대한 흐름은 생각보다 간단한데 패스키에 대한 표준에서 사용되는 용어와 구현 과정에서의 여러가지 이슈들이 많아보이기 때문입니다. 이제 패스키 로그인에 대해서 정리해보도록 하죠.</p><h4 id="패스키-로그인에서-등록과-인증의-흐름"><a href="#패스키-로그인에서-등록과-인증의-흐름" class="headerlink" title="패스키 로그인에서 등록과 인증의 흐름"></a>패스키 로그인에서 등록과 인증의 흐름</h4><p>패스키 로그인 시 등록과 인증 과정은 생각보다 간단합니다. 사용자는 본인이 사용할 수 있는 인증 기기에 발급한 패스키 정보를 RP 도메인에 대한 패스키를 등록하고 로그인 화면에서 시스템에서 제공하는 패스키 로그인을 사용해 인증 기기에 존재하는 패스키를 선택하여 사용자 계정에 대한 인증을 요청하고 승인받아 로그인을 완료합니다. 패스키를 등록하고 인증하는 과정에서 서버에서 제공받은 챌린지와 공개키에 대한 서명 정보를 제공함으로써 패스키를 사용하여 로그인을 지원하는 서버에서는 사용자에 대한 신원을 안전하게 증명(Attestation) 또는 검증(Assertion)할 수 있습니다. </p><blockquote><p>패스키 관련 표준에서 등록(Registration)과 인증(Authentication)에 대한 과정은 단순한 인증 과정이 아니라 하나의 중요한 의식이라는 관점으로 <strong>세레모니(Ceremony)</strong> 라고 표현합니다. 따라서, 패스키에 대한 여러가지 정보를 참고할 때 세레모니라는 단어가 나오면 과정이라고 이해하시면 됩니다.</p></blockquote><h4 id="패스키-등록을-위한-서비스-제공자"><a href="#패스키-등록을-위한-서비스-제공자" class="headerlink" title="패스키 등록을 위한 서비스 제공자"></a>패스키 등록을 위한 서비스 제공자</h4><p>패스키를 통해 신원을 관리하고 검증하는 주체인 서비스 제공자는 신뢰당사자(Relyting Party)라고 합니다. RP는 도메인을 의미하며 패스키 등록과 인증을 요청할때마다 챌린지(Challenge)를 받아가도록 요구합니다. RP에서 응답하는 챌린지는 난수로 이루어진 바이트 배열로 알수없는 식별자로 CSRF 토큰과 비슷한 용도로 사용됩니다. 또한, RP에 대한 아이디는 도메인으로 구성되기 때문에 클라이언트로부터 전달되는 패스키에 대한 공개키 인증 정보가 올바른 출처에 있음을 쉽게 확인할 수 있게 됩니다. 그러면 자바 애플리케이션 서버에서 RP를 구성해보도록 할까요?</p><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    implementation <span class="token string">'com.yubico:webauthn-server-core:2.5.2'</span>    implementation <span class="token string">'com.yubico:webauthn-server-attestation:2.5.2'</span>    implementation <span class="token string">'com.yubico:yubico-util:2.5.2'</span><span class="token punctuation">&#125;</span></code></pre><p>먼저, 자바 애플리케이션에서 WebAuthn에 대한 Relyting Party를 구성하기 위해서 <a href="https://developers.yubico.com/java-webauthn-server/">java-webauthn-server</a> 라이브러리를 의존성에 추가해야합니다. 그리고 아래와 같이 RelyingPartyIdentity로 RP 도메인에 대한 신원을 정의하고 RelyingParty를 초기화하면 됩니다. CredentialRepository 는 패스키 등록과 인증 과정에서 이미 등록된 패스키 정보를 제공하기 위한 용도로 사용됩니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">RelyingParty</span> <span class="token function">generateRelyingParty</span><span class="token punctuation">(</span><span class="token class-name">PasskeyCredentialRepository</span> passkeyCredentialRepository<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">RelyingPartyIdentity</span> rpID <span class="token operator">=</span> <span class="token class-name">RelyingPartyIdentity</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">"kdev.ing"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"Mambo App"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token class-name">RelyingParty</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span>rpID<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">credentialRepository</span><span class="token punctuation">(</span>passkeyCredentialRepository<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">allowOriginSubdomain</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">origins</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"https://kdev.ing"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h5 id="🔥-SecurityError-The-RP-ID-“mambo”-is-invalid-for-this-domain"><a href="#🔥-SecurityError-The-RP-ID-“mambo”-is-invalid-for-this-domain" class="headerlink" title="🔥 SecurityError: The RP ID “mambo” is invalid for this domain"></a>🔥 SecurityError: The RP ID “mambo” is invalid for this domain</h5><pre class="language-bash" data-language="bash"><code class="language-bash">SecurityError: The RP ID <span class="token string">"mambo"</span> is invalid <span class="token keyword">for</span> this domain    at identifyAuthenticationError <span class="token punctuation">(</span>@simplewebauthn_browser.js?v<span class="token operator">=</span>db6ca826:278:14<span class="token punctuation">)</span>    at startAuthentication <span class="token punctuation">(</span>@simplewebauthn_browser.js?v<span class="token operator">=</span>db6ca826:325:11<span class="token punctuation">)</span>    Caused by: DOMException: The relying party ID is not a registrable domain suffix of, nor equal to the current domain.</code></pre><p>RP 서버에 대한 아이디는 WebAuthn 표준에 따라 반드시 도메인으로 구성되어야합니다. 그렇지 않은 경우 위와 같이 클라이언트 오류가 발생할 수 있습니다.</p><h5 id="RelyingParty-generateChallenge"><a href="#RelyingParty-generateChallenge" class="headerlink" title="RelyingParty.generateChallenge"></a>RelyingParty.generateChallenge</h5><p>RelyingParty의 startRegistartion 를 통해 패스키 등록에 대한 챌린지와 공개키 생성 옵션을 클라이언트에게 제공할 수 있는데 이때 포함되는 챌린지는 RelyingParty에 32바이트로 구성된 난수로 이루어진 바이트 배열로 구현되어있습니다.</p><pre class="language-java" data-language="java"><div class="caption"><span>RelyingParty.java</span></div><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">SecureRandom</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ByteArray</span> <span class="token function">generateChallenge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    random<span class="token punctuation">.</span><span class="token function">nextBytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ByteArray</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="패스키-등록을-위한-생성-옵션-발급"><a href="#패스키-등록을-위한-생성-옵션-발급" class="headerlink" title="패스키 등록을 위한 생성 옵션 발급"></a>패스키 등록을 위한 생성 옵션 발급</h4><p>RelyingParty의 startRegistration 매개변수에 StartRegistrationOptions를 전달함으로써 패스키 등록 시 사용될 챌린지와 생성 옵션인 PublicKeyCredentialCreationOptions를 만들 수 있습니다. PublicKeyCredentialCreationOptions의 toCredentialsCreateJson 함수는 RP 서버에서 클라이언트로 응답할 때 바이트 배열로 이루어져야하는 항목에 대해 Base64URL을 적용한 JSON으로 구성되도록 구현되어있으므로 쉽게 응답할 수 있습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">createUserHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchAlgorithmException</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> userHandle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token class-name">SecureRandom</span><span class="token punctuation">.</span><span class="token function">getInstanceStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextBytes</span><span class="token punctuation">(</span>userHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> userHandle<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/registration/challenge"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">startRegistration</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> httpSession<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">UserIdentity</span> userIdentity <span class="token operator">=</span> <span class="token class-name">UserIdentity</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"mambo"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">displayName</span><span class="token punctuation">(</span><span class="token string">"Mambo"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArray</span><span class="token punctuation">(</span><span class="token function">createUserHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">PublicKeyCredentialCreationOptions</span> publicKeyCredentialCreationOptions <span class="token operator">=</span> rp<span class="token punctuation">.</span><span class="token function">startRegistration</span><span class="token punctuation">(</span>                <span class="token class-name">StartRegistrationOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>userIdentity<span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">authenticatorSelection</span><span class="token punctuation">(</span><span class="token class-name">AuthenticatorSelectionCriteria</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                <span class="token punctuation">.</span><span class="token function">residentKey</span><span class="token punctuation">(</span><span class="token class-name">ResidentKeyRequirement</span><span class="token punctuation">.</span><span class="token constant">REQUIRED</span><span class="token punctuation">)</span>                                <span class="token punctuation">.</span><span class="token function">authenticatorAttachment</span><span class="token punctuation">(</span><span class="token class-name">AuthenticatorAttachment</span><span class="token punctuation">.</span><span class="token constant">CROSS_PLATFORM</span><span class="token punctuation">)</span>                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpSession<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"publicKeyCredentialCreationOptions"</span><span class="token punctuation">,</span> publicKeyCredentialCreationOptions<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> publicKeyCredentialCreationOptions<span class="token punctuation">.</span><span class="token function">toCredentialsCreateJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>UserIdentity의 id는 공개키 인증 정보에 포함되는 User Handle과 동일합니다. 패스키 표준에서는 사용자 계정에 대한 식별자를 그대로 이용하지 않고 별도로 난수로 이루어진 식별자를 사용하도록 요구하고 있습니다. 사용자 계정에 대해 유일한 식별자로 생성하는 로직을 구현하도록 하세요.</p></blockquote><h5 id="simplewebauthn-browser-startRegistration"><a href="#simplewebauthn-browser-startRegistration" class="headerlink" title="@simplewebauthn&#x2F;browser.startRegistration"></a>@simplewebauthn&#x2F;browser.startRegistration</h5><p>클라이언트에서는 아래와 같이 패스키 등록을 위해 챌린지를 요청하고 받은 결과를 startRegistartion의 매개변수에 전달함으로써 사용자에게 패스키 등록에 대한 대화상자를 표시해주고 전달받은 결과를 서버에 전달함으로써 패스키 등록을 완료하는 로직을 구현할 수 있습니다. 아래의 코드는 이미 등록된 패스키에 대한 오류에 대한 예외 처리가 없으므로 여러가지 예외 상황을 확인하고 알맞게 처리하도록 구현해야합니다.</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">registerPasskey</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> challenge  <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/registration/challenge'</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> registrationResponse <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">startRegistration</span><span class="token punctuation">(</span>challenge<span class="token punctuation">.</span>data<span class="token punctuation">.</span>publicKey<span class="token punctuation">)</span>    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/registration/verify'</span><span class="token punctuation">,</span> registrationResponse<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></code></pre><h4 id="패스키-검증-및-등록"><a href="#패스키-검증-및-등록" class="headerlink" title="패스키 검증 및 등록"></a>패스키 검증 및 등록</h4><p>Relying Party의 finishRegistartion 함수를 통해 클라이언트에서 전달한 패스키 정보가 올바르게 서명되어있는지를 검증하고 전달받은 정보에서 일부 항목을 패스키에 대한 데이터베이스에 저장하면 됩니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/registration/verify"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">finishRegistration</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> httpSession<span class="token punctuation">,</span>                                  <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">String</span> credential<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RegistrationFailedException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> credentialsCreateJson <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> httpSession<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"publicKeyCredentialCreationOptions"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpSession<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">"publicKeyCredentialCreationOptions"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">PublicKeyCredentialCreationOptions</span> publicKeyCredentialCreationOptions <span class="token operator">=</span>            <span class="token class-name">PublicKeyCredentialCreationOptions</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>credentialsCreateJson<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">PublicKeyCredential</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthenticatorAttestationResponse</span><span class="token punctuation">,</span> <span class="token class-name">ClientRegistrationExtensionOutputs</span><span class="token punctuation">></span></span> publicKeyCredential <span class="token operator">=</span>            <span class="token class-name">PublicKeyCredential</span><span class="token punctuation">.</span><span class="token function">parseRegistrationResponseJson</span><span class="token punctuation">(</span>credential<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">RegistrationResult</span> result <span class="token operator">=</span> relyingParty<span class="token punctuation">.</span><span class="token function">finishRegistration</span><span class="token punctuation">(</span>            <span class="token class-name">FinishRegistrationOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>publicKeyCredentialCreationOptions<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span>publicKeyCredential<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ByteArray</span> aaguid <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getAaguid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ByteArray</span> credentialId <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getKeyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ByteArray</span> userHandle <span class="token operator">=</span> publicKeyCredentialCreationOptions<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ByteArray</span> publicKey <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getPublicKeyCose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transports <span class="token operator">=</span> publicKeyCredential<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransports</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">AuthenticatorTransport</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> signatureCounter <span class="token operator">=</span> publicKeyCredential<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttestation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthenticatorData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSignatureCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Authenticator</span> authenticator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Authenticator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setCredentialId</span><span class="token punctuation">(</span>credentialId<span class="token punctuation">.</span><span class="token function">getBase64Url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setUserHandle</span><span class="token punctuation">(</span>userHandle<span class="token punctuation">.</span><span class="token function">getBase64Url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setAaguid</span><span class="token punctuation">(</span>aaguid<span class="token punctuation">.</span><span class="token function">getBase64Url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setPublicKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">.</span><span class="token function">getBase64Url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setSignatureCount</span><span class="token punctuation">(</span>signatureCounter<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setTransports</span><span class="token punctuation">(</span>transports<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setLastAccessTime</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setCreatedAt</span><span class="token punctuation">(</span><span class="token class-name">OffsetDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> authenticatorRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>authenticator<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h5 id="계정-설정-내-패스키-표시"><a href="#계정-설정-내-패스키-표시" class="headerlink" title="계정 설정 내 패스키 표시"></a>계정 설정 내 패스키 표시</h5><p>패스키 등록 시 서버에 저장된 정보에는 사용자 친화적으로 표시할 수 있는 정보가 포함되어있지 않습니다. <a href="https://developers.google.com/identity/passkeys/ux/communicating-passkeys?hl=ko#what_information_to_use_to_create_a_passkey">패스키를 만드는 데 사용할 정보</a>나 <a href="https://developers.google.com/identity/passkeys/ux/user-interface-design?hl=ko">계정 설정 내 패스키 카드 표시</a>와 같은 정보들을 참고하여 패스키에 대해 아래와 같은 항목이 포함되도록 설계하는 것이 좋습니다.</p><ul><li>패스키에 대해 표시할 이름 (Nickname)</li><li>패스키가 마지막으로 사용된 시간 (Last Access Time)</li><li>패스키 인증 기기 유형 (AAGUID)</li></ul><p>패스키에 대해 표시할 이름을 설정하는 건 필수 사항은 아니지만 깃허브에서의 패스키 관리 시 이름을 설정할 수 있게 제공하는데 사용자 스스로 구분할 수 있게 지원해줄 수 있는 것 같습니다. 패스키 인증 기기 정보의 경우 AttestedCredentialData에 포함된 AAGUID를 통해 인증 기기를 제공하는 업체을 식별할 수 있는데 AAGUID는 일반적으로 사람이 인지할 수 있는 문자열은 아니므로 AAGUID 저장소의 <a href="https://github.com/passkeydeveloper/passkey-authenticator-aaguids/blob/main/aaguid.json">aaguid.json</a> 인증 장치의 유형에 대해서 이름이나 아이콘을 표시할 수 있기도 합니다.</p><h5 id="등록된-패스키-삭제"><a href="#등록된-패스키-삭제" class="headerlink" title="등록된 패스키 삭제"></a>등록된 패스키 삭제</h5><p><img data-src="/images/posts/passkey-login/01.png"></p><p>위 화면은 깃허브에서 사용자 계정에 등록했던 패스키를 삭제하려고 했을때 제공되는 메시지입니다. 패스키 관리 시 등록한 패스키를 삭제하면 되겠지만 고려해야할 부분이 있습니다. 서버에 등록된 패스키를 삭제한다고해서 사용자가 사용했던 인증 기기의 패스키 등록 정보는 삭제되지 않는다는 것입니다. 또한, 사용자가 인증 기기의 패스키를 삭제해버리는 경우 사용자 계정에 등록된 패스키는 무용지물이 되며 불필요하게 패스키 등록 정보로 남아있게 되어버립니다.</p><p>패스키 등록을 지원하는 인증 기기별로 자세한 패스키 삭제 가이드를 제공할 순 없으므로 사용자 계정에서 패스키를 삭제하더라도 패스키 로그인 시에는 패스키 옵션으로 표시될 수 있음을 알려주고 있는 것 같습니다. 다음은 자주 사용될만한 인증 기기에서의 패스키 삭제 방법이므로 참고해보세요.</p><ul><li>Google Passsword Manager: 브라우저 URL에 <a href="chrome://settings/passkeys">chrome:&#x2F;&#x2F;settings&#x2F;passkeys</a> 입력</li><li>iCloud Keychain: <a href="https://support.apple.com/ko-kr/guide/mac-help/mchl77e2cb66/mac">Mac 및 iCloud 키체인에서 패스키 또는 암호 제거하기</a></li><li>Chrome Profile: <a href="https://support.google.com/chrome/answer/13168025?hl=ko">Chrome에서 패스키 관리하기</a></li><li>Samsung Pass: Samsung Wallet → Samsung Pass → 로그인 정보 → 패스키</li></ul><h4 id="패스키-인증-요청에-대한-옵션-발급"><a href="#패스키-인증-요청에-대한-옵션-발급" class="headerlink" title="패스키 인증 요청에 대한 옵션 발급"></a>패스키 인증 요청에 대한 옵션 발급</h4><p>Relying Party의 startAssertion 함수를 통해 사용자 계쩡에 등록된 패스키에 대해 로그인할 수 있도록 챌린지를 발급할 수 있습니다. 이때, 매개변수로 전달할 StartAssertionOptions을 구성할 때 클라이언트는 사용자가 입력한 아이디를 요청 시 제공한다면 특정 사용자 계정에 대한 공개키만 조회하여 포함시킬 수 있습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/authentication/challenge"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">startAssertion</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> httpSession<span class="token punctuation">,</span>                             <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">StartAssertionOptions<span class="token punctuation">.</span>StartAssertionOptionsBuilder</span> builder <span class="token operator">=</span> <span class="token class-name">StartAssertionOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMinutes</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>username<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        builder<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">AssertionRequest</span> assertionRequest <span class="token operator">=</span> relyingParty<span class="token punctuation">.</span><span class="token function">startAssertion</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpSession<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"assertionRequest"</span><span class="token punctuation">,</span> assertionRequest<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> assertionRequest<span class="token punctuation">.</span><span class="token function">toCredentialsGetJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h5 id="패스키-검증-및-인증"><a href="#패스키-검증-및-인증" class="headerlink" title="패스키 검증 및 인증"></a>패스키 검증 및 인증</h5><p>Relying Party의 finishAssertion 함수를 통해 클라이언트에서 전달한 패스키 인증 정보를 신뢰할 수 있는지 확인할 수 있습니다. 인증 정보에 포함된 credentailId와 userHandle을 토대로 사용자 계정에 대해 로그인을 처리하면 됩니다.</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> startAuthentication <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@simplewebauthn/browser'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">passkeyLogin</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> challenge  <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/authentication/challenge'</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> authenticationResponse <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">startAuthentication</span><span class="token punctuation">(</span>challenge<span class="token punctuation">.</span>data<span class="token punctuation">.</span>publicKey<span class="token punctuation">)</span>    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/authentication/verify'</span><span class="token punctuation">,</span> authenticationResponse<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/authentication/verify"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">finishAssertion</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> httpSession<span class="token punctuation">,</span>                              <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">String</span> credential<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">AssertionFailedException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> assertionRequestJson <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> httpSession<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"assertionRequest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">AssertionRequest</span> assertionRequest <span class="token operator">=</span> <span class="token class-name">AssertionRequest</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>assertionRequestJson<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">PublicKeyCredential</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthenticatorAssertionResponse</span><span class="token punctuation">,</span> <span class="token class-name">ClientAssertionExtensionOutputs</span><span class="token punctuation">></span></span> publicKeyCredential            <span class="token operator">=</span> <span class="token class-name">PublicKeyCredential</span><span class="token punctuation">.</span><span class="token function">parseAssertionResponseJson</span><span class="token punctuation">(</span>credential<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">AssertionResult</span> result <span class="token operator">=</span> relyingParty<span class="token punctuation">.</span><span class="token function">finishAssertion</span><span class="token punctuation">(</span><span class="token class-name">FinishAssertionOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>assertionRequest<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span>publicKeyCredential<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// todo: process authenticate</span>        <span class="token class-name">String</span> username <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ByteArray</span> credentialId <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getCredential</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCredentialId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ByteArray</span> userHandle <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getCredential</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h5 id="사용자-아이디-필드에-자동-완성-UI-표시"><a href="#사용자-아이디-필드에-자동-완성-UI-표시" class="headerlink" title="사용자 아이디 필드에 자동 완성 UI 표시"></a>사용자 아이디 필드에 자동 완성 UI 표시</h5><p>패스키 인증을 위해 startAuthentication를 호출할 때 useBrowserAutofill 매개변수를 설정하는 경우 mediation 옵션이 conditional로 지정되면서 사용자에게 바로 패스키 선택을 요구하는 대화상자를 표시하지 않고 브라우저마다 구현된 방식으로 자동 완성(조건부 UI)이 표시됩니다. 패스키 자동 완성을 위해 호출했다면 사용자 계정을 입력하는 필드의 autocomplete 속성에 webauthn 을 포함시키면 됩니다.</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Login.vue</span><span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">await</span> <span class="token function">processAutofill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">// passkey.js</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span>browserSupportsWebAuthnAutofill<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@simplewebauthn/browser'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">processAutofill</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">browserSupportsWebAuthnAutofill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> challenge <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/authentication/challenge'</span><span class="token punctuation">)</span>        <span class="token keyword">const</span> authenticationResponse <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">startAuthentication</span><span class="token punctuation">(</span>challenge<span class="token punctuation">.</span>data<span class="token punctuation">.</span>publicKey<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/authentication/verify'</span><span class="token punctuation">,</span> authenticationResponse<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>조건부 UI로 사용자에게 자동 완성을 제공할 때 패스키에 대한 프로미스가 계속 대기하는 상태로 진행하고 있는데요. 기존에 진행중인 패스키를 취소할 수 있도록 SimpleWebAuthn의 startAuthentication은 내부적으로 구현되어있으므로 신경 쓸 필요는 없습니다.</p></blockquote><hr><p>본 글을 작성하기 위해서 아래와 같은 정보들을 참고했습니다.</p><ul><li><a href="https://webauthn.io/">WebAuthn.io 데모 사이트</a></li><li><a href="https://webauthn.guide/">WebAuthn 가이드</a></li><li><a href="https://passkeys.dev/device-support/">Passkeys Device Support</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Authentication_API">WebAuthn: Web Authentication API</a></li><li><a href="https://webauthn.wtf/">What is WebAuthn?</a></li><li><a href="https://passkeys.dev/docs/intro/what-are-passkeys/">What are passkeys?</a></li><li><a href="https://webauthn.me/passkeys">Web Authentication and Passkeys</a></li><li><a href="https://www.corbado.com/assets/Passkeys-Developer-Cheatsheet.pdf">Passkeys Cheet Sheet</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;패스키 로그인은 사용자 계정에 대한 비밀번호를 입력하지 않고 사용자 계정에 대해 지문이나 얼굴 인식 그리고 보안키 등을 사용해서 미리 인증 정보를 등록해놓고 사용자의 인증 기기를 사용해서 로그인을 수행하도록 제공하는 걸 말합니다. 패스키는 로그인</summary>
      
    
    
    
    
    <category term="Passkey" scheme="https://kdevkr.github.io/tags/Passkey/"/>
    
    <category term="WebAuthn" scheme="https://kdevkr.github.io/tags/WebAuthn/"/>
    
  </entry>
  
  <entry>
    <title>Amazon SNS - FCM 모바일 푸시</title>
    <link href="https://kdevkr.github.io/amazon-sns-fcm-mobile-push/"/>
    <id>https://kdevkr.github.io/amazon-sns-fcm-mobile-push/</id>
    <published>2024-07-07T09:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.509Z</updated>
    
    <content type="html"><![CDATA[<p>PWA 앱에서 푸시 알림을 위해 FCM(Firebse Cloud Messaging)을 도입했다면 Amazon SNS의 모바일 푸시 알림으로 통합할 수 있다. Firebase Admin SDK 로도 쉽게 푸시 알림을 위한 메시지를 전송할 수 있지만 Amazon SNS에 등록된 플랫폼 애플리케이션을 통해 사용자 디바이스를 애플리케이션 앤드포인트로 관리하고 우리는 Amazon SNS에 등록된 플랫폼 엔드포인트를 통해 디바이스로 푸시 알림을 전달해보도록 하자.</p><h4 id="플랫폼-애플리케이션-생성-시-FCM-자격-증명-등록"><a href="#플랫폼-애플리케이션-생성-시-FCM-자격-증명-등록" class="headerlink" title="플랫폼 애플리케이션 생성 시 FCM 자격 증명 등록"></a>플랫폼 애플리케이션 생성 시 FCM 자격 증명 등록</h4><p><img data-src="/images/posts/amazon-sns-fcm-mobile-push/01.png"></p><p>FCM 푸시 알림 플랫픔을 사용하는 애플리케이션 생성 시 FCM 콘솔의 서비스 계정에서 발급받은 Firebase 서비스 계정의 비공개 키 정보를 등록해야 한다. Firebase Admin SDK 에서 사용중이었던 서비스 계정의 JSON 파일을 그대로 설정했다.</p><h4 id="애플리케이션-앤드포인트-생성-시-FCM-디바이스-토큰-등록"><a href="#애플리케이션-앤드포인트-생성-시-FCM-디바이스-토큰-등록" class="headerlink" title="애플리케이션 앤드포인트 생성 시 FCM 디바이스 토큰 등록"></a>애플리케이션 앤드포인트 생성 시 FCM 디바이스 토큰 등록</h4><p>플랫폼 애플리케이션에서 메시지를 전달할 엔드포인트는 하나의 식별할 수 있는 디바이스라고 생각하면 된다. 디바이스 토큰은 <a href="https://firebase.google.com/docs/cloud-messaging/js/client?hl=ko#access_the_registration_token">FCM 클라이언트 SDK로부터 디바이스 내에서 발급받은 토큰</a>을 입력하면 된다. 애플리케이션 엔드포인트 생성 후 메시지 게시를 통해 샘플 메시지를 전달해볼 수 있다.</p><pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"GCM"</span><span class="token operator">:</span> <span class="token string">"&#123; \"data\": &#123; \"title\": \"Hi!\", \"body\": \"Mambo?!\" &#125; &#125;"</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>Amazon SNS의 모바일 푸시 알림에서 FCM을 위한 메시지는 GCM 이라는 키로 사용합니다.</p></blockquote><p><img data-src="/images/posts/amazon-sns-fcm-mobile-push/02.png"></p><h4 id="Amazon-SNS-SDK-for-Java-V2로-메시지-게시"><a href="#Amazon-SNS-SDK-for-Java-V2로-메시지-게시" class="headerlink" title="Amazon SNS SDK for Java V2로 메시지 게시"></a>Amazon SNS SDK for Java V2로 메시지 게시</h4><p>웹 콘솔을 통해 FCM 메시지가 디바이스로 푸시 알림이 되었음을 확인했다면 Amazon SDK for Java v2를 사용해서 프로그래밍 방식으로 메시지를 전송해보도록 하자. 먼저, 아래와 같이 모바일 푸시 API를 사용하기 위한 Amazon SDK for Java v2 의존성을 추가하도록 하자.</p><pre class="language-groovy" data-language="groovy"><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    implementation <span class="token function">platform</span><span class="token punctuation">(</span><span class="token string">'software.amazon.awssdk:bom:2.26.16'</span><span class="token punctuation">)</span>    implementation <span class="token string">'software.amazon.awssdk:sns'</span><span class="token punctuation">&#125;</span></code></pre><p>의존성을 추가했다면 <a href="https://docs.aws.amazon.com/ko_kr/sns/latest/dg/mobile-push-api.html">모바일 푸시 API</a> 중 CreatePlatformEndpoint와 Publish를 사용해서 메시지를 게시하는 샘플 코드를 만들어볼 수 있다. </p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SnsClient</span> snsClient <span class="token operator">=</span> <span class="token class-name">SnsClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">credentialsProvider</span><span class="token punctuation">(</span><span class="token class-name">ProfileCredentialsProvider</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">region</span><span class="token punctuation">(</span><span class="token class-name">Region</span><span class="token punctuation">.</span><span class="token constant">AP_NORTHEAST_2</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertDoesNotThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            <span class="token class-name">String</span> platformApplicationArn <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> fcmDeviceToken <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> endpointArn <span class="token operator">=</span> snsClient<span class="token punctuation">.</span><span class="token function">createPlatformEndpoint</span><span class="token punctuation">(</span><span class="token class-name">CreatePlatformEndpointRequest</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">platformApplicationArn</span><span class="token punctuation">(</span>platformApplicationArn<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span>fcmDeviceToken<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endpointArn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> fcmMessage <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token string">"Hi!"</span><span class="token punctuation">,</span> <span class="token string">"body"</span><span class="token punctuation">,</span> <span class="token string">"Mambo?!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> messageId <span class="token operator">=</span> snsClient<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token class-name">PublishRequest</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">messageStructure</span><span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"GCM"</span><span class="token punctuation">,</span> fcmMessage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">targetArn</span><span class="token punctuation">(</span>endpointArn<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">messageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"messageId: &#123;&#125;"</span><span class="token punctuation">,</span> messageId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span>messageId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>위 예제코드에서 메시지의 GCM 이 이스케이프된 JSON 문자열로 구성되어야함을 주의해야합니다.</p></blockquote><p><img data-src="/images/posts/amazon-sns-fcm-mobile-push/03.png" alt="PWA 앱에서의 푸시 알림 예시"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;PWA 앱에서 푸시 알림을 위해 FCM(Firebse Cloud Messaging)을 도입했다면 Amazon SNS의 모바일 푸시 알림으로 통합할 수 있다. Firebase Admin SDK 로도 쉽게 푸시 알림을 위한 메시지를 전송할 수 있지만</summary>
      
    
    
    
    
    <category term="FCM" scheme="https://kdevkr.github.io/tags/FCM/"/>
    
    <category term="SNS Mobile Push" scheme="https://kdevkr.github.io/tags/SNS-Mobile-Push/"/>
    
  </entry>
  
  <entry>
    <title>PWA 와 FCM 푸시 알림</title>
    <link href="https://kdevkr.github.io/pwa-fcm-web-push/"/>
    <id>https://kdevkr.github.io/pwa-fcm-web-push/</id>
    <published>2024-07-06T04:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.517Z</updated>
    
    <content type="html"><![CDATA[<h4 id="PWA의-서비스-워커는-HTTPS를-요구"><a href="#PWA의-서비스-워커는-HTTPS를-요구" class="headerlink" title="PWA의 서비스 워커는 HTTPS를 요구"></a>PWA의 서비스 워커는 HTTPS를 요구</h4><p>PWA 앱에서 푸시 알림을 보내기 위해서는 사용자가 사이트 또는 앱에 대한 알림 권한을 허용해야하며 PWA 앱이 종료되어있어도 백그라운드 상태에서 동작하는 서비스 워커가 필요하다. Vite 기반으로 구성되어있는 프로젝트에서는 <a href="https://vite-pwa-org.netlify.app/">PWA Plugin for Vite</a>로 쉽게 PWA 설치 지원과 함께 서비스 워커를 등록할 수 있게 설정할 수 있다. 서비스 워커는 HTTPS 에서 동작해야하므로 개발 환경에서는 <a href="https://github.com/liuweiGL/vite-plugin-mkcert">vite-plugin-mkcert</a>가 도움이 될 수 있다.</p><h4 id="서비스-워커의-상태-변경을-고려하기"><a href="#서비스-워커의-상태-변경을-고려하기" class="headerlink" title="서비스 워커의 상태 변경을 고려하기"></a>서비스 워커의 상태 변경을 고려하기</h4><p>서비스 워커의 생명 주기를 이해하고 새로 설치되거나 업데이트되는 서비스 워커로 인해 메시지 수신이 원활하지 않을 수 있다는 점을 인지해야한다. <a href="https://developer.mozilla.org/ko/docs/Web/API/ServiceWorkerGlobalScope/skipWaiting">ServiceWorkerGlobalScope.skipWaiting</a> 이나 <a href="https://developer.mozilla.org/ko/docs/Web/API/Clients/claim">Clients::claim()</a>이 도움이 될 수도 있다.</p><h5 id="서비스-워커-파일이-firebase-messaging-sw-js-일-필요는-없다"><a href="#서비스-워커-파일이-firebase-messaging-sw-js-일-필요는-없다" class="headerlink" title="서비스 워커 파일이 firebase-messaging-sw.js 일 필요는 없다"></a>서비스 워커 파일이 firebase-messaging-sw.js 일 필요는 없다</h5><pre class="language-javascript" data-language="javascript"><div class="caption"><span>main.js</span></div><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>        <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MODE</span> <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">?</span> <span class="token string">'/sw.js'</span> <span class="token operator">:</span> <span class="token string">'/dev-sw.js?dev-sw'</span><span class="token punctuation">,</span>        <span class="token punctuation">&#123;</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MODE</span> <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">?</span> <span class="token string">'classic'</span> <span class="token operator">:</span> <span class="token string">'module'</span><span class="token punctuation">&#125;</span>    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">registration</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'register service worker'</span><span class="token punctuation">,</span> registration<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></code></pre><p>FCM 관련 일부 글에서 서비스 워커의 파일이 반드시 <code>firebase-messaing-sw.js</code> 이어야 한다고 언급하는데 잘못된 정보에 해당되며 FCM 메시지 수신을 위해서 PWA 앱에서 사용중인 <code>서비스 워커 내에 Firebase SDK를 초기화</code>하는게 중요한 부분이다. 위 코드와 같이 개발 환경에서는 <a href="https://vite-pwa-org.netlify.app/guide/development#injectmanifest-strategy">dev-sw.js</a>를 서비스 워커로 등록하여 사용할 수 있음을 보여준다.</p><h4 id="FCM-푸시-알림이-여러번-표시되는-문제-🔥"><a href="#FCM-푸시-알림이-여러번-표시되는-문제-🔥" class="headerlink" title="FCM 푸시 알림이 여러번 표시되는 문제 🔥"></a>FCM 푸시 알림이 여러번 표시되는 문제 🔥</h4><p><a href="https://github.com/kdevkr/mambo-box/blob/main/errors/2024-07-06.md">PWA 앱의 푸시 알림에서 FCM 메시지가 여러번 표시되는 문제</a>와 같이 백그라운드 상태에 있는 PWA 앱에서 푸시 알림이 여러번 표시되는 이유는 <a href="https://firebase.google.com/docs/cloud-messaging/js/receive?hl=ko">자바스크립트 클라이언트에서 메시지 수신</a>시 알림 메시지에 의한 기본 화면 표시에 대해 고려하지 않은 문제에 해당된다. 자바스크립트 클라이언트에서 커스텀 메시지로 푸시 알림을 제공하고 싶다면 서버에서는 알림 메시지가 포함되지 않은 데이터 메시지로 구성하여 전달해야한다.</p><h4 id="자바스크립트-클라이언트-API-키는-안전하다"><a href="#자바스크립트-클라이언트-API-키는-안전하다" class="headerlink" title="자바스크립트 클라이언트 API 키는 안전하다"></a>자바스크립트 클라이언트 API 키는 안전하다</h4><p>일반적으로 자바스크립트로 동작하는 SDK에 대한 키는 외부에 노출될 수 밖에 없으므로 FCM 메시지를 수신할 수 있는 최소한의 권한을 보유한다. FCM 콘솔에서 <a href="https://developer.chrome.com/blog/web-push-interop-wins?hl=ko#introducing_vapid_for_server_identification">웹 푸시 인증서</a>는 <code>최대 2개까지 발급</code>할 수 있으므로 <code>VAPID</code>를 환경별로 나누어서 사용하는 것도 좋아보인다. 더 자세한 내용은 <a href="https://firebase.google.com/docs/projects/api-keys?hl=ko">Firebase용 API 키 사용 및 관리에 대해 알아보기</a>를 참고하여 고려해보도록 하자.</p><h4 id="시스템-규모에-따른-토큰-관리-전략"><a href="#시스템-규모에-따른-토큰-관리-전략" class="headerlink" title="시스템 규모에 따른 토큰 관리 전략"></a>시스템 규모에 따른 토큰 관리 전략</h4><p><a href="https://firebase.google.com/docs/cloud-messaging/manage-tokens?hl=ko">FCM 등록 토큰 관리를 위한 권장사항</a>과 <a href="https://firebase.google.com/docs/cloud-messaging/scale-fcm?hl=ko">FCM 메시지를 대규모로 전송할 때의 권장사항</a>를 참고하여 시스템에 저장되어 메시지 전송 시 사용되는 토큰의 수를 관리하는게 필요하다. 서버에서는 사용자가 PWA 앱을 삭제하는지를 감지하여 더이상 토큰이 사용되지 않는지 알 수 없다. FCM 메시지 전송 시 무제한으로 발송할 수는 없으므로 오랫동안 사용되지 않거나 만료된 토큰은 주기적으로 삭제하는 작업이 있어야한다.</p><h4 id="iOS의-PWA-앱-지원-여부"><a href="#iOS의-PWA-앱-지원-여부" class="headerlink" title="iOS의 PWA 앱 지원 여부"></a>iOS의 PWA 앱 지원 여부</h4><p>안드로이드와 크롬 브라우저와 달리 iOS 또는 사파리 브라우저에 따라 PWA 앱 설치 및 푸시 API를 지원하는지의 여부가 다름을 인지해야한다. 또한, 홈 화면으로 추가되는 앱은 반드시 기본으로 제공되는 사파리 브라우저로 실행되는 것도 중요한 부분에 해당된다.</p><ul><li><a href="https://developer.apple.com/documentation/usernotifications/sending-web-push-notifications-in-web-apps-and-browsers">Safari 16.1 and macOS 16.4 iOS &amp; iPadOS 부터 Push API 지원</a></li><li><a href="https://developer.apple.com/support/dma-and-apps-in-the-eu/">유럽 연합의 국가에서 iOS 17.4 이상에서 PWA 지원 종료</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;PWA의-서비스-워커는-HTTPS를-요구&quot;&gt;&lt;a href=&quot;#PWA의-서비스-워커는-HTTPS를-요구&quot; class=&quot;headerlink&quot; title=&quot;PWA의 서비스 워커는 HTTPS를 요구&quot;&gt;&lt;/a&gt;PWA의 서비스 워커는 HTTPS를 </summary>
      
    
    
    
    
    <category term="FCM" scheme="https://kdevkr.github.io/tags/FCM/"/>
    
    <category term="PWA" scheme="https://kdevkr.github.io/tags/PWA/"/>
    
  </entry>
  
  <entry>
    <title>HAProxy</title>
    <link href="https://kdevkr.github.io/haproxy/"/>
    <id>https://kdevkr.github.io/haproxy/</id>
    <published>2024-06-29T06:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.513Z</updated>
    
    <content type="html"><![CDATA[<p>일반적으로 애플리케이션 서버에 대한 HTTP 프록시는 엔진엑스(Nginx)를 많이 사용하고 있지만 L4 레벨의 <code>TCP 프록시</code>가 필요한 경우 stream 모듈을 별도로 설치해야하는 과정이 필요하므로 <code>HAProxy</code>가 더 좋은 선택일 수 있다. 사내 개발 환경에서 연결할 수 있는 배스천 호스트에 HAProxy를 구성하고 프라이빗 네트워크 환경으로 구성되어있는 테스트 환경의 TCP 통신이 필요한 인스턴스에 연결할 수 있도록 <code>포트 포워딩</code>을 구성해보도록 하자.</p><h4 id="TCP-프록시"><a href="#TCP-프록시" class="headerlink" title="TCP 프록시"></a>TCP 프록시</h4><p><a href="https://www.haproxy.com/documentation/haproxy-configuration-tutorials/load-balancing/tcp/">TCP 프록시</a>는 TCP 연결에 대한 리버스 프록시에 해당된다. 일반적으로 TCP 연결을 수행해야하는 인스턴스에는 Redis 또는 PostgreSQL이 있는데 현재 조직에서 활용하고 있는 시계열 데이터베이스인 <a href="https://kx.com/products/kdb/">KDB+</a>에 대해 프록시를 구성해보려고 한다. 다음은 KDB에서 사용해야하는 포트 범위를 수신하도록 설정한 예시이다.</p><pre class="language-cfg" data-language="cfg"><div class="caption"><span>haproxy.cfg</span></div><code class="language-cfg">listen kdb_proxy_for_dev    mode tcp    bind *:5010-5013    server kdb_dev 192.168.149.88</code></pre><h4 id="HAProxy-구성-테스트"><a href="#HAProxy-구성-테스트" class="headerlink" title="HAProxy 구성 테스트"></a>HAProxy 구성 테스트</h4><p>현재 설정 파일에 문법적인 문제가 없는지 <code>check mode(-c)</code> 옵션을 사용해서 현재 설정에 대해 검증을 수행해볼 수 있다.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>ec2-user@ip-192-169-14-62 ~<span class="token punctuation">]</span>$ haproxy <span class="token parameter variable">-c</span> <span class="token parameter variable">-f</span> /etc/haproxy/haproxy.cfgConfiguration <span class="token function">file</span> is valid</code></pre><h4 id="TCP-프록시-테스트"><a href="#TCP-프록시-테스트" class="headerlink" title="TCP 프록시 테스트"></a>TCP 프록시 테스트</h4><p>NetCat(nc) 명령어를 사용해서 HAProxy에서 수신하고 있는 포트를 통해 테스트 환경에 실행된 인스턴스에 연결할 수 있는지 테스트를 해보자.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>ec2-user@ip-192-169-14-62 ~<span class="token punctuation">]</span>$ <span class="token function">nc</span> <span class="token parameter variable">-znv</span> <span class="token number">127.0</span>.0.1 <span class="token number">5013</span>Ncat: Version <span class="token number">7.50</span> <span class="token punctuation">(</span> https://nmap.org/ncat <span class="token punctuation">)</span>Ncat: Connected to <span class="token number">127.0</span>.0.1:5013.Ncat: <span class="token number">0</span> bytes sent, <span class="token number">0</span> bytes received <span class="token keyword">in</span> <span class="token number">0.01</span> seconds.</code></pre><blockquote><p>배스천 호스트에 TCP 프록시를 구성하기 전까지는 배스천 호스트에 대한 SSH 터널링을 필요할때마다 수행해야 했습니다.<br>기본적으로 SSH 터널링을 구성하는게 일반적이지만 보안 수준을 검토하고 TCP 프록시를 구성해보도록 하세요.</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;일반적으로 애플리케이션 서버에 대한 HTTP 프록시는 엔진엑스(Nginx)를 많이 사용하고 있지만 L4 레벨의 &lt;code&gt;TCP 프록시&lt;/code&gt;가 필요한 경우 stream 모듈을 별도로 설치해야하는 과정이 필요하므로 &lt;code&gt;HAProxy&lt;</summary>
      
    
    
    
    
    <category term="HAProxy" scheme="https://kdevkr.github.io/tags/HAProxy/"/>
    
    <category term="TCP Proxy" scheme="https://kdevkr.github.io/tags/TCP-Proxy/"/>
    
  </entry>
  
  <entry>
    <title>Spring AI + Ollama</title>
    <link href="https://kdevkr.github.io/spring-ai-with-ollama/"/>
    <id>https://kdevkr.github.io/spring-ai-with-ollama/</id>
    <published>2024-06-28T14:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.517Z</updated>
    
    <content type="html"><![CDATA[<p>Spring AI 프로젝트에서 OpenAI의 ChatGPT 또는 Anthropic의 Claude를 지원하지만 로컬 머신에서 실행할 수 있는 Ollama도 지원하고 있다.<br>내 컴퓨터에 Ollama를 설치하고 파라미터가 작은 모델을 선택해서 간단하게 AI 엔지니어링을 해보도록 하려고 한다. </p><h4 id="윈도우-Ollama-설치"><a href="#윈도우-Ollama-설치" class="headerlink" title="윈도우 Ollama 설치"></a>윈도우 Ollama 설치</h4><p><a href="https://ollama.com/download/windows">Download for Windows (Preview)</a>를 통해 윈도우 컴퓨터에 Ollama를 설치하고 사용가능한 <a href="https://ollama.com/library">모델</a> 중에서 파라미터가 작은 모델 중 하나인 <a href="https://ollama.com/library/phi3">phi3</a>를 선택해보자.<br>일반적인 예시에서는 <a href="https://ollama.com/library/mistral">mistral</a>를 설치해서 사용해보는 것 같다. 아무튼, <code>ollama run phi3</code> 명령어로 모델을 설치할 수 있다.</p><pre class="language-ps" data-language="ps"><code class="language-ps">PS C:\Users\Mambo\ollama&gt; ollama run phi3pulling manifestpulling b26e6713dc74... 100% ▕████████████████████████████████████████████████████████▏ 2.4 GBpulling fa8235e5b48f... 100% ▕████████████████████████████████████████████████████████▏ 1.1 KBpulling 542b217f179c... 100% ▕████████████████████████████████████████████████████████▏  148 Bpulling 8dde1baf1db0... 100% ▕████████████████████████████████████████████████████████▏   78 Bpulling f91db7a2deb9... 100% ▕████████████████████████████████████████████████████████▏  485 Bverifying sha256 digestwriting manifestremoving any unused layerssuccess</code></pre><h4 id="Open-WebUI-설치"><a href="#Open-WebUI-설치" class="headerlink" title="Open WebUI 설치"></a>Open WebUI 설치</h4><p>Spring AI와는 상관없지만 ChatGPT와 같은 AI 서비스처럼 Ollama와 연동이 가능한 <a href="https://openwebui.com/">Open WebUI</a>를 설치해보았다. </p><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token key atrule">open-webui</span><span class="token punctuation">:</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/open<span class="token punctuation">-</span>webui/open<span class="token punctuation">-</span>webui<span class="token punctuation">:</span>main    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> open<span class="token punctuation">-</span>webui    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"3000:8080"</span>    <span class="token key atrule">environment</span><span class="token punctuation">:</span>      <span class="token key atrule">OLLAMA_BASE_URL</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//host.docker.internal<span class="token punctuation">:</span><span class="token number">11434</span>      <span class="token key atrule">WEBUI_AUTH</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> open<span class="token punctuation">-</span>webui<span class="token punctuation">:</span>/app/backend/data    <span class="token key atrule">extra_hosts</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> host.docker.internal<span class="token punctuation">:</span>host<span class="token punctuation">-</span>gateway    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped<span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token key atrule">open-webui</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>저는 컴퓨터 호스트에 Ollama를 설치하고 실행하였기에 host.docker.internal로 접근했습니다.<br>Ollama를 도커 컴포즈로 실행하기 위한 설정은 <a href="https://github.com/open-webui/open-webui/blob/main/docker-compose.yaml">docker-compose.yaml</a>를 참고하세요.</p></blockquote><h4 id="Spring-AI-Ollama-Chat"><a href="#Spring-AI-Ollama-Chat" class="headerlink" title="Spring AI Ollama Chat"></a>Spring AI Ollama Chat</h4><p><a href="https://docs.spring.io/spring-ai/reference/api/chat/ollama-chat.html">OllamaChatModel</a></p><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">repositories <span class="token punctuation">&#123;</span>    maven <span class="token punctuation">&#123;</span> url <span class="token string">'https://repo.spring.io/milestone'</span> <span class="token punctuation">&#125;</span>    maven <span class="token punctuation">&#123;</span> url <span class="token string">'https://repo.spring.io/snapshot'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>dependencies <span class="token punctuation">&#123;</span>    implementation <span class="token string">'org.springframework.ai:spring-ai-ollama-spring-boot-starter'</span><span class="token punctuation">&#125;</span>dependencyManagement <span class="token punctuation">&#123;</span>    imports <span class="token punctuation">&#123;</span>        mavenBom <span class="token interpolation-string"><span class="token string">"de.codecentric:spring-boot-admin-dependencies:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">springBootAdminVersion</span></span><span class="token string">"</span></span>        mavenBom <span class="token interpolation-string"><span class="token string">"org.springframework.ai:spring-ai-bom:1.0.0-M1"</span></span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-yaml" data-language="yaml"><div class="caption"><span>application.yml</span></div><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">ai</span><span class="token punctuation">:</span>    <span class="token key atrule">ollama</span><span class="token punctuation">:</span>      <span class="token key atrule">base-url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">11434</span>      <span class="token key atrule">chat</span><span class="token punctuation">:</span>        <span class="token key atrule">options</span><span class="token punctuation">:</span>          <span class="token key atrule">model</span><span class="token punctuation">:</span> phi3          <span class="token key atrule">temperature</span><span class="token punctuation">:</span> <span class="token number">0.9</span>    <span class="token key atrule">retry</span><span class="token punctuation">:</span>      <span class="token key atrule">max-attempts</span><span class="token punctuation">:</span> <span class="token number">1</span></code></pre><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RequiredArgsConstructor</span><span class="token annotation punctuation">@RestController</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatApi</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TEMPLATE</span> <span class="token operator">=</span> <span class="token triple-quoted-string string">"""            Hello ai, How many hours does &#123;timezone&#125; differ by UTC?.            """</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">OllamaChatModel</span> chatModel<span class="token punctuation">;</span>    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/ai/generate"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">String</span> timezone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">PromptTemplate</span> promptTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PromptTemplate</span><span class="token punctuation">(</span><span class="token constant">TEMPLATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        promptTemplate<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"timezone"</span><span class="token punctuation">,</span> timezone<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> chatModel<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>promptTemplate<span class="token punctuation">.</span><span class="token function">createMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-txt" data-language="txt"><div class="caption"><span>AI Response</span></div><code class="language-txt">Seoul, South Korea operates on Korea Standard Time (KST), which is 9 hours ahead of Coordinated Universal Time (UTC+9). Therefore, the difference between UTC and KST in Seoul is 9 hours.To calculate this for any specific time:- If you're looking to convert a time from UTC to KST, add 9 hours.- If you're converting a time from KST back to UTC, subtract 9 hours.</code></pre><p>결제가 필요한 ChatGPT와 Claude API 대신에 로컬 머신에 Ollama를 설치하고 Spring AI를 간단하게 다루어보았다.<br>개인적으로 AI에 대한 인식은 아직 <strong>설레발</strong>이라고 생각이 되지만 AI가 성장할수록 <a href="https://www.promptingguide.ai/kr">프롬프트 엔지니어링</a>도 개발자에게 필요한 역량이 되어갈 수 있어서 준비가 필요하다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Spring AI 프로젝트에서 OpenAI의 ChatGPT 또는 Anthropic의 Claude를 지원하지만 로컬 머신에서 실행할 수 있는 Ollama도 지원하고 있다.&lt;br&gt;내 컴퓨터에 Ollama를 설치하고 파라미터가 작은 모델을 선택해서 간</summary>
      
    
    
    
    
    <category term="spring ai" scheme="https://kdevkr.github.io/tags/spring-ai/"/>
    
    <category term="ollama" scheme="https://kdevkr.github.io/tags/ollama/"/>
    
  </entry>
  
  <entry>
    <title>AWS EC2 인스턴스 메타데이터</title>
    <link href="https://kdevkr.github.io/aws-ec2-instance-metadata/"/>
    <id>https://kdevkr.github.io/aws-ec2-instance-metadata/</id>
    <published>2024-06-25T13:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.509Z</updated>
    
    <content type="html"><![CDATA[<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># IMDSv1</span><span class="token function">curl</span> http://169.254.169.254/latest/dynamic/instance-identity/document<span class="token comment"># IMDSv2</span><span class="token assign-left variable">TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">curl</span> <span class="token parameter variable">-H</span> <span class="token string">"X-aws-ec2-metadata-token-ttl-seconds: 21600"</span><span class="token variable">`</span></span> <span class="token parameter variable">-X</span> PUT <span class="token string">"http://169.254.169.254/latest/api/token"</span> <span class="token function">curl</span> <span class="token parameter variable">-H</span> <span class="token string">"X-aws-ec2-metadata-token: <span class="token variable">$TOKEN</span>"</span> http://169.254.169.254/latest/dynamic/instance-identity/document<span class="token punctuation">&#123;</span>    <span class="token string">"accountId"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,    <span class="token string">"architecture"</span><span class="token builtin class-name">:</span> <span class="token string">"arm64"</span>,    <span class="token string">"availabilityZone"</span><span class="token builtin class-name">:</span> <span class="token string">"ap-northeast-2c"</span>,    <span class="token string">"billingProducts"</span><span class="token builtin class-name">:</span> null,    <span class="token string">"devpayProductCodes"</span><span class="token builtin class-name">:</span> null,    <span class="token string">"marketplaceProductCodes"</span><span class="token builtin class-name">:</span> null,    <span class="token string">"imageId"</span><span class="token builtin class-name">:</span> <span class="token string">"ami-0331a5c9d849893dc"</span>,    <span class="token string">"instanceId"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,    <span class="token string">"instanceType"</span><span class="token builtin class-name">:</span> <span class="token string">"c6g.xlarge"</span>,    <span class="token string">"kernelId"</span><span class="token builtin class-name">:</span> null,    <span class="token string">"pendingTime"</span><span class="token builtin class-name">:</span> <span class="token string">"2024-06-23T01:01:23Z"</span>,    <span class="token string">"privateIp"</span><span class="token builtin class-name">:</span> <span class="token string">"192.169.44.196"</span>,    <span class="token string">"ramdiskId"</span><span class="token builtin class-name">:</span> null,    <span class="token string">"region"</span><span class="token builtin class-name">:</span> <span class="token string">"ap-northeast-2"</span>,    <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token string">"2017-09-30"</span><span class="token punctuation">&#125;</span></code></pre><p><a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html">인스턴스 메타데이터 검색</a>을 활용해서 동적 데이터의 <a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/instance-identity-documents.html">인스턴스 자격 증명 문서(instance-identity&#x2F;document)</a>를 가져오는 예시이다. 이번 글에서는 <code>AWS SDK for Java</code> 라이브러리에서 제공하는 <code>EC2 메타데이터 유틸리티</code>를 통해 AWS EC2 인스턴스에서 실행중인 애플리케이션 서버에서 EC2 인스턴스 정보를 조회할 수 있도록 작성해보려고 한다. 스프링 부트 기반의 애플리케이션이라면 스프링 부트 액추에이터의 <a href="https://docs.spring.io/spring-boot/reference/actuator/endpoints.html#actuator.endpoints.info">InfoContributor</a> 인터페이스를 구현한 <code>EC2MetadataInfoContributor</code>를 만들어보자.</p><h4 id="EC2MetadataInfoContributor-with-SDK-for-Java-1-x"><a href="#EC2MetadataInfoContributor-with-SDK-for-Java-1-x" class="headerlink" title="EC2MetadataInfoContributor with SDK for Java 1.x"></a>EC2MetadataInfoContributor with SDK for Java 1.x</h4><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    <span class="token comment">// the AWS SDK for Java v1.x will enter maintenance mode on July 31, 2024, and reach end-of-support on December 31, 2025.</span>    implementation <span class="token function">platform</span><span class="token punctuation">(</span><span class="token string">'com.amazonaws:aws-java-sdk-bom:1.12.748'</span><span class="token punctuation">)</span>    implementation <span class="token string">'com.amazonaws:aws-java-sdk-ec2'</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><div class="caption"><span>EC2MetadataInfoContributor.java</span></div><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>amazonaws<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">EC2MetadataUtils</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>actuate<span class="token punctuation">.</span>info<span class="token punctuation">.</span></span><span class="token class-name">Info</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>actuate<span class="token punctuation">.</span>info<span class="token punctuation">.</span></span><span class="token class-name">InfoContributor</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EC2MetadataInfoContributor</span> <span class="token keyword">implements</span> <span class="token class-name">InfoContributor</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isRunningAwsEC2<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">EC2MetadataInfoContributor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        isRunningAwsEC2 <span class="token operator">=</span> <span class="token class-name">EC2MetadataUtils</span><span class="token punctuation">.</span><span class="token function">getInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contribute</span><span class="token punctuation">(</span><span class="token class-name">Info<span class="token punctuation">.</span>Builder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isRunningAwsEC2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">EC2MetadataUtils<span class="token punctuation">.</span>InstanceInfo</span> instanceInfo <span class="token operator">=</span> <span class="token class-name">EC2MetadataUtils</span><span class="token punctuation">.</span><span class="token function">getInstanceInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            builder<span class="token punctuation">.</span><span class="token function">withDetail</span><span class="token punctuation">(</span><span class="token string">"ec2"</span><span class="token punctuation">,</span> instanceInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="EC2MetadataInfoContributor-with-SDK-for-Java-2-x"><a href="#EC2MetadataInfoContributor-with-SDK-for-Java-2-x" class="headerlink" title="EC2MetadataInfoContributor with SDK for Java 2.x"></a>EC2MetadataInfoContributor with SDK for Java 2.x</h4><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    implementation <span class="token function">platform</span><span class="token punctuation">(</span><span class="token string">'software.amazon.awssdk:bom:2.21.4'</span><span class="token punctuation">)</span>    implementation <span class="token string">'software.amazon.awssdk:imds'</span>    implementation <span class="token string">'software.amazon.awssdk:url-connection-client'</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><div class="caption"><span>EC2MetadataInfoContributorV2.java</span></div><code class="language-java">mport <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>actuate<span class="token punctuation">.</span>info<span class="token punctuation">.</span></span>Info</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>actuate<span class="token punctuation">.</span>info<span class="token punctuation">.</span></span><span class="token class-name">InfoContributor</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">software<span class="token punctuation">.</span>amazon<span class="token punctuation">.</span>awssdk<span class="token punctuation">.</span>core<span class="token punctuation">.</span>document<span class="token punctuation">.</span></span><span class="token class-name">Document</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">software<span class="token punctuation">.</span>amazon<span class="token punctuation">.</span>awssdk<span class="token punctuation">.</span>imds<span class="token punctuation">.</span></span><span class="token class-name">Ec2MetadataClient</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">software<span class="token punctuation">.</span>amazon<span class="token punctuation">.</span>awssdk<span class="token punctuation">.</span>imds<span class="token punctuation">.</span></span><span class="token class-name">Ec2MetadataResponse</span></span><span class="token punctuation">;</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EC2MetadataInfoContributorV2</span> <span class="token keyword">implements</span> <span class="token class-name">InfoContributor</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> isRunningAwsEC2<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">EC2MetadataInfoContributorV2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Ec2MetadataClient</span> client <span class="token operator">=</span> <span class="token class-name">Ec2MetadataClient</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            isRunningAwsEC2 <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/latest/meta-data/instance-id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// ignored</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contribute</span><span class="token punctuation">(</span><span class="token class-name">Info<span class="token punctuation">.</span>Builder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isRunningAwsEC2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Ec2MetadataClient</span> client <span class="token operator">=</span> <span class="token class-name">Ec2MetadataClient</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">Ec2MetadataResponse</span> metadataResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/latest/dynamic/instance-identity/document"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">Document</span> document <span class="token operator">=</span> metadataResponse<span class="token punctuation">.</span><span class="token function">asDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                builder<span class="token punctuation">.</span><span class="token function">withDetail</span><span class="token punctuation">(</span><span class="token string">"ec2"</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">asMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// ignored</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="인스턴스-메타데이터-검색"><a href="#인스턴스-메타데이터-검색" class="headerlink" title="인스턴스 메타데이터 검색"></a>인스턴스 메타데이터 검색</h4><ol><li>SDK 버전에 따라 <a href="https://docs.aws.amazon.com/ko_kr/sdk-for-java/latest/developer-guide/migration-imds.html#migration-imds-behavior-endpoint-res">SDK가 엔드포인트를 IMDS로 확인하기 위해 확인하는 위치</a>가 다르다.</li><li><a href="https://docs.aws.amazon.com/ko_kr/sdk-for-java/latest/developer-guide/migration-imds.html#migration-imds-behavior-imdsv2">Java 2.x는 IMDSv2만 지원</a>하지만 Java 1.x는 IMDSv2 를 사용할 수 없을때 IMDSv1 으로도 조회한다.</li><li>Java 2.x는 <a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/instancedata-data-categories.html">인스턴스 메타데이터 카테고리</a>를 직접 명시해야한다.</li><li>Java 1.x는 2025년 12월 31일 <a href="https://aws.amazon.com/ko/blogs/developer/announcing-end-of-support-for-aws-sdk-for-java-v1-x-on-december-31-2025/">지원 종료(End of support)</a>된다.</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;pre class=&quot;language-bash&quot; data-language=&quot;bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# IMDSv1&lt;/span&gt;
&lt;span class=&quot;token f</summary>
      
    
    
    
    
    <category term="IMDSv1" scheme="https://kdevkr.github.io/tags/IMDSv1/"/>
    
    <category term="IMDSv2" scheme="https://kdevkr.github.io/tags/IMDSv2/"/>
    
  </entry>
  
  <entry>
    <title>스프링 부트 메일 헬스체크 캐시하기</title>
    <link href="https://kdevkr.github.io/spring-boot-mail-health-check/"/>
    <id>https://kdevkr.github.io/spring-boot-mail-health-check/</id>
    <published>2024-06-23T02:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.517Z</updated>
    
    <content type="html"><![CDATA[<p>토스의 <a href="https://toss.tech/article/how-to-work-health-check-in-spring-boot-actuator">Spring Boot Actuator의 헬스체크 살펴보기</a>라는 글을 보고 스프링 부트 액추에이터에서 기본으로 제공하는 MailHealthIndiator의 헬스 체크 결과를 별도로 요청하는 경우 <code>management.endpoint.health.cache-time-to-live</code> 속성으로 캐시되지 않음을 확인했다. 해당 속성은 전체 헬스 체크 결과를 반환하는 헬스 엔드포인트(&#x2F;actuator&#x2F;health)에 해당하는 캐시 옵션으로 메일에 대한 헬스 엔드포인트(&#x2F;actuator&#x2F;health&#x2F;mail)에 대해서는 적용되지 않는다.</p><p>스프링 부트 액추에이터의 <a href="https://github.com/spring-projects/spring-boot/blob/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/mail/MailHealthIndicator.java">MailHealthIndicator</a> 는 JavaMailSenderImpl의 testConnection 함수를 호출하여 헬스 체크 결과를 반환하도록 작성되어있다. MailHealthIndicator라는 이름으로 HealthIIndicator를 구현하면 기본적으로 제공하는 MailHealthIndicator 대신에 등록되므로 SMTP 서버로의 연결 수행 결과를 캐시하여 응답하도록 작성해볼 수 있다.</p><h4 id="CachableMailHealthIndicator"><a href="#CachableMailHealthIndicator" class="headerlink" title="CachableMailHealthIndicator"></a>CachableMailHealthIndicator</h4><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">Cache</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">CacheBuilder</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span><span class="token class-name">InitializingBean</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>actuate<span class="token punctuation">.</span>health<span class="token punctuation">.</span></span><span class="token class-name">Health</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>actuate<span class="token punctuation">.</span>mail<span class="token punctuation">.</span></span><span class="token class-name">MailHealthIndicator</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>javamail<span class="token punctuation">.</span></span><span class="token class-name">JavaMailSenderImpl</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Instant</span></span><span class="token punctuation">;</span><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"mailHealthIndicator"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CachableMailHealthIndicator</span> <span class="token keyword">extends</span> <span class="token class-name">MailHealthIndicator</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Health</span><span class="token punctuation">></span></span> cache<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">CachableMailHealthIndicator</span><span class="token punctuation">(</span><span class="token class-name">JavaMailSenderImpl</span> javaMailSender<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>javaMailSender<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doHealthCheck</span><span class="token punctuation">(</span><span class="token class-name">Health<span class="token punctuation">.</span>Builder</span> builder<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Health</span> cached <span class="token operator">=</span> cache <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> cache<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span><span class="token string">"mail"</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            builder<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>cached<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withDetails</span><span class="token punctuation">(</span>cached<span class="token punctuation">.</span><span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">doHealthCheck</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            builder<span class="token punctuation">.</span><span class="token function">down</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Health</span> health <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">withDetail</span><span class="token punctuation">(</span><span class="token string">"datetime"</span><span class="token punctuation">,</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mail"</span><span class="token punctuation">,</span> health<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        cache <span class="token operator">=</span> <span class="token class-name">CacheBuilder</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p><img data-src="/images/posts/spring-boot-mail-health-check/01.png" alt="268ms → 4ms"></p><blockquote><p>CacheableMailHealthIndicator는 호스트 정보 뿐만 아니라 <strong>캐시된 시간</strong>을 포함하여 언제 측정된 결과인지도 확인할 수 있습니다.</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;토스의 &lt;a href=&quot;https://toss.tech/article/how-to-work-health-check-in-spring-boot-actuator&quot;&gt;Spring Boot Actuator의 헬스체크 살펴보기&lt;/a&gt;라는 글을 보고 스프링 </summary>
      
    
    
    
    
    <category term="Spring Boot Actuator" scheme="https://kdevkr.github.io/tags/Spring-Boot-Actuator/"/>
    
    <category term="MailHealthIndicator" scheme="https://kdevkr.github.io/tags/MailHealthIndicator/"/>
    
  </entry>
  
  <entry>
    <title>Redis Stream</title>
    <link href="https://kdevkr.github.io/spring-boot-data-redis-stream/"/>
    <id>https://kdevkr.github.io/spring-boot-data-redis-stream/</id>
    <published>2024-06-22T03:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.517Z</updated>
    
    <content type="html"><![CDATA[<p>소규모 애플리케이션 서버에서 레디스를 사용하고 있을때 RabbitMQ 또는 Apache Kafka와 같은 메시지 큐를 통해 비동기 이벤트에 대한 요구가 필요한 경우 별도의 메시지 큐 솔루션을 도입하는 것은 인프라 상 과도할 수도 있다. 이러한 경우 레디스에서 제공하는 스트림을 사용하여 메시지 기반의 프로그래밍을 수행할 수 있는데 스프링 부트 기반의 애플리케이션인 경우 <a href="https://spring.io/projects/spring-data-redis">Spring Data Redis</a>에 <a href="https://docs.spring.io/spring-data/redis/reference/redis/redis-streams.html">레디스 스트림에 대한 기능</a>을 포함하고 있으므로 쉽게 스트림에 메시지를 등록하고 컨슈머를 추가하여 메시지를 수신하도록 구현할 수 있다.</p><h4 id="메시지-없는-빈-스트림-생성하기"><a href="#메시지-없는-빈-스트림-생성하기" class="headerlink" title="메시지 없는 빈 스트림 생성하기"></a>메시지 없는 빈 스트림 생성하기</h4><pre class="language-bash" data-language="bash"><code class="language-bash">XGROUP CREATE stream_key group_name $ MKSTREAM</code></pre><p>기본적인 레디스 명령어로는 위와 같이 컨슈머 그룹을 생성할 때 MKSTREAM 옵션을 지정하여 스트림이 존재하지 않은 경우에 스트림이 자동으로 생성되도록 할 수 있다. Spring Data Redis 에서는 RedisConnection 과 RedisStreamCommands 인터페이스에 xGroupCreate 라는 함수로 정의되어 있으므로 아래와 같이 구현하면 된다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> streamKey <span class="token operator">=</span> <span class="token string">"stream-1"</span><span class="token punctuation">;</span><span class="token class-name">String</span> groupName <span class="token operator">=</span> <span class="token string">"group-1"</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span>streamKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createGroup</span><span class="token punctuation">(</span>streamKey<span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">lastConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">RedisConnection</span> connection <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">getConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">RedisStreamCommands</span> streamCommands <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">streamCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    streamCommands<span class="token punctuation">.</span><span class="token function">xGroupCreate</span><span class="token punctuation">(</span>streamKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">latest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="StreamMessageListenerContainer"><a href="#StreamMessageListenerContainer" class="headerlink" title="StreamMessageListenerContainer"></a>StreamMessageListenerContainer</h4><p>StreamMessageListenerContainer 와 StreamListener 를 활용하면 RedisTemplate 으로 스트림을 직접 읽지 않아도 다중 스레드를 통해 메시지를 수신하여 처리할 수 있다. </p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">StreamMessageListenerContainer</span> messageListenerContainer <span class="token operator">=</span> <span class="token class-name">StreamMessageListenerContainer</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">getConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token class-name">StreamMessageListenerContainer<span class="token punctuation">.</span>StreamMessageListenerContainerOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">hashKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">hashValueSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Consumer</span> consumer <span class="token operator">=</span> <span class="token class-name">Consumer</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>groupName<span class="token punctuation">,</span> consumerName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">StreamOffset</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> streamOffset <span class="token operator">=</span> <span class="token class-name">StreamOffset</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>streamKey<span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">lastConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Subscription</span> subscription <span class="token operator">=</span> messageListenerContainer<span class="token punctuation">.</span><span class="token function">receiveAutoAck</span><span class="token punctuation">(</span>consumer<span class="token punctuation">,</span> streamOffset<span class="token punctuation">,</span> record <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>subscription<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>messageListenerContainer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;소규모 애플리케이션 서버에서 레디스를 사용하고 있을때 RabbitMQ 또는 Apache Kafka와 같은 메시지 큐를 통해 비동기 이벤트에 대한 요구가 필요한 경우 별도의 메시지 큐 솔루션을 도입하는 것은 인프라 상 과도할 수도 있다. 이러한 경</summary>
      
    
    
    
    
    <category term="Redis Stream" scheme="https://kdevkr.github.io/tags/Redis-Stream/"/>
    
  </entry>
  
  <entry>
    <title>AWS RDS 슬로우 쿼리 로그의 커서 이름 이슈</title>
    <link href="https://kdevkr.github.io/aws-rds-slow-query-with-cursor-name./"/>
    <id>https://kdevkr.github.io/aws-rds-slow-query-with-cursor-name./</id>
    <published>2024-06-20T13:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.509Z</updated>
    
    <content type="html"><![CDATA[<p><img data-src="/images/posts/aws-rds-slow-query-with-cursor-name/01.png"></p><p>위 스크린샷의 14시와 15시 사이에 RDS 의 DB 인스턴스의 CPU 부하가 90% 이상을 초과했다. 이러한 상황의 경우 어떤 호스트에서 수행한 쿼리가 문제가 되고 있는지 알기 위해서 AWS Aurora PostgreSQL의 클러스터 또는 인스턴스 파라미터를 변경하여 <a href="https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/AuroraUserGuide/USER_LogAccess.Concepts.PostgreSQL.html#USER_LogAccess.Concepts.PostgreSQL.Query_Logging">쿼리 로깅을 활성화</a>하고 <a href="https://docs.aws.amazon.com/ko_kr/prescriptive-guidance/latest/tuning-postgresql-parameters/log-min-duration-statement.html">log_min_duration_statement</a>에 대한 값을 지정하면 해당 밀리초를 초과하여 수행한 쿼리에 대한 duration 로그를 기록하고 CloudWatch의 로그 인사이트에서 확인할 수 있다.</p><h4 id="FETCH-ALL-IN-rcursor-🤔"><a href="#FETCH-ALL-IN-rcursor-🤔" class="headerlink" title="FETCH ALL IN &quot;rcursor&quot; 🤔"></a>FETCH ALL IN &quot;rcursor&quot; 🤔</h4><p><img data-src="/images/posts/aws-rds-slow-query-with-cursor-name/02.png"></p><p>RDS 콘솔의 성능 개선 도우미에서 데이터베이스 로드와 상위 SQL 정보를 확인할 수 있는데 위와 같이 FETCH ALL IN &quot;rcursor&quot; 가 대부분의 로드로 기록되어있는 걸 볼 수 있다. 실제 SQL를 확인할 수 있는 것들 이외에 <code>rcursor</code> 란 것은 도대체 무엇을 의미하는 것인지 알아야할 것 같다. PL&#x2F;pgSQL 함수를 작성할 때 <a href="https://www.postgresql.org/docs/current/plpgsql-cursors.html">Cursor</a>를 선언하고 조회한 결과를 반환할 수 있다. 일반적으로 이야기하는 프로시저 함수를 의미하며 애플리케이션에서 사용중인 대부분의 함수의 커서 이름을 동일하게 지정하여 선언했다는 것을 의미한다.</p><p>기본적으로 커서 이름을 지정하지 않으면 자동으로 <code>&lt;unnamed cursor 1&gt;</code>와 같은 랜덤한 커서가 만들어지고 JDBC 에서 SQL 함수를 호출한 결과에서 커서 이름을 굳이 동일하게 지정할 필요는 없다. 따라서, 애플리케이션은 함수 정의 시 어떤 이름의 커서를 사용하는지에 대해서는 상관하지 않으며 SQL 함수를 관리하는 개발자 혹은 DBA가 관리하기 위한 이름일 뿐이다. 그래서 쉽게 관리하여 사용하기 위해 통일했던 것으로 생각된다.</p><h4 id="RDS-모니터링을-위한-커서-이름을-사용하세요"><a href="#RDS-모니터링을-위한-커서-이름을-사용하세요" class="headerlink" title="RDS 모니터링을 위한 커서 이름을 사용하세요."></a>RDS 모니터링을 위한 커서 이름을 사용하세요.</h4><p><img data-src="/images/posts/aws-rds-slow-query-with-cursor-name/03.png"></p><p>RDS 모니터링 및 슬로우 쿼리를 확인할 수 있도록 동일한 커서 이름이 아닌 SQL 함수별 별도의 커서 이름을 정의하여 구분하는게 필요하다. SQL 함수 작성 시 커서 이름은 함수 이름과 동일하게 하여 명확히 구분하기로 협의했고 위와 같이 오래 수행되는 슬로우 쿼리를 쉽게 확인할 수 있다. 기존에는 개발자가 슬로우 쿼리를 확인할 수 있도록 애플리케이션 서버에 로그가 출력되도록 했지만 이제는 개발자 뿐만 아니라 DB 혹은 인프라 엔지니어도 RDS 모니터링으로 슬로우 쿼리 구분이 가능하도록 변경하고 있다.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 여러분은 어떤 쿼리가 2초나 소요됬는지 파악할 수 있나요?</span>LOG:  duration: <span class="token number">2217.321</span> ms  execute <span class="token operator">&lt;</span>unnamed<span class="token operator">></span>: FETCH ALL IN <span class="token string">"rcursor"</span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img data-src=&quot;/images/posts/aws-rds-slow-query-with-cursor-name/01.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;위 스크린샷의 14시와 15시 사이에 RDS 의 DB 인스턴스의 CPU 부하가 90% 이상을 초과했다</summary>
      
    
    
    
    
    <category term="AWS RDS" scheme="https://kdevkr.github.io/tags/AWS-RDS/"/>
    
    <category term="PostgreSQL" scheme="https://kdevkr.github.io/tags/PostgreSQL/"/>
    
    <category term="Cursor" scheme="https://kdevkr.github.io/tags/Cursor/"/>
    
  </entry>
  
  <entry>
    <title>자바 메일 발송 시 장애 처리</title>
    <link href="https://kdevkr.github.io/java-mail-sender-limits/"/>
    <id>https://kdevkr.github.io/java-mail-sender-limits/</id>
    <published>2024-06-16T11:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.513Z</updated>
    
    <content type="html"><![CDATA[<p>스프링 프레임워크 기반의 애플리케이션 서버에서는 <code>JavaMailSenderImpl</code>을 사용하여 쉽게 <a href="https://docs.spring.io/spring-framework/reference/integration/email.html">이메일</a>을 보내는 기능을 구현할 수 있다. 그러나, 이메일 발송에 대한 인터페이스와 구현을 제공하므로 메일 발송 실패에 따른 장애 처리에 대해서는 별도로 고려해야할 필요가 있다. 예를 들어, 다수의 스레드로 이메일 대기열 큐를 빠르게 소진한다면 <a href="https://docs.aws.amazon.com/ko_kr/ses/latest/dg/manage-sending-quotas-errors.html">Amazon SES 계정의 발신 할당량과 관련된 오류</a> 중 초당 이메일 수에 대한 제한량을 넘어서는 경우 454 Throttling failure: Maximum sending rate exceeded 오류가 발생한다.</p><h4 id="ThreadPoolExecutor를-통한-메일-대기열-큐-병렬-처리"><a href="#ThreadPoolExecutor를-통한-메일-대기열-큐-병렬-처리" class="headerlink" title="ThreadPoolExecutor를 통한 메일 대기열 큐 병렬 처리"></a>ThreadPoolExecutor를 통한 메일 대기열 큐 병렬 처리</h4><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MimeMessage</span><span class="token punctuation">></span></span> waitingQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">MimeMessage</span> message <span class="token operator">=</span> waitingQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            javaMailSender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Mail-Thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>thread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>위 코드는 간단하게 메일 대기열 큐를 순차적으로 소진하는 단일 스레드로 이메일을 발송하는 코드로 대기열 큐에 쌓이는 메일의 수가 많아진다면 ThreadPoolExecutor를 사용하여 메일 발송에 대한 처리를 병렬로 수행할 수 있다. 메일 발송 처리를 병렬로 수행한다면 SMTP 서버의 발신 한도에 대해서 고려해야한다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> coreSize <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ThreadFactory</span> threadFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">"Mail-Thread-%d"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ThreadPoolExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>coreSize<span class="token punctuation">,</span> coreSize<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> threadFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MimeMessage</span><span class="token punctuation">></span></span> waitingQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>waitingQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">MimeMessage</span> message <span class="token operator">=</span> waitingQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                javaMailSender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Mail-Thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>thread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="Spring-Retry를-통한-메일-발송-실패-시-재시도-전략-Guide-to-Spring-Retry"><a href="#Spring-Retry를-통한-메일-발송-실패-시-재시도-전략-Guide-to-Spring-Retry" class="headerlink" title="Spring Retry를 통한 메일 발송 실패 시 재시도 전략 - Guide to Spring Retry"></a>Spring Retry를 통한 메일 발송 실패 시 재시도 전략 - <a href="https://www.baeldung.com/spring-retry">Guide to Spring Retry</a></h4><p>이메일 발송 실패 건에 대해서 Spring Retry를 통해 재시도 로직을 쉽게 구현할 수 있다. 메일 발송을 위한 RetryTemplate 구성 시 재시도 전략을 구성하고 메일을 발송하는 함수를 RetryTemplate로 감싸면 된다. context.getRetryCount() 함수를 통해 재시도 횟수를 가져올 수 있다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">RetryTemplate</span> retryTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RetryTemplateBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">maxAttempts</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">exponentialBackoff</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMinutes</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">retryOn</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">MessagingException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">MailException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MimeMessage</span><span class="token punctuation">></span></span> waitingQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>waitingQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        retryTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>context <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">MimeMessage</span> message <span class="token operator">=</span> waitingQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                javaMailSender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Mail-Thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>thread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="Guava-RateLimiter를-통한-초당-이메일-발송-시도-제한-Quick-Guide-to-the-Guava-RateLimiter"><a href="#Guava-RateLimiter를-통한-초당-이메일-발송-시도-제한-Quick-Guide-to-the-Guava-RateLimiter" class="headerlink" title="Guava RateLimiter를 통한 초당 이메일 발송 시도 제한 - Quick Guide to the Guava RateLimiter"></a>Guava RateLimiter를 통한 초당 이메일 발송 시도 제한 - <a href="https://www.baeldung.com/guava-rate-limiter">Quick Guide to the Guava RateLimiter</a></h4><p>AWS SES의 발신 한도 중에는 초당 보낼 수 있는 이메일 수에 대한 제한량이 있으므로 Guava RateLimiter를 통해 초당 이메일 발송 수를 넘어서지 않도록 방어하는 코드를 작성할 수 있다. 물론, SMTP 서버를 다수의 애플리케이션 서버에서도 연결할 가능성이 있으므로 발신 할당량에 대한 모니터링 및 발신 한도를 별도로 관리할 필요는 있다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">RateLimiter</span> rateLimiter <span class="token operator">=</span> <span class="token class-name">RateLimiter</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>waitingQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">boolean</span> acquire <span class="token operator">=</span> rateLimiter<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>acquire<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                    <span class="token class-name">MimeMessage</span> message <span class="token operator">=</span> waitingQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    javaMailSender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Mail-Thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>thread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>Guava RateLimiter는 초당 호출에 대한 제한만 가능하므로 분당 이메일 발송을 제한하고 싶다면 Resilience4j의 RateLimiter를 도입해야합니다.</p></blockquote><h4 id="Resilience4j-CircuitBreaker를-통한-메일-발송-중단-Guide-to-Resilience4j"><a href="#Resilience4j-CircuitBreaker를-통한-메일-발송-중단-Guide-to-Resilience4j" class="headerlink" title="Resilience4j CircuitBreaker를 통한 메일 발송 중단 - Guide to Resilience4j"></a>Resilience4j CircuitBreaker를 통한 메일 발송 중단 - <a href="https://www.baeldung.com/resilience4j">Guide to Resilience4j</a></h4><p>SMTP 서버의 발신 한도 제한을 넘어서는 경우에 대한 장애 처리를 위해 <a href="https://github.com/resilience4j/resilience4j">Resilience4j</a>를 도입할 수 있다. 하루동안 메일을 보낼 수 있는 할당량을 초과하거나 초당 보낼 수 있는 이메일 수에 제한이 되었다면 일정 시간동안 이메일 발송을 시도하지 않도록 <code>CircuitBreaker</code>를 사용하여 장애 전파 방지를 구현할 수 있다. AWS SES의 발신 한도인 아래의 두개 항목에 대해서 처리를 고려하도록 하자.</p><ul><li>454 Throttling failure: Maximum sending rate exceeded (1초당 이메일 발송 수 제한량)</li><li>454 Throttling failure: Daily message quota exceeded (24시간 당 이메일 발송 할당량)</li></ul><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">CircuitBreaker</span> circuitBreaker <span class="token operator">=</span> <span class="token class-name">CircuitBreaker</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token string">"MailSendingLimitExceeded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">RateLimiter</span> rateLimiter <span class="token operator">=</span> <span class="token class-name">RateLimiter</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>waitingQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">boolean</span> permission <span class="token operator">=</span> circuitBreaker<span class="token punctuation">.</span><span class="token function">tryAcquirePermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        permission <span class="token operator">&amp;=</span> rateLimiter<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>permission<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                    <span class="token class-name">MimeMessage</span> message <span class="token operator">=</span> waitingQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    javaMailSender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token class-name">String</span> failReason <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>failReason <span class="token operator">!=</span> <span class="token keyword">null</span>                            <span class="token operator">&amp;&amp;</span> failReason<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"454 Throttling failure"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        circuitBreaker<span class="token punctuation">.</span><span class="token function">transitionToClosedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>failReason<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Mail-Thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>thread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="JavaMailSenderImpl은-매번-연결한다"><a href="#JavaMailSenderImpl은-매번-연결한다" class="headerlink" title="JavaMailSenderImpl은 매번 연결한다?!"></a>JavaMailSenderImpl은 매번 연결한다?!</h4><p>일부 시스템 환경에서 AWS SES의 SMTP 서버를 동일한 리전이 아닌 상당히 멀리 떨어져있는 리전에 구성된 SMTP를 통해 메일 발송을 시도하는 경우 커넥션에 대한 소요 시간이 크다는 것을 알 수 있었다. 예를 들어, US East (Ohio) 리전의 SMTP 엔드포인트를 Asia Pacific (Seoul) 리전에서 연결하는 경우 약 2초 정도의 시간이 소요되는데 동일한 리전에서 연결하면 약 100ms 가 걸린다. </p><p>JavaMailSenderImpl의 connectTransport 함수를 사용하여 testConnection 또는 doSend 함수에서 연결을 수행하는 것을 확인할 수 있는데 MimeMessage 목록을 send 함수 파라미터로 전달할 때 연결을 수행하고 해제하므로 이메일을 하나씩 보내도록 구현했다면 이메일을 보낼때마다 연결을 수행하는 것이다.</p><pre class="language-java" data-language="java"><div class="caption"><span>JavaMailSenderImpl</span></div><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Transport</span> <span class="token function">connectTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MessagingException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        username <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            password <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">Transport</span> transport <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTransport</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    transport<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> transport<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p><a href="https://www.simplejavamail.org/configuration.html#section-reusing-connections">SimpleJavaMail의 Batch Module</a>은 Transport 연결에 대한 커넥션 풀을 사용한다고 되어있으므로 SMTP 서버로의 연결 수행시간이 오래걸린다면 Transport 에 대한 커넥션 풀을 이용해보는 것도 좋은 방법으로 생각된다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;스프링 프레임워크 기반의 애플리케이션 서버에서는 &lt;code&gt;JavaMailSenderImpl&lt;/code&gt;을 사용하여 쉽게 &lt;a href=&quot;https://docs.spring.io/spring-framework/reference/integratio</summary>
      
    
    
    
    
    <category term="JavaMailSenderImpl" scheme="https://kdevkr.github.io/tags/JavaMailSenderImpl/"/>
    
    <category term="Simple Email Service" scheme="https://kdevkr.github.io/tags/Simple-Email-Service/"/>
    
    <category term="Sending Limits" scheme="https://kdevkr.github.io/tags/Sending-Limits/"/>
    
  </entry>
  
  <entry>
    <title>AWS NLB ECDSA TLS 오프로드</title>
    <link href="https://kdevkr.github.io/aws-nlb-tls-ecdsa/"/>
    <id>https://kdevkr.github.io/aws-nlb-tls-ecdsa/</id>
    <published>2024-05-25T14:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.509Z</updated>
    
    <content type="html"><![CDATA[<h4 id="AWS-인증서-관련-히스토리"><a href="#AWS-인증서-관련-히스토리" class="headerlink" title="AWS 인증서 관련 히스토리"></a>AWS 인증서 관련 히스토리</h4><ul><li><a href="https://aws.amazon.com/ko/about-aws/whats-new/2021/07/aws-certificate-manager-provides-expanded-usage-imported-ecdsa-rsa-certificates/">AWS Certificate Manager, 가져온 ECDSA 및 RSA 인증서의 확장된 사용 제공</a></li><li><a href="https://aws.amazon.com/ko/about-aws/whats-new/2022/11/aws-certificate-manager-elliptic-curve-digital-signature-algorithm-tls-certificates/">AWS Certificate Manager, 이제 Elliptic Curve Digital Signature Algorithm TLS 인증서 지원</a></li><li><a href="https://aws.amazon.com/ko/about-aws/whats-new/2024/01/network-load-balancer-rsa-3072-bit-ecdsa-256-384-521-bit-certificates/">Network Load Balancer, 이제 AWS Certificate Manager를 통한 RSA 3072-비트, ECDSA 256&#x2F;384&#x2F;521-비트 인증서 지원</a></li></ul><p>위 기록처럼 2021년 7월 부터 AWS Certificate Manager에서 외부에서 발급된 ECDSA 인증서를 가져와서 등록할 수 있게 지원하였고 2022년 11월 부터는 ACM 자체적으로 ECDSA 인증서 발급을 지원한다. 그리고 시간이 흘러 2024년 1월부터는 <a href="https://aws.amazon.com/ko/about-aws/whats-new/2024/01/network-load-balancer-rsa-3072-bit-ecdsa-256-384-521-bit-certificates/">Network Load Balancer 에서도 ECDSA 인증서 등록을 지원</a>한다.</p><p><img data-src="/images/posts/aws-nlb-tls-ecdsa/01.png"></p><blockquote><p>위 화면은 ACM 외부에서 발급된 ECDSA 인증서를 가져온 예시를 보여줍니다.</p></blockquote><h4 id="Network-Load-Balancer-TLS-리스너-구성"><a href="#Network-Load-Balancer-TLS-리스너-구성" class="headerlink" title="Network Load Balancer TLS 리스너 구성"></a>Network Load Balancer TLS 리스너 구성</h4><p>그동안 ELB 에서 ECDSA 인증서로 TLS 오프로드를 처리하기 위해서는 오직 ALB(Application Load Balancer)를 구성해야했다. 이제는 <code>NLB(Network Load Balancer)</code>로 구성하고 <a href="https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/network/create-tls-listener.html">TLS 리스너</a>에서 ACM에 추가되어있는 <code>ECDSA 인증서</code>를 선택하여 구성할 수 있다.</p><p><img data-src="/images/posts/aws-nlb-tls-ecdsa/02.png"></p><blockquote><p>하지만, NLB가 TLS 리스너를 사용하는 경우 mTLS는 지원하지 못하는 구성이 되는 것은 일부 시스템에서 중요한 부분일 수 있습니다.</p></blockquote><h4 id="대상-그룹-프록시-프로토콜-v2"><a href="#대상-그룹-프록시-프로토콜-v2" class="headerlink" title="대상 그룹 - 프록시 프로토콜 v2"></a>대상 그룹 - 프록시 프로토콜 v2</h4><p>NLB 는 ALB와는 다르게 L4 레벨로 동작하므로 HTTP 트래픽을 HTTPS로 리다이렉트하는 것을 지원하지 못한다. ChatGPT에게 물어보더라도 TCP 리스너로 구성하고 Nginx와 같은 별도의 로드밸런서에서 TLS 오프로드를 처리함과 동시에 <code>Forward http to https</code> 를 적용하는 예시를 설명한다.</p><p>사내 엔지니어와 삽질을 해본결과 로드 밸런서에 연결되는 대상 그룹에서 <code>프록시 프로토콜 v2</code>를 활성화하면 Elastic Beanstalk의 Nginx 플랫폼에서 <a href="https://docs.nginx.com/nginx/admin-guide/load-balancer/using-proxy-protocol/">PROXY Protocol</a>을 통해 <code>$proxy_protocol_server_port</code> 속성을 사용할 수 있음을 확인했다. 더 나아가서는 <code>$proxy_protocol_addr</code> 속성으로 실제로 트래픽을 전달한 <code>클라이언트 IP</code>를 액세스 로그에 출력하거나 <code>X-Forwarded-For</code> 헤더로 애플리케이션까지 전달할 수 있어보인다.</p><p><img data-src="/images/posts/aws-nlb-tls-ecdsa/03.png"></p><pre class="language-conf" data-language="conf"><code class="language-conf">http &#123;    server &#123;        listen 80 proxy_protocol;        if ($proxy_protocol_server_port &#x3D; 80) &#123;            return 301 https:&#x2F;&#x2F;$host$request_uri;        &#125;    &#125;&#125;</code></pre><blockquote><p>NLB 에서 Nginx로 전달할 때 사용한 포트가 80 이라면 HTTP 요청으로 간주하고 HTTPS 요청으로 전달될 수 있도록 301 응답을 처리했습니다.</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;AWS-인증서-관련-히스토리&quot;&gt;&lt;a href=&quot;#AWS-인증서-관련-히스토리&quot; class=&quot;headerlink&quot; title=&quot;AWS 인증서 관련 히스토리&quot;&gt;&lt;/a&gt;AWS 인증서 관련 히스토리&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;htt</summary>
      
    
    
    
    
    <category term="AWS NLB" scheme="https://kdevkr.github.io/tags/AWS-NLB/"/>
    
    <category term="ECDSA" scheme="https://kdevkr.github.io/tags/ECDSA/"/>
    
  </entry>
  
  <entry>
    <title>젠킨스 도커 멀티 플랫폼 빌드</title>
    <link href="https://kdevkr.github.io/jenkins-docker-buildx/"/>
    <id>https://kdevkr.github.io/jenkins-docker-buildx/</id>
    <published>2024-05-24T11:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.513Z</updated>
    
    <content type="html"><![CDATA[<p>젠킨스에서 Docker Plugin 을 사용해서 Dockerfile을 통해 쉽게 도커 이미지를 빌드할 수 있다. 아마존 웹 서비스와 같은 클라우드 서비스에서는 x86_64(AMD64) 아키텍처 뿐만 아니라 ARM64 아키텍처 기반의 더 저렴하고 성능이 좋은 서버를 활용할 수 있다. 기본적인 도커 이미지 빌드 명령어는 빌드를 시도하는 서버와 동일한 아키텍처에 대한 이미지만 만들 수 있으므로 <a href="https://docs.docker.com/build/building/multi-platform/">멀티 플랫폼 이미지</a>를 만들기 위해서는 <a href="https://docs.docker.com/reference/cli/docker/buildx/">Buildkit</a>을 이용해야한다.</p><h4 id="Jenkins-사용자-도커-그룹에-추가"><a href="#Jenkins-사용자-도커-그룹에-추가" class="headerlink" title="Jenkins 사용자 도커 그룹에 추가"></a>Jenkins 사용자 도커 그룹에 추가</h4><p>젠킨스가 설치된 서버에 실행되어있는 도커 엔진으로 빌드할 수 있도록 도커 그룹에 젠킨스 사용자를 포함시켜야한다. 젠킨스 사용자를 도커 그룹에 추가하고나서는 도커와 젠킨스 모두 재실행을 수행하여야 한다.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">usermod</span> <span class="token parameter variable">-aG</span> <span class="token function">docker</span> jenkins<span class="token function">sudo</span> systemctl restart jenkins<span class="token function">sudo</span> systemctl restart <span class="token function">docker</span></code></pre><h4 id="QEMU-설치"><a href="#QEMU-설치" class="headerlink" title="QEMU 설치"></a>QEMU 설치</h4><p>윈도우와 맥 환경에서 사용하는 도커 데스크탑에는 QEMU 을 포함하고 있어 쉽게 멀티 플랫폼 이미지를 빌드할 수 있다. 하지만, 일반적으로 젠킨스를 설치하는 리눅스 서버에서는 <a href="https://docs.docker.com/build/building/multi-platform/#qemu-without-docker-desktop">QEMU</a>의 도움을 받기 위해서 직접 설치해야한다.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token parameter variable">--privileged</span> <span class="token parameter variable">--rm</span> tonistiigi/binfmt <span class="token parameter variable">--install</span> all</code></pre><h4 id="Docker-Build-Cloud-를-빌더로-이용하기"><a href="#Docker-Build-Cloud-를-빌더로-이용하기" class="headerlink" title="Docker Build Cloud 를 빌더로 이용하기"></a>Docker Build Cloud 를 빌더로 이용하기</h4><p><a href="https://docs.docker.com/build/cloud/">Docker Build Cloud</a>를 이용하여 빌드하기 위해서는 cloud 드라이버를 지원하는 buildx 버전을 설치해야한다. <a href="https://github.com/docker/buildx-desktop">buildx-desktop</a> 에서 리눅스 서버에 맞는 바이너리 파일을 다운받아서 젠킨스 계정에서 바라보는 도커 경로에 docker-buildx 플러그인으로 추가하자.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 젠킨스 사용자로 전환</span><span class="token function">sudo</span> <span class="token function">su</span> jenkins <span class="token parameter variable">-s</span> /bin/bash<span class="token comment"># cloud 드라이버를 지원하는 Buildx 설치</span><span class="token function">wget</span> https://github.com/docker/buildx-desktop/releases/download/v0.14.0-desktop.1/buildx-v0.14.0-desktop.1.linux-amd64<span class="token function">mv</span> buildx-v0.14.0-desktop.1.linux-amd64 ~/docker/cli-plugins/docker-buildx<span class="token function">chmod</span> a+x ~/.docker/cli-plugins/docker-buildx<span class="token comment"># Buildx 버전 확인</span><span class="token function">docker</span> buildx versiongithub.com/docker/buildx v0.14.0-desktop.1 7b0470cffd54ccbf42976d2f75febc4532c85073<span class="token comment"># Docker Build Cloud 빌더 추가</span><span class="token function">docker</span> buildx create <span class="token parameter variable">--driver</span> xxxinc/builder <span class="token parameter variable">--use</span><span class="token function">docker</span> buildx <span class="token function">ls</span>NAME/NODE               DRIVER/ENDPOINT                          STATUS    BUILDKIT       PLATFORMScloud-eipgridinc-ddd*   cloud <span class="token punctuation">\</span>_ linux-amd64          <span class="token punctuation">\</span>_ cloud://xxxinc/builder_linux-amd64   running   v0.13.1        linux/amd64*, linux/amd64/v2, linux/amd64/v3, linux/amd64/v4, linux/386 <span class="token punctuation">\</span>_ linux-arm64          <span class="token punctuation">\</span>_ cloud://xxxinc/builder_linux-arm64   running   v0.13.1        linux/arm64*, linux/arm64/v6, linux/arm64/v7default                 <span class="token function">docker</span> <span class="token punctuation">\</span>_ default              <span class="token punctuation">\</span>_ default                              running   v0.8+unknown   linux/amd64, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/arm/v7, linux/arm/v6</code></pre><blockquote><p>Docker Build Cloud 환경에서 빌드하므로 –bootstrap 옵션으로 빌더 초기화를 수행할 필요가 없습니다.</p></blockquote><h4 id="Jenkins-에서-빌드하기"><a href="#Jenkins-에서-빌드하기" class="headerlink" title="Jenkins 에서 빌드하기"></a>Jenkins 에서 빌드하기</h4><p>Docker Plugin 에서는 buildx 명령어를 선택할 수 없기 때문에 Execute Shell 을 선택해서 직접 buildx 명령어를 사용하는 스크립트를 작성해야한다. 아래의 스크립트에서 도커 계정에 로그인하기 위해서 젠킨스 사용자의 config.json 을 이용하게 했다.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Log in to Docker Hub</span><span class="token builtin class-name">echo</span> <span class="token string">"Logging into Docker Hub..."</span><span class="token function">docker</span> login<span class="token assign-left variable">BUILDER_NAME</span><span class="token operator">=</span><span class="token string">"cloud-xxxinc-builder"</span><span class="token comment"># Check if the builder already exists</span><span class="token assign-left variable">BUILDER_EXISTS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> buildx <span class="token function">ls</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"<span class="token variable">$BUILDER_NAME</span>"</span> <span class="token operator">||</span> <span class="token boolean">true</span><span class="token variable">)</span></span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">"<span class="token variable">$BUILDER_EXISTS</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token builtin class-name">echo</span> <span class="token string">"Creating new builder instance..."</span>  <span class="token function">docker</span> buildx create <span class="token parameter variable">--name</span> <span class="token string">"<span class="token variable">$BUILDER_NAME</span>"</span> <span class="token parameter variable">--driver</span> cloud xxxinc/builder <span class="token parameter variable">--use</span><span class="token keyword">else</span>  <span class="token builtin class-name">echo</span> <span class="token string">"Using existing builder instance..."</span>  <span class="token function">docker</span> buildx use <span class="token string">"<span class="token variable">$BUILDER_NAME</span>"</span><span class="token keyword">fi</span><span class="token comment"># List the builder instances</span><span class="token function">docker</span> buildx <span class="token function">ls</span><span class="token comment"># Install QEMU emulators for building multi-architecture images</span><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token parameter variable">--privileged</span> tonistiigi/binfmt <span class="token parameter variable">--install</span> all<span class="token comment"># build</span><span class="token builtin class-name">echo</span> <span class="token string">"Building Docker image using Buildx with Docker Build Cloud..."</span><span class="token function">docker</span> buildx build <span class="token parameter variable">--platform</span> linux/amd64,linux/arm64 <span class="token parameter variable">-t</span> xxxinc/testapp:<span class="token variable">$&#123;version&#125;</span>-buildx <span class="token parameter variable">--push</span> <span class="token builtin class-name">.</span></code></pre><h4 id="Optional-HDF5-for-ARM64"><a href="#Optional-HDF5-for-ARM64" class="headerlink" title="(Optional) HDF5 for ARM64"></a>(Optional) HDF5 for ARM64</h4><p>ARM64 아키텍처로 빌드하는 경우에만 <code>ValueError: did not find HDF5 headers</code> 가 발생하는 것을 경험했다. 검색 결과 아래의 세개의 패키지를 설치하는 것으로 해결이 되었다.</p><ul><li>libhdf5-serial-dev</li><li>netcdf-bin</li><li>libnetcdf-dev</li></ul><pre class="language-docker" data-language="docker"><div class="caption"><span>Dockerfile</span></div><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> python:3.8-slim-buster</span><span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; apt-get install -y <span class="token operator">\</span>    gcc  <span class="token operator">\</span>    libpq-dev <span class="token operator">\</span>    libhdf5-serial-dev <span class="token operator">\</span>    netcdf-bin \ </span>    libnetcdf-dev</code></pre><h4 id="문제-해결에-도움이-된-글"><a href="#문제-해결에-도움이-된-글" class="headerlink" title="문제 해결에 도움이 된 글"></a>문제 해결에 도움이 된 글</h4><ul><li><a href="https://hotfoxy.tistory.com/114">jenkins(image) 에서 docker buildx를 사용하고 싶어요!</a></li><li><a href="https://forums.docker.com/t/docker-buildx-failed-to-find-driver-cloud/141238/4">Docker buildx “failed to find driver”</a></li><li><a href="https://stackoverflow.com/a/36165209">https://stackoverflow.com/a/36165209</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;젠킨스에서 Docker Plugin 을 사용해서 Dockerfile을 통해 쉽게 도커 이미지를 빌드할 수 있다. 아마존 웹 서비스와 같은 클라우드 서비스에서는 x86_64(AMD64) 아키텍처 뿐만 아니라 ARM64 아키텍처 기반의 더 저렴하고 </summary>
      
    
    
    
    
    <category term="Jenkins" scheme="https://kdevkr.github.io/tags/Jenkins/"/>
    
    <category term="Docker" scheme="https://kdevkr.github.io/tags/Docker/"/>
    
    <category term="Buildx" scheme="https://kdevkr.github.io/tags/Buildx/"/>
    
  </entry>
  
  <entry>
    <title>스프링 시큐리티 JWT 사용자 테스트</title>
    <link href="https://kdevkr.github.io/spring-security-jwt-user-test/"/>
    <id>https://kdevkr.github.io/spring-security-jwt-user-test/</id>
    <published>2024-03-27T12:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.517Z</updated>
    
    <content type="html"><![CDATA[<p>JWT 기반의 인증을 구성한 프로젝트에서 테스트 코드에 대한 사용자를 만들기 위해서 <code>WithSecurityContext</code> 와 <code>WithSecurityContextFactory</code> 를 사용해서 가상의 사용자와 토큰을 발급하는 코드를 구현하면 되는 것으로 알려져 있다. 하지만, 신규 프로젝트에서는 단일 애플리케이션이 아닌 인증의 기반이 되는 외부 플랫폼 애플리케이션에 요청하여 인증을 수행하고 권한을 처리하도록 로직을 구성하여 단순히 <strong>가상의 사용자가 아닌 실제로 존재하는 사용자로 인증할 수 있는 컨텍스트</strong>를 만들어야 했다. 사용자 테스트를 위한 컨텍스트를 적용하기 위해 아래와 같이 작성했다.</p><pre class="language-java" data-language="java"><div class="caption"><span>WithMockUser</span></div><code class="language-java"><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span><span class="token annotation punctuation">@WithSecurityContext</span><span class="token punctuation">(</span>factory <span class="token operator">=</span> <span class="token class-name">WithMockUserSecurityContextFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">WithMockUser</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> <span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"kdevkr@gmail.com"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><div class="caption"><span>WithMockUserSecurityContextFactory</span></div><code class="language-java"><span class="token annotation punctuation">@RequiredArgsConstructor</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WithMockUserSecurityContextFactory</span> <span class="token keyword">implements</span> <span class="token class-name">WithSecurityContextFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WithMockUser</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JwtTokenProvider</span> jwtTokenProvider<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">SecurityContext</span> <span class="token function">createSecurityContext</span><span class="token punctuation">(</span><span class="token class-name">WithMockUser</span> mockUser<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">SecurityContext</span> context <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> optionalUser <span class="token operator">=</span> <span class="token function">getUserById</span><span class="token punctuation">(</span>mockUser<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>optionalUser<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">User</span> user <span class="token operator">=</span> optionalUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JwtToken</span><span class="token punctuation">></span></span> token <span class="token operator">=</span> <span class="token function">getToken</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">String</span> accessToken <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> jwtTokenProvider<span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>                context<span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> context<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="No-thread-bound-request-found"><a href="#No-thread-bound-request-found" class="headerlink" title="No thread-bound request found"></a>No thread-bound request found</h4><blockquote><p>java.lang.IllegalStateException: No thread-bound request found: Are you referring to request attributes outside of an actual web request, or processing a request outside of the originally receiving thread? If you are actually operating within a web request and still receive this message, your code is probably running outside of DispatcherServlet: In this case, use RequestContextListener or RequestContextFilter to expose the current request.</p></blockquote><p>서비스 레이어의 클래스에서 요청 스레드에서 토큰 정보를 조회하기 위해 <code>RequestContextHolder</code> 를 사용하여 현재 요청에 대한 <code>Authorization</code> 헤더를 가져오는 로직으로 인해 발생한 문제라고 할 수 있다. 서비스 레벨의 테스트 코드에서는 컨트롤러를 통한 로직을 수행한 스레드가 아니기 때문에 기본적으로는 조회할 수 없다. 오류 메시지에 포함된 <code>RequestContextListener</code> 가 해결방안이 될 수 있다. <a href="https://github.com/spring-projects/spring-framework/blob/main/spring-web/src/test/java/org/springframework/web/context/request/RequestContextListenerTests.java">RequestContextListenerTests.java</a> 를 참고하여 RequestContextListener 클래스를 통해 요청에 대한 스레드를 구성할 수 있음을 확인했으며 MockHttpServletRequest를 통해 ServletRequestAttributes를 RequestContextHolder의 스레드 로컬에 반영되게 하여 컨트롤러 레벨이 아닌 서비스 레벨에서도 인증된 사용자 기반의 테스트를 수행할 수 있게 하였다. </p><pre class="language-java" data-language="java"><div class="caption"><span>WithMockUserSecurityContextFactory</span></div><code class="language-java"><span class="token annotation punctuation">@RequiredArgsConstructor</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WithMockUserSecurityContextFactory</span> <span class="token keyword">implements</span> <span class="token class-name">WithSecurityContextFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WithMockUser</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JwtTokenProvider</span> jwtTokenProvider<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">SecurityContext</span> <span class="token function">createSecurityContext</span><span class="token punctuation">(</span><span class="token class-name">WithMockUser</span> mockUser<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">SecurityContext</span> context <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">RequestContextListener</span> listener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestContextListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">MockServletContext</span> servletContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MockServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">MockHttpServletRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MockHttpServletRequest</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>        listener<span class="token punctuation">.</span><span class="token function">requestInitialized</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServletRequestEvent</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> optionalUser <span class="token operator">=</span> <span class="token function">getUserById</span><span class="token punctuation">(</span>mockUser<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>optionalUser<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">User</span> user <span class="token operator">=</span> optionalUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JwtToken</span><span class="token punctuation">></span></span> token <span class="token operator">=</span> <span class="token function">getToken</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">String</span> accessToken <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> jwtTokenProvider<span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>                context<span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>                request<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">AUTHORIZATION</span><span class="token punctuation">,</span> <span class="token string">"Bearer %s"</span><span class="token punctuation">.</span><span class="token function">formatted</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">ServletRequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">setRequestAttributes</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> context<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="참고-링크"><a href="#참고-링크" class="headerlink" title="참고 링크"></a>참고 링크</h4><ul><li><a href="https://tecoble.techcourse.co.kr/post/2020-09-30-spring-security-test/">Spring Security가 적용된 곳을 효율적으로 테스트하자.</a></li><li><a href="https://stackoverflow.com/a/9430545">https://stackoverflow.com/a/9430545</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;JWT 기반의 인증을 구성한 프로젝트에서 테스트 코드에 대한 사용자를 만들기 위해서 &lt;code&gt;WithSecurityContext&lt;/code&gt; 와 &lt;code&gt;WithSecurityContextFactory&lt;/code&gt; 를 사용해서 가상의 사용자와</summary>
      
    
    
    
    
    <category term="WithSecurityContext" scheme="https://kdevkr.github.io/tags/WithSecurityContext/"/>
    
    <category term="WithSecurityContextFactory" scheme="https://kdevkr.github.io/tags/WithSecurityContextFactory/"/>
    
    <category term="RequestContextListener" scheme="https://kdevkr.github.io/tags/RequestContextListener/"/>
    
  </entry>
  
  <entry>
    <title>Request Header Is Too Large</title>
    <link href="https://kdevkr.github.io/request-header-is-too-large/"/>
    <id>https://kdevkr.github.io/request-header-is-too-large/</id>
    <published>2024-03-26T14:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.517Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>java.lang.IllegalArgumentException: Request header is too large</p></blockquote><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/by-ids"</span><span class="token punctuation">)</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"ids"</span><span class="token punctuation">)</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ids<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>위와 같은 GET API는 ids 파라미터에 대한 길이 제한을 두지 않았으므로 Request header is too large 에 대한 취약점이 내재되어있는 상태로 볼 수 있다. 그렇다면 이에 대한 문제는 어떻게 처리하는 것이 좋을까?</p><h4 id="첫번째-서버에서-처리하는-헤더-크기-사이즈를-늘리자"><a href="#첫번째-서버에서-처리하는-헤더-크기-사이즈를-늘리자" class="headerlink" title="첫번째, 서버에서 처리하는 헤더 크기 사이즈를 늘리자"></a>첫번째, 서버에서 처리하는 헤더 크기 사이즈를 늘리자</h4><p>기본적인 해결방법은 생각보다 작게 설정되어있는 헤더 크기를 어느정도 늘리는 것이다. 다만, 여전히 예상할 수 없는 헤더 크기를 커버할 수 없으며 이에 대한 대응으로는 GET 요청이 아닌 POST 요청을 활용해야한다. 요청 헤더 크기에 대한 제한을 늘리는 방안은 임시 조치임을 잊지 말자.</p><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server.max-http-request-header-size</span><span class="token punctuation">:</span> 10MB</code></pre><h4 id="두번째-URL-인코딩-방식의-폼-데이터를-전달하자"><a href="#두번째-URL-인코딩-방식의-폼-데이터를-전달하자" class="headerlink" title="두번째, URL 인코딩 방식의 폼 데이터를 전달하자"></a>두번째, URL 인코딩 방식의 폼 데이터를 전달하자</h4><p>GET 요청 시 쿼리 파라미터가 너무 길어질 수 있다면 폼 데이터 형식으로 보낼 수 있도록 <strong>POST 요청에 대해서도 지원</strong>하면 된다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/by-ids"</span><span class="token punctuation">)</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"ids"</span><span class="token punctuation">)</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ids<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">"/by-ids"</span><span class="token punctuation">,</span> consumes <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_FORM_URLENCODED_VALUE</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token function">getUsersUsingFormData</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"ids"</span><span class="token punctuation">)</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ids<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">getUsers</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="참고할만한-링크"><a href="#참고할만한-링크" class="headerlink" title="참고할만한 링크"></a>참고할만한 링크</h4><ul><li><a href="https://www.baeldung.com/spring-boot-max-http-header-size">Max-Http-Request-Header-Size in Spring Boot</a></li><li><a href="https://www.baeldung.com/postman-form-data-raw-x-www-form-urlencoded">Difference Between form-data, x-www-form-urlencoded and raw in Postman</a></li><li><a href="https://www.baeldung.com/spring-url-encoded-form-data">Handling URL Encoded Form Data in Spring REST</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;java.lang.IllegalArgumentException: Request header is too large&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre class=&quot;language-java&quot; data-language=&quot;</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>비밀번호 재설정 절차</title>
    <link href="https://kdevkr.github.io/reset-password-flow/"/>
    <id>https://kdevkr.github.io/reset-password-flow/</id>
    <published>2024-03-22T13:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.517Z</updated>
    
    <content type="html"><![CDATA[<p>비밀번호 찾기는 대부분의 시스템에서 사용자에게 반드시 요구되는 기능이다. 오래된 레거시 시스템이 아닌 이상 사용자 계정에 대한 비밀번호는 복호화가 불가능하도록 단방향 암호화된 값으로 데이터베이스에 저장된다. 그래서 실질적으로 <strong>비밀번호 찾기 자체의 요구사항은 구현할 수 없다.</strong> 회원가입 시 입력한 비밀번호를 찾을 수는 없으므로 대부분 비밀번호 없이 본인 인증을 통해 로그인할 수 있게 하거나 비밀번호를 재설정할 수 있는 방법을 제공한다.</p><ul><li><a href="https://github.com/password_reset">https://github.com/password_reset</a></li><li><a href="https://account.samsung.com/accounts/odchb/resetPasswordGate">https://account.samsung.com/accounts/odchb/resetPasswordGate</a></li><li><a href="https://sslmember2.gmarket.co.kr/FindPW/FindPW">https://sslmember2.gmarket.co.kr/FindPW/FindPW</a></li><li><a href="https://www.jobplanet.co.kr/users/password/new">https://www.jobplanet.co.kr/users/password/new</a></li></ul><h4 id="비밀번호-재설정-또는-초기화"><a href="#비밀번호-재설정-또는-초기화" class="headerlink" title="비밀번호 재설정 또는 초기화"></a>비밀번호 재설정 또는 초기화</h4><p>비밀번호 재설정 절차에 대해서 더 자세하게 알아보도록 하자.</p><ol><li>비밀번호를 찾고자하는 사용자에게 아이디 또는 이메일 입력을 요구</li><li>(Optional) 무분별한 요구를 제한하기 위해서 캡차 또는 <a href="https://www.baeldung.com/spring-bucket4j">요청 제한량</a>을 구현</li><li>사용자에게 <strong>인증</strong>할 수 있는 <strong><a href="https://cheatsheetseries.owasp.org/cheatsheets/Forgot_Password_Cheat_Sheet.html#url-tokens">URL 토큰</a></strong> 링크를 제공</li><li>(Optional) URL 토큰과 함께 인증 코드 입력을 요구</li><li>사용자가 비밀번호 변경을 <strong>완료</strong>했다면 URL 토큰은 즉시 <strong>만료</strong></li><li>사용자에 의해 비밀번호가 변경되었음을 별도 <strong>알림</strong> 제공</li></ol><blockquote><p>URL 쿼리스트링에 포함되는 인증 정보는 JWT 토큰을 사용하지 않는게 일반적입니다.</p></blockquote><p>유튜브 <a href="https://www.youtube.com/watch?v=b5xWS8MYl0Q">제미니의 개발실무</a>에서 개발 요구사항에 대해 그대로 구현하는게 아니라 개발자 입장에서 필요하거나 고려되어야할 부분에 대해서 체크하는 것도 개발자의 역량이라는 부분을 이야기하는 것을 보고 대부분의 시스템에서 요구하는 <strong>비밀번호 찾기</strong>에 대해서 살펴보았다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;비밀번호 찾기는 대부분의 시스템에서 사용자에게 반드시 요구되는 기능이다. 오래된 레거시 시스템이 아닌 이상 사용자 계정에 대한 비밀번호는 복호화가 불가능하도록 단방향 암호화된 값으로 데이터베이스에 저장된다. 그래서 실질적으로 &lt;strong&gt;비밀번</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>레디스 웹소켓 알람 동기화</title>
    <link href="https://kdevkr.github.io/spring-boot-redis-websocket-sync/"/>
    <id>https://kdevkr.github.io/spring-boot-redis-websocket-sync/</id>
    <published>2024-03-14T14:00:00.000Z</published>
    <updated>2024-08-07T14:07:29.517Z</updated>
    
    <content type="html"><![CDATA[<h4 id="웹소켓-알람-갱신-동기화"><a href="#웹소켓-알람-갱신-동기화" class="headerlink" title="웹소켓 알람 갱신 동기화"></a>웹소켓 알람 갱신 동기화</h4><p>대부분의 예제는 채팅으로 공유되고 있지만 일반적인 웹 애플리케이션에서의 웹소켓 기능은 서버에서 클라이언트로의 알람과 이벤트를 즉시 전달하기 위해서 사용하고 있을 것이다. 단일 애플리케이션에서는 고려하지 않아도 될 부분이지만 스케일 아웃되어 분산 처리되는 애플리케이션에 각각 연결된 웹소켓으로 특정 서버에서 발생하여 만들어지는 알람 정보를 즉시 전달하기 위해서는 전파하고 동기화하는 방안이 필요하다. <a href="https://pompitzz.github.io/blog/Redis/LocalCacheSyncWithRedisPubSub.html">Redis(Pub&#x2F;Sub)로 로컬 캐시 동기화하기</a>와 비슷하다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span><span class="token annotation punctuation">@SpringBootApplication</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token keyword">implements</span> <span class="token class-name">MessageListener</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ChannelTopic</span> topic <span class="token operator">=</span> <span class="token class-name">ChannelTopic</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"NOTIFICATIONS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">public</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">CommandLineRunner</span> <span class="token function">commandLineRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> args <span class="token operator">-></span> redisTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>topic<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"REQUIRE.SYNC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">RedisMessageListenerContainer</span> <span class="token function">redisMessageListenerContainer</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">RedisMessageListenerContainer</span> container <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisMessageListenerContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        container<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>        container<span class="token punctuation">.</span><span class="token function">addMessageListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> container<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">MessageListenerAdapter</span> <span class="token function">listenerAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MessageListenerAdapter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pattern<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"receive: &#123;&#125;"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="활용-클래스-목록"><a href="#활용-클래스-목록" class="headerlink" title="활용 클래스 목록"></a>활용 클래스 목록</h4><p>레디스에 의한 Pub&#x2F;Sub을 구현하기 위해서 사용되는 스프링 프레임워크 클래스들은 아래와 같다.</p><ul><li>RedisMessageListenerContainer</li><li>RedisConnectionFactory</li><li>MessageListenerAdapter</li><li>MessageListener</li><li>StringRedisTemplate</li><li>ChannelTopic</li></ul><h4 id="참고-링크"><a href="#참고-링크" class="headerlink" title="참고 링크"></a>참고 링크</h4><ul><li><a href="https://redis.io/docs/interact/pubsub/">How to use pub&#x2F;sub channels in Redis</a></li><li><a href="https://docs.spring.io/spring-data/redis/reference/redis/pubsub.html">Pub&#x2F;Sub Messaging</a></li><li><a href="https://www.baeldung.com/spring-data-redis-pub-sub">PubSub Messaging with Spring Data Redis</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;웹소켓-알람-갱신-동기화&quot;&gt;&lt;a href=&quot;#웹소켓-알람-갱신-동기화&quot; class=&quot;headerlink&quot; title=&quot;웹소켓 알람 갱신 동기화&quot;&gt;&lt;/a&gt;웹소켓 알람 갱신 동기화&lt;/h4&gt;&lt;p&gt;대부분의 예제는 채팅으로 공유되고 있지만 일반적</summary>
      
    
    
    
    
    <category term="Redis" scheme="https://kdevkr.github.io/tags/Redis/"/>
    
    <category term="Websocket" scheme="https://kdevkr.github.io/tags/Websocket/"/>
    
  </entry>
  
</feed>
