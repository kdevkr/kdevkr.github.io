<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Mambo</title>
  
  <subtitle>Today I Learned 🔥</subtitle>
  <link href="https://kdevkr.github.io/atom.xml" rel="self"/>
  
  <link href="https://kdevkr.github.io/"/>
  <updated>2024-09-06T15:12:02.494Z</updated>
  <id>https://kdevkr.github.io/</id>
  
  <author>
    <name>Mambo</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>자카르타 메일 프로바이더 오류</title>
    <link href="https://kdevkr.github.io/jakarta-mail-provider-issue/"/>
    <id>https://kdevkr.github.io/jakarta-mail-provider-issue/</id>
    <published>2024-09-06T15:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.494Z</updated>
    
    <content type="html"><![CDATA[<h1 id="👩‍💻-사용자-로그인-시-2차-인증-메일이-안와요"><a href="#👩‍💻-사용자-로그인-시-2차-인증-메일이-안와요" class="headerlink" title="👩‍💻 사용자 로그인 시 2차 인증 메일이 안와요"></a>👩‍💻 사용자 로그인 시 2차 인증 메일이 안와요</h1><p>개발중인 애플리케이션 서버를 QA가 배포하고나서 사용자 로그인 시 <strong>2차인증을 수행하기 위한 인증코드 메일이 수신이 안된다</strong>는 버그 리포트를 해주었어요. 갑자기 어떤 문제로 인해 이메일이 발송되지 않았는지와 해결과정에 대해서 공유해보려고 합니다.</p><h2 id="문제-원인-분석"><a href="#문제-원인-분석" class="headerlink" title="문제 원인 분석"></a>문제 원인 분석</h2><p>먼저, 해당 서버에는 예외 상황을 추적할 수 있도록 Sentry가 도입되어 있는 상태였습니다. Sentry 에서는 수집된 예외가 없었기 때문에 즉시 알아채지 못하는 상황에 해당합니다. 아무튼, 애플리케이션 서버 로그를 확인하기 위해서 리눅스 서버에 접속하고 도커 컨테이너에 기록된 최근 로그를 살펴보았습니다.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker compose logs --since '2024-09-06T16:00+09:00' app</span><span class="token function">docker</span> compose logs <span class="token parameter variable">--since</span> <span class="token string">'5m'</span> appapp <span class="token operator">|</span> <span class="token punctuation">..</span>. caused by: Not provider of jakarta.mail.util.StreamProvider was found</code></pre><blockquote><p>도커 컴포즈에서 –since 옵션을 사용하면 원하는 시점부터의 로그를 확인할 수 있어요</p></blockquote><p>서버 로그에는 위와 같이 자카르타 메일의 StreamProvider를 찾을 수 없다는 오류 메시지가 남아있었는데요. 처음보는 오류 메시지 이므로 구글 검색을 해보니 <a href="https://github.com/jakartaee/mail-api/issues/665">자카르타 메일 관련 깃허브에 이슈로 등록된 내용이 있음</a>을 확인했습니다. 이슈 내용은 젠킨스 플러그인에서 Jakarta Mail API 2.1.1 을 사용하면 위와 동일한 오류가 발생한다는 것이었습니다. 동일하게 젠킨스에서 발생한 것은 아니지만 <a href="https://github.com/spring-projects/spring-boot/issues/39843">실행가능한 Jar 에서 클래스로더가 올바르지 않는다</a>는 이슈를 보게되었고 자카르타 메일에 대한 라이브러리 버전을 확인해보았습니다.</p><p>서버 애플리케이션에 해당되는 <a href="https://docs.spring.io/spring-boot/docs/3.1.2/reference/html/dependency-versions.html">스프링 부트 3.1.2의 의존성 버전 정보</a>에서 검색을 해보니 아래와 같이 파악되었습니다.</p><ul><li>org.eclipse.angus:angus-mail:1.1.0</li><li>org.eclipse.angus:angus-activation:2.0.1</li><li>jakarta.mail:jakarta.mail-api:1.1.0</li><li>jakarta.activation:jakarta.activation-api:2.1.2</li></ul><p>우선 변경사항에서 의심되는 부분이 발견되지 않았기에 의존성 버전을 변경하여 배포를 시도해보아야 했습니다. build.gradle에 아래와 같이 <strong>Jakarta Mail API 2.1.3</strong> 를 추가하고 빌드 및 배포를 수행해보았습니다.</p><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">ext <span class="token punctuation">&#123;</span>    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'angus-mail.version'</span><span class="token punctuation">,</span> <span class="token string">'2.0.3'</span><span class="token punctuation">)</span> <span class="token comment">// from 1.1.0</span>    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'jakarta-mail.version'</span><span class="token punctuation">,</span> <span class="token string">'2.1.3'</span><span class="token punctuation">)</span> <span class="token comment">// from 2.1.2</span><span class="token punctuation">&#125;</span></code></pre><p>새롭게 배포된 애플리케이션에서도 메일이 발송되지 않았고 아래와 같은 <strong>새로운 오류 메시지</strong>가 남았습니다.</p><pre class="language-bash" data-language="bash"><code class="language-bash">Provider <span class="token keyword">for</span> jakarta.activation.spi.MailcapRegistryProvider cannot be found</code></pre><p>Jakarta Mail API 버전을 변경하면 <strong>jakarta.activation-api</strong> 도 변경될거라 생각했는데요. 디펜던시 트리를 자세히 살펴보지 않은게 대응 과정에서의 실수였습니다. 아래와 같이 <strong>jakarta-activation</strong> 에 대한 버전을 추가로 지정하고 다시 배포했습니다.</p><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">ext <span class="token punctuation">&#123;</span>    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'angus-mail.version'</span><span class="token punctuation">,</span> <span class="token string">'2.0.3'</span><span class="token punctuation">)</span>    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'angus-activation.version'</span><span class="token punctuation">,</span> <span class="token string">'2.0.2'</span><span class="token punctuation">)</span> <span class="token comment">// from 1.1.0</span>    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'jakarta-mail.version'</span><span class="token punctuation">,</span> <span class="token string">'2.1.3'</span><span class="token punctuation">)</span>    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'jakarta-activation.version'</span><span class="token punctuation">,</span> <span class="token string">'2.1.3'</span><span class="token punctuation">)</span> <span class="token comment">// from 2.1.2</span><span class="token punctuation">&#125;</span></code></pre><h3 id="👩‍💻-2차-인증-메일-제대로-와요‼"><a href="#👩‍💻-2차-인증-메일-제대로-와요‼" class="headerlink" title="👩‍💻 2차 인증 메일 제대로 와요‼"></a>👩‍💻 2차 인증 메일 제대로 와요‼</h3><p>일단 급하게 해결은 되었으니 다행이지만 더 자세한 내용에 대해서 살펴보아야겠죠? 먼저, 의존성 버전을 올리는 것은 많은 테스트가 필요한 위험한 작업임을 되돌아봐야합니다. 해당 프로젝트는 릴리즈한 제품은 아니었기에 운영 환경이 없었고 문제가 발생했던 것은 테스트 엔지니어가 기능 확인할 수 있는 테스트 환경이었기에 가능했습니다.</p><p>또한, 해당 오류는 로컬 환경에서 인텔리제이 IDE로 실행되는 애플리케이션에서는 발생하지 않았는데요. 실행가능한 Jar 에서 문제가 발생할 수 있다는 정보는 문제가 해결하고나서 더 자세한 내용을 찾아보고 정리하는 단계에서 알게되었습니다. 로컬에서 빌드하고 실행해보지 않은 접근에 대해서는 아쉬운 부분으로 생각되므로 개선해야할 부분 같습니다.</p><h2 id="문제-해결-정리"><a href="#문제-해결-정리" class="headerlink" title="문제 해결 정리"></a>문제 해결 정리</h2><blockquote><p>Not provider of jakarta.mail.util.StreamProvider was found<br>Provider for jakarta.activation.spi.MailcapRegistryProvider cannot be found</p></blockquote><ul><li>스프링 부트에서 ForkJoinPool를 사용하는 경우 <strong>Executable Jar</strong> 에서 클래스로더가 올바르지 않을 수 있음</li><li>문제가 되었던 코드에는 <strong>ParallelStream</strong> 을 사용했기에 내부적으로 <strong>ForkJoinPool</strong>을 호출하는 상태</li><li>Jakarta Mail 2.1.2 이하 버전에서 클래스로더가 <strong>Jakarta Provider SPI</strong>를 찾을 수 없는 결함이 있음</li><li>Jakarta Mail 2.1.3 을 사용하기 위해서는 <strong>Angus Mail Provider 2.0.3</strong> 을 추가해야함</li></ul><p>※ Angus Mail 은 Jakarta Mail Specification 2.1+ 에 대한 구현체 프로젝트라고 해요.</p><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;👩‍💻-사용자-로그인-시-2차-인증-메일이-안와요&quot;&gt;&lt;a href=&quot;#👩‍💻-사용자-로그인-시-2차-인증-메일이-안와요&quot; class=&quot;headerlink&quot; title=&quot;👩‍💻 사용자 로그인 시 2차 인증 메일이 안와요&quot;&gt;&lt;/a</summary>
      
    
    
    
    
    <category term="문제해결" scheme="https://kdevkr.github.io/tags/%EB%AC%B8%EC%A0%9C%ED%95%B4%EA%B2%B0/"/>
    
    <category term="트러블슈팅" scheme="https://kdevkr.github.io/tags/%ED%8A%B8%EB%9F%AC%EB%B8%94%EC%8A%88%ED%8C%85/"/>
    
  </entry>
  
  <entry>
    <title>Spring AOP - Self Invocation</title>
    <link href="https://kdevkr.github.io/spring-aop-invocation/"/>
    <id>https://kdevkr.github.io/spring-aop-invocation/</id>
    <published>2024-09-05T14:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.498Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>@Cacheable self-invocation (in effect, a method within the target object calling another method of the target object).<br>The cache annotation will be ignored at runtime</p></blockquote><p>스프링 프레임워크에서 개발자가 경험하기 쉬운 실수는 동일한 클래스 내에서 비동기 또는 캐시 어노테이션이 선언된 함수를 내부적으로 호출하도록 비즈니스 로직을 작성하는 것 입니다. 이러한 문제가 발생하는 경우에는 <a href="https://www.baeldung.com/spring-invoke-cacheable-other-method-same-bean">Self Invocation</a>이 되지 않도록 별도의 클래스로 분리되도록 리팩토링을 진행하거나 <a href="https://www.baeldung.com/spring-self-injection">Self-Injection</a>이 되도록 수정해야합니다. 그외에 아래와 같은 방법들도 있지만 선호되지 않습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AService</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractService</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>cacheNames <span class="token operator">=</span> <span class="token string">"a"</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">"#root.methodName"</span><span class="token punctuation">,</span> unless <span class="token operator">=</span> <span class="token string">"#result == null"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token string">"A"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><ul><li>AdviceMode.ASPECTJ (AspectJ Weaving)</li><li>AopContext.currentProxy()</li><li>ApplicationContext.getBean()</li></ul><p>스프링 프레임워크 기반의 애플리케이션 서버를 작성하는 개발자라면 <a href="https://docs.spring.io/spring-framework/reference/core/aop/proxying.html">프록시 매커니즘</a>에 대해서 이해하고 있어야 합니다. 기본적인 프록시(CGLib) 또는 JDK 프록시가 무엇인지 알고있어야 왜 public 접근제어자가 아니거나 내부 호출인 경우 AOP를 수행할 수 없는지를 이해할 수 있습니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;@Cacheable self-invocation (in effect, a method within the target object calling another method of the target object).&lt;br&gt;Th</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>추상 클래스에서 @PostConstruct를 사용할 때</title>
    <link href="https://kdevkr.github.io/abstract-class-with-post-construct/"/>
    <id>https://kdevkr.github.io/abstract-class-with-post-construct/</id>
    <published>2024-09-03T16:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.490Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://www.baeldung.com/running-setup-logic-on-startup-in-spring">애플리케이션 실행 시 초기화</a>해야하는 로직이 필요한 경우 ApplicationReadyEvent에 대한 이벤트 리스너를 작성하거나 <strong>@PostConstruct가 선언된 함수</strong> 또는 InitializeBean 인터페이스의 afterPropertiesSet 함수를 오버라이딩하여 수행할 수 있다. 이 중에서 오늘은 @PostConstruct를 추상 클래스에 선언했을때의 문제에 대해 다루어보려고 한다.</p><h4 id="PostConstruct-with-abstract-class"><a href="#PostConstruct-with-abstract-class" class="headerlink" title="@PostConstruct with abstract class"></a>@PostConstruct with abstract class</h4><p>여러가지 서비스 로직에서 사용하는데 공통적으로 사용될 함수나 필드를 제공하기 위하여 서비스 클래스에 대한 추상 클래스를 만들 수 있다. 만약, 아래와 같이 @PostConstruct가 선언된 함수를 만들었고 이를 확장해서 만든 A 서비스, B 서비스, C 서비스가 있다고 가정하면 initialize 함수는 몇번 호출될까?</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractService</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@PostConstruct</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"initialize"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-bash" data-language="bash"><div class="caption"><span>Terminal</span></div><code class="language-bash">AService initializeBService initializeCService initialize</code></pre><p>정답은 1번도 4번도 아닌 추상 클래스를 제외한 <strong>A,B,C 서비스 3번 호출됨</strong>을 알 수 있다.</p><p>신규 프로젝트에서 상위 시스템에 의존함에 따라 <strong>API 통신을 위한 인증 토큰을 발급해오는 로직을 init 함수에 구현</strong>해두었다. 로컬에서 개발하다가 상위 시스템과의 통신에 대한 트레이스 로그를 활성화하고 애플리케이션 서버 로그를 살펴보던 중 <strong>애플리케이션 실행 시 인증 토큰 발급을 위한 요청이 주르륵 서비스 개수만큼 호출</strong>되는 것을 확인하게 되었다.</p><p>서비스 클래스마다 개별로 발급하여 사용하면 의미가 있을 수 있지만 <strong>여러번 요청하더라도 상위 시스템에서 동일한 토큰을 발급을 해주도록 구현되어</strong> 있으므로 AbstractService 기준으로 단 한번만 발급되면 되는게 의도된 동작으로 판단했다. 이에 대한 해결책으로 인증 토큰을 AbstractService의 클래스 내부 변수가 아닌 전역 변수로 변환하고 init 함수에서 토큰 발급 유무를 우선적으로 확인하여 토큰이 없는 경우에만 발급 로직을 수행하도록 수정했다.</p><blockquote><p>관련된 커밋 히스토리를 찾아보니 해당 코드가 작성된 것은 프로젝트 초기였으며 당시에는 추상 클래스를 확장한 서비스 클래스가 단 하나였는데요. 그래서 당시에는 인지하지 못하고 트레이스 로그를 활성화해본 지금에서야 내재된 오류 아닌 결함이 발견되었을 것 같습니다.</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://www.baeldung.com/running-setup-logic-on-startup-in-spring&quot;&gt;애플리케이션 실행 시 초기화&lt;/a&gt;해야하는 로직이 필요한 경우 ApplicationReadyEvent에 대한 </summary>
      
    
    
    
    
    <category term="PostConstruct" scheme="https://kdevkr.github.io/tags/PostConstruct/"/>
    
    <category term="InitializeBean" scheme="https://kdevkr.github.io/tags/InitializeBean/"/>
    
    <category term="ApplicationReadyEvent" scheme="https://kdevkr.github.io/tags/ApplicationReadyEvent/"/>
    
  </entry>
  
  <entry>
    <title>레디스</title>
    <link href="https://kdevkr.github.io/redis/"/>
    <id>https://kdevkr.github.io/redis/</id>
    <published>2024-09-03T15:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.498Z</updated>
    
    <content type="html"><![CDATA[<p>Java 기반의 스프링 애플리케이션을 개발하면서 <strong>레디스</strong>라는 기술을 아래와 같은 요구사항을 처리하기 위해 사용해왔지만 레디스에 대해서 자세히 알아보고 더 효율적으로 사용할 수 있는가를 고민해본적은 없었던 것 같다. 과연 스스로 <strong>레디스 기술에 대한 역량을 보유</strong>하고 있다고 생각이 되는가를 고민해보려고 한다.</p><ul><li>사용자 세션 클러스터링</li><li>데이터베이스 결과 캐시</li><li>EXPIRE TTL을 활용한 인증</li><li>Redis Pub&#x2F;Sub을 활용한 실시간 알림 데이터 전파</li><li>Redis Streams를 활용한 이벤트 비동기 메시지 처리</li></ul><h4 id="다른-환경에서의-레디스-활용"><a href="#다른-환경에서의-레디스-활용" class="headerlink" title="다른 환경에서의 레디스 활용"></a>다른 환경에서의 레디스 활용</h4><p>많은 개발자들이 레디스에 대한 정보들을 공유해놓은 것들을 참고해서 다른 도메인 환경에서는 어떻게 레디스를 활용하는지를 살펴보도록 하자. 우선, 게임 시스템에서는 사용자들의 <a href="https://redis.io/solutions/leaderboards/">랭킹에 대한 리더보드</a>를 구성하기 위하여 Sorted Sets(ZSET)를 활용하는 것으로 확인된다. 이커머스 도메인에서는 <a href="https://techblog.woowahan.com/2709/">재고 관리</a>에서 쿠폰이나 세일 이벤트로 인하여 <a href="https://hudi.blog/distributed-lock-with-redis/">동시성 이슈를 처리</a>하기 위해 사용되는 것으로 보인다. 또한, JWT와 같은 토큰 기반 인증 시스템으로 구성한 경우 비밀번호 변경에 의한 로그아웃 처리를 위해 레디스를 통해 블랙리스트를 구현하기도 하는 것 같다.</p><p>레디스에 저장해야할 데이터 규모가 크다거나 HA 구성을 위해 레디스 클러스터로 운영해볼 기회가 없는 것은 아쉬운 부분이긴하다. 대규모 트래픽을 경험할 수 있는 환경이 아니더라도 레디스 서버를 위해서 선택하는 AWS EC2 인스턴스 유형의 권장사양이라거나 레디스 클러스터를 운용해야하는데 레디스 서버를 관리하고 운영해줄 데이터베이스 엔지니어가 조직에 없다면 레디스 호환의 관리형 서비스인 AWS ElasticCache 가 더 좋은 선택지일까에 대한 생각을 미리 해봤으면 좋았을 것 같다.</p><h4 id="레디스-서버-모니터링"><a href="#레디스-서버-모니터링" class="headerlink" title="레디스 서버 모니터링"></a>레디스 서버 모니터링</h4><p>개인적으로 프로메테우스와 그라파나를 활용하여 모니터링 시스템을 구축했을때는 레디스에 대한 매트릭을 수집하여 간단하게 모니터링을 해보았으나 APM 솔루션인 New Relic 으로 전환하고나서는 레디스에 대해서는 별도로 모니터링을 수행하고 있지는 않고 있다. New Relic 에서도 <a href="https://docs.newrelic.com/kr/docs/infrastructure/host-integrations/host-integrations-list/redis/redis-integration/">Redis 모니터링 통합</a>을 지원하고 있으므로 도입해봐도 좋을 것 같으니 서버 엔지니어이신 부장님과 협의하에 시도는 해보아야겠다. AWS ElasticCache 를 사용하게 된다면 자체적으로 <a href="https://docs.aws.amazon.com/ko_kr/AmazonElastiCache/latest/red-ug/CacheMetrics.WhichShouldIMonitor.html">모니터링 지표를 제공</a>해주므로 CloudWatch 에서 어떤 항목을 살펴보아야하는지 알아두어야 할 것 같다.</p><h4 id="더-자세히-배울-수-있는-정보를-모아보자"><a href="#더-자세히-배울-수-있는-정보를-모아보자" class="headerlink" title="더 자세히 배울 수 있는 정보를 모아보자"></a>더 자세히 배울 수 있는 정보를 모아보자</h4><p>레디스를 검색해서 관련한 정보들을 모아보았는데 꽤나 많다. 조금씩 살펴보며 레디스 활용에 대해 더 자세히 알아가봐야겠다.</p><ul><li><a href="https://helloworld.kurly.com/blog/distributed-redisson-lock/">컬리 | 풀필먼트 입고 서비스팀에서 분산락을 사용하는 방법 - Spring Redisson</a></li><li><a href="https://hyperconnect.github.io/2019/11/15/redis-distributed-lock-1.html">하이퍼커넥트 | 레디스와 분산 락</a></li><li><a href="https://dev.gmarket.com/46">지마켓 | 지마켓 대기열 시스템 파헤치기</a></li><li><a href="https://tech.kakao.com/posts/406">카카오 | 카카오톡 캐싱 시스템의 진화 — Kubernetes와 Redis를 이용한 캐시 팜 구성</a></li><li><a href="https://tech.kakao.com/posts/316">카카오 | DNS 기반의 Redis HA 구현</a></li><li><a href="https://dev.gmarket.com/17">지마켓 | Redis를 통한 현재 접속 유저 파악하기</a></li><li><a href="https://oliveyoung.tech/blog/2023-08-07/async-process-of-coupon-issuance-using-redis/">올리브영 | Redis Pub&#x2F;Sub을 활용한 쿠폰 발급 비동기 처리</a></li><li><a href="https://tech.kakaopay.com/post/kakaopaysec-redis-on-kubernetes/">카카오페이 | Redis on Kubernetes 플랫폼을 구성해 나가기</a></li><li><a href="https://channel.io/ko/blog/real-time-chat-server-1-redis-pub-sub">채널톡 | 채널톡 실시간 채팅 서버 개선 여정 - 1편 : 레디스의 ‘Pub&#x2F;Sub’</a></li><li><a href="https://techblog.lycorp.co.jp/ko/running-redis-at-scale">라인 | 대규모 Redis를 운영하며 살아남기</a></li><li><a href="https://www.youtube.com/watch?v=MTSn93rNPPE">우아한테크 | 선착순 이벤트 서버 생존기</a></li><li><a href="https://techblog.woowahan.com/2514/">우아한테크 | 선착순 쿠폰 발급</a></li><li><a href="https://techblog.gccompany.co.kr/redis-kafka%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-%EC%84%A0%EC%B0%A9%EC%88%9C-%EC%BF%A0%ED%8F%B0-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EA%B0%9C%EB%B0%9C%EA%B8%B0-feat-%EB%84%A4%EA%B3%A0%EC%99%95-ec6682e39731">여기어때 | Redis&amp;Kafka를 활용한 선착순 쿠폰 이벤트 개발기</a></li><li><a href="https://blog.dramancompany.com/2022/10/%EC%9C%A0%EC%A0%80-%EB%AA%A9%EB%A1%9D%EC%9D%84-redis-bitmap-%EA%B5%AC%EC%A1%B0%EB%A1%9C-%EC%A0%80%EC%9E%A5%ED%95%98%EC%97%AC-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%A0%88%EC%95%BD%ED%95%98%EA%B8%B0/">리멤버 | 유저 목록을 Redis Bitmap 구조로 저장하여 메모리 절약하기</a></li><li><a href="https://techblog.lycorp.co.jp/ko/building-a-messaging-queuing-system-with-redis-streams">라인 | 실시간 추천 서비스를 위해 메시지 큐잉 도입하기</a></li><li><a href="https://channel.io/ko/blog/distributedlock_2022_backend">채널톡 | Distributed Lock 구현 과정</a></li><li><a href="https://meetup.nhncloud.com/posts/251">NHN 클라우드| 대규모 환경에서 레디스 캐시 성능을 높이기</a></li><li><a href="https://www.youtube.com/watch?v=JH07ABaRPWo">우아한테크 | ElastiCache 운영을 위한 우아한 가이드</a></li><li><a href="https://www.youtube.com/watch?v=92NizoBL4uA">NHN 클라우드 | Redis 야무지게 사용하기</a></li><li><a href="https://www.youtube.com/watch?v=-GsWFaQg6Q0">카카오 | Docker Swarm 기반 Redis SaaS 플랫폼 구축사례</a></li><li><a href="https://docs.aws.amazon.com/ko_kr/AmazonElastiCache/latest/red-ug/elasticache-use-cases.html">AWS | 일반적인 ElastiCache 사용 사례 및 지원 방법</a></li><li><a href="https://toss.tech/article/25301">토스 | 캐시 문제 해결 가이드 - DB 과부하 방지 실전 팁</a></li><li><a href="https://dev.gmarket.com/71">지마켓 | 초보 개발자를 위한 Redis Cluster Migration 가이드라인</a></li><li><a href="https://tech.kakao.com/posts/491">카카오 | 쿠버네티스에 레디스 캐시 클러스터 구축기</a></li><li><a href="https://chrisjune-13837.medium.com/redis-redis%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%98%EC%97%AC-%EC%84%9C%EB%B2%84-%EC%9A%94%EC%B2%AD-%EC%86%8D%EB%8F%84-%EC%A4%84%EC%9D%B4%EA%B8%B0-8132ea90bc39">Redis를 활용하여 Request 5배 더 받기</a></li><li><a href="https://d2.naver.com/helloworld/294797">네이버 | ZooKeeper를 활용한 Redis Cluster 관리</a></li><li><a href="https://dev.gmarket.com/69">지마켓 | Redis Lua Script를 이용해서 API Rate Limiter개발</a></li></ul><p>😮 레디스와 관련하여 유명하신 개발자분의 비싼 <a href="https://fastcampus.co.kr/pages/29568">유료 강의</a>도 있더라 </p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Java 기반의 스프링 애플리케이션을 개발하면서 &lt;strong&gt;레디스&lt;/strong&gt;라는 기술을 아래와 같은 요구사항을 처리하기 위해 사용해왔지만 레디스에 대해서 자세히 알아보고 더 효율적으로 사용할 수 있는가를 고민해본적은 없었던 것 같다. 과</summary>
      
    
    
    
    
    <category term="Redis" scheme="https://kdevkr.github.io/tags/Redis/"/>
    
    <category term="NoSQL" scheme="https://kdevkr.github.io/tags/NoSQL/"/>
    
    <category term="Cache" scheme="https://kdevkr.github.io/tags/Cache/"/>
    
    <category term="Queue" scheme="https://kdevkr.github.io/tags/Queue/"/>
    
  </entry>
  
  <entry>
    <title>Jackson 마스킹 처리</title>
    <link href="https://kdevkr.github.io/jackson-mask-sensitive-data/"/>
    <id>https://kdevkr.github.io/jackson-mask-sensitive-data/</id>
    <published>2024-09-02T15:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.494Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>■ 개인정보의 기술적관리적 보호조치 기준 제10조<br>정보통신서비스 제공자등은 개인정보 업무처리를 목적으로 개인정보의 조회, 출력 등의 업무를 수행하는 과정에서 개인정보보호를 위하여 개인정보를 마스킹하여 표시제한 조치를 취할 수 있다.</p></blockquote><p>위와 같이 개인정보 또는 보안 이슈로 인하여 일부 민감한 데이터 항목을 전체가 아닌 일부만을 표시해야할 요구사항이 있을 수 있다. <a href="https://github.com/kdevkr/mambo-box/blob/main/errors/2024-09-02.md">Jackson AnnotationIntrospector 이슈</a>를 경험한 김에 <a href="https://github.com/FasterXML/jackson-docs/wiki/AnnotationIntrospector">AnnotationIntrospector</a>를 사용하여 REST API에서 응답되는 일부 필드를 마스킹하는 방법을 이해해보도록 하자.</p><h4 id="Annotation-기반-마스킹-처리"><a href="#Annotation-기반-마스킹-처리" class="headerlink" title="Annotation 기반 마스킹 처리"></a>Annotation 기반 마스킹 처리</h4><p>기본적으로 별도의 Getter 함수로 만들어서 마스킹한 결과를 반환하는 필드를 만들어내도 된다. 그러나, 마스킹을 위한 어노테이션을 만들고 AnnotationIntrospector를 확장해서 어노테이션이 선언된 필드에 대해서 마스킹된 결과로 직렬화(Serialize)를 수행하도록 작성하면 마스킹 되어야하는 항목에 따라서 <strong>다양한 마스킹 패턴을 전략적으로 적용</strong>할 수 있다.</p><pre class="language-java" data-language="java"><div class="caption"><span>MaskedField</span></div><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">ANNOTATION_TYPE</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">FIELD</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span><span class="token annotation punctuation">@JacksonAnnotation</span><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">MaskedField</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> <span class="token function">expression</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"****"</span><span class="token punctuation">;</span>    <span class="token class-name">MaskedType</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">MaskedType</span><span class="token punctuation">.</span><span class="token constant">COMMON</span><span class="token punctuation">;</span>    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">fields</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// NOTE: If metadata</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><div class="caption"><span>MaskedFieldAnnotationIntrospector</span></div><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MaskedFieldAnnotationIntrospector</span> <span class="token keyword">extends</span> <span class="token class-name">NopAnnotationIntrospector</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">findSerializer</span><span class="token punctuation">(</span><span class="token class-name">Annotated</span> annotated<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">MaskedField</span> annotation <span class="token operator">=</span> annotated<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">MaskedField</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>annotation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token class-name">MaskedFieldSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MaskedFieldSerializer</span> <span class="token keyword">extends</span> <span class="token class-name">StdSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">ContextualSerializer</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isMask<span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MaskedField</span> annotation<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token class-name">MaskedFieldSerializer</span><span class="token punctuation">(</span><span class="token class-name">MaskedField</span> annotation<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isMask<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>isMask <span class="token operator">=</span> isMask<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>annotation <span class="token operator">=</span> annotation<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token class-name">JsonGenerator</span> gen<span class="token punctuation">,</span> <span class="token class-name">SerializerProvider</span> provider<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// NOTE: MaskedType 에 따른 마스킹 패턴 구현은 생략</span>            <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ObjectMapper</span><span class="token punctuation">)</span> gen<span class="token punctuation">.</span><span class="token function">getCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> s <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isMask<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">JSONParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONParser</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_PERMISSIVE_MODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                    <span class="token class-name">Object</span> o <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token keyword">instanceof</span> <span class="token class-name">JSONAwareEx</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token class-name">DocumentContext</span> doc <span class="token operator">=</span> <span class="token class-name">JsonPath</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">Map</span> json <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> field <span class="token operator">:</span> annotation<span class="token punctuation">.</span><span class="token function">fields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                                doc<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> annotation<span class="token punctuation">.</span><span class="token function">expression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">&#125;</span>                        <span class="token punctuation">&#125;</span>                        gen<span class="token punctuation">.</span><span class="token function">writeRawValue</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span><span class="token function">jsonString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                        gen<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>annotation<span class="token punctuation">.</span><span class="token function">expression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                gen<span class="token punctuation">.</span><span class="token function">writeRawValue</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">JsonSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">createContextual</span><span class="token punctuation">(</span><span class="token class-name">SerializerProvider</span> serializerProvider<span class="token punctuation">,</span> <span class="token class-name">BeanProperty</span> beanProperty<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonMappingException</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">MaskedField</span> maskedField <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>beanProperty <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                maskedField <span class="token operator">=</span> beanProperty<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">MaskedField</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MaskedFieldSerializer</span><span class="token punctuation">(</span>maskedField<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><div class="caption"><span>AnnotationIntrospector.pair</span></div><code class="language-java"><span class="token annotation punctuation">@Bean</span><span class="token keyword">public</span> <span class="token class-name">ObjectMapper</span> <span class="token function">objectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token class-name">Jackson2ObjectMapperBuilder</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">AnnotationIntrospector</span> introspector <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">getSerializationConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAnnotationIntrospector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">AnnotationIntrospector</span> annotationIntrospector <span class="token operator">=</span> <span class="token class-name">AnnotationIntrospector</span><span class="token punctuation">.</span><span class="token function">pair</span><span class="token punctuation">(</span>introspector<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MaskedFieldAnnotationIntrospector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    objectMapper<span class="token punctuation">.</span><span class="token function">setAnnotationIntrospector</span><span class="token punctuation">(</span>annotationIntrospector<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> objectMapper<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><ul><li>다양한 마스킹 패턴 대응을 위한 MaskedType Enum 만들기</li><li>NopAnnotationIntrospector 를 확장한 MaskedFieldAnnotationIntrospector 클래스 작성하기</li><li>objectMapper에 AnntationIntrospectorPair로 MaskedFieldAnnotationIntrospector 등록하기</li></ul><h4 id="마스킹-전략"><a href="#마스킹-전략" class="headerlink" title="마스킹 전략"></a>마스킹 전략</h4><p>이름과 주민등록번호 그리고 휴대폰 번호와 같이 민감한 데이터에 대해서는 기본적으로 <strong>마스킹</strong>이 고려되어야한다. 마스킹 전략에는 뒤에서 N개의 문자 또는 데이터 형식에 따라 중간의 N개의 문자를 별표(asterisk)로 치환한다. 경기대학교 전산정보원의 <a href="https://www.kyonggi.ac.kr/comcenter/contents.do?key=6883">개인정보 노출 조치 방법 안내</a>에서 여러가지 예시를 잘 나타내고 있는 것 같다.</p><blockquote><p>민감한 데이터에 대한 마스킹 처리를 반드시 애플리케이션 서버에서 이루어져야합니다. 또한, 서로 다른 시스템에서 개인정보를 공유하는데 각 시스템에서의 마스킹 전략이 다르다면 이것도 개인정보 처리와 보호 조치에 대한 문제의 소지가 있을 수 있습니다.</p></blockquote><p>그러면, 애플리케이션 <strong>로그에 포함될 수 있는 민감한 정보</strong>는 어떻게 <a href="https://www.baeldung.com/logback-mask-sensitive-data">마스킹</a> 해야하지? 🤔</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;■ 개인정보의 기술적관리적 보호조치 기준 제10조&lt;br&gt;정보통신서비스 제공자등은 개인정보 업무처리를 목적으로 개인정보의 조회, 출력 등의 업무를 수행하는 과정에서 개인정보보호를 위하여 개인정보를 마스킹하여 표시제한 조치를 </summary>
      
    
    
    
    
    <category term="Masking" scheme="https://kdevkr.github.io/tags/Masking/"/>
    
    <category term="Sensitive Data" scheme="https://kdevkr.github.io/tags/Sensitive-Data/"/>
    
  </entry>
  
  <entry>
    <title>Spring Security - Rejected Request</title>
    <link href="https://kdevkr.github.io/spring-security-rejected-request/"/>
    <id>https://kdevkr.github.io/spring-security-rejected-request/</id>
    <published>2024-08-18T02:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.498Z</updated>
    
    <content type="html"><![CDATA[<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>firewall<span class="token punctuation">.</span></span>RequestRejectedException</span><span class="token operator">:</span> <span class="token class-name">The</span> request was rejected because the <span class="token constant">URL</span> contained a potentially malicious <span class="token class-name">String</span> <span class="token string">"//"</span></code></pre><ul><li><a href="https://www.baeldung.com/spring-security-request-rejected-exception">Spring Security – Request Rejected Exception</a></li></ul><h4 id="요청이-거부되는-이유"><a href="#요청이-거부되는-이유" class="headerlink" title="요청이 거부되는 이유"></a>요청이 거부되는 이유</h4><p>일반적으로 스프링 부트 기반의 애플리케이션에서 <strong>스프링 시큐리티를 사용했다면</strong> 기본적으로 적용되는 HttpFirewall 구현체에 의해 연속되는 슬래시 문자를 허용하지 않도록 되어있다. REST API로 디자인하는 경우 <strong>PathVariable</strong> 로 경로 상의 리소스 아이디를 검증하는 경우가 대부분이다. 따라서, 대부분의 경우 <strong>URL 경로 상 연속된 슬래시 문자는 서버 입장에서 잘못된 요청</strong>에 해당된다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span><span class="token keyword">public</span> <span class="token class-name">WebSecurityCustomizer</span> <span class="token function">webSecurityCustomizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> webSecurity <span class="token operator">-></span> webSecurity<span class="token punctuation">.</span><span class="token function">httpFirewall</span><span class="token punctuation">(</span><span class="token function">httpFirewall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requestMatchers</span><span class="token punctuation">(</span><span class="token string">"/error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token annotation punctuation">@Bean</span><span class="token keyword">public</span> <span class="token class-name">HttpFirewall</span> <span class="token function">httpFirewall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// NOTE: Spring Security provides DefaultHttpFirewall and StrictHttpFirewall.</span>    <span class="token class-name">StrictHttpFirewall</span> httpFirewall <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StrictHttpFirewall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpFirewall<span class="token punctuation">.</span><span class="token function">setAllowSemicolon</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpFirewall<span class="token punctuation">.</span><span class="token function">setAllowNull</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpFirewall<span class="token punctuation">.</span><span class="token function">setAllowBackSlash</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpFirewall<span class="token punctuation">.</span><span class="token function">setAllowUrlEncodedDoubleSlash</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> allowedHttpMethods <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>                    <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span>                    <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">,</span>                    <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">PUT</span><span class="token punctuation">,</span>                    <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token punctuation">,</span>                    <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">OPTIONS</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token operator">::</span><span class="token function">name</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpFirewall<span class="token punctuation">.</span><span class="token function">setAllowedHttpMethods</span><span class="token punctuation">(</span>allowedHttpMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> httpFirewall<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="거부된-요청을-무시하지-말고-추적하세요"><a href="#거부된-요청을-무시하지-말고-추적하세요" class="headerlink" title="거부된 요청을 무시하지 말고 추적하세요"></a>거부된 요청을 무시하지 말고 추적하세요</h4><p>올바른 클라이언트가 아닌 봇에 의한 잘못된 요청일 수 있으나 <strong>프론트엔드 개발자가 서버에서 요구하는 REST API 설계대로 요청하지 않았을 가능성</strong>을 간과해서는 안된다. 서버에서는 최소한 이러한 요청에 대해서 <strong>오류 메시지 또는 <a href="https://engineering.linecorp.com/ko/blog/log-collection-system-sentry-on-premise">Sentry</a>와 같은 오류 추적 솔루션으로 분석할 수 있도록 남겨야</strong>한다.</p><blockquote><p>만약, <a href="https://docs.aws.amazon.com/waf/latest/developerguide/classic-web-acl-string-conditions.html">AWS WAF</a>를 사용한다면 설정과 규칙에 따라 더블 슬래시가 포함된 요청이 서버 애플리케이션까지 도달하지 않을 수 있음을 백엔드 개발자는 알고 있어야 합니다.</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;pre class=&quot;language-java&quot; data-language=&quot;java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;org</summary>
      
    
    
    
    
    <category term="Spring Security" scheme="https://kdevkr.github.io/tags/Spring-Security/"/>
    
    <category term="Firewall" scheme="https://kdevkr.github.io/tags/Firewall/"/>
    
  </entry>
  
  <entry>
    <title>디버그</title>
    <link href="https://kdevkr.github.io/debugging/"/>
    <id>https://kdevkr.github.io/debugging/</id>
    <published>2024-08-17T03:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.494Z</updated>
    
    <content type="html"><![CDATA[<p><strong>개발자 또는 엔지니어</strong>가 시스템 오류에 대한 원인을 찾기 위한 <strong>가장 간단한 방법은 System.out.println 또는 console.log와 같은 메시지를 남겨보는</strong> 걸 거에요. 그렇지만 개발 생산성을 위해서는 인텔리제이 또는 VSCode 뿐만 아니라 크롬 개발자 도구에서 제공하는 <strong>디버거를 통해 원하는 코드 라인에 중단점(Breakpoint)를 걸어</strong> 전후 상황에 대한 데이터를 확인하는 것도 중요합니다. 소프트웨어 개발자가 여러가지 상황에 따라 어떻게 원인을 찾아갈 수 있는지 알아봅니다.</p><h4 id="크롬-개발자-도구의-네트워크-요청은-확인할-줄-알아야"><a href="#크롬-개발자-도구의-네트워크-요청은-확인할-줄-알아야" class="headerlink" title="크롬 개발자 도구의 네트워크 요청은 확인할 줄 알아야"></a>크롬 개발자 도구의 네트워크 요청은 확인할 줄 알아야</h4><p>백엔드 개발자라면 서버에 남은 오류 메시지를 통해 눈에 보이지 않는 백그라운드에서 원인을 특정할 수도 있지만 가장 기본적으로는 크롬 브라우저의 네트워크 탭을 통해 문제에 대한 상황에서 어떻게 네트워크 요청이 이루어지는지 확인하는 것이 필요하다. 문제에 대한 상황에 대해서 테스트 엔지니어가 재현 상황에 대해 상세하게 버그 리포트를 등록해줄 수도 있지만 조직 내에 테스트 엔지니어가 없거나 바쁘다면 개발자가 직접 수행해보고 원인을 찾아야만 한다.</p><p><a href="https://www.youtube.com/watch?v=e1gAyQuIFQo">Inspect Network Activity - Chrome DevTools 101</a></p><ul><li>네트워크 요청에 빨간색으로 표시되는 것이 있는지 확인하기</li><li>특정 동작 시 발생하는 네트워크 요청 체크하기</li><li>요청 파라미터 또는 본문과 오류 응답 확인하기</li></ul><h4 id="오류가-발생하는-API와-비즈니스-로직-체크"><a href="#오류가-발생하는-API와-비즈니스-로직-체크" class="headerlink" title="오류가 발생하는 API와 비즈니스 로직 체크"></a>오류가 발생하는 API와 비즈니스 로직 체크</h4><p>크롬 개발자 도구를 통해 네트워크 요청에 대해 분석했다면 백엔드 개발자는 서버 애플리케이션에 구현한 API와 서비스 레이어의 비즈니스 로직을 검토해야한다. 이때 코드에 로그 메시지를 남겨 출력하는 것보다는 인텔리제이에서 제공하는 디버거로 중단점을 거는 것이 더 효율적이다. 만약, 회사에서 인텔리제이를 사용하고 있다면 아래의 정보들이 도움이 될 것이다.</p><ul><li><a href="https://blog.jetbrains.com/idea/2023/02/debugger-upskill-stepping/">Debugger Upskill: Basic and Advanced Stepping</a></li><li><a href="https://www.youtube.com/watch?v=ZbAVoypAIbE">IntelliJ IDEA: Debugger Upskill</a></li></ul><hr><p>일반적으로 대부분의 오류는 올바르게 요청되지 않았거나 유효성 검사의 부족으로인해 의도된 데이터가 생략되어있거나 테스트 코드의 부재 또는 부실한 코드로 인해 일부 케이스에 대해 검증되지 않은 비즈니스 로직에 해당됩니다. <strong>그래도 원인이 명확하지 않다면</strong> 때로는 동료와의 커뮤니케이션을 해보는 것도 디버그 방법 중 하나라고 생각합니다. 동료에게 도움을 요청할 때에는 어디까지 확인을 해보았는지 상세하게 공유하는 것도 필요하겠죠?</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;strong&gt;개발자 또는 엔지니어&lt;/strong&gt;가 시스템 오류에 대한 원인을 찾기 위한 &lt;strong&gt;가장 간단한 방법은 System.out.println 또는 console.log와 같은 메시지를 남겨보는&lt;/strong&gt; 걸 거에요. 그렇지</summary>
      
    
    
    
    
    <category term="Debug" scheme="https://kdevkr.github.io/tags/Debug/"/>
    
    <category term="Debugger" scheme="https://kdevkr.github.io/tags/Debugger/"/>
    
  </entry>
  
  <entry>
    <title>E.164</title>
    <link href="https://kdevkr.github.io/e164/"/>
    <id>https://kdevkr.github.io/e164/</id>
    <published>2024-08-15T11:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.494Z</updated>
    
    <content type="html"><![CDATA[<h4 id="What-is-the-E-164-format"><a href="#What-is-the-E-164-format" class="headerlink" title="What is the E.164 format?"></a>What is the E.164 format?</h4><p><strong>E.164</strong>는 전세계적으로 사용되는 국제전화번호에 대한 표준 형식이다. 문자 메시지 또는 왓츠앱 그리고 카카오 알림톡을 보내기 위해서 <a href="https://docs.aws.amazon.com/ko_kr/sns/latest/dg/sms_publish-to-phone.html">발송 인터페이스 문서</a>를 확인해보면 휴대폰 번호 필드에 E.164 형식의 값을 요구하는 것을 확인할 수 있다. 글로벌 서비스나 솔루션을 준비한다면 프론트엔드에서도 <a href="https://github.com/jackocnr/intl-tel-input">국가별 전화번호를 입력할 수 있는 컴포넌트</a>를 준비하는 편이다.</p><p><img data-src="https://file.okky.kr/images/1723708024170.png"></p><h4 id="821012345678"><a href="#821012345678" class="headerlink" title="+821012345678"></a>+821012345678</h4><ul><li>일반적으로 공백을 포함하지 않는 것으로 표현한다.</li><li>전화번호는 0으로 시작하는 부분은 생략한다.</li><li>한국의 국가 번호(country code)는 82 이며 이동통신망(area code)은 10 이다.</li><li>ITU-T의 E.164는 최대 15자리이다.</li></ul><h4 id="참고-링크"><a href="#참고-링크" class="headerlink" title="참고 링크"></a>참고 링크</h4><ul><li><a href="https://www.twilio.com/docs/glossary/what-e164">What is E.164? | Twilio Docs</a></li><li><a href="http://www.ktword.co.kr/test/view/view.php?no=1970">E.164 | 정보통신기술용어해설</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;What-is-the-E-164-format&quot;&gt;&lt;a href=&quot;#What-is-the-E-164-format&quot; class=&quot;headerlink&quot; title=&quot;What is the E.164 format?&quot;&gt;&lt;/a&gt;What is the E</summary>
      
    
    
    
    
    <category term="Phone Number" scheme="https://kdevkr.github.io/tags/Phone-Number/"/>
    
  </entry>
  
  <entry>
    <title>REST Assured</title>
    <link href="https://kdevkr.github.io/rest-assured/"/>
    <id>https://kdevkr.github.io/rest-assured/</id>
    <published>2024-08-09T14:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.498Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://rest-assured.io/">REST Assured</a>를 사용하면 자바 애플리케이션에서 <strong>인수 테스트</strong>를 위한 코드를 작성할 수 있다. 현재 조직은 테스트 커버리지를 체크하지 않고 비즈니스 레이어를 위주로 테스트 코드를 작성하기로 했었다. 온프레미스 형태의 B2B 솔루션이 아닌 <strong>SaaS 서비스</strong>를 준비하면서 <strong>테스트 자동화</strong>를 위해 많은 고민을 하고 있다. 일단 <a href="https://playwright.dev/">Playwright</a>와 <a href="https://allurereport.org/">Allure Report</a>를 사용하고자 준비중이라 이에 맞춰 서비스 개발 시 Allure Report와 통합할 수 있는 <strong>JUnit5 + Rest Assured</strong>로 테스트 코드를 작성하려고 한다.</p><h4 id="Gradle-Dependencies"><a href="#Gradle-Dependencies" class="headerlink" title="Gradle Dependencies"></a>Gradle Dependencies</h4><p>Rest Assured 와 함께 <a href="https://hamcrest.org/JavaHamcrest/">Hamcrest</a>를 많이 사용하는 것 같은데 스프링 부트 스타터의 테스트 의존성에는 기본적으로 Hamcrest를 포함하고 있다. 단위 테스트 코드를 작성할 때 Hamcrest를 사용해본적은 없어서 이번 기회에 잘 활용해보도록 해야겠다.</p><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    testImplementation <span class="token string">'org.springframework.boot:spring-boot-starter-test'</span>    testImplementation <span class="token string">'io.rest-assured:rest-assured:5.5.0'</span><span class="token punctuation">&#125;</span></code></pre><h4 id="Behavior-Driven-Development"><a href="#Behavior-Driven-Development" class="headerlink" title="Behavior Driven Development"></a>Behavior Driven Development</h4><p>그동안은 테스트 코드를 작성하더라도 TDD를 수행하지는 않았으며 솔루션 커스터마이징 요구사항에 맞는지만 확인해왔다. Rest Assured는 BDD로 E2E 테스트 코드를 작성할 수 있도록 제공해주기 때문에 프론트엔드나 QA 엔지니어가 작성하는 Playwright 와도 비슷하게 작성해갈 수 있을 것으로 보인다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"End to End Test"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>webEnvironment <span class="token operator">=</span> <span class="token class-name">SpringBootTest<span class="token punctuation">.</span>WebEnvironment</span><span class="token punctuation">.</span><span class="token constant">RANDOM_PORT</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">DemoApplicationTests</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@LocalServerPort</span>    <span class="token keyword">int</span> port<span class="token punctuation">;</span>    <span class="token annotation punctuation">@BeforeEach</span>    <span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">RestAssured</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">void</span> <span class="token function">whenGet_thenOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">RestAssured</span>                <span class="token punctuation">.</span><span class="token function">given</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AllureRestAssured</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">USER_AGENT</span><span class="token punctuation">,</span>                        <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifValidationFails</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">statusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">Matchers</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">"Hello World"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="Allure-REST-Assured"><a href="#Allure-REST-Assured" class="headerlink" title="Allure REST Assured"></a>Allure REST Assured</h4><p>그래들 플러그인을 추가하고 <strong>allureReport</strong> 또는 <strong>allureServe</strong> 태스크를 실행하면 Allure 리포트를 확인할 수 있다.</p><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">plugins <span class="token punctuation">&#123;</span>    id <span class="token string">'io.qameta.allure'</span> version <span class="token string">'2.12.0'</span><span class="token punctuation">&#125;</span>dependencies <span class="token punctuation">&#123;</span>    testImplementation <span class="token function">platform</span><span class="token punctuation">(</span><span class="token string">'io.qameta.allure:allure-bom:2.28.0'</span><span class="token punctuation">)</span>    testImplementation <span class="token interpolation-string"><span class="token string">"io.qameta.allure:allure-junit5"</span></span>    testImplementation <span class="token interpolation-string"><span class="token string">"io.qameta.allure:allure-rest-assured"</span></span><span class="token punctuation">&#125;</span></code></pre><p><img data-src="/images/posts/rest-assured/01.png" alt="Allure Report"></p><h4 id="참고-링크"><a href="#참고-링크" class="headerlink" title="참고 링크"></a>참고 링크</h4><ul><li><a href="https://www.baeldung.com/rest-assured-tutorial">A Guide to REST-assured</a></li><li><a href="https://www.baeldung.com/rest-assured-header-cookie-parameter">Headers, Cookies and Parameters with REST-assured</a></li><li><a href="https://www.baeldung.com/rest-assured-response">Getting and Verifying Response Data with REST-assured</a></li><li><a href="https://www.baeldung.com/rest-assured-authentication">REST Assured Authentication</a></li><li><a href="https://allurereport.org/docs/restassured/">Allure REST Assured</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://rest-assured.io/&quot;&gt;REST Assured&lt;/a&gt;를 사용하면 자바 애플리케이션에서 &lt;strong&gt;인수 테스트&lt;/strong&gt;를 위한 코드를 작성할 수 있다. 현재 조직은 테스트 커버리지를 체크하지 않고 </summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>유효성 검증</title>
    <link href="https://kdevkr.github.io/validation/"/>
    <id>https://kdevkr.github.io/validation/</id>
    <published>2024-08-07T13:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.502Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>서버 애플리케이션에서 좋은 REST API를 설계하는 것에는 잘못된 요청에 대해 유효성 검사를 포함하여 올바르게 예외를 처리하는 것도 포함됩니다.</p></blockquote><p>자바 애플리케이션에서 <strong>유효성 검증(Validation)</strong> 은 JSR-303 과 스프링 프레임워크에서 제공하는 추상화를 통해 쉽고 유연하게 유효성 검증을 수행할 수 있다. 아래의 스프링 부트 스타터를 추가하면 <strong>hibernate-validator</strong> 가 포함되어있다.</p><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">implementation <span class="token string">'org.springframework.boot:spring-boot-starter-validation'</span></code></pre><h4 id="올바르지-않은-요청에-대한-예외-목록"><a href="#올바르지-않은-요청에-대한-예외-목록" class="headerlink" title="올바르지 않은 요청에 대한 예외 목록"></a>올바르지 않은 요청에 대한 예외 목록</h4><p>유효성 검사를 포함하여 잘못된 요청에 대해서 발생하는 예외는 아래와 같다.</p><ul><li>MissingPathVariableException - 경로 변수가 지정된 파라미터가 없거나 경로 변수에 빈 값이 주어진 경우</li><li>MethodArgumentTypeMismatchException - 바인딩 데이터를 파라미터로 변환할 수 없는 경우</li><li>HttpMessageNotReadableException - 요청 바디를 올바르게 처리할 수 없는 경우</li><li>MissingServletRequestParameterException - 필수 파라미터가 포함되지 않은 경우</li><li>MethodArgumentNotValidException - 폼 데이터 또는 요청 바디가 유효성 검사에 통과하지 못한 경우</li><li>ConstraintViolationException - 경로 변수 또는 요청 파라미터가 유효성 검사에 통과하지 못한 경우</li><li>HttpRequestMethodNotSupportedException - 지원하지 않는 HTTP 함수로 요청한 경우</li></ul><blockquote><p>UnexpectedTypeException는 유효성 검사를 위해 잘못된 유형을 지정하였을 경우에 발생하므로 잘못된 요청이 아닌 서버 오류에 해당됩니다.<br>예를 들어, Integer 또는 Long과 같은 파라미터에 @NotBlank를 선언했을때 확인할 수 있습니다.</p></blockquote><h4 id="유효성-검사-예외-메시지를-확인하는-속성"><a href="#유효성-검사-예외-메시지를-확인하는-속성" class="headerlink" title="유효성 검사 예외 메시지를 확인하는 속성"></a>유효성 검사 예외 메시지를 확인하는 속성</h4><p>스프링 부트 애플리케이션에서 기본적인 오류 응답에 유효성 검사에 대한 메시지를 포함하여 확인하고 싶다면 아래와 같이 <code>server.error</code> 속성을 설정하면 된다.</p><pre class="language-yaml" data-language="yaml"><div class="caption"><span>application.yml</span></div><code class="language-yaml"><span class="token key atrule">server.error</span><span class="token punctuation">:</span>  <span class="token key atrule">include-exception</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">include-binding-errors</span><span class="token punctuation">:</span> always  <span class="token key atrule">include-message</span><span class="token punctuation">:</span> always  <span class="token key atrule">include-stacktrace</span><span class="token punctuation">:</span> never</code></pre><h4 id="Valid-그리고-Validated"><a href="#Valid-그리고-Validated" class="headerlink" title="Valid 그리고 Validated"></a>Valid 그리고 Validated</h4><p>기본적으로 JSR-303 표준의 유효성 검사를 위한 어노테이션은 @Valid 이다. REST API 뿐만 아니라 비즈니스 레이어에서도 유효성 검사를 수행하고 싶은 경우에는 @Validated를 활용하여야 한다. 또한, <strong>@Validated</strong>는 groups 속성을 통해 동일한 모델에 대해서 상황에 따라 유효성 검증 유무를 선택할 수 있어 더 유연하게 처리할 수 있다. <strong>PathVariable</strong> 과 <strong>RequestParam</strong> 에 대해서 유효성 검사를 수행하고자 하는 경우에는 @Validated를 컨트롤러 클래스에 추가해야한다.</p><h4 id="Cascaded-Validation"><a href="#Cascaded-Validation" class="headerlink" title="Cascaded Validation"></a>Cascaded Validation</h4><p>모델 빈 클래스에 하위 객체로 구성된 필드에 대해서 유효성 검증을 적용하고자하는 경우에는 필드에 <strong>@Valid</strong>를 선언하면 된다. 그렇지 않은 경우 하위 모델에 대해서는 기본적으로 유효성 검사를 자동으로 수행하지 않는다. 다음은 리스트로 구성된 필드에 개별 유효성 검사를 수행하는 케이스를 보여준다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Account</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@NotBlank</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>    <span class="token annotation punctuation">@NotBlank</span>    <span class="token annotation punctuation">@Size</span><span class="token punctuation">(</span>min <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token annotation punctuation">@Valid</span> <span class="token class-name">Contact</span><span class="token operator">></span> contacts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Data</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Contact</span> <span class="token punctuation">&#123;</span>        <span class="token annotation punctuation">@Size</span><span class="token punctuation">(</span>max <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">)</span>        <span class="token annotation punctuation">@NotEmpty</span>        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>        <span class="token annotation punctuation">@Email</span>        <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>        <span class="token annotation punctuation">@Pattern</span><span class="token punctuation">(</span>regexp <span class="token operator">=</span> <span class="token string">"^\\+?[1-9]\\d&#123;0,2&#125;[\\s\\d]&#123;1,14&#125;$"</span><span class="token punctuation">)</span> <span class="token comment">// NOTE: E.164</span>        <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="ConstraintValidator"><a href="#ConstraintValidator" class="headerlink" title="ConstraintValidator"></a>ConstraintValidator</h4><p>JSR-303 또는 JSR-380 표준의 어노테이션으로 커버하지 못하는 입력값에 대한 유효성 검증을 위해서 <strong>ConstraintValidator</strong> 인터페이스를 구현하여 시스템 요구사항에 맞는 유효성 검증을 수행할 수 있도록 구현할 수 있다. 예를 들어, 앞선 예시에서는 전화번호 입력 필드에 대해서 E.164를 검증하기 위해서 정규식을 사용했지만 더 유연하게 입력할 수 있도록 지원하기 위해서 <a href="https://github.com/google/libphonenumber">google&#x2F;libphonenumber</a>에서 제공하는 유틸을 사용한 유효성 검증을 구현할 수 있다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Documented</span><span class="token annotation punctuation">@Constraint</span><span class="token punctuation">(</span>validatedBy <span class="token operator">=</span> <span class="token class-name">PhoneConstraintValidator</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">FIELD</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">ANNOTATION_TYPE</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">CONSTRUCTOR</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">PARAMETER</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE_USE</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Phone</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> <span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"Invalid E.164 format: '$&#123;validatedValue&#125;'"</span><span class="token punctuation">;</span>    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">groups</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Payload</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PhoneConstraintValidator</span> <span class="token keyword">implements</span> <span class="token class-name">ConstraintValidator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Phone</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">Phone</span> constraintAnnotation<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ConstraintValidator</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>constraintAnnotation<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isValid</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">ConstraintValidatorContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">PhoneNumberUtil</span> phoneUtil <span class="token operator">=</span> <span class="token class-name">PhoneNumberUtil</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Phonenumber<span class="token punctuation">.</span>PhoneNumber</span> number <span class="token operator">=</span> phoneUtil<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">Phonenumber<span class="token punctuation">.</span>PhoneNumber<span class="token punctuation">.</span>CountryCodeSource</span><span class="token punctuation">.</span><span class="token constant">UNSPECIFIED</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> phoneUtil<span class="token punctuation">.</span><span class="token function">isPossibleNumber</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="유효성-검증-예외에-대한-오류-처리"><a href="#유효성-검증-예외에-대한-오류-처리" class="headerlink" title="유효성 검증 예외에 대한 오류 처리"></a>유효성 검증 예외에 대한 오류 처리</h4><p>유효성 검증 실패 시 데이터 바인딩 방식과 유효성 검증 어노테이션에 따라 예외가 발생한다. <strong>ExceptionHandler</strong>를 통해 공통 오류 응답을 구현하고자 한다면 최소한 <strong>ConstraintViolationException</strong>과 <strong>MethodArgumentNotValidException</strong> 에 대해서는 유효성 검사에 대한 메시지가 올바르게 포함되도록 작성하도록 하자.</p><ul><li>PathVariable, RequestParam + Validated → ConstraintViolationException</li><li>RequestBody + Validated → MethodArgumentNotValidException</li></ul><h4 id="참고-링크"><a href="#참고-링크" class="headerlink" title="참고 링크"></a>참고 링크</h4><ul><li><a href="https://jakarta.ee/specifications/bean-validation/3.0/jakarta-bean-validation-spec-3.0.html">Jakarta Bean Validation specification</a></li><li><a href="https://meetup.nhncloud.com/posts/223">Validation 어디까지 해봤니?</a></li><li><a href="https://www.baeldung.com/spring-valid-vs-validated">Differences in @Valid and @Validated Annotations in Spring</a></li><li><a href="https://www.youtube.com/watch?v=GdKuxmtA65I">Bean Validation 2.0 - you’ve put your annotations everywhere! by Gunnar Morling</a></li><li><a href="https://www.baeldung.com/java-validation">Java Bean Validation Basics</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;서버 애플리케이션에서 좋은 REST API를 설계하는 것에는 잘못된 요청에 대해 유효성 검사를 포함하여 올바르게 예외를 처리하는 것도 포함됩니다.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;자바 애플리케이션에서 &lt;strong&gt;유</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>뉴렐릭 인프라 에이전트 설치가 되지 않을때</title>
    <link href="https://kdevkr.github.io/install-newrelic-infra-agent/"/>
    <id>https://kdevkr.github.io/install-newrelic-infra-agent/</id>
    <published>2024-08-01T13:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.494Z</updated>
    
    <content type="html"><![CDATA[<p><img data-src="/images/posts/install-newrelic-infra-agent/01.png"></p><p>뉴렐릭은 무료 플랜을 제공하는 SaaS APM 솔루션으로 웹 UI에서 원하는 에이전트를 쉽게 설치할 수 있도록 명령어를 제공하고 있다. 그런데, 아래와 같이 gzip 관련 명령어가 수행될 때 오류가 발생하는 것을 경험할 수 있다.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-Ls</span> https://download.newrelic.com/install/newrelic-cli/scripts/install.sh <span class="token operator">|</span> <span class="token function">bash</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token assign-left variable">NEW_RELIC_API_KEY</span><span class="token operator">=</span>NRAK-XXXX <span class="token assign-left variable">NEW_RELIC_ACCOUNT_ID</span><span class="token operator">=</span>45XXXXX /usr/local/bin/newrelic <span class="token function">install</span>Installing New Relic CLI v0.92.0gzip: stdin: unexpected end of <span class="token function">file</span>tar: Child returned status <span class="token number">1</span>tar: Error is not recoverable: exiting nowAn error occurred installing the tool.The contents of the directory /tmp/tmp.ROXuwOdosK have been left <span class="token keyword">in</span> place to <span class="token builtin class-name">help</span> to debug the issue.</code></pre><p>위와 같은 오류가 발생하는 경우의 원인은 루트 권한으로 수행하지 않았기 때문이며 루트 계정으로 사용자를 전환하여 설치하도록 하자.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">su</span> -<span class="token function">curl</span> <span class="token parameter variable">-Ls</span> https://download.newrelic.com/install/newrelic-cli/scripts/install.sh <span class="token operator">|</span> <span class="token function">bash</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token assign-left variable">NEW_RELIC_API_KEY</span><span class="token operator">=</span>NRAK-XXXX <span class="token assign-left variable">NEW_RELIC_ACCOUNT_ID</span><span class="token operator">=</span>45XXXXX /usr/local/bin/newrelic <span class="token function">install</span>Installing New Relic CLI v0.92.0Installing to /usr/local/bin<span class="token punctuation">..</span>.</code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img data-src=&quot;/images/posts/install-newrelic-infra-agent/01.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;뉴렐릭은 무료 플랜을 제공하는 SaaS APM 솔루션으로 웹 UI에서 원하는 에이전트를 쉽게 설치할 수 있도록 명</summary>
      
    
    
    
    
    <category term="Newrelic CLI" scheme="https://kdevkr.github.io/tags/Newrelic-CLI/"/>
    
    <category term="Infrastructure Agent" scheme="https://kdevkr.github.io/tags/Infrastructure-Agent/"/>
    
  </entry>
  
  <entry>
    <title>2차 인증 설정을 위한 QR 코드</title>
    <link href="https://kdevkr.github.io/mfa-qrcode/"/>
    <id>https://kdevkr.github.io/mfa-qrcode/</id>
    <published>2024-07-20T03:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.498Z</updated>
    
    <content type="html"><![CDATA[<p>오늘은 2차 인증 설정 과정에서 OTP 앱으로 스캔할 수 있도록 코드 대신에 제공하는 QR 코드에 대해서 알아보려고 한다.</p><h4 id="RFC-6238"><a href="#RFC-6238" class="headerlink" title="RFC 6238"></a>RFC 6238</h4><p>Google Authenticator, Microsoft Authenticator 그리고 Authy와 같은 OTP 인증 앱들은 <a href="https://datatracker.ietf.org/doc/html/rfc6238">RFC6238</a>로 정의된 TOTP 표준에 따라 구현되어있고 QR 코드에 포함되는 텍스트는 <a href="https://github.com/google/google-authenticator/wiki/Key-Uri-Format">Key Uri Format</a>로 구성되어야 읽을 수 있다.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># otpauth://TYPE/LABEL?PARAMETERS</span>otpauth://totp/Mambo:kdevkr@email.com?secret<span class="token operator">=</span>HXDMVJECJJWSRB3HWIZR4IFUGFTMXBOZ<span class="token operator">&amp;</span><span class="token assign-left variable">issuer</span><span class="token operator">=</span>Mambo<span class="token operator">&amp;</span><span class="token assign-left variable">algorithm</span><span class="token operator">=</span>SHA1<span class="token operator">&amp;</span><span class="token assign-left variable">digits</span><span class="token operator">=</span><span class="token number">6</span><span class="token operator">&amp;</span><span class="token assign-left variable">period</span><span class="token operator">=</span><span class="token number">30</span></code></pre><h4 id="TOTP-QR-코드-이미지-만들기"><a href="#TOTP-QR-코드-이미지-만들기" class="headerlink" title="TOTP QR 코드 이미지 만들기"></a>TOTP QR 코드 이미지 만들기</h4><p>QR 코드 이미지를 만들기 위해서 <a href="https://github.com/samdjstevens/java-totp">java-totp</a> 라이브러리를 사용하려고 한다. 이 라이브러리는 비밀키 발급부터 QR 코드를 HTML에서 사용하기 위한 <a href="https://developer.mozilla.org/ko/docs/Web/HTTP/Basics_of_HTTP/Data_URLs">Data URI</a>로 변환하는 <strong>Utils.getDataUriForImage</strong> 함수도 제공해주고 있다.</p><pre class="language-groovy" data-language="groovy"><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    implementation <span class="token string">'dev.samstevens.totp:totp:1.7.1'</span>    implementation <span class="token string">'com.google.zxing:javase:3.5.3'</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">SecretGenerator</span> secretGenerator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSecretGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> secret <span class="token operator">=</span> secretGenerator<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">QrData</span> qrData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QrData<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">label</span><span class="token punctuation">(</span><span class="token string">"kdevkr@gmail.com"</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">secret</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">issuer</span><span class="token punctuation">(</span><span class="token string">"Mambo"</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">algorithm</span><span class="token punctuation">(</span><span class="token class-name">HashingAlgorithm</span><span class="token punctuation">.</span><span class="token constant">SHA1</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">digits</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">period</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ZxingPngQrGenerator</span> qrGenerator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZxingPngQrGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>qrGenerator<span class="token punctuation">.</span><span class="token function">setImageSize</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> qrImageBytes <span class="token operator">=</span> qrGenerator<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>qrData<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> qrDataUri <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">getDataUriForImage</span><span class="token punctuation">(</span>qrImageBytes<span class="token punctuation">,</span> qrGenerator<span class="token punctuation">.</span><span class="token function">getImageMimeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>qrDataUri<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p><a href="https://zxing.org/w/decode.jspx">Zxing Decoder Online</a>을 사용하여 올바르게 이미지가 만들어졌는지 <a href="https://zxing.org/w/decode?u=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPoAAAD6AQAAAACgl2eQAAACoUlEQVR4Xu2YTW6rUAyFHWXAMEtgJ2VjSInExmAnLIEhA4Tf+Wzy01bqNNZT7oCSm68Sdo6PfTH/e432c+fH+gC5PkCuKsBmWn1r3WLWTD7MPl5uLZttIUB/l6sLuHrjPrhPeccXdQA7LX27fumxAeZmWnQ3KrJygJ3c57VbevPdFEVFAClsFsBql6EegB7m9eQ302UzfXf+LZg3A1lZUsHr5XfpvRU4lhFFArvK/9itAiiK7v7Y+m5rV7OzjOqphxJAM17c49mRwuyUv4IaHlEUAMLoW98vnvYkQB4wLedSQIPHW6fPbIuSMpDHPdUFAPSq8pcHqG86yvhS5uVW9yhqAOth9NE8e4xqwKOeUbwf2BCAcbnOyrcyrwlEqWavEKDcantCFNyF5Tsf6wCuZ9dvv3YYAeUVyojmWQjgt48x04/mia96Wn4VQG5/H+NU/sj3tDDaXfjfMkDLrG7olfKXVEd1J/82JpUATGOS9CoV6E5B6fKt9AoAWVm7nl1ZPmP56pumvUqASkktfY9SypYUHVRoGSBWDkf4vkQxUWih4TLAlueLzK2kKqPSIUhBvfwWFYBOzytAJ0ltM3wModxnFG8HnAmz51Sh8uqUatyeDnU30hqAKn8gt7c8nVNZNKdKQNonwxF6yPIy7h56KADQgzzOFzGGKBTyrQurCrCR2z67OVNxNCdmpUpABDAwK13x0A1RXOVWGpILATPdkntewfAeYcQDYq8OwNrIMlKV5TuhHPKtAuQTZ6p9j6kuPOrZWCsArfNGS41IY2aHPTGBMHqWAjjzkuDjjZGOFvSlh2jLAL0uhzPNAegrhVINUF+6GaMn5s9oVwzwtE9CifJXm/fmpbIqABbb0kO8wDTGpBtttBLw5/oAuT5Arv8E+AcOAIqU2Few9gAAAABJRU5ErkJggg==">확인</a>해볼 수 있습니다.</p></blockquote><h4 id="보안-이슈"><a href="#보안-이슈" class="headerlink" title="보안 이슈"></a>보안 이슈</h4><p>2차 인증 설정을 위해서 제공하는 QR 코드에는 암호화되지 않은 상태의 보안키가 포함되어있다. 서드 파티인 OTP 앱은 QR 코드를 스캔하여 포함된 텍스트에서 정보를 추출해야하므로 보안키를 암호화 할수는 없다. 아래와 같이 <a href="https://github.com/j256/two-factor-auth/blob/d28c4da7cbe593774a7420a86257b803b67c8f5a/src/main/java/com/j256/twofactorauth/TimeBasedOneTimePasswordUtil.java#L474-L480">two-factor-auth</a>처럼 QR 코드 이미지 생성을 위해서 외부 주소에 의존하는 것은 좋지 않다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">qrImageUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyId<span class="token punctuation">,</span> <span class="token class-name">String</span> secret<span class="token punctuation">,</span> <span class="token keyword">int</span> numDigits<span class="token punctuation">,</span> <span class="token keyword">int</span> imageDimension<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"https://chart.googleapis.com/chart?chs="</span> <span class="token operator">+</span> imageDimension <span class="token operator">+</span> <span class="token string">"x"</span> <span class="token operator">+</span> imageDimension <span class="token operator">+</span> <span class="token string">"&amp;cht=qr&amp;chl="</span>            <span class="token operator">+</span> imageDimension <span class="token operator">+</span> <span class="token string">"x"</span> <span class="token operator">+</span> imageDimension <span class="token operator">+</span> <span class="token string">"&amp;chld=M|0&amp;cht=qr&amp;chl="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">addOtpAuthPart</span><span class="token punctuation">(</span>keyId<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> sb<span class="token punctuation">,</span> numDigits<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>구글에서 QR 이미지 생성을 제공했던 주소는 제거되었고 대체할 수 있는 주소가 있지만 외부 주소에 보안키를 전달하는 것은 권장하지 않습니다.</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;오늘은 2차 인증 설정 과정에서 OTP 앱으로 스캔할 수 있도록 코드 대신에 제공하는 QR 코드에 대해서 알아보려고 한다.&lt;/p&gt;
&lt;h4 id=&quot;RFC-6238&quot;&gt;&lt;a href=&quot;#RFC-6238&quot; class=&quot;headerlink&quot; title=&quot;</summary>
      
    
    
    
    
    <category term="2FA" scheme="https://kdevkr.github.io/tags/2FA/"/>
    
    <category term="TOTP" scheme="https://kdevkr.github.io/tags/TOTP/"/>
    
    <category term="QRCode" scheme="https://kdevkr.github.io/tags/QRCode/"/>
    
  </entry>
  
  <entry>
    <title>패스키 로그인 고도화</title>
    <link href="https://kdevkr.github.io/passkey-login-advanced/"/>
    <id>https://kdevkr.github.io/passkey-login-advanced/</id>
    <published>2024-07-15T14:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.498Z</updated>
    
    <content type="html"><![CDATA[<h4 id="패스키-생성-알고리즘"><a href="#패스키-생성-알고리즘" class="headerlink" title="패스키 생성 알고리즘"></a>패스키 생성 알고리즘</h4><p>패스키 등록 시 PublicKeyCredentialCreationOptions의 pubKeyCredParams 를 통해 RP 서버에서 선호하는 공개키 알고리즘 목록을 제공할 수 있는데요. 이때 공개키 알고리즘 목록에는 ES256과 RS256은 반드시 포함하는게 좋습니다. 그 이유는 <a href="https://github.com/w3c/webauthn/issues/1757#issuecomment-1169035781">대부분 ES256를 지원하고 일부는 RS256를 지원</a>한다고 하기 때문입니다.</p><h4 id="패스키-제공업체-표시"><a href="#패스키-제공업체-표시" class="headerlink" title="패스키 제공업체 표시"></a>패스키 제공업체 표시</h4><p><a href="https://web.dev/articles/webauthn-aaguid?hl=ko">Determine the passkey provider with AAGUID</a>에서 소개하는 <a href="https://github.com/passkeydeveloper/passkey-authenticator-aaguids">Passkey Provider AAGUIDs</a>에는 일부 인증 기기에 대한 이름과 아이콘 정보를 포함하고 있습니다. <a href="https://passkeydeveloper.github.io/passkey-authenticator-aaguids/explorer/">Passkeys Authenticator AAGUID Explorer</a>를 살펴보면 대부분의 사용자는 주로 아래의 인증 기기를 사용할 것 같습니다.</p><table><thead><tr><th>Authenticator</th><th>AAGUID</th></tr></thead><tbody><tr><td>Google Password Manager</td><td>ea9b8d66-4d01-1d21-3ce4-b6b48cb575d4</td></tr><tr><td>Chrome on Mac</td><td>adce0002-35bc-c60a-648b-0b25f1f05503</td></tr><tr><td>iCloud Keychain</td><td>fbfc3007-154e-4ecc-8c0b-6e020557d7bd</td></tr><tr><td>Samsung Pass</td><td>53414d53-554e-4700-0000-000000000000</td></tr></tbody></table><h5 id="AAGUID-UUID-문자열"><a href="#AAGUID-UUID-문자열" class="headerlink" title="AAGUID UUID 문자열"></a>AAGUID UUID 문자열</h5><p><a href="https://github.com/Yubico/java-webauthn-server">java-webauthn-server</a> 라이브러리의 AAGUID 클래스를 통해 ByteArray로 구성된 aaguid를 RFC4122 표준의 UUID 형식의 문자열로 변환하여 저장할 수 있습니다. 패스키 등록 이후에 변하지 않는 항목이므로 패스키 등록 과정에서 Base64URL 보다는 UUID 형태로 저장해두는게 프론트엔드에서 사용하기에는 더 편할 것 같네요. 아래와 같이 AAGUID의 asGuidString 함수를 호출해서 가져올 수 있습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">RegistrationResult</span> result <span class="token operator">=</span> relyingParty<span class="token punctuation">.</span><span class="token function">finishRegistration</span><span class="token punctuation">(</span>        <span class="token class-name">FinishRegistrationOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>publicKeyCredentialCreationOptions<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span>publicKeyCredential<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> aaguid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AAGUID</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getAaguid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asGuidString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="패스키-식별-가능한-이름-설정"><a href="#패스키-식별-가능한-이름-설정" class="headerlink" title="패스키 식별 가능한 이름 설정"></a>패스키 식별 가능한 이름 설정</h4><p><img data-src="/images/posts/passkey-login/02.png"></p><p>위 화면은 깃허브에서 패스키 등록 시 패스키에 대한 이름을 입력하도록 요구하는 단계입니다. 이와 같이 패스키 등록 시 사용자에게 등록하려는 인증 기기에 대한 이름을 입력하도록 요구하거나 사용자에게 기기에 대한 이름을 별도로 입력하지 않고 <strong>Authenticator 1</strong> 과 같이 현재 등록된 기기의 수를 토대로 기본값을 제공하고 사용자가 별도로 이름을 수정할 수 있도록 하는게 좋습니다.</p><h4 id="패스키-등록-수-제한"><a href="#패스키-등록-수-제한" class="headerlink" title="패스키 등록 수 제한"></a>패스키 등록 수 제한</h4><p>일반적으로 패스키로 등록할 수 있는 기기에 대한 제약은 필요하지 않습니다만 사용자가 너무 많은 패스키를 등록하는 것은 오히려 보안 상 좋지 않을 수 있습니다. 기본적으로 사용자에 대한 패스키는 10개 이내로 제한하고 정말로 사용자가 요구할 때 확장하는 것을 권장합니다. 예를 들어, 저와 같은 사용자는 삼성 갤럭시 스마트폰의 삼성 패스만 사용하여 패스키를 등록할 수 있습니다.</p><p><a href="https://www.corbado.com/assets/Passkeys-Developer-Cheatsheet.pdf">Passkeys Cheat Sheet for Developers</a>에서 사용자에게 더 나은 패스키를 제공하기 위한 방법에 대해서 찾아보세요.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;패스키-생성-알고리즘&quot;&gt;&lt;a href=&quot;#패스키-생성-알고리즘&quot; class=&quot;headerlink&quot; title=&quot;패스키 생성 알고리즘&quot;&gt;&lt;/a&gt;패스키 생성 알고리즘&lt;/h4&gt;&lt;p&gt;패스키 등록 시 PublicKeyCredentialCreati</summary>
      
    
    
    
    
    <category term="Passkey" scheme="https://kdevkr.github.io/tags/Passkey/"/>
    
    <category term="WebAuthn" scheme="https://kdevkr.github.io/tags/WebAuthn/"/>
    
  </entry>
  
  <entry>
    <title>패스키 로그인</title>
    <link href="https://kdevkr.github.io/passkey-login/"/>
    <id>https://kdevkr.github.io/passkey-login/</id>
    <published>2024-07-14T03:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.498Z</updated>
    
    <content type="html"><![CDATA[<p>패스키 로그인은 사용자 계정에 대한 비밀번호를 입력하지 않고 사용자 계정에 대해 지문이나 얼굴 인식 그리고 보안키 등을 사용해서 미리 인증 정보를 등록해놓고 사용자의 인증 기기를 사용해서 로그인을 수행하도록 제공하는 걸 말합니다. 패스키는 로그인 뿐만 아니라 <a href="https://aws.amazon.com/ko/about-aws/whats-new/2024/06/aws-identity-access-management-passkey-authentication-factor/?nc1=h_ls">아마존 웹 서비스</a>와 <a href="https://docs.github.com/ko/authentication/authenticating-with-a-passkey/signing-in-with-a-passkey">깃허브</a>처럼 2차 인증을 위해서도 도입될 수 있습니다. 이 글을 작성해보는 이유는 패스키 로그인에 대한 흐름은 생각보다 간단한데 패스키에 대한 표준에서 사용되는 용어와 구현 과정에서의 여러가지 이슈들이 많아보이기 때문입니다. 이제 패스키 로그인에 대해서 정리해보도록 하죠.</p><h4 id="패스키-로그인에서-등록과-인증의-흐름"><a href="#패스키-로그인에서-등록과-인증의-흐름" class="headerlink" title="패스키 로그인에서 등록과 인증의 흐름"></a>패스키 로그인에서 등록과 인증의 흐름</h4><p>패스키 로그인 시 등록과 인증 과정은 생각보다 간단합니다. 사용자는 본인이 사용할 수 있는 인증 기기에 발급한 패스키 정보를 RP 도메인에 대한 패스키를 등록하고 로그인 화면에서 시스템에서 제공하는 패스키 로그인을 사용해 인증 기기에 존재하는 패스키를 선택하여 사용자 계정에 대한 인증을 요청하고 승인받아 로그인을 완료합니다. 패스키를 등록하고 인증하는 과정에서 서버에서 제공받은 챌린지와 공개키에 대한 서명 정보를 제공함으로써 패스키를 사용하여 로그인을 지원하는 서버에서는 사용자에 대한 신원을 안전하게 증명(Attestation) 또는 검증(Assertion)할 수 있습니다. </p><blockquote><p>패스키 관련 표준에서 등록(Registration)과 인증(Authentication)에 대한 과정은 단순한 인증 과정이 아니라 하나의 중요한 의식이라는 관점으로 <strong>세레모니(Ceremony)</strong> 라고 표현합니다. 따라서, 패스키에 대한 여러가지 정보를 참고할 때 세레모니라는 단어가 나오면 과정이라고 이해하시면 됩니다.</p></blockquote><h4 id="패스키-등록을-위한-서비스-제공자"><a href="#패스키-등록을-위한-서비스-제공자" class="headerlink" title="패스키 등록을 위한 서비스 제공자"></a>패스키 등록을 위한 서비스 제공자</h4><p>패스키를 통해 신원을 관리하고 검증하는 주체인 서비스 제공자는 신뢰당사자(Relyting Party)라고 합니다. RP는 도메인을 의미하며 패스키 등록과 인증을 요청할때마다 챌린지(Challenge)를 받아가도록 요구합니다. RP에서 응답하는 챌린지는 난수로 이루어진 바이트 배열로 알수없는 식별자로 CSRF 토큰과 비슷한 용도로 사용됩니다. 또한, RP에 대한 아이디는 도메인으로 구성되기 때문에 클라이언트로부터 전달되는 패스키에 대한 공개키 인증 정보가 올바른 출처에 있음을 쉽게 확인할 수 있게 됩니다. 그러면 자바 애플리케이션 서버에서 RP를 구성해보도록 할까요?</p><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    implementation <span class="token string">'com.yubico:webauthn-server-core:2.5.2'</span>    implementation <span class="token string">'com.yubico:webauthn-server-attestation:2.5.2'</span>    implementation <span class="token string">'com.yubico:yubico-util:2.5.2'</span><span class="token punctuation">&#125;</span></code></pre><p>먼저, 자바 애플리케이션에서 WebAuthn에 대한 Relyting Party를 구성하기 위해서 <a href="https://developers.yubico.com/java-webauthn-server/">java-webauthn-server</a> 라이브러리를 의존성에 추가해야합니다. 그리고 아래와 같이 RelyingPartyIdentity로 RP 도메인에 대한 신원을 정의하고 RelyingParty를 초기화하면 됩니다. CredentialRepository 는 패스키 등록과 인증 과정에서 이미 등록된 패스키 정보를 제공하기 위한 용도로 사용됩니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">RelyingParty</span> <span class="token function">generateRelyingParty</span><span class="token punctuation">(</span><span class="token class-name">PasskeyCredentialRepository</span> passkeyCredentialRepository<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">RelyingPartyIdentity</span> rpID <span class="token operator">=</span> <span class="token class-name">RelyingPartyIdentity</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">"kdev.ing"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"Mambo App"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token class-name">RelyingParty</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span>rpID<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">credentialRepository</span><span class="token punctuation">(</span>passkeyCredentialRepository<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">allowOriginSubdomain</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">origins</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"https://kdev.ing"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h5 id="🔥-SecurityError-The-RP-ID-“mambo”-is-invalid-for-this-domain"><a href="#🔥-SecurityError-The-RP-ID-“mambo”-is-invalid-for-this-domain" class="headerlink" title="🔥 SecurityError: The RP ID “mambo” is invalid for this domain"></a>🔥 SecurityError: The RP ID “mambo” is invalid for this domain</h5><pre class="language-bash" data-language="bash"><code class="language-bash">SecurityError: The RP ID <span class="token string">"mambo"</span> is invalid <span class="token keyword">for</span> this domain    at identifyAuthenticationError <span class="token punctuation">(</span>@simplewebauthn_browser.js?v<span class="token operator">=</span>db6ca826:278:14<span class="token punctuation">)</span>    at startAuthentication <span class="token punctuation">(</span>@simplewebauthn_browser.js?v<span class="token operator">=</span>db6ca826:325:11<span class="token punctuation">)</span>    Caused by: DOMException: The relying party ID is not a registrable domain suffix of, nor equal to the current domain.</code></pre><p>RP 서버에 대한 아이디는 WebAuthn 표준에 따라 반드시 도메인으로 구성되어야합니다. 그렇지 않은 경우 위와 같이 클라이언트 오류가 발생할 수 있습니다.</p><h5 id="RelyingParty-generateChallenge"><a href="#RelyingParty-generateChallenge" class="headerlink" title="RelyingParty.generateChallenge"></a>RelyingParty.generateChallenge</h5><p>RelyingParty의 startRegistartion 를 통해 패스키 등록에 대한 챌린지와 공개키 생성 옵션을 클라이언트에게 제공할 수 있는데 이때 포함되는 챌린지는 RelyingParty에 32바이트로 구성된 난수로 이루어진 바이트 배열로 구현되어있습니다.</p><pre class="language-java" data-language="java"><div class="caption"><span>RelyingParty.java</span></div><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">SecureRandom</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ByteArray</span> <span class="token function">generateChallenge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    random<span class="token punctuation">.</span><span class="token function">nextBytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ByteArray</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="패스키-등록을-위한-생성-옵션-발급"><a href="#패스키-등록을-위한-생성-옵션-발급" class="headerlink" title="패스키 등록을 위한 생성 옵션 발급"></a>패스키 등록을 위한 생성 옵션 발급</h4><p>RelyingParty의 startRegistration 매개변수에 StartRegistrationOptions를 전달함으로써 패스키 등록 시 사용될 챌린지와 생성 옵션인 PublicKeyCredentialCreationOptions를 만들 수 있습니다. PublicKeyCredentialCreationOptions의 toCredentialsCreateJson 함수는 RP 서버에서 클라이언트로 응답할 때 바이트 배열로 이루어져야하는 항목에 대해 Base64URL을 적용한 JSON으로 구성되도록 구현되어있으므로 쉽게 응답할 수 있습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">createUserHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchAlgorithmException</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> userHandle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token class-name">SecureRandom</span><span class="token punctuation">.</span><span class="token function">getInstanceStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextBytes</span><span class="token punctuation">(</span>userHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> userHandle<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/registration/challenge"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">startRegistration</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> httpSession<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">UserIdentity</span> userIdentity <span class="token operator">=</span> <span class="token class-name">UserIdentity</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"mambo"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">displayName</span><span class="token punctuation">(</span><span class="token string">"Mambo"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArray</span><span class="token punctuation">(</span><span class="token function">createUserHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">PublicKeyCredentialCreationOptions</span> publicKeyCredentialCreationOptions <span class="token operator">=</span> rp<span class="token punctuation">.</span><span class="token function">startRegistration</span><span class="token punctuation">(</span>                <span class="token class-name">StartRegistrationOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>userIdentity<span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">authenticatorSelection</span><span class="token punctuation">(</span><span class="token class-name">AuthenticatorSelectionCriteria</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                <span class="token punctuation">.</span><span class="token function">residentKey</span><span class="token punctuation">(</span><span class="token class-name">ResidentKeyRequirement</span><span class="token punctuation">.</span><span class="token constant">REQUIRED</span><span class="token punctuation">)</span>                                <span class="token punctuation">.</span><span class="token function">authenticatorAttachment</span><span class="token punctuation">(</span><span class="token class-name">AuthenticatorAttachment</span><span class="token punctuation">.</span><span class="token constant">CROSS_PLATFORM</span><span class="token punctuation">)</span>                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpSession<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"publicKeyCredentialCreationOptions"</span><span class="token punctuation">,</span> publicKeyCredentialCreationOptions<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> publicKeyCredentialCreationOptions<span class="token punctuation">.</span><span class="token function">toCredentialsCreateJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>UserIdentity의 id는 공개키 인증 정보에 포함되는 User Handle과 동일합니다. 패스키 표준에서는 사용자 계정에 대한 식별자를 그대로 이용하지 않고 별도로 난수로 이루어진 식별자를 사용하도록 요구하고 있습니다. 사용자 계정에 대해 유일한 식별자로 생성하는 로직을 구현하도록 하세요.</p></blockquote><h5 id="simplewebauthn-browser-startRegistration"><a href="#simplewebauthn-browser-startRegistration" class="headerlink" title="@simplewebauthn&#x2F;browser.startRegistration"></a>@simplewebauthn&#x2F;browser.startRegistration</h5><p>클라이언트에서는 아래와 같이 패스키 등록을 위해 챌린지를 요청하고 받은 결과를 startRegistartion의 매개변수에 전달함으로써 사용자에게 패스키 등록에 대한 대화상자를 표시해주고 전달받은 결과를 서버에 전달함으로써 패스키 등록을 완료하는 로직을 구현할 수 있습니다. 아래의 코드는 이미 등록된 패스키에 대한 오류에 대한 예외 처리가 없으므로 여러가지 예외 상황을 확인하고 알맞게 처리하도록 구현해야합니다.</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">registerPasskey</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> challenge  <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/registration/challenge'</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> registrationResponse <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">startRegistration</span><span class="token punctuation">(</span>challenge<span class="token punctuation">.</span>data<span class="token punctuation">.</span>publicKey<span class="token punctuation">)</span>    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/registration/verify'</span><span class="token punctuation">,</span> registrationResponse<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></code></pre><h4 id="패스키-검증-및-등록"><a href="#패스키-검증-및-등록" class="headerlink" title="패스키 검증 및 등록"></a>패스키 검증 및 등록</h4><p>Relying Party의 finishRegistartion 함수를 통해 클라이언트에서 전달한 패스키 정보가 올바르게 서명되어있는지를 검증하고 전달받은 정보에서 일부 항목을 패스키에 대한 데이터베이스에 저장하면 됩니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/registration/verify"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">finishRegistration</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> httpSession<span class="token punctuation">,</span>                                  <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">String</span> credential<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RegistrationFailedException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> credentialsCreateJson <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> httpSession<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"publicKeyCredentialCreationOptions"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpSession<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">"publicKeyCredentialCreationOptions"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">PublicKeyCredentialCreationOptions</span> publicKeyCredentialCreationOptions <span class="token operator">=</span>            <span class="token class-name">PublicKeyCredentialCreationOptions</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>credentialsCreateJson<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">PublicKeyCredential</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthenticatorAttestationResponse</span><span class="token punctuation">,</span> <span class="token class-name">ClientRegistrationExtensionOutputs</span><span class="token punctuation">></span></span> publicKeyCredential <span class="token operator">=</span>            <span class="token class-name">PublicKeyCredential</span><span class="token punctuation">.</span><span class="token function">parseRegistrationResponseJson</span><span class="token punctuation">(</span>credential<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">RegistrationResult</span> result <span class="token operator">=</span> relyingParty<span class="token punctuation">.</span><span class="token function">finishRegistration</span><span class="token punctuation">(</span>            <span class="token class-name">FinishRegistrationOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>publicKeyCredentialCreationOptions<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span>publicKeyCredential<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ByteArray</span> aaguid <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getAaguid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ByteArray</span> credentialId <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getKeyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ByteArray</span> userHandle <span class="token operator">=</span> publicKeyCredentialCreationOptions<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ByteArray</span> publicKey <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getPublicKeyCose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transports <span class="token operator">=</span> publicKeyCredential<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransports</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">AuthenticatorTransport</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> signatureCounter <span class="token operator">=</span> publicKeyCredential<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttestation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthenticatorData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSignatureCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Authenticator</span> authenticator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Authenticator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setCredentialId</span><span class="token punctuation">(</span>credentialId<span class="token punctuation">.</span><span class="token function">getBase64Url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setUserHandle</span><span class="token punctuation">(</span>userHandle<span class="token punctuation">.</span><span class="token function">getBase64Url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setAaguid</span><span class="token punctuation">(</span>aaguid<span class="token punctuation">.</span><span class="token function">getBase64Url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setPublicKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">.</span><span class="token function">getBase64Url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setSignatureCount</span><span class="token punctuation">(</span>signatureCounter<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setTransports</span><span class="token punctuation">(</span>transports<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setLastAccessTime</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setCreatedAt</span><span class="token punctuation">(</span><span class="token class-name">OffsetDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> authenticatorRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>authenticator<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h5 id="계정-설정-내-패스키-표시"><a href="#계정-설정-내-패스키-표시" class="headerlink" title="계정 설정 내 패스키 표시"></a>계정 설정 내 패스키 표시</h5><p>패스키 등록 시 서버에 저장된 정보에는 사용자 친화적으로 표시할 수 있는 정보가 포함되어있지 않습니다. <a href="https://developers.google.com/identity/passkeys/ux/communicating-passkeys?hl=ko#what_information_to_use_to_create_a_passkey">패스키를 만드는 데 사용할 정보</a>나 <a href="https://developers.google.com/identity/passkeys/ux/user-interface-design?hl=ko">계정 설정 내 패스키 카드 표시</a>와 같은 정보들을 참고하여 패스키에 대해 아래와 같은 항목이 포함되도록 설계하는 것이 좋습니다.</p><ul><li>패스키에 대해 표시할 이름 (Nickname)</li><li>패스키가 마지막으로 사용된 시간 (Last Access Time)</li><li>패스키 인증 기기 유형 (AAGUID)</li></ul><p>패스키에 대해 표시할 이름을 설정하는 건 필수 사항은 아니지만 깃허브에서의 패스키 관리 시 이름을 설정할 수 있게 제공하는데 사용자 스스로 구분할 수 있게 지원해줄 수 있는 것 같습니다. 패스키 인증 기기 정보의 경우 AttestedCredentialData에 포함된 AAGUID를 통해 인증 기기를 제공하는 업체을 식별할 수 있는데 AAGUID는 일반적으로 사람이 인지할 수 있는 문자열은 아니므로 AAGUID 저장소의 <a href="https://github.com/passkeydeveloper/passkey-authenticator-aaguids/blob/main/aaguid.json">aaguid.json</a> 인증 장치의 유형에 대해서 이름이나 아이콘을 표시할 수 있기도 합니다.</p><h5 id="등록된-패스키-삭제"><a href="#등록된-패스키-삭제" class="headerlink" title="등록된 패스키 삭제"></a>등록된 패스키 삭제</h5><p><img data-src="/images/posts/passkey-login/01.png"></p><p>위 화면은 깃허브에서 사용자 계정에 등록했던 패스키를 삭제하려고 했을때 제공되는 메시지입니다. 패스키 관리 시 등록한 패스키를 삭제하면 되겠지만 고려해야할 부분이 있습니다. 서버에 등록된 패스키를 삭제한다고해서 사용자가 사용했던 인증 기기의 패스키 등록 정보는 삭제되지 않는다는 것입니다. 또한, 사용자가 인증 기기의 패스키를 삭제해버리는 경우 사용자 계정에 등록된 패스키는 무용지물이 되며 불필요하게 패스키 등록 정보로 남아있게 되어버립니다.</p><p>패스키 등록을 지원하는 인증 기기별로 자세한 패스키 삭제 가이드를 제공할 순 없으므로 사용자 계정에서 패스키를 삭제하더라도 패스키 로그인 시에는 패스키 옵션으로 표시될 수 있음을 알려주고 있는 것 같습니다. 다음은 자주 사용될만한 인증 기기에서의 패스키 삭제 방법이므로 참고해보세요.</p><ul><li>Google Passsword Manager: 브라우저 URL에 <a href="chrome://settings/passkeys">chrome:&#x2F;&#x2F;settings&#x2F;passkeys</a> 입력</li><li>iCloud Keychain: <a href="https://support.apple.com/ko-kr/guide/mac-help/mchl77e2cb66/mac">Mac 및 iCloud 키체인에서 패스키 또는 암호 제거하기</a></li><li>Chrome Profile: <a href="https://support.google.com/chrome/answer/13168025?hl=ko">Chrome에서 패스키 관리하기</a></li><li>Samsung Pass: Samsung Wallet → Samsung Pass → 로그인 정보 → 패스키</li></ul><h4 id="패스키-인증-요청에-대한-옵션-발급"><a href="#패스키-인증-요청에-대한-옵션-발급" class="headerlink" title="패스키 인증 요청에 대한 옵션 발급"></a>패스키 인증 요청에 대한 옵션 발급</h4><p>Relying Party의 startAssertion 함수를 통해 사용자 계쩡에 등록된 패스키에 대해 로그인할 수 있도록 챌린지를 발급할 수 있습니다. 이때, 매개변수로 전달할 StartAssertionOptions을 구성할 때 클라이언트는 사용자가 입력한 아이디를 요청 시 제공한다면 특정 사용자 계정에 대한 공개키만 조회하여 포함시킬 수 있습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/authentication/challenge"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">startAssertion</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> httpSession<span class="token punctuation">,</span>                             <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">StartAssertionOptions<span class="token punctuation">.</span>StartAssertionOptionsBuilder</span> builder <span class="token operator">=</span> <span class="token class-name">StartAssertionOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMinutes</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>username<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        builder<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">AssertionRequest</span> assertionRequest <span class="token operator">=</span> relyingParty<span class="token punctuation">.</span><span class="token function">startAssertion</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpSession<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"assertionRequest"</span><span class="token punctuation">,</span> assertionRequest<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> assertionRequest<span class="token punctuation">.</span><span class="token function">toCredentialsGetJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h5 id="패스키-검증-및-인증"><a href="#패스키-검증-및-인증" class="headerlink" title="패스키 검증 및 인증"></a>패스키 검증 및 인증</h5><p>Relying Party의 finishAssertion 함수를 통해 클라이언트에서 전달한 패스키 인증 정보를 신뢰할 수 있는지 확인할 수 있습니다. 인증 정보에 포함된 credentailId와 userHandle을 토대로 사용자 계정에 대해 로그인을 처리하면 됩니다.</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> startAuthentication <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@simplewebauthn/browser'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">passkeyLogin</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> challenge  <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/authentication/challenge'</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> authenticationResponse <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">startAuthentication</span><span class="token punctuation">(</span>challenge<span class="token punctuation">.</span>data<span class="token punctuation">.</span>publicKey<span class="token punctuation">)</span>    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/authentication/verify'</span><span class="token punctuation">,</span> authenticationResponse<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/authentication/verify"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">finishAssertion</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> httpSession<span class="token punctuation">,</span>                              <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">String</span> credential<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">AssertionFailedException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> assertionRequestJson <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> httpSession<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"assertionRequest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">AssertionRequest</span> assertionRequest <span class="token operator">=</span> <span class="token class-name">AssertionRequest</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>assertionRequestJson<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">PublicKeyCredential</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthenticatorAssertionResponse</span><span class="token punctuation">,</span> <span class="token class-name">ClientAssertionExtensionOutputs</span><span class="token punctuation">></span></span> publicKeyCredential            <span class="token operator">=</span> <span class="token class-name">PublicKeyCredential</span><span class="token punctuation">.</span><span class="token function">parseAssertionResponseJson</span><span class="token punctuation">(</span>credential<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">AssertionResult</span> result <span class="token operator">=</span> relyingParty<span class="token punctuation">.</span><span class="token function">finishAssertion</span><span class="token punctuation">(</span><span class="token class-name">FinishAssertionOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>assertionRequest<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span>publicKeyCredential<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// todo: process authenticate</span>        <span class="token class-name">String</span> username <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ByteArray</span> credentialId <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getCredential</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCredentialId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ByteArray</span> userHandle <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getCredential</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h5 id="사용자-아이디-필드에-자동-완성-UI-표시"><a href="#사용자-아이디-필드에-자동-완성-UI-표시" class="headerlink" title="사용자 아이디 필드에 자동 완성 UI 표시"></a>사용자 아이디 필드에 자동 완성 UI 표시</h5><p>패스키 인증을 위해 startAuthentication를 호출할 때 useBrowserAutofill 매개변수를 설정하는 경우 mediation 옵션이 conditional로 지정되면서 사용자에게 바로 패스키 선택을 요구하는 대화상자를 표시하지 않고 브라우저마다 구현된 방식으로 자동 완성(조건부 UI)이 표시됩니다. 패스키 자동 완성을 위해 호출했다면 사용자 계정을 입력하는 필드의 autocomplete 속성에 webauthn 을 포함시키면 됩니다.</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Login.vue</span><span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">await</span> <span class="token function">processAutofill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">// passkey.js</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span>browserSupportsWebAuthnAutofill<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@simplewebauthn/browser'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">processAutofill</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">browserSupportsWebAuthnAutofill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> challenge <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/authentication/challenge'</span><span class="token punctuation">)</span>        <span class="token keyword">const</span> authenticationResponse <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">startAuthentication</span><span class="token punctuation">(</span>challenge<span class="token punctuation">.</span>data<span class="token punctuation">.</span>publicKey<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/authentication/verify'</span><span class="token punctuation">,</span> authenticationResponse<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>조건부 UI로 사용자에게 자동 완성을 제공할 때 패스키에 대한 프로미스가 계속 대기하는 상태로 진행하고 있는데요. 기존에 진행중인 패스키를 취소할 수 있도록 SimpleWebAuthn의 startAuthentication은 내부적으로 구현되어있으므로 신경 쓸 필요는 없습니다.</p></blockquote><hr><p>본 글을 작성하기 위해서 아래와 같은 정보들을 참고했습니다.</p><ul><li><a href="https://webauthn.io/">WebAuthn.io 데모 사이트</a></li><li><a href="https://webauthn.guide/">WebAuthn 가이드</a></li><li><a href="https://passkeys.dev/device-support/">Passkeys Device Support</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Authentication_API">WebAuthn: Web Authentication API</a></li><li><a href="https://webauthn.wtf/">What is WebAuthn?</a></li><li><a href="https://passkeys.dev/docs/intro/what-are-passkeys/">What are passkeys?</a></li><li><a href="https://webauthn.me/passkeys">Web Authentication and Passkeys</a></li><li><a href="https://www.corbado.com/assets/Passkeys-Developer-Cheatsheet.pdf">Passkeys Cheet Sheet</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;패스키 로그인은 사용자 계정에 대한 비밀번호를 입력하지 않고 사용자 계정에 대해 지문이나 얼굴 인식 그리고 보안키 등을 사용해서 미리 인증 정보를 등록해놓고 사용자의 인증 기기를 사용해서 로그인을 수행하도록 제공하는 걸 말합니다. 패스키는 로그인</summary>
      
    
    
    
    
    <category term="Passkey" scheme="https://kdevkr.github.io/tags/Passkey/"/>
    
    <category term="WebAuthn" scheme="https://kdevkr.github.io/tags/WebAuthn/"/>
    
  </entry>
  
  <entry>
    <title>Amazon SNS - FCM 모바일 푸시</title>
    <link href="https://kdevkr.github.io/amazon-sns-fcm-mobile-push/"/>
    <id>https://kdevkr.github.io/amazon-sns-fcm-mobile-push/</id>
    <published>2024-07-07T09:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.490Z</updated>
    
    <content type="html"><![CDATA[<p>PWA 앱에서 푸시 알림을 위해 FCM(Firebse Cloud Messaging)을 도입했다면 Amazon SNS의 모바일 푸시 알림으로 통합할 수 있다. Firebase Admin SDK 로도 쉽게 푸시 알림을 위한 메시지를 전송할 수 있지만 Amazon SNS에 등록된 플랫폼 애플리케이션을 통해 사용자 디바이스를 애플리케이션 앤드포인트로 관리하고 우리는 Amazon SNS에 등록된 플랫폼 엔드포인트를 통해 디바이스로 푸시 알림을 전달해보도록 하자.</p><h4 id="플랫폼-애플리케이션-생성-시-FCM-자격-증명-등록"><a href="#플랫폼-애플리케이션-생성-시-FCM-자격-증명-등록" class="headerlink" title="플랫폼 애플리케이션 생성 시 FCM 자격 증명 등록"></a>플랫폼 애플리케이션 생성 시 FCM 자격 증명 등록</h4><p><img data-src="/images/posts/amazon-sns-fcm-mobile-push/01.png"></p><p>FCM 푸시 알림 플랫픔을 사용하는 애플리케이션 생성 시 FCM 콘솔의 서비스 계정에서 발급받은 Firebase 서비스 계정의 비공개 키 정보를 등록해야 한다. Firebase Admin SDK 에서 사용중이었던 서비스 계정의 JSON 파일을 그대로 설정했다.</p><h4 id="애플리케이션-앤드포인트-생성-시-FCM-디바이스-토큰-등록"><a href="#애플리케이션-앤드포인트-생성-시-FCM-디바이스-토큰-등록" class="headerlink" title="애플리케이션 앤드포인트 생성 시 FCM 디바이스 토큰 등록"></a>애플리케이션 앤드포인트 생성 시 FCM 디바이스 토큰 등록</h4><p>플랫폼 애플리케이션에서 메시지를 전달할 엔드포인트는 하나의 식별할 수 있는 디바이스라고 생각하면 된다. 디바이스 토큰은 <a href="https://firebase.google.com/docs/cloud-messaging/js/client?hl=ko#access_the_registration_token">FCM 클라이언트 SDK로부터 디바이스 내에서 발급받은 토큰</a>을 입력하면 된다. 애플리케이션 엔드포인트 생성 후 메시지 게시를 통해 샘플 메시지를 전달해볼 수 있다.</p><pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"GCM"</span><span class="token operator">:</span> <span class="token string">"&#123; \"data\": &#123; \"title\": \"Hi!\", \"body\": \"Mambo?!\" &#125; &#125;"</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>Amazon SNS의 모바일 푸시 알림에서 FCM을 위한 메시지는 GCM 이라는 키로 사용합니다.</p></blockquote><p><img data-src="/images/posts/amazon-sns-fcm-mobile-push/02.png"></p><h4 id="Amazon-SNS-SDK-for-Java-V2로-메시지-게시"><a href="#Amazon-SNS-SDK-for-Java-V2로-메시지-게시" class="headerlink" title="Amazon SNS SDK for Java V2로 메시지 게시"></a>Amazon SNS SDK for Java V2로 메시지 게시</h4><p>웹 콘솔을 통해 FCM 메시지가 디바이스로 푸시 알림이 되었음을 확인했다면 Amazon SDK for Java v2를 사용해서 프로그래밍 방식으로 메시지를 전송해보도록 하자. 먼저, 아래와 같이 모바일 푸시 API를 사용하기 위한 Amazon SDK for Java v2 의존성을 추가하도록 하자.</p><pre class="language-groovy" data-language="groovy"><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    implementation <span class="token function">platform</span><span class="token punctuation">(</span><span class="token string">'software.amazon.awssdk:bom:2.26.16'</span><span class="token punctuation">)</span>    implementation <span class="token string">'software.amazon.awssdk:sns'</span><span class="token punctuation">&#125;</span></code></pre><p>의존성을 추가했다면 <a href="https://docs.aws.amazon.com/ko_kr/sns/latest/dg/mobile-push-api.html">모바일 푸시 API</a> 중 CreatePlatformEndpoint와 Publish를 사용해서 메시지를 게시하는 샘플 코드를 만들어볼 수 있다. </p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SnsClient</span> snsClient <span class="token operator">=</span> <span class="token class-name">SnsClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">credentialsProvider</span><span class="token punctuation">(</span><span class="token class-name">ProfileCredentialsProvider</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">region</span><span class="token punctuation">(</span><span class="token class-name">Region</span><span class="token punctuation">.</span><span class="token constant">AP_NORTHEAST_2</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertDoesNotThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            <span class="token class-name">String</span> platformApplicationArn <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> fcmDeviceToken <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> endpointArn <span class="token operator">=</span> snsClient<span class="token punctuation">.</span><span class="token function">createPlatformEndpoint</span><span class="token punctuation">(</span><span class="token class-name">CreatePlatformEndpointRequest</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">platformApplicationArn</span><span class="token punctuation">(</span>platformApplicationArn<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span>fcmDeviceToken<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endpointArn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> fcmMessage <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token string">"Hi!"</span><span class="token punctuation">,</span> <span class="token string">"body"</span><span class="token punctuation">,</span> <span class="token string">"Mambo?!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> messageId <span class="token operator">=</span> snsClient<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token class-name">PublishRequest</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">messageStructure</span><span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"GCM"</span><span class="token punctuation">,</span> fcmMessage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">targetArn</span><span class="token punctuation">(</span>endpointArn<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">messageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"messageId: &#123;&#125;"</span><span class="token punctuation">,</span> messageId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span>messageId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>위 예제코드에서 메시지의 GCM 이 이스케이프된 JSON 문자열로 구성되어야함을 주의해야합니다.</p></blockquote><p><img data-src="/images/posts/amazon-sns-fcm-mobile-push/03.png" alt="PWA 앱에서의 푸시 알림 예시"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;PWA 앱에서 푸시 알림을 위해 FCM(Firebse Cloud Messaging)을 도입했다면 Amazon SNS의 모바일 푸시 알림으로 통합할 수 있다. Firebase Admin SDK 로도 쉽게 푸시 알림을 위한 메시지를 전송할 수 있지만</summary>
      
    
    
    
    
    <category term="FCM" scheme="https://kdevkr.github.io/tags/FCM/"/>
    
    <category term="SNS Mobile Push" scheme="https://kdevkr.github.io/tags/SNS-Mobile-Push/"/>
    
  </entry>
  
  <entry>
    <title>PWA 와 FCM 푸시 알림</title>
    <link href="https://kdevkr.github.io/pwa-fcm-web-push/"/>
    <id>https://kdevkr.github.io/pwa-fcm-web-push/</id>
    <published>2024-07-06T04:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.498Z</updated>
    
    <content type="html"><![CDATA[<h4 id="PWA의-서비스-워커는-HTTPS를-요구"><a href="#PWA의-서비스-워커는-HTTPS를-요구" class="headerlink" title="PWA의 서비스 워커는 HTTPS를 요구"></a>PWA의 서비스 워커는 HTTPS를 요구</h4><p>PWA 앱에서 푸시 알림을 보내기 위해서는 사용자가 사이트 또는 앱에 대한 알림 권한을 허용해야하며 PWA 앱이 종료되어있어도 백그라운드 상태에서 동작하는 서비스 워커가 필요하다. Vite 기반으로 구성되어있는 프로젝트에서는 <a href="https://vite-pwa-org.netlify.app/">PWA Plugin for Vite</a>로 쉽게 PWA 설치 지원과 함께 서비스 워커를 등록할 수 있게 설정할 수 있다. 서비스 워커는 HTTPS 에서 동작해야하므로 개발 환경에서는 <a href="https://github.com/liuweiGL/vite-plugin-mkcert">vite-plugin-mkcert</a>가 도움이 될 수 있다.</p><h4 id="서비스-워커의-상태-변경을-고려하기"><a href="#서비스-워커의-상태-변경을-고려하기" class="headerlink" title="서비스 워커의 상태 변경을 고려하기"></a>서비스 워커의 상태 변경을 고려하기</h4><p>서비스 워커의 생명 주기를 이해하고 새로 설치되거나 업데이트되는 서비스 워커로 인해 메시지 수신이 원활하지 않을 수 있다는 점을 인지해야한다. <a href="https://developer.mozilla.org/ko/docs/Web/API/ServiceWorkerGlobalScope/skipWaiting">ServiceWorkerGlobalScope.skipWaiting</a> 이나 <a href="https://developer.mozilla.org/ko/docs/Web/API/Clients/claim">Clients::claim()</a>이 도움이 될 수도 있다.</p><h5 id="서비스-워커-파일이-firebase-messaging-sw-js-일-필요는-없다"><a href="#서비스-워커-파일이-firebase-messaging-sw-js-일-필요는-없다" class="headerlink" title="서비스 워커 파일이 firebase-messaging-sw.js 일 필요는 없다"></a>서비스 워커 파일이 firebase-messaging-sw.js 일 필요는 없다</h5><pre class="language-javascript" data-language="javascript"><div class="caption"><span>main.js</span></div><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>        <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MODE</span> <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">?</span> <span class="token string">'/sw.js'</span> <span class="token operator">:</span> <span class="token string">'/dev-sw.js?dev-sw'</span><span class="token punctuation">,</span>        <span class="token punctuation">&#123;</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MODE</span> <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">?</span> <span class="token string">'classic'</span> <span class="token operator">:</span> <span class="token string">'module'</span><span class="token punctuation">&#125;</span>    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">registration</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'register service worker'</span><span class="token punctuation">,</span> registration<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></code></pre><p>FCM 관련 일부 글에서 서비스 워커의 파일이 반드시 <code>firebase-messaing-sw.js</code> 이어야 한다고 언급하는데 잘못된 정보에 해당되며 FCM 메시지 수신을 위해서 PWA 앱에서 사용중인 <code>서비스 워커 내에 Firebase SDK를 초기화</code>하는게 중요한 부분이다. 위 코드와 같이 개발 환경에서는 <a href="https://vite-pwa-org.netlify.app/guide/development#injectmanifest-strategy">dev-sw.js</a>를 서비스 워커로 등록하여 사용할 수 있음을 보여준다.</p><h4 id="FCM-푸시-알림이-여러번-표시되는-문제-🔥"><a href="#FCM-푸시-알림이-여러번-표시되는-문제-🔥" class="headerlink" title="FCM 푸시 알림이 여러번 표시되는 문제 🔥"></a>FCM 푸시 알림이 여러번 표시되는 문제 🔥</h4><p><a href="https://github.com/kdevkr/mambo-box/blob/main/errors/2024-07-06.md">PWA 앱의 푸시 알림에서 FCM 메시지가 여러번 표시되는 문제</a>와 같이 백그라운드 상태에 있는 PWA 앱에서 푸시 알림이 여러번 표시되는 이유는 <a href="https://firebase.google.com/docs/cloud-messaging/js/receive?hl=ko">자바스크립트 클라이언트에서 메시지 수신</a>시 알림 메시지에 의한 기본 화면 표시에 대해 고려하지 않은 문제에 해당된다. 자바스크립트 클라이언트에서 커스텀 메시지로 푸시 알림을 제공하고 싶다면 서버에서는 알림 메시지가 포함되지 않은 데이터 메시지로 구성하여 전달해야한다.</p><h4 id="자바스크립트-클라이언트-API-키는-안전하다"><a href="#자바스크립트-클라이언트-API-키는-안전하다" class="headerlink" title="자바스크립트 클라이언트 API 키는 안전하다"></a>자바스크립트 클라이언트 API 키는 안전하다</h4><p>일반적으로 자바스크립트로 동작하는 SDK에 대한 키는 외부에 노출될 수 밖에 없으므로 FCM 메시지를 수신할 수 있는 최소한의 권한을 보유한다. FCM 콘솔에서 <a href="https://developer.chrome.com/blog/web-push-interop-wins?hl=ko#introducing_vapid_for_server_identification">웹 푸시 인증서</a>는 <code>최대 2개까지 발급</code>할 수 있으므로 <code>VAPID</code>를 환경별로 나누어서 사용하는 것도 좋아보인다. 더 자세한 내용은 <a href="https://firebase.google.com/docs/projects/api-keys?hl=ko">Firebase용 API 키 사용 및 관리에 대해 알아보기</a>를 참고하여 고려해보도록 하자.</p><h4 id="시스템-규모에-따른-토큰-관리-전략"><a href="#시스템-규모에-따른-토큰-관리-전략" class="headerlink" title="시스템 규모에 따른 토큰 관리 전략"></a>시스템 규모에 따른 토큰 관리 전략</h4><p><a href="https://firebase.google.com/docs/cloud-messaging/manage-tokens?hl=ko">FCM 등록 토큰 관리를 위한 권장사항</a>과 <a href="https://firebase.google.com/docs/cloud-messaging/scale-fcm?hl=ko">FCM 메시지를 대규모로 전송할 때의 권장사항</a>를 참고하여 시스템에 저장되어 메시지 전송 시 사용되는 토큰의 수를 관리하는게 필요하다. 서버에서는 사용자가 PWA 앱을 삭제하는지를 감지하여 더이상 토큰이 사용되지 않는지 알 수 없다. FCM 메시지 전송 시 무제한으로 발송할 수는 없으므로 오랫동안 사용되지 않거나 만료된 토큰은 주기적으로 삭제하는 작업이 있어야한다.</p><h4 id="iOS의-PWA-앱-지원-여부"><a href="#iOS의-PWA-앱-지원-여부" class="headerlink" title="iOS의 PWA 앱 지원 여부"></a>iOS의 PWA 앱 지원 여부</h4><p>안드로이드와 크롬 브라우저와 달리 iOS 또는 사파리 브라우저에 따라 PWA 앱 설치 및 푸시 API를 지원하는지의 여부가 다름을 인지해야한다. 또한, 홈 화면으로 추가되는 앱은 반드시 기본으로 제공되는 사파리 브라우저로 실행되는 것도 중요한 부분에 해당된다.</p><ul><li><a href="https://developer.apple.com/documentation/usernotifications/sending-web-push-notifications-in-web-apps-and-browsers">Safari 16.1 and macOS 16.4 iOS &amp; iPadOS 부터 Push API 지원</a></li><li><a href="https://developer.apple.com/support/dma-and-apps-in-the-eu/">유럽 연합의 국가에서 iOS 17.4 이상에서 PWA 지원 종료</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;PWA의-서비스-워커는-HTTPS를-요구&quot;&gt;&lt;a href=&quot;#PWA의-서비스-워커는-HTTPS를-요구&quot; class=&quot;headerlink&quot; title=&quot;PWA의 서비스 워커는 HTTPS를 요구&quot;&gt;&lt;/a&gt;PWA의 서비스 워커는 HTTPS를 </summary>
      
    
    
    
    
    <category term="FCM" scheme="https://kdevkr.github.io/tags/FCM/"/>
    
    <category term="PWA" scheme="https://kdevkr.github.io/tags/PWA/"/>
    
  </entry>
  
  <entry>
    <title>HAProxy</title>
    <link href="https://kdevkr.github.io/haproxy/"/>
    <id>https://kdevkr.github.io/haproxy/</id>
    <published>2024-06-29T06:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.494Z</updated>
    
    <content type="html"><![CDATA[<p>일반적으로 애플리케이션 서버에 대한 HTTP 프록시는 엔진엑스(Nginx)를 많이 사용하고 있지만 L4 레벨의 <code>TCP 프록시</code>가 필요한 경우 stream 모듈을 별도로 설치해야하는 과정이 필요하므로 <code>HAProxy</code>가 더 좋은 선택일 수 있다. 사내 개발 환경에서 연결할 수 있는 배스천 호스트에 HAProxy를 구성하고 프라이빗 네트워크 환경으로 구성되어있는 테스트 환경의 TCP 통신이 필요한 인스턴스에 연결할 수 있도록 <code>포트 포워딩</code>을 구성해보도록 하자.</p><h4 id="TCP-프록시"><a href="#TCP-프록시" class="headerlink" title="TCP 프록시"></a>TCP 프록시</h4><p><a href="https://www.haproxy.com/documentation/haproxy-configuration-tutorials/load-balancing/tcp/">TCP 프록시</a>는 TCP 연결에 대한 리버스 프록시에 해당된다. 일반적으로 TCP 연결을 수행해야하는 인스턴스에는 Redis 또는 PostgreSQL이 있는데 현재 조직에서 활용하고 있는 시계열 데이터베이스인 <a href="https://kx.com/products/kdb/">KDB+</a>에 대해 프록시를 구성해보려고 한다. 다음은 KDB에서 사용해야하는 포트 범위를 수신하도록 설정한 예시이다.</p><pre class="language-cfg" data-language="cfg"><div class="caption"><span>haproxy.cfg</span></div><code class="language-cfg">listen kdb_proxy_for_dev    mode tcp    bind *:5010-5013    server kdb_dev 192.168.149.88</code></pre><h4 id="HAProxy-구성-테스트"><a href="#HAProxy-구성-테스트" class="headerlink" title="HAProxy 구성 테스트"></a>HAProxy 구성 테스트</h4><p>현재 설정 파일에 문법적인 문제가 없는지 <code>check mode(-c)</code> 옵션을 사용해서 현재 설정에 대해 검증을 수행해볼 수 있다.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>ec2-user@ip-192-169-14-62 ~<span class="token punctuation">]</span>$ haproxy <span class="token parameter variable">-c</span> <span class="token parameter variable">-f</span> /etc/haproxy/haproxy.cfgConfiguration <span class="token function">file</span> is valid</code></pre><h4 id="TCP-프록시-테스트"><a href="#TCP-프록시-테스트" class="headerlink" title="TCP 프록시 테스트"></a>TCP 프록시 테스트</h4><p>NetCat(nc) 명령어를 사용해서 HAProxy에서 수신하고 있는 포트를 통해 테스트 환경에 실행된 인스턴스에 연결할 수 있는지 테스트를 해보자.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>ec2-user@ip-192-169-14-62 ~<span class="token punctuation">]</span>$ <span class="token function">nc</span> <span class="token parameter variable">-znv</span> <span class="token number">127.0</span>.0.1 <span class="token number">5013</span>Ncat: Version <span class="token number">7.50</span> <span class="token punctuation">(</span> https://nmap.org/ncat <span class="token punctuation">)</span>Ncat: Connected to <span class="token number">127.0</span>.0.1:5013.Ncat: <span class="token number">0</span> bytes sent, <span class="token number">0</span> bytes received <span class="token keyword">in</span> <span class="token number">0.01</span> seconds.</code></pre><blockquote><p>배스천 호스트에 TCP 프록시를 구성하기 전까지는 배스천 호스트에 대한 SSH 터널링을 필요할때마다 수행해야 했습니다.<br>기본적으로 SSH 터널링을 구성하는게 일반적이지만 보안 수준을 검토하고 TCP 프록시를 구성해보도록 하세요.</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;일반적으로 애플리케이션 서버에 대한 HTTP 프록시는 엔진엑스(Nginx)를 많이 사용하고 있지만 L4 레벨의 &lt;code&gt;TCP 프록시&lt;/code&gt;가 필요한 경우 stream 모듈을 별도로 설치해야하는 과정이 필요하므로 &lt;code&gt;HAProxy&lt;</summary>
      
    
    
    
    
    <category term="HAProxy" scheme="https://kdevkr.github.io/tags/HAProxy/"/>
    
    <category term="TCP Proxy" scheme="https://kdevkr.github.io/tags/TCP-Proxy/"/>
    
  </entry>
  
  <entry>
    <title>Spring AI + Ollama</title>
    <link href="https://kdevkr.github.io/spring-ai-with-ollama/"/>
    <id>https://kdevkr.github.io/spring-ai-with-ollama/</id>
    <published>2024-06-28T14:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.498Z</updated>
    
    <content type="html"><![CDATA[<p>Spring AI 프로젝트에서 OpenAI의 ChatGPT 또는 Anthropic의 Claude를 지원하지만 로컬 머신에서 실행할 수 있는 Ollama도 지원하고 있다.<br>내 컴퓨터에 Ollama를 설치하고 파라미터가 작은 모델을 선택해서 간단하게 AI 엔지니어링을 해보도록 하려고 한다. </p><h4 id="윈도우-Ollama-설치"><a href="#윈도우-Ollama-설치" class="headerlink" title="윈도우 Ollama 설치"></a>윈도우 Ollama 설치</h4><p><a href="https://ollama.com/download/windows">Download for Windows (Preview)</a>를 통해 윈도우 컴퓨터에 Ollama를 설치하고 사용가능한 <a href="https://ollama.com/library">모델</a> 중에서 파라미터가 작은 모델 중 하나인 <a href="https://ollama.com/library/phi3">phi3</a>를 선택해보자.<br>일반적인 예시에서는 <a href="https://ollama.com/library/mistral">mistral</a>를 설치해서 사용해보는 것 같다. 아무튼, <code>ollama run phi3</code> 명령어로 모델을 설치할 수 있다.</p><pre class="language-ps" data-language="ps"><code class="language-ps">PS C:\Users\Mambo\ollama&gt; ollama run phi3pulling manifestpulling b26e6713dc74... 100% ▕████████████████████████████████████████████████████████▏ 2.4 GBpulling fa8235e5b48f... 100% ▕████████████████████████████████████████████████████████▏ 1.1 KBpulling 542b217f179c... 100% ▕████████████████████████████████████████████████████████▏  148 Bpulling 8dde1baf1db0... 100% ▕████████████████████████████████████████████████████████▏   78 Bpulling f91db7a2deb9... 100% ▕████████████████████████████████████████████████████████▏  485 Bverifying sha256 digestwriting manifestremoving any unused layerssuccess</code></pre><h4 id="Open-WebUI-설치"><a href="#Open-WebUI-설치" class="headerlink" title="Open WebUI 설치"></a>Open WebUI 설치</h4><p>Spring AI와는 상관없지만 ChatGPT와 같은 AI 서비스처럼 Ollama와 연동이 가능한 <a href="https://openwebui.com/">Open WebUI</a>를 설치해보았다. </p><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token key atrule">open-webui</span><span class="token punctuation">:</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/open<span class="token punctuation">-</span>webui/open<span class="token punctuation">-</span>webui<span class="token punctuation">:</span>main    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> open<span class="token punctuation">-</span>webui    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"3000:8080"</span>    <span class="token key atrule">environment</span><span class="token punctuation">:</span>      <span class="token key atrule">OLLAMA_BASE_URL</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//host.docker.internal<span class="token punctuation">:</span><span class="token number">11434</span>      <span class="token key atrule">WEBUI_AUTH</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> open<span class="token punctuation">-</span>webui<span class="token punctuation">:</span>/app/backend/data    <span class="token key atrule">extra_hosts</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> host.docker.internal<span class="token punctuation">:</span>host<span class="token punctuation">-</span>gateway    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped<span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token key atrule">open-webui</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>저는 컴퓨터 호스트에 Ollama를 설치하고 실행하였기에 host.docker.internal로 접근했습니다.<br>Ollama를 도커 컴포즈로 실행하기 위한 설정은 <a href="https://github.com/open-webui/open-webui/blob/main/docker-compose.yaml">docker-compose.yaml</a>를 참고하세요.</p></blockquote><h4 id="Spring-AI-Ollama-Chat"><a href="#Spring-AI-Ollama-Chat" class="headerlink" title="Spring AI Ollama Chat"></a>Spring AI Ollama Chat</h4><p><a href="https://docs.spring.io/spring-ai/reference/api/chat/ollama-chat.html">OllamaChatModel</a></p><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">repositories <span class="token punctuation">&#123;</span>    maven <span class="token punctuation">&#123;</span> url <span class="token string">'https://repo.spring.io/milestone'</span> <span class="token punctuation">&#125;</span>    maven <span class="token punctuation">&#123;</span> url <span class="token string">'https://repo.spring.io/snapshot'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>dependencies <span class="token punctuation">&#123;</span>    implementation <span class="token string">'org.springframework.ai:spring-ai-ollama-spring-boot-starter'</span><span class="token punctuation">&#125;</span>dependencyManagement <span class="token punctuation">&#123;</span>    imports <span class="token punctuation">&#123;</span>        mavenBom <span class="token interpolation-string"><span class="token string">"de.codecentric:spring-boot-admin-dependencies:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">springBootAdminVersion</span></span><span class="token string">"</span></span>        mavenBom <span class="token interpolation-string"><span class="token string">"org.springframework.ai:spring-ai-bom:1.0.0-M1"</span></span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-yaml" data-language="yaml"><div class="caption"><span>application.yml</span></div><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">ai</span><span class="token punctuation">:</span>    <span class="token key atrule">ollama</span><span class="token punctuation">:</span>      <span class="token key atrule">base-url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">11434</span>      <span class="token key atrule">chat</span><span class="token punctuation">:</span>        <span class="token key atrule">options</span><span class="token punctuation">:</span>          <span class="token key atrule">model</span><span class="token punctuation">:</span> phi3          <span class="token key atrule">temperature</span><span class="token punctuation">:</span> <span class="token number">0.9</span>    <span class="token key atrule">retry</span><span class="token punctuation">:</span>      <span class="token key atrule">max-attempts</span><span class="token punctuation">:</span> <span class="token number">1</span></code></pre><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RequiredArgsConstructor</span><span class="token annotation punctuation">@RestController</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatApi</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TEMPLATE</span> <span class="token operator">=</span> <span class="token triple-quoted-string string">"""            Hello ai, How many hours does &#123;timezone&#125; differ by UTC?.            """</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">OllamaChatModel</span> chatModel<span class="token punctuation">;</span>    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/ai/generate"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">String</span> timezone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">PromptTemplate</span> promptTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PromptTemplate</span><span class="token punctuation">(</span><span class="token constant">TEMPLATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        promptTemplate<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"timezone"</span><span class="token punctuation">,</span> timezone<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> chatModel<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>promptTemplate<span class="token punctuation">.</span><span class="token function">createMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-txt" data-language="txt"><div class="caption"><span>AI Response</span></div><code class="language-txt">Seoul, South Korea operates on Korea Standard Time (KST), which is 9 hours ahead of Coordinated Universal Time (UTC+9). Therefore, the difference between UTC and KST in Seoul is 9 hours.To calculate this for any specific time:- If you're looking to convert a time from UTC to KST, add 9 hours.- If you're converting a time from KST back to UTC, subtract 9 hours.</code></pre><p>결제가 필요한 ChatGPT와 Claude API 대신에 로컬 머신에 Ollama를 설치하고 Spring AI를 간단하게 다루어보았다.<br>개인적으로 AI에 대한 인식은 아직 <strong>설레발</strong>이라고 생각이 되지만 AI가 성장할수록 <a href="https://www.promptingguide.ai/kr">프롬프트 엔지니어링</a>도 개발자에게 필요한 역량이 되어갈 수 있어서 준비가 필요하다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Spring AI 프로젝트에서 OpenAI의 ChatGPT 또는 Anthropic의 Claude를 지원하지만 로컬 머신에서 실행할 수 있는 Ollama도 지원하고 있다.&lt;br&gt;내 컴퓨터에 Ollama를 설치하고 파라미터가 작은 모델을 선택해서 간</summary>
      
    
    
    
    
    <category term="spring ai" scheme="https://kdevkr.github.io/tags/spring-ai/"/>
    
    <category term="ollama" scheme="https://kdevkr.github.io/tags/ollama/"/>
    
  </entry>
  
  <entry>
    <title>AWS EC2 인스턴스 메타데이터</title>
    <link href="https://kdevkr.github.io/aws-ec2-instance-metadata/"/>
    <id>https://kdevkr.github.io/aws-ec2-instance-metadata/</id>
    <published>2024-06-25T13:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.490Z</updated>
    
    <content type="html"><![CDATA[<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># IMDSv1</span><span class="token function">curl</span> http://169.254.169.254/latest/dynamic/instance-identity/document<span class="token comment"># IMDSv2</span><span class="token assign-left variable">TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">curl</span> <span class="token parameter variable">-H</span> <span class="token string">"X-aws-ec2-metadata-token-ttl-seconds: 21600"</span><span class="token variable">`</span></span> <span class="token parameter variable">-X</span> PUT <span class="token string">"http://169.254.169.254/latest/api/token"</span> <span class="token function">curl</span> <span class="token parameter variable">-H</span> <span class="token string">"X-aws-ec2-metadata-token: <span class="token variable">$TOKEN</span>"</span> http://169.254.169.254/latest/dynamic/instance-identity/document<span class="token punctuation">&#123;</span>    <span class="token string">"accountId"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,    <span class="token string">"architecture"</span><span class="token builtin class-name">:</span> <span class="token string">"arm64"</span>,    <span class="token string">"availabilityZone"</span><span class="token builtin class-name">:</span> <span class="token string">"ap-northeast-2c"</span>,    <span class="token string">"billingProducts"</span><span class="token builtin class-name">:</span> null,    <span class="token string">"devpayProductCodes"</span><span class="token builtin class-name">:</span> null,    <span class="token string">"marketplaceProductCodes"</span><span class="token builtin class-name">:</span> null,    <span class="token string">"imageId"</span><span class="token builtin class-name">:</span> <span class="token string">"ami-0331a5c9d849893dc"</span>,    <span class="token string">"instanceId"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,    <span class="token string">"instanceType"</span><span class="token builtin class-name">:</span> <span class="token string">"c6g.xlarge"</span>,    <span class="token string">"kernelId"</span><span class="token builtin class-name">:</span> null,    <span class="token string">"pendingTime"</span><span class="token builtin class-name">:</span> <span class="token string">"2024-06-23T01:01:23Z"</span>,    <span class="token string">"privateIp"</span><span class="token builtin class-name">:</span> <span class="token string">"192.169.44.196"</span>,    <span class="token string">"ramdiskId"</span><span class="token builtin class-name">:</span> null,    <span class="token string">"region"</span><span class="token builtin class-name">:</span> <span class="token string">"ap-northeast-2"</span>,    <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token string">"2017-09-30"</span><span class="token punctuation">&#125;</span></code></pre><p><a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html">인스턴스 메타데이터 검색</a>을 활용해서 동적 데이터의 <a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/instance-identity-documents.html">인스턴스 자격 증명 문서(instance-identity&#x2F;document)</a>를 가져오는 예시이다. 이번 글에서는 <code>AWS SDK for Java</code> 라이브러리에서 제공하는 <code>EC2 메타데이터 유틸리티</code>를 통해 AWS EC2 인스턴스에서 실행중인 애플리케이션 서버에서 EC2 인스턴스 정보를 조회할 수 있도록 작성해보려고 한다. 스프링 부트 기반의 애플리케이션이라면 스프링 부트 액추에이터의 <a href="https://docs.spring.io/spring-boot/reference/actuator/endpoints.html#actuator.endpoints.info">InfoContributor</a> 인터페이스를 구현한 <code>EC2MetadataInfoContributor</code>를 만들어보자.</p><h4 id="EC2MetadataInfoContributor-with-SDK-for-Java-1-x"><a href="#EC2MetadataInfoContributor-with-SDK-for-Java-1-x" class="headerlink" title="EC2MetadataInfoContributor with SDK for Java 1.x"></a>EC2MetadataInfoContributor with SDK for Java 1.x</h4><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    <span class="token comment">// the AWS SDK for Java v1.x will enter maintenance mode on July 31, 2024, and reach end-of-support on December 31, 2025.</span>    implementation <span class="token function">platform</span><span class="token punctuation">(</span><span class="token string">'com.amazonaws:aws-java-sdk-bom:1.12.748'</span><span class="token punctuation">)</span>    implementation <span class="token string">'com.amazonaws:aws-java-sdk-ec2'</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><div class="caption"><span>EC2MetadataInfoContributor.java</span></div><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>amazonaws<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">EC2MetadataUtils</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>actuate<span class="token punctuation">.</span>info<span class="token punctuation">.</span></span><span class="token class-name">Info</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>actuate<span class="token punctuation">.</span>info<span class="token punctuation">.</span></span><span class="token class-name">InfoContributor</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EC2MetadataInfoContributor</span> <span class="token keyword">implements</span> <span class="token class-name">InfoContributor</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isRunningAwsEC2<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">EC2MetadataInfoContributor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        isRunningAwsEC2 <span class="token operator">=</span> <span class="token class-name">EC2MetadataUtils</span><span class="token punctuation">.</span><span class="token function">getInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contribute</span><span class="token punctuation">(</span><span class="token class-name">Info<span class="token punctuation">.</span>Builder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isRunningAwsEC2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">EC2MetadataUtils<span class="token punctuation">.</span>InstanceInfo</span> instanceInfo <span class="token operator">=</span> <span class="token class-name">EC2MetadataUtils</span><span class="token punctuation">.</span><span class="token function">getInstanceInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            builder<span class="token punctuation">.</span><span class="token function">withDetail</span><span class="token punctuation">(</span><span class="token string">"ec2"</span><span class="token punctuation">,</span> instanceInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="EC2MetadataInfoContributor-with-SDK-for-Java-2-x"><a href="#EC2MetadataInfoContributor-with-SDK-for-Java-2-x" class="headerlink" title="EC2MetadataInfoContributor with SDK for Java 2.x"></a>EC2MetadataInfoContributor with SDK for Java 2.x</h4><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    implementation <span class="token function">platform</span><span class="token punctuation">(</span><span class="token string">'software.amazon.awssdk:bom:2.21.4'</span><span class="token punctuation">)</span>    implementation <span class="token string">'software.amazon.awssdk:imds'</span>    implementation <span class="token string">'software.amazon.awssdk:url-connection-client'</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><div class="caption"><span>EC2MetadataInfoContributorV2.java</span></div><code class="language-java">mport <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>actuate<span class="token punctuation">.</span>info<span class="token punctuation">.</span></span>Info</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>actuate<span class="token punctuation">.</span>info<span class="token punctuation">.</span></span><span class="token class-name">InfoContributor</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">software<span class="token punctuation">.</span>amazon<span class="token punctuation">.</span>awssdk<span class="token punctuation">.</span>core<span class="token punctuation">.</span>document<span class="token punctuation">.</span></span><span class="token class-name">Document</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">software<span class="token punctuation">.</span>amazon<span class="token punctuation">.</span>awssdk<span class="token punctuation">.</span>imds<span class="token punctuation">.</span></span><span class="token class-name">Ec2MetadataClient</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">software<span class="token punctuation">.</span>amazon<span class="token punctuation">.</span>awssdk<span class="token punctuation">.</span>imds<span class="token punctuation">.</span></span><span class="token class-name">Ec2MetadataResponse</span></span><span class="token punctuation">;</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EC2MetadataInfoContributorV2</span> <span class="token keyword">implements</span> <span class="token class-name">InfoContributor</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> isRunningAwsEC2<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">EC2MetadataInfoContributorV2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Ec2MetadataClient</span> client <span class="token operator">=</span> <span class="token class-name">Ec2MetadataClient</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            isRunningAwsEC2 <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/latest/meta-data/instance-id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// ignored</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contribute</span><span class="token punctuation">(</span><span class="token class-name">Info<span class="token punctuation">.</span>Builder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isRunningAwsEC2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Ec2MetadataClient</span> client <span class="token operator">=</span> <span class="token class-name">Ec2MetadataClient</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">Ec2MetadataResponse</span> metadataResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/latest/dynamic/instance-identity/document"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">Document</span> document <span class="token operator">=</span> metadataResponse<span class="token punctuation">.</span><span class="token function">asDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                builder<span class="token punctuation">.</span><span class="token function">withDetail</span><span class="token punctuation">(</span><span class="token string">"ec2"</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">asMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// ignored</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="인스턴스-메타데이터-검색"><a href="#인스턴스-메타데이터-검색" class="headerlink" title="인스턴스 메타데이터 검색"></a>인스턴스 메타데이터 검색</h4><ol><li>SDK 버전에 따라 <a href="https://docs.aws.amazon.com/ko_kr/sdk-for-java/latest/developer-guide/migration-imds.html#migration-imds-behavior-endpoint-res">SDK가 엔드포인트를 IMDS로 확인하기 위해 확인하는 위치</a>가 다르다.</li><li><a href="https://docs.aws.amazon.com/ko_kr/sdk-for-java/latest/developer-guide/migration-imds.html#migration-imds-behavior-imdsv2">Java 2.x는 IMDSv2만 지원</a>하지만 Java 1.x는 IMDSv2 를 사용할 수 없을때 IMDSv1 으로도 조회한다.</li><li>Java 2.x는 <a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/instancedata-data-categories.html">인스턴스 메타데이터 카테고리</a>를 직접 명시해야한다.</li><li>Java 1.x는 2025년 12월 31일 <a href="https://aws.amazon.com/ko/blogs/developer/announcing-end-of-support-for-aws-sdk-for-java-v1-x-on-december-31-2025/">지원 종료(End of support)</a>된다.</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;pre class=&quot;language-bash&quot; data-language=&quot;bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# IMDSv1&lt;/span&gt;
&lt;span class=&quot;token f</summary>
      
    
    
    
    
    <category term="IMDSv1" scheme="https://kdevkr.github.io/tags/IMDSv1/"/>
    
    <category term="IMDSv2" scheme="https://kdevkr.github.io/tags/IMDSv2/"/>
    
  </entry>
  
  <entry>
    <title>스프링 부트 메일 헬스체크 캐시하기</title>
    <link href="https://kdevkr.github.io/spring-boot-mail-health-check/"/>
    <id>https://kdevkr.github.io/spring-boot-mail-health-check/</id>
    <published>2024-06-23T02:00:00.000Z</published>
    <updated>2024-09-06T15:12:02.498Z</updated>
    
    <content type="html"><![CDATA[<p>토스의 <a href="https://toss.tech/article/how-to-work-health-check-in-spring-boot-actuator">Spring Boot Actuator의 헬스체크 살펴보기</a>라는 글을 보고 스프링 부트 액추에이터에서 기본으로 제공하는 MailHealthIndiator의 헬스 체크 결과를 별도로 요청하는 경우 <code>management.endpoint.health.cache-time-to-live</code> 속성으로 캐시되지 않음을 확인했다. 해당 속성은 전체 헬스 체크 결과를 반환하는 헬스 엔드포인트(&#x2F;actuator&#x2F;health)에 해당하는 캐시 옵션으로 메일에 대한 헬스 엔드포인트(&#x2F;actuator&#x2F;health&#x2F;mail)에 대해서는 적용되지 않는다.</p><p>스프링 부트 액추에이터의 <a href="https://github.com/spring-projects/spring-boot/blob/main/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/mail/MailHealthIndicator.java">MailHealthIndicator</a> 는 JavaMailSenderImpl의 testConnection 함수를 호출하여 헬스 체크 결과를 반환하도록 작성되어있다. MailHealthIndicator라는 이름으로 HealthIIndicator를 구현하면 기본적으로 제공하는 MailHealthIndicator 대신에 등록되므로 SMTP 서버로의 연결 수행 결과를 캐시하여 응답하도록 작성해볼 수 있다.</p><h4 id="CachableMailHealthIndicator"><a href="#CachableMailHealthIndicator" class="headerlink" title="CachableMailHealthIndicator"></a>CachableMailHealthIndicator</h4><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">Cache</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">CacheBuilder</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span><span class="token class-name">InitializingBean</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>actuate<span class="token punctuation">.</span>health<span class="token punctuation">.</span></span><span class="token class-name">Health</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>actuate<span class="token punctuation">.</span>mail<span class="token punctuation">.</span></span><span class="token class-name">MailHealthIndicator</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>mail<span class="token punctuation">.</span>javamail<span class="token punctuation">.</span></span><span class="token class-name">JavaMailSenderImpl</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Instant</span></span><span class="token punctuation">;</span><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"mailHealthIndicator"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CachableMailHealthIndicator</span> <span class="token keyword">extends</span> <span class="token class-name">MailHealthIndicator</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Health</span><span class="token punctuation">></span></span> cache<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">CachableMailHealthIndicator</span><span class="token punctuation">(</span><span class="token class-name">JavaMailSenderImpl</span> javaMailSender<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>javaMailSender<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doHealthCheck</span><span class="token punctuation">(</span><span class="token class-name">Health<span class="token punctuation">.</span>Builder</span> builder<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Health</span> cached <span class="token operator">=</span> cache <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> cache<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span><span class="token string">"mail"</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            builder<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>cached<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withDetails</span><span class="token punctuation">(</span>cached<span class="token punctuation">.</span><span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">doHealthCheck</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            builder<span class="token punctuation">.</span><span class="token function">down</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Health</span> health <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">withDetail</span><span class="token punctuation">(</span><span class="token string">"datetime"</span><span class="token punctuation">,</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mail"</span><span class="token punctuation">,</span> health<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        cache <span class="token operator">=</span> <span class="token class-name">CacheBuilder</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p><img data-src="/images/posts/spring-boot-mail-health-check/01.png" alt="268ms → 4ms"></p><blockquote><p>CacheableMailHealthIndicator는 호스트 정보 뿐만 아니라 <strong>캐시된 시간</strong>을 포함하여 언제 측정된 결과인지도 확인할 수 있습니다.</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;토스의 &lt;a href=&quot;https://toss.tech/article/how-to-work-health-check-in-spring-boot-actuator&quot;&gt;Spring Boot Actuator의 헬스체크 살펴보기&lt;/a&gt;라는 글을 보고 스프링 </summary>
      
    
    
    
    
    <category term="Spring Boot Actuator" scheme="https://kdevkr.github.io/tags/Spring-Boot-Actuator/"/>
    
    <category term="MailHealthIndicator" scheme="https://kdevkr.github.io/tags/MailHealthIndicator/"/>
    
  </entry>
  
</feed>
