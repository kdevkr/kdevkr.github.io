<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Mambo</title>
  
  <subtitle>Today I Learned 🔥</subtitle>
  <link href="https://kdevkr.github.io/atom.xml" rel="self"/>
  
  <link href="https://kdevkr.github.io/"/>
  <updated>2024-10-14T14:25:59.464Z</updated>
  <id>https://kdevkr.github.io/</id>
  
  <author>
    <name>Mambo</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>OpenFeign 도입을 고민해보자</title>
    <link href="https://kdevkr.github.io/open-feign/"/>
    <id>https://kdevkr.github.io/open-feign/</id>
    <published>2024-10-14T14:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.464Z</updated>
    
    <content type="html"><![CDATA[<p>마이크로서비스 개발에 있어서 OpenFeign 활용에 대한 부분이 아닌 작은 모놀리식으로 구성된 소규모 시스템에서도 <code>Apache HttpClient</code>를 직접적으로 사용하지 않고 어노테이션과 인터페이스 기반의 선언적으로 통신에 대한 로직을 작성하는 것을 고민하게 되는 부분을 적어보고자 한다.</p><h4 id="통신-로직에-대한-반복적인-코드-작성"><a href="#통신-로직에-대한-반복적인-코드-작성" class="headerlink" title="통신 로직에 대한 반복적인 코드 작성"></a>통신 로직에 대한 반복적인 코드 작성</h4><p>RestTemplate와 HttpClient를 직접적으로 사용하여 통신에 대한 코드를 작성하는 경우 URI 구성과 쿼리 파라미터 그리고 폼 데이터 또는 요청 데이터 그리고 응답 결과에 대한 데이터 처리까지 아래와 같은 부분들이 강제화 되어버리는 경우가 많은 것 같다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">LoginEntity</span> login <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>통신해야하는 시스템에서 제공하는 REST API 규격에 따라 쿼리 파라미터 또는 요청 데이터를 직접 구성해야하고 전달받은 응답에 대하여 위와 같이 직접적으로 원하는 모델 클래스로 변환하는 코드를 작성해야만 한다. 이것은 스프링 백엔드 개발자가 Spring MVC의 컨트롤러를 작성하는 것과는 다른데 <a href="https://github.com/OpenFeign/feign">OpenFeign</a> 클라이언트는 <code>선언적인(Declarative) 방식을 통해 이러한 과정을 간소화</code>하고 Spring MVC와 비슷한 방식으로 작성됨에 따라서 시스템 간 연동을 위한 통신 로직을 작성하고 관리하기 용이한 장점을 가지고 있는 것 같다.</p><h4 id="의존-시스템에-대한-장애-처리-부족"><a href="#의존-시스템에-대한-장애-처리-부족" class="headerlink" title="의존 시스템에 대한 장애 처리 부족"></a>의존 시스템에 대한 장애 처리 부족</h4><p>마이크로서비스 구성이 아닌 일반적인 소규모 시스템에서 RestTemplate와 HttpClient를 직접적으로 사용하다보면 <code>시스템 간 통신에 대한 오류와 재시도 방안에 대한 고민을 하지 않고 무시하게 되는 경우</code>가 많다. OpenFeign은 마이크로서비스 개발에 사용되어지는 만큼 마이크로서비스에서 중요시하게 되는 장애 전파 방지에 대한 부분을 고려할 수 있다.</p><h4 id="마이크로서비스-구성-확장에-대한-고려"><a href="#마이크로서비스-구성-확장에-대한-고려" class="headerlink" title="마이크로서비스 구성 확장에 대한 고려"></a>마이크로서비스 구성 확장에 대한 고려</h4><p>모놀리식 아키텍처로 구성되는 소규모 시스템도 현재 시스템 규모와 요구사항을 넘어 대규모 트래픽 또는 데이터를 처리하기 위한 시스템으로 확장되는 것을 목표로 하는 경우가 대부분이다. 현재 신규 프로젝트도 마이크로서비스 구성을 목표로 초기 설계가 되어있음에 따라 Spring Cloud 모듈에 대한 의존성을 보유하고 있다. Spring Cloud OpenFeign 로 작성되어있는 경우 <code>서비스 디스커버리를 위한 Eureka와 장애 처리를 위한 Resilience4J 과의 통합이 용이하다</code>고 한다.</p><p>이와 같이 마이크로서비스 아키텍처가 아니더라도 외부 시스템 또는 시스템 간 통신이 많은 시스템의 프로젝트라면 OpenFeign 클라이언트 도입을 고려해볼만하지 않을까? 물론, <a href="https://toss.tech/article/engineering-note-3">Feign 코드 분석과 서버 성능 개선</a> 에서처럼 문제가 내재되지 않는 건 아님을 감안하긴 해야겠지만 말이다.</p><hr><h4 id="🔥-FeignClient-에서-GET-대신에-POST-요청이-되는-이유"><a href="#🔥-FeignClient-에서-GET-대신에-POST-요청이-되는-이유" class="headerlink" title="🔥 FeignClient 에서 GET 대신에 POST 요청이 되는 이유"></a>🔥 FeignClient 에서 GET 대신에 POST 요청이 되는 이유</h4><p>FeignClient에 대한 간단한 예제 코드를 작성해보던 중에 GET 요청이 POST로 전환되어 요청되는 문제를 경험했다. GET 요청 시 쿼리 파라미터를 전달하기 위해서는 <code>@SpringQueryMap를 해당 파라미터에 선언해야</code>하더라. 쿼리 파라미터가 전달되지 않는 경우가 아닌 선언된 요청 함수가 바뀌어버리는 건 신기한 부분이다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;마이크로서비스 개발에 있어서 OpenFeign 활용에 대한 부분이 아닌 작은 모놀리식으로 구성된 소규모 시스템에서도 &lt;code&gt;Apache HttpClient&lt;/code&gt;를 직접적으로 사용하지 않고 어노테이션과 인터페이스 기반의 선언적으로 통신에</summary>
      
    
    
    
    
    <category term="OpenFeign" scheme="https://kdevkr.github.io/tags/OpenFeign/"/>
    
    <category term="HttpClient" scheme="https://kdevkr.github.io/tags/HttpClient/"/>
    
    <category term="RestTemplate" scheme="https://kdevkr.github.io/tags/RestTemplate/"/>
    
  </entry>
  
  <entry>
    <title>AWS EC2 볼륨 크기 확장하기</title>
    <link href="https://kdevkr.github.io/aws-ebs-volume-expand/"/>
    <id>https://kdevkr.github.io/aws-ebs-volume-expand/</id>
    <published>2024-10-04T13:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.460Z</updated>
    
    <content type="html"><![CDATA[<p>Amazon Aurora PostgreSQL 처럼 관리형 데이터베이스 서비스를 이용하지 않고 데이터베이스와 같이 대량의 데이터를 저장하기 위한 서버를 EC2 인스턴스에서 직접 운용하는 경우에는 데이터를 저장할 볼륨의 사용량을 모니터링하고 임계치를 넘어서는 경우 디스크 볼륨의 크기를 변경하고 파일 시스템을 확장하여야 한다.</p><p>시계열 데이터를 저장하기 위해 KDB+ 시계열 데이터베이스를 EC2 인스턴스에 직접 설치하여 운용하고 있어 데이터가 저장되는 규모에 따라 볼륨에 대한 모니터링을 주기적으로 수행하고 볼륨 크기를 관리하는 작업을 수행해야 한다. 최근에는 <a href="https://aws.amazon.com/ko/finspace/features/managed-kdb-insights/">Amazon FinSpace를 통해 관리형 KDB Insight를 지원</a>하기는 합니다만 라이센스와 인프라 비용 문제로 관리형 서비스로 전환하여 사용중이지는 않는다.</p><p>아무튼, Amazon EBS의 탄력적 볼륨은 서버에 연결된 볼륨을 해제하거나 EC2 서버를 재시작하지 않고도 변경된 볼륨을 반영할 수 있게 제공해주지만 AWS CLI 또는 웹 콘솔에서 볼륨의 크기를 변경하더라도 리눅스 파일 시스템에서 사용중인 볼륨을 자동으로 확장해주지는 않는다.</p><h4 id="XFS-파일-시스템-확장"><a href="#XFS-파일-시스템-확장" class="headerlink" title="XFS 파일 시스템 확장"></a>XFS 파일 시스템 확장</h4><p>볼륨의 파일 시스템에 따라 xfs_growsfs 또는 resize2fs 명령어를 사용해서 볼륨의 크기만큼 확장할 수 있다. KDB+ 시계열 데이터베이스에서 사용하는 데이터 볼륨을 &#x2F;data 경로로 마운트되어있어 아래와 같이 파일 시스템을 확장할 수 있다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>Terminal</span></div><code class="language-bash"><span class="token function">sudo</span> <span class="token function">df</span> <span class="token parameter variable">-hT</span> /dataFilesystem     Type  Size  Used Avail Use% Mounted on/dev/nvme2n1   xfs   500G  349G  152G  <span class="token number">70</span>% /data<span class="token function">sudo</span> xfs_growfs <span class="token parameter variable">-d</span> /data</code></pre><h4 id="EBS-볼륨-수정-시-주의사항"><a href="#EBS-볼륨-수정-시-주의사항" class="headerlink" title="EBS 볼륨 수정 시 주의사항"></a>EBS 볼륨 수정 시 주의사항</h4><ul><li>볼륨 크기를 변경하고나서 최소한 6시간 이내에 재수정이 불가능하다.</li><li>볼륨 수정 후에도 optimizing 상태와 같은 볼륨 수정 상황을 모니터링 해야한다.</li><li>볼륨을 수정하기 전에 스냅샷을 생성하여 예상하지 못한 상태에 대비하자.</li></ul><hr><p>그동안 볼륨 크기를 변경하고 확장하는 작업이 자주 일어나지 않았으나 시간이 된다면 AWS CLI 또는 Lambda 를 이용하여 볼륨 임계치에 따라 자동으로 볼륨의 크기가 조정되는 방법을 적용해봐도 좋을 것 같다. GPT에 물어보니 대충 아래와 같이 배시 스크립트를 작성할 수 있나보다.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token assign-left variable">INSTANCE_ID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> /var/lib/cloud/data/instance-id<span class="token variable">)</span></span><span class="token assign-left variable">VOLUME_ID</span><span class="token operator">=</span><span class="token string">"vol-xxxxxxxxxxxxx"</span><span class="token assign-left variable">VOLUME_PATH</span><span class="token operator">=</span><span class="token string">"/data"</span><span class="token assign-left variable">USAGE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">df</span> <span class="token parameter variable">-h</span> $VOLUME_PATH <span class="token operator">|</span> <span class="token function">grep</span> / <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123; print $5 &#125;'</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/%//g'</span><span class="token variable">)</span></span><span class="token assign-left variable">THRESHOLD</span><span class="token operator">=</span><span class="token number">80</span> <span class="token comment"># %</span><span class="token assign-left variable">EXPAND_SIZE</span><span class="token operator">=</span><span class="token number">100</span> <span class="token comment"># GB</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$USAGE</span>"</span> <span class="token parameter variable">-gt</span> <span class="token string">"<span class="token variable">$THRESHOLD</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token builtin class-name">echo</span> <span class="token string">"[EBS] USAGE: <span class="token variable">$USAGE</span>"</span>  <span class="token assign-left variable">CURRENT_SIZE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>aws ec2 describe-volumes --volume-ids $VOLUME_ID <span class="token parameter variable">--query</span> <span class="token string">"Volumes[0].Size"</span><span class="token variable">)</span></span>  <span class="token assign-left variable">NEW_SIZE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>$CURRENT_SIZE <span class="token operator">+</span> $EXPAND_SIZE<span class="token variable">))</span></span>  <span class="token builtin class-name">echo</span> <span class="token string">"[EBS] CURRENT: <span class="token variable">$CURRENT_SIZE</span>, NEW: <span class="token variable">$NEW_SIZE</span>"</span>  aws ec2 modify-volume --volume-id <span class="token variable">$VOLUME_ID</span> <span class="token parameter variable">--size</span> <span class="token variable">$NEW_SIZE</span>  <span class="token function">sudo</span> xfs_growfs <span class="token parameter variable">-d</span> <span class="token variable">$VOLUME_PATH</span>  <span class="token builtin class-name">echo</span> <span class="token string">"[EBS] completed"</span><span class="token keyword">fi</span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Amazon Aurora PostgreSQL 처럼 관리형 데이터베이스 서비스를 이용하지 않고 데이터베이스와 같이 대량의 데이터를 저장하기 위한 서버를 EC2 인스턴스에서 직접 운용하는 경우에는 데이터를 저장할 볼륨의 사용량을 모니터링하고 임계치를</summary>
      
    
    
    
    
    <category term="AWS" scheme="https://kdevkr.github.io/tags/AWS/"/>
    
    <category term="Elastic Block Storage" scheme="https://kdevkr.github.io/tags/Elastic-Block-Storage/"/>
    
  </entry>
  
  <entry>
    <title>API Gateway와 SQS로 콜백 결과 처리하기</title>
    <link href="https://kdevkr.github.io/aws-api-gateway-to-sqs/"/>
    <id>https://kdevkr.github.io/aws-api-gateway-to-sqs/</id>
    <published>2024-09-20T11:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.460Z</updated>
    
    <content type="html"><![CDATA[<p>Amazon API Gateway는 REST API를 쉽게 만들 수 있는 서비스로 애플리케이션 서버를 별도로 작성하지 않아도 Lambda 함수 또는 AWS 서비스와 통합할 수 있는 기능을 제공하고 있다. <a href="(https://docs.aws.amazon.com/prescriptive-guidance/latest/patterns/integrate-amazon-api-gateway-with-amazon-sqs-to-handle-asynchronous-rest-apis.html)">Amazon API Gateway와 Amazon SQS 서비스를 사용</a>해 외부 시스템으로부터 전달되는 콜백 결과를 수신하고 SQS 대기열에 메시지로 연동하는 구성을 만들 수 있다. 예를 들어, <a href="https://biztech.gitbook.io/webapi/api/undefined/dispatch-result">Bizppurio API</a>를 통해 카카오 알림톡 메시지를 발송하는 경우 발송 결과를 사전에 등록한 URL로 비동기로 콜백해주는 방식을 제공해주고 있는데 이 발송 결과를 수신하여 비동기 대기열로 등록해두고 애플리케이션 서버에서 스케줄에 의해 처리할 수 있다. 애플리케이션 서버가 발송 결과를 그대로 받는 경우 애플리케이션 서버가 배포되는 과정에서는 일부 발송 결과가 유실될 수 있는 문제를 내재하게 된다.</p><h4 id="Amazon-API-Gateway-REST-API"><a href="#Amazon-API-Gateway-REST-API" class="headerlink" title="Amazon API Gateway REST API"></a>Amazon API Gateway REST API</h4><p><strong>REST API</strong>는 HTTP API와 다르게 <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-method-request-validation.html">요청에 대한 검증</a> 또는 <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-resource-policies.html">리소스 정책에 의한 트래픽 제한</a> 등 여러가지 부분을 설정할 수 있도록 제공하고 있다. 또한, <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/rest-api-data-transformations.html">요청 페이로드를 변환</a>할 수 있으므로 SQS 메시지를 등록하기 위해서는 REST API로 만들어야 한다. 아래와 같이 AWS 서비스 통합으로 <code>Simple Queue Service</code>를 선택하고 <strong>경로 재정의</strong>를 선택하여 SQS 대기열을 입력하면 된다. 실행 역할은 SQS 대기열에 메시지를 보낼 수 있도록 <code>SQS:SendMessage</code> 권한이 포함된 <strong>IAM Role의 ARN</strong>을 입력하면 된다.</p><p><img data-src="/images/posts/aws-api-gateway-to-sqs/02.png"></p><h4 id="Amazon-SQS-대기열에-대한-액세스-정책"><a href="#Amazon-SQS-대기열에-대한-액세스-정책" class="headerlink" title="Amazon SQS 대기열에 대한 액세스 정책"></a>Amazon SQS 대기열에 대한 액세스 정책</h4><p>Amazon API Gateway에 대한 IAM Role에 <strong>AmazonSQSFullAccess</strong> 정책을 연결해도 되지만 아래와 같이 SQS 대기열의 액세스 정책에 IAM Role이 권한을 가지도록 설정할 수 있다. 실행 역할에 입력한 ARN이 SQS 대기열에 대한 권한을 보유하고 있지 않은 경우 <strong>Access Denied</strong> 응답을 받게 된다.</p><p><img data-src="/images/posts/aws-api-gateway-to-sqs/05.png"></p><h4 id="메서드-요청-설정하기-Optional"><a href="#메서드-요청-설정하기-Optional" class="headerlink" title="메서드 요청 설정하기 (Optional)"></a>메서드 요청 설정하기 (Optional)</h4><p>REST API는 메서드 요청 설정을 통해 요청 헤더와 본문에 대한 검증을 수행할 수 있다. 요청 검사기에 <strong>쿼리 문자열 파라미터 및 헤더 검증</strong>을 선택하고 아래와 같이 Content-Type 헤더 유무와 요청 페이로드에 대한 모델 스키마를 만들어서 지정할 수 있다. <a href="https://docs.aws.amazon.com/ko_kr/apigateway/latest/developerguide/models-mappings-models.html">REST API에 대한 데이터 모델</a>은 <strong>JSON 스키마 드래프트 4</strong>로 정의할 수 있다.</p><p><img data-src="/images/posts/aws-api-gateway-to-sqs/01.png"></p><h4 id="통합-요청-설정하기"><a href="#통합-요청-설정하기" class="headerlink" title="통합 요청 설정하기"></a>통합 요청 설정하기</h4><p>REST API의 통합 요청 설정에서는 콜백 결과로 포함되는 요청 페이로드를 SQS 메시지로 전달할 수 있도록 <code>Content-Type: application/x-www-form-urlencoded</code> 로 변경하고 매핑 템플릿에 <strong>SendMessage와 MessageBody</strong>를 구성하여 SQS 메시지로 전달되도록 설정해야한다.</p><p><img data-src="/images/posts/aws-api-gateway-to-sqs/03.png"></p><h4 id="통합-응답-설정하기-Optional"><a href="#통합-응답-설정하기-Optional" class="headerlink" title="통합 응답 설정하기 (Optional)"></a>통합 응답 설정하기 (Optional)</h4><p>통합 응답 설정이 반드시 필요하지는 않지만 <strong>SQS 메시지 등록 시 전달되는 결과를 응답하지 않도록 설정</strong>할 수 있다. 비즈뿌리오에서 알림톡 발송 결과를 콜백으로 전달해줄때 응답 페이로드를 확인하지 않을것이므로 아래와 같이 빈 응답으로 변경할 수 있다. 만약, 빈 응답으로 변경하고 싶다면 통합 응답을 설정하기 이전에 메서드 응답에 <strong>200에 대한 상태 코드를 추가</strong>해야한다.</p><p><img data-src="/images/posts/aws-api-gateway-to-sqs/04.png"></p><hr><h1 id="트러블슈팅-🔥"><a href="#트러블슈팅-🔥" class="headerlink" title="트러블슈팅 🔥"></a>트러블슈팅 🔥</h1><p>Amazon API Gateway와 Amazon SQS 연동 구성 시 발생할 수 있는 오류에 대해서 알아보도록 하자. <a href="https://repost.aws/ko/knowledge-center/api-gateway-rest-api-sqs-errors">REST API를 Amazon SQS와 통합하고 일반적인 오류를 해결하려면 어떻게 해야 하나요?</a>에 일부 오류에 대한 해결 방안이 정리되어있다.</p><h4 id="UnknownOperationException"><a href="#UnknownOperationException" class="headerlink" title="UnknownOperationException"></a>UnknownOperationException</h4><pre class="language-bash" data-language="bash"><code class="language-bash">Thu Sep <span class="token number">19</span> 09:44:10 UTC <span class="token number">2024</span> <span class="token builtin class-name">:</span> Received response. Status: <span class="token number">404</span>, Integration latency: <span class="token number">2</span> msThu Sep <span class="token number">19</span> 09:44:10 UTC <span class="token number">2024</span> <span class="token builtin class-name">:</span> Endpoint response body before transformations: <span class="token operator">&lt;</span>UnknownOperationException/<span class="token operator">></span></code></pre><ul><li>Content-Type 을 application&#x2F;x-www-form-urlencoded 로 입력하지 않은 경우</li><li>매핑 템플릿에 Action&#x3D;SendMessage를 포함하지 않은 경우</li></ul><h4 id="AccessDenied"><a href="#AccessDenied" class="headerlink" title="AccessDenied"></a>AccessDenied</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">&#123;</span><span class="token string">"Error"</span>:<span class="token punctuation">&#123;</span><span class="token string">"Code"</span><span class="token builtin class-name">:</span><span class="token string">"AccessDenied"</span>,<span class="token string">"Message"</span><span class="token builtin class-name">:</span><span class="token string">"Access to the resource https://sqs.ap-northeast-2.amazonaws.com/xxxxxxxx/kakao-at-result is denied."</span>,<span class="token string">"Type"</span><span class="token builtin class-name">:</span><span class="token string">"Sender"</span><span class="token punctuation">&#125;</span>,<span class="token string">"RequestId"</span><span class="token builtin class-name">:</span><span class="token string">"aba6b507-a4c5-512c-a55f-ea625778d5ff"</span><span class="token punctuation">&#125;</span></code></pre><ul><li>실행 역할의 IAM Role이 SQS 대기열에 대한 권한이 없는 경우</li><li>요청 본문에 특수 문자가 포함되어있는데 <code>$util.urlEncode</code> 를 사용하지 않은 경우</li></ul><h4 id="Nginx-에서-API-Gateway-로-트래픽-미러-시-오류"><a href="#Nginx-에서-API-Gateway-로-트래픽-미러-시-오류" class="headerlink" title="Nginx 에서 API Gateway 로 트래픽 미러 시 오류"></a>Nginx 에서 API Gateway 로 트래픽 미러 시 오류</h4><pre class="language-bash" data-language="bash"><code class="language-bash">no resolver defined to resolve xxxxxx.execute-api.ap-northeast-2.amazonaws.comxxxxxx.execute-api.ap-northeast-2.amazonaws.com could not be resolved <span class="token punctuation">(</span><span class="token number">110</span>: Operation timed out<span class="token punctuation">)</span> <span class="token keyword">while</span> sending to client</code></pre><p>Amazon API Gateway 에서 사용자 정의 도메인을 구성하기 이전에 기존에 콜백 결과를 수신하던 것을 API Gateway의 스테이지 URL을 통해 발송 결과를 전달되도록 테스트하기 위해서 <strong>Nginx의 트래픽 미러링을 구성하고자 했을때 도메인을 찾을 수 없는 오류</strong>를 경험했다. 이에 대해서 찾아보니 내부 DNS 가 아닌 클라우드플레어 또는 구글 DNS로 지정하면 해결 가능하다.</p><pre class="language-bash" data-language="bash"><code class="language-bash">location <span class="token operator">=</span> /mirror_api_gw <span class="token punctuation">&#123;</span>  internal<span class="token punctuation">;</span>  resolver <span class="token number">1.1</span>.1.1 <span class="token number">8.8</span>.8.8 <span class="token assign-left variable">valid</span><span class="token operator">=</span>10s<span class="token punctuation">;</span>  proxy_pass https://xxxxxx.execute-api.ap-northeast-2.amazonaws.com/dev<span class="token variable">$request_uri</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Amazon API Gateway는 REST API를 쉽게 만들 수 있는 서비스로 애플리케이션 서버를 별도로 작성하지 않아도 Lambda 함수 또는 AWS 서비스와 통합할 수 있는 기능을 제공하고 있다. &lt;a href=&quot;(https://docs.</summary>
      
    
    
    
    
    <category term="Amazon API Gateway" scheme="https://kdevkr.github.io/tags/Amazon-API-Gateway/"/>
    
    <category term="Amazon SQS" scheme="https://kdevkr.github.io/tags/Amazon-SQS/"/>
    
  </entry>
  
  <entry>
    <title>ParallelStream 과 동시성 문제</title>
    <link href="https://kdevkr.github.io/java-parallel-stream/"/>
    <id>https://kdevkr.github.io/java-parallel-stream/</id>
    <published>2024-09-19T01:30:00.000Z</published>
    <updated>2024-10-14T14:25:59.460Z</updated>
    
    <content type="html"><![CDATA[<p>자바 신입 개발자 면접 질문 중에 멀티스레드와 동시성 문제는 대부분의 회사에서 단골 질문에 해당한다. 조직의 주니어 개발자가 멀티스레드를 고려하지 않고 비즈니스 요구사항을 처리하기 위해 코드를 수정한 결과로 인해 시스템에서 주요 기능 중 하나인 <strong>이벤트 모니터링 화면에서 데이터가 간헐적으로 올바르지 않은 문제가 발생함</strong>이 리포트 되었다.</p><h4 id="동시성-문제가-발생하는-코드"><a href="#동시성-문제가-발생하는-코드" class="headerlink" title="동시성 문제가 발생하는 코드"></a>동시성 문제가 발생하는 코드</h4><p>멀티스레드에 의한 병렬 처리 시 동시성 문제가 발생했던 비즈니스 로직 코드는 대충 아래와 같다고 볼 수 있다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Customer</span><span class="token punctuation">></span></span> customers <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">Customer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> optIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>customers<span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>customer <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    optIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>customer<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// customer 에 대한 데이터 조회 로직</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"expected: 100, size: "</span> <span class="token operator">+</span> optIds<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>위 코드에서 <strong>ArrayList 에 저장되는 목록의 결과가 매번 동일함이 보장이 되는가?</strong> 가 중요한 부분인데 실제로 테스트 코드를 돌려보면 간헐적으로 100개가 아닌 97개가 목록에 포함되는 경우를 확인할 수 있을 것이다. 멀티스레드에 의해서 add 함수가 동시에 호출되는 경우에는 ConcurrentModificationException와 같은 예외가 발생하지 않는게 중요한 부분이다.</p><h4 id="ArrayList-와-HashSet에-대한-동기화-컬렉션"><a href="#ArrayList-와-HashSet에-대한-동기화-컬렉션" class="headerlink" title="ArrayList 와 HashSet에 대한 동기화 컬렉션"></a>ArrayList 와 HashSet에 대한 동기화 컬렉션</h4><p>일반적으로 많이 사용되는 <strong>ArrayList</strong> 과 <strong>HashSet</strong> 에 데이터를 추가할 때 <strong>ParallelStream 을 사용하는 경우</strong> 위와 같이 동시성 문제로 인해 제대로 추가되지 않는 항목이 존재할 수 있다. 이로 인한 동시성 문제를 해결하기 위해서는 아래와 같이 <strong>Synchronized 키워드를 사용하거나 동기화 문제를 고려한</strong> 컬렉션 클래스들이 존재한다.</p><ul><li>ConcurrentSkipListSet</li><li>CopyOnWriteArrayList</li><li>Collections.synchronizedList();</li><li>CopyOnWriteArraySet</li><li>Collections.synchronizedSet();</li><li>ConcurrentHashMap.newKeySet();</li></ul><p>동시성 문제가 발생했던 비즈니스 로직에서 CopyOnWriteArrayList 와 CopyOnWriteArraySet은 쓰기 작업에 대한 오버헤드가 있다는 점을 고려하여 Collections.synchronizedList 를 사용하는 것으로 결정하여 수정하였다.</p><blockquote><p>자바에서 병렬처리 시 동시성을 고려해야하는 것은 기초적인 부분에 해당되어 주니어 개발자에게 아쉬운 부분이긴 하나 이러한 문제를 내재하게 된 가장 큰 원인은 요구사항을 처리한 당시에 개발 리드로써 코드 리뷰를 상세하게 해주지 않았던 것이므로 스스로 반성해야할 부분이라 생각됩니다.</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;자바 신입 개발자 면접 질문 중에 멀티스레드와 동시성 문제는 대부분의 회사에서 단골 질문에 해당한다. 조직의 주니어 개발자가 멀티스레드를 고려하지 않고 비즈니스 요구사항을 처리하기 위해 코드를 수정한 결과로 인해 시스템에서 주요 기능 중 하나인 </summary>
      
    
    
    
    
    <category term="ParallelStream" scheme="https://kdevkr.github.io/tags/ParallelStream/"/>
    
    <category term="ArrayList" scheme="https://kdevkr.github.io/tags/ArrayList/"/>
    
    <category term="HashSet" scheme="https://kdevkr.github.io/tags/HashSet/"/>
    
  </entry>
  
  <entry>
    <title>Apache Kafka KRaft 로컬 설치</title>
    <link href="https://kdevkr.github.io/apache-kafka-kraft-local-setup/"/>
    <id>https://kdevkr.github.io/apache-kafka-kraft-local-setup/</id>
    <published>2024-09-15T14:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.460Z</updated>
    
    <content type="html"><![CDATA[<p>Apache Kafka에 대한 학습을 위해 도커 컴포즈로 카프카에 대한 환경을 구성할 때 대부분 <a href="https://github.com/wurstmeister/kafka-docker">wurstmeister&#x2F;kafka-docker</a> 또는 <a href="https://hub.docker.com/r/confluentinc/cp-kafka/">confluentinc&#x2F;cp-kafka</a> 사용하여 ZooKeeper 기반의 카프카를 실행하는 방법에 대해 설명하는 것을 볼 수 있다. 본 글에서는 컨플루언트에서 제공하는 <a href="https://hub.docker.com/r/confluentinc/confluent-local">confluentinc&#x2F;confluent-local</a>를 사용해 KRaft 모드의 Apache Kafka에 대한 학습 환경을 만드는 것을 공유하고자 한다.</p><h4 id="도커-컴포즈-문서-작성"><a href="#도커-컴포즈-문서-작성" class="headerlink" title="도커 컴포즈 문서 작성"></a>도커 컴포즈 문서 작성</h4><pre class="language-yaml" data-language="yaml"><div class="caption"><span>compose.yaml</span></div><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span><span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token key atrule">kafka</span><span class="token punctuation">:</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> confluentinc/confluent<span class="token punctuation">-</span>local<span class="token punctuation">:</span>7.5.6    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> kafka    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> kafka    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"9092:9092"</span>      <span class="token punctuation">-</span> <span class="token string">"8082:8082"</span>    <span class="token key atrule">environment</span><span class="token punctuation">:</span>      <span class="token key atrule">CLUSTER_ID</span><span class="token punctuation">:</span> <span class="token string">"EaJs_OcfTB6oWCOPTuY64Q"</span>      <span class="token key atrule">KAFKA_NODE_ID</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">KAFKA_PROCESS_ROLES</span><span class="token punctuation">:</span> <span class="token string">"broker,controller"</span>      <span class="token key atrule">KAFKA_CONTROLLER_LISTENER_NAMES</span><span class="token punctuation">:</span> <span class="token string">"CONTROLLER"</span>      <span class="token key atrule">KAFKA_CONTROLLER_QUORUM_VOTERS</span><span class="token punctuation">:</span> <span class="token string">"1@kafka:29093"</span>      <span class="token key atrule">KAFKA_INTER_BROKER_LISTENER_NAME</span><span class="token punctuation">:</span> <span class="token string">"PLAINTEXT"</span>      <span class="token key atrule">KAFKA_LISTENERS</span><span class="token punctuation">:</span> <span class="token string">"PLAINTEXT://kafka:29092,CONTROLLER://kafka:29093,PLAINTEXT_HOST://0.0.0.0:9092"</span>      <span class="token key atrule">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span><span class="token punctuation">:</span> <span class="token string">"CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT"</span>      <span class="token key atrule">KAFKA_ADVERTISED_LISTENERS</span><span class="token punctuation">:</span> <span class="token string">"PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092"</span>      <span class="token key atrule">KAFKA_LOG_DIRS</span><span class="token punctuation">:</span> <span class="token string">"/tmp/kraft-combined-logs"</span>      <span class="token key atrule">KAFKA_REST_HOST_NAME</span><span class="token punctuation">:</span> rest<span class="token punctuation">-</span>proxy      <span class="token key atrule">KAFKA_REST_BOOTSTRAP_SERVERS</span><span class="token punctuation">:</span> <span class="token string">"kafka:29092"</span>      <span class="token key atrule">KAFKA_REST_LISTENERS</span><span class="token punctuation">:</span> <span class="token string">"http://0.0.0.0:8082"</span>  <span class="token key atrule">kafka-ui</span><span class="token punctuation">:</span> <span class="token comment"># Optional</span>    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> kafka<span class="token punctuation">-</span>ui    <span class="token key atrule">image</span><span class="token punctuation">:</span> provectuslabs/kafka<span class="token punctuation">-</span>ui<span class="token punctuation">:</span>latest    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"8080:8080"</span>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> kafka    <span class="token key atrule">environment</span><span class="token punctuation">:</span>      <span class="token key atrule">KAFKA_CLUSTERS_0_NAME</span><span class="token punctuation">:</span> local      <span class="token key atrule">KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS</span><span class="token punctuation">:</span> kafka<span class="token punctuation">:</span><span class="token number">29092</span>      <span class="token key atrule">KAFKA_CLUSTERS_0_AUDIT_TOPICAUDITENABLED</span><span class="token punctuation">:</span> <span class="token string">'true'</span>      <span class="token key atrule">KAFKA_CLUSTERS_0_AUDIT_CONSOLEAUDITENABLED</span><span class="token punctuation">:</span> <span class="token string">'true'</span></code></pre><blockquote><p>confluent-local 이미지는 개발 환경을 위한 것이므로 프로덕션 환경에서는 <a href="https://github.com/confluentinc/cp-all-in-one/blob/7.7.0-post/cp-all-in-one-kraft/docker-compose.yml">cp-all-in-one-kraft</a> 를 참고해서 cp-kafka 로 직접 구성해야합니다.</p></blockquote><h4 id="Kafka-클러스터-아이디"><a href="#Kafka-클러스터-아이디" class="headerlink" title="Kafka 클러스터 아이디"></a>Kafka 클러스터 아이디</h4><p><a href="https://docs.confluent.io/platform/current/kafka-metadata/config-kraft.html#generate-and-format-ids">kafka-storage</a>로 카프카에서 사용할 클러스터 아이디를 만들어야하며 kafka-storage 는 confluent-local 이미지에 포함되어 있어 아래와 같이 명령어를 실행하여 생성할 수 있다. <a href="https://sleeplessbeastie.eu/2021/10/22/how-to-generate-kafka-cluster-id/">How to generate Kafka cluster ID</a> 에서는 kafka-storage 를 사용하지 않고도 Base64로 인코딩된 UUID를 만드는 방법에 대해서 알려주고 있으니 참고하면 좋겠다.</p><pre class="language-bash" data-language="bash"><div class="caption"><span>Terminal</span></div><code class="language-bash"><span class="token comment"># docker run --rm confluentinc/confluent-local:7.5.6 /bin/sh -c "/bin/uuidgen --time | tr -d '-' | base64 | cut -b 1-22"</span><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> confluentinc/confluent-local:7.5.6 /bin/kafka-storage random-uuidEaJs_OcfTB6oWCOPTuY64Q</code></pre><h4 id="참고자료"><a href="#참고자료" class="headerlink" title="참고자료"></a>참고자료</h4><ul><li><a href="https://developer.confluent.io/learn/kraft/">KRaft: Apache Kafka Without ZooKeeper</a></li><li><a href="https://devocean.sk.com/blog/techBoardDetail.do?ID=165711">Apache Kafka의 새로운 협의 프로토콜인 KRaft에 대해</a></li><li><a href="https://aws.amazon.com/ko/about-aws/whats-new/2024/05/amazon-msk-kraft-mode-apache-kafka-clusters/">Amazon MSK, 새로운 Apache Kafka 클러스터를 위한 KRaft 모드 지원</a></li><li><a href="https://sleeplessbeastie.eu/2021/10/22/how-to-generate-kafka-cluster-id/">How to generate Kafka cluster ID</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Apache Kafka에 대한 학습을 위해 도커 컴포즈로 카프카에 대한 환경을 구성할 때 대부분 &lt;a href=&quot;https://github.com/wurstmeister/kafka-docker&quot;&gt;wurstmeister&amp;#x2F;kafka-dock</summary>
      
    
    
    
    
    <category term="Apache Kafka" scheme="https://kdevkr.github.io/tags/Apache-Kafka/"/>
    
    <category term="KRaft" scheme="https://kdevkr.github.io/tags/KRaft/"/>
    
    <category term="Confluent" scheme="https://kdevkr.github.io/tags/Confluent/"/>
    
  </entry>
  
  <entry>
    <title>JPA - Hibernate ObjectMapper</title>
    <link href="https://kdevkr.github.io/jpa-hibernate-object-mapper/"/>
    <id>https://kdevkr.github.io/jpa-hibernate-object-mapper/</id>
    <published>2024-09-10T14:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.460Z</updated>
    
    <content type="html"><![CDATA[<p>현재 조직에서 <strong>JPA 라는 ORM 기술을 활용하고 있지 않지만</strong> 오랜만에 JPA라는 기술을 통해 데이터베이스와 통신해보고 경험하게 된 문제와 해결방법에 대해 공유해보려고 합니다. MySQL 또는 PostgreSQL 에서는 JSON 데이터를 저장하고 처리할 수 있는 함수를 제공하고 있습니다. PostgreSQL에서 JSONB 컬럼의 데이터를 가져오는 과정에서 <strong>모델 클래스에 맞지 않은 필드가 포함될 때 발생할 수 있는 UnrecognizedPropertyException 예외</strong>를 경험했는데요.</p><h4 id="DeserializationFeature-FAIL-ON-UNKNOWN-PROPERTIES"><a href="#DeserializationFeature-FAIL-ON-UNKNOWN-PROPERTIES" class="headerlink" title="DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES"></a>DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES</h4><p>먼저, 스프링 부트 프로젝트에서 자동 구성을 통해 기본적으로 제공하는 ObjectMapper에 대해서 알 수 없는 필드가 포함된 경우 오류로 처리하지 않도록 아래와 같이 다양한 방법으로 설정할 수 있다는 것은 대부분 인지하고 있는 정보라고 생각됩니다.</p><ul><li>@JsonIgnoreProperties(ignoreUnknown &#x3D; true)</li><li>DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES</li><li>spring.jackson.deserialization.fail-on-unknown-properties</li></ul><pre class="language-yaml" data-language="yaml"><div class="caption"><span>application.yml</span></div><code class="language-yaml"><span class="token key atrule">spring.jackson.deserialization.FAIL_ON_UNKNOWN_PROPERTIES</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></code></pre><blockquote><p>현재 조직의 프로젝트에서는 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/http/converter/json/Jackson2ObjectMapperBuilder.html">Jackson2ObjectMapperBuilder</a>를 빈으로 직접 등록하여 커스텀 옵션이 적용된 사용하고 있어요!</p></blockquote><h4 id="JPA-에서는-FAIL-ON-UNKNOWN-PROPERTIES-설정이-적용되지-않음"><a href="#JPA-에서는-FAIL-ON-UNKNOWN-PROPERTIES-설정이-적용되지-않음" class="headerlink" title="JPA 에서는 FAIL_ON_UNKNOWN_PROPERTIES 설정이 적용되지 않음"></a>JPA 에서는 FAIL_ON_UNKNOWN_PROPERTIES 설정이 적용되지 않음</h4><pre class="language-bash" data-language="bash"><code class="language-bash">Caused by: java.lang.IllegalArgumentException: The given string value: <span class="token punctuation">&#123;</span><span class="token string">"active"</span><span class="token builtin class-name">:</span> true, <span class="token string">"mfa_type"</span><span class="token builtin class-name">:</span> <span class="token string">"email"</span><span class="token punctuation">&#125;</span> cannot be transformed to Json object<span class="token punctuation">..</span>. <span class="token number">79</span> common frames omittedCaused by: com.fasterxml.jackson.databind.exc.UnrecognizedPropertyException: Unrecognized field <span class="token string">"mfa_type"</span> <span class="token punctuation">(</span>class kr.kdev.demo.UserEntity<span class="token variable">$Metadata</span><span class="token punctuation">)</span>, not marked as ignorable <span class="token punctuation">(</span>one known property: <span class="token string">"active"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> at <span class="token punctuation">[</span>Source: REDACTED <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span>StreamReadFeature.INCLUDE_SOURCE_IN_LOCATION<span class="token variable">`</span></span> disabled<span class="token punctuation">)</span><span class="token punctuation">;</span> line: <span class="token number">1</span>, column: <span class="token number">31</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>through reference chain: kr.kdev.demo.UserEntity<span class="token variable">$Metadata</span><span class="token punctuation">[</span><span class="token string">"mfa_type"</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre><p>위 오류 메시지는 JPA 에서 <strong>JSONB 컬럼에 올바르지 않은 필드가 포함된 JSON</strong>을 모델 클래스로 변환하는 과정에서 발생한 것 입니다. 앞서, 스프링 부트에서 기본으로 제공하는 ObjectMapper에 FAIL_ON_UNKNOWN_PROPERTIES 를 설정했는데 왜 적용이 안되는걸까요? 그 이유는 JSON 데이터를 처리하기 위해서 적용한 <a href="https://github.com/vladmihalcea/hypersistence-utils">Hypersistence Utils</a>에서 사용하는 <a href="https://github.com/spring-projects/spring-boot/issues/33870">JacksonJsonFormatMapper</a> 에서 스프링 <strong>빈 팩토리에서 관리하는 ObjectMapper 인스턴스가 아니기 때문</strong>입니다.</p><h4 id="PostgreSQL-JSONB-컬럼-매핑-시-ObjectMapper-변경하는-방법"><a href="#PostgreSQL-JSONB-컬럼-매핑-시-ObjectMapper-변경하는-방법" class="headerlink" title="PostgreSQL JSONB 컬럼 매핑 시 ObjectMapper 변경하는 방법"></a>PostgreSQL JSONB 컬럼 매핑 시 ObjectMapper 변경하는 방법</h4><p>JPA 에서 JSON 데이터 처리 시 사용하는 ObjectMapper를 스프링 부트에서 빈으로 관리하는 인스턴스로 변경하려면 아래와 같은 방법들을 활용할 수 있습니다.</p><ul><li><a href="https://github.com/vladmihalcea/hypersistence-utils/issues/304">ObjectMapperWrapper</a></li><li>hibernate.types.jackson.object.mapper + <a href="https://vladmihalcea.com/hibernate-types-customize-jackson-objectmapper/">ObjectMapperSupplier</a></li><li><a href="https://github.com/spring-projects/spring-boot/issues/33870#issuecomment-1386822021">HibernatePropertiesCustomizer</a></li></ul><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span><span class="token keyword">public</span> <span class="token class-name">HibernatePropertiesCustomizer</span> <span class="token function">jsonFormatMapperCustomizer</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>properties<span class="token punctuation">)</span> <span class="token operator">-></span> properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">AvailableSettings</span><span class="token punctuation">.</span><span class="token constant">JSON_FORMAT_MAPPER</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">JacksonJsonFormatMapper</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>저는 스프링 부트 이슈 티켓에서 알려주는 HibernatePropertiesCustomizer로 ObjectMapper를 적용했습니다.</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;현재 조직에서 &lt;strong&gt;JPA 라는 ORM 기술을 활용하고 있지 않지만&lt;/strong&gt; 오랜만에 JPA라는 기술을 통해 데이터베이스와 통신해보고 경험하게 된 문제와 해결방법에 대해 공유해보려고 합니다. MySQL 또는 PostgreSQL 에</summary>
      
    
    
    
    
    <category term="JPA" scheme="https://kdevkr.github.io/tags/JPA/"/>
    
    <category term="Hibernate" scheme="https://kdevkr.github.io/tags/Hibernate/"/>
    
    <category term="Jackson" scheme="https://kdevkr.github.io/tags/Jackson/"/>
    
    <category term="ObjectMapper" scheme="https://kdevkr.github.io/tags/ObjectMapper/"/>
    
  </entry>
  
  <entry>
    <title>JPA - PostgreSQL JSONB</title>
    <link href="https://kdevkr.github.io/jpa-postgresql-jsonb/"/>
    <id>https://kdevkr.github.io/jpa-postgresql-jsonb/</id>
    <published>2024-09-10T13:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.464Z</updated>
    
    <content type="html"><![CDATA[<p>JPA로 <strong>PostgreSQL의 JSONB 컬럼의 JSON 데이터</strong>를 처리하고자 할때 <a href="https://github.com/vladmihalcea/hypersistence-utils">Hypersistance Utils</a>를 적용하여 쉽게 해결할 수 있다.</p><h4 id="Type-JsonType-class"><a href="#Type-JsonType-class" class="headerlink" title="@Type(JsonType.class)"></a>@Type(JsonType.class)</h4><p>공식 문서에 설명되어있는 대로 <strong>JsonType</strong> 과 <strong>JsonBinaryType</strong> 을 사용할 수 있다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Type</span><span class="token punctuation">(</span><span class="token class-name">JsonBinaryType</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> columnDefinition <span class="token operator">=</span> <span class="token string">"jsonb"</span><span class="token punctuation">)</span><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> metadata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>만약, 컬럼에 대한 <strong>columnDefinition</strong>를 지정하지 않으면 아래와 같은 매핑 오류가 발생할 수 있다.</p><pre class="language-bash" data-language="bash"><code class="language-bash">Caused by: org.hibernate.MappingException: Unable to determine SQL <span class="token builtin class-name">type</span> name <span class="token keyword">for</span> <span class="token function">column</span> <span class="token string">'metadata'</span> of table <span class="token string">'users'</span> because there is no <span class="token builtin class-name">type</span> mapping <span class="token keyword">for</span> org.hibernate.type.SqlTypes code: <span class="token number">1111</span> <span class="token punctuation">(</span>OTHER<span class="token punctuation">)</span></code></pre><h4 id="JdbcTypeCode-SqlTypes-JSON"><a href="#JdbcTypeCode-SqlTypes-JSON" class="headerlink" title="@JdbcTypeCode(SqlTypes.JSON)"></a>@JdbcTypeCode(SqlTypes.JSON)</h4><p>JsonType 과 JsonBinaryType 를 사용하는 것보다 <a href="https://docs.jboss.org/hibernate/orm/6.5/javadocs/org/hibernate/annotations/JdbcTypeCode.html">JdbcTypeCode</a>의 타입을 JSON 으로 지정하는게 더 간단하다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@JdbcTypeCode</span><span class="token punctuation">(</span><span class="token class-name">SqlTypes</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token keyword">private</span> <span class="token class-name">Metadata</span> metadata<span class="token punctuation">;</span><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Metadata</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> active<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>자매품으로 PostgreSQL 에서의 Enum 컬럼에 대한 @JdbcType(<a href="https://docs.jboss.org/hibernate/orm/6.5/javadocs/org/hibernate/dialect/PostgreSQLEnumJdbcType.html">PostgreSQLEnumJdbcType</a>::class)도 확인해봐야겠네?</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;JPA로 &lt;strong&gt;PostgreSQL의 JSONB 컬럼의 JSON 데이터&lt;/strong&gt;를 처리하고자 할때 &lt;a href=&quot;https://github.com/vladmihalcea/hypersistence-utils&quot;&gt;Hypersistanc</summary>
      
    
    
    
    
    <category term="PostgreSQL" scheme="https://kdevkr.github.io/tags/PostgreSQL/"/>
    
    <category term="JPA" scheme="https://kdevkr.github.io/tags/JPA/"/>
    
    <category term="JSONB" scheme="https://kdevkr.github.io/tags/JSONB/"/>
    
  </entry>
  
  <entry>
    <title>자카르타 메일 프로바이더 오류</title>
    <link href="https://kdevkr.github.io/jakarta-mail-provider-issue/"/>
    <id>https://kdevkr.github.io/jakarta-mail-provider-issue/</id>
    <published>2024-09-06T15:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.460Z</updated>
    
    <content type="html"><![CDATA[<h1 id="👩‍💻-사용자-로그인-시-2차-인증-메일이-안와요"><a href="#👩‍💻-사용자-로그인-시-2차-인증-메일이-안와요" class="headerlink" title="👩‍💻 사용자 로그인 시 2차 인증 메일이 안와요"></a>👩‍💻 사용자 로그인 시 2차 인증 메일이 안와요</h1><p>개발중인 애플리케이션 서버를 QA가 배포하고나서 사용자 로그인 시 <strong>2차인증을 수행하기 위한 인증코드 메일이 수신이 안된다</strong>는 버그 리포트를 해주었어요. 갑자기 어떤 문제로 인해 이메일이 발송되지 않았는지와 해결과정에 대해서 공유해보려고 합니다.</p><h2 id="문제-원인-분석"><a href="#문제-원인-분석" class="headerlink" title="문제 원인 분석"></a>문제 원인 분석</h2><p>먼저, 해당 서버에는 예외 상황을 추적할 수 있도록 Sentry가 도입되어 있는 상태였습니다. Sentry 에서는 수집된 예외가 없었기 때문에 즉시 알아채지 못하는 상황에 해당합니다. 아무튼, 애플리케이션 서버 로그를 확인하기 위해서 리눅스 서버에 접속하고 도커 컨테이너에 기록된 최근 로그를 살펴보았습니다.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># docker compose logs --since '2024-09-06T16:00+09:00' app</span><span class="token function">docker</span> compose logs <span class="token parameter variable">--since</span> <span class="token string">'5m'</span> appapp <span class="token operator">|</span> <span class="token punctuation">..</span>. caused by: Not provider of jakarta.mail.util.StreamProvider was found</code></pre><blockquote><p>도커 컴포즈에서 –since 옵션을 사용하면 원하는 시점부터의 로그를 확인할 수 있어요</p></blockquote><p>서버 로그에는 위와 같이 자카르타 메일의 StreamProvider를 찾을 수 없다는 오류 메시지가 남아있었는데요. 처음보는 오류 메시지 이므로 구글 검색을 해보니 <a href="https://github.com/jakartaee/mail-api/issues/665">자카르타 메일 관련 깃허브에 이슈로 등록된 내용이 있음</a>을 확인했습니다. 이슈 내용은 젠킨스 플러그인에서 Jakarta Mail API 2.1.1 을 사용하면 위와 동일한 오류가 발생한다는 것이었습니다. 동일하게 젠킨스에서 발생한 것은 아니지만 <a href="https://github.com/spring-projects/spring-boot/issues/39843">실행가능한 Jar 에서 클래스로더가 올바르지 않는다</a>는 이슈를 보게되었고 자카르타 메일에 대한 라이브러리 버전을 확인해보았습니다.</p><p>서버 애플리케이션에 해당되는 <a href="https://docs.spring.io/spring-boot/docs/3.1.2/reference/html/dependency-versions.html">스프링 부트 3.1.2의 의존성 버전 정보</a>에서 검색을 해보니 아래와 같이 파악되었습니다.</p><ul><li>org.eclipse.angus:angus-mail:1.1.0</li><li>org.eclipse.angus:angus-activation:2.0.1</li><li>jakarta.mail:jakarta.mail-api:1.1.0</li><li>jakarta.activation:jakarta.activation-api:2.1.2</li></ul><p>우선 변경사항에서 의심되는 부분이 발견되지 않았기에 의존성 버전을 변경하여 배포를 시도해보아야 했습니다. build.gradle에 아래와 같이 <strong>Jakarta Mail API 2.1.3</strong> 를 추가하고 빌드 및 배포를 수행해보았습니다.</p><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">ext <span class="token punctuation">&#123;</span>    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'angus-mail.version'</span><span class="token punctuation">,</span> <span class="token string">'2.0.3'</span><span class="token punctuation">)</span> <span class="token comment">// from 1.1.0</span>    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'jakarta-mail.version'</span><span class="token punctuation">,</span> <span class="token string">'2.1.3'</span><span class="token punctuation">)</span> <span class="token comment">// from 2.1.2</span><span class="token punctuation">&#125;</span></code></pre><p>새롭게 배포된 애플리케이션에서도 메일이 발송되지 않았고 아래와 같은 <strong>새로운 오류 메시지</strong>가 남았습니다.</p><pre class="language-bash" data-language="bash"><code class="language-bash">Provider <span class="token keyword">for</span> jakarta.activation.spi.MailcapRegistryProvider cannot be found</code></pre><p>Jakarta Mail API 버전을 변경하면 <strong>jakarta.activation-api</strong> 도 변경될거라 생각했는데요. 디펜던시 트리를 자세히 살펴보지 않은게 대응 과정에서의 실수였습니다. 아래와 같이 <strong>jakarta-activation</strong> 에 대한 버전을 추가로 지정하고 다시 배포했습니다.</p><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">ext <span class="token punctuation">&#123;</span>    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'angus-mail.version'</span><span class="token punctuation">,</span> <span class="token string">'2.0.3'</span><span class="token punctuation">)</span>    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'angus-activation.version'</span><span class="token punctuation">,</span> <span class="token string">'2.0.2'</span><span class="token punctuation">)</span> <span class="token comment">// from 1.1.0</span>    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'jakarta-mail.version'</span><span class="token punctuation">,</span> <span class="token string">'2.1.3'</span><span class="token punctuation">)</span>    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'jakarta-activation.version'</span><span class="token punctuation">,</span> <span class="token string">'2.1.3'</span><span class="token punctuation">)</span> <span class="token comment">// from 2.1.2</span><span class="token punctuation">&#125;</span></code></pre><h3 id="👩‍💻-2차-인증-메일-제대로-와요‼"><a href="#👩‍💻-2차-인증-메일-제대로-와요‼" class="headerlink" title="👩‍💻 2차 인증 메일 제대로 와요‼"></a>👩‍💻 2차 인증 메일 제대로 와요‼</h3><p>일단 급하게 해결은 되었으니 다행이지만 더 자세한 내용에 대해서 살펴보아야겠죠? 먼저, 의존성 버전을 올리는 것은 많은 테스트가 필요한 위험한 작업임을 되돌아봐야합니다. 해당 프로젝트는 릴리즈한 제품은 아니었기에 운영 환경이 없었고 문제가 발생했던 것은 테스트 엔지니어가 기능 확인할 수 있는 테스트 환경이었기에 가능했습니다.</p><p>또한, 해당 오류는 로컬 환경에서 인텔리제이 IDE로 실행되는 애플리케이션에서는 발생하지 않았는데요. 실행가능한 Jar 에서 문제가 발생할 수 있다는 정보는 문제가 해결하고나서 더 자세한 내용을 찾아보고 정리하는 단계에서 알게되었습니다. 로컬에서 빌드하고 실행해보지 않은 접근에 대해서는 아쉬운 부분으로 생각되므로 개선해야할 부분 같습니다.</p><h2 id="문제-해결-정리"><a href="#문제-해결-정리" class="headerlink" title="문제 해결 정리"></a>문제 해결 정리</h2><blockquote><p>Not provider of jakarta.mail.util.StreamProvider was found<br>Provider for jakarta.activation.spi.MailcapRegistryProvider cannot be found</p></blockquote><ul><li>스프링 부트에서 ForkJoinPool를 사용하는 경우 <strong>Executable Jar</strong> 에서 클래스로더가 올바르지 않을 수 있음</li><li>문제가 되었던 코드에는 <strong>ParallelStream</strong> 을 사용했기에 내부적으로 <strong>ForkJoinPool</strong>을 호출하는 상태</li><li>Jakarta Mail 2.1.2 이하 버전에서 클래스로더가 <strong>Jakarta Provider SPI</strong>를 찾을 수 없는 결함이 있음</li><li>Jakarta Mail 2.1.3 을 사용하기 위해서는 <strong>Angus Mail Provider 2.0.3</strong> 을 추가해야함</li></ul><p>※ Angus Mail 은 Jakarta Mail Specification 2.1+ 에 대한 구현체 프로젝트라고 해요.</p><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;👩‍💻-사용자-로그인-시-2차-인증-메일이-안와요&quot;&gt;&lt;a href=&quot;#👩‍💻-사용자-로그인-시-2차-인증-메일이-안와요&quot; class=&quot;headerlink&quot; title=&quot;👩‍💻 사용자 로그인 시 2차 인증 메일이 안와요&quot;&gt;&lt;/a</summary>
      
    
    
    
    
    <category term="문제해결" scheme="https://kdevkr.github.io/tags/%EB%AC%B8%EC%A0%9C%ED%95%B4%EA%B2%B0/"/>
    
    <category term="트러블슈팅" scheme="https://kdevkr.github.io/tags/%ED%8A%B8%EB%9F%AC%EB%B8%94%EC%8A%88%ED%8C%85/"/>
    
  </entry>
  
  <entry>
    <title>Spring AOP - Self Invocation</title>
    <link href="https://kdevkr.github.io/spring-aop-invocation/"/>
    <id>https://kdevkr.github.io/spring-aop-invocation/</id>
    <published>2024-09-05T14:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.464Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>@Cacheable self-invocation (in effect, a method within the target object calling another method of the target object).<br>The cache annotation will be ignored at runtime</p></blockquote><p>스프링 프레임워크에서 개발자가 경험하기 쉬운 실수는 동일한 클래스 내에서 비동기 또는 캐시 어노테이션이 선언된 함수를 내부적으로 호출하도록 비즈니스 로직을 작성하는 것 입니다. 이러한 문제가 발생하는 경우에는 <a href="https://www.baeldung.com/spring-invoke-cacheable-other-method-same-bean">Self Invocation</a>이 되지 않도록 별도의 클래스로 분리되도록 리팩토링을 진행하거나 <a href="https://www.baeldung.com/spring-self-injection">Self-Injection</a>이 되도록 수정해야합니다. 그외에 아래와 같은 방법들도 있지만 선호되지 않습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AService</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractService</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>cacheNames <span class="token operator">=</span> <span class="token string">"a"</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">"#root.methodName"</span><span class="token punctuation">,</span> unless <span class="token operator">=</span> <span class="token string">"#result == null"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token string">"A"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><ul><li>AdviceMode.ASPECTJ (AspectJ Weaving)</li><li>AopContext.currentProxy()</li><li>ApplicationContext.getBean()</li></ul><p>스프링 프레임워크 기반의 애플리케이션 서버를 작성하는 개발자라면 <a href="https://docs.spring.io/spring-framework/reference/core/aop/proxying.html">프록시 매커니즘</a>에 대해서 이해하고 있어야 합니다. 기본적인 프록시(CGLib) 또는 JDK 프록시가 무엇인지 알고있어야 왜 public 접근제어자가 아니거나 내부 호출인 경우 AOP를 수행할 수 없는지를 이해할 수 있습니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;@Cacheable self-invocation (in effect, a method within the target object calling another method of the target object).&lt;br&gt;Th</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>추상 클래스에서 @PostConstruct를 사용할 때</title>
    <link href="https://kdevkr.github.io/abstract-class-with-post-construct/"/>
    <id>https://kdevkr.github.io/abstract-class-with-post-construct/</id>
    <published>2024-09-03T16:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.456Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://www.baeldung.com/running-setup-logic-on-startup-in-spring">애플리케이션 실행 시 초기화</a>해야하는 로직이 필요한 경우 ApplicationReadyEvent에 대한 이벤트 리스너를 작성하거나 <strong>@PostConstruct가 선언된 함수</strong> 또는 InitializeBean 인터페이스의 afterPropertiesSet 함수를 오버라이딩하여 수행할 수 있다. 이 중에서 오늘은 @PostConstruct를 추상 클래스에 선언했을때의 문제에 대해 다루어보려고 한다.</p><h4 id="PostConstruct-with-abstract-class"><a href="#PostConstruct-with-abstract-class" class="headerlink" title="@PostConstruct with abstract class"></a>@PostConstruct with abstract class</h4><p>여러가지 서비스 로직에서 사용하는데 공통적으로 사용될 함수나 필드를 제공하기 위하여 서비스 클래스에 대한 추상 클래스를 만들 수 있다. 만약, 아래와 같이 @PostConstruct가 선언된 함수를 만들었고 이를 확장해서 만든 A 서비스, B 서비스, C 서비스가 있다고 가정하면 initialize 함수는 몇번 호출될까?</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractService</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@PostConstruct</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"initialize"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-bash" data-language="bash"><div class="caption"><span>Terminal</span></div><code class="language-bash">AService initializeBService initializeCService initialize</code></pre><p>정답은 1번도 4번도 아닌 추상 클래스를 제외한 <strong>A,B,C 서비스 3번 호출됨</strong>을 알 수 있다.</p><p>신규 프로젝트에서 상위 시스템에 의존함에 따라 <strong>API 통신을 위한 인증 토큰을 발급해오는 로직을 init 함수에 구현</strong>해두었다. 로컬에서 개발하다가 상위 시스템과의 통신에 대한 트레이스 로그를 활성화하고 애플리케이션 서버 로그를 살펴보던 중 <strong>애플리케이션 실행 시 인증 토큰 발급을 위한 요청이 주르륵 서비스 개수만큼 호출</strong>되는 것을 확인하게 되었다.</p><p>서비스 클래스마다 개별로 발급하여 사용하면 의미가 있을 수 있지만 <strong>여러번 요청하더라도 상위 시스템에서 동일한 토큰을 발급을 해주도록 구현되어</strong> 있으므로 AbstractService 기준으로 단 한번만 발급되면 되는게 의도된 동작으로 판단했다. 이에 대한 해결책으로 인증 토큰을 AbstractService의 클래스 내부 변수가 아닌 전역 변수로 변환하고 init 함수에서 토큰 발급 유무를 우선적으로 확인하여 토큰이 없는 경우에만 발급 로직을 수행하도록 수정했다.</p><blockquote><p>관련된 커밋 히스토리를 찾아보니 해당 코드가 작성된 것은 프로젝트 초기였으며 당시에는 추상 클래스를 확장한 서비스 클래스가 단 하나였는데요. 그래서 당시에는 인지하지 못하고 트레이스 로그를 활성화해본 지금에서야 내재된 오류 아닌 결함이 발견되었을 것 같습니다.</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://www.baeldung.com/running-setup-logic-on-startup-in-spring&quot;&gt;애플리케이션 실행 시 초기화&lt;/a&gt;해야하는 로직이 필요한 경우 ApplicationReadyEvent에 대한 </summary>
      
    
    
    
    
    <category term="PostConstruct" scheme="https://kdevkr.github.io/tags/PostConstruct/"/>
    
    <category term="InitializeBean" scheme="https://kdevkr.github.io/tags/InitializeBean/"/>
    
    <category term="ApplicationReadyEvent" scheme="https://kdevkr.github.io/tags/ApplicationReadyEvent/"/>
    
  </entry>
  
  <entry>
    <title>Jackson 마스킹 처리</title>
    <link href="https://kdevkr.github.io/jackson-mask-sensitive-data/"/>
    <id>https://kdevkr.github.io/jackson-mask-sensitive-data/</id>
    <published>2024-09-02T15:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.460Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>■ 개인정보의 기술적관리적 보호조치 기준 제10조<br>정보통신서비스 제공자등은 개인정보 업무처리를 목적으로 개인정보의 조회, 출력 등의 업무를 수행하는 과정에서 개인정보보호를 위하여 개인정보를 마스킹하여 표시제한 조치를 취할 수 있다.</p></blockquote><p>위와 같이 개인정보 또는 보안 이슈로 인하여 일부 민감한 데이터 항목을 전체가 아닌 일부만을 표시해야할 요구사항이 있을 수 있다. <a href="https://github.com/kdevkr/mambo-box/blob/main/errors/2024-09-02.md">Jackson AnnotationIntrospector 이슈</a>를 경험한 김에 <a href="https://github.com/FasterXML/jackson-docs/wiki/AnnotationIntrospector">AnnotationIntrospector</a>를 사용하여 REST API에서 응답되는 일부 필드를 마스킹하는 방법을 이해해보도록 하자.</p><h4 id="Annotation-기반-마스킹-처리"><a href="#Annotation-기반-마스킹-처리" class="headerlink" title="Annotation 기반 마스킹 처리"></a>Annotation 기반 마스킹 처리</h4><p>기본적으로 별도의 Getter 함수로 만들어서 마스킹한 결과를 반환하는 필드를 만들어내도 된다. 그러나, 마스킹을 위한 어노테이션을 만들고 AnnotationIntrospector를 확장해서 어노테이션이 선언된 필드에 대해서 마스킹된 결과로 직렬화(Serialize)를 수행하도록 작성하면 마스킹 되어야하는 항목에 따라서 <strong>다양한 마스킹 패턴을 전략적으로 적용</strong>할 수 있다.</p><pre class="language-java" data-language="java"><div class="caption"><span>MaskedField</span></div><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">ANNOTATION_TYPE</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">FIELD</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span><span class="token annotation punctuation">@JacksonAnnotation</span><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">MaskedField</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> <span class="token function">expression</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"****"</span><span class="token punctuation">;</span>    <span class="token class-name">MaskedType</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">MaskedType</span><span class="token punctuation">.</span><span class="token constant">COMMON</span><span class="token punctuation">;</span>    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">fields</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// NOTE: If metadata</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><div class="caption"><span>MaskedFieldAnnotationIntrospector</span></div><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MaskedFieldAnnotationIntrospector</span> <span class="token keyword">extends</span> <span class="token class-name">NopAnnotationIntrospector</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">findSerializer</span><span class="token punctuation">(</span><span class="token class-name">Annotated</span> annotated<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">MaskedField</span> annotation <span class="token operator">=</span> annotated<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">MaskedField</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>annotation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token class-name">MaskedFieldSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MaskedFieldSerializer</span> <span class="token keyword">extends</span> <span class="token class-name">StdSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">ContextualSerializer</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isMask<span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MaskedField</span> annotation<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token class-name">MaskedFieldSerializer</span><span class="token punctuation">(</span><span class="token class-name">MaskedField</span> annotation<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isMask<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>isMask <span class="token operator">=</span> isMask<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>annotation <span class="token operator">=</span> annotation<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token class-name">JsonGenerator</span> gen<span class="token punctuation">,</span> <span class="token class-name">SerializerProvider</span> provider<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// NOTE: MaskedType 에 따른 마스킹 패턴 구현은 생략</span>            <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ObjectMapper</span><span class="token punctuation">)</span> gen<span class="token punctuation">.</span><span class="token function">getCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> s <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isMask<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">JSONParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONParser</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_PERMISSIVE_MODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                    <span class="token class-name">Object</span> o <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token keyword">instanceof</span> <span class="token class-name">JSONAwareEx</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token class-name">DocumentContext</span> doc <span class="token operator">=</span> <span class="token class-name">JsonPath</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">Map</span> json <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> field <span class="token operator">:</span> annotation<span class="token punctuation">.</span><span class="token function">fields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                                doc<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> annotation<span class="token punctuation">.</span><span class="token function">expression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">&#125;</span>                        <span class="token punctuation">&#125;</span>                        gen<span class="token punctuation">.</span><span class="token function">writeRawValue</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span><span class="token function">jsonString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                        gen<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>annotation<span class="token punctuation">.</span><span class="token function">expression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                gen<span class="token punctuation">.</span><span class="token function">writeRawValue</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token class-name">JsonSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">createContextual</span><span class="token punctuation">(</span><span class="token class-name">SerializerProvider</span> serializerProvider<span class="token punctuation">,</span> <span class="token class-name">BeanProperty</span> beanProperty<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonMappingException</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">MaskedField</span> maskedField <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>beanProperty <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                maskedField <span class="token operator">=</span> beanProperty<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">MaskedField</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MaskedFieldSerializer</span><span class="token punctuation">(</span>maskedField<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><div class="caption"><span>AnnotationIntrospector.pair</span></div><code class="language-java"><span class="token annotation punctuation">@Bean</span><span class="token keyword">public</span> <span class="token class-name">ObjectMapper</span> <span class="token function">objectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token class-name">Jackson2ObjectMapperBuilder</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">AnnotationIntrospector</span> introspector <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">getSerializationConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAnnotationIntrospector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">AnnotationIntrospector</span> annotationIntrospector <span class="token operator">=</span> <span class="token class-name">AnnotationIntrospector</span><span class="token punctuation">.</span><span class="token function">pair</span><span class="token punctuation">(</span>introspector<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MaskedFieldAnnotationIntrospector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    objectMapper<span class="token punctuation">.</span><span class="token function">setAnnotationIntrospector</span><span class="token punctuation">(</span>annotationIntrospector<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> objectMapper<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><ul><li>다양한 마스킹 패턴 대응을 위한 MaskedType Enum 만들기</li><li>NopAnnotationIntrospector 를 확장한 MaskedFieldAnnotationIntrospector 클래스 작성하기</li><li>objectMapper에 AnntationIntrospectorPair로 MaskedFieldAnnotationIntrospector 등록하기</li></ul><h4 id="마스킹-전략"><a href="#마스킹-전략" class="headerlink" title="마스킹 전략"></a>마스킹 전략</h4><p>이름과 주민등록번호 그리고 휴대폰 번호와 같이 민감한 데이터에 대해서는 기본적으로 <strong>마스킹</strong>이 고려되어야한다. 마스킹 전략에는 뒤에서 N개의 문자 또는 데이터 형식에 따라 중간의 N개의 문자를 별표(asterisk)로 치환한다. 경기대학교 전산정보원의 <a href="https://www.kyonggi.ac.kr/comcenter/contents.do?key=6883">개인정보 노출 조치 방법 안내</a>에서 여러가지 예시를 잘 나타내고 있는 것 같다.</p><blockquote><p>민감한 데이터에 대한 마스킹 처리를 반드시 애플리케이션 서버에서 이루어져야합니다. 또한, 서로 다른 시스템에서 개인정보를 공유하는데 각 시스템에서의 마스킹 전략이 다르다면 이것도 개인정보 처리와 보호 조치에 대한 문제의 소지가 있을 수 있습니다.</p></blockquote><p>그러면, 애플리케이션 <strong>로그에 포함될 수 있는 민감한 정보</strong>는 어떻게 <a href="https://www.baeldung.com/logback-mask-sensitive-data">마스킹</a> 해야하지? 🤔</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;■ 개인정보의 기술적관리적 보호조치 기준 제10조&lt;br&gt;정보통신서비스 제공자등은 개인정보 업무처리를 목적으로 개인정보의 조회, 출력 등의 업무를 수행하는 과정에서 개인정보보호를 위하여 개인정보를 마스킹하여 표시제한 조치를 </summary>
      
    
    
    
    
    <category term="Masking" scheme="https://kdevkr.github.io/tags/Masking/"/>
    
    <category term="Sensitive Data" scheme="https://kdevkr.github.io/tags/Sensitive-Data/"/>
    
  </entry>
  
  <entry>
    <title>Spring Security - Rejected Request</title>
    <link href="https://kdevkr.github.io/spring-security-rejected-request/"/>
    <id>https://kdevkr.github.io/spring-security-rejected-request/</id>
    <published>2024-08-18T02:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.468Z</updated>
    
    <content type="html"><![CDATA[<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>firewall<span class="token punctuation">.</span></span>RequestRejectedException</span><span class="token operator">:</span> <span class="token class-name">The</span> request was rejected because the <span class="token constant">URL</span> contained a potentially malicious <span class="token class-name">String</span> <span class="token string">"//"</span></code></pre><ul><li><a href="https://www.baeldung.com/spring-security-request-rejected-exception">Spring Security – Request Rejected Exception</a></li></ul><h4 id="요청이-거부되는-이유"><a href="#요청이-거부되는-이유" class="headerlink" title="요청이 거부되는 이유"></a>요청이 거부되는 이유</h4><p>일반적으로 스프링 부트 기반의 애플리케이션에서 <strong>스프링 시큐리티를 사용했다면</strong> 기본적으로 적용되는 HttpFirewall 구현체에 의해 연속되는 슬래시 문자를 허용하지 않도록 되어있다. REST API로 디자인하는 경우 <strong>PathVariable</strong> 로 경로 상의 리소스 아이디를 검증하는 경우가 대부분이다. 따라서, 대부분의 경우 <strong>URL 경로 상 연속된 슬래시 문자는 서버 입장에서 잘못된 요청</strong>에 해당된다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span><span class="token keyword">public</span> <span class="token class-name">WebSecurityCustomizer</span> <span class="token function">webSecurityCustomizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> webSecurity <span class="token operator">-></span> webSecurity<span class="token punctuation">.</span><span class="token function">httpFirewall</span><span class="token punctuation">(</span><span class="token function">httpFirewall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requestMatchers</span><span class="token punctuation">(</span><span class="token string">"/error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token annotation punctuation">@Bean</span><span class="token keyword">public</span> <span class="token class-name">HttpFirewall</span> <span class="token function">httpFirewall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// NOTE: Spring Security provides DefaultHttpFirewall and StrictHttpFirewall.</span>    <span class="token class-name">StrictHttpFirewall</span> httpFirewall <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StrictHttpFirewall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpFirewall<span class="token punctuation">.</span><span class="token function">setAllowSemicolon</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpFirewall<span class="token punctuation">.</span><span class="token function">setAllowNull</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpFirewall<span class="token punctuation">.</span><span class="token function">setAllowBackSlash</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpFirewall<span class="token punctuation">.</span><span class="token function">setAllowUrlEncodedDoubleSlash</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> allowedHttpMethods <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>                    <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span>                    <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">,</span>                    <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">PUT</span><span class="token punctuation">,</span>                    <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token punctuation">,</span>                    <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">OPTIONS</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token operator">::</span><span class="token function">name</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpFirewall<span class="token punctuation">.</span><span class="token function">setAllowedHttpMethods</span><span class="token punctuation">(</span>allowedHttpMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> httpFirewall<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="거부된-요청을-무시하지-말고-추적하세요"><a href="#거부된-요청을-무시하지-말고-추적하세요" class="headerlink" title="거부된 요청을 무시하지 말고 추적하세요"></a>거부된 요청을 무시하지 말고 추적하세요</h4><p>올바른 클라이언트가 아닌 봇에 의한 잘못된 요청일 수 있으나 <strong>프론트엔드 개발자가 서버에서 요구하는 REST API 설계대로 요청하지 않았을 가능성</strong>을 간과해서는 안된다. 서버에서는 최소한 이러한 요청에 대해서 <strong>오류 메시지 또는 <a href="https://engineering.linecorp.com/ko/blog/log-collection-system-sentry-on-premise">Sentry</a>와 같은 오류 추적 솔루션으로 분석할 수 있도록 남겨야</strong>한다.</p><blockquote><p>만약, <a href="https://docs.aws.amazon.com/waf/latest/developerguide/classic-web-acl-string-conditions.html">AWS WAF</a>를 사용한다면 설정과 규칙에 따라 더블 슬래시가 포함된 요청이 서버 애플리케이션까지 도달하지 않을 수 있음을 백엔드 개발자는 알고 있어야 합니다.</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;pre class=&quot;language-java&quot; data-language=&quot;java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token class-name&quot;&gt;&lt;span class=&quot;token namespace&quot;&gt;org</summary>
      
    
    
    
    
    <category term="Spring Security" scheme="https://kdevkr.github.io/tags/Spring-Security/"/>
    
    <category term="Firewall" scheme="https://kdevkr.github.io/tags/Firewall/"/>
    
  </entry>
  
  <entry>
    <title>E.164</title>
    <link href="https://kdevkr.github.io/e164/"/>
    <id>https://kdevkr.github.io/e164/</id>
    <published>2024-08-15T11:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.460Z</updated>
    
    <content type="html"><![CDATA[<h4 id="What-is-the-E-164-format"><a href="#What-is-the-E-164-format" class="headerlink" title="What is the E.164 format?"></a>What is the E.164 format?</h4><p><strong>E.164</strong>는 전세계적으로 사용되는 국제전화번호에 대한 표준 형식이다. 문자 메시지 또는 왓츠앱 그리고 카카오 알림톡을 보내기 위해서 <a href="https://docs.aws.amazon.com/ko_kr/sns/latest/dg/sms_publish-to-phone.html">발송 인터페이스 문서</a>를 확인해보면 휴대폰 번호 필드에 E.164 형식의 값을 요구하는 것을 확인할 수 있다. 글로벌 서비스나 솔루션을 준비한다면 프론트엔드에서도 <a href="https://github.com/jackocnr/intl-tel-input">국가별 전화번호를 입력할 수 있는 컴포넌트</a>를 준비하는 편이다.</p><p><img data-src="https://file.okky.kr/images/1723708024170.png"></p><h4 id="821012345678"><a href="#821012345678" class="headerlink" title="+821012345678"></a>+821012345678</h4><ul><li>일반적으로 공백을 포함하지 않는 것으로 표현한다.</li><li>전화번호는 0으로 시작하는 부분은 생략한다.</li><li>한국의 국가 번호(country code)는 82 이며 이동통신망(area code)은 10 이다.</li><li>ITU-T의 E.164는 최대 15자리이다.</li></ul><h4 id="참고-링크"><a href="#참고-링크" class="headerlink" title="참고 링크"></a>참고 링크</h4><ul><li><a href="https://www.twilio.com/docs/glossary/what-e164">What is E.164? | Twilio Docs</a></li><li><a href="http://www.ktword.co.kr/test/view/view.php?no=1970">E.164 | 정보통신기술용어해설</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;What-is-the-E-164-format&quot;&gt;&lt;a href=&quot;#What-is-the-E-164-format&quot; class=&quot;headerlink&quot; title=&quot;What is the E.164 format?&quot;&gt;&lt;/a&gt;What is the E</summary>
      
    
    
    
    
    <category term="Phone Number" scheme="https://kdevkr.github.io/tags/Phone-Number/"/>
    
  </entry>
  
  <entry>
    <title>REST Assured</title>
    <link href="https://kdevkr.github.io/rest-assured/"/>
    <id>https://kdevkr.github.io/rest-assured/</id>
    <published>2024-08-09T14:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.464Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://rest-assured.io/">REST Assured</a>를 사용하면 자바 애플리케이션에서 <strong>인수 테스트</strong>를 위한 코드를 작성할 수 있다. 현재 조직은 테스트 커버리지를 체크하지 않고 비즈니스 레이어를 위주로 테스트 코드를 작성하기로 했었다. 온프레미스 형태의 B2B 솔루션이 아닌 <strong>SaaS 서비스</strong>를 준비하면서 <strong>테스트 자동화</strong>를 위해 많은 고민을 하고 있다. 일단 <a href="https://playwright.dev/">Playwright</a>와 <a href="https://allurereport.org/">Allure Report</a>를 사용하고자 준비중이라 이에 맞춰 서비스 개발 시 Allure Report와 통합할 수 있는 <strong>JUnit5 + Rest Assured</strong>로 테스트 코드를 작성하려고 한다.</p><h4 id="Gradle-Dependencies"><a href="#Gradle-Dependencies" class="headerlink" title="Gradle Dependencies"></a>Gradle Dependencies</h4><p>Rest Assured 와 함께 <a href="https://hamcrest.org/JavaHamcrest/">Hamcrest</a>를 많이 사용하는 것 같은데 스프링 부트 스타터의 테스트 의존성에는 기본적으로 Hamcrest를 포함하고 있다. 단위 테스트 코드를 작성할 때 Hamcrest를 사용해본적은 없어서 이번 기회에 잘 활용해보도록 해야겠다.</p><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    testImplementation <span class="token string">'org.springframework.boot:spring-boot-starter-test'</span>    testImplementation <span class="token string">'io.rest-assured:rest-assured:5.5.0'</span><span class="token punctuation">&#125;</span></code></pre><h4 id="Behavior-Driven-Development"><a href="#Behavior-Driven-Development" class="headerlink" title="Behavior Driven Development"></a>Behavior Driven Development</h4><p>그동안은 테스트 코드를 작성하더라도 TDD를 수행하지는 않았으며 솔루션 커스터마이징 요구사항에 맞는지만 확인해왔다. Rest Assured는 BDD로 E2E 테스트 코드를 작성할 수 있도록 제공해주기 때문에 프론트엔드나 QA 엔지니어가 작성하는 Playwright 와도 비슷하게 작성해갈 수 있을 것으로 보인다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"End to End Test"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>webEnvironment <span class="token operator">=</span> <span class="token class-name">SpringBootTest<span class="token punctuation">.</span>WebEnvironment</span><span class="token punctuation">.</span><span class="token constant">RANDOM_PORT</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">DemoApplicationTests</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@LocalServerPort</span>    <span class="token keyword">int</span> port<span class="token punctuation">;</span>    <span class="token annotation punctuation">@BeforeEach</span>    <span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">RestAssured</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">void</span> <span class="token function">whenGet_thenOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">RestAssured</span>                <span class="token punctuation">.</span><span class="token function">given</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AllureRestAssured</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">USER_AGENT</span><span class="token punctuation">,</span>                        <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifValidationFails</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">statusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">Matchers</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">"Hello World"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="Allure-REST-Assured"><a href="#Allure-REST-Assured" class="headerlink" title="Allure REST Assured"></a>Allure REST Assured</h4><p>그래들 플러그인을 추가하고 <strong>allureReport</strong> 또는 <strong>allureServe</strong> 태스크를 실행하면 Allure 리포트를 확인할 수 있다.</p><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">plugins <span class="token punctuation">&#123;</span>    id <span class="token string">'io.qameta.allure'</span> version <span class="token string">'2.12.0'</span><span class="token punctuation">&#125;</span>dependencies <span class="token punctuation">&#123;</span>    testImplementation <span class="token function">platform</span><span class="token punctuation">(</span><span class="token string">'io.qameta.allure:allure-bom:2.28.0'</span><span class="token punctuation">)</span>    testImplementation <span class="token interpolation-string"><span class="token string">"io.qameta.allure:allure-junit5"</span></span>    testImplementation <span class="token interpolation-string"><span class="token string">"io.qameta.allure:allure-rest-assured"</span></span><span class="token punctuation">&#125;</span></code></pre><p><img data-src="/images/posts/rest-assured/01.png" alt="Allure Report"></p><h4 id="참고-링크"><a href="#참고-링크" class="headerlink" title="참고 링크"></a>참고 링크</h4><ul><li><a href="https://www.baeldung.com/rest-assured-tutorial">A Guide to REST-assured</a></li><li><a href="https://www.baeldung.com/rest-assured-header-cookie-parameter">Headers, Cookies and Parameters with REST-assured</a></li><li><a href="https://www.baeldung.com/rest-assured-response">Getting and Verifying Response Data with REST-assured</a></li><li><a href="https://www.baeldung.com/rest-assured-authentication">REST Assured Authentication</a></li><li><a href="https://allurereport.org/docs/restassured/">Allure REST Assured</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://rest-assured.io/&quot;&gt;REST Assured&lt;/a&gt;를 사용하면 자바 애플리케이션에서 &lt;strong&gt;인수 테스트&lt;/strong&gt;를 위한 코드를 작성할 수 있다. 현재 조직은 테스트 커버리지를 체크하지 않고 </summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>뉴렐릭 인프라 에이전트 설치가 되지 않을때</title>
    <link href="https://kdevkr.github.io/install-newrelic-infra-agent/"/>
    <id>https://kdevkr.github.io/install-newrelic-infra-agent/</id>
    <published>2024-08-01T13:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.460Z</updated>
    
    <content type="html"><![CDATA[<p><img data-src="/images/posts/install-newrelic-infra-agent/01.png"></p><p>뉴렐릭은 무료 플랜을 제공하는 SaaS APM 솔루션으로 웹 UI에서 원하는 에이전트를 쉽게 설치할 수 있도록 명령어를 제공하고 있다. 그런데, 아래와 같이 gzip 관련 명령어가 수행될 때 오류가 발생하는 것을 경험할 수 있다.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-Ls</span> https://download.newrelic.com/install/newrelic-cli/scripts/install.sh <span class="token operator">|</span> <span class="token function">bash</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token assign-left variable">NEW_RELIC_API_KEY</span><span class="token operator">=</span>NRAK-XXXX <span class="token assign-left variable">NEW_RELIC_ACCOUNT_ID</span><span class="token operator">=</span>45XXXXX /usr/local/bin/newrelic <span class="token function">install</span>Installing New Relic CLI v0.92.0gzip: stdin: unexpected end of <span class="token function">file</span>tar: Child returned status <span class="token number">1</span>tar: Error is not recoverable: exiting nowAn error occurred installing the tool.The contents of the directory /tmp/tmp.ROXuwOdosK have been left <span class="token keyword">in</span> place to <span class="token builtin class-name">help</span> to debug the issue.</code></pre><p>위와 같은 오류가 발생하는 경우의 원인은 루트 권한으로 수행하지 않았기 때문이며 루트 계정으로 사용자를 전환하여 설치하도록 하자.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">su</span> -<span class="token function">curl</span> <span class="token parameter variable">-Ls</span> https://download.newrelic.com/install/newrelic-cli/scripts/install.sh <span class="token operator">|</span> <span class="token function">bash</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token assign-left variable">NEW_RELIC_API_KEY</span><span class="token operator">=</span>NRAK-XXXX <span class="token assign-left variable">NEW_RELIC_ACCOUNT_ID</span><span class="token operator">=</span>45XXXXX /usr/local/bin/newrelic <span class="token function">install</span>Installing New Relic CLI v0.92.0Installing to /usr/local/bin<span class="token punctuation">..</span>.</code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img data-src=&quot;/images/posts/install-newrelic-infra-agent/01.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;뉴렐릭은 무료 플랜을 제공하는 SaaS APM 솔루션으로 웹 UI에서 원하는 에이전트를 쉽게 설치할 수 있도록 명</summary>
      
    
    
    
    
    <category term="Newrelic CLI" scheme="https://kdevkr.github.io/tags/Newrelic-CLI/"/>
    
    <category term="Infrastructure Agent" scheme="https://kdevkr.github.io/tags/Infrastructure-Agent/"/>
    
  </entry>
  
  <entry>
    <title>2차 인증 설정을 위한 QR 코드</title>
    <link href="https://kdevkr.github.io/mfa-qrcode/"/>
    <id>https://kdevkr.github.io/mfa-qrcode/</id>
    <published>2024-07-20T03:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.464Z</updated>
    
    <content type="html"><![CDATA[<p>오늘은 2차 인증 설정 과정에서 OTP 앱으로 스캔할 수 있도록 코드 대신에 제공하는 QR 코드에 대해서 알아보려고 한다.</p><h4 id="RFC-6238"><a href="#RFC-6238" class="headerlink" title="RFC 6238"></a>RFC 6238</h4><p>Google Authenticator, Microsoft Authenticator 그리고 Authy와 같은 OTP 인증 앱들은 <a href="https://datatracker.ietf.org/doc/html/rfc6238">RFC6238</a>로 정의된 TOTP 표준에 따라 구현되어있고 QR 코드에 포함되는 텍스트는 <a href="https://github.com/google/google-authenticator/wiki/Key-Uri-Format">Key Uri Format</a>로 구성되어야 읽을 수 있다.</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># otpauth://TYPE/LABEL?PARAMETERS</span>otpauth://totp/Mambo:kdevkr@email.com?secret<span class="token operator">=</span>HXDMVJECJJWSRB3HWIZR4IFUGFTMXBOZ<span class="token operator">&amp;</span><span class="token assign-left variable">issuer</span><span class="token operator">=</span>Mambo<span class="token operator">&amp;</span><span class="token assign-left variable">algorithm</span><span class="token operator">=</span>SHA1<span class="token operator">&amp;</span><span class="token assign-left variable">digits</span><span class="token operator">=</span><span class="token number">6</span><span class="token operator">&amp;</span><span class="token assign-left variable">period</span><span class="token operator">=</span><span class="token number">30</span></code></pre><h4 id="TOTP-QR-코드-이미지-만들기"><a href="#TOTP-QR-코드-이미지-만들기" class="headerlink" title="TOTP QR 코드 이미지 만들기"></a>TOTP QR 코드 이미지 만들기</h4><p>QR 코드 이미지를 만들기 위해서 <a href="https://github.com/samdjstevens/java-totp">java-totp</a> 라이브러리를 사용하려고 한다. 이 라이브러리는 비밀키 발급부터 QR 코드를 HTML에서 사용하기 위한 <a href="https://developer.mozilla.org/ko/docs/Web/HTTP/Basics_of_HTTP/Data_URLs">Data URI</a>로 변환하는 <strong>Utils.getDataUriForImage</strong> 함수도 제공해주고 있다.</p><pre class="language-groovy" data-language="groovy"><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    implementation <span class="token string">'dev.samstevens.totp:totp:1.7.1'</span>    implementation <span class="token string">'com.google.zxing:javase:3.5.3'</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">SecretGenerator</span> secretGenerator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSecretGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> secret <span class="token operator">=</span> secretGenerator<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">QrData</span> qrData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QrData<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">label</span><span class="token punctuation">(</span><span class="token string">"kdevkr@gmail.com"</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">secret</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">issuer</span><span class="token punctuation">(</span><span class="token string">"Mambo"</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">algorithm</span><span class="token punctuation">(</span><span class="token class-name">HashingAlgorithm</span><span class="token punctuation">.</span><span class="token constant">SHA1</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">digits</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">period</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ZxingPngQrGenerator</span> qrGenerator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZxingPngQrGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>qrGenerator<span class="token punctuation">.</span><span class="token function">setImageSize</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> qrImageBytes <span class="token operator">=</span> qrGenerator<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>qrData<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> qrDataUri <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">getDataUriForImage</span><span class="token punctuation">(</span>qrImageBytes<span class="token punctuation">,</span> qrGenerator<span class="token punctuation">.</span><span class="token function">getImageMimeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>qrDataUri<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p><a href="https://zxing.org/w/decode.jspx">Zxing Decoder Online</a>을 사용하여 올바르게 이미지가 만들어졌는지 <a href="https://zxing.org/w/decode?u=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPoAAAD6AQAAAACgl2eQAAACoUlEQVR4Xu2YTW6rUAyFHWXAMEtgJ2VjSInExmAnLIEhA4Tf+Wzy01bqNNZT7oCSm68Sdo6PfTH/e432c+fH+gC5PkCuKsBmWn1r3WLWTD7MPl5uLZttIUB/l6sLuHrjPrhPeccXdQA7LX27fumxAeZmWnQ3KrJygJ3c57VbevPdFEVFAClsFsBql6EegB7m9eQ302UzfXf+LZg3A1lZUsHr5XfpvRU4lhFFArvK/9itAiiK7v7Y+m5rV7OzjOqphxJAM17c49mRwuyUv4IaHlEUAMLoW98vnvYkQB4wLedSQIPHW6fPbIuSMpDHPdUFAPSq8pcHqG86yvhS5uVW9yhqAOth9NE8e4xqwKOeUbwf2BCAcbnOyrcyrwlEqWavEKDcantCFNyF5Tsf6wCuZ9dvv3YYAeUVyojmWQjgt48x04/mia96Wn4VQG5/H+NU/sj3tDDaXfjfMkDLrG7olfKXVEd1J/82JpUATGOS9CoV6E5B6fKt9AoAWVm7nl1ZPmP56pumvUqASkktfY9SypYUHVRoGSBWDkf4vkQxUWih4TLAlueLzK2kKqPSIUhBvfwWFYBOzytAJ0ltM3wModxnFG8HnAmz51Sh8uqUatyeDnU30hqAKn8gt7c8nVNZNKdKQNonwxF6yPIy7h56KADQgzzOFzGGKBTyrQurCrCR2z67OVNxNCdmpUpABDAwK13x0A1RXOVWGpILATPdkntewfAeYcQDYq8OwNrIMlKV5TuhHPKtAuQTZ6p9j6kuPOrZWCsArfNGS41IY2aHPTGBMHqWAjjzkuDjjZGOFvSlh2jLAL0uhzPNAegrhVINUF+6GaMn5s9oVwzwtE9CifJXm/fmpbIqABbb0kO8wDTGpBtttBLw5/oAuT5Arv8E+AcOAIqU2Few9gAAAABJRU5ErkJggg==">확인</a>해볼 수 있습니다.</p></blockquote><h4 id="보안-이슈"><a href="#보안-이슈" class="headerlink" title="보안 이슈"></a>보안 이슈</h4><p>2차 인증 설정을 위해서 제공하는 QR 코드에는 암호화되지 않은 상태의 보안키가 포함되어있다. 서드 파티인 OTP 앱은 QR 코드를 스캔하여 포함된 텍스트에서 정보를 추출해야하므로 보안키를 암호화 할수는 없다. 아래와 같이 <a href="https://github.com/j256/two-factor-auth/blob/d28c4da7cbe593774a7420a86257b803b67c8f5a/src/main/java/com/j256/twofactorauth/TimeBasedOneTimePasswordUtil.java#L474-L480">two-factor-auth</a>처럼 QR 코드 이미지 생성을 위해서 외부 주소에 의존하는 것은 좋지 않다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">qrImageUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyId<span class="token punctuation">,</span> <span class="token class-name">String</span> secret<span class="token punctuation">,</span> <span class="token keyword">int</span> numDigits<span class="token punctuation">,</span> <span class="token keyword">int</span> imageDimension<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"https://chart.googleapis.com/chart?chs="</span> <span class="token operator">+</span> imageDimension <span class="token operator">+</span> <span class="token string">"x"</span> <span class="token operator">+</span> imageDimension <span class="token operator">+</span> <span class="token string">"&amp;cht=qr&amp;chl="</span>            <span class="token operator">+</span> imageDimension <span class="token operator">+</span> <span class="token string">"x"</span> <span class="token operator">+</span> imageDimension <span class="token operator">+</span> <span class="token string">"&amp;chld=M|0&amp;cht=qr&amp;chl="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">addOtpAuthPart</span><span class="token punctuation">(</span>keyId<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> sb<span class="token punctuation">,</span> numDigits<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>구글에서 QR 이미지 생성을 제공했던 주소는 제거되었고 대체할 수 있는 주소가 있지만 외부 주소에 보안키를 전달하는 것은 권장하지 않습니다.</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;오늘은 2차 인증 설정 과정에서 OTP 앱으로 스캔할 수 있도록 코드 대신에 제공하는 QR 코드에 대해서 알아보려고 한다.&lt;/p&gt;
&lt;h4 id=&quot;RFC-6238&quot;&gt;&lt;a href=&quot;#RFC-6238&quot; class=&quot;headerlink&quot; title=&quot;</summary>
      
    
    
    
    
    <category term="2FA" scheme="https://kdevkr.github.io/tags/2FA/"/>
    
    <category term="TOTP" scheme="https://kdevkr.github.io/tags/TOTP/"/>
    
    <category term="QRCode" scheme="https://kdevkr.github.io/tags/QRCode/"/>
    
  </entry>
  
  <entry>
    <title>패스키 로그인 고도화</title>
    <link href="https://kdevkr.github.io/passkey-login-advanced/"/>
    <id>https://kdevkr.github.io/passkey-login-advanced/</id>
    <published>2024-07-15T14:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.464Z</updated>
    
    <content type="html"><![CDATA[<h4 id="패스키-생성-알고리즘"><a href="#패스키-생성-알고리즘" class="headerlink" title="패스키 생성 알고리즘"></a>패스키 생성 알고리즘</h4><p>패스키 등록 시 PublicKeyCredentialCreationOptions의 pubKeyCredParams 를 통해 RP 서버에서 선호하는 공개키 알고리즘 목록을 제공할 수 있는데요. 이때 공개키 알고리즘 목록에는 ES256과 RS256은 반드시 포함하는게 좋습니다. 그 이유는 <a href="https://github.com/w3c/webauthn/issues/1757#issuecomment-1169035781">대부분 ES256를 지원하고 일부는 RS256를 지원</a>한다고 하기 때문입니다.</p><h4 id="패스키-제공업체-표시"><a href="#패스키-제공업체-표시" class="headerlink" title="패스키 제공업체 표시"></a>패스키 제공업체 표시</h4><p><a href="https://web.dev/articles/webauthn-aaguid?hl=ko">Determine the passkey provider with AAGUID</a>에서 소개하는 <a href="https://github.com/passkeydeveloper/passkey-authenticator-aaguids">Passkey Provider AAGUIDs</a>에는 일부 인증 기기에 대한 이름과 아이콘 정보를 포함하고 있습니다. <a href="https://passkeydeveloper.github.io/passkey-authenticator-aaguids/explorer/">Passkeys Authenticator AAGUID Explorer</a>를 살펴보면 대부분의 사용자는 주로 아래의 인증 기기를 사용할 것 같습니다.</p><table><thead><tr><th>Authenticator</th><th>AAGUID</th></tr></thead><tbody><tr><td>Google Password Manager</td><td>ea9b8d66-4d01-1d21-3ce4-b6b48cb575d4</td></tr><tr><td>Chrome on Mac</td><td>adce0002-35bc-c60a-648b-0b25f1f05503</td></tr><tr><td>iCloud Keychain</td><td>fbfc3007-154e-4ecc-8c0b-6e020557d7bd</td></tr><tr><td>Samsung Pass</td><td>53414d53-554e-4700-0000-000000000000</td></tr></tbody></table><h5 id="AAGUID-UUID-문자열"><a href="#AAGUID-UUID-문자열" class="headerlink" title="AAGUID UUID 문자열"></a>AAGUID UUID 문자열</h5><p><a href="https://github.com/Yubico/java-webauthn-server">java-webauthn-server</a> 라이브러리의 AAGUID 클래스를 통해 ByteArray로 구성된 aaguid를 RFC4122 표준의 UUID 형식의 문자열로 변환하여 저장할 수 있습니다. 패스키 등록 이후에 변하지 않는 항목이므로 패스키 등록 과정에서 Base64URL 보다는 UUID 형태로 저장해두는게 프론트엔드에서 사용하기에는 더 편할 것 같네요. 아래와 같이 AAGUID의 asGuidString 함수를 호출해서 가져올 수 있습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">RegistrationResult</span> result <span class="token operator">=</span> relyingParty<span class="token punctuation">.</span><span class="token function">finishRegistration</span><span class="token punctuation">(</span>        <span class="token class-name">FinishRegistrationOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>publicKeyCredentialCreationOptions<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span>publicKeyCredential<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> aaguid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AAGUID</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getAaguid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asGuidString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="패스키-식별-가능한-이름-설정"><a href="#패스키-식별-가능한-이름-설정" class="headerlink" title="패스키 식별 가능한 이름 설정"></a>패스키 식별 가능한 이름 설정</h4><p><img data-src="/images/posts/passkey-login/02.png"></p><p>위 화면은 깃허브에서 패스키 등록 시 패스키에 대한 이름을 입력하도록 요구하는 단계입니다. 이와 같이 패스키 등록 시 사용자에게 등록하려는 인증 기기에 대한 이름을 입력하도록 요구하거나 사용자에게 기기에 대한 이름을 별도로 입력하지 않고 <strong>Authenticator 1</strong> 과 같이 현재 등록된 기기의 수를 토대로 기본값을 제공하고 사용자가 별도로 이름을 수정할 수 있도록 하는게 좋습니다.</p><h4 id="패스키-등록-수-제한"><a href="#패스키-등록-수-제한" class="headerlink" title="패스키 등록 수 제한"></a>패스키 등록 수 제한</h4><p>일반적으로 패스키로 등록할 수 있는 기기에 대한 제약은 필요하지 않습니다만 사용자가 너무 많은 패스키를 등록하는 것은 오히려 보안 상 좋지 않을 수 있습니다. 기본적으로 사용자에 대한 패스키는 10개 이내로 제한하고 정말로 사용자가 요구할 때 확장하는 것을 권장합니다. 예를 들어, 저와 같은 사용자는 삼성 갤럭시 스마트폰의 삼성 패스만 사용하여 패스키를 등록할 수 있습니다.</p><p><a href="https://www.corbado.com/assets/Passkeys-Developer-Cheatsheet.pdf">Passkeys Cheat Sheet for Developers</a>에서 사용자에게 더 나은 패스키를 제공하기 위한 방법에 대해서 찾아보세요.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;패스키-생성-알고리즘&quot;&gt;&lt;a href=&quot;#패스키-생성-알고리즘&quot; class=&quot;headerlink&quot; title=&quot;패스키 생성 알고리즘&quot;&gt;&lt;/a&gt;패스키 생성 알고리즘&lt;/h4&gt;&lt;p&gt;패스키 등록 시 PublicKeyCredentialCreati</summary>
      
    
    
    
    
    <category term="Passkey" scheme="https://kdevkr.github.io/tags/Passkey/"/>
    
    <category term="WebAuthn" scheme="https://kdevkr.github.io/tags/WebAuthn/"/>
    
  </entry>
  
  <entry>
    <title>패스키 로그인</title>
    <link href="https://kdevkr.github.io/passkey-login/"/>
    <id>https://kdevkr.github.io/passkey-login/</id>
    <published>2024-07-14T03:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.464Z</updated>
    
    <content type="html"><![CDATA[<p>패스키 로그인은 사용자 계정에 대한 비밀번호를 입력하지 않고 사용자 계정에 대해 지문이나 얼굴 인식 그리고 보안키 등을 사용해서 미리 인증 정보를 등록해놓고 사용자의 인증 기기를 사용해서 로그인을 수행하도록 제공하는 걸 말합니다. 패스키는 로그인 뿐만 아니라 <a href="https://aws.amazon.com/ko/about-aws/whats-new/2024/06/aws-identity-access-management-passkey-authentication-factor/?nc1=h_ls">아마존 웹 서비스</a>와 <a href="https://docs.github.com/ko/authentication/authenticating-with-a-passkey/signing-in-with-a-passkey">깃허브</a>처럼 2차 인증을 위해서도 도입될 수 있습니다. 이 글을 작성해보는 이유는 패스키 로그인에 대한 흐름은 생각보다 간단한데 패스키에 대한 표준에서 사용되는 용어와 구현 과정에서의 여러가지 이슈들이 많아보이기 때문입니다. 이제 패스키 로그인에 대해서 정리해보도록 하죠.</p><h4 id="패스키-로그인에서-등록과-인증의-흐름"><a href="#패스키-로그인에서-등록과-인증의-흐름" class="headerlink" title="패스키 로그인에서 등록과 인증의 흐름"></a>패스키 로그인에서 등록과 인증의 흐름</h4><p>패스키 로그인 시 등록과 인증 과정은 생각보다 간단합니다. 사용자는 본인이 사용할 수 있는 인증 기기에 발급한 패스키 정보를 RP 도메인에 대한 패스키를 등록하고 로그인 화면에서 시스템에서 제공하는 패스키 로그인을 사용해 인증 기기에 존재하는 패스키를 선택하여 사용자 계정에 대한 인증을 요청하고 승인받아 로그인을 완료합니다. 패스키를 등록하고 인증하는 과정에서 서버에서 제공받은 챌린지와 공개키에 대한 서명 정보를 제공함으로써 패스키를 사용하여 로그인을 지원하는 서버에서는 사용자에 대한 신원을 안전하게 증명(Attestation) 또는 검증(Assertion)할 수 있습니다. </p><blockquote><p>패스키 관련 표준에서 등록(Registration)과 인증(Authentication)에 대한 과정은 단순한 인증 과정이 아니라 하나의 중요한 의식이라는 관점으로 <strong>세레모니(Ceremony)</strong> 라고 표현합니다. 따라서, 패스키에 대한 여러가지 정보를 참고할 때 세레모니라는 단어가 나오면 과정이라고 이해하시면 됩니다.</p></blockquote><h4 id="패스키-등록을-위한-서비스-제공자"><a href="#패스키-등록을-위한-서비스-제공자" class="headerlink" title="패스키 등록을 위한 서비스 제공자"></a>패스키 등록을 위한 서비스 제공자</h4><p>패스키를 통해 신원을 관리하고 검증하는 주체인 서비스 제공자는 신뢰당사자(Relyting Party)라고 합니다. RP는 도메인을 의미하며 패스키 등록과 인증을 요청할때마다 챌린지(Challenge)를 받아가도록 요구합니다. RP에서 응답하는 챌린지는 난수로 이루어진 바이트 배열로 알수없는 식별자로 CSRF 토큰과 비슷한 용도로 사용됩니다. 또한, RP에 대한 아이디는 도메인으로 구성되기 때문에 클라이언트로부터 전달되는 패스키에 대한 공개키 인증 정보가 올바른 출처에 있음을 쉽게 확인할 수 있게 됩니다. 그러면 자바 애플리케이션 서버에서 RP를 구성해보도록 할까요?</p><pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    implementation <span class="token string">'com.yubico:webauthn-server-core:2.5.2'</span>    implementation <span class="token string">'com.yubico:webauthn-server-attestation:2.5.2'</span>    implementation <span class="token string">'com.yubico:yubico-util:2.5.2'</span><span class="token punctuation">&#125;</span></code></pre><p>먼저, 자바 애플리케이션에서 WebAuthn에 대한 Relyting Party를 구성하기 위해서 <a href="https://developers.yubico.com/java-webauthn-server/">java-webauthn-server</a> 라이브러리를 의존성에 추가해야합니다. 그리고 아래와 같이 RelyingPartyIdentity로 RP 도메인에 대한 신원을 정의하고 RelyingParty를 초기화하면 됩니다. CredentialRepository 는 패스키 등록과 인증 과정에서 이미 등록된 패스키 정보를 제공하기 위한 용도로 사용됩니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">RelyingParty</span> <span class="token function">generateRelyingParty</span><span class="token punctuation">(</span><span class="token class-name">PasskeyCredentialRepository</span> passkeyCredentialRepository<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">RelyingPartyIdentity</span> rpID <span class="token operator">=</span> <span class="token class-name">RelyingPartyIdentity</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">"kdev.ing"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"Mambo App"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token class-name">RelyingParty</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span>rpID<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">credentialRepository</span><span class="token punctuation">(</span>passkeyCredentialRepository<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">allowOriginSubdomain</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">origins</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"https://kdev.ing"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h5 id="🔥-SecurityError-The-RP-ID-“mambo”-is-invalid-for-this-domain"><a href="#🔥-SecurityError-The-RP-ID-“mambo”-is-invalid-for-this-domain" class="headerlink" title="🔥 SecurityError: The RP ID “mambo” is invalid for this domain"></a>🔥 SecurityError: The RP ID “mambo” is invalid for this domain</h5><pre class="language-bash" data-language="bash"><code class="language-bash">SecurityError: The RP ID <span class="token string">"mambo"</span> is invalid <span class="token keyword">for</span> this domain    at identifyAuthenticationError <span class="token punctuation">(</span>@simplewebauthn_browser.js?v<span class="token operator">=</span>db6ca826:278:14<span class="token punctuation">)</span>    at startAuthentication <span class="token punctuation">(</span>@simplewebauthn_browser.js?v<span class="token operator">=</span>db6ca826:325:11<span class="token punctuation">)</span>    Caused by: DOMException: The relying party ID is not a registrable domain suffix of, nor equal to the current domain.</code></pre><p>RP 서버에 대한 아이디는 WebAuthn 표준에 따라 반드시 도메인으로 구성되어야합니다. 그렇지 않은 경우 위와 같이 클라이언트 오류가 발생할 수 있습니다.</p><h5 id="RelyingParty-generateChallenge"><a href="#RelyingParty-generateChallenge" class="headerlink" title="RelyingParty.generateChallenge"></a>RelyingParty.generateChallenge</h5><p>RelyingParty의 startRegistartion 를 통해 패스키 등록에 대한 챌린지와 공개키 생성 옵션을 클라이언트에게 제공할 수 있는데 이때 포함되는 챌린지는 RelyingParty에 32바이트로 구성된 난수로 이루어진 바이트 배열로 구현되어있습니다.</p><pre class="language-java" data-language="java"><div class="caption"><span>RelyingParty.java</span></div><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">SecureRandom</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ByteArray</span> <span class="token function">generateChallenge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    random<span class="token punctuation">.</span><span class="token function">nextBytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ByteArray</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h4 id="패스키-등록을-위한-생성-옵션-발급"><a href="#패스키-등록을-위한-생성-옵션-발급" class="headerlink" title="패스키 등록을 위한 생성 옵션 발급"></a>패스키 등록을 위한 생성 옵션 발급</h4><p>RelyingParty의 startRegistration 매개변수에 StartRegistrationOptions를 전달함으로써 패스키 등록 시 사용될 챌린지와 생성 옵션인 PublicKeyCredentialCreationOptions를 만들 수 있습니다. PublicKeyCredentialCreationOptions의 toCredentialsCreateJson 함수는 RP 서버에서 클라이언트로 응답할 때 바이트 배열로 이루어져야하는 항목에 대해 Base64URL을 적용한 JSON으로 구성되도록 구현되어있으므로 쉽게 응답할 수 있습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">createUserHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchAlgorithmException</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> userHandle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token class-name">SecureRandom</span><span class="token punctuation">.</span><span class="token function">getInstanceStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextBytes</span><span class="token punctuation">(</span>userHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> userHandle<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/registration/challenge"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">startRegistration</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> httpSession<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">UserIdentity</span> userIdentity <span class="token operator">=</span> <span class="token class-name">UserIdentity</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"mambo"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">displayName</span><span class="token punctuation">(</span><span class="token string">"Mambo"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArray</span><span class="token punctuation">(</span><span class="token function">createUserHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">PublicKeyCredentialCreationOptions</span> publicKeyCredentialCreationOptions <span class="token operator">=</span> rp<span class="token punctuation">.</span><span class="token function">startRegistration</span><span class="token punctuation">(</span>                <span class="token class-name">StartRegistrationOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>userIdentity<span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">authenticatorSelection</span><span class="token punctuation">(</span><span class="token class-name">AuthenticatorSelectionCriteria</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                <span class="token punctuation">.</span><span class="token function">residentKey</span><span class="token punctuation">(</span><span class="token class-name">ResidentKeyRequirement</span><span class="token punctuation">.</span><span class="token constant">REQUIRED</span><span class="token punctuation">)</span>                                <span class="token punctuation">.</span><span class="token function">authenticatorAttachment</span><span class="token punctuation">(</span><span class="token class-name">AuthenticatorAttachment</span><span class="token punctuation">.</span><span class="token constant">CROSS_PLATFORM</span><span class="token punctuation">)</span>                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpSession<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"publicKeyCredentialCreationOptions"</span><span class="token punctuation">,</span> publicKeyCredentialCreationOptions<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> publicKeyCredentialCreationOptions<span class="token punctuation">.</span><span class="token function">toCredentialsCreateJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>UserIdentity의 id는 공개키 인증 정보에 포함되는 User Handle과 동일합니다. 패스키 표준에서는 사용자 계정에 대한 식별자를 그대로 이용하지 않고 별도로 난수로 이루어진 식별자를 사용하도록 요구하고 있습니다. 사용자 계정에 대해 유일한 식별자로 생성하는 로직을 구현하도록 하세요.</p></blockquote><h5 id="simplewebauthn-browser-startRegistration"><a href="#simplewebauthn-browser-startRegistration" class="headerlink" title="@simplewebauthn&#x2F;browser.startRegistration"></a>@simplewebauthn&#x2F;browser.startRegistration</h5><p>클라이언트에서는 아래와 같이 패스키 등록을 위해 챌린지를 요청하고 받은 결과를 startRegistartion의 매개변수에 전달함으로써 사용자에게 패스키 등록에 대한 대화상자를 표시해주고 전달받은 결과를 서버에 전달함으로써 패스키 등록을 완료하는 로직을 구현할 수 있습니다. 아래의 코드는 이미 등록된 패스키에 대한 오류에 대한 예외 처리가 없으므로 여러가지 예외 상황을 확인하고 알맞게 처리하도록 구현해야합니다.</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">registerPasskey</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> challenge  <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/registration/challenge'</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> registrationResponse <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">startRegistration</span><span class="token punctuation">(</span>challenge<span class="token punctuation">.</span>data<span class="token punctuation">.</span>publicKey<span class="token punctuation">)</span>    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/registration/verify'</span><span class="token punctuation">,</span> registrationResponse<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></code></pre><h4 id="패스키-검증-및-등록"><a href="#패스키-검증-및-등록" class="headerlink" title="패스키 검증 및 등록"></a>패스키 검증 및 등록</h4><p>Relying Party의 finishRegistartion 함수를 통해 클라이언트에서 전달한 패스키 정보가 올바르게 서명되어있는지를 검증하고 전달받은 정보에서 일부 항목을 패스키에 대한 데이터베이스에 저장하면 됩니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/registration/verify"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">finishRegistration</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> httpSession<span class="token punctuation">,</span>                                  <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">String</span> credential<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RegistrationFailedException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> credentialsCreateJson <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> httpSession<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"publicKeyCredentialCreationOptions"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpSession<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">"publicKeyCredentialCreationOptions"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">PublicKeyCredentialCreationOptions</span> publicKeyCredentialCreationOptions <span class="token operator">=</span>            <span class="token class-name">PublicKeyCredentialCreationOptions</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>credentialsCreateJson<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">PublicKeyCredential</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthenticatorAttestationResponse</span><span class="token punctuation">,</span> <span class="token class-name">ClientRegistrationExtensionOutputs</span><span class="token punctuation">></span></span> publicKeyCredential <span class="token operator">=</span>            <span class="token class-name">PublicKeyCredential</span><span class="token punctuation">.</span><span class="token function">parseRegistrationResponseJson</span><span class="token punctuation">(</span>credential<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">RegistrationResult</span> result <span class="token operator">=</span> relyingParty<span class="token punctuation">.</span><span class="token function">finishRegistration</span><span class="token punctuation">(</span>            <span class="token class-name">FinishRegistrationOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>publicKeyCredentialCreationOptions<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span>publicKeyCredential<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ByteArray</span> aaguid <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getAaguid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ByteArray</span> credentialId <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getKeyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ByteArray</span> userHandle <span class="token operator">=</span> publicKeyCredentialCreationOptions<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ByteArray</span> publicKey <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getPublicKeyCose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transports <span class="token operator">=</span> publicKeyCredential<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransports</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">AuthenticatorTransport</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> signatureCounter <span class="token operator">=</span> publicKeyCredential<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttestation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthenticatorData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSignatureCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Authenticator</span> authenticator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Authenticator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setCredentialId</span><span class="token punctuation">(</span>credentialId<span class="token punctuation">.</span><span class="token function">getBase64Url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setUserHandle</span><span class="token punctuation">(</span>userHandle<span class="token punctuation">.</span><span class="token function">getBase64Url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setAaguid</span><span class="token punctuation">(</span>aaguid<span class="token punctuation">.</span><span class="token function">getBase64Url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setPublicKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">.</span><span class="token function">getBase64Url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setSignatureCount</span><span class="token punctuation">(</span>signatureCounter<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setTransports</span><span class="token punctuation">(</span>transports<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setLastAccessTime</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">setCreatedAt</span><span class="token punctuation">(</span><span class="token class-name">OffsetDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> authenticatorRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>authenticator<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h5 id="계정-설정-내-패스키-표시"><a href="#계정-설정-내-패스키-표시" class="headerlink" title="계정 설정 내 패스키 표시"></a>계정 설정 내 패스키 표시</h5><p>패스키 등록 시 서버에 저장된 정보에는 사용자 친화적으로 표시할 수 있는 정보가 포함되어있지 않습니다. <a href="https://developers.google.com/identity/passkeys/ux/communicating-passkeys?hl=ko#what_information_to_use_to_create_a_passkey">패스키를 만드는 데 사용할 정보</a>나 <a href="https://developers.google.com/identity/passkeys/ux/user-interface-design?hl=ko">계정 설정 내 패스키 카드 표시</a>와 같은 정보들을 참고하여 패스키에 대해 아래와 같은 항목이 포함되도록 설계하는 것이 좋습니다.</p><ul><li>패스키에 대해 표시할 이름 (Nickname)</li><li>패스키가 마지막으로 사용된 시간 (Last Access Time)</li><li>패스키 인증 기기 유형 (AAGUID)</li></ul><p>패스키에 대해 표시할 이름을 설정하는 건 필수 사항은 아니지만 깃허브에서의 패스키 관리 시 이름을 설정할 수 있게 제공하는데 사용자 스스로 구분할 수 있게 지원해줄 수 있는 것 같습니다. 패스키 인증 기기 정보의 경우 AttestedCredentialData에 포함된 AAGUID를 통해 인증 기기를 제공하는 업체을 식별할 수 있는데 AAGUID는 일반적으로 사람이 인지할 수 있는 문자열은 아니므로 AAGUID 저장소의 <a href="https://github.com/passkeydeveloper/passkey-authenticator-aaguids/blob/main/aaguid.json">aaguid.json</a> 인증 장치의 유형에 대해서 이름이나 아이콘을 표시할 수 있기도 합니다.</p><h5 id="등록된-패스키-삭제"><a href="#등록된-패스키-삭제" class="headerlink" title="등록된 패스키 삭제"></a>등록된 패스키 삭제</h5><p><img data-src="/images/posts/passkey-login/01.png"></p><p>위 화면은 깃허브에서 사용자 계정에 등록했던 패스키를 삭제하려고 했을때 제공되는 메시지입니다. 패스키 관리 시 등록한 패스키를 삭제하면 되겠지만 고려해야할 부분이 있습니다. 서버에 등록된 패스키를 삭제한다고해서 사용자가 사용했던 인증 기기의 패스키 등록 정보는 삭제되지 않는다는 것입니다. 또한, 사용자가 인증 기기의 패스키를 삭제해버리는 경우 사용자 계정에 등록된 패스키는 무용지물이 되며 불필요하게 패스키 등록 정보로 남아있게 되어버립니다.</p><p>패스키 등록을 지원하는 인증 기기별로 자세한 패스키 삭제 가이드를 제공할 순 없으므로 사용자 계정에서 패스키를 삭제하더라도 패스키 로그인 시에는 패스키 옵션으로 표시될 수 있음을 알려주고 있는 것 같습니다. 다음은 자주 사용될만한 인증 기기에서의 패스키 삭제 방법이므로 참고해보세요.</p><ul><li>Google Passsword Manager: 브라우저 URL에 <a href="chrome://settings/passkeys">chrome:&#x2F;&#x2F;settings&#x2F;passkeys</a> 입력</li><li>iCloud Keychain: <a href="https://support.apple.com/ko-kr/guide/mac-help/mchl77e2cb66/mac">Mac 및 iCloud 키체인에서 패스키 또는 암호 제거하기</a></li><li>Chrome Profile: <a href="https://support.google.com/chrome/answer/13168025?hl=ko">Chrome에서 패스키 관리하기</a></li><li>Samsung Pass: Samsung Wallet → Samsung Pass → 로그인 정보 → 패스키</li></ul><h4 id="패스키-인증-요청에-대한-옵션-발급"><a href="#패스키-인증-요청에-대한-옵션-발급" class="headerlink" title="패스키 인증 요청에 대한 옵션 발급"></a>패스키 인증 요청에 대한 옵션 발급</h4><p>Relying Party의 startAssertion 함수를 통해 사용자 계쩡에 등록된 패스키에 대해 로그인할 수 있도록 챌린지를 발급할 수 있습니다. 이때, 매개변수로 전달할 StartAssertionOptions을 구성할 때 클라이언트는 사용자가 입력한 아이디를 요청 시 제공한다면 특정 사용자 계정에 대한 공개키만 조회하여 포함시킬 수 있습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/authentication/challenge"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">startAssertion</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> httpSession<span class="token punctuation">,</span>                             <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">StartAssertionOptions<span class="token punctuation">.</span>StartAssertionOptionsBuilder</span> builder <span class="token operator">=</span> <span class="token class-name">StartAssertionOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMinutes</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>username<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        builder<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">AssertionRequest</span> assertionRequest <span class="token operator">=</span> relyingParty<span class="token punctuation">.</span><span class="token function">startAssertion</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    httpSession<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"assertionRequest"</span><span class="token punctuation">,</span> assertionRequest<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> assertionRequest<span class="token punctuation">.</span><span class="token function">toCredentialsGetJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h5 id="패스키-검증-및-인증"><a href="#패스키-검증-및-인증" class="headerlink" title="패스키 검증 및 인증"></a>패스키 검증 및 인증</h5><p>Relying Party의 finishAssertion 함수를 통해 클라이언트에서 전달한 패스키 인증 정보를 신뢰할 수 있는지 확인할 수 있습니다. 인증 정보에 포함된 credentailId와 userHandle을 토대로 사용자 계정에 대해 로그인을 처리하면 됩니다.</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> startAuthentication <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@simplewebauthn/browser'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">passkeyLogin</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> challenge  <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/authentication/challenge'</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> authenticationResponse <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">startAuthentication</span><span class="token punctuation">(</span>challenge<span class="token punctuation">.</span>data<span class="token punctuation">.</span>publicKey<span class="token punctuation">)</span>    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/authentication/verify'</span><span class="token punctuation">,</span> authenticationResponse<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/authentication/verify"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">finishAssertion</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> httpSession<span class="token punctuation">,</span>                              <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">String</span> credential<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">AssertionFailedException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> assertionRequestJson <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> httpSession<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"assertionRequest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">AssertionRequest</span> assertionRequest <span class="token operator">=</span> <span class="token class-name">AssertionRequest</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>assertionRequestJson<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">PublicKeyCredential</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthenticatorAssertionResponse</span><span class="token punctuation">,</span> <span class="token class-name">ClientAssertionExtensionOutputs</span><span class="token punctuation">></span></span> publicKeyCredential            <span class="token operator">=</span> <span class="token class-name">PublicKeyCredential</span><span class="token punctuation">.</span><span class="token function">parseAssertionResponseJson</span><span class="token punctuation">(</span>credential<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">AssertionResult</span> result <span class="token operator">=</span> relyingParty<span class="token punctuation">.</span><span class="token function">finishAssertion</span><span class="token punctuation">(</span><span class="token class-name">FinishAssertionOptions</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>assertionRequest<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span>publicKeyCredential<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// todo: process authenticate</span>        <span class="token class-name">String</span> username <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ByteArray</span> credentialId <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getCredential</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCredentialId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ByteArray</span> userHandle <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getCredential</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h5 id="사용자-아이디-필드에-자동-완성-UI-표시"><a href="#사용자-아이디-필드에-자동-완성-UI-표시" class="headerlink" title="사용자 아이디 필드에 자동 완성 UI 표시"></a>사용자 아이디 필드에 자동 완성 UI 표시</h5><p>패스키 인증을 위해 startAuthentication를 호출할 때 useBrowserAutofill 매개변수를 설정하는 경우 mediation 옵션이 conditional로 지정되면서 사용자에게 바로 패스키 선택을 요구하는 대화상자를 표시하지 않고 브라우저마다 구현된 방식으로 자동 완성(조건부 UI)이 표시됩니다. 패스키 자동 완성을 위해 호출했다면 사용자 계정을 입력하는 필드의 autocomplete 속성에 webauthn 을 포함시키면 됩니다.</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Login.vue</span><span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">await</span> <span class="token function">processAutofill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">// passkey.js</span><span class="token keyword">import</span> <span class="token punctuation">&#123;</span>browserSupportsWebAuthnAutofill<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@simplewebauthn/browser'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">processAutofill</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">browserSupportsWebAuthnAutofill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">const</span> challenge <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/authentication/challenge'</span><span class="token punctuation">)</span>        <span class="token keyword">const</span> authenticationResponse <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">startAuthentication</span><span class="token punctuation">(</span>challenge<span class="token punctuation">.</span>data<span class="token punctuation">.</span>publicKey<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/passkey/authentication/verify'</span><span class="token punctuation">,</span> authenticationResponse<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>조건부 UI로 사용자에게 자동 완성을 제공할 때 패스키에 대한 프로미스가 계속 대기하는 상태로 진행하고 있는데요. 기존에 진행중인 패스키를 취소할 수 있도록 SimpleWebAuthn의 startAuthentication은 내부적으로 구현되어있으므로 신경 쓸 필요는 없습니다.</p></blockquote><hr><p>본 글을 작성하기 위해서 아래와 같은 정보들을 참고했습니다.</p><ul><li><a href="https://webauthn.io/">WebAuthn.io 데모 사이트</a></li><li><a href="https://webauthn.guide/">WebAuthn 가이드</a></li><li><a href="https://passkeys.dev/device-support/">Passkeys Device Support</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Authentication_API">WebAuthn: Web Authentication API</a></li><li><a href="https://webauthn.wtf/">What is WebAuthn?</a></li><li><a href="https://passkeys.dev/docs/intro/what-are-passkeys/">What are passkeys?</a></li><li><a href="https://webauthn.me/passkeys">Web Authentication and Passkeys</a></li><li><a href="https://www.corbado.com/assets/Passkeys-Developer-Cheatsheet.pdf">Passkeys Cheet Sheet</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;패스키 로그인은 사용자 계정에 대한 비밀번호를 입력하지 않고 사용자 계정에 대해 지문이나 얼굴 인식 그리고 보안키 등을 사용해서 미리 인증 정보를 등록해놓고 사용자의 인증 기기를 사용해서 로그인을 수행하도록 제공하는 걸 말합니다. 패스키는 로그인</summary>
      
    
    
    
    
    <category term="Passkey" scheme="https://kdevkr.github.io/tags/Passkey/"/>
    
    <category term="WebAuthn" scheme="https://kdevkr.github.io/tags/WebAuthn/"/>
    
  </entry>
  
  <entry>
    <title>Amazon SNS - FCM 모바일 푸시</title>
    <link href="https://kdevkr.github.io/amazon-sns-fcm-mobile-push/"/>
    <id>https://kdevkr.github.io/amazon-sns-fcm-mobile-push/</id>
    <published>2024-07-07T09:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.456Z</updated>
    
    <content type="html"><![CDATA[<p>PWA 앱에서 푸시 알림을 위해 FCM(Firebse Cloud Messaging)을 도입했다면 Amazon SNS의 모바일 푸시 알림으로 통합할 수 있다. Firebase Admin SDK 로도 쉽게 푸시 알림을 위한 메시지를 전송할 수 있지만 Amazon SNS에 등록된 플랫폼 애플리케이션을 통해 사용자 디바이스를 애플리케이션 앤드포인트로 관리하고 우리는 Amazon SNS에 등록된 플랫폼 엔드포인트를 통해 디바이스로 푸시 알림을 전달해보도록 하자.</p><h4 id="플랫폼-애플리케이션-생성-시-FCM-자격-증명-등록"><a href="#플랫폼-애플리케이션-생성-시-FCM-자격-증명-등록" class="headerlink" title="플랫폼 애플리케이션 생성 시 FCM 자격 증명 등록"></a>플랫폼 애플리케이션 생성 시 FCM 자격 증명 등록</h4><p><img data-src="/images/posts/amazon-sns-fcm-mobile-push/01.png"></p><p>FCM 푸시 알림 플랫픔을 사용하는 애플리케이션 생성 시 FCM 콘솔의 서비스 계정에서 발급받은 Firebase 서비스 계정의 비공개 키 정보를 등록해야 한다. Firebase Admin SDK 에서 사용중이었던 서비스 계정의 JSON 파일을 그대로 설정했다.</p><h4 id="애플리케이션-앤드포인트-생성-시-FCM-디바이스-토큰-등록"><a href="#애플리케이션-앤드포인트-생성-시-FCM-디바이스-토큰-등록" class="headerlink" title="애플리케이션 앤드포인트 생성 시 FCM 디바이스 토큰 등록"></a>애플리케이션 앤드포인트 생성 시 FCM 디바이스 토큰 등록</h4><p>플랫폼 애플리케이션에서 메시지를 전달할 엔드포인트는 하나의 식별할 수 있는 디바이스라고 생각하면 된다. 디바이스 토큰은 <a href="https://firebase.google.com/docs/cloud-messaging/js/client?hl=ko#access_the_registration_token">FCM 클라이언트 SDK로부터 디바이스 내에서 발급받은 토큰</a>을 입력하면 된다. 애플리케이션 엔드포인트 생성 후 메시지 게시를 통해 샘플 메시지를 전달해볼 수 있다.</p><pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"GCM"</span><span class="token operator">:</span> <span class="token string">"&#123; \"data\": &#123; \"title\": \"Hi!\", \"body\": \"Mambo?!\" &#125; &#125;"</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>Amazon SNS의 모바일 푸시 알림에서 FCM을 위한 메시지는 GCM 이라는 키로 사용합니다.</p></blockquote><p><img data-src="/images/posts/amazon-sns-fcm-mobile-push/02.png"></p><h4 id="Amazon-SNS-SDK-for-Java-V2로-메시지-게시"><a href="#Amazon-SNS-SDK-for-Java-V2로-메시지-게시" class="headerlink" title="Amazon SNS SDK for Java V2로 메시지 게시"></a>Amazon SNS SDK for Java V2로 메시지 게시</h4><p>웹 콘솔을 통해 FCM 메시지가 디바이스로 푸시 알림이 되었음을 확인했다면 Amazon SDK for Java v2를 사용해서 프로그래밍 방식으로 메시지를 전송해보도록 하자. 먼저, 아래와 같이 모바일 푸시 API를 사용하기 위한 Amazon SDK for Java v2 의존성을 추가하도록 하자.</p><pre class="language-groovy" data-language="groovy"><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    implementation <span class="token function">platform</span><span class="token punctuation">(</span><span class="token string">'software.amazon.awssdk:bom:2.26.16'</span><span class="token punctuation">)</span>    implementation <span class="token string">'software.amazon.awssdk:sns'</span><span class="token punctuation">&#125;</span></code></pre><p>의존성을 추가했다면 <a href="https://docs.aws.amazon.com/ko_kr/sns/latest/dg/mobile-push-api.html">모바일 푸시 API</a> 중 CreatePlatformEndpoint와 Publish를 사용해서 메시지를 게시하는 샘플 코드를 만들어볼 수 있다. </p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">SnsClient</span> snsClient <span class="token operator">=</span> <span class="token class-name">SnsClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">credentialsProvider</span><span class="token punctuation">(</span><span class="token class-name">ProfileCredentialsProvider</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">region</span><span class="token punctuation">(</span><span class="token class-name">Region</span><span class="token punctuation">.</span><span class="token constant">AP_NORTHEAST_2</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertDoesNotThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            <span class="token class-name">String</span> platformApplicationArn <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> fcmDeviceToken <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> endpointArn <span class="token operator">=</span> snsClient<span class="token punctuation">.</span><span class="token function">createPlatformEndpoint</span><span class="token punctuation">(</span><span class="token class-name">CreatePlatformEndpointRequest</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">platformApplicationArn</span><span class="token punctuation">(</span>platformApplicationArn<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">token</span><span class="token punctuation">(</span>fcmDeviceToken<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endpointArn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> fcmMessage <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token string">"Hi!"</span><span class="token punctuation">,</span> <span class="token string">"body"</span><span class="token punctuation">,</span> <span class="token string">"Mambo?!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> messageId <span class="token operator">=</span> snsClient<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token class-name">PublishRequest</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">messageStructure</span><span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"GCM"</span><span class="token punctuation">,</span> fcmMessage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">targetArn</span><span class="token punctuation">(</span>endpointArn<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">messageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"messageId: &#123;&#125;"</span><span class="token punctuation">,</span> messageId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span>messageId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>위 예제코드에서 메시지의 GCM 이 이스케이프된 JSON 문자열로 구성되어야함을 주의해야합니다.</p></blockquote><p><img data-src="/images/posts/amazon-sns-fcm-mobile-push/03.png" alt="PWA 앱에서의 푸시 알림 예시"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;PWA 앱에서 푸시 알림을 위해 FCM(Firebse Cloud Messaging)을 도입했다면 Amazon SNS의 모바일 푸시 알림으로 통합할 수 있다. Firebase Admin SDK 로도 쉽게 푸시 알림을 위한 메시지를 전송할 수 있지만</summary>
      
    
    
    
    
    <category term="FCM" scheme="https://kdevkr.github.io/tags/FCM/"/>
    
    <category term="SNS Mobile Push" scheme="https://kdevkr.github.io/tags/SNS-Mobile-Push/"/>
    
  </entry>
  
  <entry>
    <title>PWA 와 FCM 푸시 알림</title>
    <link href="https://kdevkr.github.io/pwa-fcm-web-push/"/>
    <id>https://kdevkr.github.io/pwa-fcm-web-push/</id>
    <published>2024-07-06T04:00:00.000Z</published>
    <updated>2024-10-14T14:25:59.464Z</updated>
    
    <content type="html"><![CDATA[<h4 id="PWA의-서비스-워커는-HTTPS를-요구"><a href="#PWA의-서비스-워커는-HTTPS를-요구" class="headerlink" title="PWA의 서비스 워커는 HTTPS를 요구"></a>PWA의 서비스 워커는 HTTPS를 요구</h4><p>PWA 앱에서 푸시 알림을 보내기 위해서는 사용자가 사이트 또는 앱에 대한 알림 권한을 허용해야하며 PWA 앱이 종료되어있어도 백그라운드 상태에서 동작하는 서비스 워커가 필요하다. Vite 기반으로 구성되어있는 프로젝트에서는 <a href="https://vite-pwa-org.netlify.app/">PWA Plugin for Vite</a>로 쉽게 PWA 설치 지원과 함께 서비스 워커를 등록할 수 있게 설정할 수 있다. 서비스 워커는 HTTPS 에서 동작해야하므로 개발 환경에서는 <a href="https://github.com/liuweiGL/vite-plugin-mkcert">vite-plugin-mkcert</a>가 도움이 될 수 있다.</p><h4 id="서비스-워커의-상태-변경을-고려하기"><a href="#서비스-워커의-상태-변경을-고려하기" class="headerlink" title="서비스 워커의 상태 변경을 고려하기"></a>서비스 워커의 상태 변경을 고려하기</h4><p>서비스 워커의 생명 주기를 이해하고 새로 설치되거나 업데이트되는 서비스 워커로 인해 메시지 수신이 원활하지 않을 수 있다는 점을 인지해야한다. <a href="https://developer.mozilla.org/ko/docs/Web/API/ServiceWorkerGlobalScope/skipWaiting">ServiceWorkerGlobalScope.skipWaiting</a> 이나 <a href="https://developer.mozilla.org/ko/docs/Web/API/Clients/claim">Clients::claim()</a>이 도움이 될 수도 있다.</p><h5 id="서비스-워커-파일이-firebase-messaging-sw-js-일-필요는-없다"><a href="#서비스-워커-파일이-firebase-messaging-sw-js-일-필요는-없다" class="headerlink" title="서비스 워커 파일이 firebase-messaging-sw.js 일 필요는 없다"></a>서비스 워커 파일이 firebase-messaging-sw.js 일 필요는 없다</h5><pre class="language-javascript" data-language="javascript"><div class="caption"><span>main.js</span></div><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>        <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MODE</span> <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">?</span> <span class="token string">'/sw.js'</span> <span class="token operator">:</span> <span class="token string">'/dev-sw.js?dev-sw'</span><span class="token punctuation">,</span>        <span class="token punctuation">&#123;</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MODE</span> <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">?</span> <span class="token string">'classic'</span> <span class="token operator">:</span> <span class="token string">'module'</span><span class="token punctuation">&#125;</span>    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">registration</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'register service worker'</span><span class="token punctuation">,</span> registration<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></code></pre><p>FCM 관련 일부 글에서 서비스 워커의 파일이 반드시 <code>firebase-messaing-sw.js</code> 이어야 한다고 언급하는데 잘못된 정보에 해당되며 FCM 메시지 수신을 위해서 PWA 앱에서 사용중인 <code>서비스 워커 내에 Firebase SDK를 초기화</code>하는게 중요한 부분이다. 위 코드와 같이 개발 환경에서는 <a href="https://vite-pwa-org.netlify.app/guide/development#injectmanifest-strategy">dev-sw.js</a>를 서비스 워커로 등록하여 사용할 수 있음을 보여준다.</p><h4 id="FCM-푸시-알림이-여러번-표시되는-문제-🔥"><a href="#FCM-푸시-알림이-여러번-표시되는-문제-🔥" class="headerlink" title="FCM 푸시 알림이 여러번 표시되는 문제 🔥"></a>FCM 푸시 알림이 여러번 표시되는 문제 🔥</h4><p><a href="https://github.com/kdevkr/mambo-box/blob/main/errors/2024-07-06.md">PWA 앱의 푸시 알림에서 FCM 메시지가 여러번 표시되는 문제</a>와 같이 백그라운드 상태에 있는 PWA 앱에서 푸시 알림이 여러번 표시되는 이유는 <a href="https://firebase.google.com/docs/cloud-messaging/js/receive?hl=ko">자바스크립트 클라이언트에서 메시지 수신</a>시 알림 메시지에 의한 기본 화면 표시에 대해 고려하지 않은 문제에 해당된다. 자바스크립트 클라이언트에서 커스텀 메시지로 푸시 알림을 제공하고 싶다면 서버에서는 알림 메시지가 포함되지 않은 데이터 메시지로 구성하여 전달해야한다.</p><h4 id="자바스크립트-클라이언트-API-키는-안전하다"><a href="#자바스크립트-클라이언트-API-키는-안전하다" class="headerlink" title="자바스크립트 클라이언트 API 키는 안전하다"></a>자바스크립트 클라이언트 API 키는 안전하다</h4><p>일반적으로 자바스크립트로 동작하는 SDK에 대한 키는 외부에 노출될 수 밖에 없으므로 FCM 메시지를 수신할 수 있는 최소한의 권한을 보유한다. FCM 콘솔에서 <a href="https://developer.chrome.com/blog/web-push-interop-wins?hl=ko#introducing_vapid_for_server_identification">웹 푸시 인증서</a>는 <code>최대 2개까지 발급</code>할 수 있으므로 <code>VAPID</code>를 환경별로 나누어서 사용하는 것도 좋아보인다. 더 자세한 내용은 <a href="https://firebase.google.com/docs/projects/api-keys?hl=ko">Firebase용 API 키 사용 및 관리에 대해 알아보기</a>를 참고하여 고려해보도록 하자.</p><h4 id="시스템-규모에-따른-토큰-관리-전략"><a href="#시스템-규모에-따른-토큰-관리-전략" class="headerlink" title="시스템 규모에 따른 토큰 관리 전략"></a>시스템 규모에 따른 토큰 관리 전략</h4><p><a href="https://firebase.google.com/docs/cloud-messaging/manage-tokens?hl=ko">FCM 등록 토큰 관리를 위한 권장사항</a>과 <a href="https://firebase.google.com/docs/cloud-messaging/scale-fcm?hl=ko">FCM 메시지를 대규모로 전송할 때의 권장사항</a>를 참고하여 시스템에 저장되어 메시지 전송 시 사용되는 토큰의 수를 관리하는게 필요하다. 서버에서는 사용자가 PWA 앱을 삭제하는지를 감지하여 더이상 토큰이 사용되지 않는지 알 수 없다. FCM 메시지 전송 시 무제한으로 발송할 수는 없으므로 오랫동안 사용되지 않거나 만료된 토큰은 주기적으로 삭제하는 작업이 있어야한다.</p><h4 id="iOS의-PWA-앱-지원-여부"><a href="#iOS의-PWA-앱-지원-여부" class="headerlink" title="iOS의 PWA 앱 지원 여부"></a>iOS의 PWA 앱 지원 여부</h4><p>안드로이드와 크롬 브라우저와 달리 iOS 또는 사파리 브라우저에 따라 PWA 앱 설치 및 푸시 API를 지원하는지의 여부가 다름을 인지해야한다. 또한, 홈 화면으로 추가되는 앱은 반드시 기본으로 제공되는 사파리 브라우저로 실행되는 것도 중요한 부분에 해당된다.</p><ul><li><a href="https://developer.apple.com/documentation/usernotifications/sending-web-push-notifications-in-web-apps-and-browsers">Safari 16.1 and macOS 16.4 iOS &amp; iPadOS 부터 Push API 지원</a></li><li><a href="https://developer.apple.com/support/dma-and-apps-in-the-eu/">유럽 연합의 국가에서 iOS 17.4 이상에서 PWA 지원 종료</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;PWA의-서비스-워커는-HTTPS를-요구&quot;&gt;&lt;a href=&quot;#PWA의-서비스-워커는-HTTPS를-요구&quot; class=&quot;headerlink&quot; title=&quot;PWA의 서비스 워커는 HTTPS를 요구&quot;&gt;&lt;/a&gt;PWA의 서비스 워커는 HTTPS를 </summary>
      
    
    
    
    
    <category term="FCM" scheme="https://kdevkr.github.io/tags/FCM/"/>
    
    <category term="PWA" scheme="https://kdevkr.github.io/tags/PWA/"/>
    
  </entry>
  
</feed>
