<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Mambo</title>
  
  <subtitle>Today I Learned 🔥</subtitle>
  <link href="https://kdevkr.github.io/atom.xml" rel="self"/>
  
  <link href="https://kdevkr.github.io/"/>
  <updated>2022-05-07T03:34:32.512Z</updated>
  <id>https://kdevkr.github.io/</id>
  
  <author>
    <name>Mambo</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CSV, Comma Separated Values</title>
    <link href="https://kdevkr.github.io/csv/"/>
    <id>https://kdevkr.github.io/csv/</id>
    <published>2022-05-07T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.512Z</updated>
    
    <content type="html"><![CDATA[<p>데이터 기반의 웹 애플리케이션에서 데이터를 제공하는 방식은 다양합니다. 개발자들이 REST API를 통해 클라이언트와 서버 간의 데이터를 전달할 때 JSON 형식으로 주고받는 것을 선호하는 것과 별개로 시스템을 이용하는 일반 사용자들은 주로 사용하는 <a href="https://support.microsoft.com/ko-kr/office/excel%EC%97%90%EC%84%9C-%EC%A7%80%EC%9B%90%ED%95%98%EB%8A%94-%ED%8C%8C%EC%9D%BC-%ED%98%95%EC%8B%9D-0943ff2c-6014-4e8d-aaea-b83d51d46247">엑셀 프로그램에서 읽을 수 있는 XLS 또는 XLSX</a>로 제공하기를 선호합니다.</p><p>개발자들은 엑셀 프로그램에서 사용할 수 있는 XLS 또는 XLSX 파일 형식으로 데이터를 제공하는 것을 좋아하지 않습니다. 엑셀 프로그램이 데이터를 활용하기 위한 많은 기능을 제공하여 편리한 방법이기는 하지만 자바에서 엑셀 파일 형식으로 저장하기 위해서 사용하는 Apach POI와 같은 라이브러리에서 엑셀 파일 형식에 따른 제약이나 성능 이슈가 있기 때문입니다. 엑셀 파일 형식에서 가장 기본적인 제약사항은 단일 시트에 대한 최대 행수 제한입니다. 그리고 엑셀 파일에 데이터를 기록하는 방식에 따라 서버에 부하가 발생할 수 있습니다.</p><p>현재 조직에서 개발하는 시스템은 시계열 데이터를 수집하고 이를 활용할 수 있는 기능을 제공하므로 고객이 등록한 시계열 데이터를 다운로드할 수 있는 방법도 제공하고 있습니다. 이 요건은 시계열 데이터를 집계하여 정제된 데이터를 제공하는 것이 아니므로 고객이 보유하는 에너지 자원 및 데이터 항목만큼 파일에 포함되어야하는 데이터의 건수가 기하급수적으로 늘어날 수 있으며 그에 대한 규모를 예상하기 힘듭니다. 아무리 자바 애플리케이션에서 SXSSF로 스트리밍 방식으로 엑셀 파일에 데이터를 기록하거나 어떠한 동작을 최소화하도록 코드를 최적화한다고해도 처리해야하는 데이터 건수가 많음으로 발생하는 소요 시간 및 애플리케이션 부하에 대한 이슈는 해결되지 않습니다.</p><p>이러한 대용량 데이터를 다운로드하는 요건에 대해서는 불필요한 작업을 최소하하는 방안이 중요합니다. 시계열 데이터에 대해 빠른 성능을 보여주는 시계열 데이터베이스에서 애플리케이션으로 전달되는 데이터의 양을 최대한 줄일 수 있도록 해야합니다. 시계열 데이터 특성 상 같은 시간대에 대한 데이터 항목들을 열로 표현할 수 있도록 <a href="https://code.kx.com/q/kb/pivoting-tables/">테이블을 피봇하는 방법</a>이 있으므로 이를 활용하면 엑셀 파일에 기록해야하는 데이터행 수를 줄일 수 있습니다.</p><p>피봇 테이블을 도입하더라도 엑셀 파일이 읽을 수 있는 바이너리 파일을 만드는 것이므로 일반적인 텍스트 파일을 기록하는 작업보다 많은 부하가 발생합니다. CSV는 <a href="https://datatracker.ietf.org/doc/html/rfc4180">RFC 4180</a> 표준으로 되어있는 데이터 형식으로 테이블 형식으로 되어있는 데이터를 표현하기에 적합한 방법입니다. 표준으로 정의되어있기에 대부분의 스프레드시트 프로그램에서는 CSV 파일에 포함된 데이터를 불러올 수 있는 기능을 제공합니다. 시스템에서 사용하는 시계열 데이터베이스에서 <a href="https://code.kx.com/q/learn/tour/csvs/">테이블을 CSV로 변환할 수 있는 방법</a>도 제공하고 있으므로 애플리케이션에서 데이터를 가공하는 별도의 작업을 하지 않고 고객에게 데이터를 전달할 수 있습니다.</p><p>시스템의 파일 다운로드 표준은 CSV이고 XLS 및 XLSX로도 다운로드할 수 있도록 인터페이스는 제공합니다만 실제로 소요되는 시간을 비교하면 극단적으로 CSV의 다운로드에 소요되는 시간이 적은 것을 확인할 수 있었습니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;데이터 기반의 웹 애플리케이션에서 데이터를 제공하는 방식은 다양합니다. 개발자들이 REST API를 통해 클라이언트와 서버 간의 데이터를 전달할 때 JSON 형식으로 주고받는 것을 선호하는 것과 별개로 시스템을 이용하는 일반 사용자들은 주로 사용</summary>
      
    
    
    
    
    <category term="RFC 4180" scheme="https://kdevkr.github.io/tags/RFC-4180/"/>
    
    <category term="CSV" scheme="https://kdevkr.github.io/tags/CSV/"/>
    
  </entry>
  
  <entry>
    <title>재부팅 시 Crontab에 의해 프로세스를 자동으로 실행하기</title>
    <link href="https://kdevkr.github.io/autorun-process-using-crontab-on-reboot/"/>
    <id>https://kdevkr.github.io/autorun-process-using-crontab-on-reboot/</id>
    <published>2022-05-06T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.512Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>🤪 재부팅 시 Crontab에 의해서 프로세스가 자동으로 실행되지 않은 이유</p></blockquote><p>크론탭(Crontab)은 리눅스에서 일정된 시점이나 주기적으로 명령어 또는 쉘 스크립트를 실행할 수 있는 스케줄러 또는 타이머입니다. 이전에 작성한 <a href="/maintaining-process-execution-in-linux">리눅스에서 프로세스 실행 유지하기</a>에서도 크론탭으로 프로세스를 실행하는 방법에 대해서 다루어본 적이 있습니다. 서버 시스템이 예기지 않은 상황에 의해서 재부팅되거나 종료되어 수동으로 실행될 수도 있으므로 Systemd 또는 Crontab으로 프로세스를 자동으로 실행할 수 있다고 공유했었습니다. </p><p>그런데 얼마전에 특정 고객 환경의 서버들을 고객이 지진과 같은 예기치 않은 장애로 인해서 서버가 재부팅되는 상황에서 프로세스가 자동으로 실행될 수 있음을 테스트하던 중 서버가 재부팅될 때 자동으로 실행되었어야할 프로세스들이 시작되지 않는다는 피드백이 전달되었습니다. 실제로 시스템이 재부팅될 때 프로세스가 자동으로 실행되지 않았음을 확인하였고 크론탭과 쉘 스크립트에 대한 이해가 부족했다는 점을 확인했습니다.</p><p>저는 서버에 대한 부분을 전문적으로 관리하는 서버 엔지니어는 아니므로 필요한 부분을 검색한 후 정리된 바를 토대로 작업을 할 수 밖에 없습니다. Crontab에 의해서 프로세스가 자동으로 실행되기 위해서 검토하지 않은 부분이 무엇인지를 공유해보겠습니다.</p><h2 id="Crontab"><a href="#Crontab" class="headerlink" title="Crontab"></a>Crontab</h2><p>크론탭에 대한 메뉴얼 페이지를 살펴보면 <a href="https://man7.org/linux/man-pages/man5/crontab.5.html#EXTENSIONS">EXTENSIONS</a>으로 시스템이 재부팅되었을때 실행할 수 있도록 시간을 지정할 수 있는 별칭이 있다는 것을 확인할 수 있습니다. <a href="https://phoenixnap.com/kb/crontab-reboot">Crontab Reboot: How to Execute a Job Automatically at Boot</a>와 같은 글에서도 간단하게 @reboot을 사용하면 시스템이 부팅되었을때 스크립트를 실행할 수 있다고 정리되어있습니다. 그래서 단순히 @reboot를 지정하기만 하면 시스템이 재부팅되었을때 정상적으로 쉘 스크립트가 실행될 것이라고 예상하였습니다.</p><h3 id="Interactive-and-Non-Interactive-Shell"><a href="#Interactive-and-Non-Interactive-Shell" class="headerlink" title="Interactive and Non-Interactive Shell"></a>Interactive and Non-Interactive Shell</h3><p>제가 검토하지 않은 부분은 쉘 스크립트가 실행되는 방식이 다양하다는 것에 있습니다. 일반적으로 SSH 접속으로 실행되는 쉘은 로그인 쉘입니다. 로그인 쉘 및 Bash로 실행되었을때는 다음과 같은 파일들이 자동으로 로드된다는 특징이 있습니다.</p><ul><li>&#x2F;etc&#x2F;profile</li><li>~&#x2F;.bash_profile</li><li>~&#x2F;.bashrc</li><li>~&#x2F;.profile</li></ul><p>일반적으로 쉘 스크립트를 작성하고 실행해보았을때는 로그인 쉘을 통해 실행하기 때문에 실행 스크립트에서 참조하는 많은 환경변수가 올바르게 지정되어있다는 것이 보장됩니다. 그러나 Crontab에 의해서 자동으로 실행되는 스크립트는 로그인 쉘에서 수행되는 것이 아니므로 환경변수가 제대로 지정된다는 것을 보장할 수 없는 문제를 간과한 것입니다.</p><h3 id="사용자-기본-쉘"><a href="#사용자-기본-쉘" class="headerlink" title="사용자 기본 쉘"></a>사용자 기본 쉘</h3><p>쉘 스크립트에 셔뱅(#!)을 Bash로 지정하더라도 크론탭에 의해서 실행되는 쉘 유형은 사용자의 기본 쉘로 고정됩니다. SSH 접속 후 로그인 쉘 상태로 스크립트를 실행하면 현재 쉘이 Bash인 것을 확인할 수 있습니다. 그러나, 리부트 명령을 수행하고나서 크론탭에 의해서 실행된 스크립트에 대한 로그를 확인하면 Bash가 아닌 기본 쉘이라고 기록되어있습니다.</p><pre class="language-shell" data-language="shell"><code class="language-shell">.&#x2F;a.shSHELL: &#x2F;bin&#x2F;bash# reboot with #!&#x2F;bin&#x2F;bashtail a.logSHELL: &#x2F;bin&#x2F;sh# reboot with #!&#x2F;bin&#x2F;bash --logintail a.logSHELL: &#x2F;bin&#x2F;sh# crontab -e &amp;&amp; SHELL&#x3D;&#x2F;bin&#x2F;bashSHELL: &#x2F;bin&#x2F;bash</code></pre><p>위 결과를 토대로 쉘 스크립트에서 셔뱅과 함께 로그인 쉘 옵션을 활성화하는 것과 상관없이 사용자의 기본 쉘을 변경하거나 크론탭 설정 시 쉘을 지정하도록 하여야한다는 것을 확인할 수 있습니다. </p><h3 id="환경변수-파일"><a href="#환경변수-파일" class="headerlink" title="환경변수 파일"></a>환경변수 파일</h3><p>쉘 스크립트에서 로그인 쉘 옵션(–login)을 지정하는 것은 정해진 환경변수 파일을 로드하기 위한 방법입니다. 다만, 로그인 쉘이 적용되었기에 다음과 같이 ~&#x2F;.bashrc는 로드되지 않는 것을 확인할 수 있습니다.</p><pre class="language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash --logintail a.logLoaded &#x2F;etc&#x2F;profileLoaded .profileSHELL: &#x2F;bin&#x2F;bash</code></pre><blockquote><p>크론탭에 의해서 쉘 스크립트가 실행될 때에는 Non-Interactive Shell 방식으로 동작한다는 점을 인지해야합니다. 이는 로그인 쉘 옵션을 지정해도 .bashrc 파일이 로드되지 않았음을 확인할 수 있습니다.</p></blockquote><p>결과적으로, 재부팅시에도 크론탭에 의해서 쉘 스크립트를 통해 프로세스가 자동으로 실행되기 위해서는 다음의 방안 중에서 환경 변수가 올바르게 로드될 수 있도록 별도의 작업을 수행해야합니다.</p><ol><li>.profile에 환경 변수를 지정한 경우 –login 옵션 고려</li><li>.bashrc 또는 .bash_profile에 환경 변수를 지정한 경우 파일을 직접 명시하여 로드</li><li>프로세스 실행 시 필요한 환경변수를 수동으로 지정하는 스크립트 로드</li></ol><p>크론탭에 의해서 쉘 스크립트가 정상적으로 실행되지 않는다면 알맞은 쉘과 환경변수가 올바르게 로드되는 방식을 취하였는지 검토하시기 바랍니다.</p><h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul><li><a href="https://unix.stackexchange.com/a/46856">Difference between Login Shell and Non-Login Shell?</a>  </li><li><a href="https://www.geeksforgeeks.org/shell-scripting-interactive-and-non-interactive-shell/">Shell Scripting – Interactive and Non-Interactive Shell</a>  </li><li><a href="https://man7.org/linux/man-pages/man5/crontab.5.html">crontab(5) — Linux manual page</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;🤪 재부팅 시 Crontab에 의해서 프로세스가 자동으로 실행되지 않은 이유&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;크론탭(Crontab)은 리눅스에서 일정된 시점이나 주기적으로 명령어 또는 쉘 스크립트를 실행할 수 있는 </summary>
      
    
    
    
    
    <category term="Autorun" scheme="https://kdevkr.github.io/tags/Autorun/"/>
    
    <category term="Crontab" scheme="https://kdevkr.github.io/tags/Crontab/"/>
    
    <category term="Interactive Shell" scheme="https://kdevkr.github.io/tags/Interactive-Shell/"/>
    
  </entry>
  
  <entry>
    <title>서비스 상태를 모니터링하는 이유</title>
    <link href="https://kdevkr.github.io/service-status/"/>
    <id>https://kdevkr.github.io/service-status/</id>
    <published>2022-05-04T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.516Z</updated>
    
    <content type="html"><![CDATA[<p>현재 조직의 문제점은 일하는데 있어서 체계적으로 정해진 가이드가 없다는 점입니다. 고객마다 인프라 환경도 다르며 동일한 시스템을 다양한 방식으로 배포를 요구하기도 합니다. 심지어는 시스템을 구성하는 여러가지 인스턴스의 지표를 수집하거나 로그를 남기는 등의 방식도 정해 일해오던 조직이 아닙니다. 시스템에 대한 지표나 로그등을 어떤 기준에서 남기는 것이 정해지지 않는다면 추후 시스템 장애가 발생했을때 원인을 검토하고 분석하는데 어려움이 많습니다. 실제로 APM을 도입하지 않는 시스템에서 소 잃고 외양간 고치듯이 사업팀에서는 시스템의 문제를 파악하기 위한 정보를 알 수 있냐는 문의를 하는 것도 지켜보았습니다.</p><p>분야 또는 시장의 요건에 따라 필요한 시스템을 개발하는 것을 넘어서 시스템이 정상적으로 동작하도록 유지하는 노력도 중요한 부분입니다. 시스템을 설계하고 운영되는 인프라 영역을 구성할 때에는 시스템을 이용하는 규모에 맞게 수행합니다. 트래픽이 적더라도 시스템을 다수의 서버로 트래픽을 분산할 수 있도록 구성할 수는 있으나 인프라에 대한 비용이 비효율적인 방법입니다.</p><blockquote><p>IT 분야에서 서비스나 시스템을 운영하는데 들어가는 비용이 상당히 높습니다. 작은 규모의 조직일수록 비용에 더 민감할 수 밖에 없습니다. </p></blockquote><p>아무튼 시스템을 운영하기 위한 규모도 다르고 시스템을 구성하는 애플리케이션의 언어 뿐만 아니라 인프라 영역에 대한 구성도 다양합니다. 모든 서비스와 시스템이 동일하게 만들어지고 같은 방식으로 운영되지 않습니다. 그리고 정상적으로 동작하던 시스템이 어떠한 요구사항에 의한 수정에 의해 예상하지 못했던 장애의 원인을 만들기도 합니다. 그런데 중요하게 생각해야될 부분은 시스템을 만들고 운영하는 조직이 일하는 시간이 아닐 때에도 인터넷이 접속되는 환경이라면 언제 어디서든 서비스를 이용할 수 있다는 점입니다. 시스템이 제공하는 기능을 정상적으로 이용하지 못하는 시간이 길어질수록 고객은 사용중인 서비스나 시스템에 대한 신뢰를 잃게 됩니다. 다음은 구글에 시스템 오류라는 키워드로 검색을 하여 수 많은 오류로 인한 장애와 고객의 불만에 대해 알리는 기사들입니다.</p><ul><li><a href="https://www.edaily.co.kr/news/read?newsId=01092246629281144&mediaCodeNo=257">쿠팡, ‘마이 페이지’ 오류…“불편끼쳐 드려 죄송”</a></li><li><a href="https://imnews.imbc.com/news/2021/econo/article/6169999_34887.html">카카오톡 내부 시스템 오류로 장애…”긴급 점검 중”</a></li><li><a href="https://www.donga.com/news/Society/article/all/20210716/107987824/1">카카오톡 잔여백신 예약 ‘무한로딩’…당국 “시스템 오류 해결”</a></li><li><a href="https://www.koreapost.co.kr/news/articleView.html?idxno=61208">위메프, 새벽 중 시스템 오류로 지급된 5만 포인트 미회수 결정</a></li><li><a href="https://biz.newdaily.co.kr/site/data/html/2022/01/24/2022012400113.html">네이버, 연이은 접속 오류… 보상은 ‘미미’</a></li><li><a href="https://m.mk.co.kr/news/it/view/2021/12/1219484/">네이버페이 이용자 자산정보 유출…시스템 오류</a></li><li><a href="https://www.topstarnews.net/news/articleView.html?idxno=14686520">“불편 드린 점 사과”…음원 사이트 멜론(Melon), 실시간 차트→탐색 시스템 오류 발생</a></li><li><a href="https://www.thedailypost.kr/news/articleView.html?idxno=86942">혁신 아이콘 카카오의 ‘민낯’…국내 3위 다음 ‘먹통’ 브랜드 이미지 ‘실추’</a></li><li><a href="https://www.mk.co.kr/news/society/view/2022/04/327578/">전국 고속버스 발권 시스템 1시간 20분 가량 장애(종합)</a></li><li><a href="https://biz.sbs.co.kr/article/20000059393">다음 메일 6시간 넘게 ‘먹통’…내부 시스템 오류 때문</a></li><li><a href="https://fetv.co.kr/news/article.html?no=113781">“하필 일요일 점심 때” 쿠팡이츠 시스템 오류</a></li><li><a href="https://www.edaily.co.kr/news/read?newsId=01787606632294808&mediaCodeNo=257">롯데렌탈 ‘그린카’, 서버 오류로 앱 먹통…”고객 불만 폭주”</a></li><li><a href="https://www.mk.co.kr/news/economy/view/2022/01/82495/">국세청 연말정산 오류로 821명 개인정보 유출</a></li></ul><blockquote><p>제가 이용하지 않는 서비스들에서 생각보다 많은 시스템 장애가 발생한 것을 확인할 수 있습니다. </p></blockquote><p>위처럼 시스템 장애에 대한 원인은 다양합니다. 당시에 심각한 사고였던 <a href="https://m.etnews.com/20211025000215">KT 통신 장애</a>와 같이 인터넷 트래픽을 전달하는 장비의 설정 문제로 일부 네트워크 환경이 모두 마비되는 혼돈이 발생할 수도 있습니다. 이러한 문제라면 서버 인스턴스가 정상적이고 애플리케이션 코드에도 문제가 없더라도 인프라 영역의 장애이기 때문에 예상할 수 없는 장애입니다. 심지어는 클라우드 인프라 서비스를 활용해서 시스템을 운영하게 되는 시대이므로 <a href="https://www.inews24.com/view/1353037">클라우드 서비스 조차도 시스템 장애의 발생 가능성이 없는 것은 아닌점</a>도 인지해야합니다. 그래서 시스템을 만들고 운영하는 조직에서도 시스템이 정상적으로 동작할 수 있도록 고객과 같은 외부 환경에서 지속적으로 서비스 상태를 체크하고 모니터링하여 서비스에 대한 가용성을 유지하는데 노력해야합니다. 실제로 아래와 같이 자신들이 제공하는 서비스 기능에 대한 상태 정보를 제공하는 페이지를 제공하는 곳이 꽤 많습니다.</p><ul><li><a href="https://www.githubstatus.com/">Github Status</a></li><li><a href="https://status.slack.com/">Slack System Status</a></li><li><a href="https://status.spring.io/">Spring Status</a></li><li><a href="https://developers.naver.com/notice/apistatus/">Naver API Status</a></li></ul><blockquote><p>서비스 상태 정보를 제공하는 이유는 서비스 가용성을 유지하여 고객에게 신뢰성을 제공하기 위함입니다.</p></blockquote><p>조직에서 만든 시스템을 자체적으로 하나의 플랫폼으로 운영했다면 시스템 모니터링에 대한 중요성을 공유하고 시스템을 구성하는 각 인스턴스들의 <a href="https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/cloudwatch-monitoring.html">지표 모니터링</a> 뿐만 아니라 <a href="https://www.datadoghq.com/">Datadog</a>와 같은 상용 모니터링 솔루션 도입을 검토했을 것이라 생각합니다. A 라는 고객은 자체적으로 서버 인프라를 구축하고 관리하고 시스템 개발과 유지보수만 위임하고, B 라는 고객은 시스템 개발 및 유지보수 그리고 서버 인프라에 대한 관리도 할 수 있도록 권한을 부여해주기도 합니다. A 고객은 스스로의 경험에 따라 <a href="https://www.zabbix.com/">Zabbix</a>로 서버 인프라를 모니터링하도록 구축했으며 B 라는 고객은 아마존 웹 서비스의 <a href="https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/cloudwatch-monitoring.html">클라우드 와치 지표 모니터링</a>과 여러가지 로그가 S3에 저장되도록 구성합니다.</p><blockquote><p>B 고객은 대기업 규모로 자체 가이드가 존재하지만 현재 조직에 공유된 사항은 없으므로 최소한의 설정으로 구성하고 피드백을 받아서 추가 조치를 하고 있습니다. 고객마다 보안을 신경쓰는 부분이나 수준도 다릅니다.</p></blockquote><p>떠오르는 <a href="https://www.datadoghq.com/">Datadog</a>과 같은 상용 모니터링 솔루션을 도입해보면 좋겠지만 생각보다 비용이 상당히 비싼것으로 보입니다. 개인적으로 오픈소스 모니터링 솔루션인 <a href="https://prometheus.io/">Promethues</a>와 <a href="https://github.com/louislam/uptime-kuma">Uptime Kuma</a>같은 오픈소스 모니터링 도구를 활용해서 간단하게나마 <a href="/struggle-with-unknown-service-failures/">서비스 장애의 원인을 찾기위한 시도</a>에 활용해보고 있습니다. 실제로 근무 시간이 아닌 시간대에 시스템의 응답 시간이 늘어남을 확인할 수 있던 부분을 통해서 예상하지 못했던 원인을 찾게되면서 모니터링의 중요성을 다시한번 알게되는 경험을 하였습니다.</p><p><img data-src="https://images.mysetting.io/upload/user_image/2021/f3240207-fe1e-472b-bdb8-508b1332d8f6.jpeg?d=512x"></p><p>우리는 시스템을 개발하는데 그치지 않고 시스템을 정상적으로 운영하는 것을 유지하는데 많은 노력이 필요한 것 같습니다. 조직에서 정해진 방식이 없더라도 누군가는 시도해보고 중요성을 공유해야할 것으로 보입니다. 조직 세미나에서 모니터링 중요성에 대한 내용을 전달해보려고 준비해야겠습니다.</p><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;현재 조직의 문제점은 일하는데 있어서 체계적으로 정해진 가이드가 없다는 점입니다. 고객마다 인프라 환경도 다르며 동일한 시스템을 다양한 방식으로 배포를 요구하기도 합니다. 심지어는 시스템을 구성하는 여러가지 인스턴스의 지표를 수집하거나 로그를 남</summary>
      
    
    
    
    
    <category term="Service Status" scheme="https://kdevkr.github.io/tags/Service-Status/"/>
    
    <category term="Uptime" scheme="https://kdevkr.github.io/tags/Uptime/"/>
    
    <category term="Synthetic Monitoring" scheme="https://kdevkr.github.io/tags/Synthetic-Monitoring/"/>
    
  </entry>
  
  <entry>
    <title>서비스 장애의 원인을 찾아가기 위한 여러가지 시도</title>
    <link href="https://kdevkr.github.io/struggle-with-unknown-service-failures/"/>
    <id>https://kdevkr.github.io/struggle-with-unknown-service-failures/</id>
    <published>2022-05-01T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.516Z</updated>
    
    <content type="html"><![CDATA[<p>현재 조직에서 하나의 시스템을 여러 고객이 보유한 환경에서 이용할 수 있도록 전환하다보니 자체적으로 운영 시 정상적으로 동작했던 시스템에서 여러가지 서비스 장애가 발생하였고 이에 대한 원인을 파악하기 힘들어서 스트레스까지 받는 상황이 벌어졌습니다. 여러가지 서비스 장애의 원인을 찾아가기 위해 시도한 여러가지 방법에 대해서 기록하려고 합니다. 조직에서 만드는 서비스가 규모가 작은 시스템일지라도 수 많은 고객의 요구사항으로 인해 많은 기능이 수정되고 추가됨에 따라서 사이드 이펙트로 인한 장애가 지속적으로 발생하였고 심지어는 이유를 쉽게 파악할 수 없는 인프라로 인한 문제 또는 여러가지 기술에 관해서 문제를 일으키기도 했습니다. 우리가 흔히 이용하는 지하철에서도 임베디드형으로 보이는 윈도우 XP가 계속해서 재부팅하고 있다거나 블루스크린 화면을 보여주는 경우를 간간히 경험할 수 있습니다. 얼마전에는 공영 주차장의 사전 정산기 시스템에 오류가 발생해서 재부팅을 요구하는 알림창을 보여주었으나 터치스크린의 먹통으로 인해 고객 입장에서 할 수 있는 방안은 없었습니다. 이처럼 개발자 입장에서 서비스를 만들어도 시스템을 실제로 이용하는 고객의 입장에서 지속적으로 서비스를 이용할 수 있는 가용성을 유지하는 것도 굉장히 중요한 부분이라고 생각됩니다.</p><h2 id="서비스-장애"><a href="#서비스-장애" class="headerlink" title="서비스 장애"></a>서비스 장애</h2><p>서비스 장애는 애플리케이션 코드에 의해서만 발생하지 않습니다. 요구사항을 반영하기 위해서 코드를 수정하고 추가한 개발자의 실수부터 시작으로 시스템을 구성하는 인프라에서도 예상하지 못한 문제가 발생합니다. 이와같이 서비스 장애는 정말 다양한 영역에서 발생하기 때문에 이러한 장애에 대한 경험이 없다면 쉽게 파악하기 힘들고 해결해나가는 과정이 어려울 수 있습니다. 저는 현재 조직에서 어떤 장애를 경험하였을까요?</p><ol><li>AWS S3 SDK의 크레덴셜 만료</li><li>쿼츠 스케줄러에 의한 스레드 무한 증식</li><li>KDB+ 시계열 데이터베이스 프로세스가 요청을 처리할 수 없음</li></ol><blockquote><p>사소한 문제를 포함한 수 많은 장애중에서 대표적인 이슈는 위와 같습니다.</p></blockquote><h3 id="AWS-S3-SDK-크레덴셜-만료"><a href="#AWS-S3-SDK-크레덴셜-만료" class="headerlink" title="AWS S3 SDK 크레덴셜 만료"></a>AWS S3 SDK 크레덴셜 만료</h3><p>주 애플리케이션 서버와 별개로 사용자의 요청을 직접적으로 처리하지는 않지만 별도의 백그라운드 작업을 수행하는 모듈 서버에서 아마존 웹 서비스의 S3 SDK를 사용하는 코드에서 크레덴셜 만료로 인해 특정 스케줄 동작 시 오류가 발생하는 이슈가 확인되었습니다. EC2 인스턴스에 IAM Role을 지정하면 EC2 메타데이터에 의해 크레덴셜을 애플리케이션에서 사용할 수 있는데요. 기본적으로는 크레덴셜 프로바이더 체인에 의해서 여러가지 방식으로 크레덴셜을 가져오도록 코드를 작성합니다. 애플리케이션에서 사용하는 크레덴셜이 자동으로 갱신되는 옵션은 <a href="https://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/java-dg-roles.html">SDK 이용 시 InstanceProfileCredentailsProvider 또는 체인을 생성자로 전달해야만 활성화</a>된다는 정보가 있습니다.</p><blockquote><p>The automatic credentials refresh happens only when you use the default client constructor, which creates its own InstanceProfileCredentialsProvider as part of the default provider chain, or when you pass an InstanceProfileCredentialsProvider instance directly to the client constructor. If you use another method to obtain or pass instance profile credentials, you are responsible for checking for and refreshing expired credentials.</p></blockquote><p>위 정보를 토대로 모듈 서버의 코드를 검수한 결과 공통 모듈에서 정의된 크레덴셜을 가져오는 유틸 클래스로부터 크레덴셜 프로바이더 체인을 가져와서 S3 인스턴스를 생성한 것이 아닌 크레덴셜을 프로바이더에 의해 발급하고 전달하여 사용했던 것을 확인하였습니다. 이는 리팩토링 과정에서 검수되지 않은 개발자의 명백한 실수이며 애플리케이션에서 크레덴셜이 자동으로 갱신되기 위해서는 InstanceProfileCredentialsProvider가 포함된 프로바이더 체인을 사용해야한다는 정보를 숙지하게 되었던 장애 경험이었습니다.</p><h3 id="쿼츠-스케줄러에-의한-스레드-무한-증식"><a href="#쿼츠-스케줄러에-의한-스레드-무한-증식" class="headerlink" title="쿼츠 스케줄러에 의한 스레드 무한 증식"></a>쿼츠 스케줄러에 의한 스레드 무한 증식</h3><p>애플리케이션 배포 후 정상적으로 동작하던 애플리케이션이 사용자의 요청을 처리할 수 없는 상태가 되어버리는 문제를 확인하였습니다. 현재 조직은 모니터링 솔루션을 도입해서 사용해오던 조직은 아닙니다. 다만, 프로메테우스 및 그라파나 조합으로 모니터링 시스템을 구축하는 많은 글을 보고나서 개인적으로 사내 서버에 시스템을 구축해놓고 사용해왔는데요. 프로메테우스는 기본적으로 직접 HTTP 요청을 통해 지표를 수집하는 방식이므로 외부에서 접근이 불가능하도록 되어있는 애플리케이션의 지표를 수집하기 위해서 <a href="https://kdevkr.github.io/using-pushgateway-to-monitor-private-network-instance/">Promethues Pushgateway</a>로 지표를 전달하도록 에이전트를 실행해놓고 모니터링을 시작했습니다. 해당 현상이 다시 발생한 시점에서 수집된 지표를 그라파나 대시보드를 통해 확인해본 결과 스레드의 수가 점점 증가하는 것을 보았고 스프링 부트 액추에이터의 스레드 덤프 엔드포인트를 통해 스레드를 분석해보니 SMS 발송 및 발송 상태 확인을 위한 스케줄에 의한 스레드가 수 없이 생성된 것을 확인했습니다. 해당 스케줄의 코드를 검토해본 결과 쿼츠 스케줄러 동작 방식을 고려하지 않고 스케줄 잡을 구현한 클래스에서 별도의 스레드를 생성하도록 코드가 작성되어 있는 것을 확인하게 되었습니다. 이 경험을 통해 쿼츠 스케줄러에 의해 스케줄이 동작할 때 이미 만들어져있는 빈 클래스를 사용하지 않고 스케줄러에 의해 동적으로 생성되어 처리된다는 점을 확인하게 되었습니다. </p><h3 id="KDB-시계열-데이터베이스-프로세스가-요청을-처리할-수-없음"><a href="#KDB-시계열-데이터베이스-프로세스가-요청을-처리할-수-없음" class="headerlink" title="KDB+ 시계열 데이터베이스 프로세스가 요청을 처리할 수 없음"></a>KDB+ 시계열 데이터베이스 프로세스가 요청을 처리할 수 없음</h3><p>가장 크리티컬한 장애입니다. KDB+ 시계열 데이터베이스는 국내에서는 사용하지 않는 것처럼 보이는 상용 시계열 데이터베이스로써 KDB+ 프로세스가 요청을 처리할 수 없는 상태가 되나 프로세스가 종료되거나 별도로 프로세스에 의해 로그가 남는 것이 없으므로 이 문제에 대해 기술적인 도움을 요청하기에도 어려운 부분이었습니다. 프로세스가 사용자의 요청을 처리할 수 없는 상태가 되는 원인을 검토하기 위해서 여러가지 방법을 도입했습니다. </p><ol><li>애플리케이션 슬로우 쿼리 로그</li><li>서비스 상태 모니터링 솔루션</li></ol><p>첫번째 방법은 애플리케이션으로 요청되는 KDB 쿼리 중 많은 시간이 소요되는 것들을 슬랙 채널로 메시지를 전송하는 것입니다. 그런데 수 많은 요청이 메시지 채널로 전달되는 문제가 확인되었습니다. 눈에는 보이지 않았지만 생각보다 많은 요청들이 밀리는 현상이 있었던 부분입니다. 두번째 방법은 Synthetic Monitoring라고 하는 서비스 상태 모니터링 솔루션을 도입하는 것이었습니다. 조직에서 일하지 않는 시간에도 서비스가 정상적으로 동작하는 상태인지를 확인하기 위한 방법으로 이전 프로메테우스를 통한 지표 모니터링과는 관점이 다릅니다. </p><p><img data-src="/images/posts/struggle-with-unknown-service-failures/uptime-kuma-01.png"></p><p>위는 서비스 상태 모니터링 도입 후 확인된 KDB+ 시계열 데이터베이스에 대한 연결 상태를 나타내는 지표입니다. 새벽 시간대에 응답 시간이 상당히 높아짐을 확인할 수 있었고 간간히 시계열 데이터베이스에 대한 연결 상태를 확인할 수 없게 됨을 확인할 수 있습니다. 특정 고객 환경에서 발생하는 현상이었으므로 해당 시간대에 어떤 요청을 수행하는 게 있는지 확인해보니 외부 업체에서 데이터를 수집하기 위해서 순간적으로 수 많은 API 요청을 하는 것을 알게 되었습니다. 해당 업체가 데이터를 조회할 때 많은 기간을 조회하면서 복수로 조건을 전달할 수 있음에도 불구하고 한 건씩 요청하다보니 서버에 많은 부하가 발생하게 된 부분입니다.</p><blockquote><p>위와 같은 부분은 A예상하지 못한 API 부하이므로 작은 시스템 규모 상 디도스라고 자체 판단하여 API를 호출을 줄이도록 요청하였습니다.</p></blockquote><p><img data-src="/images/posts/struggle-with-unknown-service-failures/uptime-kuma-02.png"></p><p>API 요청 방식을 변경하고나서 응답 시간이 상당히 줄었으나 그대로 높다고 판단할 수 있는 지표입니다. 해당 업체가 사용하는 API에서 내부적으로 수행하는 KDB+ 쿼리를 검토해보니 다른 쿼리에 비해 상당히 성능이 느린점을 확인하였고 데이터 조회 및 불필요한 연산을 줄이는 방법을 채택하여 쿼리를 개선하고나서 현재는 다음과 같은 응답 시간을 보여주고 있습니다.</p><p><img data-src="/images/posts/struggle-with-unknown-service-failures/uptime-kuma-03.png"></p><blockquote><p>위의 결과를 보여주는 KDB+ 시계열 데이터베이스의 쿼리 최적화는 임시적인 대안일 뿐 프로세스가 기본적으로 사용자의 요청을 순차적으로 처리한다는 부분을 확인하게 되어 이를 개선할 수 있는 방안을 지속적으로 검토하고 있습니다.</p></blockquote><p>이러한 장애에 대한 경험 공유는 현재 조직에는 이롭지 않은 부분일 수 있습니다. 그러나 개인적인 입장에서는 이러한 경험을 토대로 더 서비스를 성장할 수 있도록 만들어 갈 수 있다고 생각하는 바입니다. 많은 개발자가 자신이 경험한 문제와 어떻게 해결하였는지를 공유했으면 하는 바램입니다.</p><h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul><li><a href="https://techblog.woowahan.com/4886/">우아~한 장애대응 - 우아한형제들 기술블로그</a></li><li><a href="https://engineering.linecorp.com/ko/blog/line-failure-reporting-and-follow-up-process-culture/">LINE의 장애 보고와 후속 절차 문화 - LINE Engineering</a></li><li><a href="https://tech.inflab.com/202201-event-postmortem/">2022년 1월 100% 할인 이벤트 장애 부검 - 인프런</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;현재 조직에서 하나의 시스템을 여러 고객이 보유한 환경에서 이용할 수 있도록 전환하다보니 자체적으로 운영 시 정상적으로 동작했던 시스템에서 여러가지 서비스 장애가 발생하였고 이에 대한 원인을 파악하기 힘들어서 스트레스까지 받는 상황이 벌어졌습니다</summary>
      
    
    
    
    
    <category term="Synthetic Monitoring" scheme="https://kdevkr.github.io/tags/Synthetic-Monitoring/"/>
    
    <category term="Service Failure" scheme="https://kdevkr.github.io/tags/Service-Failure/"/>
    
  </entry>
  
  <entry>
    <title>KDB Tick</title>
    <link href="https://kdevkr.github.io/kdb-tick/"/>
    <id>https://kdevkr.github.io/kdb-tick/</id>
    <published>2022-04-30T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.512Z</updated>
    
    <content type="html"><![CDATA[<p>에너지 분야는 나노초 또는 밀리초 단위의 시계열 데이터가 빠르게 생성되는 특수한 시장입니다. 시계열 데이터는 금융(Financial) 시장에서부터 중요성이 부각되었으나 이제는 다양한 분야에서 발생하고 이를 활용한 많은 서비스가 만들어지고 있습니다. 최소한 초 단위로 만들어지는 시계열 데이터를 빠르게 등록하고 조회할 수 있는 것을 목적으로하는 시계열 데이터베이스의 입지도 중요해지고 있고 많은 오픈소스 시계열 데이터베이스 솔루션도 만들어지고 있습니다. 현재 조직에서는 해외 금융 분야에서 어느정도 입지를 보이고 있는 시계열 데이터베이스인 KDB+를 도입하여 서비스에 사용중입니다. 라이센스 비용이 생각보다 비싸기는 하지만 고객들이 보유하는 데이터를 빠르게 수집하고 등록하기 위해서는 어쩔수 없는 선택이기도 합니다. </p><h2 id="KDB"><a href="#KDB" class="headerlink" title="KDB+"></a>KDB+</h2><p><a href="https://kx.com/blog/what-makes-time-series-database-kdb-so-fast/">What Makes Time-Series Database kdb+ So Fast?</a>  </p><p>KX Systems의 블로그 또는 <a href="https://code.kx.com/q/">Kdb+ and q documentation</a> 사이트에서 제공하는 정보를 토대로 KDB+ 프로세스에 대해서 간단하게 이해하고 활용해볼 수 있습니다. 더 나아가서는 <a href="https://code.kx.com/q/wp/">White Paper</a>를 통해서 KDB+ 프로세스를 더 효율적으로 사용하기 위한 방안을 확인할 수 있습니다. 본 글에서는 KDB+ 시계열 데이터베이스를 사용하기 위해 최소한 알아야할 부분을 다룹니다.</p><h3 id="데이터베이스-구조"><a href="#데이터베이스-구조" class="headerlink" title="데이터베이스 구조"></a>데이터베이스 구조</h3><p>KDB+ 프로세스에서 데이터는 기본적으로 테이블이라는 변수에 저장되며 메모리에 유지됩니다. 그러나, 서버의 메모리 자원은 한정적이므로 모든 데이터를 메모리에 유지하기에는 현실적으로 불가능합니다. KDB+ 프로세스가 사용할 수 있는 메모리가 부족하게되면 <code>&#39;wsfull</code> 오류를 보고하고 프로세스는 종료됩니다. 프로세스가 종료되면 메모리에 저장된 데이터가 모두 유실되므로 이를 보완하기 위한 방법이 필요합니다.</p><p>KDB+ 시계열 데이터베이스는 서버 메모리 자원보다 큰 데이터를 저장하기 위해서 디스크 파일을 활용합니다. 테이블의 데이터 규모에 따라 단일 바이너리 파일로 기록하거나 테이블의 컬럼에 대한 데이터를 <a href="https://code.kx.com/q/database/#splayed-table">각 컬럼 이름을 가진 파일을 가지는 폴더</a>로 저장합니다. 더 나아가서는 <a href="https://code.kx.com/q4m3/14_Introduction_to_Kdb+/#1432-partition-domain">숫자 또는 날짜와 같은 가상의 파티션</a>을 두어서 더 효율적으로 사용자가 데이터를 쿼리할 수 있도록 지원합니다.</p><h4 id="스플레이-테이블"><a href="#스플레이-테이블" class="headerlink" title="스플레이 테이블"></a>스플레이 테이블</h4><p>스플레이 테이블(Splayed Table)는 심볼과 같은 기호가 없는 완전히 열거된 테이블이어야합니다. 테이블에 심볼 형식의 컬럼이 존재한다면 <a href="https://code.kx.com/q/kb/splayed-tables/#enumerating-symbol-columns">Enumerating symbol columns</a>에서처럼 심볼 데이터가 sym 파일이라고하는 별도의 파일에 열거된 상태로 테이블을 저장해야함을 인지해야합니다.</p><h4 id="파티션-테이블"><a href="#파티션-테이블" class="headerlink" title="파티션 테이블"></a>파티션 테이블</h4><p>일반적으로 KDB+ 프로세스에서 스플레이 테이블을 그대로 사용하기보다는 가상의 파티션 폴더 밑에 두어서 <a href="https://code.kx.com/q/database/#partitioned-table">파티션 테이블</a>을 구성하여 로드하도록 구성합니다. 파티션 테이블(Partitioned Table)은 KDB+ 시계열 데이터베이스에서 일반적으로 구성하는 티커플랜트 아키텍처에서 HDB 프로세스를 구성하기 위해서 사용하므로 반드시 이해해야할 부분입니다.</p><ul><li><a href="https://code.kx.com/q4m3/14_Introduction_to_Kdb%2B/#142-splayed-tables">Splayed Tables</a>  </li><li><a href="https://code.kx.com/q4m3/14_Introduction_to_Kdb+/#143-partitioned-tables">Partitioned Tables</a>  </li><li><a href="https://code.kx.com/q/wp/data-management/#attributes-on-splayed-partitioned-tables">Attributes on splayed partitioned tables</a></li></ul><blockquote><p>파티션 테이블의 각 스플레이 테이블에 `p# 또는 `g# 속성을 적용하여 저장하는 것은 파일 데이터를 로드하여 사용하는 HDB 프로세스에 대한 쿼리 최적화를 수행할 수 있도록 지원하는 부분으로 필요에 따라 적용해야할 수 있습니다.</p></blockquote><h3 id="프로세스-통신"><a href="#프로세스-통신" class="headerlink" title="프로세스 통신"></a>프로세스 통신</h3><p>KDB+ 시계열 데이터베이스는 사용자 요청을 순차적으로 처리하는 단일 스레드를 사용하는 프로세스입니다. 아키텍처적인 관점에서는 단일 프로세스를 실행하여 활용하기보다는 용도와 목적에 맞는 여러개의 프로세스를 실행하고 <a href="https://code.kx.com/q/learn/startingkdb/ipc/#interprocess-communications">프로세스 간 통신(IPC)</a>를 통해 서로 유기적인 요청과 응답을 통해 원하는 결과를 제공할 수 있도록 구성하게 됩니다.</p><p>일반적으로 다음과 같이 <a href="https://code.kx.com/q/ref/hopen/#one-shot-request">One-shot request</a> 형태로 사용할 수 있습니다.</p><pre class="language-q" data-language="q"><code class="language-q"><span class="token symbol">`::5011</span> <span class="token string">"trade"</span><span class="token symbol">`::5011</span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>trade<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token verb operator">::</span><span class="token punctuation">)</span></code></pre><blockquote><p>다른 프로세스로 다수의 요청을 수행하는 경우에는 hopen 및 hclose를 통해 명시적으로 소켓을 열고 닫는것이 더 효율적입니다. 장시간 소켓을 열어두고 사용하는 것은 다양한 문제를 야기한 경험이 있으므로 개인적으로 추천하지 않습니다.</p></blockquote><h2 id="틱-아키텍처"><a href="#틱-아키텍처" class="headerlink" title="틱 아키텍처"></a>틱 아키텍처</h2><p>KDB+ 시계열 데이터베이스를 학습하는 단계에서는 단일 프로세스로도 충분합니다. 그러나, 실제로 시스템을 운용하기 위해서는 다수의 프로세스로 구성된 <a href="https://code.kx.com/q/architecture/">아키텍처</a>를 도입해야할 필요성이 있습니다. KDB+ 시계열 데이터베이스 시스템을 구성하는 가장 일반적인 아키텍처는 티커플랜트이며 금융 시장에서 사용하기 용이하도록 구성됩니다.</p><h3 id="티커플랜트"><a href="#티커플랜트" class="headerlink" title="티커플랜트"></a>티커플랜트</h3><p>티커플랜트(Tickerplant)는 데이터를 수집하기 위한 진입점을 제공하는 프로세스로 데이터 등록 함수에 대한 요청을 <strong>TP 로그</strong> 파일에 기록하여 시스템이 예기치 않은 상황으로 문제가 발생했을 때 복구할 수 있는 방안을 제공합니다. 또한, <a href="https://cloud.google.com/pubsub/docs/overview?hl=ko">Pub&#x2F;Sub</a>으로 데이터 피드 구독자로 등록되어있는 프로세스로 등록된 데이터를 전달하고 삭제함으로써 티커플랜트가 메모리 사용을 최소화할 수 있도록하여 경량 프로세스로 구동됩니다.</p><h3 id="실시간-데이터"><a href="#실시간-데이터" class="headerlink" title="실시간 데이터"></a>실시간 데이터</h3><p>실시간 데이터베이스(Realtime DB) 프로세스는 티커플랜트 프로세스에 데이터 피드 구독자로 등록되는 클라이언트 중 하나이며 티커플랜트로부터 전달받은 데이터를 메모리에 유지합니다. 그리고 티커플랜트가 전달하는 <strong>EOH(End of hour) 또는 EOD(End of day)</strong> 이벤트를 받아서 메모리에 유지했던 데이터를 현재 시간 또는 일자에 대한 파티션 테이블로 기록하고 다시 티커플랜트로부터 데이터 수신이 가능하도록 준비합니다.</p><blockquote><p>EOH 또는 EOD 이벤트가 발생하는 시점에는 메모리에 있는 데이터를 파일로 저장해야하므로 데이터 규모에 따라 CPU 연산 및 디스크 I&#x2F;O 작업에 대한 부하가 야기될 수 있습니다. 따라서, 메모리에 상주되는 데이터의 규모를 예상하고 서버 성능을 결정해야합니다.<br>KDB+ 프로세스가 파일로 기록하는 것은 디스크 I&#x2F;O 성능에 의존하므로 RDB 프로세스에 대한 병목 현상을 최소화하기 위해서는 높은 I&#x2F;O 성능을 가지는 스토리지를 고려하는게 좋습니다.</p></blockquote><h3 id="과거-파티션-데이터"><a href="#과거-파티션-데이터" class="headerlink" title="과거 파티션 데이터"></a>과거 파티션 데이터</h3><p>과거 파티션 데이터베이스(Historical DB)는 RDB 프로세스가 파티션 테이블 형태의 폴더로 기록한 과거 데이터를 로드하여 사용자 쿼리에 대한 조회 및 결과를 제공할 수 있도록 지원합니다. 데이터 규모 및 서버 자원에 따라 시간 또는 일자별 파티션으로 구성되므로 시스템이 쿼리를 수행하기에 효율적인 구조를 가지도록 고려해야합니다. 예를 들어, 시간별 파티션을 구성하는 경우에는 원하는 기간에 대한 시간 폴더의 데이터만 활용하므로 메모리를 효율적으로 사용할 수 있습니다. 그러나, 사용자 쿼리에 대한 조회 범위가 많아질수록 디스크 I&#x2F;O 작업을 수행해야하는 비효율적인 부분으로 인해 오히려 조회 시간이 늘어날 수 있습니다.</p><blockquote><p>KDB+ 프로세스는 기본적으로 순차처리임을 인지해야하며 많은 파티션을 조회하는 쿼리가 자주 요청될 가능성이 있다면 하나의 프로세스에서 시간 및 일자별 파티션을 동시에 사용할 수 있도록 지원하지 않으므로 일자별 파티션을 구성하는 별도의 HDB 프로세스를 도입하는 것을 고려해야합니다.</p></blockquote><p>사용자 요청에 대한 쿼리가 여러개의 파티션을 조회해야하는 작업이라면 <a href="https://code.kx.com/q/basics/cmdline/#-s-secondary-threads">프로세스 실행 시 지정된 보조 스레드</a>를 통해서 파티션별 조회를 병렬로 수행하도록 프로시저를 작성하여 쿼리 소요 시간을 어느정도는 최적화할 수 있습니다. 꽤 많은 쿼리가 병렬 작업을 수행하는 코드를 도입함으로써 극단적으로 쿼리 수행시간이 줄어듬을 확인할 수 있었습니다. 일반적인 케이스를 예를 들자면 단일 스레드 및 순차 처리에 의해 200ms가 소요되는 프로시저가 병렬 연산 작업 및 비효율적인 반복 작업을 수행하는 방식을 개선하고서 30ms가 소요되도록 개선되었습니다.</p><blockquote><p>개인적인 쿼리 경험에 의하면 데이터 조회에 대한 반복 작업을 최소화하는 것을 고려하고 데이터 조회시에는 병렬 작업을 수행하는 것이 효율적인지를 검토하는게 좋습니다. 그리고 일반적으로 사용되는 키워드 보다 더 적은 시간이나 메모리를 사용할 수 있는 방식을 사용하는 것이 중요합니다.</p></blockquote><p>예를 들어, Left Join을 반복 수행해야하는 경우라면 다음과 같이 연결하여 수행하도록 작성할 수 있습니다.</p><pre class="language-q" data-language="q"><code class="language-q">R<span class="token verb operator">:</span>A <span class="token keyword">lj</span> B<span class="token punctuation">;</span>R<span class="token verb operator">:</span>R <span class="token keyword">lj</span> C<span class="token punctuation">;</span>R<span class="token verb operator">:</span>R <span class="token keyword">lj</span> D<span class="token punctuation">;</span>R<span class="token verb operator">:</span><span class="token punctuation">(</span><span class="token keyword">lj</span><span class="token adverb function">/</span><span class="token punctuation">)</span><span class="token punctuation">(</span>A<span class="token punctuation">;</span>B<span class="token punctuation">;</span>C<span class="token punctuation">;</span>D<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="장애-및-보완"><a href="#장애-및-보완" class="headerlink" title="장애 및 보완"></a>장애 및 보완</h2><p>이제까지 경험했던 장애 또는 현재 경험하고 있는 부분을 공유하고 어떻게 보완할 수 있을까를 정리합니다.</p><h3 id="순차-처리로-인한-병목-현상"><a href="#순차-처리로-인한-병목-현상" class="headerlink" title="순차 처리로 인한 병목 현상"></a>순차 처리로 인한 병목 현상</h3><p>KDB+ 프로세스는 기본적으로 싱글 스레드로 동작하므로 <code>모든 동기 요청을 순차적으로 처리한다는 제약</code>이 있습니다. 그래서 트랜잭션을 지원하지 않더라도 현재 사용자의 요청에 대한 작업 결과가 다음 요청에 반영됨을 보장합니다. 그러나, 현재 수행중인 요청에 대한 작업이 길어질수록 다른 요청이 대기해야하는 시간이 많아질 수 있습니다. KDB+ 프로세스의 구성이 복잡하고 각 요청에 대한 쿼리가 복잡해짐에 따라서 빠르게 요청되는 쿼리가 순차적으로 밀리는 현상으로 인하여 많은 어려움을 경험하고 있습니다. 사용자 요청에 대한 쿼리 최적화는 일시적인 대안일 뿐이며 결론적으로는 아키텍처적인 관점에서 다음의 정보를 고려해야합니다.</p><ul><li><a href="https://code.kx.com/q/kb/multithreaded-input/">Multithreaded input queue mode</a>  </li><li><a href="https://code.kx.com/q/kb/deferred-response/">Deferred response</a> </li><li><a href="https://code.kx.com/q/wp/gateway-design/">Common design principles for kdb+ gateways</a></li><li><a href="https://code.kx.com/q/wp/query-routing/">Query Routing: A kdb+ framework for a scalable, load balanced system</a></li></ul><blockquote><p>현재 조직에서는 위의 방안들은 검토하였으나 여러가지 제약이나 이해하기 힘든 부분으로 인하여 KDB+ 시스템을 구성하는 각 프로세스에 대한 의존성을 분산하는 작업을 먼저 시도해보기로 결정했습니다. 다수의 프로세스가 서로 유기적으로 통신하면서 발생하는 병목 현상을 최소화하도록 재구성하는게 목적입니다.</p></blockquote><h3 id="단일-디스크-I-x2F-O-작업으로-인한-병목-현상"><a href="#단일-디스크-I-x2F-O-작업으로-인한-병목-현상" class="headerlink" title="단일 디스크 I&#x2F;O 작업으로 인한 병목 현상"></a>단일 디스크 I&#x2F;O 작업으로 인한 병목 현상</h3><p>하나의 서버에 KDB+ 프로세스를 여러개 구성하더라도 특정 프로세스에서 디스크 I&#x2F;O 작업을 수행하는 경우 동일한 폴더나 파일에 대한 작업을 수행해야하는 경우 일시적으로 대기하는 병목 현상이 야기될 수 있습니다. 파티션에 저장된 데이터가 정렬되지 않았다거나 주요 컬럼에 속성이 부여되지 않은 부분을 위해 파티션을 보정하는 프로세스가 작업중일때 동일한 파티션 폴더를 로드해야하는 HDB 프로세스에서 사용자 요청에 대한 작업이 일시적으로 많이 소요되는 문제를 경험했습니다.</p><blockquote><p>티커플랜트 아키텍처에서는 현재 시간 또는 일자에 대한 시계열 데이터가 등록되어야하지만 과거에 대한 시계열 데이터가 실시간으로 등록됨에 따라 올바른 파티션으로 데이터를 병합하는 작업으로 인해 디스크 I&#x2F;O로 인한 병목 현상이 야기되고 있습니다. 데이터 연동을 시작한 특정 고객이 가지고 있던 과거 데이터를 한번에 등록하게 됨으로써 이로 인해 프로세스에 대한 요청이 느려짐이 보고되고 있습니다.</p></blockquote><h3 id="프로세스-의존성으로-인한-멈춤-현상"><a href="#프로세스-의존성으로-인한-멈춤-현상" class="headerlink" title="프로세스 의존성으로 인한 멈춤 현상"></a>프로세스 의존성으로 인한 멈춤 현상</h3><p><img data-src="https://code.kx.com/q/img/architecture.png"></p><p>KDB+ 시스템 아키텍처는 다수의 프로세스가 유기적으로 통신하며 시스템을 구성한다고 하였습니다. 간단하게 실행되었던 시스템이 여러가지 이유에 의해서 별도의 프로세스가 추가됨에 따라서 시간 또는 일자별 파티션을 사용하는 HDB 프로세스들이 하나의 RDB 프로세스와 동일한 별도의 프로세스를 의존함에 따라서 서로 요청이 병목되어 프로세스가 요청을 처리중인데도 불구하고 프로세스가 멈추는 것 같아 보이는 현상을 확인했습니다. 각 HDB 프로세스들이 실시간 데이터 조회를 위해서 실시간 데이터를 유지만하는 별도의 읽기 전용 RDB 프로세스를 의존하도록 재구성하였고 이러한 현상이 점차적으로 줄어들고 있습니다.</p><h3 id="EOH-다운타임"><a href="#EOH-다운타임" class="headerlink" title="EOH 다운타임"></a>EOH 다운타임</h3><p>티커플랜트는 시간 또는 일과가 종료되면 EOH 또는 EOD 이벤트를 데이터 피드 구독자에게 전달합니다. 그리고 특정 RDB 프로세스는 시간 또는 일과 데이터를 현재 파티션에 기록합니다. 프로세스에서 데이터를 파일로 기록하기전에 정렬을 시도하므로 데이터 규모와 서버 성능에 따라서 <a href="https://code.kx.com/q/wp/intraday-writedown/#downtime">Downtime</a>이 발생할 수 있습니다. 이러한 다운타임을 최소화하기 위해서 RDB 프로세스에서 데이터를 저장할때는 데이터 정렬이나 스플레이 테이블에 대한 속성 부여를 최소화하고 파티션 보정을 수행하는 별도의 프로세스를 두어서 파티션 데이터를 정렬하고 쿼리 최적화를 위한 컬럼에 속성을 부여하는 작업을 수행하도록 추가 구성했습니다.</p><blockquote><p>실시간 데이터에 과거의 시계열 데이터가 많이 존재할 수 있는 케이스가 발생하면서 파티션을 다시 보정하는 작업을 수행하는 프로세스에 대한 작업도 과중화되는 것을 확인하고 있습니다.</p></blockquote><hr><p>아무리 빠른 성능을 자랑하는 기술이어도 어떤 환경에서 사용되는지와 어떻게 구성하여 사용하는지에 따라서 많은 문제나 제약이 발생할 수 있습니다. 간단했던 시스템이 복잡해지면서 장애가 발생하면 그것을 보완하기 위하여 여러가지 시도를 해보아야합니다. 이전의 경험을 토대로 그럴리 없다, 그럴 가능성은 없다라는 관점은 우리를 힘들게할 수 있습니다. 기술을 사용하는 방식이 동일하지 않음을 인정하고 그것으로부터 야기되는 문제점은 없는지 지속적으로 검토해야합니다. 그것을 우리는 장애 대응 또는 후속 조치라고 말합니다.</p><h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul><li><a href="https://kx.com/blog/what-makes-time-series-database-kdb-so-fast/">What Makes Time-Series Database kdb+ So Fast?</a></li><li><a href="https://code.kx.com/q/kb/kdb-tick/">Kdb+tick configuration</a>  </li><li><a href="https://code.kx.com/q/wp/rt-tick/">Building real-time tick subscribers</a></li><li><a href="https://github.com/kdevkr/kdb">Learning KDB+</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;에너지 분야는 나노초 또는 밀리초 단위의 시계열 데이터가 빠르게 생성되는 특수한 시장입니다. 시계열 데이터는 금융(Financial) 시장에서부터 중요성이 부각되었으나 이제는 다양한 분야에서 발생하고 이를 활용한 많은 서비스가 만들어지고 있습니다</summary>
      
    
    
    
    
    <category term="KDB+/q" scheme="https://kdevkr.github.io/tags/KDB-q/"/>
    
    <category term="TP" scheme="https://kdevkr.github.io/tags/TP/"/>
    
  </entry>
  
  <entry>
    <title>자바 날짜 및 시간 포맷</title>
    <link href="https://kdevkr.github.io/java-datetime-format/"/>
    <id>https://kdevkr.github.io/java-datetime-format/</id>
    <published>2022-03-19T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.512Z</updated>
    
    <content type="html"><![CDATA[<p>여러 국가를 대상으로 해야하는 서비스를 만들어가게 되는 경우 언어 뿐만 아니라 시간을 다루는 것도 중요합니다. 단순하게 말해서 한국에서 서비스를 제공한다고해서 한국 시간으로 모든 시간 데이터를 다루는 것은 좋은 방식이 아닙니다. 기본적으로는 UTC라고 하는 세계 협정 시간을 기준으로 시간을 저장해야합니다. PostgreSQL과 같은 데이터베이스에서도 Timestamp를 저장하게 되는 경우 내부적으로는 UTC로 저장됩니다. 따라서, 2022년 3월 19일 12시 라는 시간은 <code>2022년 3월 19일 03시</code>로 저장되는것이죠.</p><blockquote><p>애플리케이션 뿐만 아니라 서버 그리고 데이터베이스 모두 UTC로 설정하여 사용하는게 일반적입니다. 예를 들어, 아마존 웹 서비스의 EC2는 한국 리전인데도 불구하고 한국 시간대가 아닌 UTC로 설정되어있습니다.</p></blockquote><p>그리고 시간 데이터를 전달할 때는 <code>2022-03-19 12:00</code>과 같은 문자열 형태가 아닌 <a href="https://www.unixtimestamp.com/">Unix Timestamp</a>의 밀리초가 부여된 상태로 서버와 클라이언트간 요청과 응답에 사용됩니다. 가끔씩 국내 시간만 다루던 개발자들이 UTC 또는 Unix Timestamp에 대해서 모르는 경우도 꽤 많았습니다. 밀리초 형식의 Unix Timestamp를 전달받았으나 실제로 변환해보니 9시간이 빠진게 아니라 오히려 9시간이 더해진 상태로 전달하던 경험도 있습니다.</p><h2 id="Java-Date-Format"><a href="#Java-Date-Format" class="headerlink" title="Java Date Format"></a>Java Date Format</h2><p>서버와 클라이언트 간에 시간 데이터를 전달하거나 개발자 사이에 API를 제공할 때에는 앞서 이야기한 Unix Timestamp로 전달하도록 스펙을 맞출 수 있습니다. 그러나 개발자가 아닌 일반 사용자가 서비스 내에서 CSV 또는 엑셀 파일 형식으로 데이터를 업로드하거나 다운로드 받을때에는 숫자값인 Unix Timestamp가 아닌 <code>2022-03-19 12:00:00</code>과 같은 어떠한 문자 형태이어야합니다. 왜냐하면 일반인들은 UTC가 무엇인지 Unix Timestamp가 무엇인지 모르는 사람이 많으니까요. 심지어는 개발자들 중에서도…</p><blockquote><p>자바 8의 Date&#x2F;Time API에 대해서는 네이버 D2에 공유된 <a href="%5Bhttps://d2.naver.com/helloworld/645609">Java의 날짜와 시간 API</a>를 참고하시면 좋을 것 같습니다.</p></blockquote><h3 id="DateTimeFormatter"><a href="#DateTimeFormatter" class="headerlink" title="DateTimeFormatter"></a>DateTimeFormatter</h3><p>자바 8의 날짜 및 시간 클래스에 대해서 날짜 포맷을 적용해야하는 경우 <a href="https://docs.oracle.com/javase/8/docs/api/java/time/format/DateTimeFormatter.html">DateTimeFormatter</a>를 사용해야합니다. 그리고 일반적으로 다음과 같은 코드로 날짜 데이터를 변환할 수 있죠.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">TimeZone</span> tzSeoul <span class="token operator">=</span> <span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">getTimeZone</span><span class="token punctuation">(</span><span class="token string">"Asia/Seoul"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> dateStr <span class="token operator">=</span> <span class="token string">"2022-03-19 12:00:00"</span><span class="token punctuation">;</span><span class="token class-name">DateTimeFormatter</span> dateTimeFormatter <span class="token operator">=</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withZone</span><span class="token punctuation">(</span>tzSeoul<span class="token punctuation">.</span><span class="token function">toZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ZonedDateTime</span> dateTime <span class="token operator">=</span> <span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dateStr<span class="token punctuation">,</span> dateTimeFormatter<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s -> %s%n"</span><span class="token punctuation">,</span> dateStr<span class="token punctuation">,</span> dateTime<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>위 코드는 이해하기에는 쉬우나 한가지 문제점은 어떤 특정한 형태의 문자열로 구성된 데이터만 변환할 수 있다는 점입니다.</p></blockquote><p>만약, 서비스 사용자가 2022년 3월 19일 0시의 시간을 표현하고자 한다면 2022-03-19 00:00:00과 같이 불필요하게 00:00:00을 붙여야하는 단점이 생기게 됩니다. 이를 보완하기 위해서는 여러가지 형식의 날짜 포맷을 처리할 수 있는 코드가 필요합니다.</p><h3 id="DateTimeFormatterBuilder"><a href="#DateTimeFormatterBuilder" class="headerlink" title="DateTimeFormatterBuilder"></a>DateTimeFormatterBuilder</h3><p>여러가지 형태의 날짜 형식을 지원해야하는 경우에는 <strong>Optional 패턴</strong>을 적용해서 처리할 수 있습니다. DateTimeFormatter에 그대로 적용할수도 있으나 DateTimeFormatterBuilder를 통해 여러가지 처리 방식에 대한 옵션이 적용된 형태로 DateTimeFormatter를 만들 수 있습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">TimeZone</span> tzSeoul <span class="token operator">=</span> <span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">getTimeZone</span><span class="token punctuation">(</span><span class="token string">"Asia/Seoul"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">DateTimeFormatter</span> dateTimeFormatter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DateTimeFormatterBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">appendPattern</span><span class="token punctuation">(</span><span class="token string">"[yyyy-MM-dd HH:mm:ss]"</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">appendPattern</span><span class="token punctuation">(</span><span class="token string">"[yyyy-MM-dd HH:mm]"</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">appendPattern</span><span class="token punctuation">(</span><span class="token string">"[yyyy-MM-dd]"</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">parseDefaulting</span><span class="token punctuation">(</span><span class="token class-name">ChronoField</span><span class="token punctuation">.</span>HOUR_OF_DAY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">parseDefaulting</span><span class="token punctuation">(</span><span class="token class-name">ChronoField</span><span class="token punctuation">.</span>MINUTE_OF_HOUR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">parseDefaulting</span><span class="token punctuation">(</span><span class="token class-name">ChronoField</span><span class="token punctuation">.</span>SECOND_OF_MINUTE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">toFormatter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">withZone</span><span class="token punctuation">(</span>tzSeoul<span class="token punctuation">.</span><span class="token function">toZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dateStrArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"2022-03-19 00:00:00"</span><span class="token punctuation">,</span> <span class="token string">"2022-03-19 00:00"</span><span class="token punctuation">,</span> <span class="token string">"2022-03-19"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dateStr <span class="token operator">:</span> dateStrArr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">ZonedDateTime</span> dateTime <span class="token operator">=</span> <span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dateStr<span class="token punctuation">,</span> dateTimeFormatter<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s -> %s%n"</span><span class="token punctuation">,</span> dateStr<span class="token punctuation">,</span> dateTime<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 2022-03-19 00:00:00 -> 2022-03-19T00:00+09:00[Asia/Seoul]</span><span class="token comment">// 2022-03-19 00:00 -> 2022-03-19T00:00+09:00[Asia/Seoul]</span><span class="token comment">// 2022-03-19 -> 2022-03-19T00:00+09:00[Asia/Seoul]</span></code></pre><h4 id="Unable-to-obtain-LocalTime-from-TemporalAccessor"><a href="#Unable-to-obtain-LocalTime-from-TemporalAccessor" class="headerlink" title="Unable to obtain LocalTime from TemporalAccessor"></a>Unable to obtain LocalTime from TemporalAccessor</h4><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">TimeZone</span> tzSeoul <span class="token operator">=</span> <span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">getTimeZone</span><span class="token punctuation">(</span><span class="token string">"Asia/Seoul"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">DateTimeFormatter</span> dateTimeFormatter <span class="token operator">=</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"[yyyy-MM-dd HH:mm:ss][yyyy-MM-dd HH:mm][yyyy-MM-dd]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withZone</span><span class="token punctuation">(</span>tzSeoul<span class="token punctuation">.</span><span class="token function">toZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dateStrArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"2022-03-19 00:00:00"</span><span class="token punctuation">,</span> <span class="token string">"2022-03-19 00:00"</span><span class="token punctuation">,</span> <span class="token string">"2022-03-19"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dateStr <span class="token operator">:</span> dateStrArr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">ZonedDateTime</span> dateTime <span class="token operator">=</span> <span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dateStr<span class="token punctuation">,</span> dateTimeFormatter<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s -> %s%n"</span><span class="token punctuation">,</span> dateStr<span class="token punctuation">,</span> dateTime<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>위와 같이 DateTimeFormatterBuilder를 사용하지 않고서도 DateTimeFormatter 패턴 자체로 날짜 포맷 체이닝을 구성할 수 있습니다. 그러나, 2022-03-19와 같이 시간 부분이 없는 형태의 경우에는 다음과 같이 처리할 수 없다는 예외가 발생하게 됩니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>DateTimeParseException</span><span class="token operator">:</span> <span class="token class-name">Text</span> '<span class="token number">2022</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">19</span>' could not be parsed<span class="token operator">:</span> <span class="token class-name">Unable</span> <span class="token keyword">to</span> <span class="token namespace">obtain</span> <span class="token class-name">ZonedDateTime</span> from <span class="token class-name">TemporalAccessor</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>ISO<span class="token punctuation">,</span><span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Seoul</span> resolved <span class="token keyword">to</span> <span class="token number">2022</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">19</span> of type <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>Parsed</span>at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">createError</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2017</span><span class="token punctuation">)</span>at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1952</span><span class="token punctuation">)</span>at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">598</span><span class="token punctuation">)</span>at <span class="token class-name"><span class="token namespace">test<span class="token punctuation">.</span></span>Main</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">Main</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">17</span><span class="token punctuation">)</span><span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>DateTimeException</span><span class="token operator">:</span> <span class="token class-name">Unable</span> <span class="token keyword">to</span> <span class="token namespace">obtain</span> <span class="token class-name">ZonedDateTime</span> from <span class="token class-name">TemporalAccessor</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>ISO<span class="token punctuation">,</span><span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Seoul</span> resolved <span class="token keyword">to</span> <span class="token number">2022</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">19</span> of type <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>Parsed</span>at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">566</span><span class="token punctuation">)</span><span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>DateTimeException</span><span class="token operator">:</span> <span class="token class-name">Unable</span> <span class="token keyword">to</span> <span class="token namespace">obtain</span> <span class="token class-name">ZonedDateTime</span> from <span class="token class-name">TemporalAccessor</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>ISO<span class="token punctuation">,</span><span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Seoul</span> resolved <span class="token keyword">to</span> <span class="token number">2022</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">19</span> of type <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>Parsed</span>at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>Parsed</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">Parsed</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">235</span><span class="token punctuation">)</span>at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1948</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">2</span> more<span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>DateTimeException</span><span class="token operator">:</span> <span class="token class-name">Unable</span> <span class="token keyword">to</span> <span class="token namespace">obtain</span> <span class="token class-name">LocalTime</span> from <span class="token class-name">TemporalAccessor</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>ISO<span class="token punctuation">,</span><span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Seoul</span> resolved <span class="token keyword">to</span> <span class="token number">2022</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">19</span> of type <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>Parsed</span><span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>DateTimeException</span><span class="token operator">:</span> <span class="token class-name">Unable</span> <span class="token keyword">to</span> <span class="token namespace">obtain</span> <span class="token class-name">LocalTime</span> from <span class="token class-name">TemporalAccessor</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>ISO<span class="token punctuation">,</span><span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Seoul</span> resolved <span class="token keyword">to</span> <span class="token number">2022</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">19</span> of type <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>Parsed</span>at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>LocalTime</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">LocalTime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">431</span><span class="token punctuation">)</span>at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">561</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">4</span> more</code></pre><blockquote><p>따라서, DateTimeFormatterBuilder로 문자열로 구성된 날짜 및 시간 데이터에 구성되지 않는 부분을 어떻게 처리할 것인가에 대한 옵션을 적용하여 DateTimeFormatter를 만들어서 사용하는게 좋아보입니다.</p></blockquote><p>만약, 이 글을 보시는 여러분들이 여러가지 형태의 날짜 포맷을 처리하기 위해서 아래와 같이 DateTimeFormattter를 여러개 만들어서 처리하는 코드를 작성했다면 DateTimeFormatterBuilder로 하나의 DateTimeFormatter를 사용해서 좀 더 깔끔한 형태의 코드로 만들어보시기를 추천해드립니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> dateStr <span class="token operator">=</span> <span class="token string">"2022-03-19"</span><span class="token punctuation">;</span><span class="token class-name">ZonedDateTime</span> dateTime <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    dateTime <span class="token operator">=</span> <span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dateStr<span class="token punctuation">,</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withZone</span><span class="token punctuation">(</span>tzSeoul<span class="token punctuation">.</span><span class="token function">toZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DateTimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">LocalDateTime</span> localDateTime <span class="token operator">=</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dateStr<span class="token punctuation">,</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withZone</span><span class="token punctuation">(</span>tzSeoul<span class="token punctuation">.</span><span class="token function">toZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">atStartOfDay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    dateTime <span class="token operator">=</span> <span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>localDateTime<span class="token punctuation">,</span> tzSeoul<span class="token punctuation">.</span><span class="token function">toZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dateTime<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;여러 국가를 대상으로 해야하는 서비스를 만들어가게 되는 경우 언어 뿐만 아니라 시간을 다루는 것도 중요합니다. 단순하게 말해서 한국에서 서비스를 제공한다고해서 한국 시간으로 모든 시간 데이터를 다루는 것은 좋은 방식이 아닙니다. 기본적으로는 UT</summary>
      
    
    
    
    
    <category term="TimeZone" scheme="https://kdevkr.github.io/tags/TimeZone/"/>
    
    <category term="ZoneId" scheme="https://kdevkr.github.io/tags/ZoneId/"/>
    
    <category term="Instant" scheme="https://kdevkr.github.io/tags/Instant/"/>
    
    <category term="ZonedDateTime" scheme="https://kdevkr.github.io/tags/ZonedDateTime/"/>
    
    <category term="DateTimeFormatter" scheme="https://kdevkr.github.io/tags/DateTimeFormatter/"/>
    
  </entry>
  
  <entry>
    <title>프리마커 템플릿</title>
    <link href="https://kdevkr.github.io/freemarker-template/"/>
    <id>https://kdevkr.github.io/freemarker-template/</id>
    <published>2022-03-05T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.512Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>본 글은 <a href="/sending-mail-with-freemarker-template/">프리마커 템플릿으로 이메일 발송하기</a>에 이어서 프리마커 템플릿에 대해서 조금 더 학습해보고 정리하였습니다.<br>이 글에서 알아보는 내용을 코드로 확인하고 싶다면 <a href="https://github.com/kdevkr/spring-demo-freemarker">spring-demo-freemarker</a>를 참고하세요.</p></blockquote><h2 id="프리마커-템플릿"><a href="#프리마커-템플릿" class="headerlink" title="프리마커 템플릿"></a>프리마커 템플릿</h2><p><a href="https://freemarker.apache.org/">프리마커(FreeMarker)</a> 템플릿 엔진은 스프링 부트에서 공식적으로 지원하는 템플릿 엔진 중 하나입니다. <a href="https://developer.mozilla.org/ko/docs/Web/JavaScript/Reference/Template_literals">템플릿 리터럴</a>처럼 미리 정의된 템플릿 파일을 만들어서 어떠한 데이터 모델을 결합하여 동적으로 컨텐츠를 만들기 위해서 사용합니다. 여러가지 <a href="https://github.com/jreijn/spring-comparing-template-engines">템플릿 엔진과 비교</a>해서도 준수한 렌더링 성능을 보여주고 있습니다.</p><p><img data-src="https://freemarker.apache.org/images/overview.png" alt="Template + data-model = output"></p><h3 id="템플릿-로더"><a href="#템플릿-로더" class="headerlink" title="템플릿 로더"></a>템플릿 로더</h3><p>프리마커 템플릿 엔진은 다양항 방식으로 템플릿을 관리할 수 있도록 <a href="https://freemarker.apache.org/docs/api/freemarker/cache/TemplateLoader.html">TemplateLoader</a> 인터페이스를 사용합니다. 기본적으로 내장되어있는 구현체도 존재하며 프리마커 템플릿 엔진을 공식적으로 지원하는 스프링 프레임워크에는 SpringTemplateLoader라는 구현체를 포함하고 있습니다. 본 글에서 다루는 TemplateLoader는 아래와 같습니다.</p><ul><li><a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/ui/freemarker/SpringTemplateLoader.html">SpringTemplateLoader</a></li><li><a href="https://freemarker.apache.org/docs/api/freemarker/cache/StringTemplateLoader.html">StringTemplateLoader</a></li><li><a href="https://freemarker.apache.org/docs/api/freemarker/cache/MultiTemplateLoader.html">MultiTemplateLoader</a></li></ul><blockquote><p>스프링 프레임워크에서 제공하는 SpringTemplateLoader는 ResourceLoader를 통해 템플릿을 로드합니다.</p></blockquote><h3 id="국제화"><a href="#국제화" class="headerlink" title="국제화"></a>국제화</h3><p>국제화(Internationalization)는 구글처럼 다양한 언어를 사용하는 서비스 사용자가 있다면 다국어 서비스를 위해서 필수적으로 지원해야하는 기능입니다. 스프링 프레임워크에서는 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/context/MessageSource.html">메시지 소스</a>를 통해 다국어 메시지 처리를 지원합니다. 프리마커 템플릿 엔진은 스프링의 메시지 소스와는 연관성이 없으므로 스프링 프레임워크에서는 프리마커 템플릿에서 메시지 소스를 사용할 수 있도록 <a href="https://github.com/spring-projects/spring-framework/blob/main/spring-webmvc/src/main/resources/org/springframework/web/servlet/view/freemarker/spring.ftl">spring.ftl</a>를 포함하고 있습니다. </p><p>따라서, 프리마커 템플릿에서 스프링 메시지 처리하는 방법을 찾아보면 다음과 같이 해야한다는 정보를 확인할 수 있습니다.</p><pre class="language-ftl" data-language="ftl"><code class="language-ftl"><span class="token ftl language-ftl"><span class="token ftl-directive"><span class="token punctuation">&lt;</span><span class="token directive keyword">#import</span><span class="token content ftl"> <span class="token string">"/spring.ftl"</span> <span class="token keyword">as</span> spring</span><span class="token punctuation">/></span></span></span><span class="token ftl language-ftl"><span class="token ftl-directive"><span class="token punctuation">&lt;</span><span class="token directive keyword">@spring</span><span class="token content ftl"><span class="token punctuation">.</span>message <span class="token string">"messageKey"</span></span><span class="token punctuation">/></span></span></span></code></pre><blockquote><p>단, 메시지 소스를 사용할 수 있도록 정의된 FTL 파일은 RequestContext를 필요로하기 때문에 사용자의 요청에 대해 응답하는 뷰가 아닌 경우에는 사용할 수 없습니다. 따라서, 백그라운드 작업의 스레드에는 RequestContext가 존재하지 않기 때문에 메시지 소스로 다국어 메시지 처리가 불가능합니다.</p></blockquote><h4 id="ResourceBundleModel"><a href="#ResourceBundleModel" class="headerlink" title="ResourceBundleModel"></a>ResourceBundleModel</h4><p>사용자의 요청에 대한 응답이 아닌 백그라운드 작업에서 프리마커 템플릿 엔진을 사용할 때 다국어 메시지를 제공하기 위해서는 프리마커 템플릿 엔진에서 지원하는 방법을 사용해야만 합니다. 프리마커 템플릿 엔진은 리소스 번들을 모델로 사용해서 다국어를 처리할 수 있는 <strong>ResourceBundleModel</strong>을 제공하고 있습니다.</p><p>예를 들어, 클래스패스에 리소스 번들을 구성하고 ResourceBundleModel로 변환하여 데이터 모델로 전달하면 메시지 처리가 가능해집니다.</p><p><img data-src="/images/posts/freemarker-template/resource-bundle.png" alt="Resource Bundle"></p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Locale</span> locale <span class="token operator">=</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span>ROOT<span class="token punctuation">;</span><span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> configurationFactoryBean<span class="token punctuation">.</span><span class="token function">createConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">StringTemplateLoader</span> stringTemplateLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringTemplateLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>stringTemplateLoader<span class="token punctuation">.</span><span class="token function">putTemplate</span><span class="token punctuation">(</span><span class="token string">"template"</span><span class="token punctuation">,</span> <span class="token string">"$&#123;bundle(\"application.name\")&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>configuration<span class="token punctuation">.</span><span class="token function">setTemplateLoader</span><span class="token punctuation">(</span>stringTemplateLoader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Template</span> template <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token string">"template"</span><span class="token punctuation">,</span> locale<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ResourceBundle</span> resourceBundle <span class="token operator">=</span> <span class="token class-name">ResourceBundle</span><span class="token punctuation">.</span><span class="token function">getBundle</span><span class="token punctuation">(</span><span class="token string">"messages"</span><span class="token punctuation">,</span> locale<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>model<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bundle"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ResourceBundleModel</span><span class="token punctuation">(</span>resourceBundle<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BeansWrapperBuilder</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span><span class="token punctuation">.</span>DEFAULT_INCOMPATIBLE_IMPROVEMENTS<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token class-name">FreeMarkerTemplateUtils</span><span class="token punctuation">.</span><span class="token function">processTemplateIntoString</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>기본적으로는 프로퍼티 파일로 리소스 번들을 만들지만 <a href="https://docs.oracle.com/javase/7/docs/api/java/util/ResourceBundle.Control.html">XML</a> 또는 <a href="https://github.com/akkinoc/yaml-resource-bundle">YAML</a>로 리소스 번들을 만들어서 사용할 수도 있습니다.</p></blockquote><h3 id="템플릿-체이닝"><a href="#템플릿-체이닝" class="headerlink" title="템플릿 체이닝"></a>템플릿 체이닝</h3><p><a href="https://freemarker.apache.org/docs/api/freemarker/cache/MultiTemplateLoader.html">MultiTemplateLoader</a>를 사용하면 여러가지 방식의 <a href="https://freemarker.apache.org/docs/pgui_config_templateloading.html">템플릿 로딩</a>을 통해 템플릿 로더에 의해 로드되는 템플릿을 함께 사용할 수 있습니다. 또한, MultiTemplateLoader에 전달되는 템플릿 로더의 순서에 따라 SpringTemplateLoader로 기본 템플릿 레이아웃을 만들고 실제 템플릿 내용은 StringTemplateLoader로 재정의할 수도 있습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">StringTemplateLoader</span> stringTemplateLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringTemplateLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>stringTemplateLoader<span class="token punctuation">.</span><span class="token function">putTemplate</span><span class="token punctuation">(</span><span class="token string">"email.ftlh"</span><span class="token punctuation">,</span> <span class="token string">"$&#123;bundle(\"application.name\")&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>stringTemplateLoader<span class="token punctuation">.</span><span class="token function">putTemplate</span><span class="token punctuation">(</span><span class="token string">"template"</span><span class="token punctuation">,</span> <span class="token string">"&lt;#include \"email.ftlh\" >"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> configurationFactoryBean<span class="token punctuation">.</span><span class="token function">createConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">SpringTemplateLoader</span> springTemplateLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringTemplateLoader</span><span class="token punctuation">(</span>resourceLoader<span class="token punctuation">,</span> <span class="token string">"classpath:/templates/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">MultiTemplateLoader</span> multiTemplateLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MultiTemplateLoader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TemplateLoader</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>stringTemplateLoader<span class="token punctuation">,</span> springTemplateLoader<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>configuration<span class="token punctuation">.</span><span class="token function">setTemplateLoader</span><span class="token punctuation">(</span>multiTemplateLoader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Template</span> template <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token string">"template"</span><span class="token punctuation">,</span> locale<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>MultiTemplateLoader의 생성자에 전달되는 템플릿 로더의 순서대로 템플릿을 찾도록 위임한다는 것에 주의해야합니다.</p></blockquote><p>사용자의 요청에 대한 응답을 뷰로 처리하기 위해서 템플릿 엔진을 적용하기도 하지만 이메일 발송과 같은 백그라운드 작업에서도 프리마커 템플릿 엔진을 다양한 방식으로 활용할 수 있다는 것을 알게되었습니다. 프리마커 템플릿을 동적으로 처리하는 방법에 대해서 고민하게 되면서 알아본 내용이지만 많은 분들에게 도움이 되었으면 합니다.</p><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;본 글은 &lt;a href=&quot;/sending-mail-with-freemarker-template/&quot;&gt;프리마커 템플릿으로 이메일 발송하기&lt;/a&gt;에 이어서 프리마커 템플릿에 대해서 조금 더 학습해보고 정리하였습니다.&lt;br&gt;이 글</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>X509 Certificate Signed by Unknown Authority</title>
    <link href="https://kdevkr.github.io/docker-registry-certificate/"/>
    <id>https://kdevkr.github.io/docker-registry-certificate/</id>
    <published>2022-02-26T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.512Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Error response from daemon: Get https://registry.domain.com&#x2F;v2&#x2F;: x509: certificate signed by unknown authority</p></blockquote><p>생각보다 많은 조직에서 사내 정책이나 도커 허브의 <a href="https://docs.docker.com/docker-hub/download-rate-limit/">다운로드 제한량</a>을 경험하고 도커에서 제공하는 <a href="https://hub.docker.com/_/registry">레지스트리 이미지</a>로 사설 도커 레지스트리 서버를 구축하는 것 같습니다. 위 오류는 도커 레지스트리 서버에 로그인을 시도할 때 나타날 수 있습니다. 우리가 사용하는 도커 엔진이라고하는 클라이언트가 도커 레지스트리 서버가 전달해준 인증서를 신뢰할 수 없다는 의미입니다. 그러면 위와 같이 내 컴퓨터에 설치된 도커 엔진에서 사설로 구축한 도커 레지스트리 서버의 인증서를 신뢰할 수 없는 문제가 발생하면 어떻게 해결하는지를 알아보도록 하죠.</p><h2 id="도커-레지스트리-인증서"><a href="#도커-레지스트리-인증서" class="headerlink" title="도커 레지스트리 인증서"></a>도커 레지스트리 인증서</h2><p>도커 엔진에서 참조하는 레지스트리 서버에 대한 인증서 폴더는 <strong>certs.d</strong> 입니다.</p><ul><li>Windows: C:&#x2F;ProgramData&#x2F;Docker&#x2F;certs.d&#x2F;</li><li>Linux: &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;</li><li>Mac: ~&#x2F;.docker&#x2F;certs.d&#x2F;</li></ul><pre class="language-sh" data-language="sh"><code class="language-sh">&#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;         &lt;-- Certificate directory└── registry.domain.com:5000 &lt;-- Hostname:port   ├── client.cert           &lt;-- Client certificate   ├── client.key            &lt;-- Client key   └── ca.crt                &lt;-- Certificate authority that signed the registry certificate</code></pre><h3 id="안전하지-않은-레지스트리"><a href="#안전하지-않은-레지스트리" class="headerlink" title="안전하지 않은 레지스트리"></a>안전하지 않은 레지스트리</h3><p>HTTPS로 실행된 도커 레지스트리 서버에 대해서 도커 엔진이 신뢰할 수 없는 인증서를 무시하도록 <a href="https://docs.docker.com/registry/insecure/">insecure-registries</a>옵션을 지정할 수 있습니다. 다만, 이 방법은 해당 도메인 주소의 레지스트리 서버가 올바른 인증서를 사용하는지 검증하지 않기 때문에 보안적인 부분을 생각한다면 일반적으로 사용해서는 안되는 방법입니다.</p><h3 id="신뢰할-수-있는-인증-기관"><a href="#신뢰할-수-있는-인증-기관" class="headerlink" title="신뢰할 수 있는 인증 기관"></a>신뢰할 수 있는 인증 기관</h3><p>도커 엔진은 기본적으로 시스템에 등록된 신뢰할 수 있는 인증 기관의 인증서 목록으로 도커 레지스트리 서버의 클라이언트 인증서를 검증합니다. 이는 크롬과 같은 브라우저에서 HTTPS 통신 시 서버에서 전달하는 인증서가 유효한지를 확인하는 것과 다르지 않습니다. 저는 <strong>신뢰할 수 있는 인증 기관으로부터 발급받은 도메인 인증서를 사용</strong>하여 도커 레지스트리 서버를 구축하였는데도 불구하고 도커 엔진에서는 회사 도메인 주소로된 도커 레지스트리 서버에서 전달된 인증서가 올바르지 않다며 동일하게 <code>x509: certificate signed by unknown authority</code> 오류를 알려주었습니다.</p><h3 id="CA-인증서-체인"><a href="#CA-인증서-체인" class="headerlink" title="CA 인증서 체인"></a>CA 인증서 체인</h3><p>도커 엔진에서 레지스트리 서버의 인증서를 신뢰할 수 없다는 것은 몇가지 사항에 대한 의미를 가질 수 있습니다. 첫번째로, 도커 레지스트리 서버 구축 시 사용한 CA 인증서가 클라이언트 인증서와 인증 기관들에 대한 인증서가 연결된 CA 인증서 체인이 아닐 수 있다는 것입니다. 실제로 지금은 UI 기반의 사용자 및 이미지 관리를 위해 <a href="https://goharbor.io/">Harbor</a>로 도커 레지스트리 서버를 재구축하였으나 기존 도커 레지스트리 서버에 사용된 CA 인증서 파일에는 클라이언트 인증서만 존재했던 문제가 있었습니다. 그래서 조직 내 개발자들에게 레지스트리 서버에서 사용된 CA 인증서 파일과 클라이언트 인증서 및 키를 전달하고 도커 레지스트리 인증서 폴더에 저장하여 사용해달라고 안내했었습니다. 결국은 도커 엔진이 도커 레지스트리 서버를 신뢰할 수 없으므로 CA 인증서 체인을 신뢰할 수 있는 인증서 목록에 포함시키면 됩니다.</p><p>예를 들어, <a href="https://support.apple.com/ko-kr/guide/keychain-access/kyca2431/mac">Mac용 키체인 접근을 사용하여 키체인에 인증서 추가하기</a>에 따라 CA 인증서를 추가하면 다음과 같이 유효한 인증서임이 표시됨을 확인할 수 있었습니다.</p><p><img data-src="/images/posts/docker-registry-certificate/trust-certificate.png"></p><pre class="language-sh" data-language="sh"><code class="language-sh">docker login registry.domain.com -u &#39;username&#39; -p &#39;password&#39;WARNING! Using --password via the CLI is insecure. Use --password-stdin.Login Succeeded</code></pre><blockquote><p>도커 레지스트리 서버의 CA 인증서 체인을 시스템 인증서로 등록하고나서는 도커 엔진이 신뢰할 수 있는 인증서 목록에 따라 인증서가 유효함을 확인함으로 정상적으로 HTTPS 통신이 이루어지고 로그인에 성공하였습니다. 레지스트리 서버에 대한 로그인 예시이므로 CLI 경고 문구는 무시해주세요.</p></blockquote><h4 id="시스템-및-사용자-정의-CA-인증서-병합"><a href="#시스템-및-사용자-정의-CA-인증서-병합" class="headerlink" title="시스템 및 사용자 정의 CA 인증서 병합"></a>시스템 및 사용자 정의 CA 인증서 병합</h4><p><em>On Linux any root certificates authorities are merged with the system defaults, including the host’s root CA set. If you are running Docker on Windows Server, or Docker Desktop for Windows with Windows containers, the system default certificates are only used when no custom root certificates are configured.</em></p><p><a href="https://docs.docker.com/engine/security/certificates/#understand-the-configuration">공식문서</a>에 따르면 위와 같이 사용자 정의 인증서(certs.d)는 시스템 인증서와 CA 인증서가 합쳐져서 등록된다는 내용이 있습니다. 따라서, 도커 레지스트리 서버의 CA 인증서 체인을 <strong>시스템 인증서 목록</strong>이나 <strong>certs.d</strong> 폴더에 두면 된다는 이야기입니다. 실제로 시스템 인증서로 등록하지 않아도 certs.d 폴더에 ca.crt라는 이름으로 CA 인증서 체인을 두게되면 동일하게 동작함을 확인할 수 있었습니다.</p><blockquote><p>한가지 흥미로운 점은 이 글을 작성하기 위해 Docker Desktop for Windows 에서도 테스트를 해본 결과 도커 레지스트리 서버의 CA 인증서 체인을 굳이 등록하지 않아도 정상적으로 로그인이 되었다는 점입니다. 이점으로 보았을때 모든 운영체제에서 동일하게 동작하지는 않는 것 같아보입니다. 따라서, 도커 엔진에서 레지스트리 서버를 신뢰할 수 없다고 한다면 레지스트리 서버 관리자에게 인증서 체인을 전달받아서 등록하는게 좋을 것 같습니다.</p></blockquote><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Error response from daemon: Get https://registry.domain.com&amp;#x2F;v2&amp;#x2F;: x509: certificate signed by unknown authority&lt;/p&gt;</summary>
      
    
    
    
    
    <category term="Docker Registry" scheme="https://kdevkr.github.io/tags/Docker-Registry/"/>
    
    <category term="Harbor" scheme="https://kdevkr.github.io/tags/Harbor/"/>
    
    <category term="Certificate" scheme="https://kdevkr.github.io/tags/Certificate/"/>
    
  </entry>
  
  <entry>
    <title>HTTP/2를 사용하는 개발 환경</title>
    <link href="https://kdevkr.github.io/local-for-http2/"/>
    <id>https://kdevkr.github.io/local-for-http2/</id>
    <published>2022-02-22T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.512Z</updated>
    
    <content type="html"><![CDATA[<p>지난 <a href="/ssl-certificate">SSL 인증서</a>와 <a href="/tls-offload">TLS 오프로드</a>라는 글을 통해 HTTPS에 대해서 살펴본 적이 있습니다. 이처럼 HTTPS는 사용자의 요청이 안전하게 서버로 전달되는 것을 목적으로 도입하지만 <a href="https://developers.google.com/web/fundamentals/performance/http2?hl=ko">HTTP&#x2F;2</a>를 사용하기 위함도 있습니다. 일반 사용자의 컴퓨터나 모바일 디바이스에 대한 성능이 좋아지면서 TLS 핸드쉐이킹에 대한 비용은 그다지 크지 않습니다. 그러나 HTTP 1.1에서의 Keep Alive 도입은 이미 연결중인 TCP를 다시 사용하므로 어느정도의 TLS 핸드쉐이킹에 대한 비용을 줄일 수 있지만 수 많은 요청이 발생하는 애플리케이션에서는 이미 응답을 기다리는 요청이 끝나기를 현재 요청이 대기해야하는 문제를 가지고 있습니다.</p><blockquote><p>HTTP 1.1은 keep-alive 커넥션을 통해 여러개의 TCP 연결을 일정 시간 열어놓고 요청을 차례대로 수행하기 때문에 브라우저에서는 <a href="https://stackoverflow.com/a/985704">HTTP 1.1를 사용할 때 도메인 당 최대 연결 수를 제한</a>합니다.</p></blockquote><h2 id="HTTP-x2F-2"><a href="#HTTP-x2F-2" class="headerlink" title="HTTP&#x2F;2"></a>HTTP&#x2F;2</h2><p>HTTP 1.1이 이미 연결된 TCP 커넥션을 다시 재사용한다면 HTTP2는 단일 TCP 연결을 수행하고 수 많은 요청을 스트림으로 처리합니다. 그렇기에 꽤 많은 요청을 동시에 수행해도 브라우저는 이를 제한하지 않습니다. 예를 들어, 자바스크립트에서 <strong>프로미스로 여러개 요청을 동시에 수행하도록</strong> 코드를 작성하더라도 다른 요청이 끝나기까지 요청이 대기하는 현상이 줄어들게되며, 웹팩을 통해 클라이언트 UI를 구성하는 에셋 파일들을 <strong>여러개의 작은 사이즈로 나누는 청크를 수행</strong>하고 웹 페이지 로딩 시 분할된 청크를 빠르게 응답받을 수 있습니다.</p><blockquote><p>브라우저에서 HTTP&#x2F;2도 도메인 당 TCP 연결을 수행합니다. 그리고 대부분의 브라우저와 서버에서는 HTTP&#x2F;2 연결을 위해 TLS 사용을 요구합니다.</p></blockquote><h3 id="ALPN"><a href="#ALPN" class="headerlink" title="ALPN"></a>ALPN</h3><p>HTTP2.Pro 사이트를 사용해서 <a href="https://http2.pro/check?url=https://naver.com/">네이버</a>와 <a href="https://http2.pro/check?url=https://okky.kr/">오키</a> 서비스 주소를 입력해보면 ALPN 지원 여부에 대한 정보가 표시됩니다. ALPN은 TLS 핸드쉐이크를 수행하고 서버와 클라이언트간 연결에서 어떤 HTTP 프로토콜을 사용할 것인지를 결정하기 위한 정책입니다. 아마존 웹 서비스는 <a href="https://aws.amazon.com/ko/about-aws/whats-new/2020/05/network-load-balancer-now-supports-tls-alpn-policies/">NLB</a>에서도 TLS ALPN 정책을 지원하기도 하죠.</p><blockquote><p>HTTP&#x2F;2 연결을 우선적으로 요구하고 클라이언트가 불가능하다면 HTTP 1.1로 연결할 수 있습니다.</p></blockquote><h3 id="Local-CA-with-mkcert"><a href="#Local-CA-with-mkcert" class="headerlink" title="Local CA with mkcert"></a>Local CA with mkcert</h3><p><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto.webserver.configure-http2.undertow">스프링 부트 애플리케이션</a> 뿐만 아니라 <a href="/reverse-proxy-using-nginx">엔진엑스</a>에서도 TLS 구성을 위해서는 인증서가 필요합니다. 그래서 지난 SSL 인증서 글에서는 <a href="/ssl-certificate/#%EC%9E%90%EC%B2%B4-%EC%84%9C%EB%AA%85-CA-%EC%9D%B8%EC%A6%9D%EC%84%9C-%EB%B0%9C%EA%B8%89">자체 서명 CA 인증서 발급</a>을 한것처럼 로컬 개발 환경을 위한 인증서를 만들고 적용하는 과정을 공유했습니다. 이 과정들은 생각보다 까다롭고 불편한 부분이 많습니다. 결국 불편한 것을 극히 싫어하는 개발자들은 <a href="https://github.com/FiloSottile/mkcert">mkcert</a>라고 하는 로컬 환경을 위한 CA 인증서를 자동으로 신뢰 기관에 등록하는 도구를 만들어냅니다.</p><pre class="language-ps" data-language="ps"><code class="language-ps">PS C:\Users\Mambo\cert&gt; mkcert -installThe local CA is now installed in the system trust store! ⚡️PS C:\Users\Mambo\docker\nginx.conf&gt; mkcert -ecdsa localhost 127.0.0.1 ::1 mambo.krCreated a new certificate valid for the following names 📜 - &quot;localhost&quot; - &quot;127.0.0.1&quot; - &quot;::1&quot; - &quot;mambo.kr&quot;The certificate is at &quot;.&#x2F;localhost+3.pem&quot; and the key at &quot;.&#x2F;localhost+3-key.pem&quot; ✅It will expire on 22 May 2024 🗓</code></pre><blockquote><p>간단하게 CA 인증서를 신뢰 기관에 등록하고 로컬 컴퓨터를 위한 인증서를 발급했습니다.<br>로컬 컴퓨터를 위한 인증서에 대한 신뢰 인증서를 등록한다는 점을 잊지 마세요.</p></blockquote><h2 id="로컬-개발-환경"><a href="#로컬-개발-환경" class="headerlink" title="로컬 개발 환경"></a>로컬 개발 환경</h2><p>일반적으로 TLS 핸드쉐이크를 수행하는 이후의 트래픽 전달에는 TLS 연결을 수행하도록 하지 않도록 구성합니다. 일부 엔지니어들은 모든 트래픽 전달에 TLS 연결을 해야한다고 말합니다. 어느정도의 보안적인 구성을 하느냐는 조직에서 결정해야할 일입니다. 현재 조직은 아마존 웹 서비스의 로드밸런서에서 TLS 핸드쉐이크를 수행하도록 하고 내부적인 트래픽 전달에는 TLS를 사용하여 패킷을 보호하지 않습니다. </p><p>TLS 오프로드 및 리버스 프록시를 위한 엔진엑스를 구성하고 HTTP로 실행된 애플리케이션에 트래픽을 전달하며 HTTP&#x2F;2를 사용할 수 있게 만들겠습니다. 이미 사용중인 엔진엑스가 없다면 제 깃허브 리파지토리 <a href="https://github.com/kdevkr/nginx.conf">nginx.conf</a>의 코드를 활용해서 도커 컴포즈로 엔진엑스 컨테이너를 실행하셔도 좋습니다.</p><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.8'</span><span class="token key atrule">services</span><span class="token punctuation">:</span>   <span class="token key atrule">nginx</span><span class="token punctuation">:</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.21.3<span class="token punctuation">-</span>alpine    <span class="token key atrule">ports</span><span class="token punctuation">:</span>       <span class="token punctuation">-</span> <span class="token datetime number">80:80</span>      <span class="token punctuation">-</span> 443<span class="token punctuation">:</span><span class="token number">443</span>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ./nginx.conf<span class="token punctuation">:</span>/etc/nginx/nginx.conf      <span class="token punctuation">-</span> ./localhost+3.pem<span class="token punctuation">:</span>/etc/nginx/server.crt      <span class="token punctuation">-</span> ./localhost+3<span class="token punctuation">-</span>key.pem<span class="token punctuation">:</span>/etc/nginx/server.key      <span class="token punctuation">-</span> ./static<span class="token punctuation">:</span>/etc/nginx/static  <span class="token key atrule">app</span><span class="token punctuation">:</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> amazoncorretto<span class="token punctuation">:</span>11<span class="token punctuation">-</span>alpine    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'java -jar /etc/app.jar'</span>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ./demo<span class="token punctuation">-</span>0.0.1<span class="token punctuation">-</span>SNAPSHOT.jar<span class="token punctuation">:</span>/etc/app.jar</code></pre><blockquote><p>저는 리파지토리에 있는 사설 인증서 대신에 mkcert를 통해 만들어진 인증서를 사용하도록 변경했습니다.</p></blockquote><p>리파지토리에 저장된 샘플 애플리케이션을 그대로 사용했지만 로컬 호스트에서 인텔리제이와 같은 개발 도구로 애플리케이션을 실행하셨다면 nginx.conf 파일의 백엔드 스트림에 대한 주소를 <code>host.docker.internal</code>로 변경하세요. 컨테이너로 실행된 엔진엑스에서 로컬 호스트로 트래픽이 전달되게 됩니다.</p><p><img data-src="/images/posts/local-for-http2/security-overview.png" alt="TLS Handshake"><br><img data-src="/images/posts/local-for-http2/network-overview.png" alt="HTTP/2"></p><blockquote><p>mkcert가 자동으로 신뢰 기관 목록에 자신의 CA 인증서를 등록하였기 때문에 브라우저는 인증서를 신뢰할 수 있다고 판단했고 HTTPS 연결이 정상적으로 수행되었습니다.</p></blockquote><p>이제 여러분들도 로컬 환경에서 개발하실때 HTTPS와 그리고 HTTP 1.1이 아닌 HTTP&#x2F;2를 사용해보시기 바랍니다.</p><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;지난 &lt;a href=&quot;/ssl-certificate&quot;&gt;SSL 인증서&lt;/a&gt;와 &lt;a href=&quot;/tls-offload&quot;&gt;TLS 오프로드&lt;/a&gt;라는 글을 통해 HTTPS에 대해서 살펴본 적이 있습니다. 이처럼 HTTPS는 사용자의 요청이 안전하게 서</summary>
      
    
    
    
    
    <category term="Spring Boot" scheme="https://kdevkr.github.io/tags/Spring-Boot/"/>
    
    <category term="Nginx" scheme="https://kdevkr.github.io/tags/Nginx/"/>
    
    <category term="TLS" scheme="https://kdevkr.github.io/tags/TLS/"/>
    
    <category term="HTTP2" scheme="https://kdevkr.github.io/tags/HTTP2/"/>
    
    <category term="mkcert" scheme="https://kdevkr.github.io/tags/mkcert/"/>
    
  </entry>
  
  <entry>
    <title>EC2 인스턴스 유형을 교체하는 이유</title>
    <link href="https://kdevkr.github.io/reason-for-replacing-ec2-instance-type/"/>
    <id>https://kdevkr.github.io/reason-for-replacing-ec2-instance-type/</id>
    <published>2022-02-20T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.512Z</updated>
    
    <content type="html"><![CDATA[<p>서비스의 규모 그리고 서비스를 운영하는 조직의 규모가 크건 작건 서비스를 유지하기 위해 들어가는 클라우드 인프라 환경에 대한 비용은 생각보다 중요한 부분입니다. 작은 조직에서 비용에 대해 예민할지는 몰라도 오히려 인프라 팀이 별도로 존재하는 조직이라면 더 효율적으로 인프라 환경을 구성할 수 밖에 없어보입니다. 그래서 많은 조직에서는 서비스 인프라 비용을 줄이기 위해 <a href="https://gameanalytics.com/product-updates/reduce-costs-https-api-aws/">몇가지 트래픽을 줄일 수 있는 노력</a>을 한다거나 <a href="https://aws.amazon.com/ko/blogs/korea/cost-optimization-cases-ridibooks-reserved-instance/">일정 기간동안 사용할 수 있는 자원을 구매해서 사용</a>하고 <a href="https://www.grumatic.com/ko/aws-ebs-gp3-cost-saving/">인프라 자원의 성능을 비교해서 동일한 성능 대비 가격이 작은 것을 선택</a>하기도 합니다.</p><h2 id="EC2-인스턴스-유형"><a href="#EC2-인스턴스-유형" class="headerlink" title="EC2 인스턴스 유형"></a>EC2 인스턴스 유형</h2><p>아마존 웹 서비스에서는 다양한 목적에 맞는 <a href="https://aws.amazon.com/ko/ec2/instance-types/">인스턴스 유형</a>을 제공하고 있습니다. 여러가지 인스턴스 유형 중 <a href="https://aws.amazon.com/ko/ec2/graviton/">ARM 기반의 AWS Graviton</a> 프로세서를 사용하는 인스턴스가 동일한 성능 대비 더 절약된 요금으로 서버를 구성할 수 있습니다. Graviton 프로세서에 대해 자세하게 알고 싶다면 <a href="https://engineering.ab180.co/stories/migrating-python-application-to-arm">Python x ARM: Graviton2 실전 도입기</a>를 참고하시면 될 것 같습니다.</p><p>아래는 <a href="https://ec2.shop/?region=ap-northeast-2&filter=t2,t3,t3a,t4g">EC 인스턴스 유형별 요금 비교</a> 중 일반적으로 사용될만한 CPU와 메모리 구성을 가진 인스턴스만을 필터한 결과입니다.</p><p><img data-src="/images/posts/reason-for-replacing-ec2-instance-type/ec2-instance-type-compare-pricing.png" alt="ec2.shop/?region=ap-northeast-2&amp;filter=t2,t3,t3a,t4g">  </p><p>각 인스턴스별로 일부 스펙에 의한 성능 차이는 있겠지만 T2 인스턴스보다는 <a href="https://aws.amazon.com/ko/ec2/nitro/">Nitro System</a>으로 확장된 <strong>T3 인스턴스</strong>가 더 작은 요금이 할당됩니다. 그리고 인텔 프로세서 기반의 T3 인스턴스 보다는 AMD 프로세서 기반의 <strong>T3a 인스턴스</strong>가 더 작은 요금이 듭니다. 그리고 AWS Graviton 프로세서를 사용하는 ARM 아키텍처 기반의 <strong>T4g 인스턴스</strong>가 더 요금이 적게 듭니다.</p><h3 id="아키텍처-변경-제한"><a href="#아키텍처-변경-제한" class="headerlink" title="아키텍처 변경 제한"></a>아키텍처 변경 제한</h3><p>특정 아키텍처 기반의 AMI로 시작된 인스턴스 유형은 다른 아키텍처를 사용하는 인스턴스 유형으로 교체할 수 없습니다. 이는 아키텍처간 호환성이 없기 때문이므로 x86 아키텍처 기반의 기존 인스턴스 유형을 ARM 아키텍처 기반으로 변경하기 위해서는 ARM 기반의 AMI로 인스턴스를 시작하고 기존 인스턴스로부터 마이그레이션을 수행해야만합니다.</p><blockquote><p>현재 조직에서도 예약 인스턴스를 구매하여 사용중인 것은 만료된 이후 Graviton 인스턴스로 변경하려고 예정하고 있고 아키텍처 전환 문제로 인하여 Graviton으로 변경할 수 없는 일부 인스턴스들은 AMD 프로세서 기반의 인스턴스로 일부 변경하였습니다.</p></blockquote><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;서비스의 규모 그리고 서비스를 운영하는 조직의 규모가 크건 작건 서비스를 유지하기 위해 들어가는 클라우드 인프라 환경에 대한 비용은 생각보다 중요한 부분입니다. 작은 조직에서 비용에 대해 예민할지는 몰라도 오히려 인프라 팀이 별도로 존재하는 조직</summary>
      
    
    
    
    
    <category term="EC2" scheme="https://kdevkr.github.io/tags/EC2/"/>
    
    <category term="AWS Graviton2" scheme="https://kdevkr.github.io/tags/AWS-Graviton2/"/>
    
  </entry>
  
  <entry>
    <title>벨리데이션 오류 메시지가 사용자 언어로 처리되지 않은 이유</title>
    <link href="https://kdevkr.github.io/spring-validation/"/>
    <id>https://kdevkr.github.io/spring-validation/</id>
    <published>2022-02-17T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.516Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>스프링 부트 애플리케이션에서 벨리데이션 오류 메시지가 사용자가 언어로 처리되지 않는 사유를 경험하여 이와 같은 문제가 발생한 이유에 대해서 알아보고 스프링에서 제공하는 벨리데이션에 대해서 정리한 글입니다.<br>관련 코드는 <a href="https://github.com/kdevkr/spring-demo-validation">spring-demo-validation</a>에서 확인할 수 있습니다.</p></blockquote><h2 id="자카르타-벨리데이션"><a href="#자카르타-벨리데이션" class="headerlink" title="자카르타 벨리데이션"></a>자카르타 벨리데이션</h2><p>스프링 부트 애플리케이션에서는 벨리데이션 스타터를 통해 <a href="https://beanvalidation.org/2.0/">자카르타 벨리데이션</a> 기반의 <a href="https://hibernate.org/validator/">하이버네이트 벨리데이터</a>를 사용하여 벨리데이션을 수행할 수 있는 기능을 제공합니다. 이 스타터가 포함되면 <strong>ValidationAutoConfiguration</strong>이라는 자동 구성 클래스를 통해 기본적인 벨리데이터(Validator)를 사용할 수 있도록 빈으로 등록해줍니다.</p><pre class="language-groovy" data-language="groovy"><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-validation'</span><span class="token punctuation">&#125;</span></code></pre><p>그래서 스프링 부트 개발자들은 별도의 설정없이 컨트롤러 핸들러 함수에 전달되는 사용자 요청 정보를 간단하게 검증할 수 있게 됩니다. 또한, 하이버네이트 벨리데이터 라이브러리에는 벨리데이션을 위한 어노테이션에 대한 기본적인 <strong>벨리데이션 메시지 소스 번들</strong> 을 포함하고 있어 한국어나 영어와 같이 주요 국가에서 사용하는 언어에 대해서는 메시지를 처리하여 번역된 메시지를 사용자에게 제공할 수 있습니다.</p><p><img data-src="/images/posts/spring-validation/hibernate-validator-01.png" alt="org.hibernate.validator.ValidationMessages"></p><h3 id="유효성-검사"><a href="#유효성-검사" class="headerlink" title="유효성 검사"></a>유효성 검사</h3><p><a href="https://meetup.toast.com/posts/223">Validation 어디까지 해봤니?</a>에서 알 수 있듯이 자카르타 벨리데이션의 팩토리 함수를 통해 간단하게 벨리데이터를 생성하고 자바 빈 클래스에 저장된 정보가 올바른지 필드 검증을 쉽게 수행할 수 있습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginService</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token class-name">Account<span class="token punctuation">.</span>Login</span> login<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Validator</span> validator <span class="token operator">=</span> <span class="token class-name">Validation</span><span class="token punctuation">.</span><span class="token function">buildDefaultValidatorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConstraintViolation</span><span class="token punctuation">&lt;</span><span class="token class-name">Account<span class="token punctuation">.</span>Login</span><span class="token punctuation">></span><span class="token punctuation">></span></span> constraintViolations <span class="token operator">=</span> validator<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> constraintViolations<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h3 id="로케일-이슈"><a href="#로케일-이슈" class="headerlink" title="로케일 이슈"></a>로케일 이슈</h3><p>자카르타 벨리데이션의 팩토리 함수로 만들어지는 벨리데이터는 기본값으로 정의된 설정을 통해서 벨리데이션을 수행하기 때문에 <code>사용자의 언어 정보에 따라 벨리데이션에 대한 오류 메시지가 번역되지 않는 문제</code>가 있습니다. 이러한 문제는 고객의 요구사항에 의해서 CSV 또는 엑셀 파일을 업로드하여 웹 서비스를 이용할 때 필수로 등록되어야하는 과정을 벌크 형식으로 지원해야했고 구현 과정에서 애플리케이션 컨텍스트에 등록된 벨리데이터가 아닌 팩토리 함수로 만들어지는 벨리데이터를 사용해서 벨리데이션을 수행하면서 발견되었습니다.</p><pre class="language-sh" data-language="sh"><code class="language-sh">LoginController : [ConstraintViolationImpl&#123;interpolatedMessage&#x3D;&#39;공백일 수 없습니다&#39;, propertyPath&#x3D;loginId, rootBeanClass&#x3D;class com.example.springboot.bean.Account$Login, messageTemplate&#x3D;&#39;&#123;javax.validation.constraints.NotBlank.message&#125;&#39;&#125;]LoginController : locale: en_US</code></pre><blockquote><p>위와 같이 로그인 요청 정보에 대한 벨리데이션을 수행하였고 로그인 요청을 한 사용자의 언어 정보와 함께 벨리데이션 오류에 대한 메시지를 출력해보면 사용자의 언어가 아니라 시스템 로케일 정보인 한국어로 메시지가 번역되어 처리되었음을 확인할 수 있습니다.</p></blockquote><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">MessageInterpolator</span> messageInterpolator <span class="token operator">=</span> <span class="token class-name">Validation</span><span class="token punctuation">.</span><span class="token function">byDefaultProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultMessageInterpolator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>messageInterpolator <span class="token keyword">instanceof</span> <span class="token class-name">ResourceBundleMessageInterpolator</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"defaultMessageInterpolator is ResourceBundleMessageInterpolator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">Validator</span> validator <span class="token operator">=</span> <span class="token class-name">Validation</span><span class="token punctuation">.</span><span class="token function">byDefaultProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">messageInterpolator</span><span class="token punctuation">(</span>messageInterpolator<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">buildValidatorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">getValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConstraintViolation</span><span class="token punctuation">&lt;</span><span class="token class-name">Account<span class="token punctuation">.</span>Login</span><span class="token punctuation">></span><span class="token punctuation">></span></span> constraintViolations <span class="token operator">=</span> validator<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>loginInfo<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>기본 메시지 인터폴레이터를 가져와서 ResourceBundleMessageInterpolator 클래스의 인스턴스인지를 비교해보면 위 로그가 출력되는 것을 확인할 수 있습니다. 그리고 동일하게 사용자 언어가 아닌 시스템 로케일을 기반으로 메시지가 처리됨을 보여줍니다.</p><pre class="language-none"><code class="language-none">LoginController : defaultMessageInterpolator is ResourceBundleMessageInterpolatorLoginController : [ConstraintViolationImpl&#123;interpolatedMessage&#x3D;&#39;공백일 수 없습니다&#39;, propertyPath&#x3D;loginId, rootBeanClass&#x3D;class com.example.springboot.bean.Account$Login, messageTemplate&#x3D;&#39;&#123;javax.validation.constraints.NotBlank.message&#125;&#39;&#125;]LoginController : locale: en_US</code></pre><h2 id="사용자-언어-기반의-메시지-처리"><a href="#사용자-언어-기반의-메시지-처리" class="headerlink" title="사용자 언어 기반의 메시지 처리"></a>사용자 언어 기반의 메시지 처리</h2><p>기본 벨리데이터는 시스템 로케일을 기반으로 메시지가 처리됨을 확인하였으니 사용자의 언어 정보를 기반으로 메시지를 처리하기 위해서는 어떻게 하여야하는지 알아보도록 하겠습니다. <a href="https://docs.jboss.org/hibernate/validator/3.0/api/org/hibernate/validator/MessageInterpolator.html">MessageInterpolator</a> 인터페이스를 사용하여 메시지를 처리하도록 되어있기 때문에 사용자의 언어 정보를 사용하는 MessageInterpolator를 적용해야합니다.</p><p>스프링에서 사용자의 요청에 의한 스레드 내에서는 LocaleContextHolder 클래스를 통해 사용자의 로케일 정보를 쉽게 가져올 수 있도록 제공합니다. 그리고 이 클래스를 사용해서 로케일 정보를 가져와서 메시지를 처리하는 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/validation/beanvalidation/LocaleContextMessageInterpolator.html"><strong>LocaleContextMessageInterpolator</strong></a>를 제공하고 있습니다.</p><p>기본 메시지 인터폴레이터인 ResourceBundleMessageInterpolator를 LocaleContextMessageInterpolator의 생성자로 전달하여 MessageInterpolator를 대체하여 적용해보도록 하겠습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">MessageInterpolator</span> messageInterpolator <span class="token operator">=</span> <span class="token class-name">Validation</span><span class="token punctuation">.</span><span class="token function">byDefaultProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultMessageInterpolator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>messageInterpolator <span class="token keyword">instanceof</span> <span class="token class-name">ResourceBundleMessageInterpolator</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"defaultMessageInterpolator is ResourceBundleMessageInterpolator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>messageInterpolator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocaleContextMessageInterpolator</span><span class="token punctuation">(</span>messageInterpolator<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Validator</span> validator <span class="token operator">=</span> <span class="token class-name">Validation</span><span class="token punctuation">.</span><span class="token function">byDefaultProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">messageInterpolator</span><span class="token punctuation">(</span>messageInterpolator<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">buildValidatorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">getValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConstraintViolation</span><span class="token punctuation">&lt;</span><span class="token class-name">Account<span class="token punctuation">.</span>Login</span><span class="token punctuation">></span><span class="token punctuation">></span></span> constraintViolations <span class="token operator">=</span> validator<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>loginInfo<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>그리고 다시 사용자의 로그인 요청을 수행해보고 어떻게 벨리데이션 오류 메시지가 번역되는지 확인해보죠.</p><pre class="language-sh" data-language="sh"><code class="language-sh">LoginController : [ConstraintViolationImpl&#123;interpolatedMessage&#x3D;&#39;must not be blank&#39;, propertyPath&#x3D;loginId, rootBeanClass&#x3D;class com.example.springboot.bean.Account$Login, messageTemplate&#x3D;&#39;&#123;javax.validation.constraints.NotBlank.message&#125;&#39;&#125;]LoginController : locale: en_US</code></pre><blockquote><p>앞선 과정을 통해서 벨리데이션에 대한 메시지 처리는 MessageInterpolator를 사용하므로 LocaleContextMessageInterpolator를 적용하면 스프링에서 관리하는 로케일 정보를 사용해서 메시지를 처리할 수 있음을 이해했습니다.</p></blockquote><h3 id="LocalValidatorFactoryBean"><a href="#LocalValidatorFactoryBean" class="headerlink" title="LocalValidatorFactoryBean"></a>LocalValidatorFactoryBean</h3><p><a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/validation/beanvalidation/LocalValidatorFactoryBean.html">LocalValidatorFactoryBean</a>는 벨리데이션 스타터에 의해서 자동으로 등록되는 벨리데이터입니다. 컨트롤러의 핸들러 함수로 전달되는 과정에서 이 벨리데이터를 통해서 사용자의 요청 정보를 검증하며 벨리데이션 오류 메시지를 제공하게 됩니다.</p><p>현재 조직에서는 오래전에 공유한 <a href="managing-i18n-messages-with-xml">XML로 다국어 메시지 관리하기</a>에서처럼 XML 파일을 기반으로 다국어 메시지 정보를 관리하고 있으며 이 메시지 소스를 사용하도록 자동 구성이 아닌 LocalValidatorFactoryBean를 직접 벨리데이터 빈으로 등록하여 사용하고 있습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">MessageSource</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>validation<span class="token punctuation">.</span>beanvalidation<span class="token punctuation">.</span></span><span class="token class-name">LocalValidatorFactoryBean</span><span class="token punctuation">;</span><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageConfig</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">LocalValidatorFactoryBean</span> <span class="token function">validator</span><span class="token punctuation">(</span><span class="token class-name">CustomMessageSource</span> customMessageSource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">LocalValidatorFactoryBean</span> factoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalValidatorFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        factoryBean<span class="token punctuation">.</span><span class="token function">setValidationMessageSource</span><span class="token punctuation">(</span>customMessageSource<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>위와 같이 LocalValidatorFactoryBean를 등록할 때 벨리데이션 메시지 소스를 지정하는 것은 하이버네이트 벨리데이터에 의해 클래스패스에 포함된 ValidationMessages를 사용하지 못한다는 내재된 결함을 가지게 됩니다.</p><pre class="language-sh" data-language="sh"><code class="language-sh">LoginController : [ConstraintViolationImpl&#123;interpolatedMessage&#x3D;&#39;javax.validation.constraints.NotBlank.message&#39;, propertyPath&#x3D;loginId, rootBeanClass&#x3D;class com.example.springboot.bean.Account$Login, messageTemplate&#x3D;&#39;&#123;javax.validation.constraints.NotBlank.message&#125;&#39;&#125;]LoginController : locale: en_US</code></pre><blockquote><p>기본으로 사용되는 ValidationMessages 대신에 벨리데이션 메시지 소스를 지정하였기에 해당 메시지로 처리되지 않았습니다. 왜냐하면 JSR-303 어노테이션에 대한 메시지는 직접 정의하지 않았기 때문이죠.</p></blockquote><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span><span class="token keyword">public</span> <span class="token class-name">LocalValidatorFactoryBean</span> <span class="token function">validator</span><span class="token punctuation">(</span><span class="token class-name">CustomMessageSource</span> messageSource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">LocalValidatorFactoryBean</span> factoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalValidatorFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    factoryBean<span class="token punctuation">.</span><span class="token function">setValidationMessageSource</span><span class="token punctuation">(</span>messageSource<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">MessageInterpolator</span> defaultMessageInterpolator <span class="token operator">=</span> <span class="token class-name">Validation</span><span class="token punctuation">.</span><span class="token function">byDefaultProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultMessageInterpolator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">LocaleContextMessageInterpolator</span> localeContextMessageInterpolator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocaleContextMessageInterpolator</span><span class="token punctuation">(</span>defaultMessageInterpolator<span class="token punctuation">)</span><span class="token punctuation">;</span>    factoryBean<span class="token punctuation">.</span><span class="token function">setMessageInterpolator</span><span class="token punctuation">(</span>localeContextMessageInterpolator<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>현재 조직처럼 사용자 정의 메시지 소스를 벨리데이션 메시지 소스로도 사용하도록 지정하였다면 위와 같이 MessageInterpolator를 지정하는게 좋습니다. 이때에도 사용자의 언어 정보에 따라 메시지가 처리되도록 LocaleContextMessageInterpolator를 적용해야합니다.</p><h4 id="MessageInterpolatorFactory"><a href="#MessageInterpolatorFactory" class="headerlink" title="MessageInterpolatorFactory"></a>MessageInterpolatorFactory</h4><p>LocalValidatorFactoryBean을 자동 구성하는 ValidationAutoConfiguration 클래스를 살펴보면 LocaleContextMessageInterpolator이 아니라 스프링 부트에서 추가된 MessageInterpolatorFactory를 통해 MessageInterpolator를 가져와서 등록하는 것을 확인할 수 있습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ValidationAutoConfiguration</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">LocalValidatorFactoryBean</span> <span class="token function">defaultValidator</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">LocalValidatorFactoryBean</span> factoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalValidatorFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">MessageInterpolatorFactory</span> interpolatorFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageInterpolatorFactory</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>        factoryBean<span class="token punctuation">.</span><span class="token function">setMessageInterpolator</span><span class="token punctuation">(</span>interpolatorFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>이를 참고하여 사용자 정의 메시지 소스 번들을 벨리데이션 메시지 소스로 지정하였더라도 MessageInterpolatorFactory를 통해 ResourceBundleMessageInterpolator에 의해서 메시지가 번역되어 처리됨을 확인할 수 있습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span><span class="token keyword">public</span> <span class="token class-name">LocalValidatorFactoryBean</span> <span class="token function">validator</span><span class="token punctuation">(</span><span class="token class-name">CustomMessageSource</span> messageSource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">LocalValidatorFactoryBean</span> factoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalValidatorFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    factoryBean<span class="token punctuation">.</span><span class="token function">setValidationMessageSource</span><span class="token punctuation">(</span>messageSource<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">MessageInterpolatorFactory</span> messageInterpolatorFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageInterpolatorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    factoryBean<span class="token punctuation">.</span><span class="token function">setMessageInterpolator</span><span class="token punctuation">(</span>messageInterpolatorFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>그런데 앞선 자카르타 팩토리 함수에 의해 생성된 벨리데이터도 ResourceBundleMessageInterpolator를 사용하였는데 어떻게 LocalValidatorFactoryBean는 사용자 언어 정보에 따라 오류 메시지를 처리해주게 되는 것일까요?</p></blockquote><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">MessageInterpolator</span> targetInterpolator <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageInterpolator<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>targetInterpolator <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    targetInterpolator <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getDefaultMessageInterpolator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>configuration<span class="token punctuation">.</span><span class="token function">messageInterpolator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LocaleContextMessageInterpolator</span><span class="token punctuation">(</span>targetInterpolator<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>위 코드는 LocalValidatorFactoryBean이 빈으로 등록되고 난 후 afterPropertiesSet 함수에 의해 수행되는 코드 중 일부입니다. LocalValidatorFactoryBean을 빈으로 등록할 때 MessageInterpolatorFactory에 의해 가져온 ResourceBundleMessageInterpolator를 지정하였지만 이를 다시 LocaleContextMessageInterpolator로 변환하여 등록함을 확인할 수 있습니다. </p><p>결국 LocalValidatorFactoryBean을 빈으로 등록할 때는 다음과 같이 LocaleContextMessageInterpolator를 전달하지 않아도 됨을 의미합니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span><span class="token keyword">public</span> <span class="token class-name">LocalValidatorFactoryBean</span> <span class="token function">validator</span><span class="token punctuation">(</span><span class="token class-name">CustomMessageSource</span> messageSource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">LocalValidatorFactoryBean</span> factoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalValidatorFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    factoryBean<span class="token punctuation">.</span><span class="token function">setValidationMessageSource</span><span class="token punctuation">(</span>messageSource<span class="token punctuation">)</span><span class="token punctuation">;</span>    factoryBean<span class="token punctuation">.</span><span class="token function">setMessageInterpolator</span><span class="token punctuation">(</span><span class="token class-name">Validation</span><span class="token punctuation">.</span><span class="token function">byDefaultProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultMessageInterpolator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h3 id="사용자-정의-메시지"><a href="#사용자-정의-메시지" class="headerlink" title="사용자 정의 메시지"></a>사용자 정의 메시지</h3><p>그렇다면 다음과 같이 ValidationMessages에 정의된 메시지 코드를 정의하면 어떻게 메시지가 처리될까요?</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>messages</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>javax.validation.constraints.NotBlank.message<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ko_KR</span><span class="token punctuation">></span></span><span class="token cdata">&lt;![CDATA[[사용자 정의] 공백일 수 없습니다]]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ko_KR</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>en_US</span><span class="token punctuation">></span></span><span class="token cdata">&lt;![CDATA[[Custom] must not be blank]]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>en_US</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>messages</span><span class="token punctuation">></span></span></code></pre><p>NotBlank에 대한 메시지를 정의했지만 ValidationMessages에 정의된 메시지로 처리됨을 확인할 수 있을겁니다. 이렇게 되는 이유는 setValidationMessageSource 함수 동작에 있습니다. setValidationMessageSource 함수의 코드를 살펴보면 파라미터로 전달된 메시지 소스를 기반으로 ResourceBundleMessageInterpolator를 만들어서 MessageInterpolator를 변경하도록 되어있기 때문입니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValidationMessageSource</span><span class="token punctuation">(</span><span class="token class-name">MessageSource</span> messageSource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>messageInterpolator <span class="token operator">=</span> <span class="token class-name">HibernateValidatorDelegate</span><span class="token punctuation">.</span><span class="token function">buildMessageInterpolator</span><span class="token punctuation">(</span>messageSource<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">HibernateValidatorDelegate</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">MessageInterpolator</span> <span class="token function">buildMessageInterpolator</span><span class="token punctuation">(</span><span class="token class-name">MessageSource</span> messageSource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResourceBundleMessageInterpolator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageSourceResourceBundleLocator</span><span class="token punctuation">(</span>messageSource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>결국 setValidationMessageSource와 setMessageInterpolator는 동시에 적용할 수 없으므로 사용자 정의 메시지 소스를 지정한 것이 의미없는 쓰레기 코드가 됩니다.</p></blockquote><p>스프링 부트 2.6.0 버전부터는 MessageInterpolatorFactory 생성자가 메시지 소스를 받을 수 있도록 수정되었고 생성자에 의해 전달된 메시지 소스가 있다면 MessageSourceMessageInterpolator로 변경하여주는 코드가 추가되어있습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token class-name">MessageInterpolator</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">MessageInterpolator</span> messageInterpolator <span class="token operator">=</span> <span class="token function">getMessageInterpolator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageSource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MessageSourceMessageInterpolator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageSource<span class="token punctuation">,</span> messageInterpolator<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> messageInterpolator<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h3 id="사용자-정의-제약사항"><a href="#사용자-정의-제약사항" class="headerlink" title="사용자 정의 제약사항"></a>사용자 정의 제약사항</h3><p>사용자 정의 메시지 소스를 제공하더라도 메시지 패턴에서 {value}와 같은 파라미터 표현이 불가능합니다. 예를 들어, 다음과 같이 어떤 값에 대한 길이를 제한한다고 가정하여 @Min 어노테이션을 부여했다고 가정하겠습니다.</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>messages</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>javax.validation.constraints.Min.message<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ko_KR</span><span class="token punctuation">></span></span><span class="token cdata">&lt;![CDATA[(사용자 정의) &#123;value&#125; 보다 같거나 커야합니다]]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ko_KR</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>en_US</span><span class="token punctuation">></span></span><span class="token cdata">&lt;![CDATA[(Custom) must be greater than or equal to &#123;value&#125;]]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>en_US</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>messages</span><span class="token punctuation">></span></span></code></pre><p>사용자 정의 메시지에서 VailidationMessages에 정의된 것처럼 파라미터 표현을 사용해보겠습니다.</p><pre class="language-none"><code class="language-none">org.springframework.web.util.NestedServletException: Request processing failed; nested exception is javax.validation.ValidationException: HV000149: An exception occurred during message interpolation...Caused by: java.lang.IllegalArgumentException: can&#39;t parse argument number: valueat java.base&#x2F;java.text.MessageFormat.makeFormat(MessageFormat.java:1451) ~[na:na]at java.base&#x2F;java.text.MessageFormat.applyPattern(MessageFormat.java:491) ~[na:na]at java.base&#x2F;java.text.MessageFormat.&lt;init&gt;(MessageFormat.java:390) ~[na:na]...Caused by: java.lang.NumberFormatException: For input string: &quot;value&quot;at java.base&#x2F;java.lang.NumberFormatException.forInputString(NumberFormatException.java:65) ~[na:na]at java.base&#x2F;java.lang.Integer.parseInt(Integer.java:652) ~[na:na]at java.base&#x2F;java.lang.Integer.parseInt(Integer.java:770) ~[na:na]at java.base&#x2F;java.text.MessageFormat.makeFormat(MessageFormat.java:1449) ~[na:na]</code></pre><blockquote><p>이러한 파라미터 표현은 Hibernate Validator에서 지원하는 표현식이므로 MessageFormat가 지원하는 표현식과는 다릅니다. MessageFormat는 {0}, {1} 이렇게 숫자 기반의 표현식을 지원하기 때문에 표현식 제약이 발생합니다. 아쉽지만 사용자 정의 메시지에서 파라미터 표현식을 사용하지 않을 수 밖에 없고 파라미터 표현식을 사용해야한다면 ValidationMessages 리소스 번들을 클래스패스에 재정의해서 사용할 수 밖에 없습니다. </p></blockquote><p>언어별 메시지가 정의된 프로퍼티 파일을 보완하고자 XML로 메시지를 정의하여 메시지 소스를 만들어서 사용했지만 의도하지 않은 제약이 생겨버렸습니다. 불편하더라도 벨리데이션 메시지는 프로퍼티 파일로 관리해서 ResourceBundleMessageInterpolator에 의해 처리되도록 해야할 것 같습니다.</p><p>감사합니다.</p><h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul><li><a href="/managing-i18n-messages-with-xml">XML로 다국어 메시지 관리하기</a></li><li><a href="https://meetup.toast.com/posts/223">Validation 어디까지 해봤니?</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;스프링 부트 애플리케이션에서 벨리데이션 오류 메시지가 사용자가 언어로 처리되지 않는 사유를 경험하여 이와 같은 문제가 발생한 이유에 대해서 알아보고 스프링에서 제공하는 벨리데이션에 대해서 정리한 글입니다.&lt;br&gt;관련 코드는</summary>
      
    
    
    
    
    <category term="Jakarta Bean Validation" scheme="https://kdevkr.github.io/tags/Jakarta-Bean-Validation/"/>
    
    <category term="Hibernate Validator" scheme="https://kdevkr.github.io/tags/Hibernate-Validator/"/>
    
  </entry>
  
  <entry>
    <title>스프링 부트 액세스 로그를 엘라스틱서치에 기록하기</title>
    <link href="https://kdevkr.github.io/spring-boot-accesslog-with-elasticsearch/"/>
    <id>https://kdevkr.github.io/spring-boot-accesslog-with-elasticsearch/</id>
    <published>2022-02-10T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.516Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>애플리케이션 서버로 요청되는 정보를 기록하는 <a href="https://d2.naver.com/helloworld/3585246">액세스 로그</a>는 애플리케이션 운영과 장애 대응에 있어서 상당히 중요한 정보입니다. 아마존 웹 서비스에서도 <a href="https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/enable-server-access-logging.html">Amazon S3 서버 액세스 로깅 활성화</a>처럼 액세스 로그를 기록할 수 있는 기능을 제공하죠. 스프링 부트는 <strong>톰캣(Tomcat)</strong> 이나 <strong>언더토우(Undertow)</strong> 와 같은 WAS에 대하여 액세스 로그를 파일로 저장할 수 있는 기능을 기본적으로 포함하고 있습니다.</p><p>만약, 언더토우를 사용하고 있다면 다음과 같이 액세스 로그를 활성화하고 패턴을 지정할 수 있습니다.</p><pre class="language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">server.undertow.accesslog.enabled</span><span class="token punctuation">=</span><span class="token attr-value">true</span><span class="token attr-name">server.undertow.accesslog.pattern</span><span class="token punctuation">=</span><span class="token attr-value">common</span></code></pre><h2 id="스프링-부트-로깅"><a href="#스프링-부트-로깅" class="headerlink" title="스프링 부트 로깅"></a>스프링 부트 로깅</h2><p>스프링 부트는 기본적으로 Slf4j 기반의 <a href="https://logback.qos.ch/">로그백(Logback)</a>을 로깅 프레임워크로 사용합니다. 그래서 애플리케이션의 로그를 엘라스틱서치에 기록하기 위해서는 <a href="https://github.com/logfellow/logstash-logback-encoder">Logstash Logback Encoder</a>와 같이 로그백으로 기록되는 로그를 엘라스틱서치로 전달할 수 있게 구현해야합니다.</p><h3 id="Logback-Elasticsearch-Appender"><a href="#Logback-Elasticsearch-Appender" class="headerlink" title="Logback Elasticsearch Appender"></a>Logback Elasticsearch Appender</h3><p><a href="https://github.com/internetitem/logback-elasticsearch-appender">Logback Elasticsearch Appender</a>는 ELK 스택이 아니더라도 로그백으로 기록되는 로그를 엘라스틱서치로 전달하는 기능을 제공합니다. 오늘은 이것을 활용하여 스프링 부트 애플리케이션에서 발생하는 액세스 로그를 엘라스틱서치에 기록해보고자 합니다. </p><p><img data-src="/images/posts/spring-boot-accesslog-with-elasticsearch/logback-elasticsearch-appender-01.png"></p><p>그리고 위 처럼 <a href="https://logback.qos.ch/access.html">Logback Access</a>에 대한 Appender를 포함하고 있으므로 액세스 로그를 쉽게 엘라스틱서치로 전달할 수 있게 됩니다.</p><h3 id="Logback-Access-Spring-Boot-Starter"><a href="#Logback-Access-Spring-Boot-Starter" class="headerlink" title="Logback Access Spring Boot Starter"></a>Logback Access Spring Boot Starter</h3><p><a href="https://github.com/akkinoc/logback-access-spring-boot-starter">logback-access-spring-boot-starter</a>는 로그백 엑세스 설정에 대한 스프링 부트 스타터입니다. 언더토우까지 지원하므로 언더토우에 대해 로그백 엑세스 설정을 위한 <a href="https://gist.github.com/cdmatta/2a4536ab687bf7a92482faf031e8a0b5">커스터마이저</a>를 직접 구현하지 않아도 됩니다.</p><h3 id="따라하기"><a href="#따라하기" class="headerlink" title="따라하기"></a>따라하기</h3><p>스프링 부트 프로젝트를 만들고 저는 언더토우를 선호하므로 톰캣 모듈을 제외하고 언더토우 스타터를 추가했습니다.</p><pre class="language-groovy" data-language="groovy"><code class="language-groovy">configurations<span class="token punctuation">.</span>all <span class="token punctuation">&#123;</span>    exclude module<span class="token punctuation">:</span> <span class="token string">'spring-boot-starter-tomcat'</span><span class="token punctuation">&#125;</span>dependencies <span class="token punctuation">&#123;</span>    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-web'</span>    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-undertow'</span>    implementation <span class="token string">'com.internetitem:logback-elasticsearch-appender:1.6'</span>    implementation <span class="token string">'dev.akkinoc.spring.boot:logback-access-spring-boot-starter:3.2.1'</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>로그백 엑세스 스타터는 언더토우 뿐만 아니라 톰캣도 지원하므로 설정에 대한 차이는 없습니다.</p></blockquote><p>그리고 다음과 같이 로그백 엑세스를 위한 설정 파일을 클래스패스에 추가합니다. 설정 파일을 불러오는 <a href="https://github.com/akkinoc/logback-access-spring-boot-starter#priority-order">우선순위</a>에 따라 설정 파일명은 logback-access-spring.xml 이라고 생성하겠습니다.</p><p><strong>logback-access-spring.xml</strong></p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>springProperty</span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>context<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>elasticsearch_uris<span class="token punctuation">"</span></span> <span class="token attr-name">source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring.elasticsearch.uris<span class="token punctuation">"</span></span> <span class="token attr-name">defaultValue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://localhost:9200<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ELASTIC<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.internetitem.logback.elasticsearch.ElasticsearchAccessAppender<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">></span></span>$&#123;elasticsearch_uris&#125;/_bulk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>index</span><span class="token punctuation">></span></span>application-accesslog-%date&#123;yyyy-MM-dd&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>index</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>headers</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>Content-Type<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>application/json<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>headers</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ELASTIC<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span></code></pre><p>스프링 부트 애플리케이션을 실행하고 브라우저 또는 클라이언트 도구를 통해 액세스 기록을 남겨보고 엘라스틱서치에 잘 저장되는지 확인해봅니다.</p><p><img data-src="/images/posts/spring-boot-accesslog-with-elasticsearch/elasticsearch-devtools-01.png"></p><p>인덱스는 생성되었지만 액세스 로그에 대한 정보가 없습니다. 액세스 로그 정보를 기록하기 위해서는 <a href="https://logback.qos.ch/manual/layouts.html#logback-access">Logback Access conversion words</a>를 참고해서 프로퍼티를 설정해야합니다. 앞서 생성한 로그백 엑세스 설정 파일에 다음과 같이 프로퍼티 항목을 추가로 정의하겠습니다.</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>springProperty</span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>context<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>elasticsearch_uris<span class="token punctuation">"</span></span> <span class="token attr-name">source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring.elasticsearch.uris<span class="token punctuation">"</span></span> <span class="token attr-name">defaultValue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://localhost:9200<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ELASTIC<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.internetitem.logback.elasticsearch.ElasticsearchAccessAppender<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">></span></span>$&#123;elasticsearch_uris&#125;/_bulk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>index</span><span class="token punctuation">></span></span>application-accesslog-%date&#123;yyyy-MM-dd&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>index</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>contentLength<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%b<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>remoteHost<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%h<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>protocol<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%H<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>referer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%i&#123;Referer&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>userAgent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%i&#123;User-Agent&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>requestMethod<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%m<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>statusCode<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%s<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>elapsedTime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%D<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>date<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%t&#123;yyyy-MM-dd'T'HH:mm:ss&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>user<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%u<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>queryString<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%q<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>requestURI<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%U<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>headers</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>Content-Type<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>application/json<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>headers</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ELASTIC<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span></code></pre><blockquote><p>미리 정의된 패턴인 combined를 참고하여 리퍼러와 유저 에이전트 헤더를 포함하도록 프로퍼티를 설정했습니다.</p></blockquote><p><img data-src="/images/posts/spring-boot-accesslog-with-elasticsearch/elasticsearch-devtools-02.png"></p><p>위 처럼 프로퍼티를 설정하였으므로 요청된 액세스에 대한 로그를 통해 유저 에이전트가 포스트맨이며 요청된 경로는 액추에이터인 것을 확인할 수 있게 되었습니다. 따라하시는 여러분은 다양한 항목에 대해서도 기록해보시면 좋을 것 같습니다.</p><h4 id="액세스-로그-인덱스-템플릿"><a href="#액세스-로그-인덱스-템플릿" class="headerlink" title="액세스 로그 인덱스 템플릿"></a>액세스 로그 인덱스 템플릿</h4><p>생성된 액세스 로그에 대한 인덱스 매핑 정보를 조회하면 동적 매핑에 의해서 엘라스틱서치가 필드 유형을 임의대로 지정한 것을 확인할 수 있습니다. 동적 매핑은 저장되는 도큐먼트의 필드 정보를 알기 어려울 때는 편리한 기능이지만 지금처럼 액세스 로그에 저장되는 필드가 고정되어있고 필드 유형을 파악할 수 있다면 정적 매핑을 정의해두는 것이 좋습니다.</p><p><img data-src="/images/posts/spring-boot-accesslog-with-elasticsearch/elasticsearch-devtools-03.png"></p><p>액세스 로그에 기록되는 정보가 명확하므로 동적 매핑을 수행하지 않고 미리 정의된 매핑을 사용하도록 인덱스 템플릿을 정의해두겠습니다. </p><pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"index_patterns"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">"applicaiton-accesslog-*"</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token property">"template"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"path_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"path_hierarchy"</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>      <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"@timestamp"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"date"</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"contentLength"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"long"</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"date"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"date"</span><span class="token punctuation">,</span>          <span class="token property">"format"</span><span class="token operator">:</span> <span class="token string">"date_hour_minute_second || epoch_millis"</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"elapsedTime"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"protocol"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"referer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"remoteHost"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"ip"</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"requestMethod"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"requestURI"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>          <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"path_analyzer"</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"statusCode"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"short"</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"user"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"userAgent"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>현재 조직에서는 엘라스틱서치에 애플리케이션의 로그 및 액세스 로그를 기록하지는 않고 있습니다만, 엘라스틱서치를 학습하기 위한 샘플 데이터가 없어서 간단하게나마 액세스 로그를 기록해보면 어떠할까 생각해서 시도해보았습니다. 현재 대량의 <a href="https://github.com/kdevkr/elasticsearch/blob/main/sample/access.q">랜덤 액세스 로그</a>를 만들기 위해서 컬럼형 시계열 데이터베이스인 KDB를 활용해보고는 있습니다만 쉽지는 않네요. 이 부분에 대해서는 많이 시도해보고 정리하여 공유해보겠습니다.</p></blockquote><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;애플리케이션 서버로 요청되는 정보를 기록하는 &lt;a href=&quot;https://d2.naver.com/helloworld/3585246&quot;&gt;액세스 로그&lt;/a&gt;는 애플리케이션 운영과 장애 대응에 있어서 상당히 </summary>
      
    
    
    
    
    <category term="Spring Boot" scheme="https://kdevkr.github.io/tags/Spring-Boot/"/>
    
    <category term="Elasticsearch" scheme="https://kdevkr.github.io/tags/Elasticsearch/"/>
    
    <category term="Access Log" scheme="https://kdevkr.github.io/tags/Access-Log/"/>
    
  </entry>
  
  <entry>
    <title>Base64</title>
    <link href="https://kdevkr.github.io/base64/"/>
    <id>https://kdevkr.github.io/base64/</id>
    <published>2022-01-22T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.512Z</updated>
    
    <content type="html"><![CDATA[<p><img data-src="/images/posts/base64/base64-01.png"></p><p>위와 같이 어떤 서비스에 대한 회원가입을 수행하거나 비밀번호 찾기와 같은 기능을 수행했을경우 인증 관련 메일이 발송되는 것을 자주 확인할 수 있습니다. 그러나 위와 같이 인증확인 버튼을 클릭했을때 어떠한 동작을 하는지 궁금하시지 않으신가요? 위와 같은 인증 버튼은 링크 엘리먼트로 되어있으며 일반적인 GET 요청입니다. 그리고 그 URI에는 다음과 같은 어떠한 형태의 문자열이 포함되게 됩니다.</p><blockquote><p>a2RldmtyQGdtYWlsLmNvbTp5Rm5iTUtrblZrRW85ckdxTVlmTGtWNE03UUtMTldXWg&#x3D;&#x3D;</p></blockquote><p>위와 같이 구성된 문자열은 Base64로 인코딩된 데이터이며 크롬 개발자도구의 콘솔을 통해 이 아스키 문자열을 디코딩하면 다음과 같은 문자열 데이터를 확인할 수 있습니다.</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token function">atob</span><span class="token punctuation">(</span><span class="token string">"a2RldmtyQGdtYWlsLmNvbTp5Rm5iTUtrblZrRW85ckdxTVlmTGtWNE03UUtMTldXWg=="</span><span class="token punctuation">)</span><span class="token string">'kdevkr@gmail.com:yFnbMKknVkEo9rGqMYfLkV4M7QKLNWWZ'</span></code></pre><p>제 이메일 주소와 함께 어떠한 문자열을 포함하고 있습니다. 아마도 저 알수없는 문자열은 암호화된 인증 정보일 것입니다. 인증 정보와 GET 요청에 포함된 이메일 주소가 동일한지를 내부적으로 검증하겠죠. 이러한 인증 정보를 왜 Base64로 인코딩하여 전송하게 되는 것일까요? <strong>안전한 형태로 데이터를 전달하고자하는 목적</strong>에 있습니다.</p><h2 id="아스키-코드"><a href="#아스키-코드" class="headerlink" title="아스키 코드"></a>아스키 코드</h2><p>사람들은 수 많은 문자의 형태를 읽고 구분할 수 있지만 0과 1로 이루어진 컴퓨터 시스템은 시스템에 따라 0과 1을 읽고 구분하는 방식이 다를 수 있습니다. 시스템의 발전에 따라 아스키 코드부터 유니코드 그리고 여러가지 문자 조합이 확장되고 있습니다. 대부분의 문자 형식은 아스키 코드를 기초로 만들어지기 때문에 아스키 코드 중 일부 문자 집합은 거의 모든 시스템에서 공통으로 사용되는 문자입니다. 그러한 문자들을 모아 만들어지는게 Base64 인코딩입니다.</p><h3 id="Base64-이미지"><a href="#Base64-이미지" class="headerlink" title="Base64 이미지"></a>Base64 이미지</h3><p>브라우저에서는 바이너리 데이터 뿐만 아니라 Base64로 이루어진 이미지 데이터를 표현할 수 있습니다. </p><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAAXNSR0IArs4c6QAAA+VJREFUeF7tnclu4zAUBEf//9EeYG6SAhUKTdJUpnMV1663kbKd4/P5fP70bxsFjgLZhsW/hRTIXjwKZDMeBVIguymw2XqaQwpkMwU2Ww56yHEcS5d8PRZd56djU9p+9mZx/XQOKZCxiAoELiK+bXBX3A1ZXw7JMRByOevgFPNTC6b10vx2PzeBL8BxPTaH0IB2AyRIgVwUJcEsAGtBBVIgqY2d+luD1kmdzgm0G+pPIdF6jB2P1jd9f2kOSQXSFiSrogIBEyILtAJai52dw+L91UPOV0MkqDUAHQHeBsRaOAlIgi0PyQVSD4nKwnoIHP1Xu3SBfBkIxfgUEI2/2uC2PxiSYAVyeb8w24IKRN5lFchZMDrH4ME3LXupzqfn5AH2+XU+FEC+r6D9xCG0QJ7PIRZAgcBlYz1EmpQNSRSj/7uQJfXWzUnw2c/1gmUH9FibQ+T8uvlswWl8vWDZoUAG3zRI/W/NC+S3AUktIu1PST8tM9P1je6Pd1mjJ7TjFYhVbHL7ApkssB2+QOBykQTFKkKerNPLS8oxtJ/0oKn7jz6HFMjzF5xQnwJxPoKCyghw8+ACeTkQunqwFmTHG53kR49HOQv1sR5iBbQLJIHo+ej57Hhx+wJxL6hGG0ScQ+ohkwFaD6G62p4baDxKuWSxuz+PPYQELJDz78GRQRQIfK7MhmQSnJ4XyNuBUBlnQxjV4TZnUPt0Ptr/8PEpqdOCCmTsb4jqF1SUtG0MJgu3BkEGYuej+eshg7+FawHZJK3Hp5A1egGph5EH0Pir+1sPwpBVIM82PjpEF8ji77tQCCuQtwEhorOfz84JFOPT+a0+6CF2wNHtU0Gof4FIYiRoWjUVSIE8KoAhy1qo1PvWPLXYtAxN9xvPbw+GqeDUv0BAgdRiCADlALpLov72YJvutx5yIRILIu/KhhuEDVkUUqxHkAXTc/KgFNDy8QvEvc8gA6HnZLC6yqqHuB88s3oViPyvgeQB9Hy6h9iqZHVMtzkABQu/REoeE3tIgTx/DouqsJvBpEm9QArkZFQ2Ztv2NuSRgf66kDVaUAopJDDlHALw+pBVIGFVYS2QLKpACoSi0uNzMrDXhSyK4bRh8igaP6LxQ2dc7+5lLwmGGxzs4SkgXG+BfPc/mTZkhZ/D2t5D0gXaGD/6LowOfrQ/CkHUf7iH2AlJACs4AbXro5xFZbydr0BAsQKRVZD1IGuxrwNiN2jbW8GtgGnIsSFSt7dlrxXYti+QzT+XRRZWD7EmL9vXQ0YX0hJAm58VwHfqFWytAgWyVm+crUBQorUNCmSt3jhbgaBEaxsUyFq9cbYCQYnWNvgLqC4vPjN7siAAAAAASUVORK5CYII=<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAAXNSR0IArs4c6QAAA+VJREFUeF7tnclu4zAUBEf//9EeYG6SAhUKTdJUpnMV1663kbKd4/P5fP70bxsFjgLZhsW/hRTIXjwKZDMeBVIguymw2XqaQwpkMwU2Ww56yHEcS5d8PRZd56djU9p+9mZx/XQOKZCxiAoELiK+bXBX3A1ZXw7JMRByOevgFPNTC6b10vx2PzeBL8BxPTaH0IB2AyRIgVwUJcEsAGtBBVIgqY2d+luD1kmdzgm0G+pPIdF6jB2P1jd9f2kOSQXSFiSrogIBEyILtAJai52dw+L91UPOV0MkqDUAHQHeBsRaOAlIgi0PyQVSD4nKwnoIHP1Xu3SBfBkIxfgUEI2/2uC2PxiSYAVyeb8w24IKRN5lFchZMDrH4ME3LXupzqfn5AH2+XU+FEC+r6D9xCG0QJ7PIRZAgcBlYz1EmpQNSRSj/7uQJfXWzUnw2c/1gmUH9FibQ+T8uvlswWl8vWDZoUAG3zRI/W/NC+S3AUktIu1PST8tM9P1je6Pd1mjJ7TjFYhVbHL7ApkssB2+QOBykQTFKkKerNPLS8oxtJ/0oKn7jz6HFMjzF5xQnwJxPoKCyghw8+ACeTkQunqwFmTHG53kR49HOQv1sR5iBbQLJIHo+ej57Hhx+wJxL6hGG0ScQ+ohkwFaD6G62p4baDxKuWSxuz+PPYQELJDz78GRQRQIfK7MhmQSnJ4XyNuBUBlnQxjV4TZnUPt0Ptr/8PEpqdOCCmTsb4jqF1SUtG0MJgu3BkEGYuej+eshg7+FawHZJK3Hp5A1egGph5EH0Pir+1sPwpBVIM82PjpEF8ji77tQCCuQtwEhorOfz84JFOPT+a0+6CF2wNHtU0Gof4FIYiRoWjUVSIE8KoAhy1qo1PvWPLXYtAxN9xvPbw+GqeDUv0BAgdRiCADlALpLov72YJvutx5yIRILIu/KhhuEDVkUUqxHkAXTc/KgFNDy8QvEvc8gA6HnZLC6yqqHuB88s3oViPyvgeQB9Hy6h9iqZHVMtzkABQu/REoeE3tIgTx/DouqsJvBpEm9QArkZFQ2Ztv2NuSRgf66kDVaUAopJDDlHALw+pBVIGFVYS2QLKpACoSi0uNzMrDXhSyK4bRh8igaP6LxQ2dc7+5lLwmGGxzs4SkgXG+BfPc/mTZkhZ/D2t5D0gXaGD/6LowOfrQ/CkHUf7iH2AlJACs4AbXro5xFZbydr0BAsQKRVZD1IGuxrwNiN2jbW8GtgGnIsSFSt7dlrxXYti+QzT+XRRZWD7EmL9vXQ0YX0hJAm58VwHfqFWytAgWyVm+crUBQorUNCmSt3jhbgaBEaxsUyFq9cbYCQYnWNvgLqC4vPjN7siAAAAAASUVORK5CYII=<span class="token punctuation">"</span></span> <span class="token attr-name">data-loaded</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre><p><img data-src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAAXNSR0IArs4c6QAAA+VJREFUeF7tnclu4zAUBEf//9EeYG6SAhUKTdJUpnMV1663kbKd4/P5fP70bxsFjgLZhsW/hRTIXjwKZDMeBVIguymw2XqaQwpkMwU2Ww56yHEcS5d8PRZd56djU9p+9mZx/XQOKZCxiAoELiK+bXBX3A1ZXw7JMRByOevgFPNTC6b10vx2PzeBL8BxPTaH0IB2AyRIgVwUJcEsAGtBBVIgqY2d+luD1kmdzgm0G+pPIdF6jB2P1jd9f2kOSQXSFiSrogIBEyILtAJai52dw+L91UPOV0MkqDUAHQHeBsRaOAlIgi0PyQVSD4nKwnoIHP1Xu3SBfBkIxfgUEI2/2uC2PxiSYAVyeb8w24IKRN5lFchZMDrH4ME3LXupzqfn5AH2+XU+FEC+r6D9xCG0QJ7PIRZAgcBlYz1EmpQNSRSj/7uQJfXWzUnw2c/1gmUH9FibQ+T8uvlswWl8vWDZoUAG3zRI/W/NC+S3AUktIu1PST8tM9P1je6Pd1mjJ7TjFYhVbHL7ApkssB2+QOBykQTFKkKerNPLS8oxtJ/0oKn7jz6HFMjzF5xQnwJxPoKCyghw8+ACeTkQunqwFmTHG53kR49HOQv1sR5iBbQLJIHo+ej57Hhx+wJxL6hGG0ScQ+ohkwFaD6G62p4baDxKuWSxuz+PPYQELJDz78GRQRQIfK7MhmQSnJ4XyNuBUBlnQxjV4TZnUPt0Ptr/8PEpqdOCCmTsb4jqF1SUtG0MJgu3BkEGYuej+eshg7+FawHZJK3Hp5A1egGph5EH0Pir+1sPwpBVIM82PjpEF8ji77tQCCuQtwEhorOfz84JFOPT+a0+6CF2wNHtU0Gof4FIYiRoWjUVSIE8KoAhy1qo1PvWPLXYtAxN9xvPbw+GqeDUv0BAgdRiCADlALpLov72YJvutx5yIRILIu/KhhuEDVkUUqxHkAXTc/KgFNDy8QvEvc8gA6HnZLC6yqqHuB88s3oViPyvgeQB9Hy6h9iqZHVMtzkABQu/REoeE3tIgTx/DouqsJvBpEm9QArkZFQ2Ztv2NuSRgf66kDVaUAopJDDlHALw+pBVIGFVYS2QLKpACoSi0uNzMrDXhSyK4bRh8igaP6LxQ2dc7+5lLwmGGxzs4SkgXG+BfPc/mTZkhZ/D2t5D0gXaGD/6LowOfrQ/CkHUf7iH2AlJACs4AbXro5xFZbydr0BAsQKRVZD1IGuxrwNiN2jbW8GtgGnIsSFSt7dlrxXYti+QzT+XRRZWD7EmL9vXQ0YX0hJAm58VwHfqFWytAgWyVm+crUBQorUNCmSt3jhbgaBEaxsUyFq9cbYCQYnWNvgLqC4vPjN7siAAAAAASUVORK5CYII=" alt="Base64로 표시된 QR코드 이미지"></p><blockquote><p>웹팩의 <a href="https://v4.webpack.js.org/loaders/url-loader/">url-loader</a>는 위와 같은 Base64 형식의 URI로 변환합니다. </p></blockquote><h3 id="HTTP-기본-인증"><a href="#HTTP-기본-인증" class="headerlink" title="HTTP 기본 인증"></a>HTTP 기본 인증</h3><p>사용자 이름과 비밀번호를 Authorization 헤더에 포함하여 전달하는 HTTP 기본 인증의 경우에도 Base64 인코딩을 사용합니다. 이는 HTTP 헤더의 값이 <strong>아스키 코드</strong>로 인코딩되어야하기 때문입니다. 따라서, 아스키 코드로 표현할 수 없는 데이터도 전달할 수 있도록 Base64 인코딩을 사용하는 것입니다.</p><blockquote><p>Authorization: Basic bWFtYm86cGFzc3dvcmQ&#x3D;</p></blockquote><h3 id="JWT-Base64Url"><a href="#JWT-Base64Url" class="headerlink" title="JWT Base64Url"></a>JWT Base64Url</h3><p>최근 사용자 인증을 위해 많이 도입하는 JWT(JSON Web Token)는 페이로드와 시그니처 부분을 <strong>Base64Url(URL Safe Base64)</strong> 로 인코딩합니다. JWT를 Base64로 인코딩하는 이유는 토큰이 URL 파라미터로 전송될 수 있기 때문입니다. </p><h2 id="끝마치며"><a href="#끝마치며" class="headerlink" title="끝마치며"></a>끝마치며</h2><p>Base64를 사용하는 이유에 대해서 간단하게 알아보았습니다. 초보 개발자분들 뿐만 아니라 저처럼 Base64에 대해서 인지하고 있었던 분들에게도 도움이 되었으면 합니다. 감사합니다.</p><blockquote><p>Base64에 대해서 자세한 내용을 알고 싶다면 <a href="https://datatracker.ietf.org/doc/html/rfc4648">RFC4648</a>을 참고하세요.</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img data-src=&quot;/images/posts/base64/base64-01.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;위와 같이 어떤 서비스에 대한 회원가입을 수행하거나 비밀번호 찾기와 같은 기능을 수행했을경우 인증 관련 메일이 발송되는 것을 자주 확인할 수</summary>
      
    
    
    
    
    <category term="Base64" scheme="https://kdevkr.github.io/tags/Base64/"/>
    
  </entry>
  
  <entry>
    <title>Webpack 5 빌드 속도 개선하기</title>
    <link href="https://kdevkr.github.io/improve-webpack5-build-speed/"/>
    <id>https://kdevkr.github.io/improve-webpack5-build-speed/</id>
    <published>2022-01-15T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.512Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>현재 조직에서는 웹팩 4로 구성된 프로젝트를 웹팩 5를 사용할 수 있도록 업그레이드 작업을 수행하였고 많은 노력 끝에 최신 버전의 웹팩 구성으로 변경하는 것을 완료했습니다. 그러나 오히려 웹팩 5으로 전환하게 된 후 빌드 시간이 더 늘어남을 경험하게 되었는데 오늘은 왜 이런 문제가 발생했는지를 공유하고자 합니다.</p><h2 id="Webpack5"><a href="#Webpack5" class="headerlink" title="Webpack5"></a>Webpack5</h2><p>어떤 도구에 대한 최신 버전을 사용하려는 목적은 버그 개선 뿐만 아니라 구조적인 개선으로 인한 성능 향상에 있기도 합니다. 물론 반드시 최신 버전으로 업데이트하는 것이 성능 상으로 좋아짐을 보장할 순 없습니다. 웹팩에서 마이그레이션 가이드 문서를 제공한다고해도 많은 로더와 플러그인등을 사용하기 때문에 빌드 성능이 좋지 않다는 것을 검토하기에는 어려움이 많습니다.</p><h3 id="느려진-재빌드-시간"><a href="#느려진-재빌드-시간" class="headerlink" title="느려진 재빌드 시간"></a>느려진 재빌드 시간</h3><p>웹팩 5로 전환하고나서 일부 시스템 환경에 따라 시간은 다르지만 다음과 같이 빌드 시간이 상당히 느려짐을 경험했습니다. 초기 빌드 시간은 그다지 차이가 발생하지 않았으나 웹팩 5가 조금은 빨랐습니다. 그러나, 젠킨스와 같은 CI 도구에서는 재빌드를 수행하기도 하므로 다음과 같이 재빌드에 대해서 검토한 결과 오히려 빌드가 느림을 확인했습니다. </p><p><img data-src="/images/posts/improve-webpack5-build-speed/wp5-build-02.png#full"></p><p>재빌드 시에만 웹팩 5에서 심각하게 느림을 보이는 이유는 <strong>캐시</strong>에 있었습니다. 웹팩 5에서는 영구 캐시(파일시스템 캐시)를 지원하기 위해서 캐시 방식을 변경하였습니다. 이전 웹팩 4에서는 캐시 방식이 없으므로 다음과 같이 로더와 플러그인에서 자체적인 캐시 파일을 만드는 것을 제한하지 않았습니다.</p><p><img data-src="/images/posts/improve-webpack5-build-speed/wp5-build-03.png"></p><p>그러나 우측의 웹팩 5에서는 <code>terser-webpack-plugin</code> 과 <code>css-minimizer-webpack-plugin</code>에 대한 캐시 폴더가 생성되지 않았음을 확인할 수 있는데요. 이렇게 된 정확한 이유는 찾을 수 없었지만 예상하는 바는 캐시 구조 변경으로 인하여 웹팩 자체적으로 제공하는 로더와 플러그인에 대해서는 캐시 파일을 만들지않도록 수정된 것 같습니다.</p><h4 id="영구-캐시"><a href="#영구-캐시" class="headerlink" title="영구 캐시"></a>영구 캐시</h4><p>영구 캐시(Persistent Cache)를 위해 파일시스템 캐시를 지정하면 어떻게 되는지 확인해보겠습니다. </p><pre class="language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">cache</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'filesystem'</span><span class="token punctuation">,</span>        <span class="token literal-property property">buildDependencies</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token literal-property property">config</span><span class="token operator">:</span> <span class="token punctuation">[</span>__filename<span class="token punctuation">]</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>node_modules 하위의 캐시 폴더를 지운 상태에서 빌드를 수행하고 다시한번 재빌드를 수행한 결과를 비교해봅니다.</p><p><img data-src="/images/posts/improve-webpack5-build-speed/wp5-build-04.png"></p><p>웹팩 5에서 지원하는 파일시스템 캐시를 적용하고나니 재빌드 시간이 무려 15초로 단축됨을 확인할 수 있습니다. 이처럼 웹팩 5로 변경하고나서 오히려 빌드 시간이 느려짐을 경험했던 분이라면 사용중인 로더와 플러그인에서 자체적인 캐시를 사용했는지 검토하고 <strong>파일시스템 캐시</strong>를 적용하셔야 할 수 있습니다.</p><h3 id="로더-및-플러그인-대체"><a href="#로더-및-플러그인-대체" class="headerlink" title="로더 및 플러그인 대체"></a>로더 및 플러그인 대체</h3><p>최신버전의 웹팩 구성을 위해서는 사용하는 로더와 플러그인들의 호환성을 위해 최신 버전으로 업데이트해야만 합니다. 로더와 플러그인들의 버전이 업데이트되면서 오히려 수행하는 일이 더 많아질 수 있음을 인지해야할 수 있습니다. 예를 들어, 바벨을 적용중이라면 더 많은 문법을 지원하거나 프리셋에 더 많은 플러그인이 기본적으로 포함될 수도 있습니다.</p><h4 id="esbuild-loader"><a href="#esbuild-loader" class="headerlink" title="esbuild-loader"></a>esbuild-loader</h4><p><a href="https://github.com/privatenumber/esbuild-loader">esbuild-loader</a>는 esbuild를 통해 웹팩 빌드를 더 빠르게 수행하기 위한 로더 중 하나입니다. 이외에도 <a href="https://github.com/swc-project/swc-loader">swc-loader</a>도 있습니다.</p><blockquote><p>esbuild와 swc는 떠오르는 자바스크립트 번들러입니다!</p></blockquote><p>esbuild는 자체적으로 빠른 것도 있지만 Minification도 함께 지원한다는 장점도 있습니다. 기존에는 트랜스파일링을 위해 바벨 로더를 사용하고 자바스크립트 또는 CSS 파일 축소를 위해서 terser-webpack-plugin과 css-minimizer-plugin을 적용해야했습니다. esbuild 만으로도 위 기능을 대체할 수 있기 때문에 여러가지 로더와 플러그인을 수행하는 것보다는 더 좋을 수 있습니다.</p><blockquote><p>웹팩 문서에서도 최대한 로더와 플러그인을 줄여야한다고 안내합니다.</p></blockquote><pre class="language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">&#123;</span>                <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>                <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(node_modules)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>                <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>                <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                    <span class="token literal-property property">cacheDirectory</span><span class="token operator">:</span> <span class="token boolean">true</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">mimimizer</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">CssMinimizerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>                <span class="token literal-property property">minimizerOptions</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                    <span class="token literal-property property">preset</span><span class="token operator">:</span> <span class="token punctuation">[</span>                        <span class="token string">'default'</span><span class="token punctuation">,</span>                        <span class="token punctuation">&#123;</span>                            <span class="token literal-property property">discardDuplicates</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">removeAll</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                            <span class="token literal-property property">discardComments</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">removeAll</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span>                        <span class="token punctuation">&#125;</span>                    <span class="token punctuation">]</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>이제 바벨을 esbuild-loader로 변경해보고 빌드를 해보겠습니다.</p><pre class="language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">&#123;</span>                <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>                <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(node_modules)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>                <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'esbuild-loader'</span><span class="token punctuation">,</span>                <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                    <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'es2015'</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p><img data-src="/images/posts/improve-webpack5-build-speed/wp5-build-05.png" alt="esbuild-loader + teser + css-miminizer"></p><p>초기 빌드 시 2분 54초라는 시간에서 <strong>2분 21초</strong>로 단축되었습니다.</p><h4 id="TerserPlugin-esbuildMinify"><a href="#TerserPlugin-esbuildMinify" class="headerlink" title="TerserPlugin.esbuildMinify"></a>TerserPlugin.esbuildMinify</h4><p>terser-webpack-plugin은 esbuild로 자바스크립트에 대한 최적화를 수행할 수 있도록 <code>TerserPlugin.esbuildMinify</code>를 지원합니다.</p><pre class="language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">mimimizer</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>                <span class="token literal-property property">minify</span><span class="token operator">:</span> TerserPlugin<span class="token punctuation">.</span>esbuildMinify            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p><img data-src="/images/posts/improve-webpack5-build-speed/wp5-build-06.png" alt="esbuild-loader + teser[esbuild] + css-miminizer"></p><h4 id="CssMinimizerPlugin-esbuildMinify"><a href="#CssMinimizerPlugin-esbuildMinify" class="headerlink" title="CssMinimizerPlugin.esbuildMinify"></a>CssMinimizerPlugin.esbuildMinify</h4><p>css-minimizer-webpack-plugin도 esbuild로 CSS에 대한 최적화를 수행할 수 있도록 <code>CssMinimizerPlugin.esbuildMinify</code>을 지원합니다.</p><pre class="language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">mimimizer</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token keyword">new</span> <span class="token class-name">CssMinimizerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>                <span class="token literal-property property">minify</span><span class="token operator">:</span> CssMinimizerPlugin<span class="token punctuation">.</span>esbuildMinify            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p><img data-src="/images/posts/improve-webpack5-build-speed/wp5-build-07.png" alt="esbuild-loader + teser[esbuild] + css-miminizer[esbuild]"></p><h4 id="ESBuildMinifyPlugin"><a href="#ESBuildMinifyPlugin" class="headerlink" title="ESBuildMinifyPlugin"></a>ESBuildMinifyPlugin</h4><p>esbuild-loader에는 <a href="https://github.com/privatenumber/esbuild-loader#css-assets">ESBuildMinifyPlugin</a>가 포함되어있으므로 굳이 terser-webpack-plugin과 css-minimizer-webpack-plugin을 사용할 필요가 없습니다. 두개의 플러그인으로 수행하는 것보다는 하나의 플러그인으로 처리하는게 더 효율적입니다. 최적화에 대한 벤치마크는 <a href="https://github.com/privatenumber/minification-benchmarks">JS minification benchmarks</a>를 참고하시기 바랍니다.</p><pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> ESBuildMinifyPlugin <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'esbuild-loader'</span><span class="token punctuation">)</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token literal-property property">mimimizer</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token keyword">new</span> <span class="token class-name">ESBuildMinifyPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>                <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'es2015'</span><span class="token punctuation">,</span>                <span class="token literal-property property">css</span><span class="token operator">:</span> <span class="token boolean">true</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p><img data-src="/images/posts/improve-webpack5-build-speed/wp5-build-08.png" alt="esbuild-loader + esbuild-minify"></p><h3 id="빌드-결과-종합"><a href="#빌드-결과-종합" class="headerlink" title="빌드 결과 종합"></a>빌드 결과 종합</h3><p>기존에 사용하던 로더와 플러그인을 대체하면서 빌드 시간이 단축됨을 확인했습니다. 그러나 여러분의 프로젝트에서 요구하는 번들링 품질에 대해서도 검토하셔야만 합니다. 단순히 빌드 시간이 단축되었다고 더 좋다고 할 수는 없기 때문입니다. 예를 들어, esbuild에서 지원하는 문법의 한계가 있으므로 반드시 목표로하는 브라우저에서 동작하는지 검증해야합니다. </p><table><thead><tr><th>로더</th><th>플러그인</th><th>빌드시간</th></tr></thead><tbody><tr><td>babel-loader</td><td>teser + css-minimizer</td><td>2 mins, 54.35 secs</td></tr><tr><td>esbuild-loader</td><td>teser + css-minimizer</td><td>2 mins, 21.11 secs</td></tr><tr><td>esbuild-loader</td><td>teser[esbuild] + css-minimizer</td><td>1 mins, 29.034 secs</td></tr><tr><td>esbuild-loader</td><td>teser[esbuild] + css-minimizer[esbuild]</td><td>1 mins, 19.44 secs</td></tr><tr><td>esbuild-loader</td><td>esbuild-minify</td><td>1 mins, 16.92 secs</td></tr></tbody></table><blockquote><p>빌드 품질에 상관없으신 분들이라면 esbuild 도입을 검토해보시는 것도 나쁘지 않을 것 같습니다.</p></blockquote><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;현재 조직에서는 웹팩 4로 구성된 프로젝트를 웹팩 5를 사용할 수 있도록 업그레이드 작업을 수행하였고 많은 노력 끝에 최신 버전의 웹팩 구성으로 변경하는 것을 완료했습니다. 그러나 오히려 웹팩 5으로 전</summary>
      
    
    
    
    
    <category term="Webpack5" scheme="https://kdevkr.github.io/tags/Webpack5/"/>
    
    <category term="Persistent cache" scheme="https://kdevkr.github.io/tags/Persistent-cache/"/>
    
  </entry>
  
  <entry>
    <title>장애는 사소한 것에서 발생한다</title>
    <link href="https://kdevkr.github.io/system-failure-occurs-from-trivial-things/"/>
    <id>https://kdevkr.github.io/system-failure-occurs-from-trivial-things/</id>
    <published>2022-01-08T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.516Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>갑작스럽게 발생하는 시스템 장애는 늘 개발자를 힘겹게 합니다.<br>오늘은 사소한 것으로부터 발생한 시스템 장애에 대한 경험을 공유하고자 합니다.</p><h2 id="시스템-장애"><a href="#시스템-장애" class="headerlink" title="시스템 장애"></a>시스템 장애</h2><p>현재 조직에서는 시계열 데이터에 대한 관리 및 통계를 위해서 컬럼형 시계열 데이터베이스인 <a href="https://kx.com/">KDB+</a>를 사용하고 있습니다. 그리고 분산으로 실행되어있는 애플리케이션에서 RDBMS에서 조회된 일부 데이터를 컬럼형 시계열 데이터베이스로 동기화하는 스케줄이 동작합니다. 그런데 스케줄로 인하여 데이터가 동기화 된 이후에 컬럼형 시계열 데이터베이스에 있는 동기화된 데이터가 조금씩 사라지기 시작하고 동기화된 모든 데이터가 삭제되는 현상이 발생하였습니다.</p><h3 id="원인-분석"><a href="#원인-분석" class="headerlink" title="원인 분석"></a>원인 분석</h3><p>처음에는 동기화된 데이터가 저장되는 테이블에 데이터가 없다는 것을 보고받고 시스템 계정으로 접속하여 수동으로 해당 스케줄을 동작하여 데이터를 복구하였습니다. 그러나 해당 스케줄은 5분마다 동작하고 해당 스케줄이 돌게되면 데이터가 점점 없어지는 것을 확인하였습니다. 해당 스케줄이 동작하고나서 <strong>수동으로 동작시키고 난 후에는</strong> 데이터가 사라지는 현상이 나타나지 않았습니다.</p><p><img data-src="/images/posts/system-failure-occurs-from-trivial-things/01.gif" alt="똑같은 스케줄 동작인데?..."></p><p>결국 시계열 데이터베이스가 설치된 인스턴스로 접속하여 로그를 살펴보니 스케줄이 동작하고 데이터 저장을 완료했다는 로그 이후에 또다른 로그가 기록되더니 무수히 많은 <strong>잘못된 유형(&#96;type)이라는 불친절한 오류 로그</strong>를 확인하게 됩니다. 그리고 이번주 작업으로 특정 컬럼의 유형을 바꾸어야하는 요구사항에 대한 처리를 했다는 것도 인지하게 됩니다. 다만, 이 작업은 개발 환경에서 작업하였고 아직 배포전이므로 실행중인 애플리케이션에는 해당되지 않았습니다.</p><h3 id="문제-해결"><a href="#문제-해결" class="headerlink" title="문제 해결"></a>문제 해결</h3><p>그러던 중 스케줄은 환경별로 독립적으로 실행되도록 구성되어있다는 점을 떠올리게 됩니다. 즉, 로컬 환경 프로파일로 실행하면 로컬 환경에서만 독립적이라는 이야기죠. 그리고 누군가 로컬 소스코드 기준으로 (장애가 발생한) 특정 배포 환경에 연결한게 아닌가 의심하였고 조직에서 사용하는 메신저 채널인 슬랙에 알려보았습니다. 슬쩍 손을 드신분은 마침 휴가를 쓰신 팀장님이었고 원격으로 팀장님 컴퓨터에 실행중인 애플리케이션을 중지해달라고 요청했고 장애는 자연스럽게 해결되었습니다.</p><p><img data-src="/images/posts/system-failure-occurs-from-trivial-things/02.gif#compact" alt="어쨌든 범인 검거..."></p><h3 id="장애-대응-소감"><a href="#장애-대응-소감" class="headerlink" title="장애 대응 소감"></a>장애 대응 소감</h3><p>다행히도 지워지던 데이터는 중요한 데이터가 아니라 프론트엔드에서 통계 표시를 위한 기준 테이블이어서 일부 데이터가 표시되지 않는 사소한 장애였습니다. 그럼에도 불구하고 장애를 판단하고 원인을 분석하여 해결하기까지는 생각보다 쉽지 않았던 것 같습니다. 사실 이 장애는 모니터링 체계를 도입하더라도 검출되지 않는 사소하지 않는 장애이기도 합니다. 그리고 이 장애를 보다보니 유튜브 개발바닥에 공유된 <a href="https://youtu.be/SWZcrdmmLEU">재난급 서버 장애내고 개발자 인생 끝날뻔 한 썰</a>이 떠오르는 것 같습니다.</p><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;갑작스럽게 발생하는 시스템 장애는 늘 개발자를 힘겹게 합니다.&lt;br&gt;오늘은 사소한 것으로부터 발생한 시스템 장애에 대한 경험을 공유하고자 합니다.&lt;/p&gt;
&lt;h2 id=&quot;시스템-장애&quot;&gt;&lt;a href=&quot;#시</summary>
      
    
    
    
    
    <category term="System Failure" scheme="https://kdevkr.github.io/tags/System-Failure/"/>
    
    <category term="Troubleshooting" scheme="https://kdevkr.github.io/tags/Troubleshooting/"/>
    
  </entry>
  
  <entry>
    <title>롬복 어노테이션 프로세서</title>
    <link href="https://kdevkr.github.io/lombok-annotation-processor/"/>
    <id>https://kdevkr.github.io/lombok-annotation-processor/</id>
    <published>2021-12-29T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.512Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 인텔리제이에서 롬복 라이브러리를 적용하는 방법을 알아가기 위한 내용을 공유하고자 합니다.</p><h2 id="Lombok"><a href="#Lombok" class="headerlink" title="Lombok"></a>Lombok</h2><p><a href="https://projectlombok.org/">롬복 라이브러리</a>는 자바 프로젝트에서 필수적으로 사용될만큼 편리하고 유용한 기능을 제공합니다. 롬복 라이브러리는 <a href="https://docs.oracle.com/javase/7/docs/technotes/guides/apt/GettingStarted.html">APT(Annotation Processing Tool)</a>를 통해 어노테이션 프로세서(Annotation Processor)로 컴파일 단계에서 수행하게 됩니다. 따라서, 롬복 라이브러리를 사용하기 위해서는 프로젝트에서 어노테이션 프로세서를 동작시키기 위한 설정을 해야합니다.</p><h3 id="인텔리제이-어노테이션-프로세서"><a href="#인텔리제이-어노테이션-프로세서" class="headerlink" title="인텔리제이 어노테이션 프로세서"></a>인텔리제이 어노테이션 프로세서</h3><p>인텔리제이에서는 클래스패스에 있는 어노테이션 프로세서를 구성하기 위한 <a href="https://www.jetbrains.com/help/idea/annotation-processors-support.html">어노테이션 프로세싱 기능</a>을 지원합니다. 이 어노테이션 프로세싱 기능이 활성화되면 클래스패스에 있는 어노테이션 프로세서를 자동으로 등록하게 됩니다.</p><p><img data-src="/images/posts/lombok-annotation-processor/intellij-annotation-processing.png"></p><h4 id="그래들-프로젝트"><a href="#그래들-프로젝트" class="headerlink" title="그래들 프로젝트"></a>그래들 프로젝트</h4><p>인텔리제이는 그래들 프로젝트에 있는 기본 그래들 래퍼를 사용하여 프로젝트를 빌드하고 실행하도록 설정되어있습니다. <strong>Build Tools &gt; Gradle</strong> 메뉴에서 기본 그래들 래퍼가 아닌 인텔리제이 자체로 빌드하고 실행되도록 변경할 수 있습니다. 인텔리제이 자체적으로는 롬복 플러그인을 번들에 포함하고 있으므로 롬복 어노테이션 프로세서가 클래스패스에 위치하기 때문에 어노테이션 프로세싱 기능이 활성화되어있다면 롬복에 대한 어노테이션 프로세서가 자동으로 등록되게 됩니다.</p><pre class="language-groovy" data-language="groovy"><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    compileOnly <span class="token string">'org.projectlombok:lombok'</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p><em>인텔리제이는 친절하게도 롬복 라이브러리가 클래스패스에 있지만 어노테이션 프로세싱 기능이 비활성화되어있으면 이벤트 로그에 기능 활성화를 묻는 알림을 제공합니다.</em><br><em>또한, 인텔리제이를 사용하도록 선택한 환경에서는 별다른 설정없이도 클래스패스에 롬복 라이브러리가 있으면 어노테이션 프로세서가 동작함을 확인할 수 있습니다.</em></p></blockquote><h4 id="그래들-어노테이션-프로세서-구성"><a href="#그래들-어노테이션-프로세서-구성" class="headerlink" title="그래들 어노테이션 프로세서 구성"></a>그래들 어노테이션 프로세서 구성</h4><p>프로젝트의 기본 설정은 프로젝트의 그래들 래퍼로 실행하는 환경이라고 하였습니다. 이 경우에는 롬복 라이브러리에 대한 어노테이션 프로세서를 그래들 구성 파일에 정의해야합니다.</p><p><img data-src="/images/posts/lombok-annotation-processor/intellij-gradle-build-and-run.png"></p><pre class="language-groovy" data-language="groovy"><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>    compileOnly <span class="token string">'org.projectlombok:lombok'</span>    annotationProcessor <span class="token string">'org.projectlombok:lombok'</span><span class="token punctuation">&#125;</span></code></pre><p>그래들의 annotationProcessor를 통해 롬복 라이브러리의 어노테이션 프로세서가 어노테이션 프로세서가 위치하는 클래스패스에 등록됨에 따라 인텔리제이는 어노테이션 프로세싱 기능 활성화 여부를 확인하고 활성화에 대한 알림을 제공합니다. </p><pre class="language-groovy" data-language="groovy"><code class="language-groovy">configurations <span class="token punctuation">&#123;</span>   compileOnly <span class="token punctuation">&#123;</span>       extendsFrom annotationProcessor   <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>그래들 기반의 스프링 부트 프로젝트를 시작할 때 롬복을 추가하면 위 구문이 포함되는 것을 확인하실 수 있습니다. 이 구문의 역할이 무엇인지 궁금하지 않으신가요? 인텔리제이는 그래들 설정 팡리에 위 구문이 포함되는 경우 <code>Gradle Imported</code>라는 이름의 프로파일로써 롬복 라이브러리를 어노테이션 프로세서로 등록하기 위한 어노테이션 프로세싱 기능을 활성화하는 것을 자동으로 구성하게 됩니다.</p><p><img data-src="/images/posts/lombok-annotation-processor/intellij-lombok-annotation-processing-extends-from.png"></p><blockquote><p><em>인텔리제이는 기본 프로파일에 대해 어노테이션 프로세싱 기능이 활성화되어있지 않으면 이벤트 로그를 통해 롬복을 위한 어노테이션 프로세싱 기능 활성화를 안내하는 것 같습니다.</em></p></blockquote><h3 id="롬복-어노테이션-프로세서"><a href="#롬복-어노테이션-프로세서" class="headerlink" title="롬복 어노테이션 프로세서"></a>롬복 어노테이션 프로세서</h3><p>다시 내용을 정리해보자면, 롬복 라이브러리를 적용하기 위해서는 롬복 라이브러리의 어노테이션 프로세서를 등록하기 위한 설정을 수행해야합니다.</p><ul><li>인텔리제이 어노테이션 프로세싱 활성화(Enable annotation processing)</li><li>그래들 어노테이션 프로세서 구성</li></ul><h4 id="그래들-어노테이션-프로세서-구성-1"><a href="#그래들-어노테이션-프로세서-구성-1" class="headerlink" title="그래들 어노테이션 프로세서 구성"></a>그래들 어노테이션 프로세서 구성</h4><p>인텔리제이를 사용하는 개발 환경에서는 인텔리제이 어노테이션 프로세싱 활성화 기능을 통해 클래스패스에 있는 어노테이션 프로세서를 자동으로 등록할 수 있습니다만, 젠킨스와 같은 빌드 환경에서 그래들로 어노테이션 프로세서를 등록하기 위해서는 이를 위한 구성을 해야합니다.</p><pre class="language-groovy" data-language="groovy"><code class="language-groovy">configurations <span class="token punctuation">&#123;</span>    compileOnly <span class="token punctuation">&#123;</span>        extendsFrom annotationProcessor    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>dependencies <span class="token punctuation">&#123;</span>    compileOnly <span class="token string">'org.projectlombok:lombok'</span>    annotationProcessor <span class="token string">'org.projectlombok:lombok'</span>    testCompileOnly <span class="token string">'org.projectlombok:lombok'</span>    testAnnotationProcessor <span class="token string">'org.projectlombok:lombok'</span><span class="token punctuation">&#125;</span></code></pre><p>그리고 위 구성은 간단하게 <strong>그래들 롬복 플러그인</strong> 으로 대체할 수 있는데 빌드 도구의 플러그인을 사용하는 것은 공식 홈페이지에서도 추천하는 방식입니다.</p><pre class="language-groovy" data-language="groovy"><code class="language-groovy">plugins <span class="token punctuation">&#123;</span>   id <span class="token string gstring">"io.freefair.lombok"</span> version <span class="token string gstring">"6.3.0"</span><span class="token punctuation">&#125;</span></code></pre><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 인텔리제이에서 롬복 라이브러리를 적용하는 방법을 알아가기 위한 내용을 공유하고자 합니다.&lt;/p&gt;
&lt;h2 id=&quot;Lombok&quot;&gt;&lt;a href=&quot;#Lombok&quot; class=&quot;headerlink&quot; ti</summary>
      
    
    
    
    
    <category term="IntelliJ" scheme="https://kdevkr.github.io/tags/IntelliJ/"/>
    
    <category term="Lombok" scheme="https://kdevkr.github.io/tags/Lombok/"/>
    
    <category term="Annotation Processor" scheme="https://kdevkr.github.io/tags/Annotation-Processor/"/>
    
  </entry>
  
  <entry>
    <title>Webpack 5 기반의 Vue 개발 환경</title>
    <link href="https://kdevkr.github.io/webpack5-for-vue/"/>
    <id>https://kdevkr.github.io/webpack5-for-vue/</id>
    <published>2021-12-28T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.516Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 <strong>Webpack 5 기반의 Vue 개발 환경</strong>에 대해서 알아보는 시간을 가져보도록 하겠습니다.<br>본 글에서 설명한 내용에 대한 코드는 <a href="https://github.com/kdevkr/webpack5">kdevkr&#x2F;webpack5</a>에서 제공합니다.</p><h2 id="Webpack"><a href="#Webpack" class="headerlink" title="Webpack"></a>Webpack</h2><p>반드시 그런 것은 아니지만 많은 분들이 <a href="https://create-react-app.dev/">Create React App</a> 또는 <a href="https://cli.vuejs.org/">Vue CLI</a>라는 도구를 통해서 프론트엔드 개발 환경에 대한 기본 프리셋을 기반으로 학습을 시작하거나 개발 환경을 구축합니다. 이 도구들은 여러가지 사항에 대한 웹팩 구성을 기본적으로 제공함으로써 웹팩에 대한 내용을 알지 못하더라도 쉽게 리액트 또는 뷰에 대한 학습을 진행할 수 있게 도와주는 유용한 도구입니다. </p><p>그럼에도 불구하고, 실무 환경에서는 이 도구들을 사용하지 않고 직접 웹팩 설정에 대해 구성하여 사용합니다. 또한, Vue CLI는 안타깝게도 웹팩 4에 대한 구성을 제공하므로 이 도구로 만들어지는 환경은 무조건 웹팩 4로 제한되는 문제점을 가지고 있습니다. <a href="https://webpack.js.org/blog/2020-10-10-webpack-5-release/">2020년 10월에 릴리즈된 웹팩 5</a> 기반의 개발 환경을 만들기 위해서는 직접 웹팩 구성을 수행할 수 있어야만 합니다.</p><h3 id="요구사항"><a href="#요구사항" class="headerlink" title="요구사항"></a>요구사항</h3><p>시작하기에 앞서, 웹팩 5는 노드 10.13.0 이상의 버전을 요구하며 함께 개발 프록시 서버로 활용할 수 있는 webpack-dev-server@4 에서는 노드 12.13.0 이상을 요구합니다. </p><ul><li>Webpack5 required v10.13.0+</li><li>webpack-dev-server@4 v12.13.0+</li></ul><h4 id="프로젝트-노드-버전-제한"><a href="#프로젝트-노드-버전-제한" class="headerlink" title="프로젝트 노드 버전 제한"></a>프로젝트 노드 버전 제한</h4><p>위 요구사항에 따라 프로젝트에서 사용할 수 있는 노드 버전을 제한하는 것이 좋습니다. 제가 이전에 공유한 <a href="https://kdevkr.github.io/strict-nodejs-version-for-project/">프로젝트의 노드 버전 제한하기</a>를 참고하여 노드 엔진 버전을 12.13.0 이상으로 설정해두는 것을 추천하는 바입니다.</p><h3 id="커밋별로-확인하는-구성"><a href="#커밋별로-확인하는-구성" class="headerlink" title="커밋별로 확인하는 구성"></a>커밋별로 확인하는 구성</h3><p>각 커밋 단위의 Browser Files를 통해 어떻게 구성이 변화하는지를 참고하시면 좋습니다.</p><h4 id="Add-webpack-config-js-for-default-configuration"><a href="#Add-webpack-config-js-for-default-configuration" class="headerlink" title="Add webpack.config.js for default configuration"></a><a href="https://github.com/kdevkr/webpack5/commit/3f858c2702720088b8647bdb55a9f830d54a8d91">Add webpack.config.js for default configuration</a></h4><p>기본 구성을 위한 webpack.config.js 파일을 만들고 node-env 값에 따라 번들 파일명을 다르게 지정할 수 있음을 보여줍니다.</p><pre class="language-sh" data-language="sh"><code class="language-sh">npx webpack --node-env production # 모드를 지정하지 않았지만 node-env 값에 의해 처리됩니다.</code></pre><h4 id="Add-vue-loader"><a href="#Add-vue-loader" class="headerlink" title="Add vue-loader"></a><a href="https://github.com/kdevkr/webpack5/commit/3ca2fc1de5573ae339b0271ea482a73bf3dac397">Add vue-loader</a></h4><p>Vue SFC 파일을 처리하기 위한 vue-loader를 추가하고 Vue 개발 환경을 준비하고 간단한 샘플 HTML 파일을 만들어서 Vue 코드가 정상적으로 변환되었음을 확인합니다.</p><h4 id="Add-sass-postcss"><a href="#Add-sass-postcss" class="headerlink" title="Add sass, postcss"></a><a href="https://github.com/kdevkr/webpack5/commit/68ffce2b18c64e67b944a383b216c2e6fe784396">Add sass, postcss</a></h4><p>Vue SFC의 스타일 블록의 언어를 SCSS로 사용하기 위해서 sass 및 postcss에 대한 설정을 추가합니다. </p><h4 id="Add-stylelint"><a href="#Add-stylelint" class="headerlink" title="Add stylelint"></a><a href="https://github.com/kdevkr/webpack5/commit/7e1e00735738e9106033c6df675977846b159552">Add stylelint</a></h4><p>반드시 필요한 설정은 아니지만 CSS에 대한 린트를 적용하기 위해 stylelint를 postcss 플러그인으로 추가합니다.</p><h4 id="Add-eslint"><a href="#Add-eslint" class="headerlink" title="Add eslint"></a><a href="https://github.com/kdevkr/webpack5/commit/f7f566314fd675e18d3f7b3dd35283317c5891ae">Add eslint</a></h4><p>자바스크립트에 대한 린트를 적용하기 위해 eslint를 추가합니다.</p><h4 id="Add-babel"><a href="#Add-babel" class="headerlink" title="Add babel"></a><a href="https://github.com/kdevkr/webpack5/commit/c5211b28ab8176e8c5c9fb39c755083679cb24df">Add babel</a></h4><p>ES6+ 문법을 지원하지 않는 브라우저를 위해 ES5 문법으로 변환하기 위한 babel을 추가합니다. babel 7 부터는 폴리필 적용 방식이 변경되었음을 주의해야합니다. 바벨 폴리필에 대해서는 다음의 두 링크를 참고하시면 좋습니다.</p><ul><li><a href="https://poiemaweb.com/babel-polyfill">폐지된 @babel&#x2F;polyfill 대신 @babel&#x2F;plugin-transform-runtime을 사용해 폴리필 추가하기</a></li><li><a href="https://tech.kakao.com/2020/12/01/frontend-growth-02/">Babel7과 corejs3 설정으로 전역 오염 없는 폴리필 사용하기</a></li></ul><h4 id="Add-browserslist"><a href="#Add-browserslist" class="headerlink" title="Add browserslist"></a><a href="https://github.com/kdevkr/webpack5/commit/c911ef73aa85ebde4d9c738c07999300c05bfaf8">Add browserslist</a></h4><p>postcss의 autoprefixer 또는 babel에서 참고할 타겟 정보를 위해 browserslist를 추가합니다.</p><h4 id="Add-prettierrc"><a href="#Add-prettierrc" class="headerlink" title="Add prettierrc"></a><a href="https://github.com/kdevkr/webpack5/commit/b5c8e20ebdb2224f1268b431aafb82a6b49e7b3a">Add prettierrc</a></h4><p>불필요한 포맷팅을 방지하기 위한 prettier 옵션을 조정합니다.</p><h4 id="Add-asset"><a href="#Add-asset" class="headerlink" title="Add asset"></a><a href="https://github.com/kdevkr/webpack5/commit/1ba05ff066806fb2c7b59eace748e04e73756243">Add asset</a></h4><p>이미지 또는 폰트 등을 위한 에셋 모듈을 추가합니다.</p><h4 id="Apply-strict-npm-engines"><a href="#Apply-strict-npm-engines" class="headerlink" title="Apply strict npm engines"></a><a href="https://github.com/kdevkr/webpack5/commit/1b768c5881db9d8348d54f926a11e537a50050ac">Apply strict npm engines</a></h4><p>지금까지 설치된 패키지에서 최소로 요구하는 노드 버전을 명시하고 제한되도록 설정합니다.</p><h4 id="Apply-settings-for-vscode"><a href="#Apply-settings-for-vscode" class="headerlink" title="Apply settings for vscode"></a><a href="https://github.com/kdevkr/webpack5/commit/9008824470873ce172e52294ddac7eee8304c256">Apply settings for vscode</a></h4><p>VSCode를 사용하는 경우 저장될 때 ESLint가 동작하도록 설정합니다.</p><h4 id="Add-project-version-in-output-filename"><a href="#Add-project-version-in-output-filename" class="headerlink" title="Add project version in output filename"></a><a href="https://github.com/kdevkr/webpack5/commit/769171d627bb1f4bfbb4bacce62dc067ff9b617a">Add project version in output filename</a></h4><p>(Optional) package.json에 정의된 프로젝트 버전을 번들 파일명에 포함시킬 수 있음을 보여줍니다.</p><h4 id="Apply-optimization"><a href="#Apply-optimization" class="headerlink" title="Apply optimization"></a><a href="https://github.com/kdevkr/webpack5/commit/bab1505c643b4ae3ea5e7a86bdc90317f4afe470">Apply optimization</a></h4><p>프로덕션 환경을 위한 최적화 구성을 조정합니다.</p><h4 id="Add-manifest"><a href="#Add-manifest" class="headerlink" title="Add manifest"></a><a href="https://github.com/kdevkr/webpack5/commit/7d0cd27b85a8f1df757e16c3ddb6ad32b8f7b39e">Add manifest</a></h4><p>매니페스트 파일이 생성할 수 있도록 플러그인을 추가합니다. </p><pre class="language-sh" data-language="sh"><code class="language-sh">npx webpack --node-env production --env manifest</code></pre><h4 id="Add-bootstrap-vue"><a href="#Add-bootstrap-vue" class="headerlink" title="Add bootstrap-vue"></a><a href="https://github.com/kdevkr/webpack5/commit/c3da5f586c6ec368778e2c90478196e4af037a82">Add bootstrap-vue</a></h4><p>BootstrapVue를 추가해보고 <a href="https://kdevkr.github.io/no-emit-deprecation-warnings-of-dart-sass/">최신 버전의 Sass에서 출력되는 Deprecation 경고가 출력되지 않도록</a> 설정합니다.</p><p>감사합니다.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 &lt;strong&gt;Webpack 5 기반의 Vue 개발 환경&lt;/strong&gt;에 대해서 알아보는 시간을 가져보도록 하겠습니다.&lt;br&gt;본 글에서 설명한 내용에 대한 코드는 &lt;a href=&quot;https://</summary>
      
    
    
    
    
    <category term="Webpack5" scheme="https://kdevkr.github.io/tags/Webpack5/"/>
    
  </entry>
  
  <entry>
    <title>특정 디펜던시에 대한 Dart Sass의 Deprecation 경고 제외하기</title>
    <link href="https://kdevkr.github.io/no-emit-deprecation-warnings-of-dart-sass/"/>
    <id>https://kdevkr.github.io/no-emit-deprecation-warnings-of-dart-sass/</id>
    <published>2021-12-27T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.512Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 특정 디펜던시에 대한 Dart Sass의 Deprecation 경고를 제외하는 방법에 대해서 공유하려고 합니다.</p><h2 id="Deprecation-Warnings"><a href="#Deprecation-Warnings" class="headerlink" title="Deprecation Warnings"></a>Deprecation Warnings</h2><p>최신 웹팩에서 사용하는 sass-loader에서는 sass(Dart Sass)를 사용하는 것을 권장합니다. 다만, Dart Sass 버전에 따라 다음과 같이 Dart Sass 2.0에서부터 지원되지 않는 문법에 대한 경고 로그가 출력될 수 있습니다.</p><p><em>Deprecation Using &#x2F; for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0</em></p><h3 id="Bootstrap"><a href="#Bootstrap" class="headerlink" title="Bootstrap"></a>Bootstrap</h3><p>부트스트랩의 변수를 오버라이딩하여 테마를 구성하고자 하는 경우 여러분의 SCSS 파일에서 부트스트랩에서 제공하는 SCSS 파일을 불러오게되면 아래처럼 경고 로그가 출력될 수 있습니다.</p><pre class="language-ps" data-language="ps"><code class="language-ps">LOG from .&#x2F;node_modules&#x2F;sass-loader&#x2F;dist&#x2F;cjs.js sass-loader .&#x2F;node_modules&#x2F;css-loader&#x2F;dist&#x2F;cjs.js??clonedRuleSet-2[0].rules[0].use[1]!.&#x2F;node_modules&#x2F;postcss-loader&#x2F;dist&#x2F;cjs.js!.&#x2F;node_modules&#x2F;resolve-url-loader&#x2F;index.js!.&#x2F;node_modules&#x2F;sass-loader&#x2F;dist&#x2F;cjs.js??clonedRuleSet-2[0].rules[0].use[4]!.&#x2F;src&#x2F;scss&#x2F;bootstrap.scss&lt;w&gt; Deprecation Using &#x2F; for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0.&lt;w&gt;&lt;w&gt; Recommendation: math.div($b-custom-control-indicator-size-lg, 2) or calc($b-custom-control-indicator-size-lg &#x2F; 2)&lt;w&gt;&lt;w&gt; More info and automated migrator: https:&#x2F;&#x2F;sass-lang.com&#x2F;d&#x2F;slash-div&lt;w&gt;&lt;w&gt; node_modules\bootstrap-vue\src\_variables.scss 33:46  @import&lt;w&gt; node_modules\bootstrap-vue\src\index.scss 7:9         @import&lt;w&gt; src\scss\bootstrap.scss 11:9                          root stylesheet&lt;w&gt;&lt;w&gt; Deprecation Using &#x2F; for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0.&lt;w&gt;&lt;w&gt; Recommendation: math.div($b-custom-control-indicator-size-sm, 2) or calc($b-custom-control-indicator-size-sm &#x2F; 2)&lt;w&gt;&lt;w&gt; More info and automated migrator: https:&#x2F;&#x2F;sass-lang.com&#x2F;d&#x2F;slash-div&lt;w&gt;&lt;w&gt; node_modules\bootstrap-vue\src\_variables.scss 34:46  @import&lt;w&gt; node_modules\bootstrap-vue\src\index.scss 7:9         @import&lt;w&gt; src\scss\bootstrap.scss 11:9                          root stylesheet&lt;w&gt;&lt;w&gt; Deprecation Using &#x2F; for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0.&lt;w&gt;&lt;w&gt; Recommendation: math.div($font-size-lg * $line-height-lg - $b-custom-control-indicator-size-lg, 2) or calc(($font-size-lg * $line-height-lg - $b-custom-control-indicator-size-lg) &#x2F; 2)&lt;w&gt;&lt;w&gt; More info and automated migrator: https:&#x2F;&#x2F;sass-lang.com&#x2F;d&#x2F;slash-div&lt;w&gt;&lt;w&gt; node_modules\bootstrap-vue\src\components\form-checkbox\_form-checkbox.scss 10:10  @import&lt;w&gt; node_modules\bootstrap-vue\src\components\form-checkbox\index.scss 1:9             @import&lt;w&gt; node_modules\bootstrap-vue\src\components\index.scss 5:9                           @import&lt;w&gt; node_modules\bootstrap-vue\src\index.scss 14:9                                     @import&lt;w&gt; src\scss\bootstrap.scss 11:9                                                       root stylesheet&lt;w&gt;&lt;w&gt; Deprecation Using &#x2F; for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0.&lt;w&gt;&lt;w&gt; Recommendation: math.div($font-size-lg * $line-height-lg - $b-custom-control-indicator-size-lg, 2) or calc(($font-size-lg * $line-height-lg - $b-custom-control-indicator-size-lg) &#x2F; 2)&lt;w&gt;&lt;w&gt; More info and automated migrator: https:&#x2F;&#x2F;sass-lang.com&#x2F;d&#x2F;slash-div&lt;w&gt;&lt;w&gt; node_modules\bootstrap-vue\src\components\form-checkbox\_form-checkbox.scss 18:10  @import&lt;w&gt; node_modules\bootstrap-vue\src\components\form-checkbox\index.scss 1:9             @import&lt;w&gt; node_modules\bootstrap-vue\src\components\index.scss 5:9                           @import&lt;w&gt; node_modules\bootstrap-vue\src\index.scss 14:9                                     @import&lt;w&gt; src\scss\bootstrap.scss 11:9                                                       root stylesheet&lt;w&gt;&lt;w&gt; Deprecation Using &#x2F; for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0.&lt;w&gt;&lt;w&gt; Recommendation: math.div($font-size-sm * $line-height-sm - $b-custom-control-indicator-size-sm, 2) or calc(($font-size-sm * $line-height-sm - $b-custom-control-indicator-size-sm) &#x2F; 2)&lt;w&gt;&lt;w&gt; More info and automated migrator: https:&#x2F;&#x2F;sass-lang.com&#x2F;d&#x2F;slash-div&lt;w&gt;&lt;w&gt; node_modules\bootstrap-vue\src\components\form-checkbox\_form-checkbox.scss 33:10  @import&lt;w&gt; node_modules\bootstrap-vue\src\components\form-checkbox\index.scss 1:9             @import&lt;w&gt; node_modules\bootstrap-vue\src\components\index.scss 5:9                           @import&lt;w&gt; node_modules\bootstrap-vue\src\index.scss 14:9                                     @import&lt;w&gt; src\scss\bootstrap.scss 11:9                                                       root stylesheet&lt;w&gt;&lt;w&gt; 17 repetitive deprecation warnings omitted.&lt;w&gt;&lt;w&gt; null</code></pre><p>부트스트랩에서 사용중인 문법을 어떻게 바꾸라고 안내하지만 의존성에서 제공하는 파일을 수정할 수는 없습니다. 그래서 위 경고 로그를 출력하지 않게 하는 방법이 필요합니다.</p><h3 id="Dart-Sass-quietDeps"><a href="#Dart-Sass-quietDeps" class="headerlink" title="Dart Sass - quietDeps"></a>Dart Sass - quietDeps</h3><p>다행스럽게도 Dart Sass 에서는 <a href="https://sass-lang.com/documentation/cli/dart-sass#quiet-deps">quietDeps</a>옵션을 제공하여 의존성에 대한 Deprecation 경고 출력을 하지 않도록 지원합니다.<br>만약, 웹팩에서 sass-loader를 사용한다면 다음과 같이 <strong>sassOptions</strong> 속성으로 위 옵션을 적용할 수 있습니다.</p><pre class="language-js" data-language="js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">&#123;</span>        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.s[ac]ss$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span>        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token comment">// ...</span>          <span class="token punctuation">&#123;</span>            <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">"sass-loader"</span><span class="token punctuation">,</span>            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token literal-property property">sourceMap</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>              <span class="token literal-property property">sassOptions</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token literal-property property">quietDeps</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"node_modules/bootstrap/**/*.scss"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">]</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre><p>이제 부트스트랩의 SCSS 파일을 임포트하더라도 더이상 경고 로그는 출력되지 않게 되었습니다.<br>감사합니다.</p><h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul><li><a href="https://sass-lang.com/documentation/cli/dart-sass#quiet-deps">Dart Sass - quiet-deps</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 특정 디펜던시에 대한 Dart Sass의 Deprecation 경고를 제외하는 방법에 대해서 공유하려고 합니다.&lt;/p&gt;
&lt;h2 id=&quot;Deprecation-Warnings&quot;&gt;&lt;a href=&quot;#De</summary>
      
    
    
    
    
    <category term="Dart Sass" scheme="https://kdevkr.github.io/tags/Dart-Sass/"/>
    
    <category term="quietDeps" scheme="https://kdevkr.github.io/tags/quietDeps/"/>
    
  </entry>
  
  <entry>
    <title>프로젝트의 노드 버전 제한하기</title>
    <link href="https://kdevkr.github.io/strict-nodejs-version-for-project/"/>
    <id>https://kdevkr.github.io/strict-nodejs-version-for-project/</id>
    <published>2021-12-26T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.516Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 함께 일하는 개발자들이 프로젝트마다 사용해야하는 노드 버전을 제한하는 방법에 대하여 공유하려고 해요.</p><h2 id="프로젝트-노드-버전-제한"><a href="#프로젝트-노드-버전-제한" class="headerlink" title="프로젝트 노드 버전 제한"></a>프로젝트 노드 버전 제한</h2><p>프로젝트에서 사용하는 패키지마다 지원하는 최소 노드 버전이 다를 수 있습니다. 예를 들어, 다음과 같이 패키지 버전이 업데이트되면서 요구하는 노드 버전이 변경될 수 있습니다.</p><ul><li><a href="https://webpack.js.org/blog/2020-10-10-webpack-5-release/#minimum-nodejs-version">webpack@5.0.0</a> minimum supported Node.js version is 10.13.0</li><li><a href="https://github.com/webpack-contrib/style-loader/releases/tag/v3.0.0">style-loader@3.0.0</a> minimum supported Node.js version is 12.13.0</li><li><a href="https://github.com/webpack/webpack-dev-server/blob/master/CHANGELOG.md#400-beta3-2021-05-06">webpack-dev-server@4.0.0-beta.3</a> minimum supported Node.js version is 12.13.0</li></ul><h3 id="Package-json"><a href="#Package-json" class="headerlink" title="Package.json"></a>Package.json</h3><p>Package.json 파일의 <code>engines</code> 속성으로 프로젝트에서 사용하는 NPM 또는 노드 버전을 명시할 수 있습니다.</p><pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"engines"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"npm"</span><span class="token operator">:</span> <span class="token string">">=6.4.1"</span><span class="token punctuation">,</span>    <span class="token property">"node"</span><span class="token operator">:</span> <span class="token string">">=12.13.0"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h3 id="엔진-제한-옵션-활성화"><a href="#엔진-제한-옵션-활성화" class="headerlink" title="엔진 제한 옵션 활성화"></a>엔진 제한 옵션 활성화</h3><p>Package.json 파일에 노드 버전을 명시하더라도 사용자의 엔진을 제한할 수는 없습니다. 이를 별도로 제한하기 위해서는 프로젝트 폴더에 .npmrc 파일을 만들고 <code>engine-strict</code> 옵션을 활성화해야합니다.</p><pre class="language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">engine-strict</span><span class="token punctuation">=</span><span class="token attr-value">true</span></code></pre><h3 id="노드-엔진-제한-여부-확인"><a href="#노드-엔진-제한-여부-확인" class="headerlink" title="노드 엔진 제한 여부 확인"></a>노드 엔진 제한 여부 확인</h3><p>노드 버전을 명시하고 엔진 제한 옵션을 활성화하였으므로 실제로 노드 엔진이 제한되는지 확인해보겠습니다.</p><pre class="language-sh" data-language="sh"><code class="language-sh">npm inpm ERR! code ENOTSUPnpm ERR! notsup Unsupported engine for @1.0.0: wanted: &#123;&quot;npm&quot;:&quot;&gt;&#x3D;6.4.1&quot;,&quot;node&quot;:&quot;&gt;&#x3D;12.13.0&quot;&#125; (current: &#123;&quot;node&quot;:&quot;10.23.0&quot;,&quot;npm&quot;:&quot;6.14.8&quot;&#125;)npm ERR! notsup Not compatible with your version of node&#x2F;npm: @1.0.0npm ERR! notsup Not compatible with your version of node&#x2F;npm: @1.0.0npm ERR! notsup Required: &#123;&quot;npm&quot;:&quot;&gt;&#x3D;6.4.1&quot;,&quot;node&quot;:&quot;&gt;&#x3D;12.13.0&quot;&#125;npm ERR! notsup Actual:   &#123;&quot;npm&quot;:&quot;6.14.8&quot;,&quot;node&quot;:&quot;10.23.0&quot;&#125;</code></pre><p>현재 사용중인 노드 버전은 10.23.0 이지만 프로젝트에서 요구하는 버전은 12.13.0 이상이므로 오류가 발생하였습니다.</p><p>이상으로 프로젝트에서 지원하는 최소 노드 엔진 버전을 명시하고 프로젝트에 참여하는 모든 개발자들이 알맞은 노드 버전을 사용하도록 안내할 수 있게 되었습니다.</p><p>감사합니다.</p><h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul><li><a href="https://medium.com/@fabian.illner/force-correct-node-js-version-with-npm-a2a57fd12fa">Force correct Node.js version with npm</a>  </li><li><a href="https://www.geeksforgeeks.org/how-to-define-the-required-node-js-version-in-package-json/">How to define the required Node.js version in package.json?</a>  </li><li><a href="https://reactgo.com/specify-node-version/">Specifying a required Node.js version in Package.json file</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 함께 일하는 개발자들이 프로젝트마다 사용해야하는 노드 버전을 제한하는 방법에 대하여 공유하려고 해요.&lt;/p&gt;
&lt;h2 id=&quot;프로젝트-노드-버전-제한&quot;&gt;&lt;a href=&quot;#프로젝트-노드-버전-제한&quot; </summary>
      
    
    
    
    
    <category term="package.json" scheme="https://kdevkr.github.io/tags/package-json/"/>
    
    <category term="npmrc" scheme="https://kdevkr.github.io/tags/npmrc/"/>
    
    <category term="engines" scheme="https://kdevkr.github.io/tags/engines/"/>
    
  </entry>
  
  <entry>
    <title>Unsupported allowDuplicateContentLengths in Spring Cloud Gateway of Hoxton Version</title>
    <link href="https://kdevkr.github.io/unsupported-allowduplicatecontentlength-in-spring-cloud-gateway-of-hoxton-version/"/>
    <id>https://kdevkr.github.io/unsupported-allowduplicatecontentlength-in-spring-cloud-gateway-of-hoxton-version/</id>
    <published>2021-12-19T00:00:00.000Z</published>
    <updated>2022-05-07T03:34:32.516Z</updated>
    
    <content type="html"><![CDATA[<p>안녕하세요 Mambo 입니다.</p><p>오늘은 스프링 클라우드 게이트웨이에서 발생하는 Content-Length 헤더의 값이 단일이 아닌 복수로 지정될 때 발생하는 오류에 대해 다루어보려고 합니다.</p><h2 id="RFC-7230"><a href="#RFC-7230" class="headerlink" title="RFC 7230"></a>RFC 7230</h2><p><a href="https://datatracker.ietf.org/doc/html/rfc7230#section-3.3.2">RFC 7230 - 3.3.2. Content-Length</a>를 참고해보면 다른 헤더들과는 다르게 Content-Length 헤더는 단일로 구성되어야 한다고 규정합니다. 다만, 다음과 내용을 통해 Content-Length 헤더 값이 복수로 구성되는 경우는 수신자가 오류로 처리하거나 단일 값으로 처리해야한다고 설명하고 있습니다.</p><blockquote><p>If a message is received that has multiple Content-Length header fields with field-values consisting of the same decimal value, or a single Content-Length header field with a field value containing a list of identical decimal values (e.g., “Content-Length: 42, 42”), indicating that duplicate Content-Length header fields have been generated or combined by an upstream message processor, then the recipient MUST either reject the message as invalid or replace the duplicated field-values with a single valid Content-Length field containing that decimal value prior to determining the message body length or forwarding the message.</p></blockquote><h2 id="오류-및-원인-분석"><a href="#오류-및-원인-분석" class="headerlink" title="오류 및 원인 분석"></a>오류 및 원인 분석</h2><p>스프링 클라우드 게이트웨이에서 발생한 오류에 대한 내용은 <a href="https://github.com/spring-cloud/spring-cloud-gateway/issues/2465">Multiple Content-Length values found: [229455, 229455]</a>에서 확인할 수 있습니다.</p><p>모든 스프링 클라우드 게이트웨이 버전에서 발생하는 상황은 아니었으며 스프링 부트 2.3.x와 호환성이 검증된 스프링 클라우드 Hoxton 릴리즈 트레인으로 관리되는 스프링 클라우드 게이트웨이 서버에서 발생하였습니다. Content-Length 헤더 값이 복수로 지정되는 것은 브라우저에서 실행간으한 wav, mp3, webm 파일을 요청할 때 발생한 것으로 일반적인 curl 또는 Postman을 통해서는 정상적으로 응답이 수행되었습니다.</p><h3 id="HttpUtil-normalizeAndGetContentLength"><a href="#HttpUtil-normalizeAndGetContentLength" class="headerlink" title="HttpUtil#normalizeAndGetContentLength"></a>HttpUtil#normalizeAndGetContentLength</h3><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>IllegalArgumentException</span><span class="token operator">:</span> <span class="token class-name">Multiple</span> <span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Length</span> values found<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">229455</span><span class="token punctuation">,</span> <span class="token number">229455</span><span class="token punctuation">]</span>at <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span>HttpUtil</span><span class="token punctuation">.</span><span class="token function">normalizeAndGetContentLength</span><span class="token punctuation">(</span><span class="token class-name">HttpUtil</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">595</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>netty<span class="token operator">-</span>codec<span class="token operator">-</span>http<span class="token operator">-</span><span class="token number">4.1</span><span class="token number">.65</span><span class="token punctuation">.</span>Final<span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">4.1</span><span class="token number">.65</span><span class="token punctuation">.</span>Final<span class="token punctuation">]</span><span class="token class-name">Suppressed</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span>FluxOnAssembly</span>$<span class="token class-name">OnAssemblyException</span><span class="token operator">:</span> <span class="token class-name">Error</span> has been observed at the following <span class="token function">site</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">:</span></code></pre><p>위 스택트레이스 내용에 따르면 Netty 라이브러리의 netty-codec-http 모듈에서 HttpUtil.normalizeAndGetContentLength 함수로 처리될 때 오류가 던져졌음을 확인할 수 있습니다. 또한, netty-codec-http 모듈의 <a href="https://github.com/netty/netty/blob/c08beb543a6b8db0c7f3cee225042361b4025e4c/codec-http/src/main/java/io/netty/handler/codec/http/HttpUtil.java#L555-L560">HttpUtil#normarlizeAndGetContentLength</a>에는 allowDuplicateContentLengths 파라미터를 통해 복수의 동일한 값이 지정되더라도 단일 값으로 처리되도록 구현되어있는 상태입니다.</p><h3 id="Reactor-Netty-HttpDecoderSpec"><a href="#Reactor-Netty-HttpDecoderSpec" class="headerlink" title="Reactor Netty - HttpDecoderSpec"></a>Reactor Netty - HttpDecoderSpec</h3><p>이미 allowDuplicateContentLengths 옵션을 지원하는데도 불구하고 스프링 클라우드 Hoxton 버전에서 의존하는 reactor-netty:0.9.x.RELEASE 에서는 HttpDecoderSpec 클래스가 allowDuplicateContentLengths 옵션을 지원하지 않았습니다.</p><p>더 자세한 정보를 찾아본 결과 HttpDecoderSpec에서 allowDuplicateContentLengths 옵션이 지원되는 것은 <a href="https://github.com/reactor/reactor-netty/pull/1638/commits/978ba8a737f26376d1caab4806e25420e7aac7b7">Add HttpDecoderSpec#allowDuplicateContentLengths(boolean) #1638</a>으로 처리되었으며 <a href="https://github.com/reactor/reactor-netty/releases/tag/v1.0.8">Reactor Netty 1.0.8</a>에서부터 추가되어 반영되었음을 확인할 수 있었습니다. 그러나 위 반영 내용은 Reactor Netty 0.9.x 사용자들을 위한 Dysprosium 릴리즈 트레인에서 <a href="https://github.com/reactor/reactor-netty/releases/tag/v0.9.25.RELEASE">Reactor Netty 0.9.25.RELEASE</a>로 릴리즈 계획이 종료되기까지 반영되지 않은 사항입니다. </p><blockquote><p>Reactor Netty 0.9.x 사용자들을 위해 allowDuplicateContentLengths 옵션 지원을 반영할 수 있는지 <a href="https://github.com/reactor/reactor-netty/issues/1942">allowDuplicateContentLengths for Reactor Netty 0.9.x users #1942</a> 이슈를 등록해두었습니다. 이 이슈가 처리되기전까지는 HttpDecoderSpec에서 allowDuplicateContentLengths 파라미터를 활성화할 수 없습니다.</p></blockquote><h2 id="해결방안"><a href="#해결방안" class="headerlink" title="해결방안"></a>해결방안</h2><p>Content-Length 헤더에 중복된 동일한 값이 설정되는 문제를 해결하기 위해서는 allowDuplicateContentLengths 옵션이 적용될 수 있도록 해야만합니다. 스프링 클라우드 게이트웨이 서버 스타터에서 자동 구성할 때 HttpClient에 대한 HttpClientCustomizer를 지원함에도 불구하고 의존하고 있는 HttpDecoderSpec에서 allowDuplicateContentLengths를 적용할 수 있어야만 합니다. 따라서, Reactor Netty 의존성 버전을 1.0.8 이상으로 변경할 수 밖에 없습니다.</p><h3 id="첫번째-시도-Reactor-Bom-변경"><a href="#첫번째-시도-Reactor-Bom-변경" class="headerlink" title="첫번째 시도 - Reactor Bom 변경"></a>첫번째 시도 - Reactor Bom 변경</h3><p>혹시나 Reactor Netty 의존성 버전을 변경하여 가능할지도 모른다는 생각으로 버전 업그레이드를 시도해보았습니다.</p><pre class="language-groovy" data-language="groovy"><code class="language-groovy">ext <span class="token punctuation">&#123;</span>    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'springCloudVersion'</span><span class="token punctuation">,</span> <span class="token string">'Hoxton.SR12'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'reactorNettyVersion'</span><span class="token punctuation">,</span> <span class="token string">'2020.0.8'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>dependencyManagement <span class="token punctuation">&#123;</span>    imports <span class="token punctuation">&#123;</span>        mavenBom <span class="token string gstring">"org.springframework.cloud:spring-cloud-dependencies:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">&#123;</span>springCloudVersion<span class="token punctuation">&#125;</span></span>"</span>        mavenBom <span class="token string gstring">"io.projectreactor:reactor-bom:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">&#123;</span>reactorNettyVersion<span class="token punctuation">&#125;</span></span>"</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>Reactor Netty 버전을 변경하기 위해 Reactor Bom을 적용해본 결과 다음과 같이 reactor.netty.tcp.ProxyProvider를 클래스로더에서 찾을 수 없는 상태가 되었습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>NoClassDefFoundError</span><span class="token operator">:</span> reactor<span class="token operator">/</span>netty<span class="token operator">/</span>tcp<span class="token operator">/</span><span class="token class-name">ProxyProvider</span>$<span class="token class-name">Builder</span>at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Class</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethods0</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>na<span class="token operator">:</span>na<span class="token punctuation">]</span>at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Class</span><span class="token punctuation">.</span><span class="token function">privateGetDeclaredMethods</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3166</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>na<span class="token operator">:</span>na<span class="token punctuation">]</span>at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Class</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2309</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>na<span class="token operator">:</span>na<span class="token punctuation">]</span>at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">463</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>spring<span class="token operator">-</span>core<span class="token operator">-</span><span class="token number">5.2</span><span class="token number">.15</span><span class="token punctuation">.</span>RELEASE<span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">5.2</span><span class="token number">.15</span><span class="token punctuation">.</span>RELEASE<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">19</span> common frames omitted<span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassNotFoundException</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">reactor<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>tcp<span class="token punctuation">.</span></span>ProxyProvider</span>$<span class="token class-name">Builder</span>at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">jdk<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>loader<span class="token punctuation">.</span></span>BuiltinClassLoader</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">BuiltinClassLoader</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">581</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>na<span class="token operator">:</span>na<span class="token punctuation">]</span>at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">jdk<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>loader<span class="token punctuation">.</span></span>ClassLoaders</span>$<span class="token class-name">AppClassLoader</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">ClassLoaders</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">178</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>na<span class="token operator">:</span>na<span class="token punctuation">]</span>at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassLoader</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">522</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>na<span class="token operator">:</span>na<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">23</span> common frames omitted</code></pre><p>이러한 문제가 발생하는 이유는 <a href="https://github.com/reactor/reactor-netty/releases/tag/v1.0.0">Reactor Netty 1.0.0</a>에서부터 reactor.netty.tcp.ProxyProvider가 reactor.netty.transport.ProxyProvider로 변경되었기 때문입니다. 스프링 클라우드 Hoxton에서는 Reactor Netty 0.9.x의 클래스들을 사용하기 때문에 단순하게 Reactor Netty 의존성 버전을 변경할 수는 없습니다.</p><h3 id="두번째-시도-Spring-Cloud-버전-업그레이드"><a href="#두번째-시도-Spring-Cloud-버전-업그레이드" class="headerlink" title="두번째 시도 - Spring Cloud 버전 업그레이드"></a>두번째 시도 - Spring Cloud 버전 업그레이드</h3><p>Reactor Netty 1.0.8을 사용하기 위해서는 스프링 클라우드 2020.0.x aka Ilford 릴리즈 트레인의 스프링 클라우드와 함께 스프링 부트 2.4.x로 업그레이드해야합니다. 테스트 중인 프로젝트에서는 그래들 멀티 프로젝트로 구성되어 스프링 클라우드 게이트웨이 서버와 애플리케이션 서버가 동일한 스프링 부트 버전을 사용하고 있었습니다.</p><pre class="language-groovy" data-language="groovy"><code class="language-groovy">plugins <span class="token punctuation">&#123;</span>    id <span class="token string">'rog.springframework.boot'</span> version <span class="token string">'2.4.13'</span><span class="token punctuation">&#125;</span>ext <span class="token punctuation">&#123;</span>    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'springCloudVersion'</span><span class="token punctuation">,</span> <span class="token string">'2020.0.0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'reactorNettyVersion'</span><span class="token punctuation">,</span> <span class="token string">'2020.0.8'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>dependencyManagement <span class="token punctuation">&#123;</span>    imports <span class="token punctuation">&#123;</span>        mavenBom <span class="token string gstring">"org.springframework.cloud:spring-cloud-dependencies:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">&#123;</span>springCloudVersion<span class="token punctuation">&#125;</span></span>"</span>        mavenBom <span class="token string gstring">"io.projectreactor:reactor-bom:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">&#123;</span>reactorNettyVersion<span class="token punctuation">&#125;</span></span>"</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><blockquote><p>스프링 부트 2.4 부터 변경된 사항에 대해서 검토하여야합니다.</p></blockquote><p>아쉽게도 스프링 부트 버전과 스프링 클라우드 버전을 업그레이드 하고나서는 Content-Length에 복수로 설정되던 파일들이 정상적으로 단일 값으로 처리되어 allowDuplicateContentLengths 적용이 필요하지 않은 상태가 되었습니다. 만약, allowDuplicateContentLengths 적용이 필요하다면 다음과 같이 HttpClientCustomzier를 통해 구성할 수 있습니다.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyHttpClientCustomizer</span> <span class="token keyword">implements</span> <span class="token class-name">HttpClientCustomizer</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">HttpClient</span> <span class="token function">customize</span><span class="token punctuation">(</span><span class="token class-name">HttpClient</span> httpClient<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> httpClient<span class="token punctuation">.</span><span class="token function">httpResponseDecoder</span><span class="token punctuation">(</span>decoderSpec <span class="token operator">-></span>             decoderSpec                <span class="token punctuation">.</span><span class="token function">allowDuplicateContentLengths</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>이 내용은 Okky 커뮤니티에 <a href="https://okky.kr/article/1122985">Spring Cloud Hoxton의 Spring Cloud Gateway에서는 allowDuplicateContentLengths을 지원하지 않음</a>로 공유되었음을 알려드리며 마치도록 하겠습니다.</p><p>감사합니다.</p><blockquote><p><a href="https://github.com/reactor/reactor-netty/issues/1942">https://github.com/reactor/reactor-netty/issues/1942</a><br>Reactor Netty 측에 0.9.x 사용자들을 위해 수정 요청하였으나 업데이트 중단된 버전인 사유로 거부되었습니다.</p></blockquote><h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul><li><a href="https://datatracker.ietf.org/doc/html/rfc7230">RFC 7230</a>  </li><li><a href="https://spring.io/projects/spring-cloud">Spring Cloud Release train Spring Boot compatibility</a></li><li><a href="https://github.com/spring-cloud/spring-cloud-gateway">spring-cloud&#x2F;spring-cloud-gateway</a></li><li><a href="https://github.com/reactor/reactor-netty/releases/tag/v1.0.8">Reactor Netty 1.0.8 Release</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;안녕하세요 Mambo 입니다.&lt;/p&gt;
&lt;p&gt;오늘은 스프링 클라우드 게이트웨이에서 발생하는 Content-Length 헤더의 값이 단일이 아닌 복수로 지정될 때 발생하는 오류에 대해 다루어보려고 합니다.&lt;/p&gt;
&lt;h2 id=&quot;RFC-7230&quot;&gt;&lt;a</summary>
      
    
    
    
    
    <category term="Spring Cloud Gateway" scheme="https://kdevkr.github.io/tags/Spring-Cloud-Gateway/"/>
    
    <category term="RFC 7230" scheme="https://kdevkr.github.io/tags/RFC-7230/"/>
    
    <category term="Reactor Netty" scheme="https://kdevkr.github.io/tags/Reactor-Netty/"/>
    
  </entry>
  
</feed>
