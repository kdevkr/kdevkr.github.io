<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.0.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png"><link rel="mask-icon" href="/images/favicon/favicon.ico" color="#222"><meta name="google-site-verification" content="LMcddVW6xLBS7X1htGQ3duOIEmVp4ljku8sd3UuIcBg"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Sans+KR:300,300italic,400,400italic,700,700italic%7CGmarket+Sans:300,300italic,400,400italic,700,700italic%7CRIDIBatang:300,300italic,400,400italic,700,700italic%7CJetbrains+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" integrity="sha256-jTIdiMuX/e3DGJUGwl3pKSxuc6YOuqtJYkM0bGQESA4=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-loading-bar.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"kdevkr.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.10.1","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"width":240,"scrollpercent":true,"b2t":true},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script><meta name="description" content="안녕하세요 Mambo 입니다. 오늘은 아마존 웹 서비스의 Elastic Beanstalk에서 지원하는 도커 컨테이너 환경을 통해 애플리케이션을 배포하는 방법에 대하여 알아봅니다. 이 글에서는 애플리케이션을 도커 이미지화하고 사설 도커 레지스트리 서버에 저장된 도커 이미지를 기반으로 Elastic Beanstalk 환경에서 도커 컴포즈를 활용해 애플리케이션을"><meta property="og:type" content="article"><meta property="og:title" content="Elastic Beanstalk Docker Platform"><meta property="og:url" content="https://kdevkr.github.io/elastic-beanstalk-docker-with-python/index.html"><meta property="og:site_name" content="Mambo"><meta property="og:description" content="안녕하세요 Mambo 입니다. 오늘은 아마존 웹 서비스의 Elastic Beanstalk에서 지원하는 도커 컨테이너 환경을 통해 애플리케이션을 배포하는 방법에 대하여 알아봅니다. 이 글에서는 애플리케이션을 도커 이미지화하고 사설 도커 레지스트리 서버에 저장된 도커 이미지를 기반으로 Elastic Beanstalk 환경에서 도커 컴포즈를 활용해 애플리케이션을"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://kdevkr.github.io/images/posts/beanstalk-docker-platform/web.png"><meta property="article:published_time" content="2021-09-06T00:00:00.000Z"><meta property="article:modified_time" content="2022-05-04T22:43:04.409Z"><meta property="article:author" content="Mambo"><meta property="article:tag" content="Beanstalk"><meta property="article:tag" content="Docker"><meta property="article:tag" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://kdevkr.github.io/images/posts/beanstalk-docker-platform/web.png"><link rel="canonical" href="https://kdevkr.github.io/elastic-beanstalk-docker-with-python/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://kdevkr.github.io/elastic-beanstalk-docker-with-python/","path":"elastic-beanstalk-docker-with-python/","title":"Elastic Beanstalk Docker Platform"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Elastic Beanstalk Docker Platform | Mambo</title><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-93954323-1","only_pageview":true}</script><script src="/js/third-party/analytics/google-analytics.js"></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="Mambo" type="application/atom+xml">
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}</style></head><body itemscope itemtype="http://schema.org/WebPage"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Mambo</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Today I Learned 🔥</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fas fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fas fa-archive fa-fw"></i>Archives<span class="badge">53</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fas fa-user fa-fw"></i>About</a></li></ul></nav></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%EB%8F%84%EC%BB%A4-%ED%94%8C%EB%9E%AB%ED%8F%BC"><span class="nav-number">1.</span> <span class="nav-text">도커 플랫폼</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EB%8F%84%EC%BB%A4-%EC%9D%B4%EB%AF%B8%EC%A7%80"><span class="nav-number">1.1.</span> <span class="nav-text">애플리케이션 도커 이미지</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%ED%94%8C%EB%9E%AB%ED%8F%BC-%ED%99%95%EC%9E%A5-%EA%B5%AC%EC%84%B1-%ED%8C%8C%EC%9D%BC"><span class="nav-number">1.2.</span> <span class="nav-text">플랫폼 확장 구성 파일</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EB%8F%84%EC%BB%A4-%EC%BB%B4%ED%8F%AC%EC%A6%88-%EB%AC%B8%EC%84%9C"><span class="nav-number">1.3.</span> <span class="nav-text">도커 컴포즈 문서</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EB%8F%84%EC%BB%A4-%EB%A0%88%EC%A7%80%EC%8A%A4%ED%8A%B8%EB%A6%AC-%EC%84%9C%EB%B2%84-%EC%9D%B8%EC%A6%9D-%ED%8C%8C%EC%9D%BC"><span class="nav-number">1.4.</span> <span class="nav-text">도커 레지스트리 서버 인증 파일</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1-%ED%8C%8C%EC%9D%BC"><span class="nav-number">1.5.</span> <span class="nav-text">환경 구성 파일</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EB%8F%84%EC%BB%A4-%EA%B5%AC%EC%84%B1-%ED%8C%8C%EC%9D%BC"><span class="nav-number">1.6.</span> <span class="nav-text">도커 구성 파일</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EC%86%8C%EC%8A%A4-%EB%B2%88%EB%93%A4"><span class="nav-number">1.7.</span> <span class="nav-text">애플리케이션 소스 번들</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Mambo" src="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4"><p class="site-author-name" itemprop="name">Mambo</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">53</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-tags"><span class="site-state-item-count">83</span> <span class="site-state-item-name">tags</span></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/kdevkr" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kdevkr" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:kdevkr@gmail.com" title="E-Mail → mailto:kdevkr@gmail.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a></span></div><div class="cc-license site-overview-item animated" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ko" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div><div class="back-to-top animated" role="button" aria-label="Back to top"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div class="sidebar-dimmer"></div></header><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://kdevkr.github.io/elastic-beanstalk-docker-with-python/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4"><meta itemprop="name" content="Mambo"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Mambo"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Elastic Beanstalk Docker Platform | Mambo"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Elastic Beanstalk Docker Platform</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-09-06 00:00:00" itemprop="dateCreated datePublished" datetime="2021-09-06T00:00:00Z">2021-09-06</time></span></div></div></header><div class="post-body" itemprop="articleBody"><p>안녕하세요 Mambo 입니다.</p><p>오늘은 아마존 웹 서비스의 <strong>Elastic Beanstalk에서 지원하는 도커 컨테이너 환경을 통해 애플리케이션을 배포하는 방법</strong>에 대하여 알아봅니다. 이 글에서는 애플리케이션을 도커 이미지화하고 사설 도커 레지스트리 서버에 저장된 도커 이미지를 기반으로 Elastic Beanstalk 환경에서 도커 컴포즈를 활용해 애플리케이션을 실행하는 것을 설명합니다.</p><h2 id="도커-플랫폼"><a href="#도커-플랫폼" class="headerlink" title="도커 플랫폼"></a>도커 플랫폼</h2><p>Elastic Beanstalk의 <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/docker.html">도커 플랫폼</a>은 도커 컨테이너 환경에서 애플리케이션을 실행하는 기능을 지원합니다. 도커 플랫폼을 사용해 애플리케이션을 배포하기 위해서는 도커 컨테이너와 Elastic Beanstalk에 대한 이해가 필요합니다. 도커 플랫폼에서는 Dockerfile을 사용하여 직접 도커 이미지를 빌드하여 도커 컨테이너를 실행하거나 <strong>Dockerrun.aws.json</strong> 파일로 컨테이너 환경을 정의할 수 있도록 지원합니다. 또한, <a target="_blank" rel="noopener" href="https://docs.docker.com/registry/deploying/">도커 레지스트리 서버</a>에 저장된 이미지를 기반으로 컨테이너를 구성할 수 있는 <strong>도커 컴포즈</strong> 방식도 사용할 수 있습니다.</p><p>도커 플랫폼에서 도커 이미지화된 애플리케이션을 도커 컴포즈로 배포하기 위해서는 다음의 항목들을 작성해야합니다.</p><ul><li>애플리케이션 도커 이미지</li><li>플랫폼 확장 및 환경 구성 파일</li><li>도커 컴포즈 문서</li><li>도커 레지스트리 서버 인증 파일</li><li>도커 구성 파일</li></ul><blockquote><p>이 글에서는 도커 레지스트리 서버가 구축되어있다고 가정합니다.</p></blockquote><h3 id="애플리케이션-도커-이미지"><a href="#애플리케이션-도커-이미지" class="headerlink" title="애플리케이션 도커 이미지"></a>애플리케이션 도커 이미지</h3><p>Python으로 작성된 간단한 Flask 웹 애플리케이션을 작성하고 도커 이미지로 빌드하기 위한 <strong>Dockerfile</strong> 파일을 정의합니다.</p><pre class="language-python" data-language="python"><div class="caption"><span>application.py</span></div><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask

<span class="token comment"># print a nice greeting.</span>
<span class="token keyword">def</span> <span class="token function">say_hello</span><span class="token punctuation">(</span>username <span class="token operator">=</span> <span class="token string">"World"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'&lt;p>Hello %s!&lt;/p>\n'</span> <span class="token operator">%</span> username

<span class="token comment"># EB looks for an 'application' callable by default.</span>
application <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token comment"># add a rule for the index page.</span>
application<span class="token punctuation">.</span>add_url_rule<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'index'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> say_hello<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># run the app.</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment"># Setting debug to True enables debug output. This line should be</span>
    <span class="token comment"># removed before deploying a production app.</span>
    application<span class="token punctuation">.</span>debug <span class="token operator">=</span> <span class="token boolean">True</span>
    application<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><blockquote><p>저는 파이썬을 다루지 않는 개발자이므로 파이썬을 설치하고 가상 환경을 시작하는 것은 생략하겠습니다.</p></blockquote><p>PIP 명령어를 사용하여 Python 애플리케이션에서 사용하는 패키지를 설치하기 위한 <strong>requirements.txt</strong>을 준비합니다.</p><pre class="language-txt" data-language="txt"><div class="caption"><span>requirements.txt</span></div><code class="language-txt">click==8.0.1
Flask==1.1.2
itsdangerous==2.0.1
Jinja2==3.0.1
MarkupSafe==2.0.1
Werkzeug==2.0.1</code></pre><p>그리고 도커 허브에 등록된 Python 이미지를 기반으로 requirements.txt을 기준의 패키지를 설치하는 <strong>Dockerfile</strong>을 정의합니다.</p><pre class="language-Dockerfile" data-language="Dockerfile"><div class="caption"><span>Dockerfile</span></div><code class="language-Dockerfile">FROM python:3.8

WORKDIR &#x2F;app

ARG PORT&#x3D;8000
ARG MAIN&#x3D;application
ARG MAIN_APP&#x3D;application
ARG WORKERS&#x3D;application
ARG WORKERS&#x3D;2
ARG WORKERCLASS&#x3D;gevent

ENV PORT $&#123;PORT&#125;
ENV MAIN $&#123;MAIN&#125;
ENV MAIN_APP $&#123;MAIN_APP&#125;
ENV WORKERS $&#123;WORKERS&#125;
ENV WORKERCLASS $&#123;WORKERCLASS&#125;

COPY requirements.txt requirements.txt
RUN pip3 install -r requirements.txt
RUN pip3 install gunicorn
COPY . .

EXPOSE $&#123;PORT&#125;

RUN [&quot;chmod&quot;, &quot;+x&quot;, &quot;.&#x2F;entrypoint.sh&quot;]
ENTRYPOINT &quot;.&#x2F;entrypoint.sh&quot;</code></pre><p>마지막으로 <a target="_blank" rel="noopener" href="https://docs.gunicorn.org/en/stable/">Gunicorn WSGI 서버</a>를 사용하여 Flask 웹 애플리케이션을 실행하는 <strong>엔트리포인트</strong>를 작성합니다.</p><pre class="language-sh" data-language="sh"><div class="caption"><span>entrypoint.sh</span></div><code class="language-sh">#!&#x2F;bin&#x2F;sh
source venv&#x2F;bin&#x2F;activate
gunicorn $&#123;MAIN&#125;:$&#123;MAIN_APP&#125; -b 0.0.0.0:$&#123;PORT&#125; -w $&#123;WORKERS&#125;</code></pre><p>Dockerfile을 기반으로 애플리케이션을 도커 이미지로 생성하고 도커 레지스트리 서버에 빌드된 이미지를 저장합니다.</p><pre class="language-zsh" data-language="zsh"><div class="caption"><span>Terminal</span></div><code class="language-zsh">docker login https:&#x2F;&#x2F;registry.mambo.kr:5000
Username: mambo
Password:
Login Succeeded

docker build -t registry.mambo.kr:5000&#x2F;mambo-py:test
docker push registry.mambo.kr:5000&#x2F;mambo-py:test
docker logout registry.mambo.kr:5000&#x2F;mambo-py:test</code></pre><h3 id="플랫폼-확장-구성-파일"><a href="#플랫폼-확장-구성-파일" class="headerlink" title="플랫폼 확장 구성 파일"></a>플랫폼 확장 구성 파일</h3><p>Elastic Beanstalk에서도 Nginx 프록시 옵션을 설정할 수 있지만 도커 컴포즈를 사용하여 도커 컨테이너 환경을 구성하는 경우 Nginx 프록시 옵션을 활성화되어 있더라도 무시됩니다. Nginx 프록시 옵션을 무시한다는 의미는 애플리케이션 소스 번들에 도커 컴포즈 문서와 함께 <strong>.platform 폴더를 포함시키더라도 Nginx 구성 파일로 복사하여 확장하지 않는다</strong>는 이야기입니다.</p><p>하지만 애플리케이션 소스 번들에 포함시킨 <strong>.platform 폴더는 &#x2F;var&#x2F;app&#x2F;current에 추출</strong>되므로 도커 컴포즈 문서에 도커 컨테이너에 볼륨을 지정하여 전달할 수 있습니다.</p><pre class="language-nginx" data-language="nginx"><div class="caption"><span>docker-nginx.conf</span></div><code class="language-nginx"><span class="token directive"><span class="token keyword">user</span>                    nginx</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">error_log</span>               /var/log/nginx/error.log warn</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">pid</span>                     /var/run/nginx.pid</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">worker_processes</span>        auto</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">worker_rlimit_nofile</span>    <span class="token number">32768</span></span><span class="token punctuation">;</span>

<span class="token directive"><span class="token keyword">events</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">use</span>  epoll</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">worker_connections</span>  <span class="token number">1024</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">include</span>         /etc/nginx/mime.types</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">default_type</span>    application/octet-stream</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">log_format</span>      main    <span class="token string">'<span class="token variable">$remote_addr</span> - <span class="token variable">$remote_user</span> [<span class="token variable">$time_local]</span> "<span class="token variable">$request</span>" '</span>
                            <span class="token string">'<span class="token variable">$status</span> <span class="token variable">$body_bytes_sent</span> "<span class="token variable">$http_referer</span>" '</span>
                            <span class="token string">'"<span class="token variable">$http_user_agent</span>" "<span class="token variable">$http_x_forwarded_for</span>"'</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">include</span> conf.d/*.conf</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">map</span> <span class="token variable">$http_upgrade</span> <span class="token variable">$connection_upgrade</span></span> <span class="token punctuation">&#123;</span>
      <span class="token directive"><span class="token keyword">default</span>     <span class="token string">"upgrade"</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
      <span class="token directive"><span class="token keyword">listen</span>                <span class="token number">80</span> default_server</span><span class="token punctuation">;</span>
      <span class="token directive"><span class="token keyword">access_log</span>            /var/log/nginx/access.log main</span><span class="token punctuation">;</span>

      <span class="token directive"><span class="token keyword">client_header_timeout</span> <span class="token number">60</span></span><span class="token punctuation">;</span>
      <span class="token directive"><span class="token keyword">client_body_timeout</span>   <span class="token number">60</span></span><span class="token punctuation">;</span>
      <span class="token directive"><span class="token keyword">keepalive_timeout</span>     <span class="token number">60</span></span><span class="token punctuation">;</span>
      <span class="token directive"><span class="token keyword">gzip</span>                  <span class="token boolean">off</span></span><span class="token punctuation">;</span>
      <span class="token directive"><span class="token keyword">gzip_comp_level</span>       <span class="token number">4</span></span><span class="token punctuation">;</span>
      <span class="token directive"><span class="token keyword">gzip_types</span>            text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript</span><span class="token punctuation">;</span>

      <span class="token comment"># Include the Elastic Beanstalk generated locations</span>
      <span class="token directive"><span class="token keyword">include</span> conf.d/elasticbeanstalk/*.conf</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
           <span class="token directive"><span class="token keyword">listen</span>                   <span class="token number">443</span> ssl default_server</span><span class="token punctuation">;</span>
           <span class="token directive"><span class="token keyword">server_name</span>              mambo.kr</span><span class="token punctuation">;</span>
           <span class="token directive"><span class="token keyword">ssl_certificate</span>          /etc/nginx/cert/server-ca-bundle.pem</span><span class="token punctuation">;</span>
           <span class="token directive"><span class="token keyword">ssl_certificate_key</span>      /etc/nginx/cert/server.key</span><span class="token punctuation">;</span>
           <span class="token directive"><span class="token keyword">ssl_protocols</span>            TLSv1.2 TLSv1.3</span><span class="token punctuation">;</span>
           <span class="token directive"><span class="token keyword">ssl_ciphers</span>              HIGH:!aNULL:!MD5</span><span class="token punctuation">;</span>
           <span class="token directive"><span class="token keyword">ssl_verify_client</span>        optional_no_ca</span><span class="token punctuation">;</span>

           <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
               <span class="token directive"><span class="token keyword">proxy_pass</span>          http://app:8000</span><span class="token punctuation">;</span>
               <span class="token directive"><span class="token keyword">proxy_http_version</span>  1.1</span><span class="token punctuation">;</span>
               <span class="token directive"><span class="token keyword">proxy_set_header</span>    Connection          <span class="token variable">$connection_upgrade</span></span><span class="token punctuation">;</span>
               <span class="token directive"><span class="token keyword">proxy_set_header</span>    Upgrade             <span class="token variable">$http_upgrade</span></span><span class="token punctuation">;</span>
               <span class="token directive"><span class="token keyword">proxy_set_header</span>    Host                <span class="token variable">$host</span></span><span class="token punctuation">;</span>
               <span class="token directive"><span class="token keyword">proxy_set_header</span>    X-Real-IP           <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
               <span class="token directive"><span class="token keyword">proxy_set_header</span>    X-Forwarded-For     <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
               <span class="token directive"><span class="token keyword">proxy_set_header</span>    X-SSL-CERT          <span class="token variable">$ssl_client_escaped_cert</span></span><span class="token punctuation">;</span>
               <span class="token directive"><span class="token keyword">proxy_buffering</span>     <span class="token boolean">off</span></span><span class="token punctuation">;</span>
           <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre><p>단일 컨테이너를 구성하고 ELB로 전달되는 트래픽을 애플리케이션 컨테이너에 직접 전달할 수 있지만 도커 컴포즈를 사용하여 컨테이너 구성하더라도 직접 Nginx 컨테이너를 함께 구성할 수 있음을 보여줍니다. 위 Nginx 구성 파일은 일반적인 Elastic Beanstalk의 다양한 언어로 지원하는 플랫폼에서 제공하는 Nginx 확장 구성 파일과 동일하지만 <strong>애플리케이션과 Nginx가 별도의 독립적인 컨테이너로 실행되므로 호스트 이름으로 접근해야함</strong>을 보여줍니다.</p><h3 id="도커-컴포즈-문서"><a href="#도커-컴포즈-문서" class="headerlink" title="도커 컴포즈 문서"></a>도커 컴포즈 문서</h3><p>애플리케이션과 Nginx 컨테이너를 구성하는 도커 컴포즈 문서를 정의합니다.</p><pre class="language-yaml" data-language="yaml"><div class="caption"><span>docker-compose.yml</span></div><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.8"</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.21.1
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">env_file</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> .env
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> .platform/nginx/conf.d/elasticbeanstalk<span class="token punctuation">:</span>/etc/nginx/conf.d/elasticbeanstalk
      <span class="token punctuation">-</span> .platform/nginx/docker<span class="token punctuation">-</span>nginx.conf<span class="token punctuation">:</span>/etc/nginx/nginx.conf
      <span class="token punctuation">-</span> /etc/nginx/cert<span class="token punctuation">:</span>/etc/nginx/cert
      <span class="token punctuation">-</span> <span class="token string">"$&#123;EB_LOG_BASE_DIR&#125;/nginx:/var/log/nginx"</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'80:80'</span>
      <span class="token punctuation">-</span> <span class="token string">'443:443'</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> nginx_app
  <span class="token key atrule">app</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.mambo.kr<span class="token punctuation">:</span>5000/mambo<span class="token punctuation">-</span>py<span class="token punctuation">:</span>test
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">env_file</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> .env
    <span class="token key atrule">networks</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> nginx_app
<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  nginx_app<span class="token punctuation">:</span></code></pre><p>Elastic Beanstalk 환경 구성 파일에 의해 가져온 Nginx 인증서와 애플리케이션 소스 번들에 포함된 플랫폼 확장 파일을 Nginx 컨테이너 볼륨에 연결합니다. 그리고 애플리케이션 로드 밸런서 또는 네트워크 로드 밸런서에서 전달되는 트래픽은 Nginx 컨테이너로 경유하여 애플리케이션 컨테이너로 전달되므로 애플리케이션에 대한 포트는 호스트로 노출하지 않도록 하여 직접 접근이 불가능하도록 합니다.</p><h4 id="컨테이너-환경-변수"><a href="#컨테이너-환경-변수" class="headerlink" title="컨테이너 환경 변수"></a>컨테이너 환경 변수</h4><p>Beanstalk 콘솔에서 설정하는 환경 변수는 애플리케이션 소스 번들이 추출되는 &#x2F;var&#x2F;app&#x2F;current 경로에 .env 파일에 환경 변수가 정의됩니다. 그리고 이 파일을 도커 컨테이너의 환경 변수 참조 파일로 추가할 수 있습니다.</p><blockquote><p>도커 컴포즈 문서에 정의한 환경 변수가 우선 순위를 갖습니다. 도커 컴포즈 문서에 설정된 환경 변수를 Beanstalk 환경 변수로 설정하더라도 무시되니 주의하셔야합니다.</p></blockquote><h3 id="도커-레지스트리-서버-인증-파일"><a href="#도커-레지스트리-서버-인증-파일" class="headerlink" title="도커 레지스트리 서버 인증 파일"></a>도커 레지스트리 서버 인증 파일</h3><p>도커 레지스트리 서버에서 도커 이미지를 받아오기 위해서는 레지스트리 서버에 대한 인증 파일이 필요합니다. 만약, 기본 도커 레지스트리 서버인 도커 허브를 사용하는 것이 아니라 직접 구축한 도커 레지스트리 서버과 통신해야한다면 <strong>TLS 통신을 위한 인증서 파일이 필요</strong>합니다.</p><p>예를 들어, 도커 레지스트리 서버에 대한 인증서는 다음과 같이 참조하게 됩니다.</p><pre class="language-sh" data-language="sh"><code class="language-sh">&#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;         &lt;-- Certificate directory
└── registry.mambo.kr:5000   &lt;-- Hostname:port
    ├── client.cert          &lt;-- Client certificate
    ├── client.key           &lt;-- Client key
    └── ca.crt               &lt;-- Certificate authority that signed the registry certificate</code></pre><blockquote><p>윈도우와 MacOS 에서는 $USER&#x2F;.docker&#x2F;certs.d 입니다.</p></blockquote><p>도커 레지스트리 서버에 로그인하면 <strong>.dockercfg</strong> 파일에 크레덴셜 정보가 저장됩니다.</p><pre class="language-json" data-language="json"><div class="caption"><span>.dockercfg</span></div><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"https://registry.mambo.kr:5000"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"auth"</span><span class="token operator">:</span> <span class="token string">"[Base64]username:password"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre><p>윈도우 또는 Mac OS에서는 <strong>윈도우 자격 증명 관리자</strong> 또는 <strong>OSX Keychain</strong>에 크레덴셜을 저장할 수 있는데요. 이 경우에는 <strong>.dockercfg 또는 config.json</strong> 파일을 살펴보더라도 크레덴셜을 확인할 수 없습니다. 도커 로그인 시 사용되는 크레덴셜은 사용자 이름과 패스워드(username:password)를 <a target="_blank" rel="noopener" href="https://codebeautify.org/base64-encode">Base64로 인코딩</a>한 값이기 때문에 <strong>직접 Base64로 인코딩</strong>하고 위와 같이 <strong>도커 레지스트리 서버에 대한 .dockercfg를 정의</strong>하시기 바랍니다.</p><h3 id="환경-구성-파일"><a href="#환경-구성-파일" class="headerlink" title="환경 구성 파일"></a>환경 구성 파일</h3><p>도커 레지스트리 서버에 대한 인증서 파일들을 S3 버킷에서 가져오는 구성 파일을 정의합니다. 지난 <a href="../elastic-beanstalk-s3-auth">Elastic Beanstalk S3 Authentication</a>를 참고하여 다음과 같이 작성하였습니다.</p><pre class="language-yaml" data-language="yaml"><div class="caption"><span>.ebextensions/registry-cert.config</span></div><code class="language-yaml"><span class="token key atrule">Resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">AWSEBAutoScalingGroup</span><span class="token punctuation">:</span>
        <span class="token key atrule">Metadata</span><span class="token punctuation">:</span>
            <span class="token key atrule">AWS::CloudFormation::Authentication</span><span class="token punctuation">:</span>
                <span class="token key atrule">S3Auth</span><span class="token punctuation">:</span>
                    <span class="token key atrule">type</span><span class="token punctuation">:</span> S3
                    <span class="token key atrule">buckets</span><span class="token punctuation">:</span>
                        <span class="token punctuation">-</span> mambo<span class="token punctuation">-</span>cert
                    <span class="token key atrule">roleName</span><span class="token punctuation">:</span>
                        <span class="token key atrule">Fn::GetOptionSetting</span><span class="token punctuation">:</span>
                            <span class="token key atrule">Namespace</span><span class="token punctuation">:</span> aws<span class="token punctuation">:</span>autoscaling<span class="token punctuation">:</span>launchconfiguration
                            <span class="token key atrule">OptionName</span><span class="token punctuation">:</span> IamInstanceProfile
                            <span class="token key atrule">DefaultValue</span><span class="token punctuation">:</span> aws<span class="token punctuation">-</span>elasticbeanstalk<span class="token punctuation">-</span>ec2<span class="token punctuation">-</span>role
<span class="token key atrule">files</span><span class="token punctuation">:</span>
    <span class="token key atrule">"/etc/docker/certs.d/registry.mambo.kr:5000/client.cert"</span><span class="token punctuation">:</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">"000400"</span>
        <span class="token key atrule">owner</span><span class="token punctuation">:</span> root
        <span class="token key atrule">group</span><span class="token punctuation">:</span> root
        <span class="token key atrule">source</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//mambo<span class="token punctuation">-</span>cert.s3.ap<span class="token punctuation">-</span>northeast<span class="token punctuation">-</span>2.amazonaws.com/registry/client.cert
        <span class="token key atrule">authentication</span><span class="token punctuation">:</span> S3Auth
    <span class="token key atrule">"/etc/docker/certs.d/registry.mambo.kr:5000/client.key"</span><span class="token punctuation">:</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">"000400"</span>
        <span class="token key atrule">owner</span><span class="token punctuation">:</span> root
        <span class="token key atrule">group</span><span class="token punctuation">:</span> root
        <span class="token key atrule">source</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//mambo<span class="token punctuation">-</span>cert.s3.ap<span class="token punctuation">-</span>northeast<span class="token punctuation">-</span>2.amazonaws.com/registry/client.key
        <span class="token key atrule">authentication</span><span class="token punctuation">:</span> S3Auth
    <span class="token key atrule">"/etc/docker/certs.d/registry.mambo.kr:5000/ca.crt"</span><span class="token punctuation">:</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">"000400"</span>
        <span class="token key atrule">owner</span><span class="token punctuation">:</span> root
        <span class="token key atrule">group</span><span class="token punctuation">:</span> root
        <span class="token key atrule">source</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//mambo<span class="token punctuation">-</span>cert.s3.ap<span class="token punctuation">-</span>northeast<span class="token punctuation">-</span>2.amazonaws.com/registry/ca.crt
        <span class="token key atrule">authentication</span><span class="token punctuation">:</span> S3Auth

<span class="token key atrule">commands</span><span class="token punctuation">:</span>
    <span class="token key atrule">99-remove-bak</span><span class="token punctuation">:</span>
        <span class="token key atrule">cwd</span><span class="token punctuation">:</span> /etc/docker/certs.d/registry.mambo.kr<span class="token punctuation">:</span><span class="token number">5000</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span> rm <span class="token punctuation">-</span>f <span class="token important">*.bak</span></code></pre><h3 id="도커-구성-파일"><a href="#도커-구성-파일" class="headerlink" title="도커 구성 파일"></a>도커 구성 파일</h3><p>로컬 환경에서는 도커의 로그인 명령어를 사용하여 도커 레지스트리 서버에 인증하고 이미지를 등록하거나 가져올 수 있습니다. 그러나 Elastic Beanstalk 환경에서는 직접 로그인 명령어를 사용하는 것이 아니므로 도커에서 도커 레지스트리 서버에 대한 인증 파일을 사용할 수 있도록 앞서 알아본 <strong>.dockercfg</strong> 파일을 가져와야 합니다.</p><pre class="language-json" data-language="json"><div class="caption"><span>Dockerrun.aws.json</span></div><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"AWSEBDockerrunVersion"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span>
  <span class="token property">"Authentication"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"bucket"</span><span class="token operator">:</span> <span class="token string">"mambo-cert"</span><span class="token punctuation">,</span>
    <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"registry/.dockercfg"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre><p>도커 컴포즈 문서와 함께 애플리케이션 소스 번들에 포함되는 위 도커 구성 파일은 Dockerrun.aws.json v3을 사용하며 <strong>mambo-cert&#x2F;registry&#x2F;.dockercfg</strong> 파일을 <strong>&#x2F;root&#x2F;.docker&#x2F;config.json</strong>에 크레덴셜 정보를 복사합니다.</p><blockquote><p>EC2 인스턴스의 IAM Role이 S3 버킷에 대한 읽기 권한을 가져야합니다.</p></blockquote><h3 id="애플리케이션-소스-번들"><a href="#애플리케이션-소스-번들" class="headerlink" title="애플리케이션 소스 번들"></a>애플리케이션 소스 번들</h3><p>Elastic Beanstalk의 도커 플랫폼 환경에 배포할 애플리케이션 소스 번들에는 다음과 같은 파일들이 포함됩니다.</p><ul><li>docker-compose.yml</li><li>Dockerrun.aws.json</li><li>.platform</li><li>.ebextensions</li></ul><p>위 파일들을 <strong>zip 명령어로 애플리케이션 소스 번들 파일을 생성</strong>합니다.</p><pre class="language-sh" data-language="sh"><div class="caption"><span>Terminal</span></div><code class="language-sh">zip app-bundle.zip -r docker-compose.yml Dockerrun.aws.json .platform .ebextensions</code></pre><p>이제 애플리케이션 소스 번들 파일을 업로드하면 다음과 같이 Hello World가 표시되는 것을 확인할 수 있습니다.</p><p><img data-src="/images/posts/beanstalk-docker-platform/web.png"></p><p>이렇게해서 애플리케이션을 도커 이미지로 만들고 사설로 구축한 도커 레지스트리 서버에 등록된 이미지를 통해 Elastic Beanstalk의 도커 플랫폼을 활용하여 애플리케이션을 배포해보았습니다.</p><p>감사합니다.</p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Beanstalk/" rel="tag"># Beanstalk</a> <a href="/tags/Docker/" rel="tag"># Docker</a> <a href="/tags/Python/" rel="tag"># Python</a></div><div class="post-nav"><div class="post-nav-item"><a href="/ip-band-and-location-tracking/" rel="prev" title="IP 대역 그리고 위치추적"><i class="fa fa-chevron-left"></i> IP 대역 그리고 위치추적</a></div><div class="post-nav-item"><a href="/python-docker-image-optimization/" rel="next" title="파이썬 도커 이미지 최적화">파이썬 도커 이미지 최적화 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments"><script src="https://utteranc.es/client.js" repo="kdevkr/kdevkr.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Mambo</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a></div></div></footer><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script src="/js/third-party/fancybox.js"></script><script src="/js/third-party/pace.js"></script><script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script><script>var options={bottom:"unset",right:"15px",left:"unset",time:"0.5s",mixColor:"transparent",backgroundColor:"transparent",buttonColorDark:"#100f2c",buttonColorLight:"#fff",saveInCookies:!0,label:"🌗",autoMatchOsTheme:!0};const darkmode=new Darkmode(options);window.darkmode=darkmode,darkmode.showWidget()</script></body></html>