<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png"><link rel="mask-icon" href="/images/favicon/favicon.ico" color="#222"><meta name="google-site-verification" content="LMcddVW6xLBS7X1htGQ3duOIEmVp4ljku8sd3UuIcBg"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Sans+KR:300,300italic,400,400italic,700,700italic%7CPretendard-Bold:300,300italic,400,400italic,700,700italic%7CPretendard-Medium:300,300italic,400,400italic,700,700italic%7CJetbrains+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-loading-bar.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"kdevkr.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.13.2","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"width":240,"scrollpercent":true,"b2t":true},"copycode":{"enable":false,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script><meta name="description" content="본 글은 에너지 분야에서 수요 반응(DR) 이벤트를 송수신하기 위해서 사용하는 OpenADR 프로토콜에서 VTN과 VEN이 서로 상호 인증(Mutual Authentication)을 수행하는 구조를 이해하기 위해 정리한 것입니다.  Mutual AuthenticationClient certificates must be used for HTTP client"><meta property="og:type" content="article"><meta property="og:title" content="Mutual TLS"><meta property="og:url" content="https://kdevkr.github.io/mutual-tls/index.html"><meta property="og:site_name" content="Mambo"><meta property="og:description" content="본 글은 에너지 분야에서 수요 반응(DR) 이벤트를 송수신하기 위해서 사용하는 OpenADR 프로토콜에서 VTN과 VEN이 서로 상호 인증(Mutual Authentication)을 수행하는 구조를 이해하기 위해 정리한 것입니다.  Mutual AuthenticationClient certificates must be used for HTTP client"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2022-07-12T15:00:00.000Z"><meta property="article:modified_time" content="2023-12-02T14:52:11.015Z"><meta property="article:author" content="Mambo"><meta property="article:tag" content="X.509"><meta property="article:tag" content="mTLS"><meta property="article:tag" content="X-SSL-CERT"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://kdevkr.github.io/mutual-tls/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://kdevkr.github.io/mutual-tls/","path":"mutual-tls/","title":"Mutual TLS"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Mutual TLS | Mambo</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-V8LF04VMBF"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-V8LF04VMBF","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="Mambo" type="application/atom+xml">
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope itemtype="http://schema.org/WebPage"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Mambo</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Today I Learned 🔥</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fas fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fas fa-archive fa-fw"></i>Archives<span class="badge">109</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fas fa-user fa-fw"></i>About</a></li></ul></nav></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Mutual-Authentication"><span class="nav-number">1.</span> <span class="nav-text">Mutual Authentication</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#X-509-Client-Certificate"><span class="nav-number">1.1.</span> <span class="nav-text">X.509 Client Certificate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#X-509-Client-Certificate-Proxy"><span class="nav-number">1.2.</span> <span class="nav-text">X.509 Client Certificate Proxy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EC%B0%B8%EA%B3%A0"><span class="nav-number">2.</span> <span class="nav-text">참고</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Mambo" src="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4"><p class="site-author-name" itemprop="name">Mambo</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">109</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-tags"><span class="site-state-item-count">164</span> <span class="site-state-item-name">tags</span></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/kdevkr" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kdevkr" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:kdevkr@gmail.com" title="E-Mail → mailto:kdevkr@gmail.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a></span></div><div class="cc-license site-overview-item animated" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ko" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div><div class="back-to-top animated" role="button" aria-label="Back to top"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div class="sidebar-dimmer"></div></header><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://kdevkr.github.io/mutual-tls/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4"><meta itemprop="name" content="Mambo"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Mambo"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Mutual TLS | Mambo"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Mutual TLS</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2022-07-13 00:00:00" itemprop="dateCreated datePublished" datetime="2022-07-13T00:00:00+09:00">2022-07-13</time></span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>본 글은 에너지 분야에서 수요 반응(DR) 이벤트를 송수신하기 위해서 사용하는 <a target="_blank" rel="noopener" href="https://www.openadr.org/">OpenADR 프로토콜</a>에서 VTN과 VEN이 서로 상호 인증(Mutual Authentication)을 수행하는 구조를 이해하기 위해 정리한 것입니다.</p></blockquote><h2 id="Mutual-Authentication"><a href="#Mutual-Authentication" class="headerlink" title="Mutual Authentication"></a>Mutual Authentication</h2><p><em>Client certificates must be used for HTTP client authentication. The entity initiating the request(the client) must have an X.509 certificate that is validated by the server during the TLS handshake. If no client certificate is supplied, or if the certificate is not valid (e.g., it is not signed by a trusted CA, or it is expired) the server must terminate the connection during the TLS handshake.</em></p><p>OpenADR 프로토콜에서 VTN 시스템과 VEN 디바이스 간 통신을 위해서는 HTTP 또는 XMPP를 이용해야합니다. HTTP 클라이언트 통신을 위해서는 VTN과 VEN은 서로를 신뢰할 수 있는 X.509 공개키 인증서를 제공해야합니다. 클라이언트 요청에 서버가 신뢰할 수 있는 기관으로부터 서명된 X.509 인증서가 포함되지 않으면 서버 시스템에서는 TLS 핸드쉐이크 과정에서 연결을 해지할 수 있습니다.</p><h3 id="X-509-Client-Certificate"><a href="#X-509-Client-Certificate" class="headerlink" title="X.509 Client Certificate"></a>X.509 Client Certificate</h3><p>OpenADR 프로토콜에서의 보안은 공개키 기반 인프라(PKI)의 X.509 인증서로 수행하며 더 높은 보안 레벨을 요구하는 시스템을 구성하고 싶다면 XML 페이로드에 대한 서명을 지원할 수 있습니다. 2048 비트 이상의 RSA 또는 256 비트 이상의 ECC 키 기반의 공개키 인증서를 사용할 수 있습니다. 일반적으로 VEN은 임베디드 디바이스이므로 RSA 보다는 ECC 키 기반의 인증서를 사용하는 것이 더 효율적일 수 있습니다. OpenADR 프로토콜에서 TLS 핸드쉐이크 과정에서 최소한 TLS 1.2 버전과 함께 그에 상응하는 암호화 스위트를 사용해야합니다.</p><ul><li>Transport Layer Security: TLS 1.2+</li><li>Cipher Suites: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_RSA_WITH_AES_128_CBC_SHA256</li></ul><h4 id="cURL"><a href="#cURL" class="headerlink" title="cURL"></a>cURL</h4><p>리눅스 시스템에서 주로 사용되는 HTTP 클라이언트 통신 도구인 <a target="_blank" rel="noopener" href="https://curl.se/">cURL</a>를 사용해서 EiRegisterParty 서비스 엔드포인트에 대해 요청하면 VTN 과의 상호 TLS 핸드쉐이크 과정을 정상적으로 수행할 수 있는지 검증할 수 있습니다. <a target="_blank" rel="noopener" href="https://downey.io/notes/dev/curl-using-mutual-tls/">how to curl an endpoint protected by mutual tls (mtls)</a>에서는 cURL로 클라이언트 인증서를 포함하는 방법을 소개하고 있어 다음과 같이 명령어를 실행하면 됩니다.</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -v --tlsv1.2 --tls-max 1.3 --cert ./cert.pem --key ./privkey.pem https://Host/OpenADR2/Simple/2.0b/EiRegisterParty</span><br></pre></td></tr></table></figure><h4 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h4><p>웹 애플리케이션 서버 뿐만 아니라 VEN 디바이스를 구현하는 가장 일반적인 방법은 자바 언어로 구현하는 것입니다. 자바 애플리케이션에서는 KeyStore라는 별도의 키 저장소 클래스를 제공하므로 HTTP 클라이언트 요청 시 X.509 클라이언트 인증서를 포함시키기 위해서는 PKI 및 PKCS 표준에 대한 일련의 클래스들을 알아야합니다. X.509 클라이언트 인증서는 PEM 형식으로 교환되므로 KeyStore로 변환하는 과정이 필요할 수 있습니다. 다음은 <a target="_blank" rel="noopener" href="https://www.bouncycastle.org/java.html">BouncyCastle API</a> 자바 라이브러리를 통해서 X.509 인증서와 개인키를 불러와서 HTTP 클라이언트 요청을 시도하는 코드를 보여줍니다.</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MutualTlsTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(MutualTlsTest.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getClassLoader();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DisplayName(&quot;Test mutual authentication&quot;)</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testMutualAuthentication</span><span class="params">()</span> &#123;</span><br><span class="line">        Assertions.assertDoesNotThrow(() -&gt; &#123;</span><br><span class="line">            System.setProperty(<span class="string">&quot;javax.net.debug&quot;</span>, <span class="string">&quot;ssl&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">certPemText</span> <span class="operator">=</span> IOUtils.toString(classLoader.getResourceAsStream(<span class="string">&quot;cert.pem&quot;</span>), StandardCharsets.UTF_8);</span><br><span class="line">            <span class="type">String</span> <span class="variable">privateKeyText</span> <span class="operator">=</span> IOUtils.toString(classLoader.getResourceAsStream(<span class="string">&quot;privkey.pem&quot;</span>), StandardCharsets.UTF_8);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">byte</span>[] certPem = <span class="keyword">new</span> <span class="title class_">PemReader</span>(<span class="keyword">new</span> <span class="title class_">StringReader</span>(certPemText)).readPemObject().getContent();</span><br><span class="line">            <span class="keyword">final</span> <span class="type">byte</span>[] privateKey = <span class="keyword">new</span> <span class="title class_">PemReader</span>(<span class="keyword">new</span> <span class="title class_">StringReader</span>(privateKeyText)).readPemObject().getContent();</span><br><span class="line"></span><br><span class="line">            <span class="type">KeyStore</span> <span class="variable">clientKeyStore</span> <span class="operator">=</span> KeyStore.getInstance(<span class="string">&quot;jks&quot;</span>);</span><br><span class="line">            clientKeyStore.load(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">Certificate</span>&gt; chain = CertificateFactory.getInstance(<span class="string">&quot;X.509&quot;</span>).generateCertificates(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(certPem));</span><br><span class="line">            <span class="keyword">final</span> <span class="type">char</span>[] password = <span class="keyword">new</span> <span class="title class_">SecureRandom</span>().toString().toCharArray();</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Key</span> <span class="variable">key</span> <span class="operator">=</span> KeyFactory.getInstance(<span class="string">&quot;RSA&quot;</span>).generatePrivate(<span class="keyword">new</span> <span class="title class_">PKCS8EncodedKeySpec</span>(privateKey));</span><br><span class="line">            clientKeyStore.setKeyEntry(<span class="string">&quot;client&quot;</span>, key, password, chain.toArray(<span class="keyword">new</span> <span class="title class_">Certificate</span>[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">            <span class="type">KeyManagerFactory</span> <span class="variable">keyManagerFactory</span> <span class="operator">=</span> KeyManagerFactory.getInstance(<span class="string">&quot;SunX509&quot;</span>);</span><br><span class="line">            keyManagerFactory.init(clientKeyStore, password);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> If server generate client certificate from self-signed root CA, you can use trustKeyStore.</span></span><br><span class="line">            <span class="type">KeyStore</span> <span class="variable">trustKeyStore</span> <span class="operator">=</span> KeyStore.getInstance(<span class="string">&quot;jks&quot;</span>);</span><br><span class="line">            trustKeyStore.load(classLoader.getResourceAsStream(<span class="string">&quot;ca.jks&quot;</span>), <span class="string">&quot;password&quot;</span>.toCharArray());</span><br><span class="line">            <span class="type">TrustManagerFactory</span> <span class="variable">trustManagerFactory</span> <span class="operator">=</span> TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());</span><br><span class="line">            trustManagerFactory.init(trustKeyStore);</span><br><span class="line"></span><br><span class="line">            <span class="type">SSLContext</span> <span class="variable">sslcontext</span> <span class="operator">=</span> SSLContexts.custom().loadTrustMaterial(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">TrustAllStrategy</span>()).build();</span><br><span class="line">            sslcontext.init(keyManagerFactory.getKeyManagers(), trustManagerFactory.getTrustManagers(), <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            String[] tlsVersions = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;TLSv1.2&quot;</span>,<span class="string">&quot;TLSv1.3&quot;</span>&#125;;</span><br><span class="line">            String[] cipherSuites = SSLContext.getDefault().getDefaultSSLParameters().getCipherSuites();</span><br><span class="line">            <span class="type">SSLConnectionSocketFactory</span> <span class="variable">sslSocketFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SSLConnectionSocketFactory</span>(sslcontext, tlsVersions, cipherSuites, <span class="keyword">new</span> <span class="title class_">NoopHostnameVerifier</span>());</span><br><span class="line"></span><br><span class="line">            <span class="type">CloseableHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> HttpClientBuilder.create().setSSLSocketFactory(sslSocketFactory).build();</span><br><span class="line"></span><br><span class="line">            <span class="type">HttpPost</span> <span class="variable">httpPost</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpPost</span>(<span class="string">&quot;https://Host/OpenADR2/Simple/2.0b/EiRegisterParty&quot;</span>);</span><br><span class="line">            httpPost.addHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/xml; charset=UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> IOUtils.toString(classLoader.getResourceAsStream(<span class="string">&quot;payload.xml&quot;</span>), StandardCharsets.UTF_8);</span><br><span class="line">            httpPost.setEntity(<span class="keyword">new</span> <span class="title class_">StringEntity</span>(payload));</span><br><span class="line"></span><br><span class="line">            <span class="type">CloseableHttpResponse</span> <span class="variable">httpResponse</span> <span class="operator">=</span> client.execute(httpPost);</span><br><span class="line">            <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> EntityUtils.toString(httpResponse.getEntity(), StandardCharsets.UTF_8);</span><br><span class="line">            Assertions.assertNotNull(response);</span><br><span class="line">            Assertions.assertTrue(response.startsWith(<span class="string">&quot;&lt;?xml&quot;</span>));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Go"><a href="#Go" class="headerlink" title="Go"></a>Go</h4><p>개인적으로 학습중인 Go 언어에서 HTTP 클라이언트 요청과 함께 X.509 클라이언트 인증서를 포함시키는 방법을 찾아보았습니다. <a target="_blank" rel="noopener" href="https://venilnoronha.io/a-step-by-step-guide-to-mtls-in-go">A step by step guide to mTLS in Go</a>에 잘 설명되어있으므로 다음과 같이 간단하게 테스트해볼 수 있습니다.</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/tls&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/x509&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cert, err := tls.LoadX509KeyPair(<span class="string">&quot;cert.pem&quot;</span>, <span class="string">&quot;privkey.pem&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	caCert, err := ioutil.ReadFile(<span class="string">&quot;ca.pem&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	caCertPool := x509.NewCertPool()</span><br><span class="line">	caCertPool.AppendCertsFromPEM(caCert)</span><br><span class="line"></span><br><span class="line">	client := &amp;http.Client&#123;</span><br><span class="line">		Transport: &amp;http.Transport&#123;</span><br><span class="line">			TLSClientConfig: &amp;tls.Config&#123;</span><br><span class="line">				ClientAuth:   tls.RequireAndVerifyClientCert,</span><br><span class="line">				ClientCAs:    caCertPool,</span><br><span class="line">				Certificates: []tls.Certificate&#123;cert&#125;,</span><br><span class="line">				MinVersion:   tls.VersionTLS12,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	payloadXml, err := os.Open(<span class="string">&quot;payload.xml&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> payloadXml.Close()</span><br><span class="line"></span><br><span class="line">	payload, _ := ioutil.ReadAll(payloadXml)</span><br><span class="line">	r, err := client.Post(<span class="string">&quot;https://Host/OpenADR2/Simple/2.0b/EiRegisterParty&quot;</span>, <span class="string">&quot;application/xml&quot;</span>, strings.NewReader(<span class="type">string</span>(payload)))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> r.Body.Close()</span><br><span class="line">	body, err := ioutil.ReadAll(r.Body)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, body)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="X-509-Client-Certificate-Proxy"><a href="#X-509-Client-Certificate-Proxy" class="headerlink" title="X.509 Client Certificate Proxy"></a>X.509 Client Certificate Proxy</h3><p>오늘날의 인프라 시스템은 애플리케이션 서버 정보를 감추고 클라이언트 요청에 대해 전처리 동작을 수행하고 넘겨주는 리버스 프록시를 구성하는 것이 일반적입니다. 리버스 프록시는 Nginx와 같은 웹 서버 또는 로드밸런서에서 지원하며 이러한 리버스 프록시를 수행하는 인프라 구성에서는 클라이언트 요청에 대한 TLS 핸드쉐이크 과정에서 전달된 클라이언트 인증서를 별도의 프록시 헤더에 포함시켜 넘겨주어야합니다.</p><h4 id="X-SSL-CERT"><a href="#X-SSL-CERT" class="headerlink" title="X-SSL-CERT"></a>X-SSL-CERT</h4><p>일반적으로 클라이언트 인증서에 대한 프록시 헤더의 표준은 없으므로 X-SSL-CERT와 같이 애플리케이션 서버에서 읽을 수 있는 헤더를 정하여 클라이언트 인증서를 포함시켜 전달하도록 구성하면 됩니다. 다음은 Nginx에서의 리버스 프록시 구성 시 X-SSL-CERT 헤더에 클라이언트 인증서를 포함시키는 예시입니다.</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    ssl_verify_client optional_no_ca;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_set_header X-SSL-CERT $ssl_client_escaped_cert;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>일반적으로 mTLS를 수행할 때 전달되는 클라이언트 인증서도 신뢰할 수 있는 인증 기관에서 발급된 것인지를 판단합니다. 시스템 자체적으로 서명한 클라이언트 인증서는 신뢰할 수 없으므로 클라이언트 인증서의 검증은 애플리케이션 서버로 위임할 수 있습니다.</p></blockquote><h4 id="Webpack-Certificate-Proxy"><a href="#Webpack-Certificate-Proxy" class="headerlink" title="Webpack Certificate Proxy"></a>Webpack Certificate Proxy</h4><p>일반적으로 프론트엔드 개발을 위해서 사용하는 Webpack에서는 자체적으로 프록시 구성을 지원하는 <a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-server">webpack-dev-server</a>를 제공합니다. 이는 리버스 프록시 구성과 동일하므로 모든 요청에 대해서 Webpack 프록시 서버를 경유하도록 한다면 다음과 같이 클라이언트 인증서를 포함할 수 있도록 설정해야합니다.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">devServer</span>: &#123;</span><br><span class="line">        <span class="attr">server</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;spdy&#x27;</span>, <span class="comment">// https</span></span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">                <span class="attr">cert</span>: fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;cert.pem&#x27;</span>),</span><br><span class="line">                <span class="attr">key</span>: fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;privkey.pem&#x27;</span>),</span><br><span class="line">                <span class="attr">requestCert</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">rejectUnauthorized</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">minVersion</span>: <span class="string">&#x27;TLSv1.2&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">proxy</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;/&#x27;</span>: &#123;</span><br><span class="line">                <span class="attr">target</span>: <span class="string">&#x27;http://127.0.0.1:5000&#x27;</span>,</span><br><span class="line">                <span class="attr">secure</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">xfwd</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">rejectUnauthorized</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="title function_">onProxyReq</span>(<span class="params">proxyReq, req, res</span>) &#123;</span><br><span class="line">                    <span class="keyword">const</span> cert = req.<span class="property">socket</span>.<span class="title function_">getPeerCertificate</span>();</span><br><span class="line">                    <span class="keyword">if</span> (cert &amp;&amp; cert.<span class="property">raw</span>) &#123;</span><br><span class="line">                        <span class="keyword">const</span> pem = <span class="string">&#x27;-----BEGIN CERTIFICATE-----&#x27;</span> + cert.<span class="property">raw</span>.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>) + <span class="string">&#x27;-----END CERTIFICATE-----&#x27;</span>;</span><br><span class="line">                        proxyReq.<span class="title function_">setHeader</span>(<span class="string">&#x27;X-SSL-CERT&#x27;</span>, pem)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>requestCert 옵션을 켜야 onProxyReq 함수내에서 클라이언트 인증서를 가져와서 전달할 수 있습니다.</p></blockquote><h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul><li><a target="_blank" rel="noopener" href="https://www.cloudflare.com/ko-kr/learning/access-management/what-is-mutual-authentication/">What protocols support mutual authentication?</a></li><li><a target="_blank" rel="noopener" href="https://www.cloudflare.com/ko-kr/learning/access-management/what-is-mutual-tls/">What is mutual TLS (mTLS)?</a></li><li><a target="_blank" rel="noopener" href="https://downey.io/notes/dev/curl-using-mutual-tls/">how to curl an endpoint protected by mutual tls (mtls)</a></li><li><a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html#var_ssl_client_escaped_cert">Nginx SSL Client Cert</a></li><li><a target="_blank" rel="noopener" href="https://webpack.js.org/configuration/dev-server/#devserverserver">Webpack DevServer.server</a></li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/X-509/" rel="tag"># X.509</a> <a href="/tags/mTLS/" rel="tag"># mTLS</a> <a href="/tags/X-SSL-CERT/" rel="tag"># X-SSL-CERT</a></div><div class="post-nav"><div class="post-nav-item"><a href="/sha-256/" rel="prev" title="SHA-256"><i class="fa fa-chevron-left"></i> SHA-256</a></div><div class="post-nav-item"><a href="/pki/" rel="next" title="PKI(Public Key Infrastructure)">PKI(Public Key Infrastructure) <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments giscus-container"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Mambo</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script src="/js/third-party/fancybox.js"></script><script src="/js/third-party/pace.js"></script><script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script><script>var options={bottom:"unset",right:"15px",left:"unset",time:"0.5s",mixColor:"transparent",backgroundColor:"transparent",buttonColorDark:"#100f2c",buttonColorLight:"#fff",saveInCookies:!0,label:"🌗",autoMatchOsTheme:!0};const darkmode=new Darkmode(options);window.darkmode=darkmode,darkmode.showWidget()</script><script class="next-config" data-name="giscus" type="application/json">{"enable":true,"repo":"kdevkr/kdevkr.github.io","repo_id":"MDEwOlJlcG9zaXRvcnkxNTQxNjA4OTA=","category":"Announcements","category_id":"DIC_kwDOCTBO-s4CYmQM","mapping":"pathname","reactions_enabled":1,"emit_metadata":1,"theme":"light","lang":"ko","crossorigin":"anonymous","input_position":"bottom","loading":"lazy"}</script><script>document.addEventListener("page:loaded",()=>{CONFIG.page.comments&&NexT.utils.loadComments(".giscus-container").then(()=>NexT.utils.getScript("https://giscus.app/client.js",{attributes:{async:!0,crossOrigin:"anonymous","data-repo":CONFIG.giscus.repo,"data-repo-id":CONFIG.giscus.repo_id,"data-category":CONFIG.giscus.category,"data-category-id":CONFIG.giscus.category_id,"data-mapping":CONFIG.giscus.mapping,"data-reactions-enabled":CONFIG.giscus.reactions_enabled,"data-emit-metadata":CONFIG.giscus.emit_metadata,"data-theme":CONFIG.giscus.theme,"data-lang":CONFIG.giscus.lang,"data-input-position":CONFIG.giscus.input_position,"data-loading":CONFIG.giscus.loading},parentNode:document.querySelector(".giscus-container")}))})</script></body></html>