<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,700,700italic|Binggrae-Bold:300,300italic,400,400italic,700,700italic|yg-jalnan:300,300italic,400,400italic,700,700italic|Noto Sans KR:300,300italic,400,400italic,700,700italic|Jetbrains Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css">
  <script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"kdevkr.github.io","root":"/","scheme":"Gemini","version":"8.0.0-rc.3","exturl":false,"sidebar":{"position":"left","width":240,"display":"hide","scrollpercent":true,"b2t":true,"padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="잠만보의 개발 블로그">
<meta property="og:url" content="https://kdevkr.github.io/page/3/index.html">
<meta property="og:site_name" content="잠만보의 개발 블로그">
<meta property="og:locale" content="ko_KR">
<meta property="article:author" content="Mambo">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://kdevkr.github.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'ko'
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <title>잠만보의 개발 블로그</title>
  
    <script>
      function sendPageView() {
        if (CONFIG.hostname !== location.hostname) return;
        var uid = localStorage.getItem('uid') || (Math.random() + '.' + Math.random());
        localStorage.setItem('uid', uid);
        navigator.sendBeacon('https://www.google-analytics.com/collect', new URLSearchParams({
          v  : 1,
          tid: 'UA-93954323-1',
          cid: uid,
          t  : 'pageview',
          dp : encodeURIComponent(location.pathname)
        }));
      }
      document.addEventListener('pjax:complete', sendPageView);
      sendPageView();
    </script>






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before, .use-motion .logo-line-after {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

<link rel="alternate" href="/atom.xml" title="잠만보의 개발 블로그" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line toggle-line-first"></span>
        <span class="toggle-line toggle-line-middle"></span>
        <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line-before"></i>
      <h1 class="site-title">잠만보의 개발 블로그</h1>
      <i class="logo-line-after"></i>
    </a>
      <p class="site-subtitle" itemprop="description">잠만보가 알려주는 개발 이야기</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fas fa-home fa-fw"></i>홈</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fas fa-archive fa-fw"></i>아카이브<span class="badge">32</span></a>

  </li>
        <li class="menu-item menu-item-spring">

    <a href="/spring" rel="section"><i class="fas fa-seedling fa-fw"></i>Spring</a>

  </li>
        <li class="menu-item menu-item-vue.js">

    <a href="/vuejs" rel="section"><i class="fab fa-vuejs fa-fw"></i>Vue.js</a>

  </li>
        <li class="menu-item menu-item-postgresql">

    <a href="/database/postgresql" rel="section"><i class="fas fa-database fa-fw"></i>PostgreSQL</a>

  </li>
        <li class="menu-item menu-item-kdb+">

    <a href="/database/kdb" rel="section"><i class="fas fa-database fa-fw"></i>KDB+</a>

  </li>
        <li class="menu-item menu-item-docker">

    <a href="/dev-ops/docker" rel="section"><i class="fab fa-docker fa-fw"></i>Docker</a>

  </li>
        <li class="menu-item menu-item-kubernetes">

    <a href="/dev-ops/kubernetes" rel="section"><i class="fas fa-dharmachakra fa-fw"></i>kubernetes</a>

  </li>
        
            
  <li class="menu-item menu-item-꾸르팁">

    <a href="/tips/" rel="section"><i class="far fa-grin-tongue-wink fa-fw"></i>꾸르팁</a>

  </li>


      
        <li class="menu-item menu-item-소개">

    <a href="/about/" rel="section"><i class="fas fa-user fa-fw"></i>소개</a>

  </li>
  </ul>
</nav>




</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          목차
        </li>
        <li class="sidebar-nav-overview">
          흝어보기
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mambo"
      src="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4">
  <p class="site-author-name" itemprop="name">Mambo</p>
  <div class="site-description" itemprop="description"></div>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/kdevkr" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kdevkr" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:kdevkr@gmail.com" title="E-Mail → mailto:kdevkr@gmail.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ko" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <div class="reading-progress-bar"></div>


      <div class="main-inner">
        

        <div class="content index posts-expand">
          
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="ko">
    <link itemprop="mainEntityOfPage" href="https://kdevkr.github.io/spring/spring-boot-2.0-migration-from-1.5.4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4">
      <meta itemprop="name" content="Mambo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="잠만보의 개발 블로그">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/spring/spring-boot-2.0-migration-from-1.5.4/" class="post-title-link" itemprop="url">스프링 부트 1.5.4에서 2.0으로 마이그레이션 하기</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">작성일</span>

              <time title="Post created: 2020-01-21 00:00:00" itemprop="dateCreated datePublished" datetime="2020-01-21T00:00:00Z">2020-01-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%EA%B0%9C%EB%B0%9C-%EC%9D%B4%EC%95%BC%EA%B8%B0/" itemprop="url" rel="index"><span itemprop="name">개발 이야기</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="들어가며">들어가며</h2>
<p>현재 개발중인 프로젝트에서 JVM 기반으로 ES6 기반의 자바스크립트를 실행해야하는 요구사항이 있어 이를 지원하는 JDK 9 이상으로 자바 버전을 올려야하는 상황이 발생하였습니다. 😑</p>
<blockquote>
<p><a href="https://www.oracle.com/corporate/features/nashorn-javascript-engine-jdk9.html" target="_blank" rel="noopener">Nashorn JavaScript Engine in JDK 9</a>에서 ES6 지원을 확인할 수 있습니다.</p>
<p>좀 더 알아보니 OpenJDK에서는 Jashorn 엔진을 제외한다고 명시했습니다.<br>
- <a href="https://openjdk.java.net/jeps/335" target="_blank" rel="noopener">https://openjdk.java.net/jeps/335</a><br>
나중에는 <a href="https://github.com/graalvm/graaljs" target="_blank" rel="noopener">GraalVM의 GraalJS</a> 쪽으로 선회하는 방법이 좋겠습니다.</p>
</blockquote>
<h3 id="스프링-버전별-JDK-지원">스프링 버전별 JDK 지원</h3>
<p>일단 애플리케이션의 기반이 되는 스프링 부트 프레임워크의 버전별 JDK 지원 목록을 확인해야했습니다. JDK 9+를 사용해야하므로 최소한으로 지원하는 버전을 찾아야합니다.</p>
<p>다음은 제가 확인한 버전별 JDK 지원 현황입니다.</p>
<table>
<thead>
<tr>
<th>Spring Boot Version</th>
<th>JDK</th>
<th>Compatible</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.5.9.RELEASE</td>
<td>Java 7</td>
<td>or Java 8</td>
</tr>
<tr>
<td>2.0.0.RELEASE</td>
<td>Java 8</td>
<td>or Java 9</td>
</tr>
<tr>
<td>2.1.1.RELEASE</td>
<td>Java 8</td>
<td>is compatible up to Java 11</td>
</tr>
<tr>
<td>2.1.7.RELEASE</td>
<td>Java 8</td>
<td>is compatible up to Java 12</td>
</tr>
<tr>
<td>2.2.0.RELEASE</td>
<td>Java 8</td>
<td>is compatible up to Java 13</td>
</tr>
</tbody>
</table>
<p>그렇다면 제 경우에는 최소한 스프링 부트 2.0.0.RELEASE로 버전을 업그레이드해야하는 상황이 생깁니다. 😱</p>
<blockquote>
<p><a href="https://github.com/spring-projects/spring-boot/releases" target="_blank" rel="noopener">GA 릴리즈</a> 버전이 <code>2.1.12.RELEASE</code>와 <code>2.2.3.RELEASE</code>이 있으므로 이중에 선택하면 될것 같습니다.</p>
</blockquote>
<h2 id="마이그레이션-시작하기">마이그레이션 시작하기</h2>
<p>마이그레이션은 <code>gradle</code>, <code>spring-boot</code>, <code>jdk</code> 세가지 영역으로 나누어 진행했습니다.</p>
<h3 id="Gradle-✅">Gradle ✅</h3>
<p>먼저 진행한 영역은 Gradle입니다.</p>
<p>원래 사용하던 Gradle 버전은 3.5.1이었는데 <a href="https://docs.spring.io/spring-boot/docs/2.0.x/reference/htmlsingle/#build-tool-plugins-gradle-plugin" target="_blank" rel="noopener">스프링 부트 2.X의 Gradle 지원 버전</a>은 4.0+ 입니다.</p>
<h4 id="Gradle-버전-업그레이드">Gradle 버전 업그레이드</h4>
<p>gradle 명령 또는 버전을 명시해서 버전을 업그레이드 할 수 있습니다.</p>
<p>업그레이드할 Gradle 버전은 <code>5.6.4</code>입니다.<br>
<a href="https://docs.gradle.org/5.6.4/release-notes.html" target="_blank" rel="noopener">Gradle 릴리즈 노트</a>에 따르면 그루비 컴파일 속도가 빨라졌다고하여 4.10.3이 아닌 5.6.4로 결정하였습니다.</p>
<blockquote>
<p>추후 문제가 발생하여 최종적으로는 6.1로 다시 업그레이드했습니다.<br>
이에 대한 내용은 문제가 발생한 곳에서 설명하겠습니다.</p>
</blockquote>
<p><strong>gradlew</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#gradle wrapper --gradle-version 5.6.4</span></span><br><span class="line">gradlew wrapper --gradle-version 5.6.4</span><br></pre></td></tr></table></figure>
<p><strong>gradle-wrapper.properties</strong></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#distributionUrl=https\://services.gradle.org/distributions/gradle-3.5.1-all.zip</span></span><br><span class="line"><span class="attr">distributionUrl</span>=<span class="string">https\://services.gradle.org/distributions/gradle-5.6.4-all.zip</span></span><br><span class="line"><span class="comment">#distributionUrl=https\://services.gradle.org/distributions/gradle-6.1-all.zip</span></span><br></pre></td></tr></table></figure>
<h5 id="인텔리제이-Gradle-플러그인-충돌-⚠️">인텔리제이 Gradle 플러그인 충돌 ⚠️</h5>
<p>인텔리제이 버전에서 Gradle Wrapper 버전을 올린 후 자체 Gradle 플러그인 버전과 충돌되는 문제가 있었습니다.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">org.jetbrains.plugins.gradle.tooling.util.ModuleComponentIdentifierImpl.getModuleIdentifier()</span><br></pre></td></tr></table></figure>
<p><a href="http://www.jetbrains.org/intellij/sdk/docs/basics/getting_started/build_number_ranges.html" target="_blank" rel="noopener">Intellij Platform SDK DevGuide / Build Number Ranges</a>에서 192와 193 브랜치를 확인해보니 <a href="https://github.com/JetBrains/intellij-community/blob/192/build/dependencies/gradle/wrapper/gradle-wrapper.properties" target="_blank" rel="noopener">192</a>에서는 Gradle Wrapper가 4.10-all이고 <a href="https://github.com/JetBrains/intellij-community/blob/193/build/dependencies/gradle/wrapper/gradle-wrapper.properties" target="_blank" rel="noopener">193</a>에서 5.5-all로 변경되었습니다.</p>
<blockquote>
<p>자체 Gradle Wrapper가 아닌 자체 Gradle 버전을 바라보는 것은 무슨 문제일까요?<br>
이로 인해, 인텔리제이 커뮤니티 버전을 사용하는 분들께는 버전 업그레이드를 권고해드렸습니다.</p>
</blockquote>
<h5 id="Lombok-Plugin">Lombok Plugin</h5>
<p>Gradle 5+부터는 빌드를 위해 <code>롬복</code> 플러그인을 사용하거나 <code>annotationProcessor</code>를 사용해야 합니다.</p>
<blockquote>
<p><a href="https://projectlombok.org/setup/gradle" target="_blank" rel="noopener">https://projectlombok.org/setup/gradle</a></p>
</blockquote>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath(<span class="string">"io.freefair.gradle:lombok-plugin:4.1.6"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">"io.freefair.lombok"</span></span><br></pre></td></tr></table></figure>
<p>또는 직접 명시</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    compileOnly(<span class="string">'org.projectlombok:lombok'</span>)</span><br><span class="line">    annotationProcessor(<span class="string">'org.projectlombok:lombok'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Gradle 버전을 업그레이드하여도 빌드 및 구동이 정상적으로 되니 다음 영역으로 넘어가겠습니다.</p>
<h3 id="Spring-Boot-✅">Spring Boot ✅</h3>
<p>이제 대망의 스프링 부트 프레임워크의 버전을 업그레이드할 차례입니다.</p>
<p>두근두근 🤪</p>
<blockquote>
<p>자 이제 시작이야. 내꿈을, 내꿈을 위한 여행. XXX.<br>
찾아라 비밀의 열쇠, 미로같이 얽힌 모험들</p>
</blockquote>
<h4 id="기존-애플리케이션-검토">기존 애플리케이션 검토</h4>
<p>먼저 기존 애플리케이션의 의존성을 간단하게 검토해보았습니다.</p>
<table>
<thead>
<tr>
<th>이름</th>
<th>버전</th>
<th>비고</th>
</tr>
</thead>
<tbody>
<tr>
<td>JDK</td>
<td>1.8</td>
<td>jdk8u232-b09</td>
</tr>
<tr>
<td>Gradle</td>
<td><s>3.5.1</s> 5.6.4</td>
<td></td>
</tr>
<tr>
<td>Spring Boot</td>
<td>1.5.4</td>
<td></td>
</tr>
<tr>
<td>Spring</td>
<td>4.3.7</td>
<td></td>
</tr>
<tr>
<td>Embed Tomcat</td>
<td>8.5.47</td>
<td></td>
</tr>
<tr>
<td>org.springframework.boot:spring-boot-gradle-plugin</td>
<td>1.5.7.RELEASE</td>
<td></td>
</tr>
<tr>
<td>io.spring.gradle:dependency-management-plugin</td>
<td>0.5.2.RELEASE</td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<p>Gradle은 앞서 업그레이드하였으므로 반영하였습니다.</p>
</blockquote>
<h4 id="Spring-Boot-2-0-X-Migration-✅">Spring Boot 2.0.X Migration ✅</h4>
<p>마이그레이션 시 <a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.0-Migration-Guide" target="_blank" rel="noopener">Spring Boot 2.0 Migration Guide</a>를 참고하였습니다.</p>
<blockquote>
<p>이런 것 까지 준비해주시는 스프링 개발자분들 존경합니다 ㅠㅡㅠ.</p>
</blockquote>
<h5 id="의존성-검토">의존성 검토</h5>
<p>스프링 부트 2.X는 1.5.X와 비교하여 <code>리액티브 스택</code>을 추가로 지원함에따라 패키지 구조와 구성을 위한 프로퍼티에 대한 변화가 많습니다. 그리고 스프링 부트에서 사용하는 여러가지 의존성의 버전이 업데이트되면서 사용자마다 사용하는 기술 스택에 대한 의존성 버전을 확인해야합니다.</p>
<ul>
<li><a href="https://docs.spring.io/spring-boot/docs/1.5.x/reference/html/appendix-dependency-versions.html" target="_blank" rel="noopener">1.5.X의 의존성 버전</a></li>
<li><a href="https://docs.spring.io/spring-boot/docs/2.0.x/reference/html/appendix-dependency-versions.html" target="_blank" rel="noopener">2.0.X의 의존성 버전</a></li>
</ul>
<table>
<thead>
<tr>
<th>Group ID</th>
<th>Artifact ID</th>
<th>Version</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>com.fasterxml.jackson.core</td>
<td>jackson-core</td>
<td>2.8.11</td>
<td>2.9.8</td>
</tr>
<tr>
<td></td>
<td>jackson-databind</td>
<td>2.8.11.3</td>
<td>2.9.8</td>
</tr>
<tr>
<td>com.hazelcast</td>
<td>hazelcast</td>
<td>3.7.8</td>
<td>3.9.4</td>
</tr>
<tr>
<td></td>
<td>hazelcast-spring</td>
<td>3.7.8</td>
<td>3.9.4</td>
</tr>
<tr>
<td>com.google.code.gson</td>
<td>gson</td>
<td>2.8.5</td>
<td>2.8.5</td>
</tr>
<tr>
<td>com.zaxxer</td>
<td>HikariCP</td>
<td>2.5.1</td>
<td>2.7.9</td>
</tr>
<tr>
<td>commons-beanutils</td>
<td>commons-beanutils</td>
<td>1.9.3</td>
<td>X</td>
</tr>
<tr>
<td>commons-collections</td>
<td>commons-collections</td>
<td>3.2.2</td>
<td>X</td>
</tr>
<tr>
<td>javax.mail</td>
<td>javax.mail-api</td>
<td>1.5.6</td>
<td>1.6.2</td>
</tr>
<tr>
<td>javax.validation</td>
<td>validation-api</td>
<td>1.1.0.Final</td>
<td>2.0.1.Final</td>
</tr>
<tr>
<td>org.apache.httpcomponents</td>
<td>httpclient</td>
<td>4.5.9</td>
<td>4.5.8</td>
</tr>
<tr>
<td>org.apache.tomcat.embed</td>
<td>tomcat-embed-core</td>
<td>8.5.43</td>
<td>8.5.39</td>
</tr>
<tr>
<td>org.assertj</td>
<td>assertj-core</td>
<td>2.6.0</td>
<td>3.9.1</td>
</tr>
<tr>
<td>org.codehaus.groovy</td>
<td>groovy</td>
<td>2.4.17</td>
<td>2.4.16</td>
</tr>
<tr>
<td>org.elasticsearch</td>
<td>elasticsearch</td>
<td>2.4.6</td>
<td>5.6.16</td>
</tr>
<tr>
<td>org.elasticsearch.client</td>
<td>transport</td>
<td>X</td>
<td>5.6.16</td>
</tr>
<tr>
<td>org.hibernate</td>
<td>hibernate-validator</td>
<td>5.3.6.Final</td>
<td>6.0.16.Final</td>
</tr>
<tr>
<td></td>
<td>hibernate-validator-annotation-processor</td>
<td>5.3.6.Final</td>
<td>6.0.16.Final</td>
</tr>
<tr>
<td>org.postgresql</td>
<td>postgresql</td>
<td>9.4.1212.jre7</td>
<td>42.2.5</td>
</tr>
<tr>
<td>org.quartz-scheduler</td>
<td>quartz</td>
<td>X</td>
<td>2.3.1</td>
</tr>
<tr>
<td></td>
<td>quartz-jobs</td>
<td>X</td>
<td>2.3.1</td>
</tr>
<tr>
<td>org.reactivestreams</td>
<td>reactive-streams</td>
<td>X</td>
<td>1.0.2</td>
</tr>
<tr>
<td>org.springframework</td>
<td>spring-core</td>
<td>4.3.25.RELEASE</td>
<td>5.0.13.RELEASE</td>
</tr>
<tr>
<td>io.micrometer</td>
<td>micrometer-core</td>
<td>X</td>
<td>1.0.10</td>
</tr>
<tr>
<td>com.sun.mail</td>
<td>javax.mail</td>
<td>1.5.6</td>
<td>1.6.2</td>
</tr>
</tbody>
</table>
<blockquote>
<p>간단하게 추렸는데도 꽤 많아보이네요</p>
</blockquote>
<h5 id="프로퍼티-마이그레이터-설정">프로퍼티 마이그레이터 설정</h5>
<p>스프링 부트 2.0에서 많은 설정 프로퍼티가 변경, 삭제되어서 이를 업데이트해야합니다. 스프링 부트에서는 이 작업을 도와주기 위하여 <code>spring-boot-properties-migrator</code> 모듈을 제공합니다.</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    runtime(<span class="string">"org.springframework.boot:spring-boot-properties-migrator"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Once you’re done with the migration, please make sure to remove this module from your project’s dependencies.</span></span><br></pre></td></tr></table></figure>
<p>위와 같이 설정하면 런타임 시에 애플리케이션 환경을 분석해주고 임시적으로 변경된 프로퍼티로 바꿔줍니다.</p>
<blockquote>
<p>변경된 프로퍼티가 존재하면 WARN 레벨의 로그로 출력되며, 삭제된 프로퍼티를 사용하는 경우 ERROR 레벨의 로그를 출력합니다.</p>
</blockquote>
<h5 id="변경사항-확인">변경사항 확인</h5>
<p>릴리즈 노트를 통해서 무엇이 바뀌었는지 간단하게 확인하였습니다.</p>
<p><strong><em>기본 데이터베이스 커넥션 풀이 Tomcat-JDBC에서 HikariCP로 변경되었습니다.</em></strong></p>
<blockquote>
<p>기존에도 HikariCP를 사용하게 변경하여서 고려할 부분은 없었습니다.</p>
</blockquote>
<p><strong><em>리액티브 스택 지원으로 인한 의존성이 추가되어 임베디드 컨테이너 패키지가 광범위하게 리팩토링되었습니다.</em></strong></p>
<blockquote>
<p>Tomcat의 AJP 프로토콜 사용 설정을 위한 코드 변경이 필요했습니다.</p>
</blockquote>
<p><strong><em>액추에이터가 자체적인 매트릭 API이 아닌 Micrometer에 의존합니다.</em></strong></p>
<blockquote>
<p>Management 서버를 이용하지 않고 자체적으로 엔드포인트를 호출하여 사용했는데 이 엔드포인트에 대한 변경사항이 많아서 코드 로직을 다시 구현했습니다.</p>
</blockquote>
<p><strong><em>스프링 소셜에 대한 자동 구성이 제외되어 의존성 관리 목록에서 제거되었습니다.</em></strong></p>
<blockquote>
<p>스프링 소셜 기능을 사용하지 않으므로 무시합니다.</p>
</blockquote>
<p><strong><em>레디스 드라이버로써 Jedis가 아닌 Lettuce를 사용합니다.</em></strong></p>
<blockquote>
<p>리액티브 스택 지원을 위해 서블릿 기반의 Jedis가 아닌 Lettuce를 선택한 듯 보입니다.</p>
</blockquote>
<p><strong><em>엘라스틱서치가 5.4+으로 업그레이드 되었습니다. 엘라스틱에서 임베디드 엘라스틱을 더이상 지원하지 않으므로 NodeClient에 대한 자동 구성이 제외되었습니다.</em></strong></p>
<blockquote>
<p>엘라스틱서치 7.3.2를 사용하고있어 의존성 버전을 고정했습니다.</p>
</blockquote>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">ext &#123;</span><br><span class="line">    set(<span class="string">'elasticsearch.version'</span>, <span class="string">"7.3.2"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>Spring Boot Gradle Plugin의 많은 부분이 개선되었습니다. 이제 의존성 관리 플러그인을 자동으로 적용하지 않으므로 이제 직접 명시해야 합니다.</em></strong></p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'org.springframework.boot'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'io.spring.dependency-management'</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>bootRepackage</code> 태스크가 <code>bootJar</code>와 <code>bootWar</code>로 대체되었습니다. 더이상 <code>jar</code>와 <code>war</code> 태스크가 관여하지 않습니다.</li>
<li><code>BootRun</code>, <code>BootJar</code>, <code>BootWar</code> 태스크는 이제 메인 클래스 이름 설정을 위해 <code>mainClassName</code> 프로퍼티를 사용합니다.</li>
</ul>
<p><strong><em>ConditionalOnBean이 OR이 아닌 논리적 AND를 사용합니다.</em></strong></p>
<blockquote>
<p>@ConditionalOnBean 사용 시 조심해야겠네요</p>
</blockquote>
<p><strong><em>AOP 지원을 포함하여 기본적으로 CGLIB를 사용합니다.</em></strong></p>
<blockquote>
<p>인터페이스 기반의 프록시가 필요하다면 spring.aop.proxy-target-class를 설정하면 되는데 @EnableAspectJAutoProxy(proxyTargetClass = true)를 명시해서 사용하고 있으므로 별다른 변경은 없어보입니다.</p>
</blockquote>
<p><strong><em><a href="https://docs.spring.io/spring-boot/docs/2.0.9.RELEASE/reference/html/boot-features-external-config.html#boot-features-external-config-relaxed-binding" target="_blank" rel="noopener">완화된 바인딩과 관련하여 규칙이 강화</a>되었으며 새로운 구조로 대체되어 기존의 <code>org.springframework.boot.bind</code> 패키지를 더이상 이용할 수 없습니다.</em></strong></p>
<blockquote>
<p>이로 인해 spring-boot-admin 1.5.7을 더이상 사용할 수 없었습니다.</p>
</blockquote>
<h5 id="문제점-해결-⚠️">문제점 해결 ⚠️</h5>
<p>업그레이드 후 발생한 문제점을 확인하고 해결해야합니다.</p>
<p><strong>프로퍼티 변경</strong><br>
제외된 프로퍼티 또는 변경된 프로퍼티가 있으면 알려주므로 쉽게 변경하였습니다.</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># server.contextPath=</span></span><br><span class="line"><span class="meta">server.servlet.context-path</span>=<span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># server.session.timeout=</span></span><br><span class="line"><span class="meta">server.servlet.session.timeout</span>=<span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># spring.http.multipart.max-file-size=</span></span><br><span class="line"><span class="comment"># spring.http.multipart.max-request-size=</span></span><br><span class="line"><span class="meta">spring.servlet.multipart.max-file-size</span>=<span class="string"></span></span><br><span class="line"><span class="meta">spring.servlet.multipart.max-request-size</span>=<span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># spring.datasource.jmx-enabled=</span></span><br><span class="line"><span class="meta">spring.datasource.tomcat.jmx-enabled</span>=<span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># security.basic.enabled= # The security auto-configuation no longer custormizable</span></span><br><span class="line"><span class="comment"># security.oauth2.resource.filter-order= # The security auto-configuration no longer provide several security configurations</span></span><br><span class="line"><span class="comment"># security.user.name=</span></span><br><span class="line"><span class="comment"># security.user.password=</span></span><br><span class="line"><span class="meta">spring.security.user.name</span>=<span class="string"></span></span><br><span class="line"><span class="meta">spring.security.user.password</span>=<span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># endpotins.enabled=</span></span><br><span class="line"><span class="comment"># endpoints.info.enabled=</span></span><br><span class="line"><span class="meta">management.endpoints.enabled-by-default</span>=<span class="string"></span></span><br><span class="line"><span class="meta">management.endpoint.info.enabled</span>=<span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># management.context-path=</span></span><br><span class="line"><span class="comment"># management.security.enabled= a global security is auto-configuation is provided</span></span><br><span class="line"><span class="comment"># management.ssl.enabled=</span></span><br><span class="line"><span class="meta">management.server.servlet.context-path</span>=<span class="string"></span></span><br><span class="line"><span class="meta">management.server.ssl.enabled</span>=<span class="string"></span></span><br></pre></td></tr></table></figure>
<p><strong>임베디드 톰캣 커스터마이저 코드 변경</strong><br>
임베디드 컨테이너 패키지가 리팩토링되어 기존의 톰캣 커스터마이즈를 위한 클래스를 변경해야합니다.</p>
<table>
<thead>
<tr>
<th>Before</th>
<th>After</th>
</tr>
</thead>
<tbody>
<tr>
<td>EmbeddedServletContainer</td>
<td>WebServer</td>
</tr>
<tr>
<td>org.springframework.boot.context.embedded</td>
<td>org.springframework.boot.web.server</td>
</tr>
<tr>
<td>EmbeddedServletContainerCustomizer</td>
<td>WebServerFactoryCustomizer</td>
</tr>
<tr>
<td>TomcatEmbeddedServletContainerFactory</td>
<td>TomcatServletWebServerFactory</td>
</tr>
<tr>
<td>EmbeddedServletContainerCustomizer</td>
<td>WebServerFactoryCustomizer&lt;TomcatServletWebServerFactory&gt;</td>
</tr>
</tbody>
</table>
<p><strong>Spring Boot Admin 의존성 변경</strong><br>
<a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.0-Migration-Guide#relaxed-binding" target="_blank" rel="noopener">Relaxed Binding</a>이 변경되면서 org.springframework.boot.bind의 RelaxedPropertyResolver가 삭제되었는데 spring-boot-admin:1.5.7에서 RelaxedPropertyResolver를 참조하므로 더이상 사용할 수 없게 되어 버전을 업그레이드 하였습니다.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Exception encountered during context initialization - </span><br><span class="line">cancelling refresh attempt: org.springframework.beans.factory.BeanDefinitionStoreException: Failed to process import candidates for configuration class [net.ion.VppApplication]; </span><br><span class="line"></span><br><span class="line">nested exception is java.lang.IllegalStateException: </span><br><span class="line">Could not evaluate condition on de.codecentric.boot.admin.client.config.SpringBootAdminClientAutoConfiguration due to org&#x2F;springframework&#x2F;boot&#x2F;bind&#x2F;RelaxedPropertyResolver not found. </span><br><span class="line"></span><br><span class="line">Make sure your own configuration does not rely on that class. </span><br><span class="line">This can also happen if you are @ComponentScanning a springframework package (e.g. if you put a @ComponentScan in the default package by mistake)</span><br></pre></td></tr></table></figure>
<h4 id="Spring-Boot-from-2-0-X-to-2-1-X">Spring Boot from 2.0.X to 2.1.X</h4>
<p>2.0.0.RELEASE로 마이그레이션을 완료하였으며 다시 한번 2.1.X로 버전을 업그레이드 시도해보았습니다. 그 이유는 개발 시 활용하는 <a href="http://hotswapagent.org/mydoc_quickstart-jdk11.html" target="_blank" rel="noopener">HotswapAgent가 Java 8과 Java 11을 지원</a>하기 때문입니다.</p>
<blockquote>
<p>물론, <a href="https://github.com/HotswapProjects/openjdk-jdk9" target="_blank" rel="noopener">openjdk-jdk9</a>과 <a href="https://github.com/HotswapProjects/openjdk-jdk10" target="_blank" rel="noopener">openjdk-jdk10</a>에 대한 시도는 있었던 것 같습니다.</p>
</blockquote>
<p>하지만 정식으로 제공하는 것은 Java 8과 Java 11입니다.</p>
<p>결국 HotSwap 기능을 활성화하려면 JDK 11으로 빌드 및 구동할 수 있어야합니다. 앞서 알아본 스프링 버전별 JDK 지원 항목에 의해서 Java 11을 커버할 수 있는 2.1.1.RELEASE로 한 단계 더 업그레이드 하겠습니다.</p>
<h5 id="변경사항-확인-2">변경사항 확인</h5>
<p>이번에도 무엇이 바뀌었는지 확인하고 크게 바뀐 부분이 있는지 확인합니다.</p>
<p><strong><em>이제 Java 11을 지원합니다.</em></strong></p>
<blockquote>
<p>그래서 업그레이드를 시도하고 있죠</p>
</blockquote>
<p><strong><em>기본적으로 <a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.1-Release-Notes#bean-overriding" target="_blank" rel="noopener">빈 오버라이딩</a>을 허용하지 않도록 변경되었습니다.</em></strong></p>
<blockquote>
<p>같은 유형의 빈을 다시 정의하는 것을 방지하는 기능인데 다시 정의하는 것들이 있어서</p>
</blockquote>
<p><strong><em>자동 구성 제외에 대한 일관성을 제공합니다. <code>@EnableAutoConfiguration</code>, <code>@SpringBootApplication</code>, <code>@ImportAutoConfiguration</code> 또는 <code>spring.autoconfigure.exclude</code>로 정의합니다.</em></strong></p>
<blockquote>
<p>다양항 방식으로 자동 구성을 끌 수 있겠네요</p>
</blockquote>
<p><strong><em>서블릿 패스 속성이 <code>server.servlet.path</code>에서 <code>spring.mvc.servlet.path</code>로 변경되었습니다.</em></strong></p>
<blockquote>
<p>해당 프로퍼티를 사용하지 않아 문제가 없습니다.</p>
</blockquote>
<p><strong><em>웹 애플리케이션이 동작하는 동안의 디버그 로깅 출력이 개선되었습니다.</em></strong></p>
<blockquote>
<p>HTTP 처리 과정을 자세히 확인할 수 있을 듯 보입니다.</p>
</blockquote>
<p><strong><em><code>HttpPutFormContentFilter</code>이 제외되었으며 <code>FormContentFilter</code>를 사용합니다. 따라서, <code>spring.mvc.formcontent.putfilter.enabled</code>는 더이상 정의할 수 없으며 <code>spring.mvc.formcontent.filter.enabled</code>으로 변경해야합니다.</em></strong></p>
<p><strong><em><code>json-simple</code>에 대한 의존성 관리가 제공되지않으며 <code>JsonParser</code> 구현체가 제거되었습니다.</em></strong></p>
<p><strong><em>Lombok이 1.18.x로 변경되어 더 이상 프라이빗 빈 생성자를 생성하지 않습니다.</em></strong></p>
<blockquote>
<p>lombok.config의 lombok.noArgsConstructor.extraPrivate=true를 설정해야 합니다.</p>
</blockquote>
<p><strong><em>임베디드 웹 서버가 일관된 최대 HTTP 헤더 크기를 갖습니다.</em></strong></p>
<blockquote>
<p>(8kB, server.max-http-header-size)</p>
</blockquote>
<p><strong><em>컨텍스트 ApplicationConversionService을 지원합니다.</em></strong></p>
<blockquote>
<p>Environment와 BeanFactory에 ApplicationConversionService가 기본으로 등록됩니다.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;my.duration:10s&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> Duration duration;</span><br></pre></td></tr></table></figure>
<p><strong><em>프로파일 표현 형식 지원이 향상되었습니다.</em></strong></p>
<blockquote>
<p>자세한 내용은 <a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.1-Release-Notes#profile-expression" target="_blank" rel="noopener">여기</a>를 참고하세요</p>
</blockquote>
<p><strong><em>ThreadPoolTaskExecutor에 대한 자동 구성을 지원합니다.</em></strong></p>
<p><strong><em>@EnableScheduling이 명시된 경우 ThreadPoolTaskScheduler에 대한 자동 구성을 지원합니다.</em></strong></p>
<p><strong><em>연관된 로거들을 하나의 그룹으로 정의하는 로거 그룹을 지원합니다.</em></strong></p>
<blockquote>
<p>로거에 대한 레벨 설정시 그룹 단위로 지정할 수 있습니다.</p>
</blockquote>
<p><strong><em>Spring Data가 JDBC에 대한 리파지토리를 지원합니다.</em></strong></p>
<blockquote>
<p>제가 관심있는 부분인데 JPA를 사용하지 않고 리파지토리 기능을 사용할 수 있습니다.</p>
</blockquote>
<p><strong><em>RestClient와 RestHighLevelClient에 대한 자동 구성 및 spring.elasticsearch.rest.* 네임스페이스로 구성 옵션을 제공합니다.</em></strong></p>
<blockquote>
<p>수동으로 elasticsearch를 이용하므로 의미가 없습니다.</p>
</blockquote>
<p><strong><em>액추에이터 앤드포인트 추가 및 개선되었습니다.</em></strong></p>
<blockquote>
<p>런타임시 HealthIndicatorRegistry 빈으로 HealthIndicator를 추가 및 제거할 수 있습니다.<br>
또한, Health 엔드포인트가 특정 상태 인디케이터를 쿼리할 수 있습니다.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ReadOperation</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Health <span class="title">healthForComponent</span><span class="params">(@Selector String component)</span> </span>&#123;</span><br><span class="line">	HealthIndicator indicator = getNestedHealthIndicator(<span class="keyword">this</span>.healthIndicator,</span><br><span class="line">			component);</span><br><span class="line">	<span class="keyword">return</span> (indicator != <span class="keyword">null</span>) ? indicator.health() : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em><code>spring.jackson.visiblity.*</code>를 사용하여 Jackson visibility를 설정할 수 있습니다.</em></strong></p>
<blockquote>
<p>ObjectMapper를 수동으로 등록하므로 사용하지 않습니다.</p>
</blockquote>
<p><strong><em>HiddenHttpMethodFilter를 프로퍼티로 비활성화 할 수 있습니다.</em></strong></p>
<blockquote>
<p>수동으로 FilterRegistrationBean을 통해 HiddenHttpMethodFilter를 등록하는 부분을 프로퍼티로 변경해야겠습니다.</p>
</blockquote>
<p><strong><em>@SpringBootTest(webEnvironment = WebEnvironment.RANDOM_PORT)로 별도의 랜덤 포트를 적용할 수 있습니다.</em></strong></p>
<blockquote>
<p>테스트 시 포트 문제가 해결될 듯 합니다.</p>
</blockquote>
<p>그외 변경된 부분이 더 있으므로 <a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.1-Release-Notes" target="_blank" rel="noopener">릴리즈 노트</a>를 참고하시길 바랍니다.</p>
<h5 id="문제점-해결-⚠️-2">문제점 해결 ⚠️</h5>
<p><strong>빈 오버라이딩 허용 안됨</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">The bean &#39;freeMarkerConfiguration&#39;, defined in class path resource [org&#x2F;springframework&#x2F;boot&#x2F;autoconfigure&#x2F;freemarker&#x2F;FreeMarkerServletWebConfiguration.class], could not be registered. </span><br><span class="line">A bean with that name has already been defined in class path resource [..&#x2F;config&#x2F;MailConfig.class] and overriding is disabled.</span><br></pre></td></tr></table></figure>
<p>Freemaker를 메일 템플릿 엔진으로 사용하고 있었는데 freemarker.template.Configuration 빈이 오버라이딩 되기 때문에 오류가 발생했습니다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FreeMarkerServletWebConfiguration</span> <span class="keyword">extends</span> <span class="title">AbstractFreeMarkerConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> freemarker.template.<span class="function">Configuration <span class="title">freeMarkerConfiguration</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    		FreeMarkerConfig configurer)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">return</span> configurer.getConfiguration();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MailConfig</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// @Deprecated</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> freemarker.template.<span class="function">Configuration <span class="title">freeMarkerConfiguration</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TemplateException </span>&#123;</span><br><span class="line">        FreeMarkerConfigurationFactory freeMarkerConfigurationFactory = <span class="keyword">new</span> FreeMarkerConfigurationFactory();</span><br><span class="line">        freeMarkerConfigurationFactory.setTemplateLoaderPath(<span class="string">"classpath:/templates/mails"</span>);</span><br><span class="line">        <span class="keyword">return</span> freeMarkerConfigurationFactory.createConfiguration();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MailConfig에서 freemarker.template.Configuration 선언을 제거하고 프로퍼티로<br>
<code>template-loader-path</code>를 설정하였습니다.</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">spring.freemarker.template-loader-path</span>= <span class="string">classpath:/templates/mails</span></span><br></pre></td></tr></table></figure>
<h4 id="Spring-Boot-from-2-1-X-to-2-2-X">Spring Boot from 2.1.X to 2.2.X</h4>
<p>굳이 하지 않아도 되는 작업인데 번외로 최근 버전인 2.2.3.RELEASE으로도 업그레이드 시도해보았습니다.</p>
<blockquote>
<p>또 얼마전에 <a href="https://github.com/spring-projects/spring-boot/releases/tag/v2.2.4.RELEASE" target="_blank" rel="noopener">2.2.4.RELEASE</a>가 릴리즈 되었습니다. 😜<br>
여기서 좀 크리티컬한 오류가 생기는데 이에 대해서 개선되었나봅니다.</p>
</blockquote>
<h5 id="변경사항-확인-3">변경사항 확인</h5>
<p>업그레이드 하기 위한 작업은 변경사항을 확인하는 것부터 해야겠죠.</p>
<p>자세한 내용은 <a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.2-Release-Notes" target="_blank" rel="noopener">Spring boot 2.2 Release Notes</a>를 참고하세요</p>
<p><strong><em>JAVA 13을 지원합니다.</em></strong></p>
<p><strong><em>JMX가 기본적으로 활성화되어있지 않게 됩니다.</em></strong></p>
<blockquote>
<p>이 기능은 <code>spring.jmx.enabled=true</code>로 활성화할 수 있습니다</p>
</blockquote>
<p><strong><em>가능한 경우 Java EE 의존성에서 Jakarta EE 의존성으로 변경됩니다.</em></strong></p>
<blockquote>
<p><code>com.sun.mail:javax.mail</code>는 <code>com.sun.mail:jakarta.mail</code>됩니다.</p>
</blockquote>
<p><strong><em><code>spring-boot-starter-test</code>가 기본적으로 JUnit5를 지원합니다.</em></strong></p>
<blockquote>
<p>Junit4를 사용하려면 의존하는 모듈을 제외하고 Junit4를 포함해야합니다.</p>
</blockquote>
<p><strong><em>액추에이터 HTTP 트레이스와 감시 기능이 기본적으로 활성화되지 않습니다.</em></strong></p>
<p><strong><em>데이터소스 헬스 인디케이터는 별도의 <code>validationQuery</code> 속성을 포함합니다.</em></strong></p>
<p><strong><em>Gradle 4.10+가 요구됩니다.</em></strong></p>
<blockquote>
<p>저는 5.6.4를 사용하므로 문제가 되지 않습니다.</p>
</blockquote>
<p><strong><em>프리마커 템플릿에 대한 기본 템플릿 확장자가 변경되었습니다.</em></strong></p>
<blockquote>
<p>html을 사용하기 때문에 무시해도 될 것 같습니다.</p>
</blockquote>
<p><strong><em>톰캣 MBean 레지스트리가 기본적으로 비활성화되어 약 2MB의 힙이 절약됩니다.</em></strong></p>
<blockquote>
<p>MBean 매트릭이 필요하면 활성화해야겠네요</p>
</blockquote>
<p><strong><em>HttpHiddenMethodFilter가 기본적으로 비활성화됩니다.</em></strong></p>
<blockquote>
<p>다시 활성화하려면 spring.webflux.hiddenmethod.filter.enabled 또는 spring.mvc.hiddenmethod.filter.enabled를 true로 설정하세요</p>
</blockquote>
<p><strong><em>Helth Indicator 그룹 기능 구현을 위해 여러 클래스가 사용되지 않습니다.</em></strong></p>
<p><strong><em>@Configuration 클래스에서 proxyBeanMethods = false를 사용하여 시작 시간과 메모리 사용량이 줄었습니다.</em></strong></p>
<blockquote>
<p>사용자 정의 설정 클래스들을 확인해서 빈을 참조하는지 확인하여 설정하면 됩니다.<br>
참조하는 설정 클래스에 해당 옵션을 적용하면 로드 시 문제가 됩니다.</p>
</blockquote>
<p><strong><em>Gradle에서 bootRun으로 개발시 응용 프로그램을 시작할 때 JVM에 <code>-Xverify:none</code>와 <code>-XX:TieredStopAtLevel=1</code> 플래그가 설정됩니다.</em></strong></p>
<blockquote>
<p>속도 향상을 위해 기본 JVM 옵션을 부여하는 듯 합니다. 단, Java 13으로 동작하는 경우 <code>-Xverify:none</code>은 지정되지 않습니다.</p>
</blockquote>
<p><strong><em>시작 시간 절약을 위해 <code>spring.main.lazy-initialization</code> 속성으로 전역 지연 초기화 활성화를 지원합니다.</em></strong></p>
<blockquote>
<p>개발 시에는 이 속성을 사용해서 시작 시간을 앞당길 수 있습니다. 배포 환경에서는 애플리케이션이 로드되었지만 클라이언트 요청에 대해 처리할 수 없을 수 있어 비 추천합니다.</p>
</blockquote>
<p><strong><em>ApplicationContextRunner 테스트 유틸리티로 인라인 빈 등록이 가능합니다.</em></strong></p>
<blockquote>
<p>단위 테스트를 위한 유틸리티를 제공합니다.</p>
</blockquote>
<p><strong><em>유휴 JDBC 연결 매트릭을 추적하여 제공합니다.</em></strong></p>
<p><strong><em>스프링 세션의 플러쉬 모드를 지원합니다.</em></strong></p>
<blockquote>
<p>현재 애플리케이션은 개발 단계로 스프링 세션을 사용하고 있지 않으므로 무시합니다.</p>
</blockquote>
<p><strong><em>Oracle’s JDBC driver에 대한 의존성 관리가 추가되었습니다.</em></strong></p>
<blockquote>
<p>현재 애플리케이션은 PostgreSQL를 사용하므로 무시합니다.</p>
</blockquote>
<h5 id="문제점-해결-⚠️-3">문제점 해결 ⚠️</h5>
<p><strong>Cannot choose between the following variants of org.jetbrains.kotlinx:kotlinx-coroutines-bom:1.3.3</strong></p>
<p>Spring Boot 2.2.3.RELEASE와 Gradle 5.6.4로 빌드를 시도했을때 발생한 문제점입니다.<br>
이 문제는 Gradle 6.1로 업그레이드하니 바로 해결되었습니다.</p>
<blockquote>
<p>사실 상 Spring Boot 2.2.2.RELEASE에서 2.2.3.RELEASE로 올렸을 때 발생했습니다.</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Cannot choose between the following variants of org.jetbrains.kotlinx:kotlinx-coroutines-bom:1.3.3:</span><br><span class="line">  - enforcedRuntimeElements</span><br><span class="line">  - runtimeElements</span><br><span class="line">All of them match the consumer attributes:</span><br><span class="line">  - Variant <span class="string">'enforcedRuntimeElements'</span> capability org.jetbrains.kotlinx:kotlinx-coroutines-bom:1.3.3:</span><br><span class="line">      - Unmatched attributes:</span><br><span class="line">          - Found org.gradle.category <span class="string">'enforced-platform'</span> but wasn<span class="string">'t required.</span></span><br><span class="line"><span class="string">          - Found org.gradle.status '</span>release<span class="string">' but wasn'</span>t required.</span><br><span class="line">          - Found org.gradle.usage <span class="string">'java-runtime'</span> but wasn<span class="string">'t required.</span></span><br><span class="line"><span class="string">  - Variant '</span>runtimeElements<span class="string">' capability org.jetbrains.kotlinx:kotlinx-coroutines-bom:1.3.3:</span></span><br><span class="line"><span class="string">      - Unmatched attributes:</span></span><br><span class="line"><span class="string">          - Found org.gradle.category '</span>platform<span class="string">' but wasn'</span>t required.</span><br><span class="line">          - Found org.gradle.status <span class="string">'release'</span> but wasn<span class="string">'t required.</span></span><br><span class="line"><span class="string">          - Found org.gradle.usage '</span>java-runtime<span class="string">' but wasn'</span>t required.</span><br></pre></td></tr></table></figure>
<p>이와 관련하여 스프링 부트 깃허브에 <a href="https://github.com/spring-projects/spring-boot/issues/19783" target="_blank" rel="noopener">Dependency resolution fails with Gradle 5.3.x to 5.6.x</a> 이슈가 올라와있어 확인해보니 다음과 같은 답변이 있었습니다.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">The problem’s caused by spring-boot-dependencies upgrading from Kotlin Coroutines 1.3.2 to 1.3.3. </span><br><span class="line">Unfortunately this affects pure-Java projects as the Kotlin Coroutines bom is imported in the spring-boot-dependencies bom.</span><br><span class="line"></span><br><span class="line">You should be able to work around the problem by overriding the version of the Kotlin Coroutines bom that is imported by Boot’s dependency management:</span><br><span class="line"></span><br><span class="line">ext[&#39;kotlin-coroutines.version&#39;]&#x3D;&#39;1.3.2&#39;</span><br><span class="line"></span><br><span class="line">- https:&#x2F;&#x2F;github.com&#x2F;spring-projects&#x2F;spring-boot&#x2F;issues&#x2F;19783#issuecomment-575506102</span><br></pre></td></tr></table></figure>
<p>하지만 의존성 관리 플러그인이 kotlin-coroutines.version을 참조하지 않는지 해결되지 않습니다.</p>
<p>알아본 결과 이를 해결하기 위한 세 가지 방법이 있습니다.</p>
<ol>
<li>Gradle 6.1 사용</li>
<li><a href="https://github.com/spring-projects/spring-boot/issues/19783#issuecomment-576235568" target="_blank" rel="noopener">io.spring.dependency-management:1.0.9.RELEASE</a>버전 사용 <em>(2020-01-20)</em></li>
<li>Spring Boot 2.2.4.RELEASE 업그레이드 <em>(2020-01-20)</em></li>
</ol>
<blockquote>
<p><a href="https://github.com/spring-projects/spring-boot/issues/19783#issuecomment-577604150" target="_blank" rel="noopener">https://github.com/spring-projects/spring-boot/issues/19783#issuecomment-577604150</a><br>
결론적으로 제가 업그레이드를 시도했을때는 마침 문제가 있었고 😥 현재는 해결방법이 명확히 존재합니다.</p>
</blockquote>
<h3 id="JDK-✅">JDK ✅</h3>
<p>마지막으로 빌드되는 JDK 버전을 업그레이드해야합니다.</p>
<h4 id="OpenJDK-10">OpenJDK 10</h4>
<h5 id="문제점-확인-⚠️">문제점 확인 ⚠️</h5>
<p><strong><em>JDK9(Java SE 9) 이상에서 JAXB(javax.xml.bind) 클래스 못 찾음 문제</em></strong></p>
<p><a href="https://blog.leocat.kr/notes/2019/02/12/java-cannot-find-jaxb-from-jdk9-and-above" target="_blank" rel="noopener">https://blog.leocat.kr/notes/2019/02/12/java-cannot-find-jaxb-from-jdk9-and-above</a></p>
<blockquote>
<p>특정 JDK에서 --add-modules 옵션을 사용하지 못했습니다. 이에 대해서는 좀 더 확인해봐야됩니다.</p>
</blockquote>
<p><strong><em>cacerts</em></strong><br>
OpenJDK 10에서 애플리케이션 구동 시 인증서를 확인하지 못하는 문제점이 있습니다. 그 이유는 Cacerts에 해당 인증서의 인증기관이 없기 때문인데 JDK8의 cacerts를 대신 사용하도록 하였습니다.</p>
<blockquote>
<p><a href="https://stackoverflow.com/a/53246850" target="_blank" rel="noopener">https://stackoverflow.com/a/53246850</a></p>
</blockquote>
<h4 id="OpenJDK-11-for-HotswapAgent">OpenJDK 11 for HotswapAgent</h4>
<p>프로젝트 개발 시 클래스 동적 로딩을 위해 <code>HotswapAgent</code>을 사용했는데 JDK8과 <a href="http://hotswapagent.org/mydoc_quickstart-jdk11.html" target="_blank" rel="noopener">JDK11</a>을 지원하여 <a href="https://github.com/TravaOpenJDK/trava-jdk-11-dcevm" target="_blank" rel="noopener">trava-jdk-11-dcevm</a>을 사용하여 빌드 및 구동 확인하였습니다.</p>
<h3 id="Deploy-Optional">Deploy (Optional)</h3>
<p>저는 젠킨스를 활용해서 깃허브에 개발 브랜치로 푸시된 결과를 확인해 빌드를 진행하도록 설정되어있어 여기서 사용하는 JDK 버전도 변경해야합니다.</p>
<h4 id="젠킨스-OpenJDK-설치하기">젠킨스 OpenJDK 설치하기</h4>
<p>기존에는 Oracle JDK 8을 빌드에 사용하고 있었고 JDK9 부터는 OpenJDK로 빌드하려고 합니다. 그래서 <code>Extract \*.zip/\*.tar.gz</code>를 이용해 JDK를 설치하여 사용하도록 했습니다.</p>
<blockquote>
<p><a href="https://jdk.java.net/archive/" target="_blank" rel="noopener">Archived OpenJDK General-Availability Releases</a></p>
</blockquote>
<p>그리고 jdk 파라미터가 있는 경우 해당 JDK 버전을 사용하도록 설정하였습니다.</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(project.hasProperty(<span class="string">'jdk'</span>)) &#123;</span><br><span class="line">    <span class="keyword">def</span> buildJDK = project.property(<span class="string">'jdk'</span>)</span><br><span class="line">    sourceCompatibility = JavaVersion.valueOf(buildJDK)</span><br><span class="line">    targetCompatibility = JavaVersion.valueOf(buildJDK)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Gradle 이용시 JDK를 구분하여 처리할 수 있는 좋은 방법을 아신다면 공유 부탁드립니다.</p>
</blockquote>
<h2 id="참고">참고</h2>
<ul>
<li><a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.0-Migration-Guide" target="_blank" rel="noopener">Spring Boot 2.0 Migration Guide</a></li>
<li><a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.0-Release-Notes" target="_blank" rel="noopener">Spring Boot 2.0 Release Notes</a></li>
<li><a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.1-Release-Notes" target="_blank" rel="noopener">Spring Boot 2.1 Release Notes</a></li>
<li><a href="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.2-Release-Notes" target="_blank" rel="noopener">Spring Boot 2.2 Release Notes</a></li>
<li><a href="https://docs.gradle.org/5.6.4/release-notes.html" target="_blank" rel="noopener">Gradle Release Notes</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="ko">
    <link itemprop="mainEntityOfPage" href="https://kdevkr.github.io/java/do-not-create-instance-for-jaxbcontext/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4">
      <meta itemprop="name" content="Mambo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="잠만보의 개발 블로그">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/java/do-not-create-instance-for-jaxbcontext/" class="post-title-link" itemprop="url">JAXBContext 인스턴스를 매번 만들지 말아야하는 이유</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">작성일</span>

              <time title="Post created: 2019-10-30 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-30T00:00:00Z">2019-10-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%EA%B0%9C%EB%B0%9C-%EC%9D%B4%EC%95%BC%EA%B8%B0/" itemprop="url" rel="index"><span itemprop="name">개발 이야기</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%EA%B0%9C%EB%B0%9C-%EC%9D%B4%EC%95%BC%EA%B8%B0/%EC%9D%B4%EC%8A%88/" itemprop="url" rel="index"><span itemprop="name">이슈</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="XML-Marshaller">XML Marshaller</h2>
<p>자바 오브젝트를 XML로 구성(Marshal)하거나 XML으로 구성된 데이터를 자바 오브젝트화(Unmarshal)하는 것을 도와주는 클래스를 마샬러라고 합니다.</p>
<p>자바에서 사용할 수 있는 마샬러를 검색하면 <a href="https://docs.oracle.com/javase/8/docs/api/javax/xml/bind/Marshaller.html" target="_blank" rel="noopener">JAXB</a>, <a href="https://castor-data-binding.github.io/castor/reference-guide/reference/xml/xml-framework.html" target="_blank" rel="noopener">Castor</a>, <a href="http://jibx.sourceforge.net/" target="_blank" rel="noopener">JiBX</a>, <a href="https://x-stream.github.io/" target="_blank" rel="noopener">XStream</a>등이 있습니다.</p>
<h3 id="JAXB">JAXB</h3>
<p>여러 마샬러들 중에서 가장 많이 사용되고 예제가 많은 것이 JAXB(Java Architecture for XML Binding)인데 다른 마샬러와 달리 자바 패키지에 포함되어 있으면서도 사용하기가 편리합니다.</p>
<h4 id="XML-unmarshalling-benchmark">XML unmarshalling benchmark</h4>
<blockquote>
<p>XML unmarshalling benchmark in Java: JAXB vs STax vs Woodstox<br>
<a href="https://dzone.com/articles/xml-unmarshalling-benchmark" target="_blank" rel="noopener">https://dzone.com/articles/xml-unmarshalling-benchmark</a></p>
</blockquote>
<p>위 글의 결론을 보면 속도면에서는 JAXB가 월등하며 메모리 사용량에서는 STax가 우세하다고 설명합니다.</p>
<h3 id="JAXBContext">JAXBContext</h3>
<p>이 글의 주된 내용은 JAXBContext의 인스턴스에 대한 것입니다.</p>
<p>진행중인 전력관련 프로젝트에서 OpenADR 프로토콜을 이용하여 통신함에 따라 XML Marshaller를 사용해야 했습니다. 허나 XML 데이터의 크기가 커짐에 따라 서버의 마샬링 및 언마샬링 속도가 느려짐을 확인되었고 먼저 JAXB 성능에 의심을 하였으나 벤치마크 글을 확인한 후 방향을 틀어 현재 코드에서 문제가 있는곳을 찾아야 했습니다.</p>
<p>그래서 JAXB의 퍼포먼스에 대해서 검색하였고 스택오버플로우에서 다음과 같은 질문을 찾았습니다.</p>
<blockquote>
<p>How do I improve performance of application that uses the JAXBContext.newInstance operation?<br>
<a href="https://stackoverflow.com/questions/6043956/how-do-i-improve-performance-of-application-that-uses-the-jaxbcontext-newinstanc" target="_blank" rel="noopener">https://stackoverflow.com/questions/6043956/how-do-i-improve-performance-of-application-that-uses-the-jaxbcontext-newinstanc</a></p>
</blockquote>
<p>답변에 내용은 JAXBContext의 인스턴스를 만드는 것에 대한 오버헤드를 피하라는 것이었고 프로젝트 내 JAXBContext를 사용하는 코드들을 찾았습니다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Marshaller <span class="title">getMarshaller</span><span class="params">(Object payload)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JAXBManager().createMarshaller();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JAXBManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_JAXB_CONTEXT_PATH = <span class="string">""</span>;</span><br><span class="line">    JAXBContext jaxbContext;</span><br><span class="line">    OADR2NamespacePrefixMapper nsMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JAXBManager</span><span class="params">()</span> <span class="keyword">throws</span> JAXBException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JAXBManager</span><span class="params">(String jaxbContextPath)</span> <span class="keyword">throws</span> JAXBException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jaxbContext = JAXBContext.newInstance(jaxbContextPath);</span><br><span class="line">        <span class="keyword">this</span>.nsMapper = <span class="keyword">this</span>.createPrefixMapper();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JAXBContext <span class="title">getContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.jaxbContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> OADR2NamespacePrefixMapper <span class="title">createPrefixMapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OADR2NamespacePrefixMapper();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Marshaller <span class="title">createMarshaller</span><span class="params">()</span> <span class="keyword">throws</span> JAXBException </span>&#123;</span><br><span class="line">        Marshaller marshaller = <span class="keyword">this</span>.jaxbContext.createMarshaller();</span><br><span class="line">        <span class="keyword">this</span>.nsMapper.addTo(marshaller);</span><br><span class="line">        marshaller.setProperty(<span class="string">"jaxb.fragment"</span>, Boolean.TRUE);</span><br><span class="line">        <span class="keyword">return</span> marshaller;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>모든 오브젝트를 XML String으로 마샬링을 할 때 새로운 JAXBManager 인스턴스를 만듬에 따라 JAXBContext 인스턴스 또한 매번 만들어지는 코드였습니다.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">oadrPayload</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns</span>=<span class="string">"http://openadr.org/oadr-2.0b/2012/07"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:ei</span>=<span class="string">"http://docs.oasis-open.org/ns/energyinterop/201110"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:gml</span>=<span class="string">"http://www.opengis.net/gml/3.2"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:dsig11</span>=<span class="string">"http://www.w3.org/2009/xmldsig11#"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:scale</span>=<span class="string">"http://docs.oasis-open.org/ns/emix/2011/06/siscale"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:strm</span>=<span class="string">"urn:ietf:params:xml:ns:icalendar-2.0:stream"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:ds</span>=<span class="string">"http://www.w3.org/2000/09/xmldsig#"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:clm5ISO42173A</span>=<span class="string">"urn:un:unece:uncefact:codelist:standard:5:ISO42173A:2010-04-07"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:ical</span>=<span class="string">"urn:ietf:params:xml:ns:icalendar-2.0"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:pyld</span>=<span class="string">"http://docs.oasis-open.org/ns/energyinterop/201110/payloads"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:emix</span>=<span class="string">"http://docs.oasis-open.org/ns/emix/2011/06"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:power</span>=<span class="string">"http://docs.oasis-open.org/ns/emix/2011/06/power"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:gb</span>=<span class="string">"http://naesb.org/espi"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:atom</span>=<span class="string">"http://www.w3.org/2005/Atom"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">oadrSignedObject</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">oadrUpdateReport</span> <span class="attr">ei:schemaVersion</span>=<span class="string">"2.0b"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">pyld:requestID</span>&gt;</span>5db7fe19762ac9e75e1fd897<span class="tag">&lt;/<span class="name">pyld:requestID</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">oadrReport</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">ical:dtstart</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">ical:date-time</span>&gt;</span>2019-10-29T08:53:30Z<span class="tag">&lt;/<span class="name">ical:date-time</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">ical:dtstart</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">strm:intervals</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">ei:interval</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">ical:dtstart</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ical:date-time</span>&gt;</span>2019-10-29T08:53:30Z<span class="tag">&lt;/<span class="name">ical:date-time</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">ical:dtstart</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">ical:duration</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ical:duration</span>&gt;</span>PT0M<span class="tag">&lt;/<span class="name">ical:duration</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">ical:duration</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">ical:uid</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ical:text</span>&gt;</span>0<span class="tag">&lt;/<span class="name">ical:text</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">ical:uid</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:rID</span>&gt;</span>COMM_ERROR_YN<span class="tag">&lt;/<span class="name">ei:rID</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:confidence</span>&gt;</span>100<span class="tag">&lt;/<span class="name">ei:confidence</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:accuracy</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:accuracy</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">ei:value</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:value</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">oadrDataQuality</span>&gt;</span>Quality Good - Non Specific<span class="tag">&lt;/<span class="name">oadrDataQuality</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:rID</span>&gt;</span>CYCLE_ACTIVE_ENERGY<span class="tag">&lt;/<span class="name">ei:rID</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:confidence</span>&gt;</span>100<span class="tag">&lt;/<span class="name">ei:confidence</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:accuracy</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:accuracy</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">ei:value</span>&gt;</span>500.0<span class="tag">&lt;/<span class="name">ei:value</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">oadrDataQuality</span>&gt;</span>Quality Good - Non Specific<span class="tag">&lt;/<span class="name">oadrDataQuality</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:rID</span>&gt;</span>CYCLE_REVERSE_ACTIVE_ENERGY<span class="tag">&lt;/<span class="name">ei:rID</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:confidence</span>&gt;</span>100<span class="tag">&lt;/<span class="name">ei:confidence</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:accuracy</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:accuracy</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">ei:value</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:value</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">oadrDataQuality</span>&gt;</span>Quality Good - Non Specific<span class="tag">&lt;/<span class="name">oadrDataQuality</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:rID</span>&gt;</span>ACTIVE_POWER<span class="tag">&lt;/<span class="name">ei:rID</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:confidence</span>&gt;</span>100<span class="tag">&lt;/<span class="name">ei:confidence</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:accuracy</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:accuracy</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">ei:value</span>&gt;</span>223.0<span class="tag">&lt;/<span class="name">ei:value</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">oadrDataQuality</span>&gt;</span>Quality Good - Non Specific<span class="tag">&lt;/<span class="name">oadrDataQuality</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:rID</span>&gt;</span>TOTAL_ACTIVE_ENERGY<span class="tag">&lt;/<span class="name">ei:rID</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:confidence</span>&gt;</span>100<span class="tag">&lt;/<span class="name">ei:confidence</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:accuracy</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:accuracy</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">ei:value</span>&gt;</span>24700.0<span class="tag">&lt;/<span class="name">ei:value</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">oadrDataQuality</span>&gt;</span>Quality Good - Non Specific<span class="tag">&lt;/<span class="name">oadrDataQuality</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:rID</span>&gt;</span>REVERSE_ACTIVE_POWER<span class="tag">&lt;/<span class="name">ei:rID</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:confidence</span>&gt;</span>100<span class="tag">&lt;/<span class="name">ei:confidence</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:accuracy</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:accuracy</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">ei:value</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:value</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">oadrDataQuality</span>&gt;</span>Quality Good - Non Specific<span class="tag">&lt;/<span class="name">oadrDataQuality</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:rID</span>&gt;</span>TOTAL_REVERSE_ACTIVE_ENERGY<span class="tag">&lt;/<span class="name">ei:rID</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:confidence</span>&gt;</span>100<span class="tag">&lt;/<span class="name">ei:confidence</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:accuracy</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:accuracy</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">ei:value</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:value</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">oadrDataQuality</span>&gt;</span>Quality Good - Non Specific<span class="tag">&lt;/<span class="name">oadrDataQuality</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:rID</span>&gt;</span>VOLTAGE_R<span class="tag">&lt;/<span class="name">ei:rID</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:confidence</span>&gt;</span>100<span class="tag">&lt;/<span class="name">ei:confidence</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:accuracy</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:accuracy</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">ei:value</span>&gt;</span>3745.0<span class="tag">&lt;/<span class="name">ei:value</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">oadrDataQuality</span>&gt;</span>Quality Good - Non Specific<span class="tag">&lt;/<span class="name">oadrDataQuality</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:rID</span>&gt;</span>VOLTAGE_S<span class="tag">&lt;/<span class="name">ei:rID</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:confidence</span>&gt;</span>100<span class="tag">&lt;/<span class="name">ei:confidence</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:accuracy</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:accuracy</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">ei:value</span>&gt;</span>3732.0<span class="tag">&lt;/<span class="name">ei:value</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">oadrDataQuality</span>&gt;</span>Quality Good - Non Specific<span class="tag">&lt;/<span class="name">oadrDataQuality</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:rID</span>&gt;</span>VOLTAGE_T<span class="tag">&lt;/<span class="name">ei:rID</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:confidence</span>&gt;</span>100<span class="tag">&lt;/<span class="name">ei:confidence</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:accuracy</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:accuracy</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">ei:value</span>&gt;</span>117.0<span class="tag">&lt;/<span class="name">ei:value</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">oadrDataQuality</span>&gt;</span>Quality Good - Non Specific<span class="tag">&lt;/<span class="name">oadrDataQuality</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:rID</span>&gt;</span>CURRENT_R<span class="tag">&lt;/<span class="name">ei:rID</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:confidence</span>&gt;</span>100<span class="tag">&lt;/<span class="name">ei:confidence</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:accuracy</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:accuracy</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">ei:value</span>&gt;</span>66.0<span class="tag">&lt;/<span class="name">ei:value</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">oadrDataQuality</span>&gt;</span>Quality Good - Non Specific<span class="tag">&lt;/<span class="name">oadrDataQuality</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:rID</span>&gt;</span>CURRENT_S<span class="tag">&lt;/<span class="name">ei:rID</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:confidence</span>&gt;</span>100<span class="tag">&lt;/<span class="name">ei:confidence</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:accuracy</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:accuracy</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">ei:value</span>&gt;</span>89.0<span class="tag">&lt;/<span class="name">ei:value</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">oadrDataQuality</span>&gt;</span>Quality Good - Non Specific<span class="tag">&lt;/<span class="name">oadrDataQuality</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:rID</span>&gt;</span>CURRENT_T<span class="tag">&lt;/<span class="name">ei:rID</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:confidence</span>&gt;</span>100<span class="tag">&lt;/<span class="name">ei:confidence</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:accuracy</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:accuracy</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">ei:value</span>&gt;</span>93.0<span class="tag">&lt;/<span class="name">ei:value</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">oadrDataQuality</span>&gt;</span>Quality Good - Non Specific<span class="tag">&lt;/<span class="name">oadrDataQuality</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:rID</span>&gt;</span>FREQUENCY<span class="tag">&lt;/<span class="name">ei:rID</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:confidence</span>&gt;</span>100<span class="tag">&lt;/<span class="name">ei:confidence</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:accuracy</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:accuracy</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">ei:value</span>&gt;</span>600.0<span class="tag">&lt;/<span class="name">ei:value</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">oadrDataQuality</span>&gt;</span>Quality Good - Non Specific<span class="tag">&lt;/<span class="name">oadrDataQuality</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:rID</span>&gt;</span>REACTIVE_POWER<span class="tag">&lt;/<span class="name">ei:rID</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:confidence</span>&gt;</span>100<span class="tag">&lt;/<span class="name">ei:confidence</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:accuracy</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:accuracy</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">ei:value</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:value</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">oadrDataQuality</span>&gt;</span>Quality Good - Non Specific<span class="tag">&lt;/<span class="name">oadrDataQuality</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:rID</span>&gt;</span>POWER_FACTOR<span class="tag">&lt;/<span class="name">ei:rID</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:confidence</span>&gt;</span>100<span class="tag">&lt;/<span class="name">ei:confidence</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:accuracy</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:accuracy</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">ei:value</span>&gt;</span>0.0<span class="tag">&lt;/<span class="name">ei:value</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">ei:payloadFloat</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">oadrDataQuality</span>&gt;</span>Quality Good - Non Specific<span class="tag">&lt;/<span class="name">oadrDataQuality</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">oadrReportPayload</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">ei:interval</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">strm:intervals</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">ei:eiReportID</span>&gt;</span>eiRep_5db7fe19762ac9e75e1fd898<span class="tag">&lt;/<span class="name">ei:eiReportID</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">ei:reportRequestID</span>&gt;</span>5db673e9762ae7a133ef7841<span class="tag">&lt;/<span class="name">ei:reportRequestID</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">ei:reportSpecifierID</span>&gt;</span><span class="tag">&lt;/<span class="name">ei:reportSpecifierID</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">ei:reportName</span>&gt;</span>TELEMETRY_USAGE<span class="tag">&lt;/<span class="name">ei:reportName</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">ei:createdDateTime</span>&gt;</span>2019-10-29T08:53:45Z<span class="tag">&lt;/<span class="name">ei:createdDateTime</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">oadrReport</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">ei:venID</span>&gt;</span><span class="tag">&lt;/<span class="name">ei:venID</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">oadrUpdateReport</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">oadrSignedObject</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">oadrPayload</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>위 OpenADR 페이로드에 대해서 처리되는 시간이 새로운 인스턴스를 만들 경우에는 약 8초 ~ 20초가 걸렸으며 인스턴스를 한번만 만들어 사용한 경우 약 0.3 ~ 1초로 줄었습니다.</p>
<p>이는 JAXBContext가 인스턴스화 하는 과정에서 클래스를 로드할때 메모리 및 GC 부하가 많은 것 같아보입니다.</p>
<h2 id="결론">결론</h2>
<p>클래스 그룹별로 JAXBContext 인스턴스를 애플리케이션이 로드될 때 생성하여 사용하도록 합시다.</p>
<h2 id="참고">참고</h2>
<ul>
<li><a href="https://www.baeldung.com/java-xml" target="_blank" rel="noopener">A Guide to XML in Java</a></li>
<li><a href="https://stackoverflow.com/questions/7400422/jaxb-creating-context-and-marshallers-cost" target="_blank" rel="noopener">JAXB creating context and marshallers cost</a></li>
<li><a href="https://knight76.tistory.com/entry/JAXB-%EC%9E%98-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0" target="_blank" rel="noopener">JAXB-잘-사용하기</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="ko">
    <link itemprop="mainEntityOfPage" href="https://kdevkr.github.io/spring/using-nginx-proxy-for-spring-boot-application/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4">
      <meta itemprop="name" content="Mambo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="잠만보의 개발 블로그">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/spring/using-nginx-proxy-for-spring-boot-application/" class="post-title-link" itemprop="url">Nginx를 이용한 스프링 부트 애플리케이션 프록시</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">작성일</span>

              <time title="Post created: 2019-07-12 00:00:00" itemprop="dateCreated datePublished" datetime="2019-07-12T00:00:00Z">2019-07-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%EC%8A%A4%ED%94%84%EB%A7%81/" itemprop="url" rel="index"><span itemprop="name">스프링</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%EC%8A%A4%ED%94%84%EB%A7%81/%ED%94%84%EB%A1%9D%EC%8B%9C/" itemprop="url" rel="index"><span itemprop="name">프록시</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>리눅스에서 80이나 443같은 잘알려진 포트들은 루트 사용자 권한이 있어야 사용할 수 있다. 만약, 스프링 부트 애플리케이션의 내장 톰캣이 이러한 포트를 사용하고 싶다면 실행시 sudo 명령이 포함되어야 한다.</p>
<p>하지만, 루트 사용자 권한을 부여하는 것보다는 <code>iptables</code>를 이용한 포트포워딩이나 <code>Proxy</code> 서버를 두는 것이 더 좋다.</p>
<h2 id="목표">목표</h2>
<ol>
<li>웹서버(Nginx) 구동</li>
<li>SSL 인증서 생성</li>
<li>Nginx SSL 설정</li>
<li>Nginx Proxy 설정</li>
</ol>
<h3 id="1-Nginx">1. Nginx</h3>
<p>Redirect HTTP requests to HTTPS</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo systemctl stop nginx</span><br><span class="line"><span class="comment"># /etc/nginx/config.d/default.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-SSL-Certificate">2. SSL Certificate</h3>
<p>자체 인증서 발급 예제 참고</p>
<ul>
<li><a href="https://zetawiki.com/wiki/%EB%A6%AC%EB%88%85%EC%8A%A4_%EC%9E%90%EC%B2%B4%EC%84%9C%EB%AA%85_SSL_%EC%9D%B8%EC%A6%9D%EC%84%9C_%EC%83%9D%EC%84%B1" target="_blank" rel="noopener">리눅스 자체서명 SSL 인증서 생성</a></li>
<li><a href="https://www.securesign.kr/guides/SSL-Certificate-Convert-Format" target="_blank" rel="noopener">Convert Certificate Format</a></li>
<li><a href="https://cinhtau.net/2016/08/09/convert-private-ssl-key-from-jks-to-pem-format/" target="_blank" rel="noopener">CONVERT PRIVATE SSL KEY FROM JKS TO PEM FORMAT</a></li>
</ul>
<h3 id="3-Nginx-SSL-Config">3. Nginx SSL Config</h3>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/nginx/config.d/default.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       443    ssl;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"> </span><br><span class="line">    ssl_certificate         /etc/nginx/cert/ca.pem;</span><br><span class="line">    ssl_certificate_key     /etc/nginx/cert/ca-private.key;</span><br><span class="line">    ssl_protocols           TLSv1 TSLv1.1 TLSv1.2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-Nginx-Proxy-Config">4. Nginx Proxy Config</h3>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       443     ssl;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"> </span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass         https://127.0.0.1:8080;</span><br><span class="line"> </span><br><span class="line">        proxy_set_header   Host             <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header   X-Real-IP        <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header   X-Forwarded-For  <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">sudo systemctl start nginx</span><br><span class="line"><span class="comment">#sudo systemctl restart nginx</span></span><br><span class="line">sudo systemctl status nginx</span><br></pre></td></tr></table></figure>
<h2 id="참고">참고</h2>
<ul>
<li><a href="https://bjornjohansen.no/redirect-to-https-with-nginx" target="_blank" rel="noopener">Redirect all HTTP requests to HTTPS with Nginx</a></li>
<li><a href="https://medium.com/@codebyamir/using-apache-as-a-reverse-proxy-for-spring-boot-embedded-tomcat-f704da73e7c8" target="_blank" rel="noopener">Using Apache as a Reverse Proxy for Spring Boot Embedded Tomcat</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="ko">
    <link itemprop="mainEntityOfPage" href="https://kdevkr.github.io/java/efficient-use-of-apache-poi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4">
      <meta itemprop="name" content="Mambo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="잠만보의 개발 블로그">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/java/efficient-use-of-apache-poi/" class="post-title-link" itemprop="url">Apache POI 효율적으로 사용하기</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">작성일</span>

              <time title="Post created: 2019-05-29 00:00:00" itemprop="dateCreated datePublished" datetime="2019-05-29T00:00:00Z">2019-05-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%EA%B0%9C%EB%B0%9C-%EC%9D%B4%EC%95%BC%EA%B8%B0/" itemprop="url" rel="index"><span itemprop="name">개발 이야기</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img data-src="https://poi.apache.org/images/group-logo.png#center" alt=""></p>
<p>엑셀 파일 출력을 위해 Apahce POI를 활용하면서 생긴 이슈와 처리방안을 정리하려 합니다.</p>
<h2 id="액셀-생성-방식">액셀 생성 방식</h2>
<p>POI 라이브러리를 활용해 만들 수 있는 엑셀 유형은 다음과 같다.</p>
<ul>
<li>HSSF : 엑셀 97 - 2004 (.xls)</li>
<li>XSSF : 엑셀 2007 ~ (.xlsx)</li>
<li>SXSSF : XSSF의 성능 보완 버전</li>
</ul>
<p>일반적으로 XSSF 파일 형식은 XML 방식으로 저장되기 때문에 워크북 생성시 메모리 사용량이 HSSF보다 두배 이상이 될 수 있다.</p>
<p>따라서, 보편적으로는 HSSF를 사용하는 것이 좋을 것 같다.</p>
<h2 id="엑셀-폰트-및-스타일">엑셀 폰트 및 스타일</h2>
<p>POI를 사용해서 엑셀을 생성하는 예제를 검색하면 대부분 다음과 같이 설명한다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">example</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HSSFWorkbook workbook = <span class="keyword">new</span> HSSFWorkbook();</span><br><span class="line">    </span><br><span class="line">    workbook.createFont()</span><br><span class="line">    workbook.createCellStyle()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>해당 함수들을 사용해야하는 것은 맞다. 하지만, 여기서 중요한 사실이 있다.</p>
<p>해당 함수들을 호출할 때마다 워크북에 새로운 폰트 정보와 셀 스타일 정보가 저장된다.</p>
<p>대부분의 경우에는 문제가 되지 않을 수 있지만 만약에 각 셀마다 폰트와 스타일이 제각각이거나 셀 스타일을 지정할 때마다 같은 스타일을 매번 생성한다면 어떻게 될까?</p>
<p>내가 겪었던 문제는 다음과 같다.</p>
<ol>
<li>엑셀 파일 실행시 글꼴 수가 많다는 경고창이 뜬다. (폰트 관련)</li>
<li>엑셀 출력시 특정 셀부터 스타일 지정이 안된다. (스타일 관련)</li>
</ol>
<h3 id="워크북-생성시-폰트와-스타일을-저장하여-사용하자">워크북 생성시 폰트와 스타일을 저장하여 사용하자</h3>
<p>위에서 언급한 문제를 해결할 수 있는 방법은 다음과 같다.</p>
<ol>
<li>워크북에서 사용하는 폰트 및 스타일을 미리 생성해놓는 방법</li>
<li>워크북에서 사용하는 폰트 및 스타일을 저장하여 사용하는 방법</li>
</ol>
<p>1번의 경우에는 미리 생성된 스타일만 사용하도록 제한되기 때문에 2번의 경우가 더 효율적이라고 생각한다.</p>
<h4 id="구현-예시">구현 예시</h4>
<p>워크북을 생성할 수 있는 유틸 클래스를 만들고 내부적으로 폰트와 스타일을 Map에 담아 저장하도록 구현했다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Workbook</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> HSSFWorkbook workbook = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">private</span> HSSFSheet sheet = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">private</span> HSSFCell firstCell = <span class="keyword">null</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Map&lt;Integer, HSSFFont&gt; fontMap = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">// 폰트</span></span><br><span class="line">	<span class="keyword">private</span> FontStyle defaultFontStyle = <span class="keyword">null</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Map&lt;Integer, HSSFCellStyle&gt; styleMap = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">// 스타일</span></span><br></pre></td></tr></table></figure>
<h2 id="열-너비-및-행-높이">열 너비 및 행 높이</h2>
<p>열 너비와 행 높이 조절에 대한 문제를 알아보자.</p>
<h3 id="열-너비-자동-조절">열 너비 자동 조절</h3>
<p>POI 라이브러리는 열 너비에 대한 자동 조정을 위해 <a href="http://poi.apache.org/components/spreadsheet/quick-guide.html#Autofit" target="_blank" rel="noopener">autoSizeColumn()</a>을 제공하는데 이 함수는 내부적으로 모든 행에 대한 해당 열의 레코드를 비교하여 열 너비를 맞게 조절한다.</p>
<p>만약에 이 함수를 써서 열 너비를 자동 조절해야한다면 무분별한 호출이 아닌 워크북을 파일로 출력하기 이전에 수행하는 것이 좋다.</p>
<p>또, autoSizeColumn를 사용하지 않고 특정 열에 대한 데이터 길이에 따라 ColumnWidth의 최대값을 저장하여 처리하는 방안도 있다.</p>
<h3 id="행-높이-자동-조절">행 높이 자동 조절</h3>
<p>행 높이는 HSSFRow.setHeight로 조절할 수 있다. 만약에 행 높이를 자동으로 조절하고 싶다면 setHeight 함수의 파라미터 값에 -1을 주면 엑셀 프로그램에서 자동으로 계산한다.</p>
<p>단, 해당 행에 병합된 셀이 존재한다면 엑셀 프로그램에서 자동으로 계산하는 행 높이가 올바르지 않는 문제가 있다.</p>
<p>따라서, 데이터 크기에 따라 행 높이를 자동 조절하는 함수를 따로 만들어 사용하는 것도 나쁘지 않다.</p>
<h2 id="참고">참고</h2>
<ul>
<li><a href="https://poi.apache.org/components/spreadsheet/" target="_blank" rel="noopener">POI-HSSF and POI-XSSF/SXSSF</a></li>
<li><a href="https://showbang.github.io/typistShow/2017/01/25/%EC%83%9D%EC%84%B1/" target="_blank" rel="noopener">POI를 이용하여 엑셀파일 생성하기</a></li>
<li><a href="https://blog.naver.com/titan79th/140037818261" target="_blank" rel="noopener">POI 열너비 행높이</a></li>
<li><a href="https://www.waltercedric.com/index.php?option=com_content&amp;view=article&amp;id=2096:&amp;catid=102&amp;Itemid=332" target="_blank" rel="noopener">Apache POI Speed Optimizations</a></li>
<li><a href="https://goni9071.tistory.com/entry/apache-poi-%EC%97%91%EC%85%80-%EB%B3%91%ED%95%A9%EB%90%9C-%EC%85%80-%EC%9E%90%EB%8F%99-%EB%86%92%EC%9D%B4-%EC%A1%B0%EC%A0%88%ED%95%98%EA%B8%B0" target="_blank" rel="noopener">apache poi 엑셀 병합된 셀 자동 높이 조절하기</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="ko">
    <link itemprop="mainEntityOfPage" href="https://kdevkr.github.io/spring/encrypt-password-with-spring-security/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4">
      <meta itemprop="name" content="Mambo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="잠만보의 개발 블로그">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/spring/encrypt-password-with-spring-security/" class="post-title-link" itemprop="url">비밀번호 암호화 하기</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">작성일</span>

              <time title="Post created: 2019-03-20 00:00:00" itemprop="dateCreated datePublished" datetime="2019-03-20T00:00:00Z">2019-03-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%EA%B0%9C%EB%B0%9C-%EC%9D%B4%EC%95%BC%EA%B8%B0/" itemprop="url" rel="index"><span itemprop="name">개발 이야기</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img data-src="https://javatutorial.net/wp-content/uploads/2017/12/spring-featured-image.png#center" alt=""></p>
<p>자바에서 비밀번호 암호화를 구현하기 위해서는 <a href="http://github.kindler.io/java-encrypt" target="_blank" rel="noopener">개인정보보호법과 JAVA를 이용한 암호화 구현(SHA256, AES256)</a> 또는 <a href="https://www.stubbornjava.com/posts/hashing-passwords-in-java-with-bcrypt" target="_blank" rel="noopener">Hashing Passwords in Java with BCrypt</a>와 같이 바이트 연산을 하는 코드를 작성해야 한다.</p>
<h2 id="스프링-시큐리티">스프링 시큐리티</h2>
<p>스프링 프레임워크의 시큐리티 모듈은 보안 관련된 기능을 제공해준다.</p>
<p>시큐리티 모듈이 제공하는 <code>org.springframework.security.crypto.password.PasswordEncoder </code>인터페이스를 통해 쉽게 비밀번호를 암호화하는 방법을 알아보자.</p>
<blockquote>
<p>스프링 시큐리티 설정을 사용하지 않기 때문에 관련 정보를 몰라도 상관 없다.</p>
</blockquote>
<p>스프링 프레임워크는 PlainText, SHA, SHA256, MD4, MD5, SCrypt, BCrypt와 같은 다양한 암호화 방식을 제공한다.</p>
<ul>
<li>org.springframework.security.crypto.password.StandardPasswordEncoder</li>
<li>org.springframework.security.crypto.password.Pbkdf2PasswordEncoder</li>
<li>org.springframework.security.crypto.password.NoOpPasswordEncoder</li>
<li>org.springframework.security.crypto.scrypt.SCryptPasswordEncoder</li>
<li>org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder</li>
<li>org.springframework.security.authentication.encoding.Md4PasswordEncoder</li>
<li>org.springframework.security.authentication.encoding.Md5PasswordEncoder</li>
<li>org.springframework.security.authentication.encoding.PlaintextPasswordEncoder</li>
<li>org.springframework.security.authentication.encoding.ShaPasswordEncoder</li>
<li>org.springframework.security.authentication.encoding.LdapShaPasswordEncoder</li>
</ul>
<p>스프링 시큐리티의 PasswordEncoder 인터페이스는 복호화 함수를 제공하지 않는다.</p>
<p>비밀번호라는게 외부에 공개되어야 하는 정보가 아닐 뿐더러 개발자 뿐만 아니라 관리자도 알게 해서는 안된다.</p>
<blockquote>
<p>네이버 개발자 블로그의 <a href="https://d2.naver.com/helloworld/318732" target="_blank" rel="noopener">안전한 패스워드 저장</a>을 살펴보자.</p>
</blockquote>
<h3 id="Bcrypt-비밀번호-암호화">Bcrypt 비밀번호 암호화</h3>
<p>많은 암호화 방식 중에서 스프링 프레임워크 개발자들이 선호하는 BCryptPasswordEncoder 구현체를 사용하자.</p>
<h4 id="PasswordEncoder-빈-등록">PasswordEncoder 빈 등록</h4>
<p>BCryptPasswordEncoder 구현체를 PasswordEncoder 빈으로 등록하자.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder(<span class="number">12</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="암호화">암호화</h4>
<p>비밀번호를 암호화하는 것은 쉽다.</p>
<p>암호화되지 않은 비밀번호만 넘겨주면 알아서 내부적으로 해시를 만들어 암호화된 비밀번호를 반환한다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">String <span class="title">encode</span><span class="params">(CharSequence rawPassword)</span></span>;</span><br></pre></td></tr></table></figure>
<p>우리는 회원가입 또는 비밀번호 수정 시에 PasswordEncoder의 위 함수를 통해 암호화된 비밀번호를 저장해주면 된다.</p>
<h4 id="암호화된-비밀번호-비교">암호화된 비밀번호 비교</h4>
<p>스프링 시큐리티의 PasswordEncoder가 추구하는 것은 단방향 암호화이다.</p>
<p>그러므로 다시 암호화된 비밀번호를 복호화해서 비교하는 것이 아닌 암호화되지 않은 비밀번호를 다른 해시로 암호화해서 같은 값을 가지는지 비교한다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span></span>;</span><br></pre></td></tr></table></figure>
<p>우리는 로그인 시에 위 함수를 통해 비밀번호와 암호화된 비밀번호를 비교해서 처리하면 된다.</p>
<blockquote>
<p>스프링 시큐리티 5는 다양한 암호화 방식을 전환할 수 있도록 DelegatingPasswordEncoder도 제공한다.</p>
</blockquote>
<h2 id="참고">참고</h2>
<ul>
<li><a href="http://github.kindler.io/java-encrypt" target="_blank" rel="noopener">개인정보보호법과 JAVA를 이용한 암호화 구현(SHA256, AES256)</a></li>
<li><a href="https://www.stubbornjava.com/posts/hashing-passwords-in-java-with-bcrypt" target="_blank" rel="noopener">Hashing Passwords in Java with BCrypt</a></li>
<li><a href="http://www.devkuma.com/books/pages/1124" target="_blank" rel="noopener">BCryptPasswordEncoder : 암호 해시</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="ko">
    <link itemprop="mainEntityOfPage" href="https://kdevkr.github.io/spring/sending-mail-with-freemarker-template/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4">
      <meta itemprop="name" content="Mambo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="잠만보의 개발 블로그">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/spring/sending-mail-with-freemarker-template/" class="post-title-link" itemprop="url">프리마커 템플릿으로 이메일 발송하기</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">작성일</span>

              <time title="Post created: 2019-03-19 00:00:00" itemprop="dateCreated datePublished" datetime="2019-03-19T00:00:00Z">2019-03-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%EA%B0%9C%EB%B0%9C-%EC%9D%B4%EC%95%BC%EA%B8%B0/" itemprop="url" rel="index"><span itemprop="name">개발 이야기</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img data-src="https://javatutorial.net/wp-content/uploads/2017/12/spring-featured-image.png#compact" alt=""></p>
<h3 id="스프링-프레임워크의-이메일-지원">스프링 프레임워크의 이메일 지원</h3>
<p>스프링 프레임워크에서는 이메일을 발송할 수 있도록 <code>org.springframework.mail</code> 패키지를 제공한다.</p>
<p><code>MailSender</code> 인터페이스는 메일 발송 기능을 가지는 최상위 인터페이스이며 스프링 프레임워크는 이 보다 더 좋은 기능을 제공하도록 확장한 <code>JavaMailSender</code> 인터페이스를 포함한다.</p>
<h4 id="Dependencies">Dependencies</h4>
<p>스프링 프레임워크에서 메일을 발송할 때 사용되는 의존성은 다음과 같다.</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">compile(<span class="string">'org.springframework:spring-context-support:4.3.7.RELEASE'</span>)</span><br><span class="line">compile(<span class="string">'javax.mail:mail:1.4.7'</span>)</span><br></pre></td></tr></table></figure>
<h5 id="JavaMailSenderImpl">JavaMailSenderImpl</h5>
<p>스프링 프레임워크는 <code>JavaMailSender</code> 인터페이스의 구현체인 <code>JavaMailSenderImpl</code> 클래스를 제공하며</p>
<p>우리는 굳이 JavaMailSender 구현체를 만들지 않아도 이 JavaMailSenderImpl를 사용하여 메일을 발송하는 기능을 만들 수 있다.</p>
<h5 id="MimeMessageHelper">MimeMessageHelper</h5>
<p>스프링 프레임워크는 <code>javax.mail.internet.MimeMessage</code> 클래스에 각종 설정들(제목이나 첨부파일 등)을 쉽게 지정할 수 있도록 헬퍼 클래스를 제공한다.</p>
<h3 id="이메일-발송을-위한-SMTP-서버">이메일 발송을 위한 SMTP 서버</h3>
<p>이메일을 송수신하는 서버를 SMTP(Simple Mail Transfer Protocol) 서버라고 한다.</p>
<p>그러나, 스프링 프레임워크가 자체적으로 SMTP 서버를 제공해주지는 않기 때문에 실제로 이메일을 발송하기 위해서는 SMTP 서버를 구축해야만 한다.</p>
<p>SMTP 메일 서버를 구축하는 것 대신에 우리가 많이 사용하는 구글이나 네이버 이메일 계정으로 SMTP 메일 서버를 이용할 수 있다.</p>
<p>본 포스트 에서는 구글 이메일 계정으로 SMTP 메일 서버를 이용해보겠다.</p>
<blockquote>
<p><a href="https://github.com/ChangemakerStudios/Papercut%EC%99%80" target="_blank" rel="noopener">https://github.com/ChangemakerStudios/Papercut와</a> 같은 개발용 SMTP 서버도 있다.</p>
</blockquote>
<h4 id="구글-SMTP-활성화">구글 SMTP 활성화</h4>
<p>구글 SMTP 서버를 이용하기 위해서는 구글 이메일 계정의 <a href="https://myaccount.google.com/lesssecureapps" target="_blank" rel="noopener"><code>보안 수준이 낮은 앱의 액세스</code></a>를 허용해야 한다.</p>
<p><img data-src="/spring/images/google-less-secure-apps.png" alt=""></p>
<p>이후 <a href="https://support.google.com/mail/answer/7126229?visit_id=636885550269950209-1570087438&amp;rd=1" target="_blank" rel="noopener">SMTP 서버 이용시 필요한 정보</a>는 다음과 같다.</p>
<ul>
<li>SMTP Host : <a href="http://smtp.gmail.com" target="_blank" rel="noopener">smtp.gmail.com</a></li>
<li>SMTP Username : $email</li>
<li>SMTP Password : $password</li>
<li>SMTP Post : 465</li>
<li>SSL Enable : true</li>
</ul>
<h3 id="이메일-발송-기능-구현">이메일 발송 기능 구현</h3>
<p>구글 SMTP 서버를 이용할 수 있도록 설정을 완료하였으니 이메일 발송 기능을 구현하도록 하자.</p>
<h4 id="JavaMailSender-빈-등록">JavaMailSender 빈 등록</h4>
<p>우리가 가장 먼저 해야할 일은 JavaMailSender 인터페이스 구현체를 빈으로 등록하는 것이다.</p>
<p>간단하게 앞서 소개한 JavaMailSenderImpl을 구현체로 사용하고 프로퍼티에 존재하는 정보를 불러와 값을 설정한다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JavaMailSender <span class="title">javaMailSender</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> JavaMailSenderImpl mailSender = <span class="keyword">new</span> JavaMailSenderImpl();</span><br><span class="line">    mailSender.setHost(env.getProperty(<span class="string">"spring.mail.host"</span>));</span><br><span class="line">    mailSender.setPort(Integer.valueOf(env.getProperty(<span class="string">"spring.mail.port"</span>)));</span><br><span class="line">    mailSender.setProtocol(env.getProperty(<span class="string">"spring.mail.protocol"</span>));</span><br><span class="line">    mailSender.setUsername(env.getProperty(<span class="string">"spring.mail.username"</span>));</span><br><span class="line">    mailSender.setPassword(env.getProperty(<span class="string">"spring.mail.password"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Properties javaMailProperties = <span class="keyword">new</span> Properties();</span><br><span class="line">    javaMailProperties.load(applicationContext.getResource(<span class="string">"classpath:mail.properties"</span>).getInputStream());</span><br><span class="line">    mailSender.setJavaMailProperties(javaMailProperties);</span><br><span class="line">    <span class="keyword">return</span> mailSender;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>JavaMailProperties를 프로퍼티에서 불러와 직접 값을 넣어주거나 ApplicationContext 대신에 ClassPathResource를 사용해도 무방하다.</p>
</blockquote>
<h5 id="메일-발송-프로퍼티">메일 발송 프로퍼티</h5>
<p>위 JavaMailSender에서 사용된 프로퍼티 값을 설정한다.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">spring.mail.host=smtp.gmail.com</span><br><span class="line">spring.mail.port=465</span><br><span class="line">spring.mail.username=</span><br><span class="line">spring.mail.password=</span><br><span class="line"></span><br><span class="line"><span class="comment"># mail.properties</span></span><br><span class="line">mail.smtp.ssl.enable=<span class="literal">true</span></span><br><span class="line">mail.smtp.auth=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h3 id="프리마커-이메일-템플릿">프리마커 이메일 템플릿</h3>
<p>본 포스트의 목표는 단순 이메일 발송이 아닌 프리마커 템플릿을 활용해서 이메일 내용을 구성해서 발송하는 것이다.</p>
<p>많은 템플릿 중에서 프리마커를 사용하려는 이유는 가장 설정이 쉽고 이메일 내용을 구성할 때 편리하다는 개인적인 판단 때문이다.</p>
<blockquote>
<p>대부분은 Thymeleaf를 사용하는 것으로 예제를 소개하고 있다.</p>
</blockquote>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">compile(<span class="string">'org.freemarker:freemarker:2.3.28'</span>)</span><br></pre></td></tr></table></figure>
<p>의존성을 추가하였다면 <code>freemarker.template.Configuration</code> 클래스를 빈으로 등록한다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> freemarker.template.<span class="function">Configuration <span class="title">freeMarkerConfiguration</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TemplateException </span>&#123;</span><br><span class="line">    FreeMarkerConfigurationFactory freeMarkerConfigurationFactory = <span class="keyword">new</span> FreeMarkerConfigurationFactory();</span><br><span class="line">    freeMarkerConfigurationFactory.setTemplateLoaderPath(<span class="string">"classpath:/templates/mails"</span>);</span><br><span class="line">    <span class="keyword">return</span> freeMarkerConfigurationFactory.createConfiguration();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>설정은 끝났다(응?)</p>
<p>메일 본문을 넣는 코드에서 다음과 같이 템플릿으로 가져오면 된다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> freemarker.template.Configuration engine;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">Template template = engine.getTemplate(mailBuilder.getTemplate().getContentPath(), locale);</span><br><span class="line">helper.setText(FreeMarkerTemplateUtils.processTemplateIntoString(template, context), <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>프리마커 템플릿으로 내용을 구성하는 방법은 본 포스트의 목적이 아니므로 생략한다.</p>
</blockquote>
<h2 id="참고">참고</h2>
<ul>
<li><a href="https://support.google.com/mail/answer/7126229?visit_id=636885550269950209-1570087438&amp;rd=1" target="_blank" rel="noopener">다른 이메일 클라이언트에서 Gmail을 확인할 수 있도록 IMAP 사용</a></li>
<li><a href="https://www.baeldung.com/freemarker-in-spring-mvc-tutorial" target="_blank" rel="noopener">Introduction to Using FreeMarker in Spring MVC</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="ko">
    <link itemprop="mainEntityOfPage" href="https://kdevkr.github.io/spring/building-a-spring-framework-project-with-gradle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4">
      <meta itemprop="name" content="Mambo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="잠만보의 개발 블로그">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/spring/building-a-spring-framework-project-with-gradle/" class="post-title-link" itemprop="url">Gradle과 함께 스프링 프레임워크 프로젝트 구성하기</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">작성일</span>

              <time title="Post created: 2019-02-01 00:00:00" itemprop="dateCreated datePublished" datetime="2019-02-01T00:00:00Z">2019-02-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%EA%B0%9C%EB%B0%9C-%EC%9D%B4%EC%95%BC%EA%B8%B0/" itemprop="url" rel="index"><span itemprop="name">개발 이야기</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Gradle Project를 만들어 스프링 웹 MVC 애플리케이션을 구성하고 톰캣으로 웹 애플리케이션을 구동해보자.</p>
<h2 id="그래들-프로젝트-만들기">그래들 프로젝트 만들기</h2>
<p><code>인텔리제이</code>로 스프링 프레임워크를 선택해서 프로젝트를 만들게 되면 <code>메이븐</code>과 <code>XML</code> 기반으로 구성된다.</p>
<p>이렇게 하지 않고 프로젝트 관리 도구로 <code>그래들</code>을 사용하면서 스프링 웹 MVC 애플리케이션을 구성하자.</p>
<p>일단 먼저 <code>그래들 프로젝트</code>를 만들어야 한다.</p>
<p><img data-src="/spring/images/gradle-01.png" alt=""></p>
<h3 id="웹-애플리케이션-디렉토리-구조">웹 애플리케이션 디렉토리 구조</h3>
<p>일반적인 자바 웹 애플리케이션 구조는 다음과 같다.</p>
<p><img data-src="/spring/images/gradle-03.png" alt=""></p>
<p>그런데 그래들 프로젝트를 만들면 프로젝트 구조에 <code>src/main/java</code>와 <code>src/test/java</code>와 같은 모듈 디렉토리가 없을 수 있다.</p>
<p>이럴 때 <code>Preference</code>에서 <code>Gradle</code> 찾아 <code>Create directories for empty content roots automatically</code>를 활성화하면 <code>프로젝트 루트</code>에 모듈 디렉토리가 없을 경우 자동으로 만들어준다.</p>
<p><img data-src="/spring/images/gradle-02.png" alt=""></p>
<h4 id="webapp">webapp</h4>
<p>webapp 디렉토리는 웹 애플리케이션의 특별한 폴더이다.</p>
<p><code>src/main/webapp</code> 디렉토리를 만들자.</p>
<p>그리고 그 안에 <code>WEB-INF</code> 폴더 까지 만들자</p>
<p><img data-src="/spring/images/gradle-03.png" alt=""></p>
<h2 id="Spring-Web-MVC">Spring Web MVC</h2>
<p>이제 프로젝트에 스프링 웹 애플리케이션을 만들어보자.</p>
<h3 id="라이브러리-의존성">라이브러리 의존성</h3>
<p><code>build.gradle</code>의 의존성 항목에 <code>Spring Web MVC 3.4.8.RELEASE</code>를 추가하자.</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation <span class="string">'org.springframework:spring-webmvc:4.3.8.RELEASE'</span></span><br><span class="line">    providedCompile <span class="string">'javax.servlet:javax.servlet-api:4.0.1'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Spring-MVC-Architecture">Spring MVC Architecture</h3>
<p>스프링 웹 MVC의 구성은 다음과 같다.</p>
<p><img data-src="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/htmlsingle/images/mvc.png#center" alt=""></p>
<p>모든 요청에 대하여 우선적으로 받는 <code>DispatcherServlet</code>(위 그림에서 FrontController)를 서블릿 컨텍스트에 등록해야하고 톰캣이 그 컨텍스트로 서버를 동작시킨다.</p>
<p>톰캣은 <code>web.xml</code>이라는 배포 서술자에 따라 서버를 동작시키는데 스프링은 <code>WebApplicationInitializer</code>의 구현체로 그 역할을 대신할 수 있게 해준다.</p>
<h4 id="WebApplicationInitializer">WebApplicationInitializer</h4>
<p><code>WebApplicationInitializer</code> 구현체를 만들면 코드 기반 설정을 감지하고 자동으로 서블릿 3+ 컨테이너를 초기화한다. 여기에 <code>DispatcherServlet</code>을 ServletContext에 등록하자.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebApplicationInitializer</span> <span class="keyword">implements</span> <span class="title">WebApplicationInitializer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext container)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="DispatcherServlet">DispatcherServlet</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebApplicationInitializer</span> <span class="keyword">implements</span> <span class="title">WebApplicationInitializer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext container)</span> </span>&#123;</span><br><span class="line">        ServletRegistration.Dynamic registration = container.addServlet(<span class="string">"dispatcher"</span>, <span class="keyword">new</span> DispatcherServlet());</span><br><span class="line">        registration.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">        registration.addMapping(<span class="string">"/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>기본 DispatcherServlet을 등록하고 톰캣을 통해 서버를 실행시키면 다음과 같은 오류를 내뿜으며 실행이 되지 않는다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">org.apache.catalina.core.StandardContext loadOnStartup</span><br><span class="line">심각: Servlet [dispatcher] in web application [] <span class="function">threw <span class="title">load</span><span class="params">()</span> exception</span></span><br><span class="line"><span class="function">java.io.FileNotFoundException: Could not open ServletContext resource [/WEB-INF/dispatcher-servlet.xml]</span></span><br></pre></td></tr></table></figure>
<p>기본으로 <code>WEB-INF</code> 디렉토리에 있는 <code>[servlet-name]-servlet.xml</code>파일을 읽어 초기화하도록 되어있기 때문이다.</p>
<p>그래서 우리는 애플리케이션 컨텍스트를 만들어 디스패쳐 서블릿에 넣어주자.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AnnotationConfigWebApplicationContext context = <span class="keyword">new</span> AnnotationConfigWebApplicationContext();</span><br><span class="line">context.scan(<span class="string">"com.demo.app"</span>);</span><br><span class="line"></span><br><span class="line">ServletRegistration.Dynamic dispatcher = servletContext.addServlet(<span class="string">"dispatcher"</span>, <span class="keyword">new</span> DispatcherServlet(context));</span><br><span class="line">dispatcher.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">dispatcher.addMapping(<span class="string">"/"</span>);</span><br></pre></td></tr></table></figure>
<p>그러면 아래와 같이 디스패처 서블릿이 <code>독립적인 서블릿 웹 컨텍스트</code>를 가진다.</p>
<p><img data-src="https://docs.spring.io/spring/docs/4.3.22.RELEASE/spring-framework-reference/htmlsingle/images/mvc-context-hierarchy.png" alt=""></p>
<p>위 그림에서 확인할 수 있듯이 독립적인 서블릿 웹 컨텍스트를 가지므로 다른 스프링 모듈(스프링은 모듈간 결합이 가능하다)에서 서블릿 웹 컨텍스트에 등록되어 <code>관리되는 빈들을 공유할 수 없다</code>.</p>
<p>스프링은 각 <code>애플리케이션 컨텍스트(빈 팩토리)</code>의 빈들을 공통으로 관리할 수 있도록 <code>ContextLoader</code>를 제공한다.</p>
<p><code>ContextLoaderListener</code>로 애플리케이션 컨텍스트를 등록하고 서블릿 컨텍스트에 이 리스너를 추가하자.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AnnotationConfigWebApplicationContext context = <span class="keyword">new</span> AnnotationConfigWebApplicationContext();</span><br><span class="line">context.setConfigLocation(<span class="string">"com.demo.app"</span>);</span><br><span class="line">servletContext.addListener(<span class="keyword">new</span> ContextLoaderListener(context));</span><br><span class="line"></span><br><span class="line">ServletRegistration.Dynamic dispatcher = servletContext.addServlet(<span class="string">"dispatcher"</span>, <span class="keyword">new</span> DispatcherServlet(context));</span><br><span class="line">dispatcher.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">dispatcher.addMapping(<span class="string">"/"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="Spring-MVC-Configuration">Spring MVC Configuration</h3>
<p>서블릿 컨테이너에 디스패쳐 서블릿까지 등록했으면 스프링 웹 MVC를 활성화해야한다.</p>
<h4 id="EnableWebMvc">@EnableWebMvc</h4>
<p>스프링 웹 MVC는 간단하게 @Configuration가 명시된 설정 클래스에 @EnableWebMvc 어노테이션을 명시하면 된다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = <span class="string">"com.demo.app"</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> <span class="keyword">implements</span> <span class="title">WebApplicationInitializer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigWebApplicationContext context = <span class="keyword">new</span> AnnotationConfigWebApplicationContext();</span><br><span class="line">        context.setConfigLocation(<span class="string">"com.demo.app"</span>);</span><br><span class="line">        servletContext.addListener(<span class="keyword">new</span> ContextLoaderListener(context));</span><br><span class="line"></span><br><span class="line">        ServletRegistration.Dynamic dispatcher = servletContext.addServlet(<span class="string">"dispatcher"</span>, <span class="keyword">new</span> DispatcherServlet(context));</span><br><span class="line">        dispatcher.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">        dispatcher.addMapping(<span class="string">"/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Controller">@Controller</h4>
<p>스프링 웹 MVC를 활성화 했으면 요청을 담당하는 컨트롤러를 <code>@Controller</code>를 명시해서 등록할 수 있다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">"message"</span>, <span class="string">"Hello"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"index"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이 상태로 &quot;/&quot;에 접속해보자. 그러면 다음과 같이 <code>ViewResolver</code>를 설정하라고 알려준다.</p>
<h4 id="ViewResolver">ViewResolver</h4>
<p>컨트롤러 내에 <code>@RequestMapping</code>이 붙은 메소드가 문자열을 응답하면 해당 이름을 가진 뷰로 응답하도록 처리된다.</p>
<p>그런데 위에서는 그 뷰를 처리할 수 있는 뷰 리졸버가 빈으로 등록되어 있지 않았던 것이다.</p>
<p>뷰 리졸버는 <code>InternalResourceViewResolver</code>, <code>FreemarkerViewResolver</code> 등 많은 종류가 있는데</p>
<p>우리는 JSP 템플릿을 처리하기 위해 사용하는 <code>InternalResourceViewResolver</code>를 등록해보자.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> InternalResourceViewResolver <span class="title">viewResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    InternalResourceViewResolver viewResolver = <span class="keyword">new</span> InternalResourceViewResolver();</span><br><span class="line">    viewResolver.setPrefix(<span class="string">"/WEB-INF/views/"</span>);</span><br><span class="line">    viewResolver.setSuffix(<span class="string">".jsp"</span>);</span><br><span class="line">    <span class="keyword">return</span> viewResolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Run-on-Server">Run on Server</h2>
<p>자바 웹 애플리케이션을 구동시키기 위해서는 톰캣같은 서블릿 엔진이 필요하다.</p>
<p>일반적으로는 톰캣을 설치하고 <code>Edit Configurations...</code>를 통해 톰캣 서버로 실행할 수 있는 환경을 추가해야한다.</p>
<p><img data-src="/spring/images/gradle-10.png" alt=""></p>
<h3 id="임베디드-톰캣">임베디드 톰캣</h3>
<p>아파치는 굳이 톰캣을 설치하지 않고도 구동할 수 있도록 <a href="https://mvnrepository.com/artifact/org.apache.tomcat.embed/tomcat-embed-core/9.0.14" target="_blank" rel="noopener"><code>Tomcat Embed</code></a>를 제공한다.</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'org.apache.tomcat.embed'</span>, <span class="string">name:</span> <span class="string">'tomcat-embed-core'</span>, <span class="string">version:</span> <span class="string">'9.0.14'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.apache.tomcat.embed'</span>, <span class="string">name:</span> <span class="string">'tomcat-embed-jasper'</span>, <span class="string">version:</span> <span class="string">'9.0.14'</span></span><br></pre></td></tr></table></figure>
<p>그래들로 위 라이브러리들을 임포트했다면 <code>Application.java</code>를 만들어 톰캣을 구동시키도록 작성하자.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">        Tomcat tomcat = <span class="keyword">new</span> Tomcat();</span><br><span class="line">        Connector connector = tomcat.getConnector();</span><br><span class="line">        connector.setURIEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">        tomcat.addWebapp(<span class="string">"/"</span>, <span class="keyword">new</span> File(<span class="string">"src/main/webapp"</span>).getAbsolutePath());</span><br><span class="line"></span><br><span class="line">        tomcat.setPort(<span class="number">8080</span>);</span><br><span class="line">        tomcat.start();</span><br><span class="line">        tomcat.getServer().await();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 <code>Application.java</code>를 실행하면 다음 로그처럼 <code>톰캣</code>이 구동된다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2</span>월 <span class="number">09</span>, <span class="number">2019</span> <span class="number">8</span>:<span class="number">07</span>:<span class="number">13</span> 오후 org.springframework.web.context.support.AnnotationConfigWebApplicationContext loadBeanDefinitions</span><br><span class="line">정보: Found <span class="number">2</span> annotated classes in <span class="keyword">package</span> [com.demo.app]</span><br><span class="line"><span class="number">2</span>월 <span class="number">09</span>, <span class="number">2019</span> <span class="number">8</span>:<span class="number">07</span>:<span class="number">14</span> 오후 org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping register</span><br><span class="line">정보: Mapped <span class="string">"&#123;[],methods=[GET]&#125;"</span> onto <span class="keyword">public</span> java.lang.String com.demo.app.controller.HomeController.index(org.springframework.ui.Model)</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>월 <span class="number">09</span>, <span class="number">2019</span> <span class="number">8</span>:<span class="number">07</span>:<span class="number">14</span> 오후 org.springframework.web.servlet.DispatcherServlet initServletBean</span><br><span class="line">정보: FrameworkServlet <span class="string">'dispatcher'</span>: initialization completed in <span class="number">14</span> ms</span><br><span class="line"><span class="number">2</span>월 <span class="number">09</span>, <span class="number">2019</span> <span class="number">8</span>:<span class="number">07</span>:<span class="number">14</span> 오후 org.apache.coyote.AbstractProtocol start</span><br><span class="line">정보: Starting ProtocolHandler [<span class="string">"http-nio-8080"</span>]</span><br></pre></td></tr></table></figure>
<p>정말 구동되어 서버가 JSP를 처리할 수 있을까?</p>
<p><code>http://localhost:8080/</code>으로 접속해보자.</p>
<p><img data-src="/spring/images/gradle-11.png" alt=""></p>
<h2 id="참고">참고</h2>
<ul>
<li><a href="https://github.com/kdevkr/spring-demo-configuration/tree/oligarch/spring-demo-java" target="_blank" rel="noopener">Java Configuration</a></li>
<li><a href="https://stackoverflow.com/questions/45169586/how-do-i-embed-tomcat-in-a-spring-framework-mvc-application" target="_blank" rel="noopener">How do I embed Tomcat in a Spring Framework MVC application?</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="ko">
    <link itemprop="mainEntityOfPage" href="https://kdevkr.github.io/spring/managing-i18n-messages-with-xml/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4">
      <meta itemprop="name" content="Mambo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="잠만보의 개발 블로그">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/spring/managing-i18n-messages-with-xml/" class="post-title-link" itemprop="url">XML로 다국어 메시지 관리하기</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">작성일</span>

              <time title="Post created: 2019-01-26 00:00:00" itemprop="dateCreated datePublished" datetime="2019-01-26T00:00:00Z">2019-01-26</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%EA%B0%9C%EB%B0%9C-%EC%9D%B4%EC%95%BC%EA%B8%B0/" itemprop="url" rel="index"><span itemprop="name">개발 이야기</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%EA%B0%9C%EB%B0%9C-%EC%9D%B4%EC%95%BC%EA%B8%B0/%EC%8A%A4%ED%94%84%EB%A7%81/" itemprop="url" rel="index"><span itemprop="name">스프링</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img data-src="https://javatutorial.net/wp-content/uploads/2017/12/spring-featured-image.png#center" alt=""></p>
<h2 id="개요">개요</h2>
<p>스프링이나 스프링 부트에서 다국어 메시지를 적용하기 위해서 Properties를 기본으로 사용했다.<br>
그러나, <code>messages-en.properties</code>와 <code>messages-ko.properties</code>와 같이 언어별로 프로퍼티 파일을 구분하고 키별로 메시지를 관리해야한다.</p>
<p>위와 같이 프로퍼티 파일로 메시지를 관리하다보면 해당 언어에서 특정 메시지 키를 사용하는지 파악하는게 어렵다. 만약, 잠만보처럼 회사 내 프로젝트를 진행하면서 메시지 키에 대한 정의 문서가 없는 경우 개발자가 메시지 키를 관리해야하므로 매번 검색해서 있는지 파악해야만 한다.</p>
<h2 id="기존-방식의-대안을-알아보자">기존 방식의 대안을 알아보자</h2>
<h4 id="YAML">YAML</h4>
<p>YML 파일을 사용해서 다국어를 설정하는 방법은 <a href="https://jmlim.github.io/spring/2018/11/28/spring-boot-Internationalization/" target="_blank" rel="noopener">이 블로그</a>를 통해 확인할 수 있다. 하지만, Properties와 표기 방식만 다를 뿐 언어별로 파일을 관리하는 것은 똑같다.</p>
<h4 id="XML">XML</h4>
<p>그래서 잠만보가 다니는 회사에서는 프로젝트의 다국어 메시지를 프로퍼티 파일이 아닌 XML 파일로 관리하도록 했다.</p>
<p>다음은 XML 구성의 간단한 예시이다.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">messages</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"menu.console"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ko_KR</span>&gt;</span>&lt;![CDATA[콘솔]]&gt;<span class="tag">&lt;/<span class="name">ko_KR</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">en_US</span>&gt;</span>&lt;![CDATA[Console]]&gt;<span class="tag">&lt;/<span class="name">en_US</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">messages</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="커스텀-리소스-번들을-만들자">커스텀 리소스 번들을 만들자</h2>
<p>일반적으로 <code>ResourceBundle</code>의 <code>getBundle</code>함수로 XML파일을 읽어 리소스 번들 인스턴스로 만들 수 있다.</p>
<h4 id="Resource-Bundle">Resource Bundle</h4>
<p><code>ResourceBundle</code>로 메시지 소스를 만드는 구조는 <a href="https://firstboos.tistory.com/entry/XML-%EA%B8%B0%EB%B0%98%EC%9D%98-Resource-Bundle-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0" target="_blank" rel="noopener">XML 기반의 Resource Bundle, PropertyPlaceHolder 사용하기</a>에서 확인할 수 있다.</p>
<p>다음과 같이 기존의 <code>프로퍼티 구조</code>를 그대로 사용해야 한다.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">properties</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://java.sun.com/dtd/properties.dtd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"menu.console"</span>&gt;</span>&lt;![CDATA[콘솔]]&gt;<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="Don’t-use-Properties-loadFromXML">Don’t use Properties.loadFromXML()</h5>
<p><code>XmlResourceBundle</code>에서 <code>Properties.loadFromXML()</code>으로 XML을 프로퍼티 기준으로 읽어드리면 안된다.</p>
<p>위에서 만든 XML 구성에 따라 XML파일을 읽어들여서 메시지 정보를 만들자</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlResourceBundle</span> <span class="keyword">extends</span> <span class="title">ResourceBundle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Map&lt;String, String&gt;&gt; messages;</span><br><span class="line">    <span class="keyword">private</span> Locale i18n;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">XmlResourceBundle</span><span class="params">(InputStream is, Locale i18n)</span> <span class="keyword">throws</span> IOException, ParserConfigurationException, SAXException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.i18n = i18n;</span><br><span class="line">        messages = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</span><br><span class="line">        DocumentBuilder builder = factory.newDocumentBuilder();</span><br><span class="line">        Document doc = builder.parse(is);</span><br><span class="line">        doc.getDocumentElement().normalize();</span><br><span class="line"></span><br><span class="line">        NodeList entries = doc.getElementsByTagName(<span class="string">"entry"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; entries.getLength(); i++) &#123;</span><br><span class="line">            Element entry = (Element) entries.item(i);</span><br><span class="line">            String key = entry.getAttribute(<span class="string">"key"</span>);</span><br><span class="line">            NodeList childNodes = entry.getChildNodes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; childNodes.getLength(); j++) &#123;</span><br><span class="line">                Node n = childNodes.item(j);</span><br><span class="line">                <span class="keyword">if</span> (n.getNodeType() == Node.ELEMENT_NODE) &#123;</span><br><span class="line">                    String locale = n.getNodeName();</span><br><span class="line">                    String message = n.getTextContent();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!messages.containsKey(locale)) &#123;</span><br><span class="line">                        messages.put(locale, <span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    messages.get(locale).put(key, message);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        IOUtils.closeQuietly(is);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">handleGetObject</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> messages.get(i18n).get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Enumeration&lt;String&gt; <span class="title">getKeys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Set&lt;String&gt; handleKeys = messages.keySet();</span><br><span class="line">        <span class="keyword">return</span> Collections.enumeration(handleKeys);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocale</span><span class="params">(Locale locale)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.i18n = locale;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  Map&lt;String, Map&lt;String, String&gt;&gt; getMessages() &#123;</span><br><span class="line">        <span class="keyword">return</span> messages;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  Map&lt;String, String&gt; <span class="title">getMessages</span><span class="params">(Locale locale)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> messages.get(locale.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>기존의 <code>.handleGetObject()</code>는 키 파라미터만 받으므로 메시지를 가져올때 언어를 지정할 수 없기에 <code>생성자에서 스트림과 언어를 받을 수 있게</code> 하였다.<br>
그리고 읽어드린 메시지 맵 인스턴스를 다시 받아 사용할 수 있도록 Getter 함수를 추가했다.</p>
<h4 id="XmlResourceBundleLoader">XmlResourceBundleLoader</h4>
<p><code>XmlResourceBundleLoader</code>는 <a href="http://www.java2s.com/Tutorial/Java/0220__I18N/XMLresourcebundle.htm" target="_blank" rel="noopener">이 포스트</a>에서 작성한 코드를 그대로 사용했다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlResourceBundleLoader</span> <span class="keyword">extends</span> <span class="title">ResourceBundle</span>.<span class="title">Control</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; formats = Collections.singletonList(<span class="string">"xml"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getFormats</span><span class="params">(String baseName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> formats;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResourceBundle <span class="title">newBundle</span><span class="params">(String baseName, Locale locale, String format, ClassLoader loader, <span class="keyword">boolean</span> reload)</span> <span class="keyword">throws</span> IllegalAccessException, InstantiationException, IOException </span>&#123;</span><br><span class="line">        ResourceBundle resourceBundle = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        String bundleName = toBundleName(baseName, locale);</span><br><span class="line">        String resourceName = toResourceName(bundleName, format);</span><br><span class="line"></span><br><span class="line">        URL url = loader.getResource(resourceName);</span><br><span class="line">        <span class="keyword">if</span> (url == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        URLConnection connection = url.openConnection();</span><br><span class="line">        <span class="keyword">if</span> (connection == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (reload) &#123;</span><br><span class="line">            connection.setUseCaches(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        InputStream stream = connection.getInputStream();</span><br><span class="line">        <span class="keyword">if</span> (stream == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>(BufferedInputStream bis = <span class="keyword">new</span> BufferedInputStream(stream)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(locale == Locale.ROOT) &#123;</span><br><span class="line">                locale = Locale.getDefault();</span><br><span class="line">            &#125;</span><br><span class="line">            resourceBundle = <span class="keyword">new</span> XmlResourceBundle(bis, locale);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SAXException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParserConfigurationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resourceBundle;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Usage">Usage</h4>
<p>위에서 만든 <code>XmlResourceBundle</code>과 <code>XmlResourceBundleLoader</code>를 이용해서 다음과 같이 메시지를 가져올 수 있게 된다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ResourceBundle bundle = ResourceBundle.getBundle(<span class="string">"messages"</span>, <span class="keyword">new</span> Locale(<span class="string">"en"</span>, <span class="string">"US"</span>), <span class="keyword">new</span> XmlResourceBundleLoader());</span><br><span class="line">    String message = bundle.getString(<span class="string">"menu.console"</span>);</span><br><span class="line">    LOG.info(<span class="string">"message: &#123;&#125;"</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="리소스-번들을-메시지-소스에서-사용하기">리소스 번들을 메시지 소스에서 사용하기</h2>
<p>그러면 스프링 메시지 소스에서 이 리소스 번들을 사용하려면 어떻게 해야하는지 알아보겠다. 일단 메시지가 필요할 때마다 리소스 번들을 만드는 것은 효율적이지 못하다. 리소스 번들은 한번만 만들어 메시지 소스에 적용하자.</p>
<h4 id="AbstractMessageSource">AbstractMessageSource</h4>
<p>사용자 정의 메시지 소스를 만들려면 <code>AbstractMessageSource</code>를 확장하면 된다. CustomMessageSource가 생성될 때 리소스 번들을 로드시키자.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomMessageSource</span> <span class="keyword">extends</span> <span class="title">AbstractMessageSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger LOG = LoggerFactory.getLogger(CustomMessageSource<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Map&lt;String, String&gt;&gt; messages = Maps.newHashMap();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Map&lt;String, MessageFormat&gt;&gt; formats = Maps.newHashMap();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CustomMessageSource instance;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomMessageSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        instance = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            load();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> <span class="keyword">throws</span> IllegalAccessException, IOException, InstantiationException </span>&#123;</span><br><span class="line">        ResourceBundle resourceBundle = ResourceBundle.getBundle(<span class="string">"messages"</span>, Locale.ROOT, <span class="keyword">new</span> XmlResourceBundleLoader());</span><br><span class="line"></span><br><span class="line">        XmlResourceBundle xmlResourceBundle = (XmlResourceBundle) resourceBundle;</span><br><span class="line">        <span class="keyword">this</span>.messages = xmlResourceBundle.getMessages();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 메시지 소스에서 지원하는 언어 목록</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getLocales</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Lists.newArrayList(messages.keySet());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> MessageFormat <span class="title">resolveCode</span><span class="params">(String code, Locale locale)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (formats) &#123;</span><br><span class="line">            <span class="comment">// 언어 포맷이 없을 경우 메시지 포맷을 새로 생성</span></span><br><span class="line">            <span class="keyword">if</span> (!formats.containsKey(locale.toString())) &#123;</span><br><span class="line">                formats.put(locale.toString(), <span class="keyword">new</span> HashMap&lt;String, MessageFormat&gt;());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Map&lt;String, MessageFormat&gt; map = formats.get(locale.toString());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 언어 포맷에 메시지 코드가 없으면 메시지 정보를 통해 포맷을 저장</span></span><br><span class="line">            <span class="keyword">if</span> (!map.containsKey(code)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!messages.containsKey(locale.toString())) &#123;</span><br><span class="line">                    locale = Locale.getDefault();</span><br><span class="line">                &#125;</span><br><span class="line">                Map&lt;String, String&gt; msgs = messages.get(locale.toString());</span><br><span class="line">                map.put(code, <span class="keyword">new</span> MessageFormat(msgs.containsKey(code) ? msgs.get(code) : code, locale));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> map.get(code);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">(String code)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getMessage(code, <span class="keyword">new</span> Object[<span class="number">0</span>], getLocale());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMessageException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> code;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">(String code, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getMessage(code, args, getLocale());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMessageException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> code;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">(String code, Object[] args, String defaultMessage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getMessage(code, args, defaultMessage, getLocale());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMessageException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> code;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">(String code, Locale locale)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getMessage(code, <span class="keyword">new</span> Object[<span class="number">0</span>], locale);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMessageException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> code;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Reload-ResourceBundle-For-Development">Reload ResourceBundle For Development</h4>
<p>애플리케이션을 개발하는 도중에는 메시지 소스가 계속 변경되어야하는 문제점이 있다. 물론 스프링 부트를 사용하고 있다면 <code>spring-boot-devtool</code>로 애플리케이션을 다시 실행할 수 있다.</p>
<p>하지만, 메시지 소스의 변경이 애플리케이션 동작에 특별한 영향을 끼치지 않으므로 다시 실행될 필요성은 없다. 애플리케이션을 다시 실행하지 않고 <code>메시지 XML 파일에 대한 변경을 감시</code>하여 다시 로드할 수 있도록 해보자.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomMessageSource</span> <span class="keyword">extends</span> <span class="title">AbstractMessageSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomMessageSource</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        instance = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            load();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ArrayUtils.contains(environment.getActiveProfiles(), <span class="string">"production"</span>)) &#123;</span><br><span class="line">            reload();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reload</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                File file = <span class="keyword">new</span> ClassPathResource(<span class="string">"i18n/messages.xml"</span>).getFile();</span><br><span class="line">                <span class="keyword">long</span> lastModified = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (lastModified &lt; file.lastModified()) &#123;</span><br><span class="line">                            load();</span><br><span class="line">                            LOG.info(<span class="string">"Reload MessageSource - &#123;&#125;"</span>, System.currentTimeMillis());</span><br><span class="line">                            lastModified = file.lastModified();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>굳이, 파일의 수정일을 비교하지 않아도 Java 7의 <code>WatchService</code>를 이용해도 <a href="https://www.baeldung.com/java-nio2-watchservice" target="_blank" rel="noopener">이 포스트</a>처럼 폴더를 감시할 수 있다.</p>
<h2 id="참조">참조</h2>
<ul>
<li><a href="https://docs.oracle.com/javase/tutorial/i18n/serviceproviders/resourcebundlecontrolprovider.html" target="_blank" rel="noopener">Installing a Custom Resource Bundle as an Extension</a></li>
<li><a href="http://www.java2s.com/Tutorial/Java/0220__I18N/XMLresourcebundle.htm" target="_blank" rel="noopener">XML resource bundle</a></li>
<li><a href="https://firstboos.tistory.com/entry/XML-%EA%B8%B0%EB%B0%98%EC%9D%98-Resource-Bundle-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0" target="_blank" rel="noopener">XML 기반의 Resource Bundle, PropertyPlaceHolder 사용하기</a></li>
<li><a href="http://www.fun25.co.kr/blog/java-xml-parser-example-documentbuilder" target="_blank" rel="noopener">[자바] XML 파싱 예제 - DocumentBuilder</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="ko">
    <link itemprop="mainEntityOfPage" href="https://kdevkr.github.io/spring/understanding-http-content-types/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4">
      <meta itemprop="name" content="Mambo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="잠만보의 개발 블로그">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/spring/understanding-http-content-types/" class="post-title-link" itemprop="url">초보 개발자가 이해하는 HTTP Content-Type</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">작성일</span>

              <time title="Post created: 2018-12-13 00:00:00" itemprop="dateCreated datePublished" datetime="2018-12-13T00:00:00Z">2018-12-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%EA%B0%9C%EB%B0%9C-%EC%9D%B4%EC%95%BC%EA%B8%B0/" itemprop="url" rel="index"><span itemprop="name">개발 이야기</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%EA%B0%9C%EB%B0%9C-%EC%9D%B4%EC%95%BC%EA%B8%B0/HTTP/" itemprop="url" rel="index"><span itemprop="name">HTTP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>HTTP는 하이퍼텍스트 통신 프로토콜으로 서버와 클라이언트가 서로 통신하기 위하여 요청과 응답을 받는다.</p>
<p>이때 클라이언트가 서버에게 요청할 때 보내는 데이터 유형과 어떻게 보내야 올바른지 알아보자.</p>
<p>REST 클라이언트 앱인 <code>Postman</code>은 다음과 같은 <code>Content-Type</code>을 제공한다.</p>
<p><img data-src="/spring/images/postman-content-type.png" alt=""></p>
<p>일반적인 HTML 폼으로 전송할 때는 <code>x-www-form-urlencoded</code> 또는 <code>multipart/form-data</code>로 전송된다고 알고 있다.</p>
<p>혹시 모르고 있었더라도 걱정하지 말아라. 이제 알았으면 된거다.</p>
<p>중요한 것은 왜 요청 바디가 <code>raw</code>일 때 <code>text/plain</code>, <code>application/json</code>, <code>application/xml</code>등을 선택할 수 있는지를 아는 것이다.</p>
<h2 id="Content-Type-헤더">Content-Type 헤더</h2>
<p>우리가 중점적으로 알아보아야 할 것은 <code>multipart/form-data</code>, <code>x-www-form-urlencoded</code>, <code>application/json</code>이다.</p>
<h4 id="application-json">application/json</h4>
<p>대부분의 API에서 활용하는 <code>Content-Type</code> 헤더로써 <code>application/json</code>으로 페이로드와 함께 HTTP 요청을 하게 되면 서버가 <code>JSON 타입</code>으로 변환해서 사용한다.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">    key1: <span class="string">'foo'</span>,</span><br><span class="line">    key2: <span class="string">'bar'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">axios(&#123;</span><br><span class="line">    method: <span class="string">'post'</span>,</span><br><span class="line">    url: <span class="string">'https://localhost:8080'</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    data: data</span><br><span class="line">&#125;).then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// handle success</span></span><br><span class="line">&#125;).catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// handle error</span></span><br><span class="line">&#125;).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// always</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>::: tip Spring MVC<br>
스프링 컨트롤러에서 @RequestMapping과 함께 @RequestBody로 요청 페이로드를 Jackson ObjectMapper를 통해 JSON으로 받을 수 있다.<br>
:::</p>
<h4 id="x-www-form-urlencoded">x-www-form-urlencoded</h4>
<p>위에서 일반적으로 서버로 요청할 때는 <code>x-www-form-urlencoded</code>를 <code>Content-Type</code> 헤더로 명시하여 전송한다고 말했다.</p>
<p>그러면 <code>x-www-form-urlencoded</code>를 <code>Content-Type</code>으로 사용할 경우 요청 페이로드는 어떻게 구성되는지 살펴보자.</p>
<p>다음은 모질라 웹 레퍼런스 문서에서 제공하는 예시이다.</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: foo.com</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 13</span><br><span class="line"></span><br><span class="line">say=Hi&amp;to=Mom</span><br></pre></td></tr></table></figure>
<p><code>say=Hi&amp;to=Mom</code>가 위 요청에 대한 페이로드 부분이다.</p>
<p>이 페이로드는 키와 값을 =와 함께 표현하고 &amp;의 묶음으로 표현하는게 <code>x-www-form-urlencoded</code>의 데이터 구조이다.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">axios.defaults.headers.post[<span class="string">'Content-Type'</span>] = <span class="string">'application/x-www-form-urlencoded'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">    key1: <span class="string">'foo'</span>,</span><br><span class="line">    key2: <span class="string">'bar'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">axios(&#123;</span><br><span class="line">    method: <span class="string">'post'</span>,</span><br><span class="line">    url: <span class="string">'https://localhost:8080'</span>,</span><br><span class="line">    data: data</span><br><span class="line">&#125;).then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// handle success</span></span><br><span class="line">&#125;).catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// handle error</span></span><br><span class="line">&#125;).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// always</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="스프링-MVC에서의-모델-바인딩">스프링 MVC에서의 모델 바인딩</h2>
<p>사실 이 글을 쓰는 이유는 초보 개발자 입장에서 <code>스프링 MVC</code>에서 HTTP 요청 데이터에 대하여 어떻게 <code>모델로 바인딩</code>을 하는지 알려주기 위해서이다.</p>
<p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#beans-beans-conventions" target="_blank" rel="noopener">스프링 공식 레퍼런스 : Setting and Getting Basic and Nested Properties</a>에서는 프로퍼티를 가져오거나 설정하는 것을 <code>getPropertyValue</code>와 <code>getPropertyValues</code> 그리고 <code>setPropertyValue</code>와 <code>setPropertyValues</code> 메소드로 수행한다고 설명한다.</p>
<p>그리고 자바빈 스펙에 따라 <code>오브젝트의 프로퍼티로 나타내는 규칙</code>도 같이 알려주고 있다.</p>
<h5 id="프로퍼티-예시">프로퍼티 예시</h5>
<ul>
<li>name<br>
Indicates the property name that corresponds to the getName() or isName() and setName(…) methods.</li>
<li><a href="http://account.name" target="_blank" rel="noopener">account.name</a><br>
Indicates the nested property name of the property account that corresponds to (for example) the getAccount().setName() or getAccount().getName() methods.</li>
<li>account[2]<br>
Indicates the third element of the indexed property account. Indexed properties can be of type array, list, or other naturally ordered collection.</li>
<li>account[COMPANYNAME]<br>
Indicates the value of the map entry indexed by the COMPANYNAME key of the account Map property.</li>
</ul>
<p>간단하게 살펴보면 account 클래스의 <code>name 프로퍼티</code>를 바인딩할 경우에는 <code>account.name</code>이라고 표현되어야하고 <code>account[2]</code>라고 표현되면 3번째 <code>인덱스 프로퍼티</code>로 나타내며 <code>account[COMPANYNAME]</code>이면 <code>COMPANYNAME</code>을 키로 가지는 <code>Map 프로퍼티</code>인 것이다.</p>
<h4 id="ModelAttribute">@ModelAttribute</h4>
<p>이 <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-ann-modelattrib-method-args" target="_blank" rel="noopener"><code>@ModelAttribute</code></a> 어노테이션은 컨트롤러에서 리퀘스트 파라미터를 쉽게 빈 오브젝트로 바인딩하기 위해 사용한다.</p>
<p>그런데 다음과 같이 빈 오브젝트에 <code>맵 프로퍼티</code>가 존재할 경우 <code>@ModelAttribute</code>로 데이터 바인딩을 시도할 때 <code>주의</code>해야한다. 앞서 <code>x-www-form-urlencoded</code>의 데이터 구조를 살펴본 것은 바로 이 때문이다.</p>
<p>만약에 빈 오브젝트에 메타데이터로 맵 오브젝트를 담고 싶다고 가정할 때 서버로 맵 오브젝트를 보내어야하는 요구사항이 생긴다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; metadata;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>그런데 위 자바 빈 스펙 규칙에 따르면 맵 프로퍼티는 <code>metadata[address][location]</code>와 같이 표현되어야 한다.</p>
<p>그런데 서버로 요청되는 페이로드가 <code>metadata[address][location]=value</code>가 되어버리면 metadata 프로퍼티의 address가 배열의 인덱스인지 맵의 인덱스 키인지 <code>구별할 수 없다</code></p>
<p>결국 <a href="https://homoefficio.github.io/2017/04/25/Spring-%EA%B0%80-%ED%8F%AC%ED%95%A8%EB%90%9C-URL-%ED%8C%8C%EB%9D%BC%EB%AF%B8%ED%84%B0-%EB%B0%94%EC%9D%B8%EB%94%A9-%ED%95%98%EA%B8%B0/" target="_blank" rel="noopener">관련 포스트</a>처럼 다음과 같은 오류가 발생할 것이다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Property referenced in indexed property path <span class="string">'metadata[address][location]'</span> is neither an array nor a List nor a Map</span><br></pre></td></tr></table></figure>
<p>그러면 요청 페이로드가 <a href="https://gist.github.com/codesnik/1433581" target="_blank" rel="noopener">.형식으로 데이터를 변환</a>되어 <code>metadata.address.location=value</code>로 전송된다면 올바르게 바인딩 할 수 있을까?</p>
<p>답은 아니다!</p>
<p>바인딩이 되지 않는다.</p>
<p>맵 프로퍼티로 바인딩하기 위해서는 person.metadata[address]이어야만 하기 때문이다.</p>
<h4 id="복잡한-페이로드라면-application-json을-사용하자">복잡한 페이로드라면 application/json을 사용하자.</h4>
<p>따라서, 복잡한 형태로 데이터가 구성되어야 한다면<code>x-www-form-urlencoded</code>가 아니라 <code>application/json</code>으로 명시하여 서버가 처리할 수 있도록 해야하는게 좋다.</p>
<p>그리고 서버 API도 복잡한 형태의 오브젝트를 페이로드로 받도록 요구된다면 애초에 <code>application/json</code>만 요청할 수 있도록 하자.</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"metadata"</span>:&#123;<span class="attr">"address"</span>:&#123;<span class="attr">"location"</span>:<span class="string">"value"</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>물론 스프링이 <code>BeanWrapper</code> 또는 <code>DataBinder</code>를 구현하는 것도 하나의 방법이긴 하다.</p>
<p>하지만, 모델 바인딩을 위한 코드를 API와 오브젝트별로 작성해야 하기에 배보다 배꼽이 더 커질수가 있다.</p>
<p>그리고 <code>@Valid</code>와 <code>@Validated</code>를 이용한 벨리데이션을 쉽게 적용할 수 없고 <code>Validator</code>도 추가로 직접 호출해서 오브젝트를 <code>검증</code>해야 한다.</p>
<h2 id="참조">참조</h2>
<ul>
<li><a href="https://medium.com/@mohamedraja_77/content-type-x-www-form-urlencoded-form-data-and-json-e17c15926c69" target="_blank" rel="noopener">Content Type : x-www-form-urlencoded, form-data and json</a></li>
<li><a href="https://dev.to/sidthesloth92/understanding-html-form-encoding-url-encoded-and-multipart-forms-3lpa" target="_blank" rel="noopener">Understanding HTML Form Encoding: URL Encoded and Multipart Forms</a></li>
<li><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#validation" target="_blank" rel="noopener">Validation, Data Binding, and Type Conversion</a></li>
<li><a href="http://1ambda.github.io/content-type-vs-accept-http-header/" target="_blank" rel="noopener">Content-Type vs Accept, HTTP Header</a></li>
<li><a href="https://gist.github.com/jays1204/703297eb0da1facdc454" target="_blank" rel="noopener">Http Method는 POST, Content-Type이 application/x-www-form-urlencoded인 경우 body를 encoding하는게 맞을까?</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="ko">
    <link itemprop="mainEntityOfPage" href="https://kdevkr.github.io/spring/understanding-cache-control/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4">
      <meta itemprop="name" content="Mambo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="잠만보의 개발 블로그">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/spring/understanding-cache-control/" class="post-title-link" itemprop="url">초보 개발자가 이해하는 캐시 정책</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">작성일</span>

              <time title="Post created: 2018-06-09 21:21:18" itemprop="dateCreated datePublished" datetime="2018-06-09T21:21:18Z">2018-06-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%EA%B0%9C%EB%B0%9C-%EC%9D%B4%EC%95%BC%EA%B8%B0/" itemprop="url" rel="index"><span itemprop="name">개발 이야기</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="들어가며">들어가며</h2>
<p>웹 애플리케이션에서 서버가 클라이언트에게 제공하는 정적 리소스들의 캐시 정책을 이해하는 것은 굉장히 중요한 부분이라고 생각합니다.</p>
<h2 id="The-Cache-Control-Header">The Cache-Control Header</h2>
<p><code>Cache-Control</code> 헤더는 서버와 브라우저 사이의 <code>캐시 정책</code>이라고 할 수 있다. 이 헤더값에 따라서 브라우저가 해당 파일을 캐시해야하는지 언제 다시 서버에게 요청하는지를 결정하게 된다.</p>
<h3 id="Cache-Control-no-cache-그리고-no-store">Cache-Control: no-cache 그리고 no-store</h3>
<p>캐시 정책을 이해하기 위해서는 <code>no-cache</code>와 <code>no-store</code>의 차이점을 알아야 한다.</p>
<h4 id="no-cache">no-cache</h4>
<p><code>no-cache</code>는 브라우저가 서버의 응답을 캐시할지 스스로 결정할 수 있다. 하지만, 캐시된 정보가 해당 서버에서 제공한 것인지는 요청을 하게 된다.</p>
<h4 id="no-store">no-store</h4>
<p><code>no-store</code>는 브라우저가 서버의 응답을 캐시하지 못하도록 한다. 이 말은 반드시 매번 서버에 요청해야만 한다는 의미이다.</p>
<h2 id="스프링-MVC-캐시-정책">스프링 MVC 캐시 정책</h2>
<p>스프링 MVC에서 캐시 정책을 설정하기 위해서는 어떻게 해야할까?<br>
다음 글들을 참고해보자.</p>
<ul>
<li><a href="https://www.lesstif.com/pages/viewpage.action?pageId=20775788" target="_blank" rel="noopener">browser가 caching 하지 않게 하는 http header</a></li>
<li><a href="https://support.microsoft.com/ko-kr/help/234067/how-to-prevent-caching-in-internet-explorer" target="_blank" rel="noopener">Internet Explorer에서 캐싱을 방지하는 방법</a></li>
<li><a href="http://cyberx.tistory.com/9" target="_blank" rel="noopener">더 빠른 웹을 위하여 - 웹 캐쉬</a></li>
</ul>
<p>다음 코드는 캐시 정책이 설정되지 않는다. 무엇이 문제일까.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  	<span class="meta">@Override</span></span><br><span class="line">  	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">  		registry.addResourceHandler(<span class="string">"/**"</span>)</span><br><span class="line">                  .setCachePeriod(<span class="number">0</span>)</span><br><span class="line">                  .addResourceLocations(<span class="string">"classpath:/META-INF/resources/"</span>,<span class="string">"classpath:/resources/"</span>,<span class="string">"classpath:/static/"</span>,<span class="string">"classpath:/public/"</span>)</span><br><span class="line">                  .resourceChain(<span class="keyword">true</span>)</span><br><span class="line">                  .addResolver(<span class="keyword">new</span> PathResourceResolver()).addResolver(<span class="keyword">new</span> GzipResourceResolver());</span><br><span class="line">  	&#125;</span><br><span class="line"></span><br><span class="line">  	<span class="meta">@Override</span></span><br><span class="line">  	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">      registry.addInterceptor(<span class="keyword">new</span> HandlerInterceptorAdapter() &#123;</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">              response.setHeader(<span class="string">"Cache-Control"</span>,<span class="string">"private, no-cache, no-store, must-revalidate"</span>);</span><br><span class="line">              response.setHeader(<span class="string">"Pragma"</span>,<span class="string">"no-cache"</span>);</span><br><span class="line">              response.setDateHeader(<span class="string">"Expires"</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (request.getProtocol().equals(<span class="string">"HTTP/1.1"</span>)) &#123;</span><br><span class="line">                  response.setHeader(<span class="string">"Cache-Control"</span>, <span class="string">"no-cache"</span>);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      registry.addInterceptor(webContentInterceptor());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="meta">@Bean</span></span><br><span class="line">  	<span class="function"><span class="keyword">public</span> WebContentInterceptor <span class="title">webContentInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  		WebContentInterceptor webContentInterceptor = <span class="keyword">new</span> WebContentInterceptor();</span><br><span class="line">  		webContentInterceptor.setCacheSeconds(<span class="number">0</span>);</span><br><span class="line">  		<span class="keyword">return</span> webContentInterceptor;</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>혹시 다음 부분에서 문제가 있었을까?</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">registry.addInterceptor(<span class="keyword">new</span> HandlerInterceptorAdapter() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        response.setHeader(<span class="string">"Cache-Control"</span>,<span class="string">"private, no-cache, no-store, must-revalidate"</span>); <span class="comment">// HTTP/1.1</span></span><br><span class="line">        response.setHeader(<span class="string">"Pragma"</span>,<span class="string">"no-cache"</span>); <span class="comment">// HTTP/1.0</span></span><br><span class="line">        response.setDateHeader(<span class="string">"Expires"</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (request.getProtocol().equals(<span class="string">"HTTP/1.1"</span>)) &#123;</span><br><span class="line">            response.setHeader(<span class="string">"Cache-Control"</span>, <span class="string">"no-cache"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>스프링에서 브라우저 캐시와 관련된 정보를 검색하면 위와 같이 설정하는 것을 많이 찾을 수 있다. 그런데 사실 스프링 프레임워크에서 캐시 정책을 적용하기 위해서는 <code>WebContentInterceptor</code>라는 것을 이용해야 한다.</p>
<p>이상하다. 위 코드에서 <code>WebContentInterceptor</code>는 이미 빈으로 등록하고 있다. 더구나 <code>setCacheSeconds(0)</code>이다.</p>
<h4 id="WebContentGenerator-setCacheSeconds">WebContentGenerator.setCacheSeconds</h4>
<p>WebContentGenerator의 setCacheSeconds 함수에 대해서 살펴보면 다음과 같이 설명하고 있다.</p>
<p>::: tip WebContentGenerator.setCacheSeconds<br>
Cache content for the given number of seconds, by writing cache-related HTTP headers to the response:</p>
<p>seconds == -1 (default value) : no generation cache-related headers<br>
seconds == 0 : “Cache-Control: no-store” will prevent caching<br>
seconds &gt; 0 : “Cache-Control: max-age=seconds” will ask to cache content<br>
:::</p>
<p>CacheSeconds가 -1이면 캐시와 관련된 헤더를 만들지 않고 0이면 <code>Cache-Control: no-store</code>로 캐시를 막는다.<br>
이미 <code>setCacheSeconds(0)</code>인데 그럼 무엇때문에 캐시를 했던 것일까</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">registry.addInterceptor(<span class="keyword">new</span> HandlerInterceptorAdapter() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        response.setHeader(<span class="string">"Cache-Control"</span>,<span class="string">"private, no-cache, no-store, must-revalidate"</span>); <span class="comment">// HTTP/1.1</span></span><br><span class="line">        response.setHeader(<span class="string">"Pragma"</span>,<span class="string">"no-cache"</span>); <span class="comment">// HTTP/1.0</span></span><br><span class="line">        response.setDateHeader(<span class="string">"Expires"</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ERROR!</span></span><br><span class="line">        <span class="keyword">if</span> (request.getProtocol().equals(<span class="string">"HTTP/1.1"</span>)) &#123;</span><br><span class="line">            response.setHeader(<span class="string">"Cache-Control"</span>, <span class="string">"no-cache"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>자세히 살펴보면 요청 프로토콜이 HTTP/1.1일때 <code>Cache-Control: no-cache</code>를 지정한다는 것이 잘못된 코드이다. 프로토콜에 따라 무조건 적용하는 것이 아니라 요청에 의한 응답 리소스에 따라 캐시 정책을 지정해야 한다.</p>
<blockquote>
<p><code>Pragma : no-cache</code> 도 HTTP/1.0의 표준 스펙은 아니다. 다만, Cache-Control을 지원하지 않으므로 대안으로 사용하는 것일 뿐이다.</p>
</blockquote>
<p>그래서 스프링 MVC는 <code>인터셉터</code>를 통해 헤더에 직접 지정하지 않고 <code>WebContentInterceptor</code>를 제공하여 캐시 정책을 등록하게 도와준다.</p>
<p>그러므로 스프링은 WebContentInterceptor을 제공하고 캐시 전략을 등록하게 도와주는 것입니다.</p>
<blockquote>
<p><code>인터셉터</code>에서 캐시 정책을 지정하는 부분을 지우자.</p>
</blockquote>
<p>최종적으로 WebContentInterceptor에 의해 캐시 방지 처리된 페이지 결과는 다음과 같다.</p>
<p><code>Chrome</code></p>
<figure class="highlight zsh"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 200</span><br><span class="line">Cache-Control: no-store, must-revalidate, proxy-revalidate</span><br><span class="line">Content-Language: ko-KR</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Date: Sat, 09 Jun 2018 07:54:50 GMT</span><br><span class="line">Server: nginx/1.10.3</span><br><span class="line">X-Application-Context: application:production:5000</span><br><span class="line">Content-Length: 2049</span><br><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure>
<p><code>IE 11</code></p>
<figure class="highlight zsh"><table><tr><td class="code"><pre><span class="line">Cache-Control: no-store, must-revalidate, proxy-revalidate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Language: ko</span><br><span class="line">Content-Length: 2049</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Date: Sat, 09 Jun 2018 08:24:47 GMT</span><br><span class="line">Server: nginx/1.10.3</span><br><span class="line">X-Application-Context: application:production:5000</span><br></pre></td></tr></table></figure>
<h4 id="Path별-캐시-정책-지정하기">Path별 캐시 정책 지정하기</h4>
<p>스프링 MVC에서 Path별 캐시 정책을 지정할 수 있다. <code>WebContentInterceptor.setCacheMappings(Properties cacheMappings</code>와 <code>WebContentInterceptor.addCacheMapping(CacheControl cacheControl, String... paths)</code>으로 지원한다.</p>
<h2 id="샘플-애플리케이션에-캐시-정책을-지정해보자">샘플 애플리케이션에 캐시 정책을 지정해보자</h2>
<p>스프링 MVC에서 캐시 정책을 지정하는 방법을 알아보았다. 이제는 실제로 캐시 정책을 지정해보도록 하겠다.</p>
<p>먼저, <code>캐시 정책을 지정하기 위한 샘플 애플리케이션</code>은 다음과 같이 구성된다.</p>
<p><strong>/</strong><br>
index.html으로 렌더링한 페이지를 응답한다.</p>
<p><strong>/main</strong><br>
main.html으로 렌더링한 페이지를 응답한다.</p>
<p><strong>/api/users</strong><br>
샘플 애플리케이션의 사용자 목록을 응답하는 API으로 JSON 형식으로 응답된다.</p>
<p><strong>/resources/index.js</strong><br>
/resources/index.js 경로로 index.js라는 정적 리소스를 응답한다.</p>
<p>인터셉터에서는 <code>Cache-Control</code> 헤더를 지정하지 않고 응답하기전에 <code>Cache-Control</code>의 헤더를 확인만 한다.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Configuration</span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MvcConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger console = LoggerFactory.getLogger(MvcConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addInterceptor(webContentInterceptor());</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> HandlerInterceptorAdapter() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                console.info(<span class="string">"---- Cache-Control ----"</span>);</span><br><span class="line">                console.info(<span class="string">"request : &#123;&#125;"</span>, request.getHeader(<span class="string">"Cache-Control"</span>));</span><br><span class="line">                console.info(<span class="string">"response : &#123;&#125;"</span>, response.getHeader(<span class="string">"Cache-Control"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Serve For Static Resources</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addResourceHandler(<span class="string">"/resources/**"</span>)</span><br><span class="line">                .addResourceLocations(<span class="string">"classpath:/static/"</span>)</span><br><span class="line"><span class="comment">//                .setCachePeriod(3600)</span></span><br><span class="line">                .setCacheControl(CacheControl.maxAge(<span class="number">1</span>, TimeUnit.HOURS))</span><br><span class="line">                .resourceChain(<span class="keyword">true</span>)</span><br><span class="line">                .addResolver(<span class="keyword">new</span> GzipResourceResolver())</span><br><span class="line">                .addResolver(<span class="keyword">new</span> PathResourceResolver());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Serve For Dynamic Response</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WebContentInterceptor <span class="title">webContentInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        WebContentInterceptor webContentInterceptor = <span class="keyword">new</span> WebContentInterceptor();</span><br><span class="line">        webContentInterceptor.addCacheMapping(CacheControl.noStore().mustRevalidate().proxyRevalidate().cachePrivate(), <span class="string">"/api/**"</span>);</span><br><span class="line"><span class="comment">//        webContentInterceptor.addCacheMapping(CacheControl.noCache(), "/main/**");</span></span><br><span class="line">        webContentInterceptor.addCacheMapping(CacheControl.noStore(), <span class="string">"/main/**"</span>);</span><br><span class="line">        <span class="keyword">return</span> webContentInterceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="index-html의-캐시-정책">index.html의 캐시 정책</h3>
<p>동적 리소스인 index.html은 아무런 캐시 전략을 설정하지 않았다.</p>
<p><img data-src="/images/spring/index-public.png" alt=""></p>
<p>index.html을 응답받은 브라우저는 응답 헤더에 <code>Cache-Control</code>이 없으므로 스스로 판단하여 캐시 정책을 설정하게 된다.</p>
<p>다음은 <code>/</code>에서 <code>/main</code>으로 이동한 뒤에 브라우저의 뒤로가기 기능으로 <code>/</code>로 되돌아 갔을 때의 <code>index.html</code>의 응답 헤더이다.</p>
<p><img data-src="/images/spring/index-disk-cache.png" alt=""></p>
<p>브라우저는 <code>from disk cache</code> 디스크에 저장된 캐시 파일로 index.html을 보여주고 있다.</p>
<h3 id="main-html의-캐시-정책">main.html의 캐시 정책</h3>
<p><code>동적 리소스</code>인 main.html은 <code>no-store</code> 캐시 정책을 설정하였다.</p>
<p>브라우저는 main.html에 대하여 캐시 정책을 세우지 않고 매번 서버에 요청한다.</p>
<p><img data-src="/images/spring/main-no-store.png" alt=""></p>
<h3 id="index-js의-캐시-정책">index.js의 캐시 정책</h3>
<p>index.js와 같은 정적 리소스의 경우에는 <code>ResourceHandlerRegistry</code>에서 캐시 정책을 지정할 수 있다. <code>ResourceHandlerRegistry.setCacheControl</code>으로 <code>CacheControl.maxAge(1, TimeUnit.HOURS)</code>을 지정하여 index.js의 캐시 기간은 1시간이 된다.</p>
<p><img data-src="/images/spring/index-js-memory-cache.png" alt=""></p>
<p>위 처럼 <code>max-age</code>를 설정하면 해당 리소스의 <code>Last-Modified 헤더</code>에 따라 캐시할 기간이 설정되어지며 기간이 지났으면 다시 서버에서 요청한다.</p>
<h2 id="참조">참조</h2>
<ul>
<li><a href="https://www.incapsula.com/cdn-guide/glossary/cache-control.html" target="_blank" rel="noopener">Cache-Control</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="이전 페이지"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="다음 페이지"></i></a>
  </nav>



        </div>
        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mambo</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.main-inner',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

document.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>


  















    <div id="pjax">
  

  
<script>
function getExif(target) {
  const tags = {"FocalLength":"{value}mm","FNumber":"f/{value}","ExposureTime":"{value}s"};
  EXIF.getData(target, function() {
    let result = [];
    for (let [key, value] of Object.entries(tags)) {
      let data = EXIF.getTag(this, key);
      if (key === 'ExposureTime' && data <= 0.25) {
        data = '1/' + parseInt(1 / data);
      }
      if (data) result.push(value.replace('{value}', data));
    }
    if (result.length > 0) {
      const box = document.createElement('div');
      target.wrap(box);
      box.classList.add('exif-container');
      box.insertAdjacentHTML('beforeend', `<div class="exif-metabar"><span>${result.join(' ')}</span></div>`);
    }
  });
}

[...document.querySelectorAll('.post-body img')].forEach(element => {
  if (element.complete) getExif(element);
  // `lazyload` compatible
  element.addEventListener('load', () => {
    getExif(element);
  });
});
</script>

    </div>
</body>
</html>
