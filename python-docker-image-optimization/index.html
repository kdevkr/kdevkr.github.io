<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon/favicon.ico" color="#222">
  <meta name="google-site-verification" content="LMcddVW6xLBS7X1htGQ3duOIEmVp4ljku8sd3UuIcBg">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Sans+KR:300,300italic,400,400italic,700,700italic%7CGmarket+Sans:300,300italic,400,400italic,700,700italic%7CRIDIBatang:300,300italic,400,400italic,700,700italic%7CJetbrains+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-loading-bar.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"kdevkr.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"width":240,"scrollpercent":true,"b2t":true},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta name="description" content="안녕하세요 Mambo 입니다. 오늘은 파이썬 도커 이미지에 대한 최적화에 대해서 알아봅니다. 회사에서 운영중인 서비스의 분석 서버는 파이썬으로 작성된 플래스크 기반의 웹 애플리케이션입니다. 여러가지 방식으로 배포하던 애플리케이션을 Elastic Beanstalk 환경을 통해 배포하는 구조로 통합하기 위해서 파이썬 애플리케이션을 Elastic Beanstal">
<meta property="og:type" content="article">
<meta property="og:title" content="파이썬 도커 이미지 최적화">
<meta property="og:url" content="https://kdevkr.github.io/python-docker-image-optimization/index.html">
<meta property="og:site_name" content="Mambo">
<meta property="og:description" content="안녕하세요 Mambo 입니다. 오늘은 파이썬 도커 이미지에 대한 최적화에 대해서 알아봅니다. 회사에서 운영중인 서비스의 분석 서버는 파이썬으로 작성된 플래스크 기반의 웹 애플리케이션입니다. 여러가지 방식으로 배포하던 애플리케이션을 Elastic Beanstalk 환경을 통해 배포하는 구조로 통합하기 위해서 파이썬 애플리케이션을 Elastic Beanstal">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://kdevkr.github.io/images/posts/python-docker-image-optimization/python-docker-image-optimization-01.png">
<meta property="og:image" content="https://kdevkr.github.io/images/posts/python-docker-image-optimization/python-docker-image-optimization-02.png">
<meta property="og:image" content="https://kdevkr.github.io/images/posts/python-docker-image-optimization/python-docker-image-optimization-03.png">
<meta property="og:image" content="https://kdevkr.github.io/images/posts/python-docker-image-optimization/python-docker-image-optimization-04.png">
<meta property="article:published_time" content="2021-09-09T00:00:00.000Z">
<meta property="article:modified_time" content="2021-12-26T12:49:03.964Z">
<meta property="article:author" content="Mambo">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="Python">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kdevkr.github.io/images/posts/python-docker-image-optimization/python-docker-image-optimization-01.png">


<link rel="canonical" href="https://kdevkr.github.io/python-docker-image-optimization/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://kdevkr.github.io/python-docker-image-optimization/","path":"python-docker-image-optimization/","title":"파이썬 도커 이미지 최적화"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>파이썬 도커 이미지 최적화 | Mambo</title>
  
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-93954323-1","only_pageview":true}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Mambo" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Mambo</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Today I Learned 🔥</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fas fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fas fa-archive fa-fw"></i>Archives<span class="badge">37</span></a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fas fa-user fa-fw"></i>About</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%ED%8C%8C%EC%9D%B4%EC%8D%AC-%EB%8F%84%EC%BB%A4-%EC%9D%B4%EB%AF%B8%EC%A7%80"><span class="nav-number">1.</span> <span class="nav-text">파이썬 도커 이미지</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EB%A1%9C%EC%BB%AC-%ED%99%98%EA%B2%BD%EC%9D%98-Dockerfile"><span class="nav-number">1.1.</span> <span class="nav-text">로컬 환경의 Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%ED%84%B0%EB%AC%B4%EB%8B%88%EC%97%86%EB%8A%94-%EB%B9%8C%EB%93%9C%EB%90%9C-%EC%9D%B4%EB%AF%B8%EC%A7%80-%ED%81%AC%EA%B8%B0"><span class="nav-number">1.2.</span> <span class="nav-text">터무니없는 빌드된 이미지 크기</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%ED%8C%8C%EC%9D%B4%EC%8D%AC-%EA%B8%B0%EB%B0%98-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%B3%80%EA%B2%BD"><span class="nav-number">1.3.</span> <span class="nav-text">파이썬 기반 이미지 변경</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dockerfile-%ED%82%A4%EC%9B%8C%EB%93%9C-%EC%88%9C%EC%84%9C-%EB%B3%80%EA%B2%BD"><span class="nav-number">1.4.</span> <span class="nav-text">Dockerfile 키워드 순서 변경</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Gunicorn-%EC%84%A4%EC%A0%95-%EA%B0%9C%EC%84%A0"><span class="nav-number">1.5.</span> <span class="nav-text">Gunicorn 설정 개선</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EC%B0%B8%EA%B3%A0"><span class="nav-number">2.</span> <span class="nav-text">참고</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Mambo"
      src="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4">
  <p class="site-author-name" itemprop="name">Mambo</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">52</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/kdevkr" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kdevkr" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:kdevkr@gmail.com" title="E-Mail → mailto:kdevkr@gmail.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ko" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="Back to top">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://kdevkr.github.io/python-docker-image-optimization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4">
      <meta itemprop="name" content="Mambo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mambo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          파이썬 도커 이미지 최적화
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-09-09 00:00:00" itemprop="dateCreated datePublished" datetime="2021-09-09T00:00:00Z">2021-09-09</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>안녕하세요 Mambo 입니다.</p>
<p>오늘은 파이썬 도커 이미지에 대한 최적화에 대해서 알아봅니다. 회사에서 운영중인 서비스의 분석 서버는 파이썬으로 작성된 플래스크 기반의 웹 애플리케이션입니다. 여러가지 방식으로 배포하던 애플리케이션을 Elastic Beanstalk 환경을 통해 배포하는 구조로 통합하기 위해서 파이썬 애플리케이션을 Elastic Beanstalk의 도커 플랫폼으로 전환하기 위한 작업을 진행했습니다. 파이썬 플랫폼이 아닌 도커 플랫폼을 활용하는 이유는 도커 이미지로 구동하는 쿠버네티스 환경을 준비하고 있기 때문으로 동일하게 도커 이미지를 사용하여 애플리케이션을 배포하고자 결정하였습니다.</p>
<h2 id="파이썬-도커-이미지"><a href="#파이썬-도커-이미지" class="headerlink" title="파이썬 도커 이미지"></a>파이썬 도커 이미지</h2><p>파이썬으로 작성된 애플리케이션을 도커 이미지화하는 과정에서 발견한 문제에 대하여 몇가지 개선 작업을 진행한 것을 공유하고자 합니다. </p>
<h3 id="로컬-환경의-Dockerfile"><a href="#로컬-환경의-Dockerfile" class="headerlink" title="로컬 환경의 Dockerfile"></a>로컬 환경의 Dockerfile</h3><p>먼저, 로컬 환경에서 애플리케이션을 구동해보기 위해서 간단하게 작성하여 사용중이던 Dockerfile을 다시 만들어야 했습니다.</p>
<figure class="highlight docker"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.7</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> ./src /www</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /www</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span></span><br><span class="line"><span class="keyword">ENV</span> <span class="keyword">ENV</span> <span class="string">&quot;dev&quot;</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> python3 -m venv .venv</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chmod +x ./.venv/bin/activate</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ./.venv/bin/activate</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> python3 -m pip install --upgrade pip</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install -r requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install Flask</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> gunicorn main:app -b 0.0.0.0:5000 -w 1 -t=50 -k gevent --preload</span></span><br></pre></td></tr></table></figure>

<p>Dockerfile이 정리되어있지 않고 불필요한 명령어를 수행하는 것도 있지만 제일 크다고 생각한 문제점은 <a target="_blank" rel="noopener" href="https://gunicorn.org/">Gunicorn WSGI 서버</a>에 대해 다양한 옵션을 적용하기 힘들다는 점이었습니다. 웹 요청을 애플리케이션 마스터 프로세스에 전달하는 워커 프로세스의 개수를 지정하는 옵션 만큼은 이미지를 빌드하는 시점 이후에도 쉽게 변경할 수 있게 적용하는게 좋을 것 같았습니다.</p>
<figure class="highlight docker"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /app/logs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> PORT=<span class="number">8000</span></span><br><span class="line"><span class="keyword">ARG</span> MAIN=application</span><br><span class="line"><span class="keyword">ARG</span> MAIN_APP=application</span><br><span class="line"><span class="keyword">ARG</span> WORKERS=application</span><br><span class="line"><span class="keyword">ARG</span> WORKERS=<span class="number">2</span></span><br><span class="line"><span class="keyword">ARG</span> WORKERCLASS=gevent</span><br><span class="line"><span class="keyword">ARG</span> TIMEOUT=<span class="number">60</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> PORT $&#123;PORT&#125;</span><br><span class="line"><span class="keyword">ENV</span> MAIN $&#123;MAIN&#125;</span><br><span class="line"><span class="keyword">ENV</span> MAIN_APP $&#123;MAIN_APP&#125;</span><br><span class="line"><span class="comment"># This number should generally be between 2-4 workers per core in the server.</span></span><br><span class="line"><span class="keyword">ENV</span> WORKERS $&#123;WORKERS&#125;</span><br><span class="line"><span class="comment"># one of sync, eventlet, gevent, tornado, gthread</span></span><br><span class="line"><span class="keyword">ENV</span> WORKERCLASS $&#123;WORKERCLASS&#125;</span><br><span class="line"><span class="keyword">ENV</span> TIMEOUT $&#123;TIMEOUT&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> entrypoint.sh entrypoint.sh</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> src/ .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install -r requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install gunicorn gevent</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> $&#123;PORT&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://docs.gunicorn.org/en/stable/run.html</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> [<span class="string">&quot;chmod&quot;</span>, <span class="string">&quot;+x&quot;</span>, <span class="string">&quot;./entrypoint.sh&quot;</span>]</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> <span class="string">&quot;./entrypoint.sh&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>다시 작성한 Dockerfile에서는 <strong>ARG 키워드로 빌드 시점에 옵션을 적용</strong>하고 <strong>ENV 키워드를 사용하여 도커 컨테이너를 실행하는 시점</strong>에 환경 변수로 다양한 옵션을 적용할 수 있도록 하였습니다.</p>
<h3 id="터무니없는-빌드된-이미지-크기"><a href="#터무니없는-빌드된-이미지-크기" class="headerlink" title="터무니없는 빌드된 이미지 크기"></a>터무니없는 빌드된 이미지 크기</h3><p>Dockerfile을 다시 작성하면서 꽤 깔끔해졌지만 또 다른 문제가 내재되어있었습니다. 그것은 빌드된 이미지의 크기가 3.7GB라는 터무니 없는 크기를 가지고 있던 것이었습니다. </p>
<p><img data-src="/images/posts/python-docker-image-optimization/python-docker-image-optimization-01.png" alt="3.71GB"></p>
<p>분석 서버를 개발하시는 실장님도 파이썬을 전문으로 하는 개발자가 아니었기 때문에 이러한 이미지 크기가 정상적인 것 같다고 하셨으나 <strong>requirements.txt에 정의된 패키지에 의해 설치된 용량이 무려 2.8GB</strong>인 것을 확인하고 requirements.txt에 <strong>정의된 패키지 중 사용하지 않는 패키지들을 제거</strong>하는 작업을 수행하고보니 <strong>97개의 패키지가 39개로 축소</strong>되었습니다.</p>
<p><img data-src="/images/posts/python-docker-image-optimization/python-docker-image-optimization-02.png" alt="1.28GB"></p>
<p>축소된 requirements.txt에 의해 설치된 패키지의 용량은 2.8GB에서 368MB로 줄어든 것으로 확인되었습니다.</p>
<h3 id="파이썬-기반-이미지-변경"><a href="#파이썬-기반-이미지-변경" class="headerlink" title="파이썬 기반 이미지 변경"></a>파이썬 기반 이미지 변경</h3><p>그럼에도 불구하고 아직 1.28GB라는 상당히 무거운 이미지 사이즈를 가지고 있었습니다. 그 이유는 기본 파이썬 이미지에서 이미 많은 패키지가 설치되기 때문입니다.</p>
<p><img data-src="/images/posts/python-docker-image-optimization/python-docker-image-optimization-03.png"></p>
<p>일반적으로 도커 이미지를 줄이기 위해서 알파인 리눅스 기반으로 만들어진 이미지를 사용하는 것으로 변경합니다. 그런데 알파인 리눅스로 된 파이썬 이미지를 사용하면 <a target="_blank" rel="noopener" href="https://jonnung.dev/docker/2020/04/08/optimizing-docker-images/">도커 이미지 잘 만드는 방법</a>에서 확인할 수 있듯이 <strong>빌드 소요시간이 15분 이상 걸리는 현상</strong>을 보였습니다.</p>
<figure class="highlight docker"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.8</span>-slim-buster</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="bash"> gcc libpq-dev</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>결국 알파인 리눅스 기반 이미지 대신에 <code>3.8-slim-buster</code>을 기반의 이미지로 변경하였고 PostgreSQL 모듈을 설치할 때 오류가 발생하여 gcc 와 libpg-dev 패키지를 설치하였습니다.</p>
<p><img data-src="/images/posts/python-docker-image-optimization/python-docker-image-optimization-04.png"></p>
<p><strong>1.28GB의 도커 이미지가 655MB의 용량을 가지는 이미지로 축소</strong>되었습니다. 결과적으로 약 3.14GB의 크기를 줄이게 되었고 <strong>캐시되지 않은 상태에서 약 40초 정도의 시간이 소요됨</strong>을 확인했습니다. </p>
<h3 id="Dockerfile-키워드-순서-변경"><a href="#Dockerfile-키워드-순서-변경" class="headerlink" title="Dockerfile 키워드 순서 변경"></a>Dockerfile 키워드 순서 변경</h3><p><strong>도커 이미지 잘 만드는 방법</strong>을 참고하면 애플리케이션 소스는 패키지를 설치하고나서 복사하는 것이 빌드 시간을 단축한다는 것을 보고 COPY 키워드 순서를 변경하였습니다.</p>
<figure class="highlight docker"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> src/requirements.txt requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install -r requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install gunicorn gevent</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> entrypoint.sh entrypoint.sh</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> src/ .</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>먼저, requirements.txt을 우선적으로 복사하고 패키지를 설치한 뒤 애플리케이션 실행을 위한 엔트리포인트 스크립트 파일과 애플리케이션 소스 폴더를 복사하도록 변경했습니다.</p>
<h3 id="Gunicorn-설정-개선"><a href="#Gunicorn-설정-개선" class="headerlink" title="Gunicorn 설정 개선"></a>Gunicorn 설정 개선</h3><p>다시 작성한 Dockerfile을 살펴보니 ARG와 ENV 키워드가 많아 쓸데없이 파일이 지저분해보였습니다. ARG와 ENV 키워드들은 용량을 차지하지 않으므로 이미지 크기에 영향을 주지는 않으나 Gunicorn의 여러가지 옵션을 하나의 환경 변수로 지원하도록 추가 개선하였습니다.</p>
<figure class="highlight docker"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.8</span>-slim-buster</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="bash"> gcc libpq-dev</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /app/logs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Build Arguments</span></span><br><span class="line"><span class="keyword">ARG</span> PORT=<span class="number">8000</span></span><br><span class="line"><span class="keyword">ARG</span> MAIN=application</span><br><span class="line"><span class="keyword">ARG</span> MAIN_APP=application</span><br><span class="line"><span class="keyword">ARG</span> GUNICORN_ARGS=--preload</span><br><span class="line"></span><br><span class="line"><span class="comment"># Environoment Variables</span></span><br><span class="line"><span class="keyword">ARG</span> PORT $&#123;PORT&#125;</span><br><span class="line"><span class="keyword">ENV</span> MAIN $&#123;MAIN&#125;</span><br><span class="line"><span class="keyword">ENV</span> MAIN_APP $&#123;MAIN_APP&#125;</span><br><span class="line"><span class="keyword">ENV</span> GUNICORN_ARGS $&#123;GUNICORN_ARGS&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> requirements.txt requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install -r requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip3 install gunicorn gevent</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> gunicorn.conf.py gunicorn.conf.py</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> entrypoint.sh entrypoint.sh</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> src/ .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> $&#123;PORT&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://docs.gunicorn.org/en/stable/run.html</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> [<span class="string">&quot;chmod&quot;</span>, <span class="string">&quot;+x&quot;</span>, <span class="string">&quot;./entrypoint.sh&quot;</span>]</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> <span class="string">&quot;./entrypoint.sh&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>다음과 같이 기본 옵션이 정의된 <strong>gunicorn.conf.py</strong> 파일을 적용하였습니다.</p>
<figure class="highlight py"><figcaption><span>gunicorn.conf.py</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://docs.gunicorn.org/en/stable/settings.html</span></span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"></span><br><span class="line">bind = <span class="string">&#x27;0.0.0.0:8000&#x27;</span></span><br><span class="line">workers = multiprocessing.cpu_count() * <span class="number">2</span> + <span class="number">1</span></span><br><span class="line">worker_connections = <span class="number">1000</span></span><br><span class="line">worker_class = <span class="string">&#x27;gevent&#x27;</span></span><br><span class="line">threads = <span class="number">1</span></span><br><span class="line">max_requests = <span class="number">0</span></span><br><span class="line">timeout = <span class="number">30</span></span><br><span class="line">keepalive = <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>그리고 기본으로 적용된 옵션을 하나로 통합된 <strong>GUNICORN_ARGS</strong> 환경 변수를 통해 자유롭게 옵션을 재정의하도록 하였습니다.</p>
<p><strong>requirements.txt에 정의된 패키지 정리</strong>하고 <strong>slim-buster 기반의 이미지로 변경</strong> 그리고 <strong>Dockerfile 키워드 순서를 변경</strong>함으로써 파이썬 애플리케이션에 대한 도커 이미지를 최적화하는 것을 알아보았습니다. 결과적으로 도커 이미지 사이즈를 많이 줄이게되어 이미지 용량에 대한 부담과 빌드 및 배포하기까지의 시간을 단축하게되어 다행이라고 생각합니다.</p>
<p>감사합니다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a target="_blank" rel="noopener" href="http://blog.hwahae.co.kr/all/tech/tech-tech/5567/">gunicorn 설정의 A to Z</a></li>
<li><a target="_blank" rel="noopener" href="https://jonnung.dev/docker/2020/04/08/optimizing-docker-images/">도커 이미지 잘 만드는 방법</a>  </li>
<li><a target="_blank" rel="noopener" href="https://kimeuichan.github.io/posts/deploy-docker-more-faster/">자주 변경되는 도커 이미지 빠르게 배포하기</a>  </li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Docker/" rel="tag"># Docker</a>
              <a href="/tags/Python/" rel="tag"># Python</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/elastic-beanstalk-docker-with-python/" rel="prev" title="Elastic Beanstalk Docker Platform">
                  <i class="fa fa-chevron-left"></i> Elastic Beanstalk Docker Platform
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/ed25519/" rel="next" title="ED25519">
                  ED25519 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  
  <div class="comments">
  <script src="https://utteranc.es/client.js" repo="kdevkr/kdevkr.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
  </div>
  
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mambo</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  



  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  





</body>
</html>
