<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>스프링 부트에서 모든 메시지 코드 가져오기</title>
    <url>/all-message-codes-in-spring-boot/</url>
    <content><![CDATA[<h2 id="ResourceBundleMessageSource"><a href="#ResourceBundleMessageSource" class="headerlink" title="ResourceBundleMessageSource"></a>ResourceBundleMessageSource</h2><p>스프링 부트에서 기본적으로 제공하는 <code>ResourceBundleMessageSource</code>는 메시지에 대한 모든 코드를 가져올 수 있는 기능이 존재하지 않습니다. 예외적으로 ReloadableResourceBundleMessageSource이라는 메시지 소스는 <code>getMergedProperties(Locale locale)</code> 함수를 통해 로케일에 대한 메시지 프로퍼티를 가져올 수 있습니다.</p>
<h2 id="ReloadableResourceBundleMessageSource"><a href="#ReloadableResourceBundleMessageSource" class="headerlink" title="ReloadableResourceBundleMessageSource"></a>ReloadableResourceBundleMessageSource</h2><p>하지만, getMergedProperties 함수는 접근제어자가 protected이므로 <code>ReloadableResourceBundleMessageSource</code>를 확장하는 클래스를 만들어야합니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExtendReloadableResourceBundleMessageSource</span> <span class="token keyword">extends</span> <span class="token class-name">ReloadableResourceBundleMessageSource</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">Properties</span> <span class="token function">getMessages</span><span class="token punctuation">(</span><span class="token class-name">Locale</span> locale<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">getMergedProperties</span><span class="token punctuation">(</span>locale<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="MessageSource-Configuration"><a href="#MessageSource-Configuration" class="headerlink" title="MessageSource Configuration"></a>MessageSource Configuration</h2><p>구성 메타 클래스를 만들어 ExtendReloadableResourceBundleMessageSource를 메시지 소스로 등록합니다. 애플리케이션 컨텍스트에 <code>messageSource</code> 빈이 존재하는 경우 <code>MessageSourceAutoConfiguration</code>은 적용되지 않습니다.</p>
<p>따라서, 다음과 같이 <code>MessageSourceProperties</code>도 등록되도록 합니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageSourceConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.messages"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">MessageSourceProperties</span> <span class="token function">properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MessageSourceProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">MessageSource</span> <span class="token function">messageSource</span><span class="token punctuation">(</span><span class="token class-name">MessageSourceProperties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ExtendReloadableResourceBundleMessageSource</span> messageSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExtendReloadableResourceBundleMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getBasename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            messageSource<span class="token punctuation">.</span><span class="token function">setBasenames</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span>
                    <span class="token punctuation">.</span><span class="token function">commaDelimitedListToStringArray</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">trimAllWhitespace</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getBasename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getEncoding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            messageSource<span class="token punctuation">.</span><span class="token function">setDefaultEncoding</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getEncoding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        messageSource<span class="token punctuation">.</span><span class="token function">setFallbackToSystemLocale</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">isFallbackToSystemLocale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Duration</span> cacheDuration <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getCacheDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheDuration <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            messageSource<span class="token punctuation">.</span><span class="token function">setCacheMillis</span><span class="token punctuation">(</span>cacheDuration<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        messageSource<span class="token punctuation">.</span><span class="token function">setAlwaysUseMessageFormat</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">isAlwaysUseMessageFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageSource<span class="token punctuation">.</span><span class="token function">setUseCodeAsDefaultMessage</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">isUseCodeAsDefaultMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> messageSource<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="spring-messages-basename"><a href="#spring-messages-basename" class="headerlink" title="spring.messages.basename"></a>spring.messages.basename</h3><p>ReloadableResourceBundleMessageSource를 확장하는 클래스를 만들었지만 스프링 부트의 기본 <code>spring.messages.basename</code> 값인 <code>messages</code>으로 메시지 프로퍼티를 가져올 수 없습니다.</p>
<p>ReloadableResourceBundleMessageSource에서 사용중인 ResourceLoader가 DefaultResourceLoader이므로 클래스패스에 위치한 <code>messages.properties</code>을 리소스로 가져오지 못합니다.</p>
<p>따라서, spring.messages.basename에 클래스패스를 포함하여 명시합니다.</p>
<pre class="language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">spring.messages.basename</span><span class="token punctuation">=</span><span class="token value attr-value">classpath:/messages</span></code></pre>

<h2 id="Messages-API"><a href="#Messages-API" class="headerlink" title="Messages API"></a>Messages API</h2><p>이제 ExtendReloadableResourceBundleMessageSource를 통해 메시지 정보를 가져올 수 있게 되고 API로도 제공하여 프론트엔드 클라이언트에서도 동일한 메시지 코드를 활용할 수 있습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/messages"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">messages</span><span class="token punctuation">(</span><span class="token class-name">Locale</span> locale<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ExtendReloadableResourceBundleMessageSource</span> messageSource <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ExtendReloadableResourceBundleMessageSource</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageSource<span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> messages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Properties</span> allMessages <span class="token operator">=</span> messageSource<span class="token punctuation">.</span><span class="token function">getMessages</span><span class="token punctuation">(</span>locale<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span><span class="token punctuation">></span></span> entries <span class="token operator">=</span> allMessages<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> entry <span class="token operator">:</span> entries<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Object</span> key <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> value <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        messages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>Spring Boot</tag>
        <tag>Message Source</tag>
      </tags>
  </entry>
  <entry>
    <title>EC2 인스턴스 연결(콘솔) 허용하기</title>
    <url>/allow-ec2-instance-connect/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>오늘 알아볼 내용은 EC2 인스턴스 연결(EC2 Instance Connect) 기능입니다. 일반적으로 EC2 인스턴스에 접속하기 위해서는 SSH 클라이언트를 사용합니다. 아마존 EC2 콘솔은 SSH 클라이언트를 사용하지 않고도 EC2 인스턴스에 연결할 수 있는 기능을 제공하고 있습니다. 어떻게 해야 EC2 콘솔을 통해 EC2 인스턴스에 연결할 수 있는지 알아봅시다.</p>
<h2 id="EC2-인스턴스-연결"><a href="#EC2-인스턴스-연결" class="headerlink" title="EC2 인스턴스 연결"></a>EC2 인스턴스 연결</h2><p><strong>EC2 인스턴스 연결</strong>은 아마존 EC2 콘솔을 통해 퍼블릭 IPv4 주소가 할당된 인스턴스에 연결할 수 있는 기능입니다. EC2 인스턴스 연결에 대한 자세한 내용은 <a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/ec2-instance-connect-methods.html#ec2-instance-connect-connecting-console">EC2 Instance Connect를 사용한 연결</a> 문서에서 확인할 수 있습니다.</p>
<p>퍼블릭 IPv4 주소가 할당된 Amazon Linux 2 또는 Ubuntu 16.04 이상의 인스턴스라면 아마존 EC2 콘솔에서 제공하는 EC2 인스턴스 연결 기능을 사용하여 인스턴스에 접속할 수 있습니다.</p>
<h3 id="인바운드-SSH-트래픽-허용"><a href="#인바운드-SSH-트래픽-허용" class="headerlink" title="인바운드 SSH 트래픽 허용"></a>인바운드 SSH 트래픽 허용</h3><p>기본으로 제공하는 보안 그룹에는 SSH 트래픽을 수신하는 것을 허용하지 않습니다. EC2 인스턴스 연결을 사용하기 위해서는 <strong>EC2_INSTANCE_CONNECT라는 서비스가 사용하는 IP 대역에 대하여 SSH 트래픽을 수신하도록 허용</strong>해야합니다.</p>
<p>EC2_INSTANCE_CONNECT 서비스가 사용하는 IP 대역은 <a href="https://ip-ranges.amazonaws.com/ip-ranges.json">AWSIP 주소 범위</a>에서 EC2_INSTANCE_CONNECT 서비스와 VPC가 생성된 region에 대하여 필터링을 해야합니다.</p>
<p><img data-src="/images/posts/allow-ec2-instance-connect/ec2-instance-connect-01.png"></p>
<p>다행히도 다른 서비스와 다르게 EC2_INSTANCE_CONNECT는 리전별로 하나이므로 <strong>13.209.1.56&#x2F;29</strong> IP 대역을 SSH 트래픽으로 수신하도록 허용하면 됩니다.</p>
<p>회사에서 지급받은 구형 맥북에서 <a href="https://aws.amazon.com/ko/premiumsupport/knowledge-center/ec2-instance-connect-troubleshooting/">AWS 문서에서 알려주는 다음의 명령어</a>를 쳐봐도 하나만 나옵니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">curl -s https:&#x2F;&#x2F;ip-ranges.amazonaws.com&#x2F;ip-ranges.json| jq -r &#39;.prefixes[] | select(.region&#x3D;&#x3D;&quot;us-east-1&quot;) | select(.service&#x3D;&#x3D;&quot;EC2_INSTANCE_CONNECT&quot;) | .ip_prefix&#39;
13.209.1.56&#x2F;29</code></pre>

<p><img data-src="/images/posts/allow-ec2-instance-connect/ec2-instance-connect-02.png"></p>
<p>위와 같이 13.209.1.56&#x2F;29 대역에 대한 SSH 트래픽을 수신할 수 있도록 허용하였으니 이제 이 보안그룹을 인스턴스에 추가하면 됩니다.</p>
<h3 id="샘플-인스턴스-생성"><a href="#샘플-인스턴스-생성" class="headerlink" title="샘플 인스턴스 생성"></a>샘플 인스턴스 생성</h3><p><img data-src="/images/posts/allow-ec2-instance-connect/ec2-instance-connect-03.png"></p>
<p>샘플 인스턴스는 기본으로 제공하는 보안 그룹을 지정하였습니다. 따라서 SSH 트래픽에 대해서 허용하지 않은 상태이므로 다음과 같이 EC2 인스턴스 연결을 시도하면 실패하게 됩니다.</p>
<p><img data-src="/images/posts/allow-ec2-instance-connect/ec2-instance-connect-04.png"></p>
<p>이제 샘플 인스턴스에 ec2-instance-connect 보안그룹을 추가하겠습니다.</p>
<p><img data-src="/images/posts/allow-ec2-instance-connect/ec2-instance-connect-05.png"></p>
<p>다시 아마존 EC2 콘솔의 EC2 인스턴스 연결으로 샘플 인스턴스에 접속해보겠습니다.</p>
<p><img data-src="/images/posts/allow-ec2-instance-connect/ec2-instance-connect-06.png"></p>
<p>EC2_INSTANCE_CONNECT 서비스의 IP 대역을 허용하였기 때문에 정상적으로 접속되었습니다.</p>
<p><img data-src="/images/posts/allow-ec2-instance-connect/complete.gif"></p>
<p>보안을 중요시하는 회사라면 모든 IP 대역에 대하여 SSH 접속을 허용하지 않고 <strong>EC2_INSTANCE_CONNECT 서비스와 회사에서 사용되는 IP 대역을 허용하시는 것을 권장</strong>합니다.</p>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>AWS</tag>
        <tag>EC2</tag>
      </tags>
  </entry>
  <entry>
    <title>재부팅 시 Crontab에 의해 프로세스를 자동으로 실행하기</title>
    <url>/autorun-process-using-crontab-on-reboot/</url>
    <content><![CDATA[<blockquote>
<p>🤪 재부팅 시 Crontab에 의해서 프로세스가 자동으로 실행되지 않은 이유</p>
</blockquote>
<p>크론탭(Crontab)은 리눅스에서 일정된 시점이나 주기적으로 명령어 또는 쉘 스크립트를 실행할 수 있는 스케줄러 또는 타이머입니다. 이전에 작성한 <a href="/maintaining-process-execution-in-linux">리눅스에서 프로세스 실행 유지하기</a>에서도 크론탭으로 프로세스를 실행하는 방법에 대해서 다루어본 적이 있습니다. 서버 시스템이 예기지 않은 상황에 의해서 재부팅되거나 종료되어 수동으로 실행될 수도 있으므로 Systemd 또는 Crontab으로 프로세스를 자동으로 실행할 수 있다고 공유했었습니다. </p>
<p>그런데 얼마전에 특정 고객 환경의 서버들을 고객이 지진과 같은 예기치 않은 장애로 인해서 서버가 재부팅되는 상황에서 프로세스가 자동으로 실행될 수 있음을 테스트하던 중 서버가 재부팅될 때 자동으로 실행되었어야할 프로세스들이 시작되지 않는다는 피드백이 전달되었습니다. 실제로 시스템이 재부팅될 때 프로세스가 자동으로 실행되지 않았음을 확인하였고 크론탭과 쉘 스크립트에 대한 이해가 부족했다는 점을 확인했습니다.</p>
<p>저는 서버에 대한 부분을 전문적으로 관리하는 서버 엔지니어는 아니므로 필요한 부분을 검색한 후 정리된 바를 토대로 작업을 할 수 밖에 없습니다. Crontab에 의해서 프로세스가 자동으로 실행되기 위해서 검토하지 않은 부분이 무엇인지를 공유해보겠습니다.</p>
<h2 id="Crontab"><a href="#Crontab" class="headerlink" title="Crontab"></a>Crontab</h2><p>크론탭에 대한 메뉴얼 페이지를 살펴보면 <a href="https://man7.org/linux/man-pages/man5/crontab.5.html#EXTENSIONS">EXTENSIONS</a>으로 시스템이 재부팅되었을때 실행할 수 있도록 시간을 지정할 수 있는 별칭이 있다는 것을 확인할 수 있습니다. <a href="https://phoenixnap.com/kb/crontab-reboot">Crontab Reboot: How to Execute a Job Automatically at Boot</a>와 같은 글에서도 간단하게 @reboot을 사용하면 시스템이 부팅되었을때 스크립트를 실행할 수 있다고 정리되어있습니다. 그래서 단순히 @reboot를 지정하기만 하면 시스템이 재부팅되었을때 정상적으로 쉘 스크립트가 실행될 것이라고 예상하였습니다.</p>
<h3 id="Interactive-and-Non-Interactive-Shell"><a href="#Interactive-and-Non-Interactive-Shell" class="headerlink" title="Interactive and Non-Interactive Shell"></a>Interactive and Non-Interactive Shell</h3><p>제가 검토하지 않은 부분은 쉘 스크립트가 실행되는 방식이 다양하다는 것에 있습니다. 일반적으로 SSH 접속으로 실행되는 쉘은 로그인 쉘입니다. 로그인 쉘 및 Bash로 실행되었을때는 다음과 같은 파일들이 자동으로 로드된다는 특징이 있습니다.</p>
<ul>
<li>&#x2F;etc&#x2F;profile</li>
<li>~&#x2F;.bash_profile</li>
<li>~&#x2F;.bashrc</li>
<li>~&#x2F;.profile</li>
</ul>
<p>일반적으로 쉘 스크립트를 작성하고 실행해보았을때는 로그인 쉘을 통해 실행하기 때문에 실행 스크립트에서 참조하는 많은 환경변수가 올바르게 지정되어있다는 것이 보장됩니다. 그러나 Crontab에 의해서 자동으로 실행되는 스크립트는 로그인 쉘에서 수행되는 것이 아니므로 환경변수가 제대로 지정된다는 것을 보장할 수 없는 문제를 간과한 것입니다.</p>
<h3 id="사용자-기본-쉘"><a href="#사용자-기본-쉘" class="headerlink" title="사용자 기본 쉘"></a>사용자 기본 쉘</h3><p>쉘 스크립트에 셔뱅(#!)을 Bash로 지정하더라도 크론탭에 의해서 실행되는 쉘 유형은 사용자의 기본 쉘로 고정됩니다. SSH 접속 후 로그인 쉘 상태로 스크립트를 실행하면 현재 쉘이 Bash인 것을 확인할 수 있습니다. 그러나, 리부트 명령을 수행하고나서 크론탭에 의해서 실행된 스크립트에 대한 로그를 확인하면 Bash가 아닌 기본 쉘이라고 기록되어있습니다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">./a.sh
<span class="token environment constant">SHELL</span><span class="token builtin class-name">:</span> /bin/bash

<span class="token comment"># reboot with #!/bin/bash</span>
<span class="token function">tail</span> a.log
<span class="token environment constant">SHELL</span><span class="token builtin class-name">:</span> /bin/sh

<span class="token comment"># reboot with #!/bin/bash --login</span>
<span class="token function">tail</span> a.log
<span class="token environment constant">SHELL</span><span class="token builtin class-name">:</span> /bin/sh

<span class="token comment"># crontab -e &amp;&amp; SHELL=/bin/bash</span>
<span class="token environment constant">SHELL</span><span class="token builtin class-name">:</span> /bin/bash</code></pre>

<p>위 결과를 토대로 쉘 스크립트에서 셔뱅과 함께 로그인 쉘 옵션을 활성화하는 것과 상관없이 사용자의 기본 쉘을 변경하거나 크론탭 설정 시 쉘을 지정하도록 하여야한다는 것을 확인할 수 있습니다. </p>
<h3 id="환경변수-파일"><a href="#환경변수-파일" class="headerlink" title="환경변수 파일"></a>환경변수 파일</h3><p>쉘 스크립트에서 로그인 쉘 옵션(–login)을 지정하는 것은 정해진 환경변수 파일을 로드하기 위한 방법입니다. 다만, 로그인 쉘이 적용되었기에 다음과 같이 ~&#x2F;.bashrc는 로드되지 않는 것을 확인할 수 있습니다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash --login</span>

<span class="token function">tail</span> a.log
Loaded /etc/profile
Loaded .profile
<span class="token environment constant">SHELL</span><span class="token builtin class-name">:</span> /bin/bash</code></pre>

<blockquote>
<p>크론탭에 의해서 쉘 스크립트가 실행될 때에는 Non-Interactive Shell 방식으로 동작한다는 점을 인지해야합니다. 이는 로그인 쉘 옵션을 지정해도 .bashrc 파일이 로드되지 않았음을 확인할 수 있습니다.</p>
</blockquote>
<p>결과적으로, 재부팅시에도 크론탭에 의해서 쉘 스크립트를 통해 프로세스가 자동으로 실행되기 위해서는 다음의 방안 중에서 환경 변수가 올바르게 로드될 수 있도록 별도의 작업을 수행해야합니다.</p>
<ol>
<li>.profile에 환경 변수를 지정한 경우 –login 옵션 고려</li>
<li>.bashrc 또는 .bash_profile에 환경 변수를 지정한 경우 파일을 직접 명시하여 로드</li>
<li>프로세스 실행 시 필요한 환경변수를 수동으로 지정하는 스크립트 로드</li>
</ol>
<p>크론탭에 의해서 쉘 스크립트가 정상적으로 실행되지 않는다면 알맞은 쉘과 환경변수가 올바르게 로드되는 방식을 취하였는지 검토하시기 바랍니다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://unix.stackexchange.com/a/46856">Difference between Login Shell and Non-Login Shell?</a>  </li>
<li><a href="https://www.geeksforgeeks.org/shell-scripting-interactive-and-non-interactive-shell/">Shell Scripting – Interactive and Non-Interactive Shell</a>  </li>
<li><a href="https://man7.org/linux/man-pages/man5/crontab.5.html">crontab(5) — Linux manual page</a></li>
</ul>
]]></content>
      <tags>
        <tag>Autorun</tag>
        <tag>Crontab</tag>
        <tag>Interactive Shell</tag>
      </tags>
  </entry>
  <entry>
    <title>Base64</title>
    <url>/base64/</url>
    <content><![CDATA[<p><img data-src="/images/posts/base64/base64-01.png"></p>
<p>위와 같이 어떤 서비스에 대한 회원가입을 수행하거나 비밀번호 찾기와 같은 기능을 수행했을경우 인증 관련 메일이 발송되는 것을 자주 확인할 수 있습니다. 그러나 위와 같이 인증확인 버튼을 클릭했을때 어떠한 동작을 하는지 궁금하시지 않으신가요? 위와 같은 인증 버튼은 링크 엘리먼트로 되어있으며 일반적인 GET 요청입니다. 그리고 그 URI에는 다음과 같은 어떠한 형태의 문자열이 포함되게 됩니다.</p>
<blockquote>
<p>a2RldmtyQGdtYWlsLmNvbTp5Rm5iTUtrblZrRW85ckdxTVlmTGtWNE03UUtMTldXWg&#x3D;&#x3D;</p>
</blockquote>
<p>위와 같이 구성된 문자열은 Base64로 인코딩된 데이터이며 크롬 개발자도구의 콘솔을 통해 이 아스키 문자열을 디코딩하면 다음과 같은 문자열 데이터를 확인할 수 있습니다.</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">atob</span><span class="token punctuation">(</span><span class="token string">"a2RldmtyQGdtYWlsLmNvbTp5Rm5iTUtrblZrRW85ckdxTVlmTGtWNE03UUtMTldXWg=="</span><span class="token punctuation">)</span>
<span class="token string">'kdevkr@gmail.com:yFnbMKknVkEo9rGqMYfLkV4M7QKLNWWZ'</span></code></pre>

<p>제 이메일 주소와 함께 어떠한 문자열을 포함하고 있습니다. 아마도 저 알수없는 문자열은 암호화된 인증 정보일 것입니다. 인증 정보와 GET 요청에 포함된 이메일 주소가 동일한지를 내부적으로 검증하겠죠. 이러한 인증 정보를 왜 Base64로 인코딩하여 전송하게 되는 것일까요? <strong>안전한 형태로 데이터를 전달하고자하는 목적</strong>에 있습니다.</p>
<h2 id="아스키-코드"><a href="#아스키-코드" class="headerlink" title="아스키 코드"></a>아스키 코드</h2><p>사람들은 수 많은 문자의 형태를 읽고 구분할 수 있지만 0과 1로 이루어진 컴퓨터 시스템은 시스템에 따라 0과 1을 읽고 구분하는 방식이 다를 수 있습니다. 시스템의 발전에 따라 아스키 코드부터 유니코드 그리고 여러가지 문자 조합이 확장되고 있습니다. 대부분의 문자 형식은 아스키 코드를 기초로 만들어지기 때문에 아스키 코드 중 일부 문자 집합은 거의 모든 시스템에서 공통으로 사용되는 문자입니다. 그러한 문자들을 모아 만들어지는게 Base64 인코딩입니다.</p>
<h3 id="Base64-이미지"><a href="#Base64-이미지" class="headerlink" title="Base64 이미지"></a>Base64 이미지</h3><p>브라우저에서는 바이너리 데이터 뿐만 아니라 Base64로 이루어진 이미지 데이터를 표현할 수 있습니다. </p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAAXNSR0IArs4c6QAAA+VJREFUeF7tnclu4zAUBEf//9EeYG6SAhUKTdJUpnMV1663kbKd4/P5fP70bxsFjgLZhsW/hRTIXjwKZDMeBVIguymw2XqaQwpkMwU2Ww56yHEcS5d8PRZd56djU9p+9mZx/XQOKZCxiAoELiK+bXBX3A1ZXw7JMRByOevgFPNTC6b10vx2PzeBL8BxPTaH0IB2AyRIgVwUJcEsAGtBBVIgqY2d+luD1kmdzgm0G+pPIdF6jB2P1jd9f2kOSQXSFiSrogIBEyILtAJai52dw+L91UPOV0MkqDUAHQHeBsRaOAlIgi0PyQVSD4nKwnoIHP1Xu3SBfBkIxfgUEI2/2uC2PxiSYAVyeb8w24IKRN5lFchZMDrH4ME3LXupzqfn5AH2+XU+FEC+r6D9xCG0QJ7PIRZAgcBlYz1EmpQNSRSj/7uQJfXWzUnw2c/1gmUH9FibQ+T8uvlswWl8vWDZoUAG3zRI/W/NC+S3AUktIu1PST8tM9P1je6Pd1mjJ7TjFYhVbHL7ApkssB2+QOBykQTFKkKerNPLS8oxtJ/0oKn7jz6HFMjzF5xQnwJxPoKCyghw8+ACeTkQunqwFmTHG53kR49HOQv1sR5iBbQLJIHo+ej57Hhx+wJxL6hGG0ScQ+ohkwFaD6G62p4baDxKuWSxuz+PPYQELJDz78GRQRQIfK7MhmQSnJ4XyNuBUBlnQxjV4TZnUPt0Ptr/8PEpqdOCCmTsb4jqF1SUtG0MJgu3BkEGYuej+eshg7+FawHZJK3Hp5A1egGph5EH0Pir+1sPwpBVIM82PjpEF8ji77tQCCuQtwEhorOfz84JFOPT+a0+6CF2wNHtU0Gof4FIYiRoWjUVSIE8KoAhy1qo1PvWPLXYtAxN9xvPbw+GqeDUv0BAgdRiCADlALpLov72YJvutx5yIRILIu/KhhuEDVkUUqxHkAXTc/KgFNDy8QvEvc8gA6HnZLC6yqqHuB88s3oViPyvgeQB9Hy6h9iqZHVMtzkABQu/REoeE3tIgTx/DouqsJvBpEm9QArkZFQ2Ztv2NuSRgf66kDVaUAopJDDlHALw+pBVIGFVYS2QLKpACoSi0uNzMrDXhSyK4bRh8igaP6LxQ2dc7+5lLwmGGxzs4SkgXG+BfPc/mTZkhZ/D2t5D0gXaGD/6LowOfrQ/CkHUf7iH2AlJACs4AbXro5xFZbydr0BAsQKRVZD1IGuxrwNiN2jbW8GtgGnIsSFSt7dlrxXYti+QzT+XRRZWD7EmL9vXQ0YX0hJAm58VwHfqFWytAgWyVm+crUBQorUNCmSt3jhbgaBEaxsUyFq9cbYCQYnWNvgLqC4vPjN7siAAAAAASUVORK5CYII=<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAAXNSR0IArs4c6QAAA+VJREFUeF7tnclu4zAUBEf//9EeYG6SAhUKTdJUpnMV1663kbKd4/P5fP70bxsFjgLZhsW/hRTIXjwKZDMeBVIguymw2XqaQwpkMwU2Ww56yHEcS5d8PRZd56djU9p+9mZx/XQOKZCxiAoELiK+bXBX3A1ZXw7JMRByOevgFPNTC6b10vx2PzeBL8BxPTaH0IB2AyRIgVwUJcEsAGtBBVIgqY2d+luD1kmdzgm0G+pPIdF6jB2P1jd9f2kOSQXSFiSrogIBEyILtAJai52dw+L91UPOV0MkqDUAHQHeBsRaOAlIgi0PyQVSD4nKwnoIHP1Xu3SBfBkIxfgUEI2/2uC2PxiSYAVyeb8w24IKRN5lFchZMDrH4ME3LXupzqfn5AH2+XU+FEC+r6D9xCG0QJ7PIRZAgcBlYz1EmpQNSRSj/7uQJfXWzUnw2c/1gmUH9FibQ+T8uvlswWl8vWDZoUAG3zRI/W/NC+S3AUktIu1PST8tM9P1je6Pd1mjJ7TjFYhVbHL7ApkssB2+QOBykQTFKkKerNPLS8oxtJ/0oKn7jz6HFMjzF5xQnwJxPoKCyghw8+ACeTkQunqwFmTHG53kR49HOQv1sR5iBbQLJIHo+ej57Hhx+wJxL6hGG0ScQ+ohkwFaD6G62p4baDxKuWSxuz+PPYQELJDz78GRQRQIfK7MhmQSnJ4XyNuBUBlnQxjV4TZnUPt0Ptr/8PEpqdOCCmTsb4jqF1SUtG0MJgu3BkEGYuej+eshg7+FawHZJK3Hp5A1egGph5EH0Pir+1sPwpBVIM82PjpEF8ji77tQCCuQtwEhorOfz84JFOPT+a0+6CF2wNHtU0Gof4FIYiRoWjUVSIE8KoAhy1qo1PvWPLXYtAxN9xvPbw+GqeDUv0BAgdRiCADlALpLov72YJvutx5yIRILIu/KhhuEDVkUUqxHkAXTc/KgFNDy8QvEvc8gA6HnZLC6yqqHuB88s3oViPyvgeQB9Hy6h9iqZHVMtzkABQu/REoeE3tIgTx/DouqsJvBpEm9QArkZFQ2Ztv2NuSRgf66kDVaUAopJDDlHALw+pBVIGFVYS2QLKpACoSi0uNzMrDXhSyK4bRh8igaP6LxQ2dc7+5lLwmGGxzs4SkgXG+BfPc/mTZkhZ/D2t5D0gXaGD/6LowOfrQ/CkHUf7iH2AlJACs4AbXro5xFZbydr0BAsQKRVZD1IGuxrwNiN2jbW8GtgGnIsSFSt7dlrxXYti+QzT+XRRZWD7EmL9vXQ0YX0hJAm58VwHfqFWytAgWyVm+crUBQorUNCmSt3jhbgaBEaxsUyFq9cbYCQYnWNvgLqC4vPjN7siAAAAAASUVORK5CYII=<span class="token punctuation">"</span></span> <span class="token attr-name">data-loaded</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre>

<p><img data-src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAAXNSR0IArs4c6QAAA+VJREFUeF7tnclu4zAUBEf//9EeYG6SAhUKTdJUpnMV1663kbKd4/P5fP70bxsFjgLZhsW/hRTIXjwKZDMeBVIguymw2XqaQwpkMwU2Ww56yHEcS5d8PRZd56djU9p+9mZx/XQOKZCxiAoELiK+bXBX3A1ZXw7JMRByOevgFPNTC6b10vx2PzeBL8BxPTaH0IB2AyRIgVwUJcEsAGtBBVIgqY2d+luD1kmdzgm0G+pPIdF6jB2P1jd9f2kOSQXSFiSrogIBEyILtAJai52dw+L91UPOV0MkqDUAHQHeBsRaOAlIgi0PyQVSD4nKwnoIHP1Xu3SBfBkIxfgUEI2/2uC2PxiSYAVyeb8w24IKRN5lFchZMDrH4ME3LXupzqfn5AH2+XU+FEC+r6D9xCG0QJ7PIRZAgcBlYz1EmpQNSRSj/7uQJfXWzUnw2c/1gmUH9FibQ+T8uvlswWl8vWDZoUAG3zRI/W/NC+S3AUktIu1PST8tM9P1je6Pd1mjJ7TjFYhVbHL7ApkssB2+QOBykQTFKkKerNPLS8oxtJ/0oKn7jz6HFMjzF5xQnwJxPoKCyghw8+ACeTkQunqwFmTHG53kR49HOQv1sR5iBbQLJIHo+ej57Hhx+wJxL6hGG0ScQ+ohkwFaD6G62p4baDxKuWSxuz+PPYQELJDz78GRQRQIfK7MhmQSnJ4XyNuBUBlnQxjV4TZnUPt0Ptr/8PEpqdOCCmTsb4jqF1SUtG0MJgu3BkEGYuej+eshg7+FawHZJK3Hp5A1egGph5EH0Pir+1sPwpBVIM82PjpEF8ji77tQCCuQtwEhorOfz84JFOPT+a0+6CF2wNHtU0Gof4FIYiRoWjUVSIE8KoAhy1qo1PvWPLXYtAxN9xvPbw+GqeDUv0BAgdRiCADlALpLov72YJvutx5yIRILIu/KhhuEDVkUUqxHkAXTc/KgFNDy8QvEvc8gA6HnZLC6yqqHuB88s3oViPyvgeQB9Hy6h9iqZHVMtzkABQu/REoeE3tIgTx/DouqsJvBpEm9QArkZFQ2Ztv2NuSRgf66kDVaUAopJDDlHALw+pBVIGFVYS2QLKpACoSi0uNzMrDXhSyK4bRh8igaP6LxQ2dc7+5lLwmGGxzs4SkgXG+BfPc/mTZkhZ/D2t5D0gXaGD/6LowOfrQ/CkHUf7iH2AlJACs4AbXro5xFZbydr0BAsQKRVZD1IGuxrwNiN2jbW8GtgGnIsSFSt7dlrxXYti+QzT+XRRZWD7EmL9vXQ0YX0hJAm58VwHfqFWytAgWyVm+crUBQorUNCmSt3jhbgaBEaxsUyFq9cbYCQYnWNvgLqC4vPjN7siAAAAAASUVORK5CYII=" alt="Base64로 표시된 QR코드 이미지"></p>
<blockquote>
<p>웹팩의 <a href="https://v4.webpack.js.org/loaders/url-loader/">url-loader</a>는 위와 같은 Base64 형식의 URI로 변환합니다. </p>
</blockquote>
<h3 id="HTTP-기본-인증"><a href="#HTTP-기본-인증" class="headerlink" title="HTTP 기본 인증"></a>HTTP 기본 인증</h3><p>사용자 이름과 비밀번호를 Authorization 헤더에 포함하여 전달하는 HTTP 기본 인증의 경우에도 Base64 인코딩을 사용합니다. 이는 HTTP 헤더의 값이 <strong>아스키 코드</strong>로 인코딩되어야하기 때문입니다. 따라서, 아스키 코드로 표현할 수 없는 데이터도 전달할 수 있도록 Base64 인코딩을 사용하는 것입니다.</p>
<blockquote>
<p>Authorization: Basic bWFtYm86cGFzc3dvcmQ&#x3D;</p>
</blockquote>
<h3 id="JWT-Base64Url"><a href="#JWT-Base64Url" class="headerlink" title="JWT Base64Url"></a>JWT Base64Url</h3><p>최근 사용자 인증을 위해 많이 도입하는 JWT(JSON Web Token)는 페이로드와 시그니처 부분을 <strong>Base64Url(URL Safe Base64)</strong> 로 인코딩합니다. JWT를 Base64로 인코딩하는 이유는 토큰이 URL 파라미터로 전송될 수 있기 때문입니다. </p>
<h2 id="끝마치며"><a href="#끝마치며" class="headerlink" title="끝마치며"></a>끝마치며</h2><p>Base64를 사용하는 이유에 대해서 간단하게 알아보았습니다. 초보 개발자분들 뿐만 아니라 저처럼 Base64에 대해서 인지하고 있었던 분들에게도 도움이 되었으면 합니다. 감사합니다.</p>
<blockquote>
<p>Base64에 대해서 자세한 내용을 알고 싶다면 <a href="https://datatracker.ietf.org/doc/html/rfc4648">RFC4648</a>을 참고하세요.</p>
</blockquote>
]]></content>
      <tags>
        <tag>Base64</tag>
      </tags>
  </entry>
  <entry>
    <title>AWS SSM 에이전트로 프라이빗 EC2 인스턴스에 연결하기</title>
    <url>/connect-private-ec2-instance-using-ssm-agent/</url>
    <content><![CDATA[<p>오늘은 아마존 웹 서비스에서 제공하는 SSM(System Session Manager) 에이전트를 통해서 퍼블릭 IP를 통한 SSH 접속이 아닌 HTTPS 엔드포인트를 사용해서 프라이빗 서브넷에 위치하는 인스턴스에 접근할 수 있는 방법을 알아보고자 합니다. </p>
<p>인터넷에서 접근할 수 있는 아이피 주소가 할당되지 않는 프라이빗 서브넷에 위치하는 프라이빗 EC2 인스턴스에 접근하기 위해서는 퍼블릭 IP가 할당되는 퍼블릭 서브넷에서 실행되는 <strong>배스천 호스트</strong>가 필요하며 이 배스천 호스트라는 서버를 경유하여 내부 네트워크 연결을 통해 프라이빗 인스턴스로 접근할 수 있도록 구성하게 됩니다. SSH 클라이언트를 사용해서 배스천 호스트에 접속하기 위해서는 퍼블릭 DNS 또는 퍼블릭 IP 주소를 가지는 퍼블릭 인스턴스이어야하므로 배스천 호스트를 구성한다는 의미는 불필요하게 인스턴스를 유지하여 비용이 발생한다는 문제와 내부 인스턴스에 접근하기 위한 키 페어가 배스천 호스트에 있다는 단점을 가지게 됩니다.</p>
<h2 id="AWS-Systems-Manager"><a href="#AWS-Systems-Manager" class="headerlink" title="AWS Systems Manager"></a>AWS Systems Manager</h2><p>HTTPS 엔드포인트를 사용해서 인터넷과 연결되지 않는 프라이빗 서브넷에 접근할 수 있도록 관리형 인스턴스를 만들기 위해서는 아마존 웹 서비스의 Systems Manager 서비스를 통해서 <a href="https://docs.aws.amazon.com/ko_kr/systems-manager/latest/userguide/sysman-install-ssm-agent.html">SSM 에이전트</a>가 설치된 EC2 인스턴스를 관리형 인스턴스로 등록하여 관리되도록 구성해야합니다.</p>
<h3 id="호스트-관리-기능-활성화"><a href="#호스트-관리-기능-활성화" class="headerlink" title="호스트 관리 기능 활성화"></a>호스트 관리 기능 활성화</h3><p><img data-src="/images/posts/connect-private-ec2-instance/aws-ssm-quick-setup.png"></p>
<p>AWS Systems Manager의 빠른 설정 기능 중 Host Management 구성을 통해 쉽게 EC2 인스턴스를 관리형 인스턴스로 등록하기 위한 작업을 활성화 할 수 있습니다. 학습 단계이므로 간단하게 현재 리전에 대한 모든 인스턴스를 관리하도록 선택하고 생성하시기 바랍니다.</p>
<h4 id="관리형-인스턴스-조건-검토"><a href="#관리형-인스턴스-조건-검토" class="headerlink" title="관리형 인스턴스 조건 검토"></a>관리형 인스턴스 조건 검토</h4><p>Systems Manager에서 EC2 인스턴스를 관리형 인스턴스로 등록하기 위해서는 다음의 조건이 충족되어야하므로 이를 검토해야합니다.</p>
<ul>
<li>SSM 에이전트 설치 : EC2 인스턴스에 SSM 에이전트가 설치되어있어야 합니다.</li>
<li>SSM 엔드포인트 연결 : SSM 서비스가 SSM 에이전트로 통신할 수 있어야 합니다.</li>
<li>SSM IAM 역할 연결 : AmazonSSMManagedInstanceCore 정책을 포함하는 IAM 역할을 연결해야합니다.</li>
</ul>
<h3 id="SSM-에이전트를-위한-VPC-엔드포인트-구성"><a href="#SSM-에이전트를-위한-VPC-엔드포인트-구성" class="headerlink" title="SSM 에이전트를 위한 VPC 엔드포인트 구성"></a>SSM 에이전트를 위한 VPC 엔드포인트 구성</h3><p>SSM 에이전트는 SSH 프로토콜이 아닌 HTTPS 엔드포인트를 통해서 인스턴스 접근을 제공하기에 앞서 호스트 관리 구성을 통해 활성화된 SSM 에이전트가 VPC 내 프라이빗 서브넷에 접근할 수 있도록 AWS PrivateLink로 구동되는 <a href="https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html">VPC 인터페이스 엔드포인트</a>를 설정해야 합니다.</p>
<h4 id="VPC-DNS-호스트-이름-활성화"><a href="#VPC-DNS-호스트-이름-활성화" class="headerlink" title="VPC DNS 호스트 이름 활성화"></a>VPC DNS 호스트 이름 활성화</h4><p>먼저 VPC 엔드포인트를 생성하기 위해서는 VPC에 대한 속성들 중에서 <strong>DNS 호스트 이름을 활성화</strong>해야합니다.</p>
<p><img data-src="/images/posts/connect-private-ec2-instance/aws-ssm-enable-dns-name.png"></p>
<h4 id="VPC-엔드포인트-생성"><a href="#VPC-엔드포인트-생성" class="headerlink" title="VPC 엔드포인트 생성"></a>VPC 엔드포인트 생성</h4><p>VPC의 DNS 호스트 이름이 활성화되었음을 확인하였다면 <strong>EC2와 SSM 서비스에 대한 VPC 엔드포인트</strong>를 생성합니다.</p>
<p><img data-src="/images/posts/connect-private-ec2-instance/aws-ssm-vpc-endpoints.png"></p>
<h3 id="EC2-인스턴스-프로파일-지정"><a href="#EC2-인스턴스-프로파일-지정" class="headerlink" title="EC2 인스턴스 프로파일 지정"></a>EC2 인스턴스 프로파일 지정</h3><p>빠른 설정 기능의 호스트 관리 구성을 수행했기에 <strong>AmazonSSMRoleForInstancesQuickSetup</strong>이라는 IAM 역할이 자동으로 생성됩니다. 이제 EC2 인스턴스를 실행할 때 AmazonSSMRoleForInstancesQuickSetup IAM 역할을 지정하면 AWS Systems Manager가 SSM 에이전트와 통신하여 관리형 인스턴스로 등록됩니다.</p>
<p><img data-src="/images/posts/connect-private-ec2-instance/aws-ssm-managed-instance-core-policy.png"></p>
<p>AWS Systems Manager가 관리형 인스턴스로 등록하는데에 약간의 시간이 소요될 수 있어 잠시 기다리셔야하며 만약에 AmazonSSMRoleForInstancesQuickSetup IAM 역할이 자동으로 만들어지지 않았다면 AmazonSSMManagedInstanceCore 정책을 지정한 IAM 역할을 직접 생성하시기 바랍니다.</p>
<h4 id="IAM-역할"><a href="#IAM-역할" class="headerlink" title="IAM 역할"></a>IAM 역할</h4><p>다음은 IAM 역할이 지정되지 않은 인스턴스는 내부적으로 SSM 에이전트가 설치되어있어도 SSM 에이전트가 통신할 수 있는 권한이 없으므로 아래와 같이 웹 콘솔에서 Session Manager를 사용하여 인스턴스에 연결할 수 없습니다.</p>
<p><img data-src="/images/posts/connect-private-ec2-instance/aws-ssm-connect-instance-console-failed.png" alt="IAM 역할이 지정되지 않은 인스턴스"></p>
<p>만약, IAM 역할이 지정되지 않았음을 확인한다면 AmazonSSMRoleForInstancesQuickSetup 역할을 지정하시기를 바랍니다.</p>
<p><img data-src="/images/posts/connect-private-ec2-instance/aws-ssm-set-iam-role.png"></p>
<h4 id="HTTPS-인바운드-트래픽-허용"><a href="#HTTPS-인바운드-트래픽-허용" class="headerlink" title="HTTPS 인바운드 트래픽 허용"></a>HTTPS 인바운드 트래픽 허용</h4><p>AmazonSSMRoleForInstancesQuickSetup 역할을 지정하였으나 Session Manager를 통해 인스턴스 연결이 불가능하다면 VPC를 구성하는 프라이빗 네트워크 주소 범위에 대해서 HTTPS에 대한 인바운드 트래픽을 허용하도록 해야합니다. SSM 에이전트는 HTTPS 엔드포인트로 통신하여 인스턴스 접근을 제공한다는 점을 인지하셔야 합니다.</p>
<p><img data-src="/images/posts/connect-private-ec2-instance/aws-ssm-https-inbound-trafic.png"></p>
<h4 id="Session-Manager-활성화"><a href="#Session-Manager-활성화" class="headerlink" title="Session Manager 활성화"></a>Session Manager 활성화</h4><p>잘 따라오셨다면 SSM 에이전트와의 통신이 성공적으로 이루어지고 Systems Manager가 관리형 인스턴스로 등록했다면 EC2 웹 콘솔을 통해서 프라이빗 인스턴스에 배스천 호스트 없이도 직접 연결할 수 있습니다. </p>
<p><img data-src="/images/posts/connect-private-ec2-instance/aws-ssm-connect-instance-console.png"></p>
<h2 id="AWS-SSM-CLI"><a href="#AWS-SSM-CLI" class="headerlink" title="AWS SSM CLI"></a>AWS SSM CLI</h2><p>SSM 서비스에 대한 권한을 가지는 IAM 프로파일을 가지고 있다면 AWS CLI의 ssm 명령어를 사용해서 프라이빗 인스턴스에 접근할 수 있습니다. 만약, AWS CLI이 설치되지 않은 상태라면 아래와 같이 사용중인 운영체제에 맞는 방법으로 AWS CLI를 설치하시기 바랍니다.</p>
<p><img data-src="/images/posts/connect-private-ec2-instance/aws-ssm-install-aws-cli-2-for-windows.png"></p>
<h3 id="SSM-세션-시작하기"><a href="#SSM-세션-시작하기" class="headerlink" title="SSM 세션 시작하기"></a>SSM 세션 시작하기</h3><p>AWS CLI을 사용하기 위하여 <code>AmazonSSMManagedInstanceCore</code> 정책이 부여된 크레덴셜을 프로파일로 등록한 후 AWS SSM CLI의 <code>start-session</code> 명령어로 관리형 인스턴스에 대한 세션을 시작할 수 있습니다. </p>
<p><img data-src="/images/posts/connect-private-ec2-instance/aws-ssm-configure-aws-cli-profile.png" alt="IAM 프로파일 크레덴셜 구성"></p>
<p><img data-src="/images/posts/connect-private-ec2-instance/aws-ssm-cli-start-session.png"></p>
<h4 id="SSM-포트-포워딩"><a href="#SSM-포트-포워딩" class="headerlink" title="SSM 포트 포워딩"></a>SSM 포트 포워딩</h4><p>SSM 에이전트는 포트 포워딩 세션 기능도 제공하므로 다음과 같이 포트 포워딩에 대한 도큐먼트와 함께 <strong>관리형 인스턴스의 포트 번호(portNumber)</strong> 와 <strong>로컬 호스트의 포트 번호(localPortNumber)</strong> 를 파라미터로 제공하면 됩니다. 예를 들어, 프라이빗 인스턴스의 8080 포트에 대해서 로컬 호스트의 5000 포트로 연결하고자 한다면 다음과 같이 명령어를 실행하면 됩니다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">aws ssm start-session <span class="token punctuation">\</span>
--profile mambo <span class="token punctuation">\</span> 
--target <span class="token variable">$instance_id</span> <span class="token punctuation">\</span>
--document-name AWS-StartPortForwardingSession <span class="token punctuation">\</span>
--parameters <span class="token string">'&#123;"portNumber":["8080"], "localPortNumber":["5000"]&#125;'</span>

Starting session with SessionId: <span class="token variable">$session_id</span>
Port <span class="token number">5000</span> opened <span class="token keyword">for</span> sessionId <span class="token variable">$session_id</span>
Waiting <span class="token keyword">for</span> connections<span class="token punctuation">..</span>.</code></pre>

<h3 id="SSH-연결-활성화"><a href="#SSH-연결-활성화" class="headerlink" title="SSH 연결 활성화"></a>SSH 연결 활성화</h3><p>기본적으로 SSM 에이전트는 HTTPS 엔드포인트를 통해서 통신하므로 SSH 접속에 대한 22번 포트에 대한 보안 그룹 설정이 필요하지 않습니다. 그러나, SCP와 같은 동작을 위해서 <a href="https://docs.aws.amazon.com/ko_kr/systems-manager/latest/userguide/session-manager-getting-started-enable-ssh-connections.html">SSH 연결 활성화</a>를 구성하여 SSM을 통해서 SSH 연결을 수행할 수 있습니다. </p>
<p><em>~&#x2F;.ssh&#x2F;config</em></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># SSH over Session Manager</span>
<span class="token function">host</span> i-* mi-*
    ProxyCommand C:<span class="token punctuation">\</span>Windows<span class="token punctuation">\</span>System32<span class="token punctuation">\</span>WindowsPowerShell<span class="token punctuation">\</span>v1.0<span class="token punctuation">\</span>powershell.exe <span class="token string">"aws ssm start-session --target %h --document-name AWS-StartSSHSession --parameters portNumber=%p"</span></code></pre>

<blockquote>
<p>내부적으로 SSH 프로토콜을 사용한 터널링을 수행한다는 점과 SSM 에이전트를 통해 SSH 연결을 시도하면 로깅 기능은 활성화되지 않는다는 점을 감안하시기 바랍니다.</p>
</blockquote>
<h3 id="Interactive-CLI-Gossm"><a href="#Interactive-CLI-Gossm" class="headerlink" title="Interactive CLI - Gossm"></a>Interactive CLI - Gossm</h3><p>저는 사용하지는 않고 있지만 <a href="https://medium.com/@gjbae1212/aws-ssm-%EC%9D%B4%EC%9A%A9%ED%95%B4-ec2-%EC%A0%91%EC%86%8D%ED%95%98%EB%8A%94-cli-%EA%B0%9C%EB%B0%9C-62c2f7357fb8">AWS SSM 이용해 EC2 접속하는 CLI 개발</a>에서 소개하는 <a href="https://github.com/gjbae1212/gossm">gossm</a>은 AWS SSM CLI의 불편함을 보완하여 좀 더 편하게 사용할 수 있도록 제공하니 활용해보시면 좋을 것 같습니다. </p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-getting-started.html">Setting up Session Manager</a></li>
<li><a href="https://musma.github.io/2019/11/29/about-aws-ssm.html">AWS SSM으로 EC2 인스턴스에 접근하기 (SSH 대체)</a></li>
<li><a href="http://sawers.com/blog/aws-session-manager-a-better-way-to-ssh/">AWS Session Manager: A better way to SSH</a></li>
</ul>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>AWS</tag>
        <tag>SSM Agent</tag>
      </tags>
  </entry>
  <entry>
    <title>CSV, Comma Separated Values</title>
    <url>/csv/</url>
    <content><![CDATA[<p>데이터 기반의 웹 애플리케이션에서 데이터를 제공하는 방식은 다양합니다. 개발자들이 REST API를 통해 클라이언트와 서버 간의 데이터를 전달할 때 JSON 형식으로 주고받는 것을 선호하는 것과 별개로 시스템을 이용하는 일반 사용자들은 주로 사용하는 <a href="https://support.microsoft.com/ko-kr/office/excel%EC%97%90%EC%84%9C-%EC%A7%80%EC%9B%90%ED%95%98%EB%8A%94-%ED%8C%8C%EC%9D%BC-%ED%98%95%EC%8B%9D-0943ff2c-6014-4e8d-aaea-b83d51d46247">엑셀 프로그램에서 읽을 수 있는 XLS 또는 XLSX</a>로 제공하기를 선호합니다.</p>
<p>개발자들은 엑셀 프로그램에서 사용할 수 있는 XLS 또는 XLSX 파일 형식으로 데이터를 제공하는 것을 좋아하지 않습니다. 엑셀 프로그램이 데이터를 활용하기 위한 많은 기능을 제공하여 편리한 방법이기는 하지만 자바에서 엑셀 파일 형식으로 저장하기 위해서 사용하는 Apach POI와 같은 라이브러리에서 엑셀 파일 형식에 따른 제약이나 성능 이슈가 있기 때문입니다. 엑셀 파일 형식에서 가장 기본적인 제약사항은 단일 시트에 대한 최대 행수 제한입니다. 그리고 엑셀 파일에 데이터를 기록하는 방식에 따라 서버에 부하가 발생할 수 있습니다.</p>
<p>현재 조직에서 개발하는 시스템은 시계열 데이터를 수집하고 이를 활용할 수 있는 기능을 제공하므로 고객이 등록한 시계열 데이터를 다운로드할 수 있는 방법도 제공하고 있습니다. 이 요건은 시계열 데이터를 집계하여 정제된 데이터를 제공하는 것이 아니므로 고객이 보유하는 에너지 자원 및 데이터 항목만큼 파일에 포함되어야하는 데이터의 건수가 기하급수적으로 늘어날 수 있으며 그에 대한 규모를 예상하기 힘듭니다. 아무리 자바 애플리케이션에서 SXSSF로 스트리밍 방식으로 엑셀 파일에 데이터를 기록하거나 어떠한 동작을 최소화하도록 코드를 최적화한다고해도 처리해야하는 데이터 건수가 많음으로 발생하는 소요 시간 및 애플리케이션 부하에 대한 이슈는 해결되지 않습니다.</p>
<p>이러한 대용량 데이터를 다운로드하는 요건에 대해서는 불필요한 작업을 최소하하는 방안이 중요합니다. 시계열 데이터에 대해 빠른 성능을 보여주는 시계열 데이터베이스에서 애플리케이션으로 전달되는 데이터의 양을 최대한 줄일 수 있도록 해야합니다. 시계열 데이터 특성 상 같은 시간대에 대한 데이터 항목들을 열로 표현할 수 있도록 <a href="https://code.kx.com/q/kb/pivoting-tables/">테이블을 피봇하는 방법</a>이 있으므로 이를 활용하면 엑셀 파일에 기록해야하는 데이터행 수를 줄일 수 있습니다.</p>
<p>피봇 테이블을 도입하더라도 엑셀 파일이 읽을 수 있는 바이너리 파일을 만드는 것이므로 일반적인 텍스트 파일을 기록하는 작업보다 많은 부하가 발생합니다. CSV는 <a href="https://datatracker.ietf.org/doc/html/rfc4180">RFC 4180</a> 표준으로 되어있는 데이터 형식으로 테이블 형식으로 되어있는 데이터를 표현하기에 적합한 방법입니다. 표준으로 정의되어있기에 대부분의 스프레드시트 프로그램에서는 CSV 파일에 포함된 데이터를 불러올 수 있는 기능을 제공합니다. 시스템에서 사용하는 시계열 데이터베이스에서 <a href="https://code.kx.com/q/learn/tour/csvs/">테이블을 CSV로 변환할 수 있는 방법</a>도 제공하고 있으므로 애플리케이션에서 데이터를 가공하는 별도의 작업을 하지 않고 고객에게 데이터를 전달할 수 있습니다.</p>
<p>시스템의 파일 다운로드 표준은 CSV이고 XLS 및 XLSX로도 다운로드할 수 있도록 인터페이스는 제공합니다만 실제로 소요되는 시간을 비교하면 극단적으로 CSV의 다운로드에 소요되는 시간이 적은 것을 확인할 수 있었습니다.</p>
]]></content>
      <tags>
        <tag>RFC 4180</tag>
        <tag>CSV</tag>
      </tags>
  </entry>
  <entry>
    <title>X509 Certificate Signed by Unknown Authority</title>
    <url>/docker-registry-certificate/</url>
    <content><![CDATA[<blockquote>
<p>Error response from daemon: Get https://registry.domain.com&#x2F;v2&#x2F;: x509: certificate signed by unknown authority</p>
</blockquote>
<p>생각보다 많은 조직에서 사내 정책이나 도커 허브의 <a href="https://docs.docker.com/docker-hub/download-rate-limit/">다운로드 제한량</a>을 경험하고 도커에서 제공하는 <a href="https://hub.docker.com/_/registry">레지스트리 이미지</a>로 사설 도커 레지스트리 서버를 구축하는 것 같습니다. 위 오류는 도커 레지스트리 서버에 로그인을 시도할 때 나타날 수 있습니다. 우리가 사용하는 도커 엔진이라고하는 클라이언트가 도커 레지스트리 서버가 전달해준 인증서를 신뢰할 수 없다는 의미입니다. 그러면 위와 같이 내 컴퓨터에 설치된 도커 엔진에서 사설로 구축한 도커 레지스트리 서버의 인증서를 신뢰할 수 없는 문제가 발생하면 어떻게 해결하는지를 알아보도록 하죠.</p>
<h2 id="도커-레지스트리-인증서"><a href="#도커-레지스트리-인증서" class="headerlink" title="도커 레지스트리 인증서"></a>도커 레지스트리 인증서</h2><p>도커 엔진에서 참조하는 레지스트리 서버에 대한 인증서 폴더는 <strong>certs.d</strong> 입니다.</p>
<ul>
<li>Windows: C:&#x2F;ProgramData&#x2F;Docker&#x2F;certs.d&#x2F;</li>
<li>Linux: &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;</li>
<li>Mac: ~&#x2F;.docker&#x2F;certs.d&#x2F;</li>
</ul>
<pre class="language-sh" data-language="sh"><code class="language-sh">&#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;         &lt;-- Certificate directory
└── registry.domain.com:5000 &lt;-- Hostname:port
   ├── client.cert           &lt;-- Client certificate
   ├── client.key            &lt;-- Client key
   └── ca.crt                &lt;-- Certificate authority that signed the registry certificate</code></pre>

<h3 id="안전하지-않은-레지스트리"><a href="#안전하지-않은-레지스트리" class="headerlink" title="안전하지 않은 레지스트리"></a>안전하지 않은 레지스트리</h3><p>HTTPS로 실행된 도커 레지스트리 서버에 대해서 도커 엔진이 신뢰할 수 없는 인증서를 무시하도록 <a href="https://docs.docker.com/registry/insecure/">insecure-registries</a>옵션을 지정할 수 있습니다. 다만, 이 방법은 해당 도메인 주소의 레지스트리 서버가 올바른 인증서를 사용하는지 검증하지 않기 때문에 보안적인 부분을 생각한다면 일반적으로 사용해서는 안되는 방법입니다.</p>
<h3 id="신뢰할-수-있는-인증-기관"><a href="#신뢰할-수-있는-인증-기관" class="headerlink" title="신뢰할 수 있는 인증 기관"></a>신뢰할 수 있는 인증 기관</h3><p>도커 엔진은 기본적으로 시스템에 등록된 신뢰할 수 있는 인증 기관의 인증서 목록으로 도커 레지스트리 서버의 클라이언트 인증서를 검증합니다. 이는 크롬과 같은 브라우저에서 HTTPS 통신 시 서버에서 전달하는 인증서가 유효한지를 확인하는 것과 다르지 않습니다. 저는 <strong>신뢰할 수 있는 인증 기관으로부터 발급받은 도메인 인증서를 사용</strong>하여 도커 레지스트리 서버를 구축하였는데도 불구하고 도커 엔진에서는 회사 도메인 주소로된 도커 레지스트리 서버에서 전달된 인증서가 올바르지 않다며 동일하게 <code>x509: certificate signed by unknown authority</code> 오류를 알려주었습니다.</p>
<h3 id="CA-인증서-체인"><a href="#CA-인증서-체인" class="headerlink" title="CA 인증서 체인"></a>CA 인증서 체인</h3><p>도커 엔진에서 레지스트리 서버의 인증서를 신뢰할 수 없다는 것은 몇가지 사항에 대한 의미를 가질 수 있습니다. 첫번째로, 도커 레지스트리 서버 구축 시 사용한 CA 인증서가 클라이언트 인증서와 인증 기관들에 대한 인증서가 연결된 CA 인증서 체인이 아닐 수 있다는 것입니다. 실제로 지금은 UI 기반의 사용자 및 이미지 관리를 위해 <a href="https://goharbor.io/">Harbor</a>로 도커 레지스트리 서버를 재구축하였으나 기존 도커 레지스트리 서버에 사용된 CA 인증서 파일에는 클라이언트 인증서만 존재했던 문제가 있었습니다. 그래서 조직 내 개발자들에게 레지스트리 서버에서 사용된 CA 인증서 파일과 클라이언트 인증서 및 키를 전달하고 도커 레지스트리 인증서 폴더에 저장하여 사용해달라고 안내했었습니다. 결국은 도커 엔진이 도커 레지스트리 서버를 신뢰할 수 없으므로 CA 인증서 체인을 신뢰할 수 있는 인증서 목록에 포함시키면 됩니다.</p>
<p>예를 들어, <a href="https://support.apple.com/ko-kr/guide/keychain-access/kyca2431/mac">Mac용 키체인 접근을 사용하여 키체인에 인증서 추가하기</a>에 따라 CA 인증서를 추가하면 다음과 같이 유효한 인증서임이 표시됨을 확인할 수 있었습니다.</p>
<p><img data-src="/images/posts/docker-registry-certificate/trust-certificate.png"></p>
<pre class="language-sh" data-language="sh"><code class="language-sh">docker login registry.domain.com -u &#39;username&#39; -p &#39;password&#39;
WARNING! Using --password via the CLI is insecure. Use --password-stdin.
Login Succeeded</code></pre>

<blockquote>
<p>도커 레지스트리 서버의 CA 인증서 체인을 시스템 인증서로 등록하고나서는 도커 엔진이 신뢰할 수 있는 인증서 목록에 따라 인증서가 유효함을 확인함으로 정상적으로 HTTPS 통신이 이루어지고 로그인에 성공하였습니다. 레지스트리 서버에 대한 로그인 예시이므로 CLI 경고 문구는 무시해주세요.</p>
</blockquote>
<h4 id="시스템-및-사용자-정의-CA-인증서-병합"><a href="#시스템-및-사용자-정의-CA-인증서-병합" class="headerlink" title="시스템 및 사용자 정의 CA 인증서 병합"></a>시스템 및 사용자 정의 CA 인증서 병합</h4><p><em>On Linux any root certificates authorities are merged with the system defaults, including the host’s root CA set. If you are running Docker on Windows Server, or Docker Desktop for Windows with Windows containers, the system default certificates are only used when no custom root certificates are configured.</em></p>
<p><a href="https://docs.docker.com/engine/security/certificates/#understand-the-configuration">공식문서</a>에 따르면 위와 같이 사용자 정의 인증서(certs.d)는 시스템 인증서와 CA 인증서가 합쳐져서 등록된다는 내용이 있습니다. 따라서, 도커 레지스트리 서버의 CA 인증서 체인을 <strong>시스템 인증서 목록</strong>이나 <strong>certs.d</strong> 폴더에 두면 된다는 이야기입니다. 실제로 시스템 인증서로 등록하지 않아도 certs.d 폴더에 ca.crt라는 이름으로 CA 인증서 체인을 두게되면 동일하게 동작함을 확인할 수 있었습니다.</p>
<blockquote>
<p>한가지 흥미로운 점은 이 글을 작성하기 위해 Docker Desktop for Windows 에서도 테스트를 해본 결과 도커 레지스트리 서버의 CA 인증서 체인을 굳이 등록하지 않아도 정상적으로 로그인이 되었다는 점입니다. 이점으로 보았을때 모든 운영체제에서 동일하게 동작하지는 않는 것 같아보입니다. 따라서, 도커 엔진에서 레지스트리 서버를 신뢰할 수 없다고 한다면 레지스트리 서버 관리자에게 인증서 체인을 전달받아서 등록하는게 좋을 것 같습니다.</p>
</blockquote>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>Docker Registry</tag>
        <tag>Harbor</tag>
        <tag>Certificate</tag>
      </tags>
  </entry>
  <entry>
    <title>EC2 인스턴스에서 S3 버킷 액세스하기</title>
    <url>/ec2-instance-access-s3-bucket/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>오늘은 EC2 인스턴스에서 S3 버킷에 액세스할 수 있도록 구성하는 방법에 대해 알아봅니다.</p>
<p>최근 회사에서 진행하고 있는 프로젝트 중에는 보안 정책에 의해 고객이 구성한 EC2 인스턴스에 대한 접근 정보만을 제공받아 애플리케이션 실행해야하는 요구사항이 생겼습니다. 현재 애플리케이션에서 사용중인 데이터베이스 중에는 EC2 인스턴스에 직접 설치하여 사용하고 있는 상용 시계열 데이터베이스가 있습니다. 이 데이터베이스의 데이터를 주기적으로 백업하기 위하여 매일 1시에 파일로 저장된 데이터를 압축하여 S3로 저장하는 스크립트를 수행하고 있습니다. 고객이 보유한 EC2 인스턴스에서 이 데이터베이스의 백업 파일을 저장하기 위한 S3 버킷에 대한 권한을 지정해주도록 유도할 예정입니다.</p>
<h2 id="S3-버킷-정책"><a href="#S3-버킷-정책" class="headerlink" title="S3 버킷 정책"></a>S3 버킷 정책</h2><p>S3에서 버킷을 만들면 기본적으로 <strong>모든 퍼블릭 액세스 차단</strong>됩니다.</p>
<p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-01.png"></p>
<p>그리고 <strong>버킷 정책</strong>을 통해 버킷 또는 버킷에 저장된 오브젝트에 대한 액세스 권한을 부여할 수 있습니다. </p>
<h3 id="버킷-정책-생성"><a href="#버킷-정책-생성" class="headerlink" title="버킷 정책 생성"></a>버킷 정책 생성</h3><p>버킷 정책을 생성할 때는 아마존 웹 서비스에서 제공하는 <a href="http://awspolicygen.s3.amazonaws.com/policygen.html">AWS Policy Generator</a>를 사용하는 것이 좋습니다.</p>
<p>다음은 특정 IP에 대해서 버킷에 대한 조회, 읽기, 쓰기 권한을 부여하는 정책을 생성한 예시입니다.</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"s3:ListBucket"</span><span class="token punctuation">,</span>
                <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span>
                <span class="token string">"s3:PutObject"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"arn:aws:s3:::mambo.kr"</span><span class="token punctuation">,</span>
                <span class="token string">"arn:aws:s3:::mambo.kr/*"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Condition"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token property">"IpAddress"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                    <span class="token property">"aws:SourceIp"</span><span class="token operator">:</span> <span class="token string">"218.156.190.x/32"</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>버킷 정책을 정의하는 JSON의 크기는 20kB로 제한됩니다.</p>
</blockquote>
<p>버킷 정책에 대한 더 자세한 내용은 <a href="https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/example-bucket-policies.html">버킷 정책 예제</a> 문서를 참고하세요.</p>
<h2 id="EC2-인스턴스"><a href="#EC2-인스턴스" class="headerlink" title="EC2 인스턴스"></a>EC2 인스턴스</h2><p>아마존 리눅스 AMI로 EC2 인스턴스를 실행하면 AWS CLI가 기본으로 설치되어있습니다. 따라서, AWS CLI를 사용해서 S3 서비스에 작업을 수행할 수 있습니다.</p>
<h3 id="IAM-역할-생성"><a href="#IAM-역할-생성" class="headerlink" title="IAM 역할 생성"></a>IAM 역할 생성</h3><p>S3 버킷 권한 설정에서 버킷 정책을 설정할 수 있으나 IAM 역할을 만들고 인라인 정책으로 적용할 수도 있습니다. 우리는 EC2 인스턴스에서 접근해야하므로 EC2 서비스에 대한 IAM 역할을 만들어서 인스턴스 프로파일로 등록하겠습니다.</p>
<p>먼저, EC2 인스턴스에서 AWS CLI로 버킷을 조회해보겠습니다.</p>
<p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-02.png"></p>
<p>현재 EC2 인스턴스에는 IAM 인스턴스 프로파일이 지정되어있지 않기 때문에 오류가 발생합니다.</p>
<p>IAM 메뉴에서 신규로 역할을 생성합니다.</p>
<p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-03.png"></p>
<p>S3 버킷에 대한 권한을 인라인 정책으로 정의할 것이므로 관리형 정책은 설정하지않습니다.</p>
<p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-04.png"></p>
<p>생성한 IAM 역할을 EC2 인스턴스 프로파일로 지정합니다.</p>
<p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-05.png"></p>
<p>IAM 역할에 어떠한 정책을 적용하지 않고 버킷을 조회해보겠습니다.</p>
<p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-06.png"></p>
<p>IAM 역할을 지정하였기에 AWS CLI를 사용할 수 있게 되었지만 mambo.kr 이라는 버킷에 대한 ListObjectsV2 작업은 Access Denied 오류가 발생했습니다.</p>
<h3 id="인라인-정책"><a href="#인라인-정책" class="headerlink" title="인라인 정책"></a>인라인 정책</h3><p>우리가 생성한 IAM 역할에는 어떠한 정책도 연결하지 않았기 때문에 접근 권한을 가지지 않는게 당연합니다. 다시 IAM 메뉴로 돌아가서 <strong>인라인 정책 추가</strong>를 선택합니다.</p>
<p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-07.png"></p>
<p>버킷 정책 예제를 참고해서 다음과 같이 JSON 형식으로 버킷 정책을 정의합니다.</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token property">"Sid"</span><span class="token operator">:</span> <span class="token string">"Mannual"</span><span class="token punctuation">,</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"s3:ListBucket"</span><span class="token punctuation">,</span>
                <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span>
                <span class="token string">"s3:PutObject"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"arn:aws:s3:::mambo.kr"</span><span class="token punctuation">,</span>
                <span class="token string">"arn:aws:s3:::mambo.kr/*"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-08.png"></p>
<h3 id="버킷-조회"><a href="#버킷-조회" class="headerlink" title="버킷 조회"></a>버킷 조회</h3><p>S3 버킷에 대한 정책이 IAM 인라인 정책으로 연결되었으니 버킷에 대한 접근 권한이 가지게 되었는지 확인합니다.</p>
<p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-09.png"></p>
<p>EC2 인스턴스에서 사용자 계정의 보유한 S3 버킷에 대한 목록은 권한이 없어서 조회할 수 없으나 인라인 정책으로 정의된 mambo.kr 버킷에 대해서는 조회되었습니다.</p>
<p>만약, S3 버킷 목록을 조회하고 싶다면 다음과 같이 Statement를 추가하시면 됩니다.</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token property">"Sid"</span><span class="token operator">:</span> <span class="token string">"Mannual"</span><span class="token punctuation">,</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"s3:ListBucket"</span><span class="token punctuation">,</span>
                <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span>
                <span class="token string">"s3:PutObject"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"arn:aws:s3:::mambo.kr"</span><span class="token punctuation">,</span>
                <span class="token string">"arn:aws:s3:::mambo.kr/*"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span>
            <span class="token property">"Sid"</span><span class="token operator">:</span> <span class="token string">"Mannual-2"</span><span class="token punctuation">,</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"s3:ListBucket"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"arn:aws:s3:::*/*"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>빈 텍스트 파일을 만들어서 버킷에 업로드하고 가져올 수 있는지 확인해보겠습니다.</p>
<p><img data-src="/images/posts/ec2-instance-access-s3-bucket/s3-bucket-10.png"></p>
<p>S3에 저장할 수 있는 크기에 대한 제한은 없으나 PUT 요청으로 업로드 가능한 크기는 최대 5GB입니다. AWS CLI의 S3 명령어를 사용하는 경우 일정 크기 이상이라면 멀티파트 업로드를 수행하므로 알고 계시고 신경쓰지 않아도 됩니다.</p>
<h2 id="마치며"><a href="#마치며" class="headerlink" title="마치며"></a>마치며</h2><p>퍼블릭 IP가 할당되지 않는 EC2 인스턴스라면 AWS PrivateLink로 구성되는 VPC 인터페이스 엔드포인트를 사용하여 <a href="https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/privatelink-interface-endpoints.html">S3 서비스와 통신할 수 있도록 설정</a>해야합니다. 그리고 다른 사용자 계정의 ARN을 제공받아서 접근할 수 있게 구성할 수도 있으니 공식 문서에서 제공하는 다양한 정책 예제를 참고해봅시다.</p>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>EC2</tag>
        <tag>S3</tag>
      </tags>
  </entry>
  <entry>
    <title>EC2 Node Exporter</title>
    <url>/ec2-node-exporter/</url>
    <content><![CDATA[<p>조직에서 아마존 웹 서비스를 클라우드 환경으로 사용하곤 있지만 인프라 엔지니어로 구성된 인프라팀이 별도로 존재하지 않다보니 클라우드 서비스를 제대로 활용하지 않고 필요하다고 생각될 때 어떻게 사용해야하는가를 찾아보고 고민하게 되는 것 같습니다. 서버 인스턴스 모니터링에 대해서도 기본적으로는 웹 콘솔에서 지표를 확인할 수 있도록 <a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/monitoring_ec2.html">Amazon EC2 모니터링</a>기능을 제공하고 있지만 5분 단위로 수집되는 지표를 1분 단위로 수집하기 위해서는 <a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/using-cloudwatch-new.html">인스턴스에 대한 세부 모니터링 활성화</a>를 해야하고 더 많은 인스턴스에 대한 지표를 확인하기 위해서는 EC2 인스턴스에 <a href="https://docs.aws.amazon.com/ko_kr/AmazonCloudWatch/latest/monitoring/installing-cloudwatch-agent-ssm.html">CloudWatch 에이전트 설치</a>해야하고 별도의 비용이 추가적으로 든다는 점으로 인하여 사용하지는 않고 있습니다.</p>
<p>회사 사내 서버에 개인적으로 프로메테우스 및 그라파나 서버를 실행해두었기 때문에 Node Exporter를 활용해서 EC2 인스턴스에 접속할 수 있는 권한이 있다면 지표를 수집할 수 있는 방안을 마련할 수 있다고 생각되었습니다. 고객으로 부터 웹 콘솔을 접근할 수 있는 권한을 부여받기도 하고 어떤 고객은 보안 상 이유로 인하여 인프라 구성과 관리는 직접 담당하고 정해진 스펙에 따라서 생성한 EC2 인스턴스 접속 권한만 부여하기 때문에 CloudWatch를 공통적으로 사용하도록 할 수 없습니다.</p>
<blockquote>
<p>회사 사내 서버에 임시적으로 구성한 프로메테우스 및 그라파나는 모니터링 방안이 검토되면 조직내에서 운영중인 클라우드 환경으로 이전할 생각입니다.</p>
</blockquote>
<p>아무튼 현재 조직에서 모니터링 방안을 제대로 검토할 수 있는 단계는 아니지만 고객의 인프라 환경에 시스템을 배포하고 운영하고 있으므로 최소한 원인을 찾아가기 위한 지표는 남겨두어야한다고 생각하기에 Node Exporter를 일괄적으로 설치하는 작업을 수행했고 이에 대한 정보를 남기고자 합니다.</p>
<h2 id="Node-Exporter"><a href="#Node-Exporter" class="headerlink" title="Node Exporter"></a>Node Exporter</h2><p><a href="https://github.com/prometheus/node_exporter">Node Exporter</a>는 프로메테우스 프로젝트에서 공식적으로 지원하는 시스템 매트릭을 수집하는 방법을 제공하는 Exporter 입니다. <a href="https://prometheus.io/docs/guides/node-exporter/#installing-and-running-the-node-exporter">Installing and running the Node Exporter</a>와 같이 Node Exporter를 설치하고 실행하는 방법에 대한 가이드 문서도 제공하고 있습니다.</p>
<p>EC2 인스턴스는 상태가 정상적이지 않음이 확인되면 <a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/ec2-instance-recover.html">인스턴스 복구</a> 기능으로 아마존 웹 서비스에서 자동으로 인스턴스 상태를 복원할 수 있습니다. 그래서 언제든지 EC2 인스턴스가 재부팅되어 실행중인 프로세스가 종료될 수 있습니다. 서버 인스턴스가 재부팅되어도 자동으로 프로세스가 실행되도록 유지하기 위해서 Systemd와 같은 서비스를 등록하도록 구성하는 것이 좋습니다.</p>
<h3 id="EC2-인스턴스-아키텍처"><a href="#EC2-인스턴스-아키텍처" class="headerlink" title="EC2 인스턴스 아키텍처"></a>EC2 인스턴스 아키텍처</h3><p>아마존 웹 서비스에서는 일반적으로 사용되는 amd64 기반의 아키텍처 뿐만 아니라 <a href="https://aws.amazon.com/ko/ec2/graviton/">Arm 기반의 AWS Graviton 프로세서</a>로 제공되는 인스턴스를 제공하고 최근에는 Arm 기반의 인스턴스를 통해 더 저렴한 가격으로 서버 인스턴스를 실행하므로 EC2 인스턴스의 아키텍처를 확인하고 사용할 수 있는 올바르게 빌드된 파일을 다운로드 받아서 설치해야합니다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">uname</span> -rmpo
<span class="token number">4.14</span>.256-197.484.amzn2.aarch64 aarch64 aarch64 GNU/Linux</code></pre>

<h3 id="릴리즈-파일-다운로드-및-설치"><a href="#릴리즈-파일-다운로드-및-설치" class="headerlink" title="릴리즈 파일 다운로드 및 설치"></a>릴리즈 파일 다운로드 및 설치</h3><p>EC2 인스턴스의 아키텍처 유형을 확인했다면 <a href="https://github.com/prometheus/node_exporter/releases">릴리즈 파일</a>에서 위 아키텍처에 맞는 arm64가 포함된 릴리즈 파일을 다운로드합니다. 대부분의 예제는 일반적으로 사용하는 x86_64 아키텍처를 기준으로 하기 때문에 amd64를 다운로드 합니다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://github.com/prometheus/node_exporter/releases/download/v1.3.1/node_exporter-1.3.1.linux-arm64.tar.gz

<span class="token function">tar</span> zxvf node_exporter-1.3.1.linux-arm64.tar.gz
<span class="token function">sudo</span> <span class="token function">cp</span> node_exporter-1.3.1.linux-arm64/node_exporter /usr/local/bin/

<span class="token function">sudo</span> <span class="token function">useradd</span> -M -r -s /bin/false node_exporter
<span class="token function">sudo</span> <span class="token function">chown</span> node_exporter:node_exporter /usr/local/bin/node_exporter</code></pre>

<h4 id="Node-Exporter-용-사용자-추가"><a href="#Node-Exporter-용-사용자-추가" class="headerlink" title="Node Exporter 용 사용자 추가"></a>Node Exporter 용 사용자 추가</h4><p>인프라 엔지니어가 아니기에 사용자를 직접 추가해본적이 없어서 사용자를 추가하는 명령어에 대해서 알아보아야했습니다. 많은 예제들에서 사용자 추가 시 적용하는 옵션이 제각각이라서 더 혼란이 있었습니다. </p>
<ul>
<li><a href="https://linux.die.net/man/8/useradd">useradd(8) - Linux man page</a></li>
<li><a href="https://faq.hostway.co.kr/Linux_ETC/1624">&#x2F;bin&#x2F;false, &#x2F;sbin&#x2F;nologin 의 차이점</a></li>
<li><a href="https://linuxhint.com/add-user-linux/">How do I add a user in Linux without a home directory?</a></li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># sudo useradd --no-create-home --system --shell /bin/false node_exporter</span>
<span class="token function">sudo</span> <span class="token function">useradd</span> -M -r -s /bin/false node_exporter</code></pre>

<blockquote>
<p>시스템 계정을 생성하되 로그인이 불가능하도록 하면 되는 것 같습니다.</p>
</blockquote>
<h3 id="Systemd-서비스-등록"><a href="#Systemd-서비스-등록" class="headerlink" title="Systemd 서비스 등록"></a>Systemd 서비스 등록</h3><p>설치한 바이너리를 실행하기 위해서 Systemd 서비스를 등록하고 Systemctl 명령어를 통해 프로세스를 실행하고 서버가 부팅될 때 자동으로 시작되도록 활성화합니다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">tee</span> /etc/systemd/system/node_exporter.service <span class="token operator">&lt;&lt;</span><span class="token string">"EOF"
[Unit]
Description=Node Exporter
After=network.target

[Service]
User=node_exporter
Group=node_exporter
ExecStart=/usr/local/bin/node_exporter

[Install]
WantedBy=multi-user.target
EOF</span>

<span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl start node_exporter
<span class="token function">sudo</span> systemctl status node_exporter
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> node_exporter</code></pre>

<h3 id="매트릭-확인"><a href="#매트릭-확인" class="headerlink" title="매트릭 확인"></a>매트릭 확인</h3><p>Node Exporter 서비스가 정상적으로 실행됬다면 curl 명령어를 통해서 지표를 가져올 수 있는지 확인하고 종료합니다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> -s localhost:9100/metrics</code></pre>

<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://docs.vmware.com/en/VMware-vRealize-Operations-Management-Pack-for-Kubernetes/1.6/kubernetes-solution/GUID-A1B68BE5-EF38-48E1-AA80-FD71E6F19989.html">Node Exporter Setup on Linux Nodes</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-install-prometheus-on-ubuntu-16-04">How To Install Prometheus on Ubuntu 16.04</a></li>
<li><a href="https://devdojo.com/ruanbekker/getting-started-with-prometheus-and-node-exporter">Getting Started with Prometheus and Node Exporter</a></li>
<li><a href="https://devopscube.com/monitor-linux-servers-prometheus-node-exporter/">How To Monitor Linux Servers Using Prometheus Node Exporter</a></li>
</ul>
]]></content>
      <tags>
        <tag>EC2</tag>
        <tag>node-exporter</tag>
      </tags>
  </entry>
  <entry>
    <title>ED25519</title>
    <url>/ed25519/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>오늘은 보안 관련 기술인 타원곡선 암호 알고리즘을 기반으로 하는 <strong>ED25519</strong>라는 것에 대해 알아보려고 합니다. </p>
<p>아마존 웹 서비스에서는 2021년 8월 17일부터 EC2 인스턴스 접근을 위해 <a href="https://aws.amazon.com/about-aws/whats-new/2021/08/amazon-ec2-customers-ed25519-keys-authentication/">ED25519 형식의 키로 SSH 연결을 수행할 수 있도록 지원</a>하였으며 2021년 9월 1일에는 깃허브에서도 DSA 형식의 키를 제거하고 <a href="https://github.blog/2021-09-01-improving-git-protocol-security-github/">ECDSA와 ED25519 형식의 키를 추가</a>하기로 결정하였습니다. </p>
<p>공통으로 언급되고 있는 ED25519라는 것을 모르시는 분이라면 저와 함께 알아보도록 합시다. </p>
<p><img data-src="/images/posts/ed25519/ed25519-00.gif"></p>
<h2 id="ED25519"><a href="#ED25519" class="headerlink" title="ED25519"></a>ED25519</h2><p>ED25519(Ed25519)는 ECC(Elliptic Curve Cryptography) 알고리즘으로 수행하도록 구현된 전자서명입니다. 타원곡선 암호 알고리즘을 사용하는 공개키 암호화 방식은 <strong>기존의 RSA와 비교해서 동일한 안정성을 가지면서도 상대적으로 더 적은 길이의 키</strong>를 가진다고 합니다. 컴퓨터 연산 속도가 발전함에 따라 일반적으로 사용되는 RSA의 권장되는 키 길이가 길어짐으로 인하여 일반 컴퓨터 또는 디바이스에서는 연산 속도가 느려지는 단점을 가지게 되고 상대적으로 작은 키 길이를 사용할 수 있으면서 동일한 안정성을 보여주므로 권장되는 공개키 암호화 방식이라고 할 수 있습니다.</p>
<blockquote>
<p>RSA와 비교해서 보안적으로 우수하다고 볼 순 없지만 상대적으로 비교하여 효율적이라는 것을 이해하셔야합니다.</p>
</blockquote>
<h3 id="타원-곡선"><a href="#타원-곡선" class="headerlink" title="타원 곡선"></a>타원 곡선</h3><p>ED25519는 어떤 타원 곡선을 사용하여 구현된 전자서명일지 궁금해집니다. 다음은 암호화에 적합하다고 판단되어 표준으로 정의된 타원 곡선들입니다.</p>
<ul>
<li>secp256k1</li>
<li>secp256r1</li>
<li>prime256v1</li>
<li>Curve25519</li>
</ul>
<p>미국 국립표준연구소(NIST) 또는 <a href="https://www.secg.org/">표준 암호화 그룹(SECG)</a>에서는 효율적인 타원 곡선들에 이름을 부여했습니다. 예를 들어, ECC NIST P-256은 SECG에서 정의한 secp256r1과 prime256v1를 지칭한 것과 같습니다. </p>
<p>표준으로 정의된 다양한 타원 곡선들에 대한 자세한 내용은 다음의 두 문서를 통해 확인할 수 있습니다.</p>
<ul>
<li><a href="https://www.secg.org/sec2-v2.pdf">SEC 2: Recommended Elliptic Curve Domain Parameters</a></li>
<li><a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.186-4.pdf">Digital Signature Standard (DSS)</a></li>
</ul>
<p>저로서는 이해하기 힘든 부분이라고 생각하여 설명은 생략하며 간단하게 말해서 여러가지 타원 곡선 형태를 <strong>도메인 파라미터로 정의</strong>하여 이름을 부여한 것 입니다. NIST P-256은 NIST에서 정의한 소수 기반의 타원 곡선 방정식을 말하며 <a href="https://en.bitcoin.it/wiki/Secp256k1">secp256k1</a>는 SECG에서 정의한 Koblitz curve 기반의 타원 곡선 방정식을 말합니다. </p>
<blockquote>
<p>비트코인과 이더리움에서도 secp256k1 라는 타원곡선을 사용한다고…</p>
</blockquote>
<h3 id="키-교환과-전자-서명"><a href="#키-교환과-전자-서명" class="headerlink" title="키 교환과 전자 서명"></a>키 교환과 전자 서명</h3><p>타원 곡선을 사용하여 디피-헬먼 키 교환을 구현한 알고리즘을 ECDH라고 하며 타원 곡선 암호를 사용해서 <a href="https://ko.wikipedia.org/wiki/%EB%94%94%EC%A7%80%ED%84%B8_%EC%84%9C%EB%AA%85_%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98">전자서명 알고리즘(DSA)</a>를 구현한 것을 <strong>ECDSA</strong>라고 합니다. ECDSA는 지난 <a href="../ssl-certificate">SSL 인증서</a> 글에서 TLS 핸드쉐이크 과정에서 ECDHE_ECDSA와 같은 타원 곡선 암호 방식을 사용하는 것을 통해 이미 확인한 개념인데 기억하시는 분이 계실지 모르겠습니다.</p>
<p>타원 곡선 기반의 전자 서명 알고리즘에는 <a href="https://en.wikipedia.org/wiki/EdDSA">EdDSA</a>도 있으며 <strong>Twisted Edwards curve</strong>와 <strong>Schnorr 서명 방식</strong>을 사용하도록 구현된 DSA 입니다.</p>
<h3 id="X25519-그리고-Ed25519"><a href="#X25519-그리고-Ed25519" class="headerlink" title="X25519 그리고 Ed25519"></a>X25519 그리고 Ed25519</h3><p>앞서 언급된 타원 곡선 중 Curve25519는 키 교환 알고리즘인 디피-헬먼과 같이 사용하도록 고안된 타원 곡선입니다. Curve25519를 기반으로하여 ECDH로 키 교환을 수행하는 것을 X25519라고 하게 됩니다. 그리고 Curve25519과 함께 SHA-512와 같은 <strong>해시 함수</strong>를 사용하는 구현된 EdDSA를 <strong>Ed25519</strong>라는 이름으로 부르게 됩니다. </p>
<ul>
<li>ECDSA : 타원 곡선 기반의 전자 서명 알고리즘</li>
<li>X25519 : Curve25519를 사용하는 타원 곡선 키 교환 알고리즘</li>
<li>Ed25519 : Curve25519를 사용하는 타원 곡선 전자 서명 알고리즘</li>
</ul>
<p><img data-src="/images/posts/ed25519/ed25519-04.gif" alt="머리속에 정리가 잘 되셨나요?"></p>
<h3 id="ED25519-키-페어"><a href="#ED25519-키-페어" class="headerlink" title="ED25519 키 페어"></a>ED25519 키 페어</h3><p>지금부터는 ED25519 형식의 키 페어를 만들고 EC2 인스턴스에 접근해보는 것을 따라해보겠습니다. </p>
<h4 id="키-페어-생성하기"><a href="#키-페어-생성하기" class="headerlink" title="키 페어 생성하기"></a>키 페어 생성하기</h4><p>먼저, ED25519 형식의 키 페어는 OpenSSH를 통해 만들 수도 있고 아마존 웹 서비스를 통해 ED25519 형식의 키 페어를 생성할 수 있습니다. </p>
<p><img data-src="/images/posts/ed25519/ed25519-01.png"></p>
<blockquote>
<p>2021년 8월 17일 부터는 콘솔을 통해 ED25119 키 페어를 사용하여 EC2 인스턴스 연결이 가능하다고 했는데 우측 제약사항에는 아직 업데이트되지 않은 듯 합니다.</p>
</blockquote>
<p>아래와 같이 AWS CLI의 create-key-pair 명령어를 통해서도 ED25519 키 페어를 생성할 수 있습니다.</p>
<pre class="language-ps" data-language="ps"><code class="language-ps">aws ec2 create-key-pair --key-name mambo --key-type ed25519 --query &quot;KeyMaterial&quot; --output text &gt; aws-mambo.pem
aws ec2 describe-key-pairs
&#123;
    &quot;KeyPairs&quot;: [
        &#123;
            &quot;KeyPairId&quot;: &quot;###&quot;,
            &quot;KeyFingerprint&quot;: &quot;###&quot;,
            &quot;KeyName&quot;: &quot;mambo&quot;,
            &quot;KeyType&quot;: &quot;ed25519&quot;,
            &quot;Tags&quot;: []
        &#125;
    ]
&#125;</code></pre>

<p>아마존 웹 서비스에 키 페어가 생성되었으면 VPC에 EC2 인스턴스를 시작할 때 SSH 접속 시 사용될 ED25519 키 페어를 선택할 수 있습니다. </p>
<p><img data-src="/images/posts/ed25519/ed25519-02.png"></p>
<p>EC2 인스턴스가 실행되었으면 아마존 웹 서비스 콘솔의 EC2 인스턴스 연결 기능을 통해 인스턴스에 접속해보겠습니다.</p>
<p><img data-src="/images/posts/ed25519/ed25519-03.png"></p>
<p>ED25519 키 페어를 사용해서 EC2 인스턴스 연결에 성공하였습니다. 그런데 말이죠, 아마존 웹 서비스에서 생성된 ED25519 키 페어를 윈도우 10에서 지원하는 SSH 클라이언트에서 사용해보면 잘못된 형식이라고 로그가 출력되고 EC2 인스턴스에 연결할 수 없음을 확인했습니다.</p>
<pre class="language-none"><code class="language-none">ssh -i &quot;aws-mambo.pem&quot; ec2-user@ec2-3-36-96-111.ap-northeast-2.compute.amazonaws.com

The authenticity of host &#39;ec2-3-36-96-111.ap-northeast-2.compute.amazonaws.com (3.36.96.111)&#39; can&#39;t be established.
ECDSA key fingerprint is SHA256:gvSJ&#x2F;qfnIlB8bkTE78QY65HO4px3YpoYvsyAv90LsTE.
Are you sure you want to continue connecting (yes&#x2F;no)? yes
Warning: Permanently added &#39;ec2-3-36-96-111.ap-northeast-2.compute.amazonaws.com,3.36.96.111&#39; (ECDSA) to the list of known hosts.
Load key &quot;aws-mambo.pem&quot;: invalid format
ec2-user@ec2-3-36-96-111.ap-northeast-2.compute.amazonaws.com: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).</code></pre>

<p>아마존 웹 서비스가 만들어주는 ED25519 형식의 키 페어를 사용하지 않고 직접 윈도우 10에서 ssh-keygen을 통해 ED25519 형식의 키 페어를 생성하고 아마존 웹 서비스에 퍼블릭 키를 추가하면 정상적으로 EC2 인스턴스 연결할 수 있습니다. </p>
<pre class="language-none"><code class="language-none">ssh-keygen -t ed25519 -m PEM -f .&#x2F;mambo.pem</code></pre>

<p>이처럼 아마존 웹 서비스에서 만들어주는 ED25519 형식의 키 페어는 윈도우에서 사용할 수 없기 때문에 주의해야할 것 같습니다.</p>
<p>타원곡선 암호에 대해서 더 자세히 알고 싶다면 다음의 글들을 참고해보시기를 추천드립니다.</p>
<ul>
<li><a href="https://medium.com/humanscape-tech/blockchain-elliptic-curve-cryptography-ecc-49e6d7d9a50a">[Blockchain] Elliptic Curve Cryptography(ECC)</a></li>
<li><a href="https://naleejang.tistory.com/218">보안 그리고 암호화 알고리즘</a></li>
</ul>
<p>감사합니다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc4492">Elliptic Curve Cryptography (ECC) Cipher Suites for Transport Layer Security (TLS)</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7748">Elliptic Curves for Security</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc8032">Edwards-Curve Digital Signature Algorithm (EdDSA)</a></li>
<li><a href="https://ed25519.cr.yp.to/">Ed25519: high-speed high-security signatures</a></li>
</ul>
]]></content>
      <tags>
        <tag>ECC</tag>
        <tag>Ed25519</tag>
      </tags>
  </entry>
  <entry>
    <title>Elastic Beanstalk S3 Authentication</title>
    <url>/elastic-beanstalk-s3-auth/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>오늘은 Elastic Beanstalk 구성 시 S3 프라이빗 저장소에서 파일을 받아오는 것을 알아보고자 합니다. 지난 <a href="../tls-offload">TLS 오프로드</a>에서 Nginx 에서 사용할 SSL 인증서를 Beanstalk 환경 구성 파일의 <a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/customize-containers-ec2.html#linux-files">파일 키</a>를 사용하여 생성했었습니다. 하지만, 보안을 중요시하는 회사라면 애플리케이션 소스 번들에 인증서와 개인키를 포함시키는 것을 허용하지 않을 수 있습니다. 그렇기 때문에 애플리케이션 소스 번들에 인증서를 포함하지 않고 애플리케이션 배포 단계에서 가져올 수 있는 방안을 마련해야합니다.</p>
<h2 id="Beanstalk-S3-Auth"><a href="#Beanstalk-S3-Auth" class="headerlink" title="Beanstalk S3 Auth"></a>Beanstalk S3 Auth</h2><p>Beanstalk 확장 구성 파일에서 CloudFormation의 <a href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/aws-resource-authentication.html">AWS::CloudFormation::Authentication</a> 리소스를 사용하여 S3 버킷에 대한 자격 증명을 지정할 수 있고 인증을 수행하여 S3 저장소에 등록되어있는 인증서를 가져올 수 있습니다. <a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/https-storingprivatekeys.html">프라이빗 키를 Amazon S3에 안전하게 저장</a>에서 알려주는 대로 Beanstalk 구성 시 <a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/ebextensions-functions.html#ebextensions-functions-getoptionsetting">Fn::GetOptionSetting</a> 함수를 활용하면 됩니다.</p>
<h3 id="S3-Bucket-Policy"><a href="#S3-Bucket-Policy" class="headerlink" title="S3 Bucket Policy"></a>S3 Bucket Policy</h3><p>먼저, <strong>AWS::CloudFormation::Authentication</strong> 리소스로 S3 버킷에 대한 자격 증명을 가질 수 있도록 S3 버킷에 보안 정책을 설정해야 합니다. 일반적으로 Beanstalk으로 애플리케이션을 배포하는 경우 <strong>aws-elasticbeanstalk-ec2-role</strong>을 인스턴스 프로파일로 가지게 됩니다. 인증서 파일이 저장된 S3 버킷은 퍼블릭 액세스가 차단되어있으므로 EC2 인스턴스가 <a href="https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/add-bucket-policy.html">버킷에 대한 권한을 가지도록 정책을 추가</a>합니다.</p>
<p><img data-src="/images/posts/elastic-beanstalk-s3-auth-01.png"></p>
<h3 id="Extend-Nginx"><a href="#Extend-Nginx" class="headerlink" title="Extend Nginx"></a>Extend Nginx</h3><p>이제 이전에 작성하였던 SSL 인증서를 만들어내는 구성 파일을 S3에서 받아오도록 작성해야합니다. files 키의 <strong>content</strong> 항목을 제거하고 다음의 항목을 추가합니다.</p>
<ul>
<li>source : S3 인증서 오브젝트 URL</li>
<li>authentication : 인증 속성 이름</li>
</ul>
<pre class="language-yaml" data-language="yaml"><div class="caption"><span>.ebextensions/nginx-cert.config</span></div><code class="language-yaml"><span class="token key atrule">Resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">AWSEBAutoScalingGroup</span><span class="token punctuation">:</span>
        <span class="token key atrule">Metadata</span><span class="token punctuation">:</span>
            <span class="token key atrule">AWS::CloudFormation::Authentication</span><span class="token punctuation">:</span>
                <span class="token key atrule">S3Auth</span><span class="token punctuation">:</span>
                    <span class="token key atrule">type</span><span class="token punctuation">:</span> S3
                    <span class="token key atrule">buckets</span><span class="token punctuation">:</span>
                        <span class="token punctuation">-</span> mambo<span class="token punctuation">-</span>cert
                    <span class="token key atrule">roleName</span><span class="token punctuation">:</span>
                        <span class="token key atrule">Fn::GetOptionSetting</span><span class="token punctuation">:</span>
                            <span class="token key atrule">Namespace</span><span class="token punctuation">:</span> aws<span class="token punctuation">:</span>autoscaling<span class="token punctuation">:</span>launchconfiguration
                            <span class="token key atrule">OptionName</span><span class="token punctuation">:</span> IamInstanceProfile
                            <span class="token key atrule">DefaultValue</span><span class="token punctuation">:</span> aws<span class="token punctuation">-</span>elasticbeanstalk<span class="token punctuation">-</span>ec2<span class="token punctuation">-</span>role
<span class="token key atrule">files</span><span class="token punctuation">:</span>
    <span class="token key atrule">"/etc/nginx/cert/server.crt"</span><span class="token punctuation">:</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">"000400"</span>
        <span class="token key atrule">owner</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">group</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">source</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//mambo<span class="token punctuation">-</span>cert.s3.ap<span class="token punctuation">-</span>northeast<span class="token punctuation">-</span>2.amazonaws.com/server.crt
        <span class="token key atrule">authentication</span><span class="token punctuation">:</span> S3Auth
    <span class="token key atrule">"/etc/nginx/cert/server.key"</span><span class="token punctuation">:</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">"000400"</span>
        <span class="token key atrule">owner</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">group</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">source</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//mambo<span class="token punctuation">-</span>cert.s3.ap<span class="token punctuation">-</span>northeast<span class="token punctuation">-</span>2.amazonaws.com/server.key
        <span class="token key atrule">authentication</span><span class="token punctuation">:</span> S3Auth
    <span class="token key atrule">"/etc/nginx/cert/server.ca-bundle"</span><span class="token punctuation">:</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">"000400"</span>
        <span class="token key atrule">owner</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">group</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">source</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//mambo<span class="token punctuation">-</span>cert.s3.ap<span class="token punctuation">-</span>northeast<span class="token punctuation">-</span>2.amazonaws.com/server<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>bundle
        <span class="token key atrule">authentication</span><span class="token punctuation">:</span> S3Auth

<span class="token key atrule">commands</span><span class="token punctuation">:</span>
    <span class="token key atrule">00-chain-ca-bundle</span><span class="token punctuation">:</span>
        <span class="token key atrule">cwd</span><span class="token punctuation">:</span> /etc/nginx/cert
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            cat server.crt server.ca-bundle > server-ca.pem
            chown nginx:nginx server-ca.pem
            chmod 400 server-ca.pem</span>
    <span class="token key atrule">99-remove-bak</span><span class="token punctuation">:</span>
        <span class="token key atrule">cwd</span><span class="token punctuation">:</span> /etc/nginx/cert
        <span class="token key atrule">command</span><span class="token punctuation">:</span> rm <span class="token punctuation">-</span>f <span class="token important">*.bak</span></code></pre>

<h3 id="Beanstalk-Resources"><a href="#Beanstalk-Resources" class="headerlink" title="Beanstalk Resources"></a>Beanstalk Resources</h3><p>아마존 웹 서비스의 리소스들은 CloudFormation으로 만들어지며 Elastic Beanstalk 환경도 <strong>CloudFormation 스택을 구성</strong>하여 만들어지게 됩니다.</p>
<pre class="language-yaml" data-language="yaml"><div class="caption"><span>.ebextensions/nginx-cert.config</span></div><code class="language-yaml"><span class="token key atrule">Resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">AWSEBAutoScalingGroup</span><span class="token punctuation">:</span>
        <span class="token key atrule">Metadata</span><span class="token punctuation">:</span>
            <span class="token key atrule">AWS::CloudFormation::Authentication</span><span class="token punctuation">:</span>
                <span class="token key atrule">S3Auth</span><span class="token punctuation">:</span>
                    <span class="token key atrule">type</span><span class="token punctuation">:</span> S3
                    <span class="token key atrule">buckets</span><span class="token punctuation">:</span>
                        <span class="token punctuation">-</span> mambo<span class="token punctuation">-</span>cert
                    <span class="token key atrule">roleName</span><span class="token punctuation">:</span>
                        <span class="token key atrule">Fn::GetOptionSetting</span><span class="token punctuation">:</span>
                            <span class="token key atrule">Namespace</span><span class="token punctuation">:</span> aws<span class="token punctuation">:</span>autoscaling<span class="token punctuation">:</span>launchconfiguration
                            <span class="token key atrule">OptionName</span><span class="token punctuation">:</span> IamInstanceProfile
                            <span class="token key atrule">DefaultValue</span><span class="token punctuation">:</span> aws<span class="token punctuation">-</span>elasticbeanstalk<span class="token punctuation">-</span>ec2<span class="token punctuation">-</span>role</code></pre>

<p>그래서 구성 파일의 리소스 키를 정의하는 것은 CloudFormation 템플릿에 리소스를 추가하는 것과 같습니다. 위 예시에서는 Beanstalk 환경 시작 시 만들어지는 CloudFormation 스택에 미리 정의된 웹 서버 환경의 리소스 항목인 <a href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/aws-properties-as-group.html">AWSEBAutoScalingGroup</a>을 사용했습니다. </p>
<p>그리고 AWSEBAutoScalingGroup에는 <a href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/aws-properties-as-launchconfig.html">LaunchConfiguration(AWS::AutoScaling::LaunchConfiguration)</a>라는 EC2 인스턴스에 대한 시작 구성을 정의하는 항목이 있으며 시작 구성에 정의된 내용 중에는 <a href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/aws-properties-as-launchconfig.html#cfn-as-launchconfig-iaminstanceprofile">IamInstanceProfile</a> 속성이 있습니다. IamInstanceProfile 속성은 EC2 인스턴스에 대한 인스턴스 프로파일로 지정된 <strong>IAM Role</strong>에 대한 이름을 제공합니다.</p>
<p>따라서, Beanstalk 환경 구성 시 선택한 IAM Role을 가져와서 <strong>AWS::CloudFormation::Authentication</strong> 리소스를 활용해 S3 버킷에 대한 자격 증명을 지정한 것입니다. 우리는 앞서 aws-elasticbeanstalk-ec2-role이라는 IAM Role이 인증서가 저장된 S3 버킷에 읽기 권한을 부여했기 때문에 파일 키에 정의된 파일을 생성할 때 외부 소스(S3 저장소)에서 가져올 수 있게된 것입니다. 이렇게 해서 우리는 애플리케이션 소스 번들에 인증서를 포함시키지 않고 EC2 인스턴스에서만 접근할 수 있는 S3 버킷에 인증서를 저장하고 사용할 수 있는 구성을 할 수 있게 되었습니다.</p>
<p>이 글을 보시는 분들이 인증서의 개인키와 같은 민감한 파일들을 애플리케이션 소스 번들에 포함하고 있다면 프라이빗 S3 저장소에 저장하여 더 안전한 방식으로 애플리케이션을 배포하는 것을 고려해보시기 바랍니다.</p>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>S3</tag>
        <tag>Beanstalk</tag>
      </tags>
  </entry>
  <entry>
    <title>엘라스틱서치 인덱스</title>
    <url>/elasticsearch-indices/</url>
    <content><![CDATA[<p>현재 조직의 주요 솔루션은 엘라스틱서치 1.6을 기반으로 동작하며 여러개의 노드로 구성되는 엘라스틱서치 클러스터로 운용하고 있습니다. 그러나, 제가 담당하여 개발중인 신규 시스템은 시계열 데이터를 저장하기 위한 시계열 데이터베이스를 사용중이므로 엘라스틱서치에 시계열 데이터와 같은 대규모 데이터 및 안전하게 운용되어야하는 가용성이 요구되지 않으므로 단일 노드 클러스터로 사용하고 있습니다.</p>
<p>싱글 노드 클러스터로 운용되는 엘라스틱서치에는 시스템에서 발생하는 특정 정보에 대한 로그 데이터를 개별 단일 인덱스에 저장하고 있으며 엘라스틱서치로부터 정해진 인덱스에 저장되는 도큐먼트를 조회하기 때문에 엘라스틱서치가 지원하는 여러가지 쿼리를 활용할 경험은 많지 않은 것은 아쉬운 부분이긴 합니다.</p>
<blockquote>
<p>시계열 데이터는 엘라스틱서치가 아닌 별도의 <a href="https://kx.com/developers/">시계열 데이터베이스</a>에 저장하고 통계 정보를 쿼리하고 있습니다.</p>
</blockquote>
<h2 id="인덱스-관련-트러블슈팅"><a href="#인덱스-관련-트러블슈팅" class="headerlink" title="인덱스 관련 트러블슈팅"></a>인덱스 관련 트러블슈팅</h2><p>대규모 노드로 구성된 엘라스틱서치 클러스터를 운용하지 않더라도 인덱스와 관련된 여러가지 문제들을 간간히 경험해보긴 했습니다. 오히려 엘라스틱서치가 고 가용성으로 운영되지 않아서 발생하는 문제로 봐야할 것 같습니다. </p>
<h3 id="동적-매핑-필드-제한"><a href="#동적-매핑-필드-제한" class="headerlink" title="동적 매핑 필드 제한"></a>동적 매핑 필드 제한</h3><p>조직의 기존 솔루션이 엘라스틱서치를 주요 데이터베이스로 활용했더라도 주 개발자들이 현재 개발중인 시스템에 참여한 것은 아니고 저는 조직의 신입일 때 참여했으므로 엘라스틱서치에 대해 대략적인 개념조차 모르던 시기였습니다. 시스템의 요구 사항과 설계가 명확하지 않았기에 엘라스틱서치에서 기본적으로 제공하는 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html#mapping-dynamic">동적 필드 매핑</a>을 통해 개발자가 별도로 관리하지 않아도 도큐먼트에 대한 각 필드들을 자동으로 매핑하는 상태로 시스템에서 발생하는 일부 정보의 변화들을 로그로 저장하였습니다.</p>
<blockquote>
<p>limit of total fields 1000 has been exceeded</p>
</blockquote>
<p>위 문제는 동적 필드 매핑으로 만들어지는 인덱스에 여러가지 필드가 저장되어질때 확인할 수 있는 오류입니다. 엘라스틱서치에 저장되도록한 로그 중에서 다양하게 필드가 변경될 수 있는 메타데이터 오브젝트가 포함되었고 점점 다양한 키 값이 추가되면서 엘라스틱서치는 동적 매핑에 의해 메타데이터 키에 대한 필드 매핑을 추가하여 매핑 정보가 점차 늘어나서 제한량까지 넘어서게 되는 상황이 발생한 것 입니다.</p>
<p>이 문제에 대해서는 임시적으로 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html#mapping-limit-settings">인덱스에 대해 필드 제한 수를 조정</a>하여 조치할 수 있으나 메타데이터 오브젝트가 다양하게 추가되면 다시 발생할 수 있으므로 근본적인 해결책은 아닙니다. 그래서 해당 현상이 발견되는 인덱스에 대해서는 동적 매핑에 의해 추가된 매핑 정보를 확인하여 계속해서 매핑 정보가 만들어질 수 있는 필드를 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/enabled.html">단순히 저장만하도록</a> 매핑 정보를 부여하고 재 인덱스를 수행해야만 했습니다.</p>
<h3 id="도큐먼트-삭제"><a href="#도큐먼트-삭제" class="headerlink" title="도큐먼트 삭제"></a>도큐먼트 삭제</h3><p>단일 노드의 엘라스틱서치 클러스터이므로 단일 인덱스에 너무 많은 도큐먼트가 저장되면 성능에 문제가 될 수 있습니다. 심지어는 엘라스틱서치 7부터 인덱스에 대한 프라이머리 샤드의 기본값이 1 이었던 부분으로 인하여 인덱스의 하나의 샤드가 너무 많은 도큐먼트를 저장하고 있는 구조가 되어버렸습니다.</p>
<p>특정 인덱스에 저장되는 도큐먼트가 너무 많아졌고 심지어는 오래된 도큐먼트가 불필요하게 남아있었기에 일정 기간이 지난 도큐먼트는 지우도록 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-delete-by-query.html">_delete_by_query</a>를 사용해서 스케줄에 의해 엘라스틱서치 클러스터에 지우도록 요청해두었습니다. 그러나, <a href="https://ridicorp.com/story/index-aliases/">Elasticsearch의 색인 별명 활용 팁</a>에 나와있는 것처럼 엘라스틱서치 클러스터에서는 도큐먼트를 실제로 삭제하는 것은 아닌 부분으로 인하여 오히려 엘라스틱서치 클러스터의 인덱스의 용량이 일시적으로 늘어나게 되는 문제를 가져가게 됩니다. </p>
<blockquote>
<p>디스크 볼륨을 증설할 수 있다고 해도 서버 용량에 민감할 수 밖에 없습니다.</p>
</blockquote>
<h3 id="일자별-인덱스-조회"><a href="#일자별-인덱스-조회" class="headerlink" title="일자별 인덱스 조회"></a>일자별 인덱스 조회</h3><p>도큐먼트 삭제가 용이하지 않은 단일 인덱스의 문제를 해소하기 위해서 특정 로그에 대해서는 일자별로 저장되도록 적용해야했습니다. 단일 인덱스로 저장하던걸 일자별로 저장하는 것은 인덱스 명에 저장되는 시점의 날짜 포맷(yyyyMMdd)을 추가하면 되기에 어려움은 없었습니다. 해당 작업에 대해 검토하던 중 인덱스에 대한 조회 기능에 일부 사이드 이펙트가 발생할 수 있음을 확인하였습니다.</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-search.html">Search API</a>에 대해서는 인덱스 패턴에 대해서 조회할 수 있도록 지원합니다만, 특정 도큐먼트에 대한 아이디를 기준으로 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-get.html#docs-get-api-request">Get API</a>를 사용하기 위해서는 인덱스 명을 알아야만 합니다. 심지어는 여러개의 인덱스에 대해서 조회할 수 있는 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-multi-get.html">Mget API</a>도 조회하고자 하는 인덱스들의 이름을 나열해야했기에 인덱스 패턴에 대해 인덱스 목록을 조회하고 여러개의 인덱스에 걸쳐 병렬 조회할 수 있도록 아래와 같이 변경해야 했습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// NOTE: 인덱스 패턴에 의한 실제 인덱스 목록 조회</span>
<span class="token class-name">GetIndexRequest</span> getIndexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetIndexRequest</span><span class="token punctuation">(</span><span class="token string">"oauth_log*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">GetIndexResponse</span> getIndexResponse <span class="token operator">=</span> highLevelClient<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>getIndexRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> indices <span class="token operator">=</span> getIndexResponse<span class="token punctuation">.</span><span class="token function">getIndices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// NOTE: 여러개의 인덱스에 걸쳐 병렬 조회</span>
<span class="token class-name">MultiGetRequest</span> multiGetRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MultiGetRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> index <span class="token operator">:</span> indices<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    multiGetRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token string">"c70e49fa-d0f4-4278-a271-a46f688349f6"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">MultiGetResponse</span> multiGetResponse <span class="token operator">=</span> highLevelClient<span class="token punctuation">.</span><span class="token function">mget</span><span class="token punctuation">(</span>multiGetRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">MultiGetItemResponse</span><span class="token punctuation">[</span><span class="token punctuation">]</span> responses <span class="token operator">=</span> multiGetResponse<span class="token punctuation">.</span><span class="token function">getResponses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MultiGetItemResponse</span> response <span class="token operator">:</span> responses<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span><span class="token function">isFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> index <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> id <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125; in &#123;&#125;, &#123;&#125;"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> index<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<blockquote>
<p>일자별 인덱스에 있는 도큐먼트의 아이디가 충돌하지 않는다는 것을 보장할 때를 기준으로 합니다.</p>
</blockquote>
<p>최근 인덱스와 관련된 작업을 하고 있어서 여태까지 경험했던 문제에 대해서 작성해보았습니다. 인덱스 관리와 관련해서 사용중이던 엘라스틱서치 버전을 7.3.2에서 7.12.1로 변경하는 작업을 진행하고 있으며 이와 더불어 엘라스틱서치와 함께 키바나를 활용해서 더 효율적으로 인덱스를 관리할 수 있는 방안에 대해서 공부해보고 있습니다.</p>
<p>감사합니다.</p>
]]></content>
  </entry>
  <entry>
    <title>신뢰할 수 있는 이메일 발송 도메인</title>
    <url>/email-spf-dkim-dmarc/</url>
    <content><![CDATA[<p>시스템을 개발하는 단계에서는 메일 발송 기능을 위해서 회사 내 서버 인프라 엔지니어분께 사내 메일 서버를 대신 이용할 수 있도록 요청하고 메일 서버를 이용할 수 있는 SMTP 서버와 사용자 인증 정보를 전달받아서 테스트하곤 했습니다. 그러나, 실제로 시스템을 운용하는 시점에 들어서자 회사 사내 메일 서버로 전달되는 전송 건들이 많아져서 회사 인프라 담당 엔지니어분으로부터 <a href="https://aws.amazon.com/ko/ses/">Amazon SES</a>로 메일 서버를 전환해달라는 요청을 받고 화사 사내 메일 서버 대신에 클라우드 환경에서 제공하는 SMTP 서버를 사용하도록 작업을 하였습니다. </p>
<h2 id="Amazon-SES"><a href="#Amazon-SES" class="headerlink" title="Amazon SES"></a>Amazon SES</h2><p>저는 서버 인프라 엔지니어는 아니기 때문에 인프라 영역에서 사용되는 모든 지식을 알지는 못하는데요. 개발자로써 이메일 발송 기능을 구현하는 방법에 대해서 찾아보면 <a href="/sending-mail-with-freemarker-template/">프리마커 템플릿으로 이메일 발송하기</a>와 같이 SMTP 프로토콜을 사용하면 된다는 것을 알 수 있습니다. </p>
<p><img data-src="/images/posts/email-spf-dkim-dmarc/ses-01.png"></p>
<p>Amazon SES는 SMTP 엔드포인트와 STARTTLS&#x2F;TLS 옵션에 따라 사용해야하는 포트와 SMTP 인증을 위한 크레덴셜을 발급하고 인증만 하면 사용할 수 있습니다. 간단한 클릭만으로도 SMTP 크레덴셜을 발급할 수 있기 때문에 개발자라면 누구나 쉽게 사용자 인증 정보를 가져와서 메일 서버를 이용할 수 있습니다. Amazon SES는 인증된 이메일 주소로 메일을 발송할 수 있거나 도메인을 인증하여 이메일 발송에 대한 신원을 검증할 수 있도록 제공하고 있는데요. 그래서 아래와 같이 이메일 수신이 가능한 발신 이메일이 존재한다면 간단하게 발신 주소를 등록할 수 있습니다.</p>
<p><img data-src="/images/posts/email-spf-dkim-dmarc/ses-02.png"></p>
<h3 id="이메일에-대한-발신-주소를-신뢰할-수-없음"><a href="#이메일에-대한-발신-주소를-신뢰할-수-없음" class="headerlink" title="이메일에 대한 발신 주소를 신뢰할 수 없음"></a>이메일에 대한 발신 주소를 신뢰할 수 없음</h3><p>간단하게 SMTP 메일 서버를 전환할 수 있기 때문에 어려운 작업은 아니라고 생각했었는데 잠시 후 예상하지 못했던 문제가 파악되었어요. Amazon SES의 SMTP 서버를 사용하도록 전환하고나서 시스템에서 발송하는 이메일을 수신자가 받았을때 스팸 메일함으로 전달되는 것이었습니다. 그래서 원인을 찾아보니 <a href="https://aws.amazon.com/ko/premiumsupport/knowledge-center/ses-email-flagged-as-spam/">Amazon SES를 사용하여 전송하는 이메일이 스팸으로 표시되는 이유는 무엇입니까?</a>와 같은 가이드를 찾았습니다. SMTP 서버에 의해 전달되는 이메일을 신뢰할 수 있는지 검증하는 것은 Amazon SES가 보장할 수 없다는 부분과 다음의 요인이 있다는 것을 안내하고 있었습니다.</p>
<blockquote>
<p><a href="https://docs.aws.amazon.com/ses/latest/dg/send-email-authentication-dkim.html">DomainKeys Identified Mail(DKIM)</a> 또는 <a href="https://docs.aws.amazon.com/ses/latest/dg/send-email-authentication-spf.html">Sender Policy Framework(SPF)</a>와 같은 이메일 인증 부족</p>
</blockquote>
<h3 id="발신-도메인-검증"><a href="#발신-도메인-검증" class="headerlink" title="발신 도메인 검증"></a>발신 도메인 검증</h3><p><a href="https://docs.aws.amazon.com/ses/latest/dg/configure-identities.html">Configuring identities in Amazon SES</a> 문서를 살펴보면 SMTP 프로토콜은 자체적으로 인증 기능이 없다는 것과 이러한 부분으로 인해 스패머가 발신 주소를 위장할 수 있다는 점을 알게 되었습니다. 그래서 SPF 또는 DKIM와 같은 인증 매커니즘을 사용하게 된다고 소개하고 있습니다. 이제껏 듣도보도 못한 새로운 용어가 나타나게 된거죠. <a href="https://blog.cloudflare.com/ko-kr/tackling-email-spoofing-ko-kr/">이메일 스푸핑과 피싱에 대처하기</a>에서 DNS의 도메인 레코드를 사용해서 스푸핑을 방지하기 위한 매커니즘을 구성한다는 점을 이해할 수 있었습니다. </p>
<p><img data-src="/images/posts/email-spf-dkim-dmarc/ses-03.png"></p>
<p>수신된 이메일이 올바른 곳으로부터 발송된 것인지를 검증하기 위해서는 도메인 기반으로 신원을 검증하고 SPF, DKIM, DMARC와 같은 DNS 레코드를 도메인에 설정해야했습니다. 다행히도 Route53으로 도메인을 사용중이기에 Amazon SES에서 자동으로 DNS 레코드를 설정할 수 있었습니다. <a href="https://docs.aws.amazon.com/ko_kr/ses/latest/dg/send-email-authentication-dmarc.html">Amazon SES를 사용하여 DMARC 준수</a>에 따라 도메인 레코드에 DMARC 정책이 설정되었는지를 확인하고 Amazon SES가 도메인을 검증하기를 기다렸습니다.</p>
<p><img data-src="/images/posts/email-spf-dkim-dmarc/ses-04.png"></p>
<h3 id="이메일-보안-DNS-레코드-질의"><a href="#이메일-보안-DNS-레코드-질의" class="headerlink" title="이메일 보안 DNS 레코드 질의"></a>이메일 보안 DNS 레코드 질의</h3><p>DKIM으로 도메인 검증을 하였음을 확인하였고 추가적으로 dig와 같은 DNS 질의 명령어 도구를 통해서 DNS 레코드가 반영되었는지 확인할 수 있었습니다. </p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># SPF 레코드 확인</span>
<span class="token function">dig</span> TXT example.com +short
<span class="token string">"v=spf1 include:_spf.google.com ip4:xxx.xxx.xxx.xxx a:mail.example.com ~all"</span>
<span class="token comment"># DKIM 레코드 확인</span>
<span class="token function">dig</span> TXT google._domainkey.example.com +short
<span class="token string">"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAoamWoQQ5zEdcFQnGaWN055oT3sEnCgN5bcAze5R6uvI1P"</span> <span class="token string">"X4d+CGbNDSVJqOmQPyrJdK2fOVG3hvjMkoilYcgWrGKDat2Nh29ftN5tTx5SVK/kl+5aPKRd9q6q9c9EWL7aRS2hqoGRyzW0Nb0ilKZc/"</span> <span class="token string">"odDbh3bgNhN6AJqIZwlE9BJgkYT5aT6TGJM/Vi4GJcYDEKm6yDexTJKzfZ8o8TCRDufCYDF8F+dKKyLvyaKrngfgIjRi5PiGVGbyNrIL7iMp1CkJ7ErpkYCJw5DeTQkXi8Gxt+Km61sIP2F8IZyd/"</span> <span class="token string">"WrEXJmk2pHzRfiJJqIiY4r3s4loR/sJ4hQPS6HEq7JQIDAQAB"</span>
<span class="token comment"># DMARC 레코드 확인</span>
<span class="token function">dig</span> TXT _dmarc.example.com +short
<span class="token string">"v=DMARC1; p=quarantine; rua=mailto:postmaster@example.com; ruf=mailto:postmaster@example.com"</span></code></pre>

<h3 id="발신-도메인-신뢰-확인"><a href="#발신-도메인-신뢰-확인" class="headerlink" title="발신 도메인 신뢰 확인"></a>발신 도메인 신뢰 확인</h3><p>도메인 기반의 인증 매커니즘이 적용되고나서는 수신된 이메일이 스팸으로 분류되지 않게 되었고 원본 메일 정보를 확인하면 SPF, DKIM, DMARC에 대한 검증이 통과된 것을 확인할 수 있습니다.</p>
<p><img data-src="/images/posts/email-spf-dkim-dmarc/ses-05.png"></p>
<blockquote>
<p>원본 메일을 확인하는 것은 서버 인프라 엔지니어분이 알려주셨어요! 😁</p>
</blockquote>
<p>SMTP 서버를 Amazon SES로 전환하는 경험을 통해서 이메일이 정상적인 곳으로부터 발신되었다는 것을 검증하기 위해서 도메인 레코드를 사용하는 매커니즘을 이용한다는 지식을 알게되었습니다. 수신된 이메일을 검증하는 과정을 더 자세하게 알고 싶다면 <a href="https://www.learndmarc.com/">이메일의 SPF&#x2F;DKIM&#x2F;DMARC가 어떻게 동작하는지 인터랙티브하게 보기</a>를 이용해보시기 바랍니다. </p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://aws.amazon.com/ko/premiumsupport/knowledge-center/ses-email-flagged-as-spam/">Amazon SES를 사용하여 전송하는 이메일이 스팸으로 표시되는 이유는 무엇입니까?</a></li>
<li><a href="https://blog.cloudflare.com/ko-kr/tackling-email-spoofing-ko-kr/">이메일 스푸핑과 피싱에 대처하기</a></li>
<li><a href="https://www.learndmarc.com/">이메일의 SPF&#x2F;DKIM&#x2F;DMARC가 어떻게 동작하는지 인터랙티브하게 보기</a></li>
</ul>
]]></content>
      <tags>
        <tag>SPF</tag>
        <tag>DKIM</tag>
        <tag>DMARC</tag>
      </tags>
  </entry>
  <entry>
    <title>프리마커 템플릿</title>
    <url>/freemarker-template/</url>
    <content><![CDATA[<blockquote>
<p>본 글은 <a href="/sending-mail-with-freemarker-template/">프리마커 템플릿으로 이메일 발송하기</a>에 이어서 프리마커 템플릿에 대해서 조금 더 학습해보고 정리하였습니다.<br>이 글에서 알아보는 내용을 코드로 확인하고 싶다면 <a href="https://github.com/kdevkr/spring-demo-freemarker">spring-demo-freemarker</a>를 참고하세요.</p>
</blockquote>
<h2 id="프리마커-템플릿"><a href="#프리마커-템플릿" class="headerlink" title="프리마커 템플릿"></a>프리마커 템플릿</h2><p><a href="https://freemarker.apache.org/">프리마커(FreeMarker)</a> 템플릿 엔진은 스프링 부트에서 공식적으로 지원하는 템플릿 엔진 중 하나입니다. <a href="https://developer.mozilla.org/ko/docs/Web/JavaScript/Reference/Template_literals">템플릿 리터럴</a>처럼 미리 정의된 템플릿 파일을 만들어서 어떠한 데이터 모델을 결합하여 동적으로 컨텐츠를 만들기 위해서 사용합니다. 여러가지 <a href="https://github.com/jreijn/spring-comparing-template-engines">템플릿 엔진과 비교</a>해서도 준수한 렌더링 성능을 보여주고 있습니다.</p>
<p><img data-src="https://freemarker.apache.org/images/overview.png" alt="Template + data-model = output"></p>
<h3 id="템플릿-로더"><a href="#템플릿-로더" class="headerlink" title="템플릿 로더"></a>템플릿 로더</h3><p>프리마커 템플릿 엔진은 다양항 방식으로 템플릿을 관리할 수 있도록 <a href="https://freemarker.apache.org/docs/api/freemarker/cache/TemplateLoader.html">TemplateLoader</a> 인터페이스를 사용합니다. 기본적으로 내장되어있는 구현체도 존재하며 프리마커 템플릿 엔진을 공식적으로 지원하는 스프링 프레임워크에는 SpringTemplateLoader라는 구현체를 포함하고 있습니다. 본 글에서 다루는 TemplateLoader는 아래와 같습니다.</p>
<ul>
<li><a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/ui/freemarker/SpringTemplateLoader.html">SpringTemplateLoader</a></li>
<li><a href="https://freemarker.apache.org/docs/api/freemarker/cache/StringTemplateLoader.html">StringTemplateLoader</a></li>
<li><a href="https://freemarker.apache.org/docs/api/freemarker/cache/MultiTemplateLoader.html">MultiTemplateLoader</a></li>
</ul>
<blockquote>
<p>스프링 프레임워크에서 제공하는 SpringTemplateLoader는 ResourceLoader를 통해 템플릿을 로드합니다.</p>
</blockquote>
<h3 id="국제화"><a href="#국제화" class="headerlink" title="국제화"></a>국제화</h3><p>국제화(Internationalization)는 구글처럼 다양한 언어를 사용하는 서비스 사용자가 있다면 다국어 서비스를 위해서 필수적으로 지원해야하는 기능입니다. 스프링 프레임워크에서는 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/context/MessageSource.html">메시지 소스</a>를 통해 다국어 메시지 처리를 지원합니다. 프리마커 템플릿 엔진은 스프링의 메시지 소스와는 연관성이 없으므로 스프링 프레임워크에서는 프리마커 템플릿에서 메시지 소스를 사용할 수 있도록 <a href="https://github.com/spring-projects/spring-framework/blob/main/spring-webmvc/src/main/resources/org/springframework/web/servlet/view/freemarker/spring.ftl">spring.ftl</a>를 포함하고 있습니다. </p>
<p>따라서, 프리마커 템플릿에서 스프링 메시지 처리하는 방법을 찾아보면 다음과 같이 해야한다는 정보를 확인할 수 있습니다.</p>
<pre class="language-ftl" data-language="ftl"><code class="language-ftl"><span class="token ftl language-ftl"><span class="token ftl-directive"><span class="token punctuation">&lt;</span><span class="token directive keyword">#import</span><span class="token content ftl"> <span class="token string">"/spring.ftl"</span> <span class="token keyword">as</span> spring</span><span class="token punctuation">/></span></span></span>
<span class="token ftl language-ftl"><span class="token ftl-directive"><span class="token punctuation">&lt;</span><span class="token directive keyword">@spring</span><span class="token content ftl"><span class="token punctuation">.</span>message <span class="token string">"messageKey"</span></span><span class="token punctuation">/></span></span></span></code></pre>

<blockquote>
<p>단, 메시지 소스를 사용할 수 있도록 정의된 FTL 파일은 RequestContext를 필요로하기 때문에 사용자의 요청에 대해 응답하는 뷰가 아닌 경우에는 사용할 수 없습니다. 따라서, 백그라운드 작업의 스레드에는 RequestContext가 존재하지 않기 때문에 메시지 소스로 다국어 메시지 처리가 불가능합니다.</p>
</blockquote>
<h4 id="ResourceBundleModel"><a href="#ResourceBundleModel" class="headerlink" title="ResourceBundleModel"></a>ResourceBundleModel</h4><p>사용자의 요청에 대한 응답이 아닌 백그라운드 작업에서 프리마커 템플릿 엔진을 사용할 때 다국어 메시지를 제공하기 위해서는 프리마커 템플릿 엔진에서 지원하는 방법을 사용해야만 합니다. 프리마커 템플릿 엔진은 리소스 번들을 모델로 사용해서 다국어를 처리할 수 있는 <strong>ResourceBundleModel</strong>을 제공하고 있습니다.</p>
<p>예를 들어, 클래스패스에 리소스 번들을 구성하고 ResourceBundleModel로 변환하여 데이터 모델로 전달하면 메시지 처리가 가능해집니다.</p>
<p><img data-src="/images/posts/freemarker-template/resource-bundle.png" alt="Resource Bundle"></p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Locale</span> locale <span class="token operator">=</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span>ROOT<span class="token punctuation">;</span>

<span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> configurationFactoryBean<span class="token punctuation">.</span><span class="token function">createConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">StringTemplateLoader</span> stringTemplateLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringTemplateLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stringTemplateLoader<span class="token punctuation">.</span><span class="token function">putTemplate</span><span class="token punctuation">(</span><span class="token string">"template"</span><span class="token punctuation">,</span> <span class="token string">"$&#123;bundle(\"application.name\")&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
configuration<span class="token punctuation">.</span><span class="token function">setTemplateLoader</span><span class="token punctuation">(</span>stringTemplateLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Template</span> template <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token string">"template"</span><span class="token punctuation">,</span> locale<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ResourceBundle</span> resourceBundle <span class="token operator">=</span> <span class="token class-name">ResourceBundle</span><span class="token punctuation">.</span><span class="token function">getBundle</span><span class="token punctuation">(</span><span class="token string">"messages"</span><span class="token punctuation">,</span> locale<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
model<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bundle"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ResourceBundleModel</span><span class="token punctuation">(</span>resourceBundle<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BeansWrapperBuilder</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span><span class="token punctuation">.</span>DEFAULT_INCOMPATIBLE_IMPROVEMENTS<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token class-name">FreeMarkerTemplateUtils</span><span class="token punctuation">.</span><span class="token function">processTemplateIntoString</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<blockquote>
<p>기본적으로는 프로퍼티 파일로 리소스 번들을 만들지만 <a href="https://docs.oracle.com/javase/7/docs/api/java/util/ResourceBundle.Control.html">XML</a> 또는 <a href="https://github.com/akkinoc/yaml-resource-bundle">YAML</a>로 리소스 번들을 만들어서 사용할 수도 있습니다.</p>
</blockquote>
<h3 id="템플릿-체이닝"><a href="#템플릿-체이닝" class="headerlink" title="템플릿 체이닝"></a>템플릿 체이닝</h3><p><a href="https://freemarker.apache.org/docs/api/freemarker/cache/MultiTemplateLoader.html">MultiTemplateLoader</a>를 사용하면 여러가지 방식의 <a href="https://freemarker.apache.org/docs/pgui_config_templateloading.html">템플릿 로딩</a>을 통해 템플릿 로더에 의해 로드되는 템플릿을 함께 사용할 수 있습니다. 또한, MultiTemplateLoader에 전달되는 템플릿 로더의 순서에 따라 SpringTemplateLoader로 기본 템플릿 레이아웃을 만들고 실제 템플릿 내용은 StringTemplateLoader로 재정의할 수도 있습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">StringTemplateLoader</span> stringTemplateLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringTemplateLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stringTemplateLoader<span class="token punctuation">.</span><span class="token function">putTemplate</span><span class="token punctuation">(</span><span class="token string">"email.ftlh"</span><span class="token punctuation">,</span> <span class="token string">"$&#123;bundle(\"application.name\")&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stringTemplateLoader<span class="token punctuation">.</span><span class="token function">putTemplate</span><span class="token punctuation">(</span><span class="token string">"template"</span><span class="token punctuation">,</span> <span class="token string">"&lt;#include \"email.ftlh\" >"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> configurationFactoryBean<span class="token punctuation">.</span><span class="token function">createConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SpringTemplateLoader</span> springTemplateLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringTemplateLoader</span><span class="token punctuation">(</span>resourceLoader<span class="token punctuation">,</span> <span class="token string">"classpath:/templates/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">MultiTemplateLoader</span> multiTemplateLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MultiTemplateLoader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TemplateLoader</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>stringTemplateLoader<span class="token punctuation">,</span> springTemplateLoader<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
configuration<span class="token punctuation">.</span><span class="token function">setTemplateLoader</span><span class="token punctuation">(</span>multiTemplateLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Template</span> template <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token string">"template"</span><span class="token punctuation">,</span> locale<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<blockquote>
<p>MultiTemplateLoader의 생성자에 전달되는 템플릿 로더의 순서대로 템플릿을 찾도록 위임한다는 것에 주의해야합니다.</p>
</blockquote>
<p>사용자의 요청에 대한 응답을 뷰로 처리하기 위해서 템플릿 엔진을 적용하기도 하지만 이메일 발송과 같은 백그라운드 작업에서도 프리마커 템플릿 엔진을 다양한 방식으로 활용할 수 있다는 것을 알게되었습니다. 프리마커 템플릿을 동적으로 처리하는 방법에 대해서 고민하게 되면서 알아본 내용이지만 많은 분들에게 도움이 되었으면 합니다.</p>
<p>감사합니다.</p>
]]></content>
  </entry>
  <entry>
    <title>Gmail SMTP</title>
    <url>/gmail-smtp/</url>
    <content><![CDATA[<p>오래전에 <a href="/sending-mail-with-freemarker-template/">프리마커 템플릿으로 이메일 발송하기</a>라는 주제로 구글 SMTP 서버를 사용해서 스프링 부트 애플리케이션에서 이메일을 발송하는 것을 다루어 보았었는데요. 구글의 보안 정책의 변경에 따라서 <a href="https://support.google.com/accounts/answer/6010255">2022년 5월 30</a>일부터는 보안 수준이 낮은 앱의 액세스가 활성된 계정으로는 SMTP 서버를 이용할 수 없게 되었습니다. 그러면 구글 SMTP 서버를 더이상 사용할 수 없는 것일까요?</p>
<h2 id="Gmail-SMTP"><a href="#Gmail-SMTP" class="headerlink" title="Gmail SMTP"></a>Gmail SMTP</h2><p>보안 수준이 낮은 앱의 액세스를 활성화한 계정에서는 사용자 이름과 비밀번호를 사용해서 Gmail SMTP와 같은 서드 파티 앱에 인증할 수 있었지만 이제는 사용자의 계정을 더 안전하게 보호하기 위해서 사용자 이름과 비밀번호를 사용해서 서드 파티 앱과 기기에 로그인 요청하는 것을 지원하지 않습니다. 이제는 Gmail SMTP 서버를 이용하기 위해서는 보안 수준이 높은 Gmail 계정을 만들고나서 사용자 이름과 비밀번호가 아닌 다른 방식으로 인증을 요청해야만 합니다.</p>
<h3 id="2단계-인증-활성화"><a href="#2단계-인증-활성화" class="headerlink" title="2단계 인증 활성화"></a>2단계 인증 활성화</h3><p>보안 수준이 높은 Gmail 계정을 만들기 위해서는 먼저 2단계 인증을 활성화하여야 합니다. 구글 계정 관리 &gt; 보안 메뉴에 들어가면 아래와 같이 2단계 인증을 사용중인지를 확인할 수 있습니다.</p>
<p><img data-src="/images/posts/gmail-smtp/02.png"></p>
<p>위와 같이 2단계 인증을 활성화 하지 않았다면 2단계 인증을 클릭해서 안내에 따라서 다음과 같이 인증을 완료하고 2단계 인증을 활성화합니다.</p>
<p><img data-src="/images/posts/gmail-smtp/03.png" alt="구글 계정에 입력된 전화번호로 인증"></p>
<p><img data-src="/images/posts/gmail-smtp/04.png" alt="전화 또는 문자메시지로 받은 인증번호 입력 후 인증 완료"></p>
<p><img data-src="/images/posts/gmail-smtp/05.png" alt="2단계 인증 활성화 완료"></p>
<h3 id="앱-비밀번호-추가"><a href="#앱-비밀번호-추가" class="headerlink" title="앱 비밀번호 추가"></a>앱 비밀번호 추가</h3><p>2단계 인증이 활성화 되고나서 앱 비밀번호라는 부분이 추가되었습니다. 앱 비밀번호를 추가하면 Gmail SMTP와 같은 2단계 인증을 지원하지 않는 앱에서도 로그인할 수 있다고 알려주는데요. 앞서 말한 사용자 이름과 비밀번호 방식이 아닌 다른 방식으로 인증할 수 있다는 이야기입니다.</p>
<p><img data-src="/images/posts/gmail-smtp/06.png"></p>
<p><img data-src="/images/posts/gmail-smtp/07.png"></p>
<p>이제 발급된 16자리의 앱 비밀번호를 잘 복사해두고 Gmail SMTP 인증에 사용하면 됩니다.</p>
<h3 id="이메일-발송"><a href="#이메일-발송" class="headerlink" title="이메일 발송"></a>이메일 발송</h3><p><a href="https://github.com/kdevkr/spring-demo-freemarker/tree/main/src/main/resources/config">Gmail SMTP를 사용하기 위한 정보</a>는 달라지지 않으며 우리가 수정해야할 부분은 구글 이메일 계정에 대한 비밀번호 대신에 앞서 발급한 16자리의 앱 비밀번호를 사용하는 것입니다. </p>
<p><img data-src="/images/posts/gmail-smtp/08.png"></p>
<p>더이상 보안 수준 낮은 앱의 액세스 활성화 없이도 Gmail SMTP 서버를 이용해볼 수 있는 것을 확인했습니다.</p>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>Gmail</tag>
        <tag>SMTP</tag>
      </tags>
  </entry>
  <entry>
    <title>그래들 빌드 라이프사이클</title>
    <url>/gradle-build-lifecycle/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>오늘 알아볼 내용은 그래들 빌드의 라이프사이클입니다. </p>
<p>얼마전에 단일 애플리케이션 프로젝트에서 다양한 배포 환경에 대한 기능을 별도로 지원해야하는 요구사항으로 인하여 그래들 멀티 모듈 프로젝트로 전환하게 되면서 배포 과정에서 문제가 발생하였었는데요. 그 문제는 크리티컬한 이슈는 아니지만 태스크 수행 후 만들어진 압축 파일에 프로젝트 버전이 포함되지 않는 상황이었습니다. 이러한 문제가 발생한 이유는 그래들 태스크를 정의할 때 <strong>그래들 빌드 라이프사이클</strong>을 고려하지 않았기 때문입니다.</p>
<h2 id="그래들-태스크"><a href="#그래들-태스크" class="headerlink" title="그래들 태스크"></a>그래들 태스크</h2><p>먼저 기존에 정의된 태스크는 <a href="https://github.com/kdevkr/beanstalk-deploy-sample/blob/main/build.gradle">beanstalk-deploy-sample의 build.gradle에 정의된 zipBeanstalk 태스크</a>와 같이 Zip 유형의 태스크로 작성되어있습니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">task <span class="token function">zipBeanstalk</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span> Zip<span class="token punctuation">,</span> dependsOn<span class="token punctuation">:</span> <span class="token string">'procfile'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    from <span class="token punctuation">(</span><span class="token string">'.ebextensions'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> into <span class="token string">'.ebextensions'</span> <span class="token punctuation">&#125;</span>
    from <span class="token punctuation">(</span><span class="token string">'.platform'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> into <span class="token string">'.platform'</span> <span class="token punctuation">&#125;</span>

    from <span class="token punctuation">(</span><span class="token string">'build/libs'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        println bootWar<span class="token punctuation">.</span>archiveName
        <span class="token function">include</span><span class="token punctuation">(</span>bootWar<span class="token punctuation">.</span>archiveName<span class="token punctuation">)</span>
        <span class="token function">include</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"Procfile"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    baseName <span class="token operator">=</span> <span class="token string">'beanstalk'</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>위 샘플 태스크처럼 단일 애플리케이션 프로젝트에서 정의된 태스크는 문제가 발생할 가능성이 적습니다. 그 이유는 배포를 위해서 여러가지 태스크를 정의하지 않기 때문인데요. 그러면 위 태스크를 수행하면 어떤 결과를 제공하는지 한번 확인해볼까요?</p>
<h3 id="태스크-결과"><a href="#태스크-결과" class="headerlink" title="태스크 결과"></a>태스크 결과</h3><p>프로젝트 폴더에 있는 Gradle Wrapper를 사용하여 zipBeanstalk 태스크를 수행하면서 프로젝트 버전을 명시해보겠습니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">.&#x2F;gradlew clean zipBeanstalk -x test -Pversion&#x3D;1.0.0-hotfix.11</code></pre>

<p><img data-src="/images/posts/gradle-build-lifecycle/gradle-01.png"></p>
<p>패키징된 WAR 파일과 zipBeanstalk 태스크에 의해 만들어지는 아카이브 파일에 프로젝트 버전이 포함됨을 확인할 수 있습니다.</p>
<h3 id="수동-배포-환경을-위한-태스크"><a href="#수동-배포-환경을-위한-태스크" class="headerlink" title="수동 배포 환경을 위한 태스크"></a>수동 배포 환경을 위한 태스크</h3><p>사실 zipBeanstalk 태스크는 아마존 웹 서비스의 빈스톡 환경으로 배포하기 위한 애플리케이션 번들 파일을 만드는 태스크입니다. 만약, 수동으로 배포하여야하는 환경이 추가된다면 빈스톡 환경에서 사용하는 Procfile과 환경 구성 파일들은 포함할 필요가 없으며 특정 환경을 위한 프로퍼티 파일만 별도로 추가하면 됩니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">task <span class="token function">zipManually</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span> Zip<span class="token punctuation">,</span> dependsOn<span class="token punctuation">:</span> <span class="token string">'bootWar'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    println <span class="token string">'Build Version: '</span> <span class="token operator">+</span> project<span class="token punctuation">.</span>version

    from <span class="token punctuation">(</span><span class="token string">'.conf'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> into <span class="token string">'application-prod.yml'</span><span class="token punctuation">&#125;</span>
    from <span class="token punctuation">(</span><span class="token string">'build/libs'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">include</span><span class="token punctuation">(</span>bootWar<span class="token punctuation">.</span>archiveName<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    baseName <span class="token operator">=</span> <span class="token string">'app-bundle'</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>zipManually 태스크에는 application-prod.yml을 패키징된 애플리케이션 WAR 파일과 함께 포함시키도록 정의했습니다. 아시는 분들도 있겠지만 스프링 부트 애플리케이션은 <strong>WAR 파일과 동일한 위치에 있는 애플리케이션 프로퍼티 파일</strong>을 읽을 수 있습니다. 만약, 모르시는 분들이라면 프로퍼티 구성 우선 순위에 대한 문서를 확인하시기 바랍니다.</p>
<p>동일하게 zipManually 태스크를 실행해보도록 하겠습니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">.&#x2F;gradlew clean zipManually -x test -Pversion&#x3D;1.0.0-hotfix.11

&gt; Configure project :
JDK info: 11
Build Version: 1.0.0-hotfix.11
Build Version: 1.0.0-hotfix.11

&gt; Task :bootBuildInfo
&gt; Task :compileJava UP-TO-DATE
&gt; Task :processResources UP-TO-DATE
&gt; Task :classes
&gt; Task :bootWarMainClassName
&gt; Task :bootWar
&gt; Task :procfile
&gt; Task :zipManually</code></pre>

<p><img data-src="/images/posts/gradle-build-lifecycle/gradle-02.png"></p>
<p>zipManually 태스크 결과는 정상으로 보입니다만… 이상한 부분을 눈치채신분들이 있으시겠죠? <strong>바로 Build Version이 두번 출력되었다는 점</strong>인데요. 우리는 분명히 별도의 태스크로 정의하고 태스크 블록 내에서 현재 Build Version을 출력하도록 작성했습니다. 이렇게 Build Version 버전이 두번 출력되는 이유는 이 글의 주요 내용인 그래들 빌드 라이프사이클에 대한 개념과 관련이 있습니다.</p>
<h2 id="그래들-빌드-라이프사이클"><a href="#그래들-빌드-라이프사이클" class="headerlink" title="그래들 빌드 라이프사이클"></a>그래들 빌드 라이프사이클</h2><p>사실 상 이러한 문제를 경험하는 이유는 그래들의 빌드 라이프사이클에 대한 개념을 모르기 때문인데요. 20년차이신 팀장님 조차도 잘 모르는 부분이었다고 할 수 있습니다. 빌드 라이프사이클 존재를 모르는 상황이었기에 이렇게 되는 이유를 검색하고 팀장님께서 <a href="https://stackoverflow.com/a/23485085">Gradle executes all tasks?</a>이라는 스택오버플로우 질문을 공유해주셨습니다.</p>
<p>이 질문에 대한 답변에서는 그래들에는 configuration 단계와 execution 단계가 있고 이것은 중요한 개념이라고 설명하고 있었습니다. 그러면 그래들 공식 문서에 있는 <a href="https://docs.gradle.org/current/userguide/build_lifecycle.html">Build Lifecycle</a>를 살펴보도록 하겠습니다.</p>
<blockquote>
<p>Gradle builds the complete dependency graph before any task is executed.<br>… Your build scripts configure this dependency graph.</p>
</blockquote>
<p>그래들은 태스크를 수행하기 전에 의존성 그래프를 빌드하고 빌드 스크립트는 의존성 그래프를 구성한다고 설명하며 빌드 단계에 대해서 설명합니다.</p>
<h3 id="빌드-단계"><a href="#빌드-단계" class="headerlink" title="빌드 단계"></a>빌드 단계</h3><p>그래들의 빌드 단계는 3가지로 구분된다고 하며 초기화(Initialization), 구성(Configuration), 수행(Execution)입니다. </p>
<blockquote>
<p><strong>Initialization</strong><br>Gradle supports single and multi-project builds. During the initialization phase, Gradle determines which projects are going to take part in the build, and creates a Project instance for each of these projects.</p>
<p><strong>Configuration</strong><br>During this phase the project objects are configured. The build scripts of all projects which are part of the build are executed.</p>
<p><strong>Execution</strong><br>Gradle determines the subset of the tasks, created and configured during the configuration phase, to be executed. The subset is determined by the task name arguments passed to the gradle command and the current directory. Gradle then executes each of the selected tasks.</p>
</blockquote>
<p>세가지의 단계 중 구성 단계에서는 모든 프로젝트의 빌드 스크립트가 실행된다는 설명이 있습니다. 이 부분이 제가 경험한 문제의 원인이라고 할 수 있는데 태스크 내에서 작성하는 코드는 구성 단계에 포함되며 doFirst와 doLast 블록이 수행 단계에 포함되기 때문입니다.</p>
<p>저도 모르는 부분이었고 생각보다 많은 블로그에서는 그래들 태스크 정의를 설명할 때 구성 단계에 해당되는 곳에 println을 작성하는 예시를 보여주는데요. 생각보다 많은 분들이 이 개념에 대해서 모른다고 할 수 있습니다. 물론 단일 애플리케이션 프로젝트에서는 몰라도 상관없다고 할 수 있겠네요.</p>
<h3 id="테스트를-위한-태스크"><a href="#테스트를-위한-태스크" class="headerlink" title="테스트를 위한 태스크"></a>테스트를 위한 태스크</h3><p>그러면 어떻게 하였기에 프로젝트 버전이 포함되지 않았을 지 다음의 태스크를 살펴보도록 하겠습니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">task <span class="token function">zipBeanstalk</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span> Zip<span class="token punctuation">,</span> dependsOn<span class="token punctuation">:</span> <span class="token string">'procfile'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
task <span class="token function">zipManually</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span> Zip<span class="token punctuation">,</span> dependsOn<span class="token punctuation">:</span> <span class="token string">'bootWar'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

task <span class="token function">k8sbuild</span><span class="token punctuation">(</span>dependsOn<span class="token punctuation">:</span> bootWar<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    project<span class="token punctuation">.</span>version <span class="token string">''</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>추가한 k8sbuild 태스크는 쿠버네티스 배포 환경 테스트를 위해 패키징된 애플리케이션 WAR 파일에 포함되는 프로젝트 버전을 생략하기 위해서 project.version을 빈 값으로 설정하도록 작성한게 화근이었습니다. 이 상태로 zipManually 태스크를 다시 한번 수행하면 어떻게 되는지 확인해봅시다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">.&#x2F;gradlew clean zipManually -x test -Pversion&#x3D;1.0.0-hotfix.11</code></pre>

<p><img data-src="/images/posts/gradle-build-lifecycle/gradle-03.png"></p>
<p>k8sbuild 태스크에 작성된 project.version을 설정하는 행위는 구성 단계에 해당하기 때문에 모든 태스크를 수행하기 이전에 적용되어 zipManually 태스크를 수행했음에도 불구하고 프로젝트 버전이 포함되지 않았음을 보여줍니다.</p>
<h3 id="해결방안"><a href="#해결방안" class="headerlink" title="해결방안"></a>해결방안</h3><p>그러면 어떻게 해결하는게 좋을지 방안을 찾아보도록 하겠습니다. </p>
<h4 id="프로젝트-버전-재정의하는-경우"><a href="#프로젝트-버전-재정의하는-경우" class="headerlink" title="프로젝트 버전 재정의하는 경우"></a>프로젝트 버전 재정의하는 경우</h4><p>k8sbuild 태스크처럼 특정 태스크에서 프로젝트 버전을 재정의 하고싶은 경우에는 doFirst와 같은 클로저를 활용해야합니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">task <span class="token function">k8sbuild</span><span class="token punctuation">(</span>dependsOn<span class="token punctuation">:</span> bootWar<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    doFirst <span class="token punctuation">&#123;</span>
        project<span class="token punctuation">.</span>version <span class="token string">''</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="프로젝트-버전을-확인하고-싶은-경우"><a href="#프로젝트-버전을-확인하고-싶은-경우" class="headerlink" title="프로젝트 버전을 확인하고 싶은 경우"></a>프로젝트 버전을 확인하고 싶은 경우</h4><p>zipBeanstalk와 zipManually 태스크처럼 애플리케이션을 WAR로 패키징하는 경우 현재 프로젝트 버전을 출력하고 싶은 경우 gradle.taskGraph.whenReady를 활용함으로써 해결할 수 있습니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">task <span class="token function">zipBeanstalk</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span> Zip<span class="token punctuation">,</span> dependsOn<span class="token punctuation">:</span> <span class="token string">'procfile'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    from <span class="token punctuation">(</span><span class="token string">'.ebextensions'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> into <span class="token string">'.ebextensions'</span> <span class="token punctuation">&#125;</span>
    from <span class="token punctuation">(</span><span class="token string">'.platform'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> into <span class="token string">'.platform'</span> <span class="token punctuation">&#125;</span>

    from <span class="token punctuation">(</span><span class="token string">'build/libs'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">include</span><span class="token punctuation">(</span>bootWar<span class="token punctuation">.</span>archiveName<span class="token punctuation">)</span>
        <span class="token function">include</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"Procfile"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    baseName <span class="token operator">=</span> <span class="token string">'beanstalk'</span>
<span class="token punctuation">&#125;</span>

task <span class="token function">zipManually</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span> Zip<span class="token punctuation">,</span> dependsOn<span class="token punctuation">:</span> <span class="token string">'bootWar'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    from <span class="token punctuation">(</span><span class="token string">'.conf'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> into <span class="token string">'application-prod.yml'</span><span class="token punctuation">&#125;</span>
    from <span class="token punctuation">(</span><span class="token string">'build/libs'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">include</span><span class="token punctuation">(</span>bootWar<span class="token punctuation">.</span>archiveName<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    baseName <span class="token operator">=</span> <span class="token string">'app-bundle'</span>
<span class="token punctuation">&#125;</span>

gradle<span class="token punctuation">.</span>taskGraph<span class="token punctuation">.</span>whenReady <span class="token punctuation">&#123;</span> graph <span class="token operator">-></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>graph<span class="token punctuation">.</span><span class="token function">hasTask</span><span class="token punctuation">(</span>bootWar<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        println <span class="token string">'Build Version: '</span> <span class="token operator">+</span> project<span class="token punctuation">.</span>version
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="불필요한-파일을-제거해야하는-경우"><a href="#불필요한-파일을-제거해야하는-경우" class="headerlink" title="불필요한 파일을 제거해야하는 경우"></a>불필요한 파일을 제거해야하는 경우</h4><p>경우에 따라서는 프로젝트 빌드 시 패키징된 애플리케이션 WAR 파일에 포함되지 않도록 해야할 수 있습니다. 예를 들어, 로컬 환경에서 사용하는 애플리케이션 프로퍼티 파일이나 특정 도메인에 대한 인증서 또는 인증키를 포함하지않도록 제외해야할 수 있습니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">gradle<span class="token punctuation">.</span>taskGraph<span class="token punctuation">.</span>whenReady <span class="token punctuation">&#123;</span> graph <span class="token operator">-></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>graph<span class="token punctuation">.</span><span class="token function">hasTask</span><span class="token punctuation">(</span>build_for_customer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        processResources <span class="token punctuation">&#123;</span>
            <span class="token function">exclude</span><span class="token punctuation">(</span><span class="token string">'**/config/**.yml'</span><span class="token punctuation">)</span>
            <span class="token function">exclude</span><span class="token punctuation">(</span><span class="token string">'**/certs/**'</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>위 예시는 구성 단계에서 의존성 그래프 구성이 완료된 이후에 build_for_customer 태스크가 수행되는 경우에 고객 환경으로 배포하는 애플리케이션 WAR 파일에 자체적으로 사용하는 애플리케이션 프로퍼티 파일들과 인증서를 포함하지 않도록 processResources를 재정의함을 보여줍니다.</p>
<p>그래들 빌드 라이프사이클 개념과 함께 경험하였던 문제에 대하여 어떻게 해결할 수 있는지 알아보았습니다. 어떤 기술을 사용함에 있어서 주요 개념을 이해하고 있는 것이 중요함을 다시한번 깨닫게 되는 좋은 경험이었습니다. 여러분의 그래들 빌드 스크립트에서도 수행 단계에서 수행되어야할 코드를 구성 단계에서 동작하도록 작성되지 않았는지 검토해보시기를 바랍니다.</p>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>Gradle</tag>
        <tag>Lifecycle</tag>
      </tags>
  </entry>
  <entry>
    <title>그래들 멀티 모듈 프로젝트</title>
    <url>/gradle-multi-module-project/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>오늘은 그래들 멀티 모듈 프로젝트의 디펜던시 공유에 대하여 이야기 해보려고 합니다. </p>
<h2 id="그래들-멀티-모듈"><a href="#그래들-멀티-모듈" class="headerlink" title="그래들 멀티 모듈"></a>그래들 멀티 모듈</h2><p>서비스의 규모가 어느정도 커지게되면 모놀리식 아키텍처로써 서비스에 대한 모든 기능이 하나의 애플리케이션에 구현하는 것을 마이크로서비스 아키텍처를 참고하여 일부 기능을 수행하는 별도의 애플리케이션로 독립시키기도 합니다. 현재 다니고 있는 회사에서는 모놀리식 아키텍처로 개발하고 있는 애플리케이션을 여러 고객들의 환경에 맞는 배포 또는 별도의 커스텀 기능을 지원하기 위하여 <strong>그래들 멀티 모듈 프로젝트</strong>로 전환하였습니다.</p>
<h3 id="Java-라이브러리-플러그인"><a href="#Java-라이브러리-플러그인" class="headerlink" title="Java 라이브러리 플러그인"></a>Java 라이브러리 플러그인</h3><p>공용 모듈에서 사용하는 디펜던시를 상위 모듈에서도 사용하기 위해서는 자바 플러그인 대신 자바 라이브러리 플러그인을 적용하고 <code>api</code>를 사용하여 지정된 디펜던시를 외부 모듈의 컴파일 클래스패스에 노출시켜야합니다. Gradle 7 부터는 <code>compile</code>을 지원하지 않으며 <code>implementation</code>은 지정한 디펜던시를 외부 모듈에 노출시키지 않습니다.</p>
<blockquote>
<p>The compile and runtime configurations have been removed with Gradle 7.0. Please refer to the upgrade guide how to migrate to implementation and api configurations&#96;.</p>
</blockquote>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy"><span class="token comment">// module-common/build.gradle</span>
plugins <span class="token punctuation">&#123;</span>
    id <span class="token string">'java-library'</span>
    id <span class="token string">'io.spring.dependency-management'</span>
<span class="token punctuation">&#125;</span>

dependencies <span class="token punctuation">&#123;</span>
    api <span class="token string">'com.google.code.gson:gson'</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>common 모듈의 gson 라이브러리는 api를 통해 상위 모듈의 클래스패스에 노출되어 상위 모듈에서도 사용이 가능해집니다. 기본적으로 implementation을 사용하는 경우 외부 모듈 클래스패스에 노출시키지 않는 이유는 빠른 컴파일과 클래스패스 사이즈를 줄이기 위함이며 api 보다는 implementation을 선호해야한다고 합니다.</p>
<h3 id="Common-Module"><a href="#Common-Module" class="headerlink" title="Common Module"></a>Common Module</h3><p><a href="https://github.com/kdevkr/gradle-multi-module">gradle-multi-module</a> 처럼 그래들 멀티 모듈 프로젝트에 공용으로 적용되는 코드를 가지는 Common 모듈이 있을때 다음과 같이 공통으로 적용되어야하는 설정을 수행할 수 있습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Jackson2ObjectMapperBuilderCustomizer</span> <span class="token function">objectMapperBuilderCustomizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> builder <span class="token operator">-></span> builder
                <span class="token punctuation">.</span><span class="token function">featuresToEnable</span><span class="token punctuation">(</span><span class="token class-name">SerializationFeature</span><span class="token punctuation">.</span>WRITE_DATES_AS_TIMESTAMPS<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">featuresToDisable</span><span class="token punctuation">(</span><span class="token class-name">SerializationFeature</span><span class="token punctuation">.</span>WRITE_DATE_TIMESTAMPS_AS_NANOSECONDS<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">modules</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Jdk8Module</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">JavaTimeModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>

<p>위 코드에서는 Date 또는 Timestamp와 같은 클래스에 대하여 Long 값으로 변환하는 기능을 활성화하기 위하여 SerializationFeature.WRITE_DATES_AS_TIMESTAMPS를 적용하였습니다. </p>
<h4 id="Common-Dependencies"><a href="#Common-Dependencies" class="headerlink" title="Common Dependencies"></a>Common Dependencies</h4><pre class="language-groovy" data-language="groovy"><code class="language-groovy">plugins <span class="token punctuation">&#123;</span>
    id <span class="token string">'java-library'</span>
<span class="token punctuation">&#125;</span>

dependencies <span class="token punctuation">&#123;</span>
    api <span class="token string">'org.springframework.boot:spring-boot-starter-security'</span>
    api <span class="token string">'com.google.code.gson:gson'</span>
    api <span class="token string">'com.fasterxml.jackson.core:jackson-databind'</span>
    api <span class="token string">'org.hibernate.validator:hibernate-validator'</span>
    api <span class="token string">'org.apache.commons:commons-lang3'</span>
    api <span class="token string">'org.apache.commons:commons-collections4:4.4'</span>
    api <span class="token string">'com.google.guava:guava:31.0.1-jre'</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>위 설정처럼 implementation 대신에 api를 사용하면 동일한 버전의 디펜던시를 다른 외부 모듈에서도 사용할 수 있도록 클래스패스에 노출할 수 있습니다. 이를 통해 각 모듈에서 사용되는 디펜던시 버전이 달라서 발생할 수 있는 문제를 방지할 수 있게 됩니다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://docs.gradle.org/current/userguide/dependency_management_for_java_projects.html">Managing Dependencies of JVM Projects</a>  </li>
<li><a href="https://docs.gradle.org/current/userguide/java_library_plugin.html#sec:java_library_configurations_graph">The Java Library Plugin</a></li>
</ul>
]]></content>
      <tags>
        <tag>Gradle</tag>
      </tags>
  </entry>
  <entry>
    <title>개발자를 위한 인프라 지식</title>
    <url>/infrastructure/</url>
    <content><![CDATA[<blockquote>
<p>IT가 어렵다고 느끼게 되는 이유는 기술의 발전으로 예전에는 불가능했다거나 그러지 않았던 부분들이 변화해서 많은 선택지가 생기기 때문입니다. 온-프레미스 환경을 넘어서 클라우드 환경으로 인프라를 구성하게 되는 것도 동일합니다.</p>
</blockquote>
<p>IT 분야에서 반드시 그래야한다는 것이 보장되지 않는 것과 비슷하게 모든 회사 또는 조직이 시스템을 운영하기 위한 인프라를 어떻게 구성한다거나 인프라를 담당하기 위한 팀을 별도로 구성할 지 일부 인원들이 담당할지는 알 수 없습니다. 작은 조직에서는 인건비의 문제로 인하여 서버 인프라 엔지니어를 최소화하고 클라우드 환경을 통해 개발자가 스스로 인프라를 구성하고 운영하는 선택을 할 것입니다. 조직에서 만드는 시스템이나 서비스의 규모가 커지게되면 업무의 과중화로 인하여 <a href="https://tech.kakao.com/2020/12/07/kakao-infra-team/">카카오 서비스의 모든 시스템과 트래픽을 책임지는 ‘인프라팀’ 이야기</a> 또는 <a href="https://blog.toss.im/article/infraengineeringteam-interview">토스 서비스의 근간을 다지는 사람들, 인프라 엔지니어링 팀을 만나다</a>에서처럼 클라우드 환경의 인프라를 사용하더라도 더 효율적으로 인프라를 구성하고 중점적으로 관리하기 위해서 인프라 팀을 구성하게 될 것입니다. </p>
<h2 id="인프라스트럭처"><a href="#인프라스트럭처" class="headerlink" title="인프라스트럭처"></a>인프라스트럭처</h2><p>인프라 영역에 대해서 서버 인프라 엔지니어에게 원하는 바를 전달하기 위해서는 인프라 영역에 대한 지식을 어느정도 알고 있어야 합니다. 인프라 영역을 담당하는 것과 인프라 영역에 대한 지식을 알고 협업하는 것은 다르다고 생각됩니다. 솔루션 회사의 사업팀 인원들은 IT 분야 또는 시스템에서 사용되는 용어나 개념들을 학습하여 업무에 활용하는 것처럼 개발자도 개발 영역 뿐만 아니라 인프라 영역에 대한 개념을 알고 있는게 당연할 것 입니다. 개발 영역과 마찬가지로 인프라 영역에서 알아야할 지식도 무궁무진합니다. 클라우드 환경에서 가상의 네트워크 영역을 구성하기 위해서 사이더(CIDR) 블록 및 NAT와 같은 개념을 알아야하거나 시스템을 운영하기 위해서 적합한 <a href="https://aws.amazon.com/ko/ec2/instance-types/">EC2 인스턴스 유형</a>을 선택할 수 있어야합니다.</p>
<h3 id="서버-CPU-아키텍처"><a href="#서버-CPU-아키텍처" class="headerlink" title="서버 CPU 아키텍처"></a>서버 CPU 아키텍처</h3><p>온-프레미스 환경에서는 호환성을 위해서 일반적으로 인텔 제품군의 제온 프로세서와 같은 X86_64 아키텍처 기반의 서버용 CPU를 사용하는 경우가 많았을 것입니다. 클라우드 환경에서는 인텔과 AMD와 같은 amd64 아키텍처 기반의 프로세서 뿐만 아니라 arm64 아키텍처 기반의 프로세서를 사용할 수 있도록 지원하므로 선택지가 다양하고 서버 인스턴스에서 구동되는 프로세스의 목적에 따라서 선택하게 됩니다. 현재 조직에서는 <a href="/reason-for-replacing-ec2-instance-type/">EC2 인스턴스 유형을 교체하는 이유</a>에서처럼 서버 비용을 줄이기 위한 목적으로 일부 서버 인스턴스에 대해서 클라우드 서비스에서 제공하는 최신 인스턴스 유형으로 전환하기도 했죠. </p>
<p><img data-src="/images/posts/infrastructure/arm-01.png"></p>
<p>서버 CPU 아키텍처의 선택지가 다양해짐으로써 사용해야하는 프로세스나 도구에서 CPU 아키텍처를 지원하는지를 검토해야할 수 있습니다. 위 스크린샷처럼 <a href="https://github.com/prometheus/node_exporter/releases">Promethues Node Exporter</a>를 Arm 아키텍처 기반의 서버에서 사용하기 위해서는 <strong>arm64</strong>로 빌드된 바이너리를 다운로드해야합니다. 도커 컨테이너를 통해서 프로세스를 실행하는 것도 도커 이미지가 <a href="https://docs.docker.com/desktop/multi-arch/#build-multi-arch-images-with-buildx">Arm 아키텍처로 빌드된 이미지</a>를 지원하는지 확인해보고 사용해야합니다.</p>
<h4 id="서버-아키텍처-확인"><a href="#서버-아키텍처-확인" class="headerlink" title="서버 아키텍처 확인"></a>서버 아키텍처 확인</h4><p>클라우드 서비스 콘솔에 접속할 수 있다면 서버 인스턴스가 어떤 아키텍처 기반인지 쉽게 확인할 수 있을 것 입니다. 그러나 일반적으로는 SSH 접속을 통해서 서버에 접근할 수 있는 권한을 부여할 것이므로 현재 접속한 서버내에서 어떤 아키텍처를 사용하는지를 확인할 수 있어야합니다. 서버 내에서 아키텍처 정보를 확인하려면 커널 또는 CPU에 대한 정보를 조회하는 명령어나 도구를 사용하면 됩니다. 여러분들이 접속하는 서버에서 다음의 명령어를 확인해보세요.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">uname</span> -rmpo
<span class="token number">4.14</span>.256-197.484.amzn2.aarch64 aarch64 aarch64 GNU/Linux

$ <span class="token function">cat</span> /proc/version
Linux version <span class="token number">4.14</span>.256-197.484.amzn2.aarch64 <span class="token punctuation">(</span>mockbuild@ip-10-0-46-15<span class="token punctuation">)</span> <span class="token punctuation">(</span>gcc version <span class="token number">7.3</span>.1 <span class="token number">20180712</span> <span class="token punctuation">(</span>Red Hat <span class="token number">7.3</span>.1-13<span class="token punctuation">)</span> 
<span class="token punctuation">(</span>GCC<span class="token punctuation">))</span> <span class="token comment">#1 SMP Tue Nov 30 00:18:02 UTC 2021</span>

$ hostnamectl
   Static hostname: ip-192-168-53-1.ap-northeast-2.compute.internal
         Icon name: computer-vm
           Chassis: vm
        Machine ID: ec2d229d0283ccced53f112dc3648f3a
           Boot ID: 67c156512c204340b1ac01d60eb45b26
    Virtualization: amazon
  Operating System: Amazon Linux <span class="token number">2</span>
       CPE OS Name: cpe:2.3:<span class="token punctuation">\</span>o:amazon:amazon_linux:2
            Kernel: Linux <span class="token number">4.14</span>.256-197.484.amzn2.aarch64
      Architecture: arm64

$ lscpu
Architecture:        aarch64
Byte Order:          Little Endian
CPU<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:              <span class="token number">4</span>
On-line CPU<span class="token punctuation">(</span>s<span class="token punctuation">)</span> list: <span class="token number">0</span>-3
Thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span> per core:  <span class="token number">1</span>
Core<span class="token punctuation">(</span>s<span class="token punctuation">)</span> per socket:  <span class="token number">4</span>
Socket<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:           <span class="token number">1</span>
NUMA node<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:        <span class="token number">1</span>
Model:               <span class="token number">1</span>
BogoMIPS:            <span class="token number">243.75</span>
L1d cache:           64K
L1i cache:           64K
L2 cache:            1024K
L3 cache:            32768K
NUMA node0 CPU<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:   <span class="token number">0</span>-3
Flags:               fp asimd evtstrm aes pmull sha1 sha2 crc32 atomics fphp asimdhp cpuid asimdrdm lrcpc dcpop asimddp ssbs</code></pre>

<blockquote>
<p>x86_64와 amd64는 X86 명령어 집합의 아키텍처이며 aarch64와 arm64는 arm 명령어 집합의 아키텍처입니다.</p>
</blockquote>
<h3 id="디스크-볼륨"><a href="#디스크-볼륨" class="headerlink" title="디스크 볼륨"></a>디스크 볼륨</h3><p>서버 인스턴스에서 사용하는 디스크 볼륨에 대한 부분에 대해서 이야기가 오고갈 수 있습니다. 클라우드 서비스는 다양한 <a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/ebs-volume-types.html">디스크 볼륨 유형</a>을 선택할 수 있도록 지원하므로 서버 인스턴스의 목적에 맞는 디스크 볼륨을 추가하여 사용하기 때문입니다. 현재 사용중인 디스크 볼륨 정보를 확인하고 어떤 파일시스템의 파티션인지를 확인하고 디스크 볼륨의 용량을 증설해야할 수도 있죠. </p>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">df</span> -hT
Filesystem     Type      Size  Used Avail Use% Mounted on
/dev/root      ext4       30G  <span class="token number">8</span>.9G   21G  <span class="token number">31</span>% /
/dev/nvme1n1   xfs      1000G  629G  371G  <span class="token number">63</span>% /data/main
/dev/nvme2n1   xfs       <span class="token number">2</span>.0T  306G  <span class="token number">1</span>.7T  <span class="token number">16</span>% /data/sub

$ lsblk -f
NAME        FSTYPE   LABEL           UUID                                 FSAVAIL FSUSE% MOUNTPOINT
nvme1n1     xfs                      <span class="token number">18891124</span>-be54-415d-ba02-21dc6acf9e4f  <span class="token number">370</span>.9G    <span class="token number">63</span>% /data/main
nvme2n1     xfs                      5be85d99-8ed0-440b-a423-486bdef1b1b4    <span class="token number">1</span>.7T    <span class="token number">15</span>% /data/sub
nvme0n1
└─nvme0n1p1 ext4     cloudimg-rootfs e8070c31-bfee-4314-a151-d1332dc23486   <span class="token number">20</span>.1G    <span class="token number">31</span>% /</code></pre>

<p>위 예시 결과를 보면 서버 인스턴스에 연결된 루트 볼륨은 NVMe 기반이며 ext4 파일시스템의 파티션으로 되어있음을 확인할 수 있습니다. 추가로 연결된 데이터 볼륨은 동일하게 NVMe 기반이지만 xfs 파일시스템으로 되어있는 것을 확인할 수 있습니다. </p>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">du</span> --max-depth <span class="token number">1</span> <span class="token operator">|</span> <span class="token function">sort</span> -nr
<span class="token number">188679628</span> <span class="token builtin class-name">.</span>
<span class="token number">187045152</span> ./elasticsearch-7.3.2
<span class="token number">1034772</span>   ./kibana-7.3.2
<span class="token number">18756</span>     ./node_exporter-1.1.2.linux-amd64</code></pre>

<p>du 명령어를 통해서 현재 경로 기준에서 사용량이 많은 디렉토리 순서대로 출력했습니다. 디스크 볼륨의 용량이 부족해지면 사용량이 많은 디렉토리가 무엇인지 확인하고 불필요한 파일이 남아있는지를 먼저 확인하고 용량 확보가 불가능하다면 디스크 볼륨 증설을 요청하거나 작업을 수행할 것 입니다.</p>
<h3 id="네트워크"><a href="#네트워크" class="headerlink" title="네트워크"></a>네트워크</h3><p>인프라 영역 중 네트워크에 대한 부분은 외부 시스템과의 연동이 필요한 경우가 아니라면 생각보다 경험해볼 가능성이 적습니다. 외부 시스템의 IP 또는 호스트 주소로 트래픽이 전달되는지를 확인하거나 외부 API를 서버 내에서 직접 요청해볼 수도 있습니다. </p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 네트워크 인터페이스 조회</span>
<span class="token function">ifconfig</span>

<span class="token comment"># 내부 아이피 조회</span>
<span class="token function">hostname</span> -I

<span class="token comment"># 외부 아이피 조회</span>
<span class="token function">curl</span> ipconfig.io

<span class="token comment"># TCP 바인딩 포트 조회</span>
<span class="token function">netstat</span> -tnlp

<span class="token comment"># 트래픽 경로 추적</span>
<span class="token function">traceroute</span> google.com

<span class="token comment"># DNS 조회</span>
<span class="token function">nslookup</span> -type<span class="token operator">=</span>mx google.com
<span class="token function">dig</span> google.com mx</code></pre>

<h3 id="시스템-로그"><a href="#시스템-로그" class="headerlink" title="시스템 로그"></a>시스템 로그</h3><p>인프라 엔지니어로 구성된 인프라 팀이 조직내에 있다면 서버 시스템에서 발생하는 다양한 로그 또는 지표를 모니터링할 수 있는 Zabbix, Datadog과 같은 솔루션을 도입할 것입니다. 서버에 기록된 시스템 로그는 서버에서 발생한 일련의 이벤트들의 기록이므로 어떠한 문제가 파악되었을때 원인을 찾아가기 위한 분석 용도로 사용할 수 있습니다. 모니터링 시스템이 구축되어있지 않아도 시스템 로그를 확인할 수 있는 방법은 알아야합니다. 사용자의 요청이 애플리케이션으로 전달되는 과정에서 서버 네트워크 트래픽이 로그로 기록된다거나 엔진엑스와 같은 웹서버에서 리버스 프록시를 수행하기 전에 요청에 대해 액세스 로그를 기록합니다. 심지어는 애플리케이션 서버에서도 자체적으로 액세스 로그를 남기거나 애플리케이션의 주요 기능에 대한 동작을 로그로 저장되도록 정의하기도 합니다. 서버 인프라 엔지니어가 있다면 더 상세하게 원인을 파악할 수 있는 방법을 시도하겠지만 개발자로써는 간단하게 로그를 확인할 수 있으면 됩니다.</p>
<h4 id="리눅스-로그-디렉토리"><a href="#리눅스-로그-디렉토리" class="headerlink" title="리눅스 로그 디렉토리"></a>리눅스 로그 디렉토리</h4><p>리눅스 시스템의 로그가 저장되는 기본 디렉토리는 <strong>&#x2F;var&#x2F;log</strong> 입니다. 별도로 설치한 프로세스의 로그가 아니라면 대부분의 로그들이 이 경로에 저장될 것입니다. </p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 접속 기록 조회</span>
lastlog -t <span class="token number">1</span>

<span class="token comment"># systemd 로그 조회</span>
journalctl -b

<span class="token comment"># 커널 부트 메시지 조회</span>
<span class="token function">dmesg</span>

<span class="token comment"># 시스템 로그 조회</span>
<span class="token function">tail</span> /var/log/syslog</code></pre>

<blockquote>
<p>Zabbix와 같은 모니터링 솔루션을 도입하는 경우 <a href="https://www.zabbix.com/documentation/current/en/manual/config/items/itemtypes/log_items">로그 파일 감시</a> 기능으로 예상되는 문제를 감지할 수 있습니다.</p>
</blockquote>
<h4 id="로그-관리"><a href="#로그-관리" class="headerlink" title="로그 관리"></a>로그 관리</h4><p>서버를 관리하는 인프라 엔지니어 입장에서는 로그 파일을 효율적으로 관리하기 위해서 logrotate라고하는 로그 관리 도구를 사용합니다. 서버에 저장되는 로그 파일을 일정한 패턴을 주기로 구분하여 저장함으로써 나중에 어떠한 문제가 발생하거나 감사를 위해서 특정 시점에 대한 로그를 요청했을때 쉽게 전달할 수 있도록 대비합니다. 예를 들어, Nginx에 대한 로테이션 설정 파일을 살펴보면 아래와 같이 되어있는 것을 확인할 수 있습니다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> /etc/logrotate.d/nginx
/var/log/nginx/*.log <span class="token punctuation">&#123;</span>
        daily
        missingok
        rotate <span class="token number">52</span>
        compress
        delaycompress
        notifempty
        create <span class="token number">640</span> nginx adm
        sharedscripts
        postrotate
                <span class="token keyword">if</span> <span class="token punctuation">[</span> -f /var/run/nginx.pid <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                        <span class="token function">kill</span> -USR1 <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> /var/run/nginx.pid<span class="token variable">`</span></span>
                <span class="token keyword">fi</span>
        endscript
<span class="token punctuation">&#125;</span></code></pre>

<p>인프라 영역에서 로그 관리에 대한 개념을 알게된다면 개발자로써 애플리케이션 서버에서 기록되는 로그에 어떠한 정보를 남겨야하는가를 좀 더 고민하게 될 것입니다. 너무 불필요한 정보를 로그로 남기게 되어 서버의 디스크 볼륨의 용량을 너무 차지하게 되고 로그 분석도 힘들어질 수 있기 때문입니다.</p>
<p>개발자가 알아야할 기초적인 부분에 대해서 다루어보았습니다. 더 자세하게 들어간다면 시스템 성능의 지표를 확인하거나 시스템을 더 효율적으로 만드는 커널 튜닝에 대한 부분도 다루어보아야합니다. 인프라 영역에 대해서 더 많은 경험을 하게되면 이에 대한 부분도 공유해볼 수 있기를 바랍니다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://aws.amazon.com/ko/ec2/graviton/">AWS Graviton 프로세서</a></li>
<li><a href="https://www.oracle.com/kr/cloud/compute/arm/what-is-arm/">ARM 프로세서를 선택해야 하는 이유</a></li>
<li><a href="https://www.epnc.co.kr/news/articleView.html?idxno=205714">미래 컴퓨팅 환경 반영하는 ARM 아키텍처 기술</a></li>
</ul>
]]></content>
      <tags>
        <tag>Infrastructure</tag>
        <tag>Microarchitecture</tag>
      </tags>
  </entry>
  <entry>
    <title>IP 대역 그리고 위치추적</title>
    <url>/ip-band-and-location-tracking/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>오늘은 IT 인프라를 구성하는 IP 대역과 NAT 그리고 IP를 활용한 위치 추적에 대해서 알아봅니다. </p>
<h2 id="IP-대역"><a href="#IP-대역" class="headerlink" title="IP 대역"></a>IP 대역</h2><p>IT 인프라에서 IP는 퍼블릭 IP 그리고 프라이빗 IP로 구분되어집니다. <strong>퍼블릭 IP</strong>는 인터넷에 접속할 수 있는 공인 IP를 말하며 <strong>프라이빗 IP</strong>는 개인적으로 구성한 네트워크 망에서 사용하는 사설 IP를 말합니다. 따라서, <strong>사설망 IP로는 외부 인터넷 접속을 통해 구글 또는 네이버 사이트에 접근할 수 없습니다.</strong></p>
<h3 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h3><p><a href="https://datatracker.ietf.org/doc/html/rfc1631">NAT(IP Network Address Translator)</a>는 IPv4 주소체계의 한계로 인하여 IP 주소가 부족해지는 현상을 보완하기 위해 사용하는 기술입니다. NAT는 <strong>내부 사설망 IP를 가지고 외부 네트워크망에 접속할 수 있도록 공인 IP로 변환</strong>하는 기능을 수행합니다. 일반적으로 사용하는 공유기에는 NAT 기능을 포함하고 있기 때문에 공유기에서 192.168.0.2와 같은 주소를 할당하더라도 외부 인터넷에 접속할 경우에는 공인 IP로 변환하여 요청하게 됩니다.</p>
<p>이러한 차이로 윈도우 컴퓨터의 명령프롬프트에서 <strong>ifconfig</strong> 명령어를 실행하면 <strong>공유기에서 할당한 사설 IP</strong>를 확인할 수 있지만 아이피 정보를 확인할 수 있는 <a href="https://ipconfig.io/">ipconfig.io</a>, <a href="https://ifconfig.io/">ifconfig.io</a>, <a href="https://ifconfig.me/">ifconfig.me</a>에 접속해보면 사설 IP가 아닌 <strong>공인 IP</strong>를 확인할 수 있습니다.</p>
<p><img data-src="/images/posts/ip-band-and-location-tracking/ipconfig-01.png" alt="내부 아이피 조회"></p>
<p><img data-src="/images/posts/ip-band-and-location-tracking/ipconfig-02.png" alt="외부 아이피 조회"></p>
<h3 id="IP-위치-조회"><a href="#IP-위치-조회" class="headerlink" title="IP 위치 조회"></a>IP 위치 조회</h3><p>위에서 확인한 공인 IP에 대해서 위치추적 사이트라는 곳에서 조회를 해보면 실제로 살고있는 곳 보다는 터무니없는 곳을 보여주는 경우가 많습니다. 이렇게 위치추적 사이트에서 IP에 대한 위치 조회가 정확하지 않은 이유는 <strong>인터넷 서비스 사업자(ISP)인 KT 인터넷과 같은 업체에서 지역을 정해서 IP 대역을 할당</strong>하고 그 지역내에서 DHCP를 통해 동적으로 할당하기 때문입니다. 예를 들어, 한국인터넷진흥원에서 제공하는 <a href="https://후이즈검색.한국/">WHOIS</a> 서비스를 통해 IP를 조회해보면 조금 더 상세한 지역을 안내해줍니다.</p>
<p><img data-src="/images/posts/ip-band-and-location-tracking/ipconfig-03.png" alt="WHOIS 조회"></p>
<p>실제로 제가 살고 있는 경기도 양주시에서 사용중인 IP라고 안내해주었습니다. 이렇게 한국인터넷진흥원에서 보다 정확한 위치를 확인할 수 있는 이유는 <strong>KT 인터넷과 같은 인터넷 서비스 사업자에서 한국인터넷진흥원에 지역에 대한 IP 대역 정보를 등록</strong>하기 때문입니다.</p>
<p>공인 IP 대역의 <strong>218.152.0.0부터 218.159.255.255는 KT 인터넷에서 사용중인 IP 대역</strong>이며 그 중에서 218.156.190.X에 대한 IP 대역은 경기도 양주시에서 사용하도록 할당하는 것을 알 수 있습니다. 위치 추적 사이트에서 인터넷 서비스 사업자의 IP 대역은 알 수 있지만 <strong>특정 IP가 실제로 KT 인터넷이 어떤 지역에 할당했는지에 대한 정보가 없기 때문에</strong> KT 인터넷에 대한 본사 또는 지역적으로 퍼져있는 KT 인터넷 장비의 위치 정보를 대신 표시해주는 것 입니다.</p>
<blockquote>
<p>인터넷 서비스 사업자는 지역에 대하여 IP 대역을 형성하기 때문에 특정 IP 대역에서 트래픽 과부화가 발생하면 인터넷 속도를 제한하는 락을 걸기도 합니다. 실제로 인터넷 속도가 충분하게 나오지 않아서 인터넷 기사를 불러 확인해보면 주변 장비에 대한 정보를 확인하고 락 해제를 요청하는 걸 많이 경험했습니다.</p>
<p>지난 4월에 난리였던 <a href="https://www.seoul.co.kr/news/newsView.php?id=20210420500154">KT ‘10기가 인터넷’ 속도저하 논란에 방통위 조사 나선다</a>와 같은 경우도 트래픽 규모에 따라 제한을 둔 것인데 기술적으로 결함이 있지 않았나 싶네요.</p>
</blockquote>
<h3 id="현실과-영화는-다르다"><a href="#현실과-영화는-다르다" class="headerlink" title="현실과 영화는 다르다"></a>현실과 영화는 다르다</h3><p>아무튼, 영화에서는 IP 정보를 알게되면 해당 IP를 사용하는 범죄자의 위치를 정확히 아는 것처럼 나오는 경우가 많습니다. 실제로는 경찰이 필요에 의해 웹 서비스 회사에 특정 아이디에 대한 IP 이력 정보를 요구하는 공조 요청을 하게 되고 <strong>제공받은 IP를 다시 인터넷 서비스 사업자인 KT 본사에게 IP 대역에 대한 정보를 요청</strong>하게 됩니다. 그래서 최종적으로는 <strong>정확한 위치는 아니더라도 대략적으로 읍면동까지</strong>는 알게됩니다.</p>
<p>범죄자가 사용하는 IP가 해외에서 사용하는 공인 IP 정보로 조회되는 경우에는 더 까다로워지는 것은 맞습니다. 해당 IP 대역을 할당하는 인터넷 서비스 업체에게 공조 요청을 하는게 아니라 <strong>국제형사사법 공조법에 의거</strong>해서 국가 간 공조 요청을 하고 제공받아야합니다. 경찰분들이 담당하는 사건들이 하나가 아니기 때문에 해외 IP에 대한 추적을 꺼려하는게 어찌보면 당연할 수 있습니다. </p>
<p>그럼에도 불구하고 <a href="https://www.youtube.com/watch?v=aWqK1b5w9Yo">성 착취 영상물을 유포한 사건</a>의 용의자도 집요한 추적 끝에 잡아내기도 하죠. 해외 VPN 서버를 사용하면 추적할 수 없다는 이야기를 하는 사람들이 많은데 <strong>사실은 추적은 되지만 귀찮을 수 있다</strong>라고 봐야겠죠.</p>
<h2 id="실무-환경에서의-IP"><a href="#실무-환경에서의-IP" class="headerlink" title="실무 환경에서의 IP"></a>실무 환경에서의 IP</h2><p>그러면 실무 환경인 회사에서 사용하는 IP에 대해서 알아보도록 하겠습니다. 회사에서도 자체 내부 사설망을 구축하여 회사 내부에서 근무하는 직원들이 사용할 수 있는 IP를 할당하게 됩니다. 이러한 것은 회사 네트워크를 관리하는 네트워크 담당자가 수행합니다. </p>
<h3 id="NAT-아이피"><a href="#NAT-아이피" class="headerlink" title="NAT 아이피"></a>NAT 아이피</h3><p>일반적으로 라우터 장비로부터 DHCP로 동적으로 할당받는 내부 아이피를 사용하여 인터넷을 사용하지만 경우에 따라서는 외부 인터넷망에서 회사 네트워크 대역에 접근할 수 있도록 NAT 아이피를 요청해야하는 경우도 있습니다.</p>
<p style="text-align:center; font-weight:bold;">"외부에서 접근하기 위한 NAT 아이피가 필요합니다."</p>

<p>그러면 네트워크 담당자는 NAT 아이피가 필요한 사유를 검토하고 NAT 아이피와 함께 외부에서 접근 가능한 도메인 주소와 포트 정보를 전달해줍니다. 회사 라우터 장비에서는 외부 트래픽의 도메인과 포트를 확인하고 연결된 NAT 아이피로 트래픽을 전달해줌으로써 내부 사설망에서 실행중인 애플리케이션에 접근할 수 있게 됩니다.</p>
<h3 id="VPN"><a href="#VPN" class="headerlink" title="VPN"></a>VPN</h3><p>코로나 19로 인하여 <strong>대부분의 IT 기업들이 재택근무를 허용</strong>하게 되었습니다. 필요에 의해 회사로 출근하기도 하지만 대부분의 업무는 집에서 수행합니다. 하지만, 개발 조직에서는 개발 환경에서 사용하는 많은 인스턴스를 외부에서 접근이 불가능한 회사 내부 사설망 서버에 구축합니다. 그리고 아마존 웹 서비스와 같은 클라우드 환경을 사용한다고 하더라도 <strong>SSH를 통한 인스턴스 접근은 회사에서 사용중인 아이피 대역에 대해서만 허용</strong>하는 경우가 많습니다.</p>
<p>집에서 사용하는 공인 IP는 회사에서 사용하는 아이피 대역이 아니므로 SSH 접근이 불가능합니다. 그렇기 때문에 회사 외부에서도 회사에서 사용하는 아이피 대역처럼 사용할 수 있는 VPN을 활용하게 됩니다. 제가 다니고 있는 회사에서는 <strong>TLS 프로토콜을 적용하여 통신하는 OpenVPN을 사용</strong>하고 있으며 여자친구가 일하는 회사에서는 Pulse Secure와 함께 <a href="https://vip.symantec.com/">VIP Access</a>을 사용하여 2단계 인증까지 요구하기도 합니다.</p>
<p>이 글을 보신 여러분들도 인터넷 접속을 위해 할당받은 외부 아이피를 확인해보고 한국인터넷진흥원의 WHOIS 서비스를 통해 어느 지역까지 추적되는지 경험해보시기 바랍니다.</p>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>IP Band</tag>
        <tag>NAT</tag>
        <tag>Location Tracking</tag>
      </tags>
  </entry>
  <entry>
    <title>자바 날짜 및 시간 포맷</title>
    <url>/java-datetime-format/</url>
    <content><![CDATA[<p>여러 국가를 대상으로 해야하는 서비스를 만들어가게 되는 경우 언어 뿐만 아니라 시간을 다루는 것도 중요합니다. 단순하게 말해서 한국에서 서비스를 제공한다고해서 한국 시간으로 모든 시간 데이터를 다루는 것은 좋은 방식이 아닙니다. 기본적으로는 UTC라고 하는 세계 협정 시간을 기준으로 시간을 저장해야합니다. PostgreSQL과 같은 데이터베이스에서도 Timestamp를 저장하게 되는 경우 내부적으로는 UTC로 저장됩니다. 따라서, 2022년 3월 19일 12시 라는 시간은 <code>2022년 3월 19일 03시</code>로 저장되는것이죠.</p>
<blockquote>
<p>애플리케이션 뿐만 아니라 서버 그리고 데이터베이스 모두 UTC로 설정하여 사용하는게 일반적입니다. 예를 들어, 아마존 웹 서비스의 EC2는 한국 리전인데도 불구하고 한국 시간대가 아닌 UTC로 설정되어있습니다.</p>
</blockquote>
<p>그리고 시간 데이터를 전달할 때는 <code>2022-03-19 12:00</code>과 같은 문자열 형태가 아닌 <a href="https://www.unixtimestamp.com/">Unix Timestamp</a>의 밀리초가 부여된 상태로 서버와 클라이언트간 요청과 응답에 사용됩니다. 가끔씩 국내 시간만 다루던 개발자들이 UTC 또는 Unix Timestamp에 대해서 모르는 경우도 꽤 많았습니다. 밀리초 형식의 Unix Timestamp를 전달받았으나 실제로 변환해보니 9시간이 빠진게 아니라 오히려 9시간이 더해진 상태로 전달하던 경험도 있습니다.</p>
<h2 id="Java-Date-Format"><a href="#Java-Date-Format" class="headerlink" title="Java Date Format"></a>Java Date Format</h2><p>서버와 클라이언트 간에 시간 데이터를 전달하거나 개발자 사이에 API를 제공할 때에는 앞서 이야기한 Unix Timestamp로 전달하도록 스펙을 맞출 수 있습니다. 그러나 개발자가 아닌 일반 사용자가 서비스 내에서 CSV 또는 엑셀 파일 형식으로 데이터를 업로드하거나 다운로드 받을때에는 숫자값인 Unix Timestamp가 아닌 <code>2022-03-19 12:00:00</code>과 같은 어떠한 문자 형태이어야합니다. 왜냐하면 일반인들은 UTC가 무엇인지 Unix Timestamp가 무엇인지 모르는 사람이 많으니까요. 심지어는 개발자들 중에서도…</p>
<blockquote>
<p>자바 8의 Date&#x2F;Time API에 대해서는 네이버 D2에 공유된 <a href="%5Bhttps://d2.naver.com/helloworld/645609">Java의 날짜와 시간 API</a>를 참고하시면 좋을 것 같습니다.</p>
</blockquote>
<h3 id="DateTimeFormatter"><a href="#DateTimeFormatter" class="headerlink" title="DateTimeFormatter"></a>DateTimeFormatter</h3><p>자바 8의 날짜 및 시간 클래스에 대해서 날짜 포맷을 적용해야하는 경우 <a href="https://docs.oracle.com/javase/8/docs/api/java/time/format/DateTimeFormatter.html">DateTimeFormatter</a>를 사용해야합니다. 그리고 일반적으로 다음과 같은 코드로 날짜 데이터를 변환할 수 있죠.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">TimeZone</span> tzSeoul <span class="token operator">=</span> <span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">getTimeZone</span><span class="token punctuation">(</span><span class="token string">"Asia/Seoul"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> dateStr <span class="token operator">=</span> <span class="token string">"2022-03-19 12:00:00"</span><span class="token punctuation">;</span>
<span class="token class-name">DateTimeFormatter</span> dateTimeFormatter <span class="token operator">=</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withZone</span><span class="token punctuation">(</span>tzSeoul<span class="token punctuation">.</span><span class="token function">toZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ZonedDateTime</span> dateTime <span class="token operator">=</span> <span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dateStr<span class="token punctuation">,</span> dateTimeFormatter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s -> %s%n"</span><span class="token punctuation">,</span> dateStr<span class="token punctuation">,</span> dateTime<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<blockquote>
<p>위 코드는 이해하기에는 쉬우나 한가지 문제점은 어떤 특정한 형태의 문자열로 구성된 데이터만 변환할 수 있다는 점입니다.</p>
</blockquote>
<p>만약, 서비스 사용자가 2022년 3월 19일 0시의 시간을 표현하고자 한다면 2022-03-19 00:00:00과 같이 불필요하게 00:00:00을 붙여야하는 단점이 생기게 됩니다. 이를 보완하기 위해서는 여러가지 형식의 날짜 포맷을 처리할 수 있는 코드가 필요합니다.</p>
<h3 id="DateTimeFormatterBuilder"><a href="#DateTimeFormatterBuilder" class="headerlink" title="DateTimeFormatterBuilder"></a>DateTimeFormatterBuilder</h3><p>여러가지 형태의 날짜 형식을 지원해야하는 경우에는 <strong>Optional 패턴</strong>을 적용해서 처리할 수 있습니다. DateTimeFormatter에 그대로 적용할수도 있으나 DateTimeFormatterBuilder를 통해 여러가지 처리 방식에 대한 옵션이 적용된 형태로 DateTimeFormatter를 만들 수 있습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">TimeZone</span> tzSeoul <span class="token operator">=</span> <span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">getTimeZone</span><span class="token punctuation">(</span><span class="token string">"Asia/Seoul"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DateTimeFormatter</span> dateTimeFormatter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DateTimeFormatterBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">appendPattern</span><span class="token punctuation">(</span><span class="token string">"[yyyy-MM-dd HH:mm:ss]"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">appendPattern</span><span class="token punctuation">(</span><span class="token string">"[yyyy-MM-dd HH:mm]"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">appendPattern</span><span class="token punctuation">(</span><span class="token string">"[yyyy-MM-dd]"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">parseDefaulting</span><span class="token punctuation">(</span><span class="token class-name">ChronoField</span><span class="token punctuation">.</span>HOUR_OF_DAY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">parseDefaulting</span><span class="token punctuation">(</span><span class="token class-name">ChronoField</span><span class="token punctuation">.</span>MINUTE_OF_HOUR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">parseDefaulting</span><span class="token punctuation">(</span><span class="token class-name">ChronoField</span><span class="token punctuation">.</span>SECOND_OF_MINUTE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">toFormatter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withZone</span><span class="token punctuation">(</span>tzSeoul<span class="token punctuation">.</span><span class="token function">toZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dateStrArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"2022-03-19 00:00:00"</span><span class="token punctuation">,</span> <span class="token string">"2022-03-19 00:00"</span><span class="token punctuation">,</span> <span class="token string">"2022-03-19"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dateStr <span class="token operator">:</span> dateStrArr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ZonedDateTime</span> dateTime <span class="token operator">=</span> <span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dateStr<span class="token punctuation">,</span> dateTimeFormatter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s -> %s%n"</span><span class="token punctuation">,</span> dateStr<span class="token punctuation">,</span> dateTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 2022-03-19 00:00:00 -> 2022-03-19T00:00+09:00[Asia/Seoul]</span>
<span class="token comment">// 2022-03-19 00:00 -> 2022-03-19T00:00+09:00[Asia/Seoul]</span>
<span class="token comment">// 2022-03-19 -> 2022-03-19T00:00+09:00[Asia/Seoul]</span></code></pre>

<h4 id="Unable-to-obtain-LocalTime-from-TemporalAccessor"><a href="#Unable-to-obtain-LocalTime-from-TemporalAccessor" class="headerlink" title="Unable to obtain LocalTime from TemporalAccessor"></a>Unable to obtain LocalTime from TemporalAccessor</h4><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">TimeZone</span> tzSeoul <span class="token operator">=</span> <span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">getTimeZone</span><span class="token punctuation">(</span><span class="token string">"Asia/Seoul"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DateTimeFormatter</span> dateTimeFormatter <span class="token operator">=</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"[yyyy-MM-dd HH:mm:ss][yyyy-MM-dd HH:mm][yyyy-MM-dd]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withZone</span><span class="token punctuation">(</span>tzSeoul<span class="token punctuation">.</span><span class="token function">toZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dateStrArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"2022-03-19 00:00:00"</span><span class="token punctuation">,</span> <span class="token string">"2022-03-19 00:00"</span><span class="token punctuation">,</span> <span class="token string">"2022-03-19"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dateStr <span class="token operator">:</span> dateStrArr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ZonedDateTime</span> dateTime <span class="token operator">=</span> <span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dateStr<span class="token punctuation">,</span> dateTimeFormatter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s -> %s%n"</span><span class="token punctuation">,</span> dateStr<span class="token punctuation">,</span> dateTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>위와 같이 DateTimeFormatterBuilder를 사용하지 않고서도 DateTimeFormatter 패턴 자체로 날짜 포맷 체이닝을 구성할 수 있습니다. 그러나, 2022-03-19와 같이 시간 부분이 없는 형태의 경우에는 다음과 같이 처리할 수 없다는 예외가 발생하게 됩니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>DateTimeParseException</span><span class="token operator">:</span> <span class="token class-name">Text</span> '<span class="token number">2022</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">19</span>' could not be parsed<span class="token operator">:</span> <span class="token class-name">Unable</span> <span class="token keyword">to</span> <span class="token namespace">obtain</span> <span class="token class-name">ZonedDateTime</span> from <span class="token class-name">TemporalAccessor</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>ISO<span class="token punctuation">,</span><span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Seoul</span> resolved <span class="token keyword">to</span> <span class="token number">2022</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">19</span> of type <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>Parsed</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">createError</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2017</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1952</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">598</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">test<span class="token punctuation">.</span></span>Main</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">Main</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">17</span><span class="token punctuation">)</span>
<span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>DateTimeException</span><span class="token operator">:</span> <span class="token class-name">Unable</span> <span class="token keyword">to</span> <span class="token namespace">obtain</span> <span class="token class-name">ZonedDateTime</span> from <span class="token class-name">TemporalAccessor</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>ISO<span class="token punctuation">,</span><span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Seoul</span> resolved <span class="token keyword">to</span> <span class="token number">2022</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">19</span> of type <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>Parsed</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">566</span><span class="token punctuation">)</span>
<span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>DateTimeException</span><span class="token operator">:</span> <span class="token class-name">Unable</span> <span class="token keyword">to</span> <span class="token namespace">obtain</span> <span class="token class-name">ZonedDateTime</span> from <span class="token class-name">TemporalAccessor</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>ISO<span class="token punctuation">,</span><span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Seoul</span> resolved <span class="token keyword">to</span> <span class="token number">2022</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">19</span> of type <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>Parsed</span>

	at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>Parsed</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">Parsed</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">235</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1948</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">2</span> more
<span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>DateTimeException</span><span class="token operator">:</span> <span class="token class-name">Unable</span> <span class="token keyword">to</span> <span class="token namespace">obtain</span> <span class="token class-name">LocalTime</span> from <span class="token class-name">TemporalAccessor</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>ISO<span class="token punctuation">,</span><span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Seoul</span> resolved <span class="token keyword">to</span> <span class="token number">2022</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">19</span> of type <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>Parsed</span>
<span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>DateTimeException</span><span class="token operator">:</span> <span class="token class-name">Unable</span> <span class="token keyword">to</span> <span class="token namespace">obtain</span> <span class="token class-name">LocalTime</span> from <span class="token class-name">TemporalAccessor</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>ISO<span class="token punctuation">,</span><span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Seoul</span> resolved <span class="token keyword">to</span> <span class="token number">2022</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">19</span> of type <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>Parsed</span>

	at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>LocalTime</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">LocalTime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">431</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span>ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">561</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">4</span> more</code></pre>

<blockquote>
<p>따라서, DateTimeFormatterBuilder로 문자열로 구성된 날짜 및 시간 데이터에 구성되지 않는 부분을 어떻게 처리할 것인가에 대한 옵션을 적용하여 DateTimeFormatter를 만들어서 사용하는게 좋아보입니다.</p>
</blockquote>
<p>만약, 이 글을 보시는 여러분들이 여러가지 형태의 날짜 포맷을 처리하기 위해서 아래와 같이 DateTimeFormattter를 여러개 만들어서 처리하는 코드를 작성했다면 DateTimeFormatterBuilder로 하나의 DateTimeFormatter를 사용해서 좀 더 깔끔한 형태의 코드로 만들어보시기를 추천해드립니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> dateStr <span class="token operator">=</span> <span class="token string">"2022-03-19"</span><span class="token punctuation">;</span>
<span class="token class-name">ZonedDateTime</span> dateTime <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    dateTime <span class="token operator">=</span> <span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dateStr<span class="token punctuation">,</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withZone</span><span class="token punctuation">(</span>tzSeoul<span class="token punctuation">.</span><span class="token function">toZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DateTimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">LocalDateTime</span> localDateTime <span class="token operator">=</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dateStr<span class="token punctuation">,</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withZone</span><span class="token punctuation">(</span>tzSeoul<span class="token punctuation">.</span><span class="token function">toZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">atStartOfDay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dateTime <span class="token operator">=</span> <span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>localDateTime<span class="token punctuation">,</span> tzSeoul<span class="token punctuation">.</span><span class="token function">toZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dateTime<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>TimeZone</tag>
        <tag>ZoneId</tag>
        <tag>Instant</tag>
        <tag>ZonedDateTime</tag>
        <tag>DateTimeFormatter</tag>
      </tags>
  </entry>
  <entry>
    <title>키바나에서 엘라스틱서치 클러스터로 연결할 수 없음</title>
    <url>/kibana-cannot-connect-elasticsearch/</url>
    <content><![CDATA[<p><img data-src="/images/posts/kibana-cannot-connect-elasticsearch/01.png"></p>
<p>AWS EC2 인스턴스에 설치된 엘라스틱서치에 대해 키바나를 설치하고 실행하니 위와 같이 엘라스틱서치 클러스터에 연결할 수 없다는 화면이 노출되었습니다. 회사에서 이 문제에 대해 머리를 싸매면서 여러가지를 시도해보았으나 해결되지 않았고 집에와서 쉬는 김에 이와 관련된 정보를 검색해보면서 여러가지 확인 끝에 원인을 찾아내어 이 글을 작성합니다.</p>
<h2 id="키바나-응답-페이로드"><a href="#키바나-응답-페이로드" class="headerlink" title="키바나 응답 페이로드"></a>키바나 응답 페이로드</h2><blockquote>
<p>This Kibana installation has strict security requirements enabled that your current browser does not meet.</p>
</blockquote>
<p>먼저, 웹 페이지 화면에서는 엘라스틱서치 클러스터에 연결할 수 없다는 내용의 메시지였지만 실제로 키바나로부터 받은 응답 페이로드를 확인해보니 <a href="https://www.elastic.co/guide/en/kibana/current/Security-production-considerations.html#csp-strict-mode">Content Security Policy</a> 관련된 오류 내용이었습니다. 그리고 크롬 개발자 도구 콘솔에는 아래와 같은 오류 로그도 표시됨을 확인했습니다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">Refused to execute inline script because it violates the following Content Security Policy directive: <span class="token string">"script-src 'unsafe-eval' 'nonce-LQ+1u6/j7+lb3KNy'"</span><span class="token builtin class-name">.</span>
Either the <span class="token string">'unsafe-inline'</span> keyword, a <span class="token builtin class-name">hash</span> <span class="token punctuation">(</span><span class="token string">'sha256-SHHSeLc0bp6xt4BoVVyUy+3IbVqp3ujLaR+s+kSP5UI='</span><span class="token punctuation">)</span>, or a nonce <span class="token punctuation">(</span><span class="token string">'nonce-...'</span><span class="token punctuation">)</span> is required to <span class="token builtin class-name">enable</span> inline execution.  </code></pre>

<h3 id="CSP-비활성화-시도"><a href="#CSP-비활성화-시도" class="headerlink" title="CSP 비활성화 시도"></a>CSP 비활성화 시도</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">csp.strict</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></code></pre>

<p>엘라스틱서치 클러스터에 연결할 수 없는 사유인지 다른 문제인지를 판단할 수 없어서 CSP를 비활성화 해보았습니다. 그러나, CSP 비활성화 후에도 키바나에서는 동일하게 엘라스틱서치 클러스터에 연결할 수 없다고 표시되었기에 이로 인한 문제는 아님을 확인할 수 있었습니다.</p>
<h2 id="키바나-로그"><a href="#키바나-로그" class="headerlink" title="키바나 로그"></a>키바나 로그</h2><p>사실 키바나에서 엘라스틱서치 클러스터에 연결할 수 없다는 메시지를 보고나서는 엘라스틱서치와 키바나의 설정 파일의 문제가 아닐까 여러가지 살펴보았지만 다른 환경에서 사용중인 설정과 다를바가 없었기에 키바나 로그를 확인해야 했습니다.</p>
<h3 id="Chromium-with-headless-shell"><a href="#Chromium-with-headless-shell" class="headerlink" title="Chromium with headless_shell"></a>Chromium with headless_shell</h3><blockquote>
<p>Reporting plugin self-check generated a warning: Error: Could not close browser client handle</p>
</blockquote>
<p>가장 먼저 의심스러운 위 로그에 대해 검색해보니 <a href="https://github.com/elastic/kibana/issues/53829">kibana&#x2F;issues&#x2F;53829</a>에서 샌드박스 옵션을 설정한 것을 보고 시도해보았습니다.</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">xpack.reporting.capture.browser.chromium.disableSandbox</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code></pre>

<p>위 조치와 함께 EC2에 노드와 크로미움 패키지를 직접 설치까지 해보았지만 위 문제가 해소되지 않았습니다.</p>
<h3 id="플러그인-로그"><a href="#플러그인-로그" class="headerlink" title="플러그인 로그"></a>플러그인 로그</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>error<span class="token punctuation">]</span><span class="token punctuation">[</span>status<span class="token punctuation">]</span><span class="token punctuation">[</span>plugin:xpack_main@7.3.2<span class="token punctuation">]</span> Status changed from yellow to red - <span class="token punctuation">[</span>data<span class="token punctuation">]</span> Elasticsearch cluster did not respond with license information.</code></pre>

<p>집에와서 키바나 로그를 좀 더 자세히 살펴보니 위와 같은 오류 로그가 발생하는 것을 확인하였습니다. 사실 회사에서는 플러그인 오류이므로 키바나에서 엘라스틱서치 클러스터에 연결할 수 없는 사유와는 상관없다고 판단했었습니다. 왜냐하면 엘라스틱서치에 키바나 관련 인덱스까지는 만들어지므로 엘라스틱서치 클러스터와 통신이 되는 상황이라고 생각할 수 밖에 없었을테니까요.</p>
<p>아무튼 위 로그에 대해서 검색해보니 <a href="https://github.com/elastic/kibana/issues/36079">kibana&#x2F;issues&#x2F;36079</a>에 라이센스 정보를 확인하는 댓글이 눈에 들어왔고 라이센스 정보를 확인해보았습니다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>ec2-user ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> http://localhost:9200/_xpack/license?pretty
<span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>사실 라이센스가 없다고 생각하지는 않았고 혹시나 트라이얼 라이센스인데 만료되어서 그런 것인가라고 생각되 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/license-settings.html">License Settings</a>에 나와있는대로 베이직 라이센스 유형을 지정하고 클러스터를 다시 실행하였지만 증상을 동일했습니다. </p>
</blockquote>
<p>그러나, 정말로 엘라스틱서치에는 라이센스 정보가 없었고 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/start-basic.html">Start basic API</a>를 통해 베이직 라이센스를 시작할 수 있다고 하여 아래와 같이 라이센스를 추가하였습니다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>ec2-user ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> -X POST http://localhost:9200/_license/start_basic?pretty
<span class="token punctuation">&#123;</span>
  <span class="token string">"acknowledged"</span> <span class="token builtin class-name">:</span> true,
  <span class="token string">"basic_was_started"</span> <span class="token builtin class-name">:</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>ec2-user ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> http://localhost:9200/_xpack/license?pretty
<span class="token punctuation">&#123;</span>
  <span class="token string">"license"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"status"</span> <span class="token builtin class-name">:</span> <span class="token string">"active"</span>,
    <span class="token string">"uid"</span> <span class="token builtin class-name">:</span> <span class="token string">"fb6a45f5-4f26-45fe-9889-2380b9ec8801"</span>,
    <span class="token string">"type"</span> <span class="token builtin class-name">:</span> <span class="token string">"basic"</span>,
    <span class="token string">"issue_date"</span> <span class="token builtin class-name">:</span> <span class="token string">"2022-08-18T14:51:26.602Z"</span>,
    <span class="token string">"issue_date_in_millis"</span> <span class="token builtin class-name">:</span> <span class="token number">1660834286602</span>,
    <span class="token string">"max_nodes"</span> <span class="token builtin class-name">:</span> <span class="token number">1000</span>,
    <span class="token string">"issued_to"</span> <span class="token builtin class-name">:</span> <span class="token string">"cluster"</span>,
    <span class="token string">"issuer"</span> <span class="token builtin class-name">:</span> <span class="token string">"elasticsearch"</span>,
    <span class="token string">"start_date_in_millis"</span> <span class="token builtin class-name">:</span> -1
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><img data-src="/images/posts/kibana-cannot-connect-elasticsearch/02.png"></p>
<p>엘라스틱서치 클러스터에 베이직 라이센스 정보가 있으므로 키바나에서는 더이상 플러그인 오류가 발생하지 않았으며 키바나 주소로 다시 접속하니 엘라스틱서치 클러스터에 연결할 수 없다는 메시지는 더이상 표시되지 않았습니다. 이로써 키바나에서 엘라스틱서치 클러스터로 연결한다는 의미는 X-Pack 플러그인에 대한 라이센스 정보를 확인한다는 점으로 이해할 수 있을 것 같습니다. 엘라스틱서치 클러스터가 만료된 트라이얼 라이센스를 가지고 있더라도 키바나 또는 Start basic API를 통해 베이직 라이센스로 전환할 수 있습니다. 따라서, 키바나를 실행하고나서 엘라스틱서치 클러스터에 연결할 수 없다는 의미의 메시지를 확인하다면 클러스터에 라이센스 정보가 있는지 확인해보시기 바랍니다.</p>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>Basic License</tag>
      </tags>
  </entry>
  <entry>
    <title>AWS IAM 사용자 리전 제한하기</title>
    <url>/limit-region-aws-iam-user/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>회사에 있던 책들 중 <strong>탄력적 개발로 이끄는 AWS 실천 기술</strong>이라는 책을 읽어보고 관련된 정보를 찾으면서 AWS 활용 방안에 대해 공부하고 있습니다.</p>
<p>AWS 프리 티어 또는 AWS 서비스를 학습하는 사람이라면 모든 권한을 가지고 있는 루트 사용자 계정을 사용하는 경우가 많을겁니다. 실무 환경에서는 회사의 루트 사용자 계정이 아닌 IAM을 통해 직무 또는 특정 권한을 가지는 사용자를 만들어서 사용하도록 구성하겠죠. 보안 등급이 높거나 체계적인 회사라면 AWS 리소스에 대한 정책을 검토하고 부여하겠지만 제가 다니고 있는 회사의 팀에서도 모든 권한을 부여한 사용자를 만들어서 사용하고 있는 것을 보았고 직원마다 권한을 부여할 수 있도록 사용자를 발급해달라고 요청하여 사용하고는 있습니다.</p>
<blockquote>
<p>루트 사용자 계정을 사용하지 않는다고 해도 권한 정책을 검토하고 부여하는 것이 귀찮은 건 맞습니다. 결국 사용자에게 모든 권한을 가지는 정책을 연결하여 사용할 수도 있습니다.</p>
</blockquote>
<p>AWS와 같은 클라우드 서비스는 다양한 지역에 존재하는 데이터 센터에 자원을 생성하고 사용할 수 있도록 지원하기 때문에 사용자 계정 정보가 유출된다면 주로 사용하는 리전이 아닌 곳에 AWS 리소스가 생성되고 요금이 발생하는 문제가 생길 수 있습니다. 일부 요금 폭탄 문제가 생기는 분들도 주로 사용하는 서울 리전에 대한 리소스만 체크한 상태로 있다가 전혀 사용하지 않고 있는 리전에 실행된 AWS 리소스로 인하여 발생하는 요금으로 당황하는 경우도 많은 것 같습니다. </p>
<p>이 글에서는 IAM 사용자의 계정 정보가 유출되더라도 주로 사용하는 리전만 접근할 수 있도록 제한하여 불필요한 리전에 AWS 리소스가 나도 모르게 생성되지 않도록 방지하는 대책을 설정할 수 있는 방법을 알려드립니다.</p>
<h2 id="AWS-IAM"><a href="#AWS-IAM" class="headerlink" title="AWS IAM"></a>AWS IAM</h2><p>IAM(Identity and Access Management)은 사용자의 신원을 확인하거나 리소스에 대한 액세스 권한을 통합적으로 관리하는 기능을 말합니다. AWS IAM도 마찬가지로 조직을 구성하거나 장기 또는 임시적으로 AWS 리소스 권한을 부여하는 기능을 제공합니다.</p>
<h3 id="IAM-사용자"><a href="#IAM-사용자" class="headerlink" title="IAM 사용자"></a>IAM 사용자</h3><p>AWS IAM의 사용자는 AWS 리소스에 대한 장기적인 권한을 가지도록 구성하는 장기 자격 증명입니다. </p>
<p>먼저, 테스트를 위한 IAM 사용자인 pika를 만들겠습니다. pika는 <strong>모든 권한을 가지는 직무 정책인 AdminisratorAccess</strong>를 가진다고 가정하겠습니다.</p>
<p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-01.png"></p>
<p>pika는 AWS에서 기본적으로 제공하는 관리형 정책인 AdministratorAccess와 IAMUserChangePassword을 가지게 되었습니다.</p>
<p>그러면 pika 사용자의 비밀번호가 유출되어 누군가가 AWS 콘솔에 접속할 수 있게 된다면 수 많은 리전에 VPC를 생성하거나 EC2 인스턴스를 실행할 수 있는 상태가 됩니다.</p>
<p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-02.png"></p>
<h3 id="IAM-사용자-리전-제한"><a href="#IAM-사용자-리전-제한" class="headerlink" title="IAM 사용자 리전 제한"></a>IAM 사용자 리전 제한</h3><p>만약 pika라는 사용자가 애플리케이션을 운영하기 위한 구성을 서울(ap-northeast-2) 리전에서만 사용한다고 가정해본다면 다른 리전에 대한 권한을 불필요하게 주고 있는 상태가 됩니다. </p>
<h4 id="aws-RequestedRegion"><a href="#aws-RequestedRegion" class="headerlink" title="aws:RequestedRegion"></a>aws:RequestedRegion</h4><p>IAM 정책을 정의할 때 aws:RequestedRegion는 글로벌 조건 키를 사용하면 특정 리전에 대해서만 권한을 가지도록 제한할 수 있습니다.</p>
<p>만약, 서울 리전만 권한을 부여하고 싶다면 다음과 같이 조건절을 정의하면 됩니다.</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>
            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>
            <span class="token property">"Condition"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token property">"StringEquals"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                    <span class="token property">"aws:RequestedRegion"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                        <span class="token string">"ap-northeast-2"</span>
                    <span class="token punctuation">]</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>기존에 연결하였던 AdministratorAccess라는 직무 정책을 해제하고 AdministratorAccessOnlySeoul이라는 정책을 만들어서 연결하겠습니다.</p>
<p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-03.png"></p>
<h3 id="리전-제한-확인"><a href="#리전-제한-확인" class="headerlink" title="리전 제한 확인"></a>리전 제한 확인</h3><p>pika 사용자는 서울 리전에 대한 권한만 가지도록 제한되었기 때문에 정말로 그러한 상태가 되는지 확인해보겠습니다.</p>
<p>연결되지 않은 탄력적 IP는 요금을 지불해야하므로 탄력적 IP를 생성하려고 시도했지만 불가능합니다. </p>
<p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-04.png"></p>
<p>EC2 인스턴스를 생성하기 위해서 서울 리전에서 사용가능한 AMI 유형을 조회할 수 없기 때문에 진행할 수 없습니다.</p>
<p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-05.png"></p>
<p>도쿄 리전에 대한 페이지는 접속할 수 있지만 AWS 리소스를 생성하는 것은 동일하게 AWS API를 사용하기 때문에 서울 리전외에는 권한 오류가 발생하게 됩니다.</p>
<p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-06.png"></p>
<p>심지어는 글로벌 리전 서비스인 S3에서도 권한 오류가 발생합니다. 이는 S3 서비스로 이동할 때 현재 리전 파라미터를 전달하기 때문인데 서울 리전으로 변경하거나 제거하시면 됩니다.</p>
<p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-07.png"></p>
<h3 id="경계-설정으로-리전-제한"><a href="#경계-설정으로-리전-제한" class="headerlink" title="경계 설정으로 리전 제한"></a>경계 설정으로 리전 제한</h3><p>앞서 pika 사용자는 AdministratorAccess라는 직무 정책과 동일하게 모든 권한을 가지는 AdministratorAccessOnlySeoul이라는 정책을 만들어서 연결하여 제한하였습니다. 그러나 사용자마다 부여된 권한이 다를 수 있기 때문에 매번 리전을 제한하는 정책을 만들어서 연결하기에는 불편함이 있습니다. 이 경우에는 정책을 권한 경계(Permissions boundary)로 설정하면 모든 사용자마다 부여된 정책에 대하여 리전을 제한할 수 있습니다.</p>
<h4 id="특정-서비스에-대한-권한을-가진-사용자"><a href="#특정-서비스에-대한-권한을-가진-사용자" class="headerlink" title="특정 서비스에 대한 권한을 가진 사용자"></a>특정 서비스에 대한 권한을 가진 사용자</h4><p>제가 사용하는 mambo라는 사용자는 VPC, EC2, S3에 대한 모든 권한을 가지도록 정책을 연결하였습니다.</p>
<p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-08.png"></p>
<h4 id="서울-리전을-경계로-제한"><a href="#서울-리전을-경계로-제한" class="headerlink" title="서울 리전을 경계로 제한"></a>서울 리전을 경계로 제한</h4><p>이전과 동일하게 서울 리전만을 사용할 수 있도록 제한하기 위해 정책을 만들어서 권한 경계로 설정하겠습니다.</p>
<p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-09.png"></p>
<p>mambo 사용자는 RDS에 대한 권한이 없기 때문에 서울 리전에서도 RDS를 사용하여 데이터베이스를 생성할 수 없습니다.</p>
<p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-10.png"></p>
<p>EC2 서비스에 대한 권한을 가지고 있지만 경계 설정으로 인하여 서울 리전이 아니면 권한이 없게 됩니다.</p>
<p><img data-src="/images/posts/limit-region-aws-iam-user/aws-iam-user-11.png"></p>
<h4 id="글로벌-서비스-리전"><a href="#글로벌-서비스-리전" class="headerlink" title="글로벌 서비스 리전"></a>글로벌 서비스 리전</h4><p>CloudFront, Route53, IAM과 같은 글로벌 서비스는 미국 동부 (us-east-1) 리전의 엔드포인트를 사용하기 때문에 이에 대한 권한을 별도로 설정하여야합니다.</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
    <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"cloudfront:*"</span><span class="token punctuation">,</span>
        <span class="token string">"route53:*"</span><span class="token punctuation">,</span>
        <span class="token string">"iam:*"</span><span class="token punctuation">,</span>
        <span class="token string">"support:*"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>
    <span class="token property">"Condition"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"StringEquals"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"aws:RequestedRegion"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"us-east-1"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="끝마치며"><a href="#끝마치며" class="headerlink" title="끝마치며"></a>끝마치며</h2><p>IAM 사용자가 사용할 수 있는 리전을 제한함으로써 비록 계정 정보가 유출되더라도 서울 리전에서만 AWS 리소스를 마음대로 생성할 수 있도록 방지할 수 있게 되었습니다. 이 방법을 적용하더라도 IAM 사용자의 비밀번호와 액세스 키는 주기적으로 갱신하는 것은 반드시 필요합니다.</p>
<p>감사합니다.</p>
]]></content>
  </entry>
  <entry>
    <title>도커 데스크탑이 사용하는 WSL 리소스 제한하기</title>
    <url>/limit-resources-docker-desktop-using-wslconfig/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다. </p>
<p>오늘은 <strong>윈도우 환경의 도커 데스크탑에서 사용하는 WSL 리소스를 제한하는 방법</strong>에 대하여 공유하고자 합니다. 윈도우에서 도커 데스크탑을 사용할 때 컴퓨터가 느려진다는 느낌을 받고있다면 현재 도커 데스크탑과 WSL에 의해 점유되는 메모리를 확인하시고 이 글에서 소개하는 방법으로 WSL가 점유하는 리소스를 제한하시는게 좋습니다.</p>
<h2 id="Docker-Desktop-WSL-2"><a href="#Docker-Desktop-WSL-2" class="headerlink" title="Docker Desktop WSL 2"></a>Docker Desktop WSL 2</h2><p>윈도우 10 환경에서 WSL 2를 설치하고 활성화했다면 도커 데스크탑에서 WSL 2를 사용해서 컨테이너를 구동될 수 있도록 지원하고 있습니다. </p>
<p><img data-src="/images/posts/docker-desktop-wsl-config/docker-desktop-wsl-config-01.png"></p>
<blockquote>
<p>Docker Desktop uses the dynamic memory allocation feature in WSL 2 to greatly improve the resource consumption. This means, Docker Desktop only uses the required amount of CPU and memory resources it needs, while enabling CPU and memory-intensive tasks such as building a container to run much faster.</p>
</blockquote>
<p>도커 데스크탑 공식 문서에서는 WSL 2을 사용하면 메모리를 동적으로 할당할 수 있고 리소스를 효율적으로 소비한다고 소개합니다. 그런데 실제로 도커를 사용하여 다수의 컨테이너를 실행하다보면 컴퓨터 성능이 점점 느려지는 것을 체감하실 수도 있는 분들도 계실텐데요. 이 문제는 WSL 깃허브에 이슈로 등록되어있는데 WSL가 점유하는 메모리를 제대로 반환하지 못하는 현상인 것 같습니다.</p>
<p><a href="https://github.com/microsoft/WSL/issues/4166">WSL 2 consumes massive amounts of RAM and doesn’t return it</a></p>
<p>이슈가 등록된 날짜는 2019년이지만 아직도 해결되지 않고 오픈된 상태로 남아있는 이슈입니다. 개발자 한분은 <a href="https://github.com/microsoft/WSL/issues/4166#issuecomment-526725261">WSL2 VM이 점유하는 리소스를 제한하는 방법</a>을 사용하여 WSL에서 사용하는 메모리를 제한하라고 해결책을 제시합니다.</p>
<h3 id="WSL-Configuration"><a href="#WSL-Configuration" class="headerlink" title="WSL Configuration"></a>WSL Configuration</h3><p>위에서 소개한 방법은 이미 도커 데스크탑에서도 설정 메뉴에서 소개하고 있는 부분으로 리소스 제한은 윈도우에 의해 관리되므로 CPU, 메모리 등을 제한하기 위해서는 WSL 2의 설정을 수행하라고 합니다.</p>
<p><img data-src="/images/posts/docker-desktop-wsl-config/docker-desktop-wsl-config-02.png"></p>
<h4 id="wslconfig-정의"><a href="#wslconfig-정의" class="headerlink" title=".wslconfig 정의"></a>.wslconfig 정의</h4><p>사용자 폴더 위치에서 .wslconfig 파일을 직접 생성하거나 다음과 같이 윈도우 터미널에서 비쥬얼 스튜디오 코드를 사용하여 생성할 수 있습니다. </p>
<blockquote>
<p>파일을 만들기 위한 파워 쉘 명령어가 별도로 존재하지만 비쥬얼 스튜디오 코드로 여는게 더 편하다고 생각합니다.</p>
</blockquote>
<p><img data-src="/images/posts/docker-desktop-wsl-config/docker-desktop-wsl-config-03.png"></p>
<p>비쥬얼 스튜디오 코드로 열어진 .wslconfig 파일의 내용을 다음과 같이 입력하고 저장합니다.</p>
<pre class="language-plain" data-language="plain"><div class="caption"><span>.wslconfig</span></div><code class="language-plain">[wsl2]
memory=4GB
processors=2
swap=0</code></pre>

<h4 id="wslconfig-반영"><a href="#wslconfig-반영" class="headerlink" title=".wslconfig 반영"></a>.wslconfig 반영</h4><p>파일에 정의한 내용을 WSL에 반영하기 위해서는 도커 데스크탑을 종료하고 <strong>PowerShell</strong>을 관리자 권한으로 실행한 다음 <strong>LxssManager</strong>를 다시 실행해야합니다.</p>
<p><img data-src="/images/posts/docker-desktop-wsl-config/docker-desktop-wsl-config-04.png"></p>
<h3 id="비교해보기"><a href="#비교해보기" class="headerlink" title="비교해보기"></a>비교해보기</h3><p>다음은 간단하게 WSL 2의 기본 설정에 의해 동작하는 것과 .wslconfig을 정의해서 WSL 에서 사용할 리소스를 제한하였을 경우를 비교한 내용입니다. 대략적으로 어떤 차이를 보이는지만 확인해주시기 바랍니다.</p>
<h4 id="기본-WSL-2"><a href="#기본-WSL-2" class="headerlink" title="기본 WSL 2"></a>기본 WSL 2</h4><p>먼저, 기본 WSL 2 설정에 의해 도커 데스크탑이 점유하게 되는 리소스를 확인해보죠.</p>
<p><img data-src="/images/posts/docker-desktop-wsl-config/docker-desktop-wsl-config-05.gif"></p>
<p>기다리기 지겨워하실 분들을 위해서 설명하자면 컨테이너를 실행할때마다 메모리가 올라가면서 4GB를 점유한 것을 보여주고 있습니다. 사용하는 만큼 메모리를 점유하는 것은 당연한 부분일 수 있으나 문제는 그 다음부터 발생합니다.</p>
<p><img data-src="/images/posts/docker-desktop-wsl-config/docker-desktop-wsl-config-06.png"></p>
<p>위 화면을 살펴보시면 도커 데스크탑으로 실행했던 컨테이너를 전부 종료하고 이미지 그리고 볼륨을 전부 삭제했음에도 불구하고 <strong>WSL2에서 점유중인 메모리의 일부는 반환되지 않고 있음</strong>을 보여줍니다. </p>
<h4 id="사용자-정의-WSL-2"><a href="#사용자-정의-WSL-2" class="headerlink" title="사용자 정의 WSL 2"></a>사용자 정의 WSL 2</h4><p>이제 WSL 2에서 점유하여 사용할 프로세서를 2개, 메모리를 2GB 그리고 스왑을 하지않도록 설정하고 앞서 컨테이너를 실행했던 것을 다시 시도 해본 결과를 확인해보겠습니다.</p>
<p><img data-src="/images/posts/docker-desktop-wsl-config/docker-desktop-wsl-config-07.gif"></p>
<p>기본 설정때와는 다르게 여러개의 컨테이너를 실행하더라도 WSL2에서 할당하는 메모리는 2GB를 넘지않게 됨을 확인할 수 있습니다. 물론, 점유하고 있는 리소스가 제한되어있기 때문에 컨테이너 성능은 줄어들게 당연한 부분입니다. 따라서, 시스템 자원이 여유롭다면 적당하게 제한하시는 것을 추천합니다.</p>
<h2 id="느려짐을-체감하는-이유"><a href="#느려짐을-체감하는-이유" class="headerlink" title="느려짐을 체감하는 이유"></a>느려짐을 체감하는 이유</h2><p>.wslconfig 파일을 정의하지 않고 기본 설정으로 WSL 2를 사용하고 있을때 도커 데스크탑이 시스템 자원을 어느정도 까지 사용할 수 있을 지 확인해보겠습니다.</p>
<p><img data-src="/images/posts/docker-desktop-wsl-config/docker-desktop-wsl-config-08.png"></p>
<p>기본적으로 <em><strong>프로세서는 전부 사용</strong></em>한다고 하며 메모리는 <strong>총 메모리의 절반 또는 8GB 중 작은쪽으로 설정</strong>됩니다. 저의 경우는 32GB의 메모리이므로 메모리의 절반보다 작은 8GB가 설정되게 됩니다. 일반적으로 개발자가 사용하는 컴퓨터의 메모리 용량 16GB이라면 동일하게 8GB이므로 <strong>무려 총 메모리의 절반이나 점유</strong>할 수 있게 되고 컨테이너를 종료하더라도 일부의 메모리는 점유하고 있을 수 있다는 이야기입니다.</p>
<p>윈도우의 리소스 모니터를 사용해서 vmmem에 할당된 메모리가 높은지 확인해보시기 바라며 이상으로 도커 데스크탑이 사용하는 WSL 리소스 제한하기를 마치겠습니다.</p>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>WSL</tag>
        <tag>Docker Desktop</tag>
      </tags>
  </entry>
  <entry>
    <title>HTTP/2를 사용하는 개발 환경</title>
    <url>/local-for-http2/</url>
    <content><![CDATA[<p>지난 <a href="/ssl-certificate">SSL 인증서</a>와 <a href="/tls-offload">TLS 오프로드</a>라는 글을 통해 HTTPS에 대해서 살펴본 적이 있습니다. 이처럼 HTTPS는 사용자의 요청이 안전하게 서버로 전달되는 것을 목적으로 도입하지만 <a href="https://developers.google.com/web/fundamentals/performance/http2?hl=ko">HTTP&#x2F;2</a>를 사용하기 위함도 있습니다. 일반 사용자의 컴퓨터나 모바일 디바이스에 대한 성능이 좋아지면서 TLS 핸드쉐이킹에 대한 비용은 그다지 크지 않습니다. 그러나 HTTP 1.1에서의 Keep Alive 도입은 이미 연결중인 TCP를 다시 사용하므로 어느정도의 TLS 핸드쉐이킹에 대한 비용을 줄일 수 있지만 수 많은 요청이 발생하는 애플리케이션에서는 이미 응답을 기다리는 요청이 끝나기를 현재 요청이 대기해야하는 문제를 가지고 있습니다.</p>
<blockquote>
<p>HTTP 1.1은 keep-alive 커넥션을 통해 여러개의 TCP 연결을 일정 시간 열어놓고 요청을 차례대로 수행하기 때문에 브라우저에서는 <a href="https://stackoverflow.com/a/985704">HTTP 1.1를 사용할 때 도메인 당 최대 연결 수를 제한</a>합니다.</p>
</blockquote>
<h2 id="HTTP-x2F-2"><a href="#HTTP-x2F-2" class="headerlink" title="HTTP&#x2F;2"></a>HTTP&#x2F;2</h2><p>HTTP 1.1이 이미 연결된 TCP 커넥션을 다시 재사용한다면 HTTP2는 단일 TCP 연결을 수행하고 수 많은 요청을 스트림으로 처리합니다. 그렇기에 꽤 많은 요청을 동시에 수행해도 브라우저는 이를 제한하지 않습니다. 예를 들어, 자바스크립트에서 <strong>프로미스로 여러개 요청을 동시에 수행하도록</strong> 코드를 작성하더라도 다른 요청이 끝나기까지 요청이 대기하는 현상이 줄어들게되며, 웹팩을 통해 클라이언트 UI를 구성하는 에셋 파일들을 <strong>여러개의 작은 사이즈로 나누는 청크를 수행</strong>하고 웹 페이지 로딩 시 분할된 청크를 빠르게 응답받을 수 있습니다.</p>
<blockquote>
<p>브라우저에서 HTTP&#x2F;2도 도메인 당 TCP 연결을 수행합니다. 그리고 대부분의 브라우저와 서버에서는 HTTP&#x2F;2 연결을 위해 TLS 사용을 요구합니다.</p>
</blockquote>
<h3 id="ALPN"><a href="#ALPN" class="headerlink" title="ALPN"></a>ALPN</h3><p>HTTP2.Pro 사이트를 사용해서 <a href="https://http2.pro/check?url=https://naver.com/">네이버</a>와 <a href="https://http2.pro/check?url=https://okky.kr/">오키</a> 서비스 주소를 입력해보면 ALPN 지원 여부에 대한 정보가 표시됩니다. ALPN은 TLS 핸드쉐이크를 수행하고 서버와 클라이언트간 연결에서 어떤 HTTP 프로토콜을 사용할 것인지를 결정하기 위한 정책입니다. 아마존 웹 서비스는 <a href="https://aws.amazon.com/ko/about-aws/whats-new/2020/05/network-load-balancer-now-supports-tls-alpn-policies/">NLB</a>에서도 TLS ALPN 정책을 지원하기도 하죠.</p>
<blockquote>
<p>HTTP&#x2F;2 연결을 우선적으로 요구하고 클라이언트가 불가능하다면 HTTP 1.1로 연결할 수 있습니다.</p>
</blockquote>
<h3 id="Local-CA-with-mkcert"><a href="#Local-CA-with-mkcert" class="headerlink" title="Local CA with mkcert"></a>Local CA with mkcert</h3><p><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto.webserver.configure-http2.undertow">스프링 부트 애플리케이션</a> 뿐만 아니라 <a href="/reverse-proxy-using-nginx">엔진엑스</a>에서도 TLS 구성을 위해서는 인증서가 필요합니다. 그래서 지난 SSL 인증서 글에서는 <a href="/ssl-certificate/#%EC%9E%90%EC%B2%B4-%EC%84%9C%EB%AA%85-CA-%EC%9D%B8%EC%A6%9D%EC%84%9C-%EB%B0%9C%EA%B8%89">자체 서명 CA 인증서 발급</a>을 한것처럼 로컬 개발 환경을 위한 인증서를 만들고 적용하는 과정을 공유했습니다. 이 과정들은 생각보다 까다롭고 불편한 부분이 많습니다. 결국 불편한 것을 극히 싫어하는 개발자들은 <a href="https://github.com/FiloSottile/mkcert">mkcert</a>라고 하는 로컬 환경을 위한 CA 인증서를 자동으로 신뢰 기관에 등록하는 도구를 만들어냅니다.</p>
<pre class="language-ps" data-language="ps"><code class="language-ps">PS C:\Users\Mambo\cert&gt; mkcert -install
The local CA is now installed in the system trust store! ⚡️

PS C:\Users\Mambo\docker\nginx.conf&gt; mkcert -ecdsa localhost 127.0.0.1 ::1 mambo.kr

Created a new certificate valid for the following names 📜
 - &quot;localhost&quot;
 - &quot;127.0.0.1&quot;
 - &quot;::1&quot;
 - &quot;mambo.kr&quot;

The certificate is at &quot;.&#x2F;localhost+3.pem&quot; and the key at &quot;.&#x2F;localhost+3-key.pem&quot; ✅

It will expire on 22 May 2024 🗓</code></pre>

<blockquote>
<p>간단하게 CA 인증서를 신뢰 기관에 등록하고 로컬 컴퓨터를 위한 인증서를 발급했습니다.<br>로컬 컴퓨터를 위한 인증서에 대한 신뢰 인증서를 등록한다는 점을 잊지 마세요.</p>
</blockquote>
<h2 id="로컬-개발-환경"><a href="#로컬-개발-환경" class="headerlink" title="로컬 개발 환경"></a>로컬 개발 환경</h2><p>일반적으로 TLS 핸드쉐이크를 수행하는 이후의 트래픽 전달에는 TLS 연결을 수행하도록 하지 않도록 구성합니다. 일부 엔지니어들은 모든 트래픽 전달에 TLS 연결을 해야한다고 말합니다. 어느정도의 보안적인 구성을 하느냐는 조직에서 결정해야할 일입니다. 현재 조직은 아마존 웹 서비스의 로드밸런서에서 TLS 핸드쉐이크를 수행하도록 하고 내부적인 트래픽 전달에는 TLS를 사용하여 패킷을 보호하지 않습니다. </p>
<p>TLS 오프로드 및 리버스 프록시를 위한 엔진엑스를 구성하고 HTTP로 실행된 애플리케이션에 트래픽을 전달하며 HTTP&#x2F;2를 사용할 수 있게 만들겠습니다. 이미 사용중인 엔진엑스가 없다면 제 깃허브 리파지토리 <a href="https://github.com/kdevkr/nginx.conf">nginx.conf</a>의 코드를 활용해서 도커 컴포즈로 엔진엑스 컨테이너를 실행하셔도 좋습니다.</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.8'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span> 
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.21.3<span class="token punctuation">-</span>alpine
    <span class="token key atrule">ports</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token datetime number">80:80</span>
      <span class="token punctuation">-</span> 443<span class="token punctuation">:</span><span class="token number">443</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./nginx.conf<span class="token punctuation">:</span>/etc/nginx/nginx.conf
      <span class="token punctuation">-</span> ./localhost+3.pem<span class="token punctuation">:</span>/etc/nginx/server.crt
      <span class="token punctuation">-</span> ./localhost+3<span class="token punctuation">-</span>key.pem<span class="token punctuation">:</span>/etc/nginx/server.key
      <span class="token punctuation">-</span> ./static<span class="token punctuation">:</span>/etc/nginx/static
  <span class="token key atrule">app</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> amazoncorretto<span class="token punctuation">:</span>11<span class="token punctuation">-</span>alpine
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'java -jar /etc/app.jar'</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./demo<span class="token punctuation">-</span>0.0.1<span class="token punctuation">-</span>SNAPSHOT.jar<span class="token punctuation">:</span>/etc/app.jar
</code></pre>

<blockquote>
<p>저는 리파지토리에 있는 사설 인증서 대신에 mkcert를 통해 만들어진 인증서를 사용하도록 변경했습니다.</p>
</blockquote>
<p>리파지토리에 저장된 샘플 애플리케이션을 그대로 사용했지만 로컬 호스트에서 인텔리제이와 같은 개발 도구로 애플리케이션을 실행하셨다면 nginx.conf 파일의 백엔드 스트림에 대한 주소를 <code>host.docker.internal</code>로 변경하세요. 컨테이너로 실행된 엔진엑스에서 로컬 호스트로 트래픽이 전달되게 됩니다.</p>
<p><img data-src="/images/posts/local-for-http2/security-overview.png" alt="TLS Handshake"><br><img data-src="/images/posts/local-for-http2/network-overview.png" alt="HTTP/2"></p>
<blockquote>
<p>mkcert가 자동으로 신뢰 기관 목록에 자신의 CA 인증서를 등록하였기 때문에 브라우저는 인증서를 신뢰할 수 있다고 판단했고 HTTPS 연결이 정상적으로 수행되었습니다.</p>
</blockquote>
<p>이제 여러분들도 로컬 환경에서 개발하실때 HTTPS와 그리고 HTTP 1.1이 아닌 HTTP&#x2F;2를 사용해보시기 바랍니다.</p>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>Spring Boot</tag>
        <tag>Nginx</tag>
        <tag>TLS</tag>
        <tag>HTTP2</tag>
        <tag>mkcert</tag>
      </tags>
  </entry>
  <entry>
    <title>롬복 어노테이션 프로세서</title>
    <url>/lombok-annotation-processor/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>오늘은 인텔리제이에서 롬복 라이브러리를 적용하는 방법을 알아가기 위한 내용을 공유하고자 합니다.</p>
<h2 id="Lombok"><a href="#Lombok" class="headerlink" title="Lombok"></a>Lombok</h2><p><a href="https://projectlombok.org/">롬복 라이브러리</a>는 자바 프로젝트에서 필수적으로 사용될만큼 편리하고 유용한 기능을 제공합니다. 롬복 라이브러리는 <a href="https://docs.oracle.com/javase/7/docs/technotes/guides/apt/GettingStarted.html">APT(Annotation Processing Tool)</a>를 통해 어노테이션 프로세서(Annotation Processor)로 컴파일 단계에서 수행하게 됩니다. 따라서, 롬복 라이브러리를 사용하기 위해서는 프로젝트에서 어노테이션 프로세서를 동작시키기 위한 설정을 해야합니다.</p>
<h3 id="인텔리제이-어노테이션-프로세서"><a href="#인텔리제이-어노테이션-프로세서" class="headerlink" title="인텔리제이 어노테이션 프로세서"></a>인텔리제이 어노테이션 프로세서</h3><p>인텔리제이에서는 클래스패스에 있는 어노테이션 프로세서를 구성하기 위한 <a href="https://www.jetbrains.com/help/idea/annotation-processors-support.html">어노테이션 프로세싱 기능</a>을 지원합니다. 이 어노테이션 프로세싱 기능이 활성화되면 클래스패스에 있는 어노테이션 프로세서를 자동으로 등록하게 됩니다.</p>
<p><img data-src="/images/posts/lombok-annotation-processor/intellij-annotation-processing.png"></p>
<h4 id="그래들-프로젝트"><a href="#그래들-프로젝트" class="headerlink" title="그래들 프로젝트"></a>그래들 프로젝트</h4><p>인텔리제이는 그래들 프로젝트에 있는 기본 그래들 래퍼를 사용하여 프로젝트를 빌드하고 실행하도록 설정되어있습니다. <strong>Build Tools &gt; Gradle</strong> 메뉴에서 기본 그래들 래퍼가 아닌 인텔리제이 자체로 빌드하고 실행되도록 변경할 수 있습니다. 인텔리제이 자체적으로는 롬복 플러그인을 번들에 포함하고 있으므로 롬복 어노테이션 프로세서가 클래스패스에 위치하기 때문에 어노테이션 프로세싱 기능이 활성화되어있다면 롬복에 대한 어노테이션 프로세서가 자동으로 등록되게 됩니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>
    compileOnly <span class="token string">'org.projectlombok:lombok'</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p><em>인텔리제이는 친절하게도 롬복 라이브러리가 클래스패스에 있지만 어노테이션 프로세싱 기능이 비활성화되어있으면 이벤트 로그에 기능 활성화를 묻는 알림을 제공합니다.</em><br><em>또한, 인텔리제이를 사용하도록 선택한 환경에서는 별다른 설정없이도 클래스패스에 롬복 라이브러리가 있으면 어노테이션 프로세서가 동작함을 확인할 수 있습니다.</em></p>
</blockquote>
<h4 id="그래들-어노테이션-프로세서-구성"><a href="#그래들-어노테이션-프로세서-구성" class="headerlink" title="그래들 어노테이션 프로세서 구성"></a>그래들 어노테이션 프로세서 구성</h4><p>프로젝트의 기본 설정은 프로젝트의 그래들 래퍼로 실행하는 환경이라고 하였습니다. 이 경우에는 롬복 라이브러리에 대한 어노테이션 프로세서를 그래들 구성 파일에 정의해야합니다.</p>
<p><img data-src="/images/posts/lombok-annotation-processor/intellij-gradle-build-and-run.png"></p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>
    compileOnly <span class="token string">'org.projectlombok:lombok'</span>
    annotationProcessor <span class="token string">'org.projectlombok:lombok'</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>그래들의 annotationProcessor를 통해 롬복 라이브러리의 어노테이션 프로세서가 어노테이션 프로세서가 위치하는 클래스패스에 등록됨에 따라 인텔리제이는 어노테이션 프로세싱 기능 활성화 여부를 확인하고 활성화에 대한 알림을 제공합니다. </p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">configurations <span class="token punctuation">&#123;</span>
   compileOnly <span class="token punctuation">&#123;</span>
       extendsFrom annotationProcessor
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>그래들 기반의 스프링 부트 프로젝트를 시작할 때 롬복을 추가하면 위 구문이 포함되는 것을 확인하실 수 있습니다. 이 구문의 역할이 무엇인지 궁금하지 않으신가요? 인텔리제이는 그래들 설정 팡리에 위 구문이 포함되는 경우 <code>Gradle Imported</code>라는 이름의 프로파일로써 롬복 라이브러리를 어노테이션 프로세서로 등록하기 위한 어노테이션 프로세싱 기능을 활성화하는 것을 자동으로 구성하게 됩니다.</p>
<p><img data-src="/images/posts/lombok-annotation-processor/intellij-lombok-annotation-processing-extends-from.png"></p>
<blockquote>
<p><em>인텔리제이는 기본 프로파일에 대해 어노테이션 프로세싱 기능이 활성화되어있지 않으면 이벤트 로그를 통해 롬복을 위한 어노테이션 프로세싱 기능 활성화를 안내하는 것 같습니다.</em></p>
</blockquote>
<h3 id="롬복-어노테이션-프로세서"><a href="#롬복-어노테이션-프로세서" class="headerlink" title="롬복 어노테이션 프로세서"></a>롬복 어노테이션 프로세서</h3><p>다시 내용을 정리해보자면, 롬복 라이브러리를 적용하기 위해서는 롬복 라이브러리의 어노테이션 프로세서를 등록하기 위한 설정을 수행해야합니다.</p>
<ul>
<li>인텔리제이 어노테이션 프로세싱 활성화(Enable annotation processing)</li>
<li>그래들 어노테이션 프로세서 구성</li>
</ul>
<h4 id="그래들-어노테이션-프로세서-구성-1"><a href="#그래들-어노테이션-프로세서-구성-1" class="headerlink" title="그래들 어노테이션 프로세서 구성"></a>그래들 어노테이션 프로세서 구성</h4><p>인텔리제이를 사용하는 개발 환경에서는 인텔리제이 어노테이션 프로세싱 활성화 기능을 통해 클래스패스에 있는 어노테이션 프로세서를 자동으로 등록할 수 있습니다만, 젠킨스와 같은 빌드 환경에서 그래들로 어노테이션 프로세서를 등록하기 위해서는 이를 위한 구성을 해야합니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">configurations <span class="token punctuation">&#123;</span>
    compileOnly <span class="token punctuation">&#123;</span>
        extendsFrom annotationProcessor
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
dependencies <span class="token punctuation">&#123;</span>
    compileOnly <span class="token string">'org.projectlombok:lombok'</span>
    annotationProcessor <span class="token string">'org.projectlombok:lombok'</span>
    testCompileOnly <span class="token string">'org.projectlombok:lombok'</span>
    testAnnotationProcessor <span class="token string">'org.projectlombok:lombok'</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>그리고 위 구성은 간단하게 <strong>그래들 롬복 플러그인</strong> 으로 대체할 수 있는데 빌드 도구의 플러그인을 사용하는 것은 공식 홈페이지에서도 추천하는 방식입니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">plugins <span class="token punctuation">&#123;</span>
   id <span class="token interpolation-string"><span class="token string">"io.freefair.lombok"</span></span> version <span class="token interpolation-string"><span class="token string">"6.3.0"</span></span>
<span class="token punctuation">&#125;</span></code></pre>

<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>IntelliJ</tag>
        <tag>Lombok</tag>
        <tag>Annotation Processor</tag>
      </tags>
  </entry>
  <entry>
    <title>리눅스에서 프로세스 실행 유지하기</title>
    <url>/maintaining-process-execution-in-linux/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>서버에서 실행중인 애플리케이션은 언제든지 <strong>예기치 않은 상황</strong>으로 중단될 수 있습니다. 예를 들어, 일시적으로 전력이 차단되어 서버 장비가 다시 시작되거나 애플리케이션 프로세스가 서버 자원을 많이 사용해서 프로세스가 중단되는 상황이 발생할 수 있습니다. </p>
<p>그래서 오늘 알아볼 내용은 리눅스에서 예기치 않은 상황으로 인하여 프로세스가 중단되었을 경우 자동으로 프로세스를 다시 실행시킴으로써 프로세스 실행 상태를 유지하기 위한 방법입니다.</p>
<h2 id="프로세스-실행-유지"><a href="#프로세스-실행-유지" class="headerlink" title="프로세스 실행 유지"></a>프로세스 실행 유지</h2><p>먼저, 스프링 부트 애플리케이션을 다음과 같이 실행할 수 있다고 가정 하겠습니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">nohup java -jar -Xmx500m demo.war 1&gt; app.log 2&gt;&amp;1 &amp;
# [1] 227

ls -l
# total 21M
# -rw-r--r-- 1 ec2-user ec2-user 2.0K Oct  8 15:19 app.log
# -rw-r--r-- 1 ec2-user ec2-user    3 Oct  8 15:19 app.pid
# -rwxr-xr-x 1 ec2-user ec2-user  20M Oct  8 12:28 demo.war*

cat app.pid
# 227</code></pre>

<p>위 예시에서 nohup 명령어를 사용하고 출력된 프로세스 아이디와 스프링 부트 애플리케이션에서 ApplicationPidWriter에 의해 생성된 프로세스 아이디 파일이 동일한 것을 확인할 수 있습니다.</p>
<h3 id="프로세스-아이디-확인하기"><a href="#프로세스-아이디-확인하기" class="headerlink" title="프로세스 아이디 확인하기"></a>프로세스 아이디 확인하기</h3><p>앞서 스프링 부트 애플리케이션처럼 애플리케이션 자체적으로 현재 실행중인 프로세스 아이디를 저장할 수 있는 기능을 포함하고 있다면 좋겠지만 그렇지 않을 수 있습니다. 그래서 이미 실행중인 프로세스 아이디를 확인하고 가져올 수 있는 방법을 알아야 합니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh"># echo $!
nohup java -jar -Xmx500m demo.war 1&gt; app.log 2&gt;&amp;1 &amp; echo $! &gt; app.pid

# JPS(JVM Process Status)
jps -v | grep war | awk &#39;&#123;print $1&#125;&#39;

# ps -ef
ps -ef | grep java | grep -v grep | awk &#39;&#123;print $2&#125;&#39;

# netstat -tnlp
netstat -tnlp | grep java | awk &#39;&#123;print $7&#125;&#39; | awk -F &#39;&#x2F;&#39; &#39;&#123;print $1&#125;&#39;

# pgrep
pgrep java</code></pre>

<p>첫번째 방식에 사용된 <strong>echo $!</strong> 는 마지막으로 백그라운드에서 실행된 명령어에 대한 PID값을 출력할 수 있는 명령어입니다.</p>
<h3 id="Crontab으로-프로세스-유지하기"><a href="#Crontab으로-프로세스-유지하기" class="headerlink" title="Crontab으로 프로세스 유지하기"></a>Crontab으로 프로세스 유지하기</h3><p>일반적으로 사용되는 고전적인 방식은 앞서 다양한 방식으로 추출된 프로세스 아이디에 대한 프로세스 실행 상태를 체크하는 스크립트를 Crontab을 통해 주기적으로 실행하는 것입니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">#!&#x2F;bin&#x2F;sh

PID_FILE&#x3D;&quot;app.pid&quot;

autorun () &#123;
  # ... &amp; echo $! &gt; app.pid
&#125;

if [ -f &quot;$PID_FILE&quot; ] &amp;&amp; [ ! -z &#96;cat &quot;$PID_FILE&quot;&#96; ]; then
  PID&#x3D;$(cat $PID_FILE)
  if ps -p $PID &gt; &#x2F;dev&#x2F;null; then
    echo &quot;$PID_FILE($PID) is running&quot;
  else
    autorun
  fi
else
  autorun
fi</code></pre>

<h3 id="SystemD"><a href="#SystemD" class="headerlink" title="SystemD"></a>SystemD</h3><p>더 효율적인 방식은 Nginx와 같은 패키지를 APT 또는 YUM으로 설치할 때 SystemD 서비스에 자동으로 등록하는 것처럼  애플리케이션을 실행하는 명령어 또는 스크립트를 SystemD 서비스로 등록하는 것입니다. </p>
<p><strong>&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;demo.service</strong></p>
<pre class="language-text" data-language="text"><code class="language-text">[Unit]
Description=Demo
After=syslog.target

[Service]
User=ec2-user
WorkingDirectory=/home/ec2-user
ExecStart=/usr/bin/java -jar -Xmx500m demo.war
ExecStop=kill -9 `cat app.pid`
SuccessExitStatus=143
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target</code></pre>

<p>위와 같이 스크립트를 정의했다면 다음과 같이 서버가 실행될 때 서비스가 시작되도록 활성화하거나 직접 서비스를 실행하고 종료할 수 있습니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">sudo systemctl daemon-reload
sudo systemctl enable demo.service
sudo systemctl start demo.service</code></pre>

<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>XML로 다국어 메시지 관리하기</title>
    <url>/managing-i18n-messages-with-xml/</url>
    <content><![CDATA[<blockquote>
<p>본 글은 <a href="/spring-validation">벨리데이션 오류 메시지가 사용자 언어로 처리되지 않은 이유</a>를 작성하면서 보완되었습니다.</p>
</blockquote>
<h2 id="다국어-메시지"><a href="#다국어-메시지" class="headerlink" title="다국어 메시지"></a>다국어 메시지</h2><p>스프링이나 스프링 부트에서 다국어 메시지를 적용하기 위해서는 Properties를 기본으로 사용해야합니다. 그러나, messages-en.properties 또는 messages-ko.properties와 같이 언어별로 프로퍼티 파일을 구분하여 메시지를 관리해야만 합니다. 이처럼 프로퍼티 파일로 메시지를 관리하다보면 해당 언어에서 특정 메시지를 키를 사용했는지 파악하는게 상당히 어렵습니다. 현재 조직처럼 회사 내 프로젝트를 진행할 때 메시지 키에 대해 정의된 문서가 없는 경우에는 개발자가 메시지 코드를 관리해야하므로 매번 검색해서 사용하고 있는지 파악해야만 합니다.</p>
<h3 id="대안-방식"><a href="#대안-방식" class="headerlink" title="대안 방식"></a>대안 방식</h3><p>프로퍼티 파일로 다국어 메시지를 관리하는 것을 보완하기 위한 방법은 다양합니다.</p>
<h4 id="YAML"><a href="#YAML" class="headerlink" title="YAML"></a>YAML</h4><p>애플리케이션 프로퍼티 파일을 야믈(Yaml) 파일로 대체하는 것처럼 YAML 파일을 사용해서 다국어 메시지를 관리하는 방법은 <a href="https://jmlim.github.io/spring/2018/11/28/spring-boot-Internationalization/">기억하기 위한 개발노트:스프링부트에서 다국어 기능 사용하기</a>를 통해 확인할 수 있습니다. 그러나 이 방식은 파일만 대체할 뿐 메시지를 관리하기 위한 YAML 파일은 언어별로 만들어야함으로 프로퍼티의 문제점을 동일하게 가지고 있습니다.</p>
<blockquote>
<p>ISO-8859-1 인코딩 형식으로 저장되는 프로퍼티와는 다르게 한글이 유니코드로 표시되지 않는다는 장점은 존재합니다.</p>
</blockquote>
<h4 id="XML"><a href="#XML" class="headerlink" title="XML"></a>XML</h4><p>현재 조직에서는 프로젝트에서 사용하는 다국어 메시지를 XML 파일로 구성하여 관리하고 있습니다. 다음은 다국어 메시지를 관리하기 위한 XML 파일의 간단한 예시입니다.</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>messages</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn.signIn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ko_KR</span><span class="token punctuation">></span></span><span class="token cdata">&lt;![CDATA[로그인]]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ko_KR</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>en_US</span><span class="token punctuation">></span></span><span class="token cdata">&lt;![CDATA[Login]]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>en_US</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>messages</span><span class="token punctuation">></span></span></code></pre>

<h3 id="커스텀-리소스-번들"><a href="#커스텀-리소스-번들" class="headerlink" title="커스텀 리소스 번들"></a>커스텀 리소스 번들</h3><p>프로퍼티 파일 대신에 XML로 메시지 소스를 만들기 위해서는 리소스 번들부터 만들어야합니다. ResourceBundle 클래스의 getBundle 함수를 사용해서 XML 파일을 읽어 리소스 번들로 변환할 수 있습니다. 리소스 번들로 메시지 소스를 만드는 구조는 <a href="https://firstboos.tistory.com/entry/XML-%EA%B8%B0%EB%B0%98%EC%9D%98-Resource-Bundle-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0">XML 기반의 Resource Bundle, PropertyPlaceHolder 사용하기</a>에서 확인할 수 있습니다.</p>
<h4 id="XmlResourceBundle"><a href="#XmlResourceBundle" class="headerlink" title="XmlResourceBundle"></a>XmlResourceBundle</h4><p>그러나 앞서 알아본 다국어 메시지에 대한 XML 파일은 프로퍼티 구조를 따르지 않습니다. 그래서 <strong>Properties.loadFromXML</strong> 함수를 통해 XML을 프로퍼티 기준으로 읽으면 안됩니다. 다음처럼 XML 구성에 따라서 메시지 정보를 만들어야합니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>w3c<span class="token punctuation">.</span>dom<span class="token punctuation">.</span></span><span class="token class-name">Document</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>w3c<span class="token punctuation">.</span>dom<span class="token punctuation">.</span></span><span class="token class-name">Element</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>w3c<span class="token punctuation">.</span>dom<span class="token punctuation">.</span></span><span class="token class-name">Node</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>w3c<span class="token punctuation">.</span>dom<span class="token punctuation">.</span></span><span class="token class-name">NodeList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>sax<span class="token punctuation">.</span></span><span class="token class-name">SAXException</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>parsers<span class="token punctuation">.</span></span><span class="token class-name">DocumentBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>parsers<span class="token punctuation">.</span></span><span class="token class-name">DocumentBuilderFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>parsers<span class="token punctuation">.</span></span><span class="token class-name">ParserConfigurationException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XmlResourceBundle</span> <span class="token keyword">extends</span> <span class="token class-name">ResourceBundle</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> messages<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Locale</span> i18n<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">XmlResourceBundle</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> is<span class="token punctuation">,</span> <span class="token class-name">Locale</span> i18n<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ParserConfigurationException</span><span class="token punctuation">,</span> <span class="token class-name">SAXException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>is<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>i18n <span class="token operator">=</span> i18n<span class="token punctuation">;</span>
            messages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">DocumentBuilderFactory</span> factory <span class="token operator">=</span> <span class="token class-name">DocumentBuilderFactory</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DocumentBuilder</span> builder <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newDocumentBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Document</span> doc <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
            doc<span class="token punctuation">.</span><span class="token function">getDocumentElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">NodeList</span> entries <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">"entry"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> entries<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Element</span> entry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Element</span><span class="token punctuation">)</span> entries<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> key <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">NodeList</span> childNodes <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> childNodes<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Node</span> n <span class="token operator">=</span> childNodes<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token punctuation">.</span><span class="token function">getNodeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>ELEMENT_NODE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">String</span> locale <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> message <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">getTextContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messages<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>locale<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            messages<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>locale<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>

                        messages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>locale<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">handleGetObject</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> messages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i18n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> handleKeys <span class="token operator">=</span> messages<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">enumeration</span><span class="token punctuation">(</span>handleKeys<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLocale</span><span class="token punctuation">(</span><span class="token class-name">Locale</span> locale<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>i18n <span class="token operator">=</span> locale<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">getMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> messages<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getMessages</span><span class="token punctuation">(</span><span class="token class-name">Locale</span> locale<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> messages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>locale<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>기존의 handleGetObject 함수는 키 파라미터만 받도록 되어있기 때문에 메시지를 가져올 경우에 언어를 지정할 수 없으므로 리소스 번들을 생성하는 시점에 언어를 지정할 수 있게 하였습니다.</p>
</blockquote>
<h4 id="XmlResourceBundleLoader"><a href="#XmlResourceBundleLoader" class="headerlink" title="XmlResourceBundleLoader"></a>XmlResourceBundleLoader</h4><p>XmlResourceBundle를 로드하기 위한 클래스를 만들기 위해서 <a href="http://www.java2s.com/Tutorial/Java/0220__I18N/XMLresourcebundle.htm">The Strings.xml Resource Bundle</a>을 참고하여 코드를 작성합니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>sax<span class="token punctuation">.</span></span><span class="token class-name">SAXException</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>parsers<span class="token punctuation">.</span></span><span class="token class-name">ParserConfigurationException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">BufferedInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URL</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URLConnection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Locale</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ResourceBundle</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XmlResourceBundleLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ResourceBundle<span class="token punctuation">.</span>Control</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> formats <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">"xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getFormats</span><span class="token punctuation">(</span><span class="token class-name">String</span> baseName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> formats<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ResourceBundle</span> <span class="token function">newBundle</span><span class="token punctuation">(</span><span class="token class-name">String</span> baseName<span class="token punctuation">,</span> <span class="token class-name">Locale</span> locale<span class="token punctuation">,</span> <span class="token class-name">String</span> format<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token keyword">boolean</span> reload<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ResourceBundle</span> resourceBundle <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> bundleName <span class="token operator">=</span> <span class="token function">toBundleName</span><span class="token punctuation">(</span>baseName<span class="token punctuation">,</span> locale<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> resourceName <span class="token operator">=</span> <span class="token function">toResourceName</span><span class="token punctuation">(</span>bundleName<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">URL</span> url <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span>resourceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">URLConnection</span> connection <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reload<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            connection<span class="token punctuation">.</span><span class="token function">setUseCaches</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">InputStream</span> stream <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stream <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">BufferedInputStream</span> bis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>locale <span class="token operator">==</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span>ROOT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                locale <span class="token operator">=</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            resourceBundle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XmlResourceBundle</span><span class="token punctuation">(</span>bis<span class="token punctuation">,</span> locale<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SAXException</span> <span class="token operator">|</span> <span class="token class-name">ParserConfigurationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> resourceBundle<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="메시지-소스"><a href="#메시지-소스" class="headerlink" title="메시지 소스"></a>메시지 소스</h3><p>준비된 리소스 번들을 사용하기 위해서 메시지 소스로 변환해야합니다. 사용자 정의 메시지 소스를 만들기 위해서는 <strong>AbstractMessageSource</strong>를 상속하면 됩니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>springboot<span class="token punctuation">.</span>i18n</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">NoSuchMessageException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>i18n<span class="token punctuation">.</span></span><span class="token class-name">LocaleContextHolder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">AbstractMessageSource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">MessageFormat</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomMessageSource</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMessageSource</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">MessageFormat</span><span class="token punctuation">></span><span class="token punctuation">></span></span> formats <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> messages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">CustomMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ResourceBundle</span> resourceBundle <span class="token operator">=</span> <span class="token class-name">ResourceBundle</span><span class="token punctuation">.</span><span class="token function">getBundle</span><span class="token punctuation">(</span><span class="token string">"messages"</span><span class="token punctuation">,</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span>ROOT<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">XmlResourceBundleLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">XmlResourceBundle</span> xmlResourceBundle <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">XmlResourceBundle</span><span class="token punctuation">)</span> resourceBundle<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messages <span class="token operator">=</span> xmlResourceBundle<span class="token punctuation">.</span><span class="token function">getMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 메시지 소스에서 지원하는 언어 목록</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getLocales</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">MessageFormat</span> <span class="token function">resolveCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">Locale</span> locale<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>formats<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 언어 포맷이 없을 경우 메시지 포맷을 새로 생성</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>formats<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>locale<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                formats<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>locale<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">MessageFormat</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> formats<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>locale<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 언어 포맷에 메시지 코드가 없으면 메시지 정보를 통해 포맷을 저장</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messages<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>locale<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    locale <span class="token operator">=</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> msgs <span class="token operator">=</span> messages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>locale<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageFormat</span><span class="token punctuation">(</span>msgs<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">,</span> locale<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">getMessage</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">LocaleContextHolder</span><span class="token punctuation">.</span><span class="token function">getLocale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMessageException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> code<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">getMessage</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token class-name">LocaleContextHolder</span><span class="token punctuation">.</span><span class="token function">getLocale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMessageException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> code<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token class-name">String</span> defaultMessage<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">getMessage</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> args<span class="token punctuation">,</span> defaultMessage<span class="token punctuation">,</span> <span class="token class-name">LocaleContextHolder</span><span class="token punctuation">.</span><span class="token function">getLocale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMessageException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> code<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">Locale</span> locale<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">getMessage</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> locale<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMessageException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> code<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="메시지-소스-갱신"><a href="#메시지-소스-갱신" class="headerlink" title="메시지 소스 갱신"></a>메시지 소스 갱신</h4><p>로컬 환경에서 애플리케이션을 개발하는 동안에는 메시지 소스 정보가 계속 변경되어야하는 요구사항이 있습니다. 스프링 부트를 사용하고 있다면 <strong>spring-boot-devtool</strong>을 사용해서 애플리케이션이 다시 실행할 수 있게 변경할 수 있습니다. 그러나, 메시지 정보가 변경되는 것이 애플리케이션 자체에 특별한 영향을 미치지는 않습니다. 애플리케이션을 다시 실행하지 않고 변경된 메시지 정보를 반영할 수 있도록 하는 것이 좋습니다.</p>
<blockquote>
<p>우리가 구현해야할 동작은 ReloadableResourceBundleMessageSource가 변경된 프로퍼티 파일을 다시 로드하는 것과 비슷합니다.</p>
</blockquote>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomMessageSource</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMessageSource</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">CustomMessageSource</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ArrayUtils</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getActiveProfiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"production"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">"messages.xml"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">long</span> lastModified <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastModified <span class="token operator">&lt;</span> file<span class="token punctuation">.</span><span class="token function">lastModified</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Reload MessageSource - &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            lastModified <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">lastModified</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>위 처럼 파일 수정일을 비교하지 않아도 <a href="https://www.baeldung.com/java-nio2-watchservice">자바 7의 WatchService를 활용</a>해도 파일을 감시할 수 있습니다.</p>
</blockquote>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://docs.oracle.com/javase/tutorial/i18n/serviceproviders/resourcebundlecontrolprovider.html">Installing a Custom Resource Bundle as an Extension</a></li>
<li><a href="http://www.java2s.com/Tutorial/Java/0220__I18N/XMLresourcebundle.htm">XML resource bundle</a></li>
<li><a href="https://firstboos.tistory.com/entry/XML-%EA%B8%B0%EB%B0%98%EC%9D%98-Resource-Bundle-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0">XML 기반의 Resource Bundle, PropertyPlaceHolder 사용하기</a></li>
<li><a href="http://www.fun25.co.kr/blog/java-xml-parser-example-documentbuilder">[자바] XML 파싱 예제 - DocumentBuilder</a></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>모드버스 TCP</title>
    <url>/modbus-tcp/</url>
    <content><![CDATA[<p>대부분의 IoT 디바이스의 통신에는 MQTT 메시징 프로토콜을 사용하고 있지만 에너지 분야 산업에서 사용하는 필드버스들에서는 Modbus 라는 통신 프로토콜을 사용하여 장비 간 제어를 수행하는데 사용되고 있습니다. 에너지 분야에서 사용하기 위한 시스템인 만큼 각종 산업 장비들이 보유하고 있는 데이터를 시스템으로 수집하기 위해서는 모드버스 TCP 프로토콜을 통해 데이터를 가져와서 더 높은 레벨의 통신 프로토콜인 REST API 또는 MQTT를 사용해야 합니다.</p>
<h2 id="Modbus-TCP-x2F-IP"><a href="#Modbus-TCP-x2F-IP" class="headerlink" title="Modbus TCP&#x2F;IP"></a>Modbus TCP&#x2F;IP</h2><p>모드버스 프로토콜은 일반적으로 자동화 설비 산업에서 사용되므로 웹 개발자들이 경험할 수 있는 범용적인 통신 프로토콜은 아닙니다. 모드버스 TCP에서는 MBAP(MODBUS Application Protocol) 헤더와 Function Code 그리고 데이터 프레임을 하나로 전달하게 되며 일반적인 소켓 통신과 동일합니다. </p>
<p>모드버스 프로토콜은 마스터&#x2F;슬레이브 구조이므로 마스터는 슬레이브에서 정의한 메모리 맵 정보를 토대로 데이터를 읽거나 원하는 명령을 수행하도록 메모리의 데이터를 변경할 수 있습니다. 미리 정의된 몇가지의 기능 코드 중에서 03(0x03, Read Holding Registers)과 16(0x10, Wrtie Multiple Registers)를 주로 사용하는 편입니다. </p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">implementation <span class="token string">'com.ghgande:j2mod:3.1.1'</span></code></pre>

<p><a href="https://github.com/steveohara/j2mod">steveohara&#x2F;j2mod</a>는 모드버스 TCP에 대해서 마스터와 슬레이브 구성을 모두 지원하는 자바 라이브러리이며 모드버스 <a href="https://github.com/steveohara/j2mod/tree/master/src/test/java/com/ghgande/j2mod/modbus">테스트 예제</a>를 제공하므로 모드버스 통신을 구현하는 것은 그다지 어렵지 않을 것입니다.</p>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><p>다음은 간단하게 슬레이브에 모드버스 맵을 이미지로 정의하고 마스터에서 정의된 모드버스 맵에 대해서 읽어보는 테스트 예시입니다. </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ModbusTCP</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> TCP_UNIT_ID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Define slave memory map.</span>
        <span class="token class-name">SimpleProcessImage</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleProcessImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObservableRegister</span> register <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObservableRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        register<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        image<span class="token punctuation">.</span><span class="token function">addRegister</span><span class="token punctuation">(</span>register<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Run slave.</span>
        <span class="token class-name">ModbusSlave</span> tcpSlave <span class="token operator">=</span> <span class="token class-name">ModbusSlaveFactory</span><span class="token punctuation">.</span><span class="token function">createTCPSlave</span><span class="token punctuation">(</span><span class="token number">502</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tcpSlave<span class="token punctuation">.</span><span class="token function">addProcessImage</span><span class="token punctuation">(</span>TCP_UNIT_ID<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tcpSlave<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Run master and connect to slave</span>
        <span class="token class-name">ModbusTCPMaster</span> modbusTCPMaster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModbusTCPMaster</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">502</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        modbusTCPMaster<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>modbusTCPMaster<span class="token punctuation">.</span><span class="token function">isConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Register</span><span class="token punctuation">[</span><span class="token punctuation">]</span> registers <span class="token operator">=</span> modbusTCPMaster<span class="token punctuation">.</span><span class="token function">readMultipleRegisters</span><span class="token punctuation">(</span>TCP_UNIT_ID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"registers, &#123;&#125;"</span><span class="token punctuation">,</span> registers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            modbusTCPMaster<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// Closes all slaves</span>
        <span class="token class-name">ModbusSlaveFactory</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>현재 시스템에서는 AWS IoT 및 SQS 그리고 OpenAPI를 통하여 데이터를 수집할 수 있도록 제공하고 있습니다. 모드버스 통신 프로토콜을 통해 데이터를 수집할 수 있는 애플리케이션을 담당하고 있지는 않으나 간단하게 정리해보았습니다. </p>
</blockquote>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://modbus.org/docs/Modbus_Messaging_Implementation_Guide_V1_0b.pdf">MODBUS Messaging on TCP&#x2F;IP Implementation Guide V1.0b</a></li>
<li><a href="https://www.youtube.com/watch?v=eb8iophBMLs">모드버스 프로토콜 11부 - 모드버스 TCP(더 넓은 세상으로)</a></li>
</ul>
]]></content>
      <tags>
        <tag>Modbus</tag>
        <tag>TCP/IP</tag>
      </tags>
  </entry>
  <entry>
    <title>Mutual TLS</title>
    <url>/mutual-tls/</url>
    <content><![CDATA[<blockquote>
<p>본 글은 에너지 분야에서 수요 반응(DR) 이벤트를 송수신하기 위해서 사용하는 <a href="https://www.openadr.org/">OpenADR 프로토콜</a>에서 VTN과 VEN이 서로 상호 인증(Mutual Authentication)을 수행하는 구조를 이해하기 위해 정리한 것입니다.</p>
</blockquote>
<h2 id="Mutual-Authentication"><a href="#Mutual-Authentication" class="headerlink" title="Mutual Authentication"></a>Mutual Authentication</h2><p><em>Client certificates must be used for HTTP client authentication. The entity initiating the request(the client) must have an X.509 certificate that is validated by the server during the TLS handshake. If no client certificate is supplied, or if the certificate is not valid (e.g., it is not signed by a trusted CA, or it is expired) the server must terminate the connection during the TLS handshake.</em></p>
<p>OpenADR 프로토콜에서 VTN 시스템과 VEN 디바이스 간 통신을 위해서는 HTTP 또는 XMPP를 이용해야합니다. HTTP 클라이언트 통신을 위해서는 VTN과 VEN은 서로를 신뢰할 수 있는 X.509 공개키 인증서를 제공해야합니다. 클라이언트 요청에 서버가 신뢰할 수 있는 기관으로부터 서명된 X.509 인증서가 포함되지 않으면 서버 시스템에서는 TLS 핸드쉐이크 과정에서 연결을 해지할 수 있습니다. </p>
<h3 id="X-509-Client-Certificate"><a href="#X-509-Client-Certificate" class="headerlink" title="X.509 Client Certificate"></a>X.509 Client Certificate</h3><p>OpenADR 프로토콜에서의 보안은 공개키 기반 인프라(PKI)의 X.509 인증서로 수행하며 더 높은 보안 레벨을 요구하는 시스템을 구성하고 싶다면 XML 페이로드에 대한 서명을 지원할 수 있습니다. 2048 비트 이상의 RSA 또는 256 비트 이상의 ECC 키 기반의 공개키 인증서를 사용할 수 있습니다. 일반적으로 VEN은 임베디드 디바이스이므로 RSA 보다는 ECC 키 기반의 인증서를 사용하는 것이 더 효율적일 수 있습니다. OpenADR 프로토콜에서 TLS 핸드쉐이크 과정에서 최소한 TLS 1.2 버전과 함께 그에 상응하는 암호화 스위트를 사용해야합니다.</p>
<ul>
<li>Transport Layer Security: TLS 1.2+</li>
<li>Cipher Suites: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_RSA_WITH_AES_128_CBC_SHA256</li>
</ul>
<h4 id="cURL"><a href="#cURL" class="headerlink" title="cURL"></a>cURL</h4><p>리눅스 시스템에서 주로 사용되는 HTTP 클라이언트 통신 도구인 <a href="https://curl.se/">cURL</a>를 사용해서 EiRegisterParty 서비스 엔드포인트에 대해 요청하면 VTN 과의 상호 TLS 핸드쉐이크 과정을 정상적으로 수행할 수 있는지 검증할 수 있습니다. <a href="https://downey.io/notes/dev/curl-using-mutual-tls/">how to curl an endpoint protected by mutual tls (mtls)</a>에서는 cURL로 클라이언트 인증서를 포함하는 방법을 소개하고 있어 다음과 같이 명령어를 실행하면 됩니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">curl -v --tlsv1.2 --tls-max 1.3 --cert .&#x2F;cert.pem --key .&#x2F;privkey.pem https:&#x2F;&#x2F;Host&#x2F;OpenADR2&#x2F;Simple&#x2F;2.0b&#x2F;EiRegisterParty</code></pre>

<h4 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h4><p>웹 애플리케이션 서버 뿐만 아니라 VEN 디바이스를 구현하는 가장 일반적인 방법은 자바 언어로 구현하는 것입니다. 자바 애플리케이션에서는 KeyStore라는 별도의 키 저장소 클래스를 제공하므로 HTTP 클라이언트 요청 시 X.509 클라이언트 인증서를 포함시키기 위해서는 PKI 및 PKCS 표준에 대한 일련의 클래스들을 알아야합니다. X.509 클라이언트 인증서는 PEM 형식으로 교환되므로 KeyStore로 변환하는 과정이 필요할 수 있습니다. 다음은 <a href="https://www.bouncycastle.org/java.html">BouncyCastle API</a> 자바 라이브러리를 통해서 X.509 인증서와 개인키를 불러와서 HTTP 클라이언트 요청을 시도하는 코드를 보여줍니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">MutualTlsTest</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">MutualTlsTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"Test mutual authentication"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testMutualAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertDoesNotThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"javax.net.debug"</span><span class="token punctuation">,</span> <span class="token string">"ssl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> certPemText <span class="token operator">=</span> <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">"cert.pem"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> privateKeyText <span class="token operator">=</span> <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">"privkey.pem"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> certPem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PemReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span>certPemText<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readPemObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> privateKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PemReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span>privateKeyText<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readPemObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">KeyStore</span> clientKeyStore <span class="token operator">=</span> <span class="token class-name">KeyStore</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"jks"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            clientKeyStore<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Certificate</span><span class="token punctuation">></span></span> chain <span class="token operator">=</span> <span class="token class-name">CertificateFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"X.509"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">generateCertificates</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>certPem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> password <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">Key</span> key <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"RSA"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">generatePrivate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PKCS8EncodedKeySpec</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            clientKeyStore<span class="token punctuation">.</span><span class="token function">setKeyEntry</span><span class="token punctuation">(</span><span class="token string">"client"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> password<span class="token punctuation">,</span> chain<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Certificate</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">KeyManagerFactory</span> keyManagerFactory <span class="token operator">=</span> <span class="token class-name">KeyManagerFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"SunX509"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyManagerFactory<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>clientKeyStore<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// NOTE: If server generate client certificate from self-signed root CA, you can use trustKeyStore.</span>
            <span class="token class-name">KeyStore</span> trustKeyStore <span class="token operator">=</span> <span class="token class-name">KeyStore</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"jks"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            trustKeyStore<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">"ca.jks"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TrustManagerFactory</span> trustManagerFactory <span class="token operator">=</span> <span class="token class-name">TrustManagerFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">TrustManagerFactory</span><span class="token punctuation">.</span><span class="token function">getDefaultAlgorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            trustManagerFactory<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>trustKeyStore<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">SSLContext</span> sslcontext <span class="token operator">=</span> <span class="token class-name">SSLContexts</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadTrustMaterial</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TrustAllStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sslcontext<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>keyManagerFactory<span class="token punctuation">.</span><span class="token function">getKeyManagers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> trustManagerFactory<span class="token punctuation">.</span><span class="token function">getTrustManagers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tlsVersions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"TLSv1.2"</span><span class="token punctuation">,</span><span class="token string">"TLSv1.3"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cipherSuites <span class="token operator">=</span> <span class="token class-name">SSLContext</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultSSLParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCipherSuites</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SSLConnectionSocketFactory</span> sslSocketFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SSLConnectionSocketFactory</span><span class="token punctuation">(</span>sslcontext<span class="token punctuation">,</span> tlsVersions<span class="token punctuation">,</span> cipherSuites<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NoopHostnameVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">CloseableHttpClient</span> client <span class="token operator">=</span> <span class="token class-name">HttpClientBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSSLSocketFactory</span><span class="token punctuation">(</span>sslSocketFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">HttpPost</span> httpPost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpPost</span><span class="token punctuation">(</span><span class="token string">"https://Host/OpenADR2/Simple/2.0b/EiRegisterParty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            httpPost<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/xml; charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">"payload.xml"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
            httpPost<span class="token punctuation">.</span><span class="token function">setEntity</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringEntity</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">CloseableHttpResponse</span> httpResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>httpPost<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> response <span class="token operator">=</span> <span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>httpResponse<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"&lt;?xml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="Go"><a href="#Go" class="headerlink" title="Go"></a>Go</h4><p>개인적으로 학습중인 Go 언어에서 HTTP 클라이언트 요청과 함께 X.509 클라이언트 인증서를 포함시키는 방법을 찾아보았습니다. <a href="https://venilnoronha.io/a-step-by-step-guide-to-mtls-in-go">A step by step guide to mTLS in Go</a>에 잘 설명되어있으므로 다음과 같이 간단하게 테스트해볼 수 있습니다.</p>
<pre class="language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"crypto/tls"</span>
	<span class="token string">"crypto/x509"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"io/ioutil"</span>
	<span class="token string">"log"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"os"</span>
	<span class="token string">"strings"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	cert<span class="token punctuation">,</span> err <span class="token operator">:=</span> tls<span class="token punctuation">.</span><span class="token function">LoadX509KeyPair</span><span class="token punctuation">(</span><span class="token string">"cert.pem"</span><span class="token punctuation">,</span> <span class="token string">"privkey.pem"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	caCert<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">"ca.pem"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	caCertPool <span class="token operator">:=</span> x509<span class="token punctuation">.</span><span class="token function">NewCertPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	caCertPool<span class="token punctuation">.</span><span class="token function">AppendCertsFromPEM</span><span class="token punctuation">(</span>caCert<span class="token punctuation">)</span>

	client <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">&#123;</span>
		Transport<span class="token punctuation">:</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">&#123;</span>
			TLSClientConfig<span class="token punctuation">:</span> <span class="token operator">&amp;</span>tls<span class="token punctuation">.</span>Config<span class="token punctuation">&#123;</span>
				ClientAuth<span class="token punctuation">:</span>   tls<span class="token punctuation">.</span>RequireAndVerifyClientCert<span class="token punctuation">,</span>
				ClientCAs<span class="token punctuation">:</span>    caCertPool<span class="token punctuation">,</span>
				Certificates<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tls<span class="token punctuation">.</span>Certificate<span class="token punctuation">&#123;</span>cert<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
				MinVersion<span class="token punctuation">:</span>   tls<span class="token punctuation">.</span>VersionTLS12<span class="token punctuation">,</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>

	payloadXml<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"payload.xml"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">defer</span> payloadXml<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	payload<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>payloadXml<span class="token punctuation">)</span>
	r<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"https://Host/OpenADR2/Simple/2.0b/EiRegisterParty"</span><span class="token punctuation">,</span> <span class="token string">"application/xml"</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">defer</span> r<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	body<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="X-509-Client-Certificate-Proxy"><a href="#X-509-Client-Certificate-Proxy" class="headerlink" title="X.509 Client Certificate Proxy"></a>X.509 Client Certificate Proxy</h3><p>오늘날의 인프라 시스템은 애플리케이션 서버 정보를 감추고 클라이언트 요청에 대해 전처리 동작을 수행하고 넘겨주는 리버스 프록시를 구성하는 것이 일반적입니다. 리버스 프록시는 Nginx와 같은 웹 서버 또는 로드밸런서에서 지원하며 이러한 리버스 프록시를 수행하는 인프라 구성에서는 클라이언트 요청에 대한 TLS 핸드쉐이크 과정에서 전달된 클라이언트 인증서를 별도의 프록시 헤더에 포함시켜 넘겨주어야합니다.</p>
<h4 id="X-SSL-CERT"><a href="#X-SSL-CERT" class="headerlink" title="X-SSL-CERT"></a>X-SSL-CERT</h4><p>일반적으로 클라이언트 인증서에 대한 프록시 헤더의 표준은 없으므로 X-SSL-CERT와 같이 애플리케이션 서버에서 읽을 수 있는 헤더를 정하여 클라이언트 인증서를 포함시켜 전달하도록 구성하면 됩니다. 다음은 Nginx에서의 리버스 프록시 구성 시 X-SSL-CERT 헤더에 클라이언트 인증서를 포함시키는 예시입니다.</p>
<pre class="language-conf" data-language="conf"><code class="language-conf">server &#123;
    ssl_verify_client optional_no_ca;

    location &#x2F; &#123;
        proxy_set_header X-SSL-CERT $ssl_client_escaped_cert;
    &#125;
&#125;</code></pre>

<blockquote>
<p>일반적으로 mTLS를 수행할 때 전달되는 클라이언트 인증서도 신뢰할 수 있는 인증 기관에서 발급된 것인지를 판단합니다. 시스템 자체적으로 서명한 클라이언트 인증서는 신뢰할 수 없으므로 클라이언트 인증서의 검증은 애플리케이션 서버로 위임할 수 있습니다.</p>
</blockquote>
<h4 id="Webpack-Certificate-Proxy"><a href="#Webpack-Certificate-Proxy" class="headerlink" title="Webpack Certificate Proxy"></a>Webpack Certificate Proxy</h4><p>일반적으로 프론트엔드 개발을 위해서 사용하는 Webpack에서는 자체적으로 프록시 구성을 지원하는 <a href="https://github.com/webpack/webpack-dev-server">webpack-dev-server</a>를 제공합니다. 이는 리버스 프록시 구성과 동일하므로 모든 요청에 대해서 Webpack 프록시 서버를 경유하도록 한다면 다음과 같이 클라이언트 인증서를 포함할 수 있도록 설정해야합니다.</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">server</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'spdy'</span><span class="token punctuation">,</span> <span class="token comment">// https</span>
            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token literal-property property">cert</span><span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'cert.pem'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token literal-property property">key</span><span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'privkey.pem'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token literal-property property">requestCert</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token literal-property property">rejectUnauthorized</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token literal-property property">minVersion</span><span class="token operator">:</span> <span class="token string">'TLSv1.2'</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string-property property">'/'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'http://127.0.0.1:5000'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">secure</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token literal-property property">xfwd</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token literal-property property">changeOrigin</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token literal-property property">rejectUnauthorized</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token function">onProxyReq</span><span class="token punctuation">(</span><span class="token parameter">proxyReq<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">const</span> cert <span class="token operator">=</span> req<span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">getPeerCertificate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cert <span class="token operator">&amp;&amp;</span> cert<span class="token punctuation">.</span>raw<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">const</span> pem <span class="token operator">=</span> <span class="token string">'-----BEGIN CERTIFICATE-----'</span> <span class="token operator">+</span> cert<span class="token punctuation">.</span>raw<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'-----END CERTIFICATE-----'</span><span class="token punctuation">;</span>
                        proxyReq<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'X-SSL-CERT'</span><span class="token punctuation">,</span> pem<span class="token punctuation">)</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>requestCert 옵션을 켜야 onProxyReq 함수내에서 클라이언트 인증서를 가져와서 전달할 수 있습니다.</p>
</blockquote>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://www.cloudflare.com/ko-kr/learning/access-management/what-is-mutual-authentication/">What protocols support mutual authentication?</a></li>
<li><a href="https://www.cloudflare.com/ko-kr/learning/access-management/what-is-mutual-tls/">What is mutual TLS (mTLS)?</a></li>
<li><a href="https://downey.io/notes/dev/curl-using-mutual-tls/">how to curl an endpoint protected by mutual tls (mtls)</a></li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html#var_ssl_client_escaped_cert">Nginx SSL Client Cert</a></li>
<li><a href="https://webpack.js.org/configuration/dev-server/#devserverserver">Webpack DevServer.server</a></li>
</ul>
]]></content>
      <tags>
        <tag>X.509</tag>
        <tag>mTLS</tag>
        <tag>X-SSL-CERT</tag>
      </tags>
  </entry>
  <entry>
    <title>개발자가 알아야할 네트워크 지식</title>
    <url>/network/</url>
    <content><![CDATA[<p><img data-src="/images/posts/network/01.jpg" alt="노란건 돌돌이..."></p>
<p><a href="https://roadmap.sh/backend">roadmap.sh</a>를 참고하면 프론트엔드와 백엔드 개발자 모두 인터넷이라는 기초 지식을 필요로 하다고 말합니다. 그렇다면 위 장비들이 인터넷을 사용하기 위해서 어떠한 용도로 사용되는 장비라는 것을 아는 개발자가 얼마나 될까요? 이미 이것들을 알거나 다루지 않는 경험 많은 개발자들은 “개발자는 저것을 사용할 일이 없어요”라고 할테지요. 물론 저도 위 장비들을 경험한 것은 개발자로 일하고 있는 지금이 아니라 컴퓨터공학과라는 이유로 가설병 보직을 받고나서 사단 내 유선 전화를 고치거나 신규로 다이렉트 전화선을 추가해야하는 요건이 있을때 사용해본 경험이 있을 뿐입니다.</p>
<blockquote>
<p>심지어는 유선병이라는 이유로 늘어진 통신선을 정리하기 위해서 전봇대도 타야하는 상황도…</p>
</blockquote>
<p>아무튼 위와 같은 경험이 없었더라면 인터넷을 사용하기 위해서 사용하는 <em>RJ45 커넥터 규격</em>이란 것을 떠올리거나 UTP 케이블을 커넥터와 결합할 때 일반적으로 나열하는 <em>색상의 순서가 표준으로 정해져있다</em>는 것을 알지 못했을 겁니다. 왜냐하면 현재 개발자로 일할때에는 인터넷 선에 대한 부분을 직접 다루어본다거나 이미 구성된 서버 인프라 환경을 통해서 애플리케이션을 배포하고 운영하기 때문이죠.</p>
<p><img data-src="/images/posts/network/02.png" alt="대한민국 해저 케이블 위치"></p>
<p>인터넷으로 전세계가 연결될 수 있다는 것을 알아도 우리나라에서 다른 나라로 트래픽이 전달되기 위해서는 수 많은 <a href="https://www.submarinecablemap.com/country/south-korea">해저 광 케이블</a>이 설치되고 경유한다는 것까지는 모를 수 있습니다. 실제로 개발자 또는 엔지니어가 아닌 사업팀에게 사용자의 클릭으로 인해 어떠한 요청이 서버로 전달되고 다시 돌아오는데까지 설명하더라도 바다를 통해서 다른 나라로 건너가서 서버로 들어오게 된다라고 설명하지는 않습니다.</p>
<blockquote>
<p>개인적으로 궁금할 수는 있지만 굳이 모른다고해도 일하거나 이해하는데 지장이 없기 때문이죠.</p>
</blockquote>
<h4 id="해저-케이블-관련-정보"><a href="#해저-케이블-관련-정보" class="headerlink" title="해저 케이블 관련 정보"></a>해저 케이블 관련 정보</h4><ul>
<li><a href="https://www.yna.co.kr/view/AKR20210108069100051">해저케이블 있기에 가능한 지구촌 소통</a></li>
<li><a href="https://brunch.co.kr/@go2hanoi/14">베트남 해저 케이블은 왜 자주 끊길까?</a></li>
<li><a href="http://www.goodmorningvietnam.co.kr/mobile/article.html?no=49888">해저 케이블 루트 2개에 문제가 있는데 여전히 고칠 수 없다</a></li>
</ul>
<p>조직내에 서버 인프라 엔지니어가 있거나 인프라 팀이 존재한다면 애플리케이션으로 트래픽이 전달되도록 <a href="https://aws.amazon.com/ko/route53/what-is-dns/">DNS</a>와 <a href="https://docs.microsoft.com/ko-kr/azure/rtos/netx-duo/netx-duo-nat/chapter1">NAT</a>와 같은 설정들을 개발자가 담당하지는 않을겁니다. AWS와 같은 클라우드 서비스에서는 개발자가 직접 웹 콘솔을 통해서 클릭만으로도 서버 인프라 구성에 대한 설정을 쉽게 할 수 있도록 제공하긴 합니다. 그래서 클라우드 인프라 환경을 직접 다루는 저와 같은 개발자들은 요구사항에 따라서 인프라 구성을 검토하거나 설정을 변경해야하는 작업도 해야할 수 있기에 어느정도의 인프라 지식도 필요하게 되죠.</p>
<blockquote>
<p>알아야하는 인프라 지식은 현재 조직에서 어떤 것을 경험하느냐에 따라 달라집니다.</p>
</blockquote>
<p>일반적으로는 HTTP라는 통신 프로토콜을 사용하지만 사업 분야에 따라서 <a href="https://mqtt.org/">MQTT 통신 프로토콜</a>를 통해 데이터가 전달된다거나 <a href="https://ko.wikipedia.org/w/index.php?title=%EB%AA%A8%EB%93%9C%EB%B2%84%EC%8A%A4&tableofcontents=0">Modbus TCP</a>를 통해 산업 자동화 장비와의 통신으로 데이터를 수집하고 심지어는 차량에서는 <a href="https://ko.wikipedia.org/wiki/CAN_%EB%B2%84%EC%8A%A4">CAN 통신</a>을 사용하고 OBD 모듈을 통해서 데이터를 전달받기도 하죠. 통신 프로토콜 뿐만 아니라 이더넷으로 인터넷에 접속하지 않고 프라이빗 네트워크 환경으로 연결하며 무선 통신을 통해서 인터넷으로 접속하는 인프라 환경을 경험해보지 않았다면 아마도 네트워크 우선 순위가 있다는 지식을 알지 못하고 있을 수 있씁니다.</p>
<blockquote>
<p>셀룰러 모듈이 포함된 클라이언트 장비를 전달하고나서 유선 연결을 시도한 순간 인터넷 연결이 끊어져서 원격이 해제되었던 것을 실제로 경험하기도 했죠.</p>
</blockquote>
<p>대부분의 개발자가 웹 서버 또는 애플리케이션에 SSL 인증서를 설치해서 HTTPS 통신을 할 수 있도록 구성할 수 있지만 AWS 클라우드 환경을 사용하지 않거나 ELB 중 NLB를 통해서 ECC 기반의 SSL 인증서를 설정하여 TLS 오프로드 기능을 설정하려고 시도하지 않았다면 <a href="https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/network/create-tls-listener.html#tls-listener-certificates">2048 이상의 RSA 키 또는 EC 키가 포함된 인증서를 지원하지 않음</a>에 대한 것을 알지 못할 수 있습니다. </p>
<p>결국은 개발자라는 직무에서 알아야할 네트워크 지식은 정해져있지 않으며 현재 내가 조직에서 어떠한 요구사항을 처리하는가 또는 어떤 것까지 담당하고 경험하는가에 따라 그 깊이와 범위가 달라질 수 있다는 점을 인지해야할 것 같습니다. </p>
]]></content>
      <tags>
        <tag>개발자</tag>
        <tag>네트워크</tag>
      </tags>
  </entry>
  <entry>
    <title>특정 디펜던시에 대한 Dart Sass의 Deprecation 경고 제외하기</title>
    <url>/no-emit-deprecation-warnings-of-dart-sass/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>오늘은 특정 디펜던시에 대한 Dart Sass의 Deprecation 경고를 제외하는 방법에 대해서 공유하려고 합니다.</p>
<h2 id="Deprecation-Warnings"><a href="#Deprecation-Warnings" class="headerlink" title="Deprecation Warnings"></a>Deprecation Warnings</h2><p>최신 웹팩에서 사용하는 sass-loader에서는 sass(Dart Sass)를 사용하는 것을 권장합니다. 다만, Dart Sass 버전에 따라 다음과 같이 Dart Sass 2.0에서부터 지원되지 않는 문법에 대한 경고 로그가 출력될 수 있습니다.</p>
<p><em>Deprecation Using &#x2F; for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0</em></p>
<h3 id="Bootstrap"><a href="#Bootstrap" class="headerlink" title="Bootstrap"></a>Bootstrap</h3><p>부트스트랩의 변수를 오버라이딩하여 테마를 구성하고자 하는 경우 여러분의 SCSS 파일에서 부트스트랩에서 제공하는 SCSS 파일을 불러오게되면 아래처럼 경고 로그가 출력될 수 있습니다.</p>
<pre class="language-ps" data-language="ps"><code class="language-ps">LOG from .&#x2F;node_modules&#x2F;sass-loader&#x2F;dist&#x2F;cjs.js sass-loader .&#x2F;node_modules&#x2F;css-loader&#x2F;dist&#x2F;cjs.js??clonedRuleSet-2[0].rules[0].use[1]!.&#x2F;node_modules&#x2F;postcss-loader&#x2F;dist&#x2F;cjs.js!.&#x2F;node_modules&#x2F;resolve-url-loader&#x2F;index.js!.&#x2F;node_modules&#x2F;sass-loader&#x2F;dist&#x2F;cjs.js??clonedRuleSet-2[0].rules[0].use[4]!.&#x2F;src&#x2F;scss&#x2F;bootstrap.scss
&lt;w&gt; Deprecation Using &#x2F; for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0.
&lt;w&gt;
&lt;w&gt; Recommendation: math.div($b-custom-control-indicator-size-lg, 2) or calc($b-custom-control-indicator-size-lg &#x2F; 2)
&lt;w&gt;
&lt;w&gt; More info and automated migrator: https:&#x2F;&#x2F;sass-lang.com&#x2F;d&#x2F;slash-div
&lt;w&gt;
&lt;w&gt; node_modules\bootstrap-vue\src\_variables.scss 33:46  @import
&lt;w&gt; node_modules\bootstrap-vue\src\index.scss 7:9         @import
&lt;w&gt; src\scss\bootstrap.scss 11:9                          root stylesheet
&lt;w&gt;
&lt;w&gt; Deprecation Using &#x2F; for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0.
&lt;w&gt;
&lt;w&gt; Recommendation: math.div($b-custom-control-indicator-size-sm, 2) or calc($b-custom-control-indicator-size-sm &#x2F; 2)
&lt;w&gt;
&lt;w&gt; More info and automated migrator: https:&#x2F;&#x2F;sass-lang.com&#x2F;d&#x2F;slash-div
&lt;w&gt;
&lt;w&gt; node_modules\bootstrap-vue\src\_variables.scss 34:46  @import
&lt;w&gt; node_modules\bootstrap-vue\src\index.scss 7:9         @import
&lt;w&gt; src\scss\bootstrap.scss 11:9                          root stylesheet
&lt;w&gt;
&lt;w&gt; Deprecation Using &#x2F; for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0.
&lt;w&gt;
&lt;w&gt; Recommendation: math.div($font-size-lg * $line-height-lg - $b-custom-control-indicator-size-lg, 2) or calc(($font-size-lg * $line-height-lg - $b-custom-control-indicator-size-lg) &#x2F; 2)
&lt;w&gt;
&lt;w&gt; More info and automated migrator: https:&#x2F;&#x2F;sass-lang.com&#x2F;d&#x2F;slash-div
&lt;w&gt;
&lt;w&gt; node_modules\bootstrap-vue\src\components\form-checkbox\_form-checkbox.scss 10:10  @import
&lt;w&gt; node_modules\bootstrap-vue\src\components\form-checkbox\index.scss 1:9             @import
&lt;w&gt; node_modules\bootstrap-vue\src\components\index.scss 5:9                           @import
&lt;w&gt; node_modules\bootstrap-vue\src\index.scss 14:9                                     @import
&lt;w&gt; src\scss\bootstrap.scss 11:9                                                       root stylesheet
&lt;w&gt;
&lt;w&gt; Deprecation Using &#x2F; for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0.
&lt;w&gt;
&lt;w&gt; Recommendation: math.div($font-size-lg * $line-height-lg - $b-custom-control-indicator-size-lg, 2) or calc(($font-size-lg * $line-height-lg - $b-custom-control-indicator-size-lg) &#x2F; 2)
&lt;w&gt;
&lt;w&gt; More info and automated migrator: https:&#x2F;&#x2F;sass-lang.com&#x2F;d&#x2F;slash-div
&lt;w&gt;
&lt;w&gt; node_modules\bootstrap-vue\src\components\form-checkbox\_form-checkbox.scss 18:10  @import
&lt;w&gt; node_modules\bootstrap-vue\src\components\form-checkbox\index.scss 1:9             @import
&lt;w&gt; node_modules\bootstrap-vue\src\components\index.scss 5:9                           @import
&lt;w&gt; node_modules\bootstrap-vue\src\index.scss 14:9                                     @import
&lt;w&gt; src\scss\bootstrap.scss 11:9                                                       root stylesheet
&lt;w&gt;
&lt;w&gt; Deprecation Using &#x2F; for division outside of calc() is deprecated and will be removed in Dart Sass 2.0.0.
&lt;w&gt;
&lt;w&gt; Recommendation: math.div($font-size-sm * $line-height-sm - $b-custom-control-indicator-size-sm, 2) or calc(($font-size-sm * $line-height-sm - $b-custom-control-indicator-size-sm) &#x2F; 2)
&lt;w&gt;
&lt;w&gt; More info and automated migrator: https:&#x2F;&#x2F;sass-lang.com&#x2F;d&#x2F;slash-div
&lt;w&gt;
&lt;w&gt; node_modules\bootstrap-vue\src\components\form-checkbox\_form-checkbox.scss 33:10  @import
&lt;w&gt; node_modules\bootstrap-vue\src\components\form-checkbox\index.scss 1:9             @import
&lt;w&gt; node_modules\bootstrap-vue\src\components\index.scss 5:9                           @import
&lt;w&gt; node_modules\bootstrap-vue\src\index.scss 14:9                                     @import
&lt;w&gt; src\scss\bootstrap.scss 11:9                                                       root stylesheet
&lt;w&gt;
&lt;w&gt; 17 repetitive deprecation warnings omitted.
&lt;w&gt;
&lt;w&gt; null</code></pre>

<p>부트스트랩에서 사용중인 문법을 어떻게 바꾸라고 안내하지만 의존성에서 제공하는 파일을 수정할 수는 없습니다. 그래서 위 경고 로그를 출력하지 않게 하는 방법이 필요합니다.</p>
<h3 id="Dart-Sass-quietDeps"><a href="#Dart-Sass-quietDeps" class="headerlink" title="Dart Sass - quietDeps"></a>Dart Sass - quietDeps</h3><p>다행스럽게도 Dart Sass 에서는 <a href="https://sass-lang.com/documentation/cli/dart-sass#quiet-deps">quietDeps</a>옵션을 제공하여 의존성에 대한 Deprecation 경고 출력을 하지 않도록 지원합니다.<br>만약, 웹팩에서 sass-loader를 사용한다면 다음과 같이 <strong>sassOptions</strong> 속성으로 위 옵션을 적용할 수 있습니다.</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.s[ac]ss$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token comment">// ...</span>
          <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">"sass-loader"</span><span class="token punctuation">,</span>
            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              <span class="token literal-property property">sourceMap</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token literal-property property">sassOptions</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token literal-property property">quietDeps</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"node_modules/bootstrap/**/*.scss"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>이제 부트스트랩의 SCSS 파일을 임포트하더라도 더이상 경고 로그는 출력되지 않게 되었습니다.<br>감사합니다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://sass-lang.com/documentation/cli/dart-sass#quiet-deps">Dart Sass - quiet-deps</a></li>
</ul>
]]></content>
      <tags>
        <tag>Dart Sass</tag>
        <tag>quietDeps</tag>
      </tags>
  </entry>
  <entry>
    <title>최적화된 도커 이미지</title>
    <url>/optimize-dockerfile/</url>
    <content><![CDATA[<p>회사에서는 애플리케이션을 <a href="/deploy-application-to-the-aws-elastic-beanstalk-java-se-platform-enviroment/">아마존 웹 서비스의 Elastic Beanstalk Java SE 플랫폼 환경을 활용해서 배포</a>하고 있어서 도커 이미지를 만들어볼 기회가 없는데 그럼에도 도커 이미지를 직접 만들어보면 생각보다 이미지의 크기나 빌드 시간이 오래걸려서 당황하게 된다.</p>
<ul>
<li><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">Best practices for writing Dockerfiles</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-optimize-docker-images-for-production">How To Optimize Docker Images for Production</a></li>
<li><a href="https://medium.com/the-agile-crafter/docker-image-optimization-from-1-16gb-to-22-4mb-53fdb4c53311">Docker Image Optimization: from 1.16GB to 22.4MB</a></li>
<li><a href="https://jonnung.dev/docker/2020/04/08/optimizing-docker-images/">도커 이미지 잘 만드는 방법</a></li>
<li><a href="https://docs.docker.com/language/">Language-specific getting started guides</a></li>
<li><a href="https://github.com/GoogleCloudPlatform/golang-samples/blob/main/run/helloworld/Dockerfile">GoogleCloudPlatform&#x2F;golang-samples</a></li>
</ul>
<p>많은 글에서 다루는 도커 빌드 이미지를 최적화하는 방향에 대해서 정리해보자면 다음과 같다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">첫째, 애플리케이션 언어에 적합한 경량의 베이스 이미지를 사용하라.
둘째, 애플리케이션 실행 및 운용에 필요한 필수 패키지만 설치하라.
셋째, COPY 그리고 RUN 등의 레이어를 만드는 명령어를 최소화하라.
넷째, 멀티 스테이지로 빌드와 런타임 환경의 이미지를 분리하라.</code></pre>

<h4 id="오픈소스-솔루션으로-확인하는-Dockerfile-예시"><a href="#오픈소스-솔루션으로-확인하는-Dockerfile-예시" class="headerlink" title="오픈소스 솔루션으로 확인하는 Dockerfile 예시"></a>오픈소스 솔루션으로 확인하는 Dockerfile 예시</h4><ul>
<li><a href="https://github.com/prometheus/prometheus/blob/main/Dockerfile">promethues&#x2F;Dockerfile</a></li>
<li><a href="https://github.com/grafana/grafana/blob/main/Dockerfile">grafana&#x2F;Dockerfile</a></li>
<li><a href="https://github.com/louislam/uptime-kuma/tree/master/docker">uptime-kuma&#x2F;docker</a></li>
</ul>
]]></content>
      <tags>
        <tag>도커 이미지</tag>
        <tag>최적화</tag>
      </tags>
  </entry>
  <entry>
    <title>프리마커 템플릿으로 이메일 발송하기</title>
    <url>/sending-mail-with-freemarker-template/</url>
    <content><![CDATA[<blockquote>
<p>현재 조직에서는 스프링 부트의 기본 템플릿 엔진인 타임리프를 사용하지 않고 이메일 발송에는 프리마커 템플릿 엔진을 사용해서 변환한 HTML 형식의 이메일을 전달합니다. </p>
</blockquote>
<h2 id="프리마커-템플릿-엔진"><a href="#프리마커-템플릿-엔진" class="headerlink" title="프리마커 템플릿 엔진"></a>프리마커 템플릿 엔진</h2><p>일반적으로 많이 사용되는 템플릿 엔진은 <a href="https://www.thymeleaf.org/">타임리프</a>이기는 하지만 사용하기 어려운 문법과 다른 템플릿 엔진과의 렌더링 성능 문제로 인하여 이메일 발송처럼 대량으로 렌더링할 가능성이 있다면  <a href="https://freemarker.apache.org/">FreeMarker</a> 또는 <a href="https://mustache.github.io/">Mustache</a> 템플릿 엔진을 사용하는 것이 좋습니다. </p>
<h3 id="프리마커-스타터"><a href="#프리마커-스타터" class="headerlink" title="프리마커 스타터"></a>프리마커 스타터</h3><p>스프링 부트 프리마커 스타터 의존성을 통해 프리마커 템플릿으로 이메일을 발송하기 위한 라이브러리들을 참조합니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-freemarker'</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-mail'</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="SMTP-메일-서버"><a href="#SMTP-메일-서버" class="headerlink" title="SMTP 메일 서버"></a>SMTP 메일 서버</h3><p>이메일을 발송하기 위해서는 SMTP 프로토콜을 사용하는 메일 서버가 필요합니다. 많은 무료 메일 서버 솔루션이 있으나 일반적으로 많이 사용하는 구글이나 네이버 이메일 계정의 몇가지 설정을 통해서 SMTP 메일 서버를 이용할 수 있습니다. </p>
<h4 id="Gmail-SMTP"><a href="#Gmail-SMTP" class="headerlink" title="Gmail SMTP"></a>Gmail SMTP</h4><p>지메일 계정으로 발신 메일 서버를 이용하기 위해서는 다음과 같이 인증 옵션과 함께 SSL(465) 또는 TLS(587)용 포트를 사용해야합니다.</p>
<pre class="language-.properties" data-language=".properties"><code class="language-.properties">spring.mail.protocol&#x3D;smtp
spring.mail.host&#x3D;smtp.gmail.com
spring.mail.port&#x3D;587
spring.mail.username&#x3D;username@gmail.com
spring.mail.password&#x3D;password
spring.mail.properties.smtp.auth&#x3D;true
spring.mail.properties.mail.smtp.starttls.enable&#x3D;true
spring.mail.properties.mail.smtp.starttls.required&#x3D;true
spring.mail.test-connection&#x3D;true</code></pre>

<h5 id="지메일-계정-인증-오류"><a href="#지메일-계정-인증-오류" class="headerlink" title="지메일 계정 인증 오류"></a>지메일 계정 인증 오류</h5><p>메일 서버 연결 시 다음과 같이 인증 오류가 발생하는 경우 <a href="https://myaccount.google.com/u/0/lesssecureapps">보안 수준이 낮은 앱의 액세스</a>를 허용해야합니다. </p>
<pre class="language-sh" data-language="sh"><code class="language-sh">Caused by: java.lang.IllegalStateException: Mail server is not available
...
Caused by: javax.mail.AuthenticationFailedException: 535-5.7.8 Username and Password not accepted. Learn more at</code></pre>

<blockquote>
<p>보안 정책 변경에 따라 <a href="https://support.google.com/accounts/answer/6010255">2022년 5월 30일</a>부터는 지메일 계정으로 SMTP 서버를 이용할 수 없을 수 있습니다. </p>
</blockquote>
<h3 id="자바-이메일-발송"><a href="#자바-이메일-발송" class="headerlink" title="자바 이메일 발송"></a>자바 이메일 발송</h3><p>지메일 계정으로 SMTP 서버에 인증까지 완료했다면 실제로 이메일을 발송할 수 있는지 테스트 해보아야 합니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">GmailSmtpTests</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JavaMailSenderImpl</span> javaMailSender<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MimeMessage</span> mimeMessage <span class="token operator">=</span> javaMailSender<span class="token punctuation">.</span><span class="token function">createMimeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MimeMessageHelper</span> mimeMessageHelper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MimeMessageHelper</span><span class="token punctuation">(</span>mimeMessage<span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mimeMessageHelper<span class="token punctuation">.</span><span class="token function">setFrom</span><span class="token punctuation">(</span><span class="token string">"Mambo &lt;kdevkr.gmail.com>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mimeMessageHelper<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span><span class="token string">"kdevkr@gmail.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mimeMessageHelper<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span><span class="token string">"Java Mail Test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mimeMessageHelper<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"&lt;h5>Hello World&lt;/h5>"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        javaMailSender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>mimeMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="프리마커-템플릿-적용하기"><a href="#프리마커-템플릿-적용하기" class="headerlink" title="프리마커 템플릿 적용하기"></a>프리마커 템플릿 적용하기</h4><p>프리마커 템플릿 파일을 작성하고 템플릿 엔진을 사용해서 HTML 형식의 문자열을 이메일 내용으로 전달하여 발송하도록 구현하면 됩니다. 저는 <a href="https://heropy.blog/2018/12/30/html-email-template/">HTML Email Template 만들기</a>라는 글을 참고하여 템플릿을 작성하였습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">GmailSmtpTests</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JavaMailSenderImpl</span> javaMailSender<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">FreeMarkerConfigurationFactoryBean</span> configurationFactoryBean<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> configurationFactoryBean<span class="token punctuation">.</span><span class="token function">createConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Template</span> template <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token string">"email.ftlh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token string">"Java Mail Test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span> <span class="token string">"Hello World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token class-name">FreeMarkerTemplateUtils</span><span class="token punctuation">.</span><span class="token function">processTemplateIntoString</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">MimeMessage</span> mimeMessage <span class="token operator">=</span> javaMailSender<span class="token punctuation">.</span><span class="token function">createMimeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MimeMessageHelper</span> mimeMessageHelper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MimeMessageHelper</span><span class="token punctuation">(</span>mimeMessage<span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mimeMessageHelper<span class="token punctuation">.</span><span class="token function">setFrom</span><span class="token punctuation">(</span><span class="token string">"Mambo &lt;kdevkr.gmail.com>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mimeMessageHelper<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span><span class="token string">"kdevkr@gmail.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mimeMessageHelper<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span><span class="token string">"Java Mail Test with FreeMarker"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mimeMessageHelper<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        javaMailSender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>mimeMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>기본 프리마커 템플릿 폴더는 클래스패스의 <strong>templates</strong> 입니다.<br>spring.freemarker.template-loader-path&#x3D;classpath:&#x2F;templates&#x2F;</p>
</blockquote>
<p><img data-src="/images/posts/sending-mail-with-freemarker-template/example.png"></p>
<p>감사합니다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.servlet.spring-mvc.template-engines">Spring Boot Docs - Template Engines</a></li>
<li><a href="https://springhow.com/spring-boot-email-freemarker/">SpringHow - Send HTML emails with FreeMarker Templates</a></li>
<li><a href="https://www.baeldung.com/freemarker-in-spring-mvc-tutorial">Introduction to Using FreeMarker in Spring MVC</a></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>SHA-256</title>
    <url>/sha-256/</url>
    <content><![CDATA[<h2 id="SHA"><a href="#SHA" class="headerlink" title="SHA"></a>SHA</h2><p><a href="https://ko.wikipedia.org/wiki/SHA">SHA(Secure Hash Algorithm)</a>은 NIST에 의해서 관리되는 안전한 해시 표준 함수들의 모음이며 현재는 NIST FIPS 180-3 규격의 <a href="https://ko.wikipedia.org/wiki/SHA-2">SHA-2</a>를 권장해서 사용하고 있습니다. 해시 함수는 어떠한 문자열을 일정한 길이를 가진 임의의 문자열로 변환하는 것을 말합니다. 수 많은 연구에 의해 만들어진 여러가지 해시 함수 중에서 일반적으로 SHA-256을 사용하는 이유는 해시 함수를 사용하게 되는 목적에 있다고 볼 수 있습니다. 특정한 문자열에 대해서는 동일한 해시값(다이제스트)으로 변환되며 해시값을 기준으로는 동일한 패턴을 찾을 수 없어서 본래의 문자열을 유추할 수 없도록 하고자 하는 것에 있습니다.</p>
<p>SHA-256 해시 함수의 동작 과정은 <a href="https://sha256algorithm.com/">Sha256 Algorithm Explained</a>를 이용하면 눈으로 확인할 수 있으니 참고해보면 좋을 것 같습니다.</p>
<h3 id="메시지-다이제스트"><a href="#메시지-다이제스트" class="headerlink" title="메시지 다이제스트"></a>메시지 다이제스트</h3><p>해시 함수는 어떠한 입력에 대해서 일정한 길이의 비트로 이루어진 결과를 가져오기 위한 목적으로 사용됩니다. 메시지 다이제스트란 어떤 문자열 데이터를 일정한 길이의 다이제스트로 변환한 것을 말하며 단순하게 해시 함수로 처리된 해시값일 뿐입니다.</p>
<pre class="language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"crypto/sha256"</span>
	<span class="token string">"encoding/hex"</span>
	<span class="token string">"fmt"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	plain <span class="token operator">:=</span> <span class="token string">"HelloWorld"</span>
	hash <span class="token operator">:=</span> sha256<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	hash<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>plain<span class="token punctuation">)</span><span class="token punctuation">)</span>
	hashed <span class="token operator">:=</span> hash<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"plain:"</span><span class="token punctuation">,</span> plain<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hashed:"</span><span class="token punctuation">,</span> hex<span class="token punctuation">.</span><span class="token function">EncodeToString</span><span class="token punctuation">(</span>hashed<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">plain: HelloWorld
hashed: 872e4e50ce9990d8b041330c47c9ddd11bec6b503ae9386a99da8584e9bb12c4</code></pre>

<h3 id="파일-체크섬"><a href="#파일-체크섬" class="headerlink" title="파일 체크섬"></a>파일 체크섬</h3><p>위 메시지 다이제스트를 바이너리 파일에 활용한 부분이 파일 체크섬입니다. <a href="https://ubuntu.com/tutorials/how-to-verify-ubuntu#5-verify-the-sha256-checksum">how-to-verify-ubuntu</a>에서 처럼 다운로드 받은 파일의 위변조 여부를 검증하기 위해서 MD5 또는 SHA-256로 해시된 다이제스트를 제공하며 이를 통해 올바른 바이너리 파일임을 검증하고 안전하다고 판단할 수 있습니다. 아래의 예시는 윈도우 터미널에서 <a href="https://docs.microsoft.com/ko-kr/windows-server/administration/windows-commands/certutil">CertUtil</a>을 사용하여 파일 체크섬을 확인한 것이며 <a href="https://gtkhash.org/">GtkHash</a>와 같은 도구로도 확인할 수 있습니다.</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> C:\> certutil <span class="token operator">-</span>hashfile orig<span class="token punctuation">.</span>txt sha256
SHA256의 orig<span class="token punctuation">.</span>txt 해시:
872e4e50ce9990d8b041330c47c9ddd11bec6b503ae9386a99da8584e9bb12c4
CertUtil: <span class="token operator">-</span>hashfile 명령이 성공적으로 완료되었습니다<span class="token punctuation">.</span></code></pre>

<h3 id="비밀번호-암호화"><a href="#비밀번호-암호화" class="headerlink" title="비밀번호 암호화"></a>비밀번호 암호화</h3><p>일반적으로 비밀번호를 암호화하여 저장할 때는 <a href="https://d2.naver.com/helloworld/318732">안전한 패스워드 저장</a>에서 언급된 PBKDF2 또는 bcrypt를 사용하는 편인 것으로 알고 있습니다. bcrypt는 NIST 에서 권장하는 알고리즘에 속하지는 않았으나 OpenBSD나 스프링 프레임워크의 기본 패스워드 인코더로 지정된 비교적 안전한 알고리즘 중 하나입니다. 아무튼 시계열 데이터베이스 중 하나인 <a href="https://code.kx.com/q/basics/cmdline/#-u-usr-pwd-local">KDB+는 MD5 또는 SHA-1 알고리즘 방식으로 비밀번호를 지원</a>하기에 사용하는 시스템마다 지원하는 방식에 제한이 있을 수 있습니다.</p>
<h4 id="비밀번호-암호화-관련-읽으면-좋은-글"><a href="#비밀번호-암호화-관련-읽으면-좋은-글" class="headerlink" title="비밀번호 암호화 관련 읽으면 좋은 글"></a>비밀번호 암호화 관련 읽으면 좋은 글</h4><ul>
<li><a href="https://d2.naver.com/helloworld/318732">안전한 패스워드 저장</a></li>
<li><a href="https://lovejaco.github.io/posts/cryptographic-hash-function/">해시 함수, 암호화 해시 함수, 그리고 SHA</a></li>
<li><a href="https://auth0.com/blog/hashing-in-action-understanding-bcrypt/">Hashing in Action: Understanding bcrypt</a></li>
</ul>
<h3 id="키-서명-지문"><a href="#키-서명-지문" class="headerlink" title="키 서명 지문"></a>키 서명 지문</h3><p><a href="/ssh">SSH 키 페어 발급 및 원격 호스트 연결하기</a>에서처럼 SSH 키에 대해 지문(Fingerprint)을 생성해놓고 호스트에 대한 공개키가 변경되었는지를 판단하는데 사용되기도 합니다. 이러한 키 서명 지문은 아래의 이미지와 같이 SSL 인증서 정보에도 서명 해시 알고리즘으로도 사용하는 것을 확인할 수 있습니다.</p>
<p><img data-src="/images/posts/sha-256/01.png"></p>
]]></content>
      <tags>
        <tag>Hashing</tag>
        <tag>Message Disgest</tag>
        <tag>Checksum</tag>
      </tags>
  </entry>
  <entry>
    <title>스프링 부트 액세스 로그를 엘라스틱서치에 기록하기</title>
    <url>/spring-boot-accesslog-with-elasticsearch/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>애플리케이션 서버로 요청되는 정보를 기록하는 <a href="https://d2.naver.com/helloworld/3585246">액세스 로그</a>는 애플리케이션 운영과 장애 대응에 있어서 상당히 중요한 정보입니다. 아마존 웹 서비스에서도 <a href="https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/enable-server-access-logging.html">Amazon S3 서버 액세스 로깅 활성화</a>처럼 액세스 로그를 기록할 수 있는 기능을 제공하죠. 스프링 부트는 <strong>톰캣(Tomcat)</strong> 이나 <strong>언더토우(Undertow)</strong> 와 같은 WAS에 대하여 액세스 로그를 파일로 저장할 수 있는 기능을 기본적으로 포함하고 있습니다.</p>
<p>만약, 언더토우를 사용하고 있다면 다음과 같이 액세스 로그를 활성화하고 패턴을 지정할 수 있습니다.</p>
<pre class="language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">server.undertow.accesslog.enabled</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token key attr-name">server.undertow.accesslog.pattern</span><span class="token punctuation">=</span><span class="token value attr-value">common</span></code></pre>

<h2 id="스프링-부트-로깅"><a href="#스프링-부트-로깅" class="headerlink" title="스프링 부트 로깅"></a>스프링 부트 로깅</h2><p>스프링 부트는 기본적으로 Slf4j 기반의 <a href="https://logback.qos.ch/">로그백(Logback)</a>을 로깅 프레임워크로 사용합니다. 그래서 애플리케이션의 로그를 엘라스틱서치에 기록하기 위해서는 <a href="https://github.com/logfellow/logstash-logback-encoder">Logstash Logback Encoder</a>와 같이 로그백으로 기록되는 로그를 엘라스틱서치로 전달할 수 있게 구현해야합니다.</p>
<h3 id="Logback-Elasticsearch-Appender"><a href="#Logback-Elasticsearch-Appender" class="headerlink" title="Logback Elasticsearch Appender"></a>Logback Elasticsearch Appender</h3><p><a href="https://github.com/internetitem/logback-elasticsearch-appender">Logback Elasticsearch Appender</a>는 ELK 스택이 아니더라도 로그백으로 기록되는 로그를 엘라스틱서치로 전달하는 기능을 제공합니다. 오늘은 이것을 활용하여 스프링 부트 애플리케이션에서 발생하는 액세스 로그를 엘라스틱서치에 기록해보고자 합니다. </p>
<p><img data-src="/images/posts/spring-boot-accesslog-with-elasticsearch/logback-elasticsearch-appender-01.png"></p>
<p>그리고 위 처럼 <a href="https://logback.qos.ch/access.html">Logback Access</a>에 대한 Appender를 포함하고 있으므로 액세스 로그를 쉽게 엘라스틱서치로 전달할 수 있게 됩니다.</p>
<h3 id="Logback-Access-Spring-Boot-Starter"><a href="#Logback-Access-Spring-Boot-Starter" class="headerlink" title="Logback Access Spring Boot Starter"></a>Logback Access Spring Boot Starter</h3><p><a href="https://github.com/akkinoc/logback-access-spring-boot-starter">logback-access-spring-boot-starter</a>는 로그백 엑세스 설정에 대한 스프링 부트 스타터입니다. 언더토우까지 지원하므로 언더토우에 대해 로그백 엑세스 설정을 위한 <a href="https://gist.github.com/cdmatta/2a4536ab687bf7a92482faf031e8a0b5">커스터마이저</a>를 직접 구현하지 않아도 됩니다.</p>
<h3 id="따라하기"><a href="#따라하기" class="headerlink" title="따라하기"></a>따라하기</h3><p>스프링 부트 프로젝트를 만들고 저는 언더토우를 선호하므로 톰캣 모듈을 제외하고 언더토우 스타터를 추가했습니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">configurations<span class="token punctuation">.</span>all <span class="token punctuation">&#123;</span>
    exclude module<span class="token punctuation">:</span> <span class="token string">'spring-boot-starter-tomcat'</span>
<span class="token punctuation">&#125;</span>

dependencies <span class="token punctuation">&#123;</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-web'</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-undertow'</span>
    implementation <span class="token string">'com.internetitem:logback-elasticsearch-appender:1.6'</span>
    implementation <span class="token string">'dev.akkinoc.spring.boot:logback-access-spring-boot-starter:3.2.1'</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>로그백 엑세스 스타터는 언더토우 뿐만 아니라 톰캣도 지원하므로 설정에 대한 차이는 없습니다.</p>
</blockquote>
<p>그리고 다음과 같이 로그백 엑세스를 위한 설정 파일을 클래스패스에 추가합니다. 설정 파일을 불러오는 <a href="https://github.com/akkinoc/logback-access-spring-boot-starter#priority-order">우선순위</a>에 따라 설정 파일명은 logback-access-spring.xml 이라고 생성하겠습니다.</p>
<p><strong>logback-access-spring.xml</strong></p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>springProperty</span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>context<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>elasticsearch_uris<span class="token punctuation">"</span></span> <span class="token attr-name">source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring.elasticsearch.uris<span class="token punctuation">"</span></span> <span class="token attr-name">defaultValue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://localhost:9200<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ELASTIC<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.internetitem.logback.elasticsearch.ElasticsearchAccessAppender<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">></span></span>$&#123;elasticsearch_uris&#125;/_bulk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>index</span><span class="token punctuation">></span></span>application-accesslog-%date&#123;yyyy-MM-dd&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>index</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>headers</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>Content-Type<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>application/json<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>headers</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ELASTIC<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span></code></pre>

<p>스프링 부트 애플리케이션을 실행하고 브라우저 또는 클라이언트 도구를 통해 액세스 기록을 남겨보고 엘라스틱서치에 잘 저장되는지 확인해봅니다.</p>
<p><img data-src="/images/posts/spring-boot-accesslog-with-elasticsearch/elasticsearch-devtools-01.png"></p>
<p>인덱스는 생성되었지만 액세스 로그에 대한 정보가 없습니다. 액세스 로그 정보를 기록하기 위해서는 <a href="https://logback.qos.ch/manual/layouts.html#logback-access">Logback Access conversion words</a>를 참고해서 프로퍼티를 설정해야합니다. 앞서 생성한 로그백 엑세스 설정 파일에 다음과 같이 프로퍼티 항목을 추가로 정의하겠습니다.</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>springProperty</span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>context<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>elasticsearch_uris<span class="token punctuation">"</span></span> <span class="token attr-name">source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>spring.elasticsearch.uris<span class="token punctuation">"</span></span> <span class="token attr-name">defaultValue</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://localhost:9200<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ELASTIC<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.internetitem.logback.elasticsearch.ElasticsearchAccessAppender<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">></span></span>$&#123;elasticsearch_uris&#125;/_bulk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>index</span><span class="token punctuation">></span></span>application-accesslog-%date&#123;yyyy-MM-dd&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>index</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>contentLength<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%b<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>remoteHost<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%h<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>protocol<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%H<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>referer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%i&#123;Referer&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>userAgent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%i&#123;User-Agent&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>requestMethod<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%m<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>statusCode<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%s<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>elapsedTime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%D<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>date<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%t&#123;yyyy-MM-dd'T'HH:mm:ss&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>user<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%u<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>queryString<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%q<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>requestURI<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>%U<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>headers</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>Content-Type<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">></span></span>application/json<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>headers</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ELASTIC<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span></code></pre>

<blockquote>
<p>미리 정의된 패턴인 combined를 참고하여 리퍼러와 유저 에이전트 헤더를 포함하도록 프로퍼티를 설정했습니다.</p>
</blockquote>
<p><img data-src="/images/posts/spring-boot-accesslog-with-elasticsearch/elasticsearch-devtools-02.png"></p>
<p>위 처럼 프로퍼티를 설정하였으므로 요청된 액세스에 대한 로그를 통해 유저 에이전트가 포스트맨이며 요청된 경로는 액추에이터인 것을 확인할 수 있게 되었습니다. 따라하시는 여러분은 다양한 항목에 대해서도 기록해보시면 좋을 것 같습니다.</p>
<h4 id="액세스-로그-인덱스-템플릿"><a href="#액세스-로그-인덱스-템플릿" class="headerlink" title="액세스 로그 인덱스 템플릿"></a>액세스 로그 인덱스 템플릿</h4><p>생성된 액세스 로그에 대한 인덱스 매핑 정보를 조회하면 동적 매핑에 의해서 엘라스틱서치가 필드 유형을 임의대로 지정한 것을 확인할 수 있습니다. 동적 매핑은 저장되는 도큐먼트의 필드 정보를 알기 어려울 때는 편리한 기능이지만 지금처럼 액세스 로그에 저장되는 필드가 고정되어있고 필드 유형을 파악할 수 있다면 정적 매핑을 정의해두는 것이 좋습니다.</p>
<p><img data-src="/images/posts/spring-boot-accesslog-with-elasticsearch/elasticsearch-devtools-03.png"></p>
<p>액세스 로그에 기록되는 정보가 명확하므로 동적 매핑을 수행하지 않고 미리 정의된 매핑을 사용하도록 인덱스 템플릿을 정의해두겠습니다. </p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"index_patterns"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"applicaiton-accesslog-*"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"template"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"path_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"path_hierarchy"</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"@timestamp"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"date"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"contentLength"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"long"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"date"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"date"</span><span class="token punctuation">,</span>
          <span class="token property">"format"</span><span class="token operator">:</span> <span class="token string">"date_hour_minute_second || epoch_millis"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"elapsedTime"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"protocol"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"referer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"remoteHost"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"ip"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"requestMethod"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"requestURI"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
          <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"path_analyzer"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"statusCode"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"short"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"user"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"userAgent"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>현재 조직에서는 엘라스틱서치에 애플리케이션의 로그 및 액세스 로그를 기록하지는 않고 있습니다만, 엘라스틱서치를 학습하기 위한 샘플 데이터가 없어서 간단하게나마 액세스 로그를 기록해보면 어떠할까 생각해서 시도해보았습니다. 현재 대량의 <a href="https://github.com/kdevkr/elasticsearch/blob/main/sample/access.q">랜덤 액세스 로그</a>를 만들기 위해서 컬럼형 시계열 데이터베이스인 KDB를 활용해보고는 있습니다만 쉽지는 않네요. 이 부분에 대해서는 많이 시도해보고 정리하여 공유해보겠습니다.</p>
</blockquote>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>Spring Boot</tag>
        <tag>Elasticsearch</tag>
        <tag>Access Log</tag>
      </tags>
  </entry>
  <entry>
    <title>스프링 부트 MQTT 클라이언트 메시지 채널 구성하기</title>
    <url>/spring-boot-integration-mqtt/</url>
    <content><![CDATA[<p>제주 전기차 실증 시스템을 개발하면서 전기차 OBD 데이터를 수집하기 위하여 MQTT(Message Queuing Telemetry Transfer) 클라이언트를 구성하고 토픽에 대한 메시지 페이로드를 수신하는 것을 처음 구성하였습니다.</p>
<p>본 글에서는 스프링 MQTT를 통해 MQTT 클라이언트와 메시지 구독 또는 발행하는 채널을 구성하는 것을 설명합니다.</p>
<h2 id="의존성"><a href="#의존성" class="headerlink" title="의존성"></a>의존성</h2><pre class="language-groovy" data-language="groovy"><code class="language-groovy">implementation <span class="token string">'org.springframework.boot:spring-boot-starter-integration'</span>
implementation <span class="token string">'org.springframework.integration:spring-integration-mqtt'</span></code></pre>

<p>스프링 MQTT는 <a href="https://www.eclipse.org/paho/">Eclipse Paho MQTT Client</a> 라이브러리를 사용합니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>integration<span class="token punctuation">:</span>spring<span class="token operator">-</span>integration<span class="token operator">-</span>mqtt<span class="token punctuation">:</span><span class="token number">5.3</span><span class="token punctuation">.</span><span class="token number">2</span><span class="token punctuation">.</span>RELEASE
  org<span class="token punctuation">.</span>eclipse<span class="token punctuation">.</span>paho<span class="token punctuation">:</span>org<span class="token punctuation">.</span>eclipse<span class="token punctuation">.</span>paho<span class="token punctuation">.</span>client<span class="token punctuation">.</span>mqttv3<span class="token punctuation">:</span><span class="token number">1.2</span><span class="token punctuation">.</span><span class="token number">4</span></code></pre>

<h2 id="Inbound-Channel-Configuration"><a href="#Inbound-Channel-Configuration" class="headerlink" title="Inbound Channel Configuration"></a>Inbound Channel Configuration</h2><p>토픽 메시지 구독을 위한 인바운드 채널 구성은 <code>MqttPahoMessageDrivenChannelAdapter</code> 구현체를 통해 가능합니다.</p>
<h3 id="DefaultMqttPahoClientFactory"><a href="#DefaultMqttPahoClientFactory" class="headerlink" title="DefaultMqttPahoClientFactory"></a>DefaultMqttPahoClientFactory</h3><p>기본적으로 <code>DefaultMqttPahoClientFactory</code>를 통해 MQTT 클라이언트를 등록합니다. 그러므로 우리는 MQTT 연결 정보(MqttConnectOptions)을 설정한 DefaultMqttPahoClientFactory를 빈으로 등록합니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqttConfig</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> MQTT_USERNAME <span class="token operator">=</span> <span class="token string">"username"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> MQTT_PASSWORD <span class="token operator">=</span> <span class="token string">"password"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">MqttConnectOptions</span> <span class="token function">connectOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MqttConnectOptions</span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MqttConnectOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span><span class="token function">setCleanSession</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span>MQTT_USERNAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>MQTT_PASSWORD<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> options<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DefaultMqttPahoClientFactory</span> <span class="token function">defaultMqttPahoClientFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">DefaultMqttPahoClientFactory</span> clientFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMqttPahoClientFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        clientFactory<span class="token punctuation">.</span><span class="token function">setConnectionOptions</span><span class="token punctuation">(</span><span class="token function">connectOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> clientFactory<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="MqttPahoMessageDrivenChannelAdapter"><a href="#MqttPahoMessageDrivenChannelAdapter" class="headerlink" title="MqttPahoMessageDrivenChannelAdapter"></a>MqttPahoMessageDrivenChannelAdapter</h3><p>앞서 등록하였던 MQTT 클라이언트를 통해 메시지를 구독하기 위하여 <code>MqttPahoMessageDrivenChannelAdapter</code>를 통해 메시지 수신을 위한 채널을 구성합니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqttConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> BROKER_URL <span class="token operator">=</span> <span class="token string">"tcp://localhost:1883"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> MQTT_CLIENT_ID <span class="token operator">=</span> <span class="token class-name">MqttAsyncClient</span><span class="token punctuation">.</span><span class="token function">generateClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TOPIC_FILTER <span class="token operator">=</span> <span class="token string">"[PROTECT]"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">MessageChannel</span> <span class="token function">mqttInputChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">MessageProducer</span> <span class="token function">inboundChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MqttPahoMessageDrivenChannelAdapter</span> adapter <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">MqttPahoMessageDrivenChannelAdapter</span><span class="token punctuation">(</span>BROKER_URL<span class="token punctuation">,</span> MQTT_CLIENT_ID<span class="token punctuation">,</span> TOPIC_FILTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        adapter<span class="token punctuation">.</span><span class="token function">setCompletionTimeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        adapter<span class="token punctuation">.</span><span class="token function">setConverter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultPahoMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        adapter<span class="token punctuation">.</span><span class="token function">setQos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        adapter<span class="token punctuation">.</span><span class="token function">setOutputChannel</span><span class="token punctuation">(</span><span class="token function">mqttInputChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> adapter<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ServiceActivator</span><span class="token punctuation">(</span>inputChannel <span class="token operator">=</span> <span class="token string">"mqttInputChannel"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">MessageHandler</span> <span class="token function">inboundMessageHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> message <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> topic <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> message<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MqttHeaders</span><span class="token punctuation">.</span>RECEIVED_TOPIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Topic:"</span> <span class="token operator">+</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Payload"</span> <span class="token operator">+</span> message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>이제 MQTT 클라이언트에 의해 수신된 페이로드는 MQTT 클라이언트 ➤ Inbound Channel ➤ MessageChannel ➤ MessageHandler 순으로 이동되어 MessageHandler를 통해 수신된 페이로드를 확인할 수 있습니다.</p>
<h2 id="Outbound-Channel-Configuration"><a href="#Outbound-Channel-Configuration" class="headerlink" title="Outbound Channel Configuration"></a>Outbound Channel Configuration</h2><p>제주 전기차 실증 시스템에서는 MQTT 클라이언트를 통해 메시지를 발행하는 것은 구현하지 않았습니다. 다만, 메시지를 수신하는 채널을 등록하는 것처럼 메시지를 발행하기 위한 채널을 구성하면 됩니다.</p>
<h3 id="MqttPahoMessageHandler"><a href="#MqttPahoMessageHandler" class="headerlink" title="MqttPahoMessageHandler"></a>MqttPahoMessageHandler</h3><p>MQTT 클라이언트는 이미 구성되었으므로 <code>MqttPahoMessageHandler</code>으로 메시지 발행을 위한 채널을 구성합니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqttConfig</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> MQTT_CLIENT_ID <span class="token operator">=</span> <span class="token class-name">MqttAsyncClient</span><span class="token punctuation">.</span><span class="token function">generateClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">MessageChannel</span> <span class="token function">mqttOutboundChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ServiceActivator</span><span class="token punctuation">(</span>inputChannel <span class="token operator">=</span> <span class="token string">"mqttOutboundChannel"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">MessageHandler</span> <span class="token function">mqttOutbound</span><span class="token punctuation">(</span><span class="token class-name">DefaultMqttPahoClientFactory</span> clientFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MqttPahoMessageHandler</span> messageHandler <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">MqttPahoMessageHandler</span><span class="token punctuation">(</span>MQTT_CLIENT_ID<span class="token punctuation">,</span> clientFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageHandler<span class="token punctuation">.</span><span class="token function">setAsync</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageHandler<span class="token punctuation">.</span><span class="token function">setDefaultQos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> messageHandler<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>이제 @MessagingGateway 어노테이션을 선언한 메시지 게이트웨이 API를 통해 메시지를 발송합니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqttConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@MessagingGateway</span><span class="token punctuation">(</span>defaultRequestChannel <span class="token operator">=</span> <span class="token string">"mqttOutboundChannel"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OutboundGateway</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">void</span> <span class="token function">sendToMqtt</span><span class="token punctuation">(</span><span class="token class-name">String</span> payload<span class="token punctuation">,</span> <span class="token annotation punctuation">@Header</span><span class="token punctuation">(</span><span class="token class-name">MqttHeaders</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">)</span> <span class="token class-name">String</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="MQTT-Events"><a href="#MQTT-Events" class="headerlink" title="MQTT Events"></a>MQTT Events</h2><p>만약, MQTT 클라이언트가 브로커 서버에 연결을 실패하거나 토픽 구독을 감지한 이벤트를 처리하고 싶다면 다음의 링크를 참고하시기 바랍니다.</p>
<p><a href="https://docs.spring.io/spring-integration/reference/html/mqtt.html#mqtt-events">https://docs.spring.io/spring-integration/reference/html/mqtt.html#mqtt-events</a></p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://docs.spring.io/spring-integration/reference/html/mqtt.html">Spring Integration - MQTT Support</a></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>스프링 부트 애플리케이션을 Vue와 함께 개발하기</title>
    <url>/spring-boot-integration-vuejs/</url>
    <content><![CDATA[<blockquote>
<p>관련 소스코드는 Github <a href="https://github.com/kdevkr/spring-boot-integration-vuejs">spring-boot-integration-vuejs</a> 리포지토리에서 제공합니다.</p>
</blockquote>
<p>최근에는 스프링 프레임워크로 애플리케이션 개발 시 프론트엔드 클라이언트를 Vue를 활용하여 개발하고 배포합니다. 이번 글에서는 스프링 부트 프로젝트를 시작하고 Vue CLI를 통해 프론트엔드 클라이언트를 개발할 때 어떻게 진행하는지 설명합니다. 제가 알려드리는 방법과 구조는 정확한 정답은 아님을 미리 밝히는 바 입니다.</p>
<h2 id="Spring-Initializr"><a href="#Spring-Initializr" class="headerlink" title="Spring Initializr"></a>Spring Initializr</h2><p>스프링 부트 프로젝트는 <a href="https://start.spring.io/">Spring Initializr</a>에서 쉽게 여러분이 스프링 부트 애플리케이션을 시작할 수 있도록 지원합니다. 저는 메이븐(Maven)이 아닌 <code>그래들(Gradle)</code> 프로젝트를 선호하며 언어는 <code>Java</code>로 개발합니다.</p>
<p><img data-src="/images/posts/spring-initializr.png"></p>
<p>그리고 위와 같이 프로젝트에서 사용할 의존성(Dependencies)를 찾아 선택합니다. 이렇게 만들어지는 스프링 부트 프로젝트는 다음과 같은 디렉토리 구조를 가지게 됩니다.</p>
<pre class="language-none"><code class="language-none">src
 ├─ main
 │ ├─ java
 │ └─ resources
gradle
build.gradle</code></pre>

<h2 id="Vue-CLI"><a href="#Vue-CLI" class="headerlink" title="Vue CLI"></a>Vue CLI</h2><p>앞서 <code>Spring Initializr</code>를 통해 스프링 부트 프로젝트를 구성하였습니다. 이제는 스프링 부트 애플리케이션과 함께 개발할 Vue 프로젝트를 구성합니다. Vue 프로젝트는 Vue CLI를 활용하여 쉽게 시작할 수 있습니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh"># Vue CLI는 NPM으로 설치합니다.
npm i -g @vue&#x2F;cli
# 그리고 create 명령어로 프로젝트를 시작합니다.
vue create --preset kdevkr&#x2F;vue-preset [project-name]</code></pre>

<p>위 예시처럼 Vue 프로젝트를 시작할 때 자주 사용하는 플러그인을 프리셋 형태(preset.json)로 구성하여 지정할 수 있습니다. 저의 <a href="https://github.com/kdevkr/vue-preset">kdevkr&#x2F;vue-preset</a> 프리셋은 다음의 라이브러리들을 포함하는 Vue 프로젝트를 구성합니다.</p>
<ul>
<li>Babel</li>
<li>ESLint + Prettier</li>
<li>SCSS (with dart-sass)</li>
<li>Vuex</li>
<li>Vue Router</li>
<li>Bootstrap Vue</li>
<li>Fontawesome</li>
</ul>
<h3 id="src-x2F-main-x2F-vue"><a href="#src-x2F-main-x2F-vue" class="headerlink" title="src&#x2F;main&#x2F;vue"></a>src&#x2F;main&#x2F;vue</h3><p>보통은 프로젝트 루트 경로에 Vue 프로젝트를 구성해도 상관없으나 저는 <code>src/main/java</code>처럼 <code>src/main/vue</code>로 구성하는 것을 추천합니다. 이제 src&#x2F;main&#x2F;vue 폴더에서 프론트엔드 클라이언트 코드를 관리하게 됩니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">cd src&#x2F;main
vue create --preset kdevkr&#x2F;vue-preset vue</code></pre>

<p>Vue CLI에 의해 <a href="https://github.com/kdevkr/spring-boot-integration-vuejs/tree/main/src/main/vue">src&#x2F;main&#x2F;vue</a>에 Vue 프로젝트가 만들어집니다.</p>
<h3 id="Vue-Configuration"><a href="#Vue-Configuration" class="headerlink" title="Vue Configuration"></a>Vue Configuration</h3><p>Vue 프로젝트에 대한 설정은 <code>vue.config.js</code>를 통해 변경할 수 있습니다. Vue 프로젝트는 만들었지만 몇가지 설정을 진행해야합니다. 가장 먼저 Vue를 통해 개발할 때는 <a href="https://cli.vuejs.org/config/#devserver">webpack-dev-server</a>를 실행해서 개발합니다.</p>
<p>스프링 부트 애플리케이션은 별다른 설정이 없으면 <code>8080</code> 포트를 사용하게 됩니다. 따라서, Vue 개발용 서버는 <code>8081</code> 포트를 사용하도록 합니다.</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">8081</span><span class="token punctuation">,</span>
    <span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token string">'http://localhost:8080'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">disableHostCheck</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>이제 <code>http://localhost:8081</code>으로 접속하여 웹 페이지를 개발할 수 있게 되고 프록시 설정을 통해 Vue 개발용 서버가 처리하지 못하는 모든 요청은 8080 포트로 요청합니다. 따라서, Vue 컴포넌트 내에서 스프링 부트 애플리케이션이 제공하는 API를 호출할 수 있게 됩니다.</p>
<blockquote>
<p>API 호출을 위해 <code>jQuery.ajax</code> 또는 <code>axios</code>를 사용하는 것은 본 글의 주된 관심사가 아닙니다.</p>
</blockquote>
<h3 id="Production-build"><a href="#Production-build" class="headerlink" title="Production build"></a>Production build</h3><p>Vue 프로젝트로 개발한 프론트엔드 클라이언트는 <code>build</code> 명령을 사용하여 빌드할 수 있습니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">npm run build</code></pre>

<p>위 명령을 통해 빌드되는 파일은 <code>dist/</code> 폴더에 생성됩니다. 따라서, <code>src/main/vue/dist</code>에 만들어지게 됩니다. 만약, 스프링 부트 애플리케이션을 빌드하여 실행하였다면 해당 파일들은 스프링 부트 애플리케이션이 리소스를 읽어 배포할 수 없게 됩니다.</p>
<p>스프링 부트 애플리케이션이 기본적으로 리소스를 읽어 배포하는 경로는 <a href="https://docs.spring.io/spring-boot/docs/2.4.2/reference/html/appendix-application-properties.html#spring.web.resources.static-locations"><code>spring.web.resources.static-locations</code></a> 프로퍼티로 확인할 수 있습니다. 저는 <code>src/main/resources/static/dist</code>를 Vue 프로젝트의 빌드 경로로 잡고 스프링 부트 애플리케이션에서 해당 빌드 파일을 배포할 수 있게 설정하도록 하겠습니다.</p>
<p>먼저 애플리케이션 프로퍼티에 클래스패스를 기준으로 <code>static/dist</code>의 리소스를 읽을 수 있게 합니다.<br><strong>application.properties</strong></p>
<pre class="language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">spring.web.resources.static-locations</span><span class="token punctuation">=</span><span class="token value attr-value">classpath:/META-INF/resources/, classpath:/resources/, classpath:/static/, classpath:/public/, classpath:/static/dist</span></code></pre>

<p>그리고 Vue 프로젝트 빌드 경로는 <code>outputDir</code>로 설정할 수 있습니다.<br><strong>vue.config.js</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">outputDir</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../resources/static/dist'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="Freemarker-Template-Engine"><a href="#Freemarker-Template-Engine" class="headerlink" title="Freemarker Template Engine"></a>Freemarker Template Engine</h2><p>Vue 프로젝트로 빌드된 프론트엔드 클라이언트를 위한 파일들은 <code>html-webpack-plugin</code>에 의해 만들어지는 <code>index.html</code>에 자동으로 파일들이 포함됩니다. 그런데 스프링 부트 애플리케이션에서 템플릿 엔진을 사용하여 페이지에 대한 정보나 세션 정보를 웹 페이지에 포함시키고 싶을 수 있습니다. 예를 들어, Spring Initializr에서 프리마커를 템플릿 엔진으로 사용하기 위하여 의존성을 추가하였다면 <code>src/main/resources/templates</code> 하위에 위치한 <code>*.ftlh</code>을 View로 제공할 수 있습니다.</p>
<p>따라서, 다음과 같이 <code>indexPath</code>를 설정하여 index.ftlh이 만들어지는 위치를 지정할 수 있습니다.<br><strong>vue.config.js</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">indexPath</span><span class="token operator">:</span> <span class="token string">'../../templates/index.ftlh'</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="html-webpack-plugin"><a href="#html-webpack-plugin" class="headerlink" title="html-webpack-plugin"></a>html-webpack-plugin</h3><p>앞서 index 파일은 <code>html-webpack-plugin</code>에 의해 만들어진다고 하였습니다. 우리가 위에서 indexPath를 지정한 것은 단순히 확장자를 <code>.ftlh</code>로 바꾼 것과 다를 바 없습니다. 템플릿 엔진을 사용하는 목적은 해당 템플릿 엔진에서 지원하는 문법으로 정보를 표현하기 위함입니다. 이를 위해 플러그인에 대한 옵션을 변경하도록 합니다.</p>
<p>예를 들어, &lt;html&gt; 태그에 lang 속성에 요청에 따른 언어값을 부여하고 싶을 수 있습니다. 그러면 다음과 같이 index.ftlh가 만들어져야 합니다.</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;.locale?split(<span class="token punctuation">"</span></span><span class="token attr-name">_")[0]&#125;"</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>

<p>아쉽게도 html-webpack-plugin은 위 내용을 읽다가 값을 처리할 수 없어 오류를 보여줍니다. 다행스럽게도 약간의 트릭을 쓰면서 플러그인 옵션을 건드려서 가능하게 할 수 있습니다.</p>
<p><strong>index.html</strong></p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&lt;%= <span class="token punctuation">'</span>\$&#123;.locale?split(\<span class="token punctuation">"</span></span><span class="token attr-name">_\")[0]&#125;'</span> <span class="token attr-name">%</span><span class="token punctuation">></span></span>">
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>

<p><strong>vue.config.js</strong></p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">chainWebpack</span><span class="token operator">:</span> <span class="token parameter">config</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    config<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">args</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>minify <span class="token operator">=</span> <span class="token boolean">false</span>
          args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>interpolate <span class="token operator">=</span> <span class="token boolean">true</span>
          <span class="token keyword">return</span> args
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><code>minify</code> 옵션을 끄는 것은 스프링 부트 애플리케이션이 프리마커 템플릿 엔진으로 <code>index.ftlh</code>을 읽을 때 발생하는 오류를 방지하기 위함입니다.</p>
<p>이제 빌드된 <a href="https://github.com/kdevkr/spring-boot-integration-vuejs/blob/main/src/main/resources/templates/index.ftlh">index.ftlh</a>는 다음과 같이 만들어집니다.</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;.locale?split(<span class="token punctuation">"</span></span><span class="token attr-name">_")[0]&#125;"</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>IE=edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width,initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>icon<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/favicon.ico<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/about.d6d714df.js<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>prefetch<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/css/app.f94ee837.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>style<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/css/chunk-vendors.01c183df.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>style<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/app.247cb7a3.js<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>script<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/chunk-vendors.65fb301b.js<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>script<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/css/chunk-vendors.01c183df.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/css/app.f94ee837.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>noscript</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">></span></span>We're sorry but vue doesn't work properly without JavaScript enabled. Please enable it to continue.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>noscript</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!-- built files will be auto injected --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/chunk-vendors.65fb301b.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/app.247cb7a3.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>

<p>이제 여러분도 스프링 부트 애플리케이션을 Vue와 함께 개발할 수 있게 되었습니다. 감사합니다. 😀</p>
]]></content>
  </entry>
  <entry>
    <title>Spring JDBC</title>
    <url>/spring-jdbc/</url>
    <content><![CDATA[<p>Spring Security OAuth2 학습을 위한 샘플 프로젝트를 만들면서 사용하게될 각 모듈에서 필요한 데이터베이스 스키마를 적용하기 위해서 Spring JDBC를 사용한 부분에 대해서 정리해보고자 합니다. 일반적으로 데이터 액세스에 대해서는 Mybatis 또는 JPA 이라는 기술을 도입하는 경우가 많을텐데 스프링 JDBC 만으로도 충분히 데이터베이스 액세스가 가능하며 Spring Session 이나 Spring Security 에서도 JDBC 기반으로 관련 기능을 제공하고 있습니다.</p>
<h2 id="Data-Access-with-JDBC"><a href="#Data-Access-with-JDBC" class="headerlink" title="Data Access with JDBC"></a>Data Access with JDBC</h2><p>Spring JDBC는 다양한 방식으로 데이터베이스에 대한 액세스 방법을 제공하며 스프링 세션이나 스프링 시큐리티와 함께 JDBC 기반으로 관련된 기능을 구현하기 위해서는 반드시 Spring JDBC가 포함되어야 합니다. 아마도 대부분의 애플리케이션에서는 관계형 데이터베이스에 대한 접근이 필수적이므로 다음과 같은 JDBC 모듈을 반드시 포함하고 있을 것 입니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">implementation <span class="token string">'org.springframework.boot:spring-boot-starter-jdbc'</span></code></pre>

<h3 id="JdbcTemplate"><a href="#JdbcTemplate" class="headerlink" title="JdbcTemplate"></a>JdbcTemplate</h3><p>스프링 부트에서는 JdbcTemplateAutoConfiguration를 통해서 JdbcTemplate와 NamedParameterJdbcTemplate를 자동으로 빈으로 구성하는 것을 확인할 수 있는데요. JdbcTemplate 뿐만 아니라 NamedParameterJdbcTemplate를 함께 구성하는 이유는 Spring Data JDBC와 같은 모듈에서 내부적으로 사용하도록 되어있기 때문이라고 생각됩니다.</p>
<h3 id="JdbcUserDetailsManager"><a href="#JdbcUserDetailsManager" class="headerlink" title="JdbcUserDetailsManager"></a>JdbcUserDetailsManager</h3><p>스프링 시큐리티에서 JdbcUserDetailsManager는 JDBC 기반의 사용자 인증 구현을 위해서 JdbcDaoSupport를 확장하며 내부적으로 JdbcTemplate과 RowMapper를 사용하는 것으로 작성되어 있습니다. </p>
<h3 id="JdbcIndexedSessionRepository"><a href="#JdbcIndexedSessionRepository" class="headerlink" title="JdbcIndexedSessionRepository"></a>JdbcIndexedSessionRepository</h3><p>스프링 세션에서의 JdbcHttpSessionConfiguration는 JdbcTemplate를 통해서 JdbcIndexedSessionRepository를 빈으로 등록하게 됩니다. JdbcIndexedSessionRepository는 내부적으로 JdbcOperations를 사용하여 SQL를 수행하는데 세션에 대한 애트리뷰트를 저장할때 <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/data-access.html#jdbc-advanced-jdbc">JDBC Batch Operations</a>를 활용하는 것으로 보입니다.</p>
<blockquote>
<p>JdbcTemplate는 JdbcOperatrions 구현체입니다.</p>
</blockquote>
<h2 id="Stored-Function-with-JDBC"><a href="#Stored-Function-with-JDBC" class="headerlink" title="Stored Function with JDBC"></a>Stored Function with JDBC</h2><p>현재 조직에서는 일반적으로 사용되는 Mybatis 또는 JPA를 도입하지 않고 스토어드 함수(프로시저와 비슷한)를 작성해놓고 스프링 JDBC를 통해서 호출하는 방식으로 구현하고 있습니다. 레거시 시스템을 경험하지 않았거나 Mybatis 또는 JPA라는 기술만을 접한 개발자들은 궁금할 수 있는 부분이기도 할 것 같습니다. 우선 아래와 같은 함수가 PostgreSQL 데이터베이스에 정의되어있다고 가정하겠습니다.</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> users$find_by_username<span class="token punctuation">(</span>v_username <span class="token keyword">VARCHAR</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> REFCURSOR <span class="token keyword">AS</span>
$$
<span class="token keyword">DECLARE</span>
    rtn_cursor REFCURSOR :<span class="token operator">=</span> <span class="token string">'rtn_cursor'</span><span class="token punctuation">;</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">OPEN</span> rtn_cursor <span class="token keyword">FOR</span>
        <span class="token keyword">SELECT</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> enabled <span class="token keyword">from</span> users <span class="token keyword">where</span> username <span class="token operator">=</span> v_username<span class="token punctuation">;</span>
    <span class="token keyword">RETURN</span> rtn_cursor<span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
$$ <span class="token keyword">LANGUAGE</span> plpgsql<span class="token punctuation">;</span>

<span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> users$find_by_username<span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">FETCH</span> <span class="token keyword">ALL</span> <span class="token operator">IN</span> <span class="token string">"rtn_cursor"</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span></code></pre>

<h3 id="StoredProcedure"><a href="#StoredProcedure" class="headerlink" title="StoredProcedure"></a>StoredProcedure</h3><p>스프링 JDBC의 GenericStoredProcedure는 RDBMS에서 지원하는 스토어드 프로시저를 호출할 수 있도록 구현된 클래스입니다. 아래와 같이 스토어드 함수명을 지정하여 파라미터와 함께 전달하면 프로시저 호출 결과를 가져올 수 있습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"Call stored function using GenericStoredProcedure"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testCallFunctionWithStoredProcedure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> functionName <span class="token operator">=</span> <span class="token string">"users$find_by_username"</span><span class="token punctuation">;</span>
    jdbcTemplate<span class="token punctuation">.</span><span class="token function">setResultsMapCaseInsensitive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">GenericStoredProcedure</span> storedProcedure <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericStoredProcedure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    storedProcedure<span class="token punctuation">.</span><span class="token function">setJdbcTemplate</span><span class="token punctuation">(</span>jdbcTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    storedProcedure<span class="token punctuation">.</span><span class="token function">setFunction</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    storedProcedure<span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span>functionName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    storedProcedure<span class="token punctuation">.</span><span class="token function">declareParameter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SqlOutParameter</span><span class="token punctuation">(</span><span class="token string">"rtn_cursor"</span><span class="token punctuation">,</span> <span class="token class-name">Types</span><span class="token punctuation">.</span>REF_CURSOR<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ColumnMapRowMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    storedProcedure<span class="token punctuation">.</span><span class="token function">declareParameter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SqlParameter</span><span class="token punctuation">(</span><span class="token string">"v_username"</span><span class="token punctuation">,</span> <span class="token class-name">Types</span><span class="token punctuation">.</span>VARCHAR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> inParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    inParams<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"v_username"</span><span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> results <span class="token operator">=</span> storedProcedure<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>inParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"rtn_cursor"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertDoesNotThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> cursors <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> results<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"rtn_cursor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> cursor <span class="token operator">:</span> cursors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> cursor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="SimpleJdbcXXXX"><a href="#SimpleJdbcXXXX" class="headerlink" title="SimpleJdbcXXXX"></a>SimpleJdbcXXXX</h3><p>SimpleJdbcInsert와 SimpleJdbcCall은 JdbcTemplate를 사용하여 몇가지 상황에 대해 효율적으로 처리할 수 있는 방법을 제공합니다. 예를 들어, 한번에 많은 생성 작업이 필요한 경우에 SimpleJdbcInsert를 사용할 수 있고 스토어드 프로시저(Stored Procedure) 또는 스토어드 함수(Stored Function)를 호출하고자 하는 경우에도 SimpleJdbcCall을 사용할 수 있습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"Call stored function using SimpleJdbcCall"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testCallFunctionWithSimpleJdbcCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> functionName <span class="token operator">=</span> <span class="token string">"users$find_by_username"</span><span class="token punctuation">;</span>

    <span class="token class-name">MapSqlParameterSource</span> sqlParameterSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapSqlParameterSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sqlParameterSource<span class="token punctuation">.</span><span class="token function">addValue</span><span class="token punctuation">(</span><span class="token string">"v_username"</span><span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleJdbcCall</span><span class="token punctuation">(</span>jdbcTemplate<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withFunctionName</span><span class="token punctuation">(</span>functionName<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withoutProcedureColumnMetaDataAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">declareParameters</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SqlParameter</span><span class="token punctuation">(</span><span class="token string">"v_username"</span><span class="token punctuation">,</span> <span class="token class-name">Types</span><span class="token punctuation">.</span>VARCHAR<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">returningResultSet</span><span class="token punctuation">(</span><span class="token string">"rtn_cursor"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ColumnMapRowMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>sqlParameterSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"rtn_cursor"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>GenericStoredProcedure와 비교해서 조금은 코드가 간결함을 확인할 수 있습니다.</p>
</blockquote>
<h3 id="JdbcTemplate-1"><a href="#JdbcTemplate-1" class="headerlink" title="JdbcTemplate"></a>JdbcTemplate</h3><p>스프링 JDBC에서 제공하는 클래스가 아니더라도 스토어드 프로시저를 호출할 수 있습니다. JdbcTemplate에서 커넥션을 가져온 후 prepareCall을 사용해서 직접 호출한 결과를 RowMapper로 변환할 수 있습니다. </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"Call stored function using connection"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testCallFunctionWithConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> functionName <span class="token operator">=</span> <span class="token string">"users$find_by_username"</span><span class="token punctuation">;</span>

    <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertDoesNotThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> connection <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">CallableStatement</span> statement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareCall</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"&#123;call %s(?)&#125;"</span><span class="token punctuation">,</span> functionName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            statement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>resultSet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">PgResultSet</span> pgResultSet <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PgResultSet</span><span class="token punctuation">)</span> resultSet<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">RowMapperResultSetExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span><span class="token punctuation">></span></span> extractor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RowMapperResultSetExtractor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ColumnMapRowMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> extractor<span class="token punctuation">.</span><span class="token function">extractData</span><span class="token punctuation">(</span>pgResultSet<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>DataClassRowMapper 또는 BeanPropertyRowMapper를 사용해서 더 범용적인 코드를 작성할 수도 있습니다.</p>
</blockquote>
<p><a href="https://qr.ae/pvkBiH">저장 프로시저를 사용하는 것에 대한 장점</a>도 존재하기 때문에 애플리케이션에서 저장 프로시저를 호출할 수 있는 방법을 알고 있는 것도 중요합니다. Spring JDBC에 대해서 다루기 때문에 소개하지는 않았지만 JPA 기술 스펙에서도 NamedStoredProcedureQuery와 같이 프로시저를 호출할 수 있도록 지원하고 있습니다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://docs.spring.io/spring-framework/docs/current/reference/html/data-access.html#jdbc">Spring Docs - Data Access with JDBC</a></li>
<li><a href="https://www.baeldung.com/jdbc-batch-processing">Batch Processing in JDBC</a></li>
</ul>
]]></content>
      <tags>
        <tag>JDBC</tag>
        <tag>RowMapper</tag>
      </tags>
  </entry>
  <entry>
    <title>SSH 키 페어 발급 및 원격 호스트 연결하기</title>
    <url>/ssh/</url>
    <content><![CDATA[<p>개발자 또는 시스템을 운용하는 사람들이 서버 엔지니어가 구축한 원격 호스트에 접속하기 위해서 SSH 프로토콜을 사용한다. 우리가 컴퓨터에 로그인하는 것처럼 간단하게 사용자 이름과 비밀번호를 사용하기도 하며 공개키 기반 인증으로 비밀번호를 대체하거나 2FA(OTP)를 추가적으로 인증하여 보안을 적용하기도 한다. SSH 프로토콜을 사용하는 이유에는 TCP 보안 채널을 연결하고 통신 내용에 대해 암호화하여 패킷을 보호하고 안전하게 서버에 접속하여 통신할 수 있도록 구성하기 위함에 있다. 초보 개발자라면 이 글을 통해서 SSH 키페어를 발급해보고 아마존 웹 서비스의 EC2 인스턴스 또는 깃허브 저장소에 등록하여 원격 호스트에 연결하는 방법을 통해서 SSH에 대해 이해해보기를 바란다.</p>
<p>먼저, 서버 엔지니어가 리눅스 서버 환경을 준비하고 제공해주는 것처럼 내 컴퓨터에 가상의 리눅스 환경을 만들어볼 수 있는데 아래의 두가지 방법 중에서 <a href="https://www.virtualbox.org/">OracleVM VirtualBox</a>을 사용해서 리눅스 서버를 준비하였다.</p>
<ul>
<li><a href="https://ubuntu.com/tutorials/install-ubuntu-on-wsl2-on-windows-10">Install Ubuntu on WSL2 on Windows 10</a></li>
<li><a href="https://ubuntu.com/tutorials/how-to-run-ubuntu-desktop-on-a-virtual-machine-using-virtualbox">How to run Ubuntu Desktop on a virtual machine using VirtualBox</a></li>
</ul>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> openssh-server
<span class="token function">ssh</span> -V
OpenSSH_8.9p1 Ubuntu-3, OpenSSL <span class="token number">3.0</span>.2 <span class="token number">15</span> Mar <span class="token number">2022</span></code></pre>

<blockquote>
<p>VirtualBox로 준비된 우분투 리눅스의 주소는 192.168.0.28 이다.</p>
</blockquote>
<p>내 컴퓨터에 설치된 OpenSSH 클라이언트를 사용해서 위 우분투 리눅스에 접속해보도록 하자.</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> C:\Users\Mambo> ssh ubuntu@192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>0<span class="token punctuation">.</span>28
ubuntu@192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>0<span class="token punctuation">.</span>28's password:
Welcome to Ubuntu 22<span class="token punctuation">.</span>04<span class="token punctuation">.</span>1 LTS <span class="token punctuation">(</span>GNU/Linux 5<span class="token punctuation">.</span>15<span class="token punctuation">.</span>0-47-generic x86_64<span class="token punctuation">)</span></code></pre>

<p>실제 리눅스 서버 그리고 인프라에 따라서 여러가지 네트워크 방화벽 정책이 있을 수 있지만 지금은 내 컴퓨터에 가상 환경으로 우분투 리눅스를 준비했고 어떤 방화벽도 존재하지 않으므로 사용자 이름과 비밀번호만으로 SSH 프로토콜을 사용하여 리눅스 서버에 연결할 수 있었다.</p>
<h2 id="SSH-키-페어"><a href="#SSH-키-페어" class="headerlink" title="SSH 키 페어"></a>SSH 키 페어</h2><p>아마존 웹 서비스의 EC2 인스턴스 또는 깃허브 저장소와 같은 서비스에서는 SSH 프로토콜을 사용해서 서버에 연결할 때에 사용자 이름과 비밀번호를 사용하지 않고 공개키 기반의 키 페어라는 것을 사용한다. 비밀번호 인증보다 공개키 기반 인증을 구성하는 이유는 비밀번호 인증 방식의 경우에는 서버에서 사용되는 비밀번호를 외부로 그대로 대칭키로써 노출하는 것이며 공개키 기반 인증은 서버에서 신뢰할 수 있는 키를 보유한 클라이언트가 서로 다른 키를 가지고 있기 때문이다.</p>
<blockquote>
<p>SSH 키페어가 보안적으로 완벽한 것은 아니므로 SSH 클라이언트가 보유하는 비밀키가 제 3자에게 탈취되지 않도록 잘 관리해야하는 것은 필요하다.</p>
</blockquote>
<h3 id="SSH-키-페어-생성하기"><a href="#SSH-키-페어-생성하기" class="headerlink" title="SSH 키 페어 생성하기"></a>SSH 키 페어 생성하기</h3><p>아마존 웹 서비스를 이용하는 개발자라면 웹 콘솔이나 AWS CLI의 create-key-pair 명령을 사용해서 RSA 또는 ED25519 기반의 키 페어를 간단하게 생성할 수 있다. 그러나, 일반적인 경우라면 어떠한 환경에 의존하지 않고 OpenSSH에 포함된 ssh-keygen 도구를 사용하는 방법에 대해서 알아야한다. 앞서, 준비된 우분투 리눅스에 사용자 이름과 비밀번호를 사용해서 접속하였을때 윈도우의 OpenSSH 클라이언트를 이용하였는데 윈도우 10의 선택적 기능을 통해서 간단하게 OpenSSH 클라이언트를 설치할 수 있고 Git Bash를 설치해도 ssh-keygen이 포함되어있으므로 자신이 원하는 방식을 선택해보면 좋을 것 같다.</p>
<p><img data-src="/images/posts/ssh/ssh-01.png" alt="윈도우 10의 선택적 기능을 통해서 설치한 OpenSSH 클라이언트"></p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token comment"># in Windows Terminal</span>
<span class="token function">PS</span> C:\Users\Mambo\keypair> ssh <span class="token operator">-</span>V
OpenSSH_for_Windows_7<span class="token punctuation">.</span>7p1<span class="token punctuation">,</span> LibreSSL 2<span class="token punctuation">.</span>6<span class="token punctuation">.</span>5

<span class="token comment"># in Git Bash</span>
$ ssh <span class="token operator">-</span>V
OpenSSH_9<span class="token punctuation">.</span>0p1<span class="token punctuation">,</span> OpenSSL 1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>1p  21 Jun 2022</code></pre>

<p>OpenSSH를 확인했다면 <a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent">Generating a new SSH key and adding it to the ssh-agent</a>를 참고해서 ssh-keygen으로 SSH 키페어를 생성하는 방법에 대해서 알아보자. </p>
<h4 id="RSA-키-페어"><a href="#RSA-키-페어" class="headerlink" title="RSA 키 페어"></a>RSA 키 페어</h4><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> C:\Users\Mambo\keypair> ssh-keygen <span class="token operator">-</span>t rsa <span class="token operator">-</span>b 4096 <span class="token operator">-</span>m PEM <span class="token operator">-</span>f win-mambo-rsa-4096<span class="token punctuation">.</span>pem
Generating public/private rsa key pair<span class="token punctuation">.</span>
Enter passphrase <span class="token punctuation">(</span>empty <span class="token keyword">for</span> no passphrase<span class="token punctuation">)</span>:
Enter same passphrase again:
Your identification has been saved in win-mambo-rsa-4096<span class="token punctuation">.</span>pem<span class="token punctuation">.</span>
Your public key has been saved in win-mambo-rsa-4096<span class="token punctuation">.</span>pem<span class="token punctuation">.</span>pub<span class="token punctuation">.</span>
The key fingerprint is:
SHA256:F3ECBEjeXszb6ccTJ2EWz9eaxvZoAg4f6F4rU0aDYJY mambo@DESKTOP-OJJ4TB3
The key's randomart image is:
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">-</span><span class="token namespace">[RSA 4096]</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token punctuation">|</span>   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">+</span>o<span class="token punctuation">.</span>o o    <span class="token punctuation">|</span>
<span class="token punctuation">|</span>   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Eo   <span class="token operator">+</span> <span class="token operator">+</span>  <span class="token punctuation">.</span><span class="token punctuation">|</span>
<span class="token punctuation">|</span>    <span class="token punctuation">.</span>o<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">+</span> o o<span class="token punctuation">|</span>
<span class="token punctuation">|</span>     <span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">+</span>o= o <span class="token operator">+</span> <span class="token punctuation">|</span>
<span class="token punctuation">|</span>      <span class="token punctuation">.</span> S<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">.</span>o B  <span class="token punctuation">|</span>
<span class="token punctuation">|</span>       <span class="token punctuation">.</span> <span class="token operator">*</span>o+ <span class="token operator">*</span> o <span class="token punctuation">|</span>
<span class="token punctuation">|</span>        <span class="token punctuation">.</span>o= = o <span class="token punctuation">.</span><span class="token punctuation">|</span>
<span class="token punctuation">|</span>       <span class="token punctuation">.</span>o<span class="token punctuation">.</span> o <span class="token operator">+</span>   <span class="token punctuation">|</span>
<span class="token punctuation">|</span>        <span class="token punctuation">.</span>o<span class="token punctuation">.</span>      <span class="token punctuation">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token namespace">[SHA256]</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span></code></pre>

<h4 id="ED25519-키-페어"><a href="#ED25519-키-페어" class="headerlink" title="ED25519 키 페어"></a>ED25519 키 페어</h4><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> C:\Users\Mambo\keypair> ssh-keygen <span class="token operator">-</span>t ed25519 <span class="token operator">-</span>m PEM <span class="token operator">-</span>f win-mambo-ed25519<span class="token punctuation">.</span>pem
Generating public/private ed25519 key pair<span class="token punctuation">.</span>
Enter passphrase <span class="token punctuation">(</span>empty <span class="token keyword">for</span> no passphrase<span class="token punctuation">)</span>:
Enter same passphrase again:
Your identification has been saved in win-mambo-ed25519<span class="token punctuation">.</span>pem<span class="token punctuation">.</span>
Your public key has been saved in win-mambo-ed25519<span class="token punctuation">.</span>pem<span class="token punctuation">.</span>pub<span class="token punctuation">.</span>
The key fingerprint is:
SHA256:oad/A11tVJQFxRIDA63pozCFj/FsTCDh51hALNdFBVU mambo@DESKTOP-OJJ4TB3
The key's randomart image is:
<span class="token operator">+</span><span class="token operator">--</span><span class="token namespace">[ED25519 256]</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token punctuation">|</span>   o+o o+<span class="token operator">++</span><span class="token operator">+</span>E<span class="token punctuation">.</span><span class="token operator">+</span>BB<span class="token punctuation">|</span>
<span class="token punctuation">|</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token punctuation">.</span>o     <span class="token punctuation">.</span><span class="token punctuation">.</span>oo<span class="token punctuation">.</span><span class="token punctuation">|</span>
<span class="token punctuation">|</span>   o<span class="token punctuation">.</span><span class="token punctuation">.</span>oo<span class="token punctuation">.</span>  o o <span class="token punctuation">.</span> <span class="token punctuation">|</span>
<span class="token punctuation">|</span>     =o<span class="token punctuation">.</span>o<span class="token punctuation">.</span>o <span class="token punctuation">.</span> o  <span class="token punctuation">|</span>
<span class="token punctuation">|</span>    <span class="token punctuation">.</span> oXSo <span class="token punctuation">.</span> <span class="token punctuation">.</span>   <span class="token punctuation">|</span>
<span class="token punctuation">|</span>      <span class="token operator">+</span>oB <span class="token operator">+</span>      <span class="token punctuation">|</span>
<span class="token punctuation">|</span>      <span class="token punctuation">.</span><span class="token operator">+</span> o <span class="token punctuation">.</span>     <span class="token punctuation">|</span>
<span class="token punctuation">|</span>       <span class="token punctuation">.</span><span class="token punctuation">.</span> o      <span class="token punctuation">|</span>
<span class="token punctuation">|</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span>     <span class="token punctuation">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token namespace">[SHA256]</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span></code></pre>

<p>먼저, RSA 기반의 키 페어를 만들때는 기본적으로 2048 비트 이상으로 만들어지게 되는데 아마존 웹 서비스나 깃허브 저장소에서는 모두 4096 비트를 지원하고 있으며 이를 권장하는 편이다. 그런데, 시스템에서 ED25519 방식을 지원한다면 키 길이에 따른 보안 효율 상 ED25519를 사용하는게 더 나은 선택이 될 수 있다.</p>
<h3 id="SSH-공개키-등록하기"><a href="#SSH-공개키-등록하기" class="headerlink" title="SSH 공개키 등록하기"></a>SSH 공개키 등록하기</h3><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> C:\Users\Mambo\keypair> scp <span class="token punctuation">.</span>\window-mambo<span class="token punctuation">.</span>pub ubuntu@192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>0<span class="token punctuation">.</span>28:<span class="token operator">/</span>home/ubuntu/<span class="token punctuation">.</span>ssh/
ubuntu@192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>0<span class="token punctuation">.</span>28's password:
window-mambo<span class="token punctuation">.</span>pub                                                                      100%  104    51<span class="token punctuation">.</span>6KB/s   00:00

<span class="token comment"># in ubuntu</span>
ubuntu@ubuntu:~<span class="token operator">/</span><span class="token punctuation">.</span>ssh$ <span class="token function">cat</span> window-mambo<span class="token punctuation">.</span>pub >> authorized_keys</code></pre>

<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> C:\Users\Mambo\keypair> ssh <span class="token operator">-</span>i <span class="token punctuation">.</span>\window-mambo<span class="token punctuation">.</span>pem ubuntu@192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>0<span class="token punctuation">.</span>28
Welcome to Ubuntu 22<span class="token punctuation">.</span>04<span class="token punctuation">.</span>1 LTS <span class="token punctuation">(</span>GNU/Linux 5<span class="token punctuation">.</span>15<span class="token punctuation">.</span>0-47-generic x86_64</code></pre>

<p>이렇게 해서 SSH 키 페어를 발급하고 가상 환경인 우분투 리눅스에 키 페어를 등록하고 SSH로 접속해보았다. 서버 엔지니어는 이러한 과정을 거치게 되면서 최종적으로 개발자인 우리에게 서버에 접속할 사용자 이름과 함께 비밀키를 전달한 것임을 알 수 있다.</p>
<h2 id="SSH-키-페어-실습"><a href="#SSH-키-페어-실습" class="headerlink" title="SSH 키 페어 실습"></a>SSH 키 페어 실습</h2><p>이제 아마존 웹 서비스와 깃허브 저장소 서비스에 SSH 키페어를 등록하고 연결하는 것을 실습해보면서 다시 한번 머리에 숙지하도록 해보자.</p>
<h3 id="깃허브-공개키-등록하기"><a href="#깃허브-공개키-등록하기" class="headerlink" title="깃허브 공개키 등록하기"></a>깃허브 공개키 등록하기</h3><p>먼저, 사내에서 사용중인 조직 계정으로 등록되어있는 프라이빗 깃허브 리파지토리를 복사해오거나 푸시해야한다면 조직에 속한 내 사용자 계정에 SSH 키 페어를 등록하고 깃허브 서버에 인증할 수 있어야 한다. 사용자 계정 설정 &gt; 액세스 &gt; <a href="https://github.com/settings/keys">SSH and GPG Keys</a> 메뉴로 진입하면 SSH 키 페어를 등록할 수 있도록 제공하고 있으므로 앞서 만들었던 ED25519 키 페어를 등록하고 깃허브에 접속할 수 있는지 테스트 해보자.</p>
<p><img data-src="/images/posts/ssh/ssh-02.png"></p>
<p><img data-src="/images/posts/ssh/ssh-03.png"></p>
<p><img data-src="/images/posts/ssh/ssh-04.png"></p>
<p>깃허브 서버에 우리가 만든 키 페어를 등록하였으므로 내 컴퓨터의 OpenSSH 클라이언트로 깃허브에 연결할 수 있는지 확인해보자. 깃허브에서는 앞서 리눅스 서버에 연결했던 것 처럼 쉘을 제공하지는 않지만 인증에 성공할 수 있는지 검증해볼 수 있다.</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> C:\Users\Mambo\keypair> ssh <span class="token operator">-</span>i win-mambo-ed25519<span class="token punctuation">.</span>pem <span class="token operator">-</span>T git@github<span class="token punctuation">.</span>com
The authenticity of host <span class="token string">'github.com (15.164.81.167)'</span> cannot be established<span class="token punctuation">.</span>
ECDSA key fingerprint is SHA256:p2QAMXNIC1TJYWeIOttrVc98/R1BUFWu3/LiyKgUfQM<span class="token punctuation">.</span>
Are you sure you want to <span class="token keyword">continue</span> connecting <span class="token punctuation">(</span>yes/no<span class="token punctuation">)</span>? yes
Warning: Permanently added <span class="token string">'github.com,15.164.81.167'</span> <span class="token punctuation">(</span>ECDSA<span class="token punctuation">)</span> to the list of known hosts<span class="token punctuation">.</span>
Hi kdevkr! You've successfully authenticated<span class="token punctuation">,</span> but GitHub does not provide shell access<span class="token punctuation">.</span></code></pre>

<h3 id="EC2-공개키-등록하기"><a href="#EC2-공개키-등록하기" class="headerlink" title="EC2 공개키 등록하기"></a>EC2 공개키 등록하기</h3><p>아마존 웹 서비스에서 EC2 인스턴스를 실행할 때 키 페어를 자동으로 만들어주기도 하는데 이미 만들어진 SSH 키 페어를 가져와서 등록하고 사용할 수 있도록 지원하고 있다. 내 컴퓨터에서 발급했던 공개키를 가져와서 등록한 후 EC2 인스턴스인 리눅스 서버에 접속할 수 있는지 확인해보자.</p>
<p><img data-src="/images/posts/ssh/ssh-05.png"></p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> C:\Users\Mambo\keypair> ssh <span class="token operator">-</span>i win-mambo-ed25519<span class="token punctuation">.</span>pem ec2-user@15<span class="token punctuation">.</span>164<span class="token punctuation">.</span>219<span class="token punctuation">.</span>55
The authenticity of host <span class="token string">'15.164.219.55 (15.164.219.55)'</span> cannot be established<span class="token punctuation">.</span>
ECDSA key fingerprint is SHA256:64Ca/STwUWZkN+ggo5jx6BCvwyhNRcCY5/xjk0SkSjU<span class="token punctuation">.</span>
Are you sure you want to <span class="token keyword">continue</span> connecting <span class="token punctuation">(</span>yes/no<span class="token punctuation">)</span>? yes
Warning: Permanently added <span class="token string">'15.164.219.55'</span> <span class="token punctuation">(</span>ECDSA<span class="token punctuation">)</span> to the list of known hosts<span class="token punctuation">.</span>

       __<span class="token punctuation">|</span>  __<span class="token punctuation">|</span>_  <span class="token punctuation">)</span>
       _<span class="token punctuation">|</span>  <span class="token punctuation">(</span>     <span class="token operator">/</span>   Amazon Linux 2 AMI
      ___<span class="token punctuation">|</span>\___<span class="token punctuation">|</span>___<span class="token punctuation">|</span>

https:<span class="token operator">/</span><span class="token operator">/</span>aws<span class="token punctuation">.</span>amazon<span class="token punctuation">.</span>com/amazon-linux-2/

<span class="token namespace">[ec2-user@ip-10-0-2-243 ~]</span>$ <span class="token function">cat</span> ~<span class="token operator">/</span><span class="token punctuation">.</span>ssh/authorized_keys
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOy21gZ45To8FNf6hilxV51QqT9JCBjIpVKCRlup7m4D window-mambo</code></pre>

<blockquote>
<p>EC2 인스턴스가 퍼블릭 서브넷에 위치하고 22번 포트가 허용되어있다면 SSH 키 페어를 사용하여 EC2 인스턴스에 접속할 수 있는데, 인터넷에서 바로 접근할 수 없는 프라이빗 서브넷에 위치한 EC2 인스턴스에 SSM 에이전트를 구성한다면 아마존 웹 서비스에서 제공하는 <a href="/connect-private-ec2-instance-using-ssm-agent/">SSM 엔드포인트를 사용해서 SSH 접속이 가능</a>하도록 만들 수 있다.</p>
</blockquote>
<h2 id="트러블슈팅"><a href="#트러블슈팅" class="headerlink" title="트러블슈팅"></a>트러블슈팅</h2><p>지난 <a href="/ed25519">ED25519</a> 글을 읽어본 분들이라면 윈도우 컴퓨터에서 발급한 ED25519 키 페어를 발급하고 윈도우 환경에서 비밀키를 사용해서 인증을 시도하면 키 형식이 올바르지 않아서 실패하는 문제가 있다는 것을 확인했을 것이다. 지난번 글에서는 단순히 안되는 부분을 언급하고 마무리하였지만 이 문제에 대해서 왜 그런것인가에 대해 궁금해졌고 <a href="https://github.com/aws/aws-cli/discussions/7074">aws-cli&#x2F;discussions&#x2F;7074</a>로 관련 문제에 대해서 질문을 통해서 원인을 찾게 되었다.</p>
<p><img data-src="/images/posts/ssh/ssh-06.png"></p>
<p>윈도우 환경에서 AWS CLI를 통해서 키 페어를 발급하고나서 비밀키 파일에 대해서 에디터로 열어보면 위와 같이 UTF-16LE 인코딩 형식과 CRLF 개행 방식으로 되어있는 것을 확인할 수 있었다. OpenSSH의 ssh-keygen으로 만들어지는 키페어 파일을 살펴보면 UTF-8과 LF로 만들어지는데 Git Bash에 포함되어있는 dos2unix라는 도구를 통해서 UTF-16LE로 되어있는 인코딩 형식을 UTF-8로 변경해보고 시도해본결과 정상적으로 접속을 수행할 수 있었다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">$ dos2unix aws-mambo.pem
dos2unix: converting UTF-16LE file aws-mambo.pem to UTF-8 Unix format...</code></pre>

<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> C:\Users\Mambo\keypair> ssh <span class="token operator">-</span>i aws-mambo<span class="token punctuation">.</span>pem ec2-user@3<span class="token punctuation">.</span>34<span class="token punctuation">.</span>188<span class="token punctuation">.</span>47

       __<span class="token punctuation">|</span>  __<span class="token punctuation">|</span>_  <span class="token punctuation">)</span>
       _<span class="token punctuation">|</span>  <span class="token punctuation">(</span>     <span class="token operator">/</span>   Amazon Linux 2 AMI
      ___<span class="token punctuation">|</span>\___<span class="token punctuation">|</span>___<span class="token punctuation">|</span>

https:<span class="token operator">/</span><span class="token operator">/</span>aws<span class="token punctuation">.</span>amazon<span class="token punctuation">.</span>com/amazon-linux-2/
<span class="token namespace">[ec2-user@ip-10-0-2-42 ~]</span>$</code></pre>

<p>또한, 윈도우 터미널이 아니라 Git Bash에서 시도해본 결과 다음과 같이 다시한번 키 형식이 올바르지 않다는 메시지가 발생했는데 이번에는 CRLF로 되어있던 개행 형식을 LF로 변경하게되면 성공적으로 접속할 수 있음을 확인했다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ssh</span> -i aws-mambo.pem ec2-user@3.34.188.47
Load key <span class="token string">"aws-mambo.pem"</span><span class="token builtin class-name">:</span> invalid <span class="token function">format</span>
ec2-user@3.34.188.47: Permission denied <span class="token punctuation">(</span>publickey,gssapi-keyex,gssapi-with-mic<span class="token punctuation">)</span>.</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ssh</span> -i aws-mambo.pem ec2-user@3.34.188.47

       __<span class="token operator">|</span>  __<span class="token operator">|</span>_  <span class="token punctuation">)</span>
       _<span class="token operator">|</span>  <span class="token punctuation">(</span>     /   Amazon Linux <span class="token number">2</span> AMI
      ___<span class="token operator">|</span><span class="token punctuation">\</span>___<span class="token operator">|</span>___<span class="token operator">|</span>

https://aws.amazon.com/amazon-linux-2/
<span class="token punctuation">[</span>ec2-user@ip-10-0-2-42 ~<span class="token punctuation">]</span>$</code></pre>

<p>실무에서 SSH 키 페어를 전달받았는데 SSH 접속이 불가능하다면 전달받은 키 페어 파일의 인코딩 형식과 개행 형식을 살펴보고 위와 같이 변경해서 시도해보기를 추천한다. </p>
<blockquote>
<p>실무에서는 조직 혹은 인프라 환경마다 다양한 방식으로 서버에 접속할 수 있는 방법을 제한하는데요. 배스천 호스트로 우선 접속하거나서 각 서버마다 정해진 사용자 이름과 비밀번호를 사용하여 이동해야하거나 심지어는 SSH 키 페어 인증 뿐만 아니라 OTP를 통한 2FA 인증을 요구하도록 구성하기도 합니다. 저는 서버 엔지니어가 아니므로 SSH 연결 시 2FA을 구성하는 것은 모르기에 이 부분에 대해서는 별도로 찾아보아야겠습니다.</p>
</blockquote>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstancesLinux.html">Connect to your Linux instance using SSH</a>  </li>
<li><a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh">Connecting to GitHub with SSH</a></li>
</ul>
]]></content>
      <tags>
        <tag>SSH</tag>
        <tag>Key Pair</tag>
        <tag>RSA</tag>
        <tag>ED25519</tag>
      </tags>
  </entry>
  <entry>
    <title>SonarQube와 Github Action으로 수행하는 정적 분석</title>
    <url>/static-analysis-performed-by-sonarqube-and-github-action/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>오늘은 SonarQube와 Github Action을 통해 정적 분석을 수행하기 위한 과정을 알아보려고 합니다.</p>
<h2 id="SonarQube"><a href="#SonarQube" class="headerlink" title="SonarQube"></a>SonarQube</h2><p><a href="https://www.sonarqube.org/">소나큐브</a>는 다양한 언어에 대한 코드 품질을 분석하고 취약점을 파악할 수 있는 정적 분석 도구입니다. 회사에서 정적 분석을 수행하고 싶다는 요구사항이 있어 제가 SonarQube를 도입하고 월요일과 금요일마다 프로젝트 코드에 대한 정적 분석을 수행하고 있습니다. 제가 정적 분석을 위해서 소나큐브를 도입한 이유는 다음과 같습니다.</p>
<p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-00.png" alt="소나큐브 라이센스"></p>
<ol>
<li>GPLv3 라이센스 기반의 오픈소스 버전 지원</li>
<li>IntelliJ 또는 VSCode와 같은 IDE를 위한 SonarLint 지원</li>
<li>소나큐브에 대한 공식 도커 이미지 지원</li>
<li>다양한 언어와 커뮤니티 기반의 규칙 지원</li>
</ol>
<p>회사 개발자들이 주로 사용하는 인텔리제이 IDEA 또는 VSCode에서 사용할 수 있는 SonarLint를 제공하여 별도의 서버 없이도 간단하게 자체적으로 정적 분석을 수행하고 결과를 확인할 수 있으며 공식 도커 이미지를 통해 별다른 설정 없이도 간단하게 소나큐브 시스템을 구성할 수 있습니다.</p>
<h3 id="소나큐브-시스템-구성"><a href="#소나큐브-시스템-구성" class="headerlink" title="소나큐브 시스템 구성"></a>소나큐브 시스템 구성</h3><p>소나큐브는 <a href="https://docs.sonarqube.org/latest/setup/install-server/">직접 설치</a>할 수도 있으며 도커 이미지와 함께 제공하는 도커 컴포즈 문서를 활용할 수 있습니다.</p>
<p><a href="https://github.com/SonarSource/docker-sonarqube/blob/master/example-compose-files/sq-with-postgres/docker-compose.yml">sq-with-postgres&#x2F;docker-compose.yml</a></p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.8"</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">web</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> sonarqube<span class="token punctuation">:</span>9.1.0<span class="token punctuation">-</span>community
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> db
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"9000:9000"</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> sonarnet
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">SONAR_JDBC_URL</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>postgresql<span class="token punctuation">:</span>//db<span class="token punctuation">:</span>5432/sonar
      <span class="token key atrule">SONAR_JDBC_USERNAME</span><span class="token punctuation">:</span> sonar
      <span class="token key atrule">SONAR_JDBC_PASSWORD</span><span class="token punctuation">:</span> sonar
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> sonarqube_data<span class="token punctuation">:</span>/opt/sonarqube/data
      <span class="token punctuation">-</span> sonarqube_extensions<span class="token punctuation">:</span>/opt/sonarqube/extensions
      <span class="token punctuation">-</span> sonarqube_logs<span class="token punctuation">:</span>/opt/sonarqube/logs
      <span class="token punctuation">-</span> sonarqube_temp<span class="token punctuation">:</span>/opt/sonarqube/temp
      <span class="token punctuation">-</span> sonarqube_bundled<span class="token punctuation">-</span>plugins<span class="token punctuation">:</span>/opt/sonarqube/lib/bundled<span class="token punctuation">-</span>plugins
    <span class="token key atrule">ulimits</span><span class="token punctuation">:</span>
      <span class="token key atrule">nproc</span><span class="token punctuation">:</span> <span class="token number">65535</span>
      <span class="token key atrule">nofile</span><span class="token punctuation">:</span>
        <span class="token key atrule">soft</span><span class="token punctuation">:</span> <span class="token number">262144</span>
        <span class="token key atrule">hard</span><span class="token punctuation">:</span> <span class="token number">262144</span>
  <span class="token key atrule">db</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> sonarnet
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">POSTGRES_USER</span><span class="token punctuation">:</span> sonar
      <span class="token key atrule">POSTGRES_PASSWORD</span><span class="token punctuation">:</span> sonar
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> postgresql<span class="token punctuation">:</span>/var/lib/postgresql
      <span class="token punctuation">-</span> postgresql_data<span class="token punctuation">:</span>/var/lib/postgresql/data

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">sonarnet</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge

<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">sonarqube_data</span><span class="token punctuation">:</span>
  <span class="token key atrule">sonarqube_extensions</span><span class="token punctuation">:</span>
  <span class="token key atrule">sonarqube_logs</span><span class="token punctuation">:</span>
  <span class="token key atrule">sonarqube_temp</span><span class="token punctuation">:</span>
  <span class="token key atrule">sonarqube_bundled-plugins</span><span class="token punctuation">:</span>
  <span class="token key atrule">postgresql</span><span class="token punctuation">:</span>
  postgresql_data<span class="token punctuation">:</span></code></pre>

<h4 id="WSL-vm-max-map-count"><a href="#WSL-vm-max-map-count" class="headerlink" title="WSL vm.max_map_count"></a>WSL vm.max_map_count</h4><p>윈도우 환경에서 WSL로 도커 컨테이너를 실행하는 경우 vm.max_map_count로 인하여 소나큐브에서 실행하는 Elasticsearch가 실행되지 않을 수 있습니다. 이 경우 윈도우 터미널에서 WSL로 도커 컨테이너로 접속 후 다음의 명령어를 실행하여 Elasticsearch에서 요구하는 수치로 변경하시면 됩니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh"># Max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]
wsl -d docker-desktop
sysctl -w vm.max_map_count&#x3D;262144</code></pre>

<blockquote>
<p>소나큐브의 관리자 계정과 초기 비밀번호는 admin&#x2F;admin 입니다.</p>
</blockquote>
<h3 id="소나큐브-프로젝트-생성"><a href="#소나큐브-프로젝트-생성" class="headerlink" title="소나큐브 프로젝트 생성"></a>소나큐브 프로젝트 생성</h3><p>소나큐브에 접속하였다면 정적 분석을 수행할 프로젝트를 생성해야합니다. 저는 깃허브 리파지토리 이름을 그대로 사용하는 편입니다.</p>
<p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-01.png" alt="spring5-web-example 프로젝트"></p>
<p>그리고 소나큐브에 로그인할 수 있는 토큰을 발행합니다. </p>
<p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-02.png"></p>
<p>토큰 용도를 구분하기 위한 이름을 지정하는데 저는 Github Action에서 사용할 예정이므로 GITHUB_ACTION을 지정하였습니다.</p>
<p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-03.png"></p>
<p>저는 로컬 컴퓨터에 소나큐브를 실행하였고 필요할때만 포트포워딩을 수행할 예정이므로 토큰을 공개하겠습니다. (어차피 학습 후에 지움…)</p>
<h3 id="소나큐브-관련-코드-추가"><a href="#소나큐브-관련-코드-추가" class="headerlink" title="소나큐브 관련 코드 추가"></a>소나큐브 관련 코드 추가</h3><p>소나큐브 시스템에 프로젝트를 생성하고 토큰을 발급하였기 때문에 소나큐브와 연계할 수 있도록 프로젝트 폴더에 소나큐브와 관련된 코드를 추가하겠습니다.</p>
<h4 id="build-gradle"><a href="#build-gradle" class="headerlink" title="build.gradle"></a>build.gradle</h4><p>만약, 그래들을 통해 소나큐브와 연동하고 싶다면 build.gradle에 SonarQube 플러그인을 추가해야합니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">plugins <span class="token punctuation">&#123;</span>
    id <span class="token interpolation-string"><span class="token string">"org.sonarqube"</span></span> version <span class="token string">'3.3'</span>
    id <span class="token string">'jacoco'</span>
<span class="token punctuation">&#125;</span>

sonarqube <span class="token punctuation">&#123;</span>
  properties <span class="token punctuation">&#123;</span>
    property <span class="token interpolation-string"><span class="token string">"sonar.projectKey"</span></span><span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">"spring5-web-example"</span></span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="sonar-project-properties"><a href="#sonar-project-properties" class="headerlink" title="sonar-project.properties"></a>sonar-project.properties</h4><p>sonar-project.properties 파일은 소나큐브에서 참조하게 되는 설정 파일입니다.</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml">sonar.projectKey=spring5<span class="token punctuation">-</span>web<span class="token punctuation">-</span>example
sonar.projectName=spring5<span class="token punctuation">-</span>web<span class="token punctuation">-</span>example
sonar.java.source=1.11
sonar.sources=src/main/java
<span class="token comment">#sonar.tests=src/main/test</span>
sonar.java.binaries=build/classes/java/main/com/example
sonar.sourceEncoding=UTF<span class="token punctuation">-</span><span class="token number">8</span>
sonar.exclusions=</code></pre>

<h2 id="Github-Action"><a href="#Github-Action" class="headerlink" title="Github Action"></a>Github Action</h2><p><a href="https://github.com/kitabisa/sonarqube-action">SonarQube GitHub Action</a>은 Github Action을 통해 소나큐브로 정적 분석을 수행할 수 있도록 지원합니다.</p>
<h3 id="소나큐브-워크플로우-코드-추가"><a href="#소나큐브-워크플로우-코드-추가" class="headerlink" title="소나큐브 워크플로우 코드 추가"></a>소나큐브 워크플로우 코드 추가</h3><p><strong>.github&#x2F;workflows&#x2F;sonarqube.yml</strong></p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token comment"># schedule:</span>
    <span class="token comment"># - cron: '0 * * * 1'</span>
  <span class="token key atrule">workflow_dispatch</span><span class="token punctuation">:</span>

<span class="token key atrule">name</span><span class="token punctuation">:</span> SonarQube Workflow
<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">build</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> Build
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up JDK 1.11
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> AdoptOpenJDK/install<span class="token punctuation">-</span>jdk@v1
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'11'</span>
        <span class="token key atrule">architecture</span><span class="token punctuation">:</span> x64
        <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token string">'JAVA_HOME'</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Grant execute permission for gradlew
      <span class="token key atrule">run</span><span class="token punctuation">:</span> chmod +x gradlew
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build with Gradle
      <span class="token key atrule">run</span><span class="token punctuation">:</span> ./gradlew build <span class="token punctuation">-</span>x test
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Upload build artifact
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/upload<span class="token punctuation">-</span>artifact@v2
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> build
        <span class="token key atrule">path</span><span class="token punctuation">:</span> build/classes

  <span class="token key atrule">sonarQube</span><span class="token punctuation">:</span>
    <span class="token key atrule">needs</span><span class="token punctuation">:</span> build
    <span class="token key atrule">name</span><span class="token punctuation">:</span> SonarQube
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Donwload build artifact
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/download<span class="token punctuation">-</span>artifact@v2
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> build
        <span class="token key atrule">path</span><span class="token punctuation">:</span> build/classes
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SonarQube Scan
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> kitabisa/sonarqube<span class="token punctuation">-</span>action@master
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> secrets.SONAR_HOST <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">login</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> secrets.SONAR_TOKEN <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">projectBaseDir</span><span class="token punctuation">:</span> <span class="token string">'/github/workspace'</span></code></pre>

<p>소나큐브 워크플로우 파일을 깃허브 리파지토리의 메인 또는 마스터 브랜치에 반영하면 깃허브에서 워크플로우를 등록합니다.</p>
<p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-04.png"></p>
<h3 id="소나큐브-관련-시크릿-생성"><a href="#소나큐브-관련-시크릿-생성" class="headerlink" title="소나큐브 관련 시크릿 생성"></a>소나큐브 관련 시크릿 생성</h3><p>소나큐브 워크플로우에서 사용하는 두가지 시크릿을 깃허브 리파지토리에 설정해야합니다.</p>
<ul>
<li>SONAR_HOST : 소나큐브 호스트 주소</li>
<li>SONAR_TOKEN : 소나큐브에서 발급한 토큰 정보</li>
</ul>
<p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-05.png"></p>
<h3 id="소나큐브-워크플로우-실행"><a href="#소나큐브-워크플로우-실행" class="headerlink" title="소나큐브 워크플로우 실행"></a>소나큐브 워크플로우 실행</h3><p>소나큐브 워크플로우 설정이 완료되었으므로 메인 브랜치를 기준으로 워크플로우를 실행합니다.</p>
<p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-06.png"></p>
<p>프로젝트 코드에 대한 빌드가 정상적으로 수행되고 소나큐브 서버를 통해 정적 분석을 수행되었다면 다음과 같이 워크플로우가 정상적으로 완료됩니다.</p>
<p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-07.png"></p>
<h2 id="정적-분석-결과"><a href="#정적-분석-결과" class="headerlink" title="정적 분석 결과"></a>정적 분석 결과</h2><p>소나큐브 시스템에 접속하여 소나큐브 워크플로우를 실행한 프로젝트의 정적 분석 결과를 확인합니다.</p>
<p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-08.png"></p>
<p>빌드 테스트는 수행하지 않았기 때문에 코드 커버리지는 분석할 수 없었으나 10개의 코드 악취가 발견되었습니다.</p>
<h3 id="코드-악취-검토-및-개선"><a href="#코드-악취-검토-및-개선" class="headerlink" title="코드 악취 검토 및 개선"></a>코드 악취 검토 및 개선</h3><p>정적 분석 결과로 검출된 코드 악취에 대한 내용을 검토하고 이를 개선해보겠습니다.</p>
<h4 id="코드-악취"><a href="#코드-악취" class="headerlink" title="코드 악취"></a>코드 악취</h4><p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-09.png"></p>
<p>첫번째 검출 항목은 연속된 라인을 주석으로 처리한 부분을 제거해야한다는 것입니다. </p>
<p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-10.png"></p>
<p>만약, 이렇게 주석되어있는 것이 남아있어야 한다고 가정하면 다음과 같이 프로젝트에 대한 검출 규칙을 변경할 수 있습니다.</p>
<pre class="language-properties" data-language="properties"><code class="language-properties"><span class="token comment"># Ignore Rules</span>
<span class="token key attr-name">sonar.issue.ignore.multicriteria</span><span class="token punctuation">=</span><span class="token value attr-value">e1,e2</span>
<span class="token key attr-name">sonar.issue.ignore.multicriteria.e1.ruleKey</span><span class="token punctuation">=</span><span class="token value attr-value">java:S125</span>
<span class="token key attr-name">sonar.issue.ignore.multicriteria.e1.resourceKey</span><span class="token punctuation">=</span><span class="token value attr-value">**/*.java</span>
<span class="token key attr-name">sonar.issue.ignore.multicriteria.e2.ruleKey</span><span class="token punctuation">=</span><span class="token value attr-value">java:S1192</span>
<span class="token key attr-name">sonar.issue.ignore.multicriteria.e2.resourceKey</span><span class="token punctuation">=</span><span class="token value attr-value">**/*.java</span></code></pre>

<p>java:S125는 블록으로 된 주석을 남기고 있다는 악취이며 java:S1192는 동일한 문자열을 상수로 취급하지 않는다는 악취입니다. 저는 이것을 악취로 보지 않기 위해서 위와 같이 설정하고 소나큐브 워크플로우를 다시 수행해보겠습니다.</p>
<p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-11.png"></p>
<p>기존에 검출되었던 코드 악취 중 java:S125와 java:S1192에 해당하는 부분이 제외되어 3개의 코드 악취가 줄어들었음을 확인할 수 있습니다. 이렇게 회사 또는 개발팀에서 프로젝트 코드에 대한 규칙을 검토하는 과정을 거쳐야합니다만 저희 회사는 정작 그러지 않고 있어 아쉬움이 많습니다. 체계가 없다보니 무언가 도입을 원하지만 실제로는 제대로 활용하지 않는게 많은 것 같아요.</p>
<p>아무튼 나머지 코드 악취에 대해서도 리팩토링을 수행하여 없애보도록 하면서 마치겠습니다.</p>
<p><img data-src="/images/posts/sonarqube-and-github-action/sonarqube-12.png"></p>
<h4 id="SuppressWarnings"><a href="#SuppressWarnings" class="headerlink" title="@SuppressWarnings"></a>@SuppressWarnings</h4><p>sonar-project.properties에서 제외되도록 정의한 규칙이 패턴에 의한 것이라면 특정 클래스 또는 함수 단위로 규칙을 제외하고 싶은 경우 @SuppressWarnings을 사용할 수 있습니다. </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"squid:S125"</span><span class="token punctuation">,</span><span class="token string">"squid:S1192"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></code></pre>

<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>SonarQube</tag>
        <tag>Github Action</tag>
      </tags>
  </entry>
  <entry>
    <title>프로젝트의 노드 버전 제한하기</title>
    <url>/strict-nodejs-version-for-project/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>오늘은 함께 일하는 개발자들이 프로젝트마다 사용해야하는 노드 버전을 제한하는 방법에 대하여 공유하려고 해요.</p>
<h2 id="프로젝트-노드-버전-제한"><a href="#프로젝트-노드-버전-제한" class="headerlink" title="프로젝트 노드 버전 제한"></a>프로젝트 노드 버전 제한</h2><p>프로젝트에서 사용하는 패키지마다 지원하는 최소 노드 버전이 다를 수 있습니다. 예를 들어, 다음과 같이 패키지 버전이 업데이트되면서 요구하는 노드 버전이 변경될 수 있습니다.</p>
<ul>
<li><a href="https://webpack.js.org/blog/2020-10-10-webpack-5-release/#minimum-nodejs-version">webpack@5.0.0</a> minimum supported Node.js version is 10.13.0</li>
<li><a href="https://github.com/webpack-contrib/style-loader/releases/tag/v3.0.0">style-loader@3.0.0</a> minimum supported Node.js version is 12.13.0</li>
<li><a href="https://github.com/webpack/webpack-dev-server/blob/master/CHANGELOG.md#400-beta3-2021-05-06">webpack-dev-server@4.0.0-beta.3</a> minimum supported Node.js version is 12.13.0</li>
</ul>
<h3 id="Package-json"><a href="#Package-json" class="headerlink" title="Package.json"></a>Package.json</h3><p>Package.json 파일의 <code>engines</code> 속성으로 프로젝트에서 사용하는 NPM 또는 노드 버전을 명시할 수 있습니다.</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"engines"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"npm"</span><span class="token operator">:</span> <span class="token string">">=6.4.1"</span><span class="token punctuation">,</span>
    <span class="token property">"node"</span><span class="token operator">:</span> <span class="token string">">=12.13.0"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="엔진-제한-옵션-활성화"><a href="#엔진-제한-옵션-활성화" class="headerlink" title="엔진 제한 옵션 활성화"></a>엔진 제한 옵션 활성화</h3><p>Package.json 파일에 노드 버전을 명시하더라도 사용자의 엔진을 제한할 수는 없습니다. 이를 별도로 제한하기 위해서는 프로젝트 폴더에 .npmrc 파일을 만들고 <code>engine-strict</code> 옵션을 활성화해야합니다.</p>
<pre class="language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">engine-strict</span><span class="token punctuation">=</span><span class="token value attr-value">true</span></code></pre>

<h3 id="노드-엔진-제한-여부-확인"><a href="#노드-엔진-제한-여부-확인" class="headerlink" title="노드 엔진 제한 여부 확인"></a>노드 엔진 제한 여부 확인</h3><p>노드 버전을 명시하고 엔진 제한 옵션을 활성화하였으므로 실제로 노드 엔진이 제한되는지 확인해보겠습니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">npm i
npm ERR! code ENOTSUP
npm ERR! notsup Unsupported engine for @1.0.0: wanted: &#123;&quot;npm&quot;:&quot;&gt;&#x3D;6.4.1&quot;,&quot;node&quot;:&quot;&gt;&#x3D;12.13.0&quot;&#125; (current: &#123;&quot;node&quot;:&quot;10.23.0&quot;,&quot;npm&quot;:&quot;6.14.8&quot;&#125;)
npm ERR! notsup Not compatible with your version of node&#x2F;npm: @1.0.0
npm ERR! notsup Not compatible with your version of node&#x2F;npm: @1.0.0
npm ERR! notsup Required: &#123;&quot;npm&quot;:&quot;&gt;&#x3D;6.4.1&quot;,&quot;node&quot;:&quot;&gt;&#x3D;12.13.0&quot;&#125;
npm ERR! notsup Actual:   &#123;&quot;npm&quot;:&quot;6.14.8&quot;,&quot;node&quot;:&quot;10.23.0&quot;&#125;</code></pre>

<p>현재 사용중인 노드 버전은 10.23.0 이지만 프로젝트에서 요구하는 버전은 12.13.0 이상이므로 오류가 발생하였습니다.</p>
<p>이상으로 프로젝트에서 지원하는 최소 노드 엔진 버전을 명시하고 프로젝트에 참여하는 모든 개발자들이 알맞은 노드 버전을 사용하도록 안내할 수 있게 되었습니다.</p>
<p>감사합니다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://medium.com/@fabian.illner/force-correct-node-js-version-with-npm-a2a57fd12fa">Force correct Node.js version with npm</a>  </li>
<li><a href="https://www.geeksforgeeks.org/how-to-define-the-required-node-js-version-in-package-json/">How to define the required Node.js version in package.json?</a>  </li>
<li><a href="https://reactgo.com/specify-node-version/">Specifying a required Node.js version in Package.json file</a></li>
</ul>
]]></content>
      <tags>
        <tag>package.json</tag>
        <tag>npmrc</tag>
        <tag>engines</tag>
      </tags>
  </entry>
  <entry>
    <title>타임스탬프 문자열 패턴</title>
    <url>/timestamp-format-patterns/</url>
    <content><![CDATA[<p>현재 조직에서 만드는 시스템에서 특정 언어를 사용하도록 설정된 계정에서만 <a href="https://fullcalendar.io/">캘린더</a>에 입력된 예약 스케줄 정보가 표시되지 않는다는 버그 리포트를 받았습니다. 처음에는 버그 리포트의 내용처럼 캘린더 라이브러리에 언어 정보가 적용되지 않아서 표시되지 않는다고 1차원적으로 예상하였습니다. 그러나 실제로는 예약된 스케줄 정보가 표시되지 않은 이유는 자바스크립트 날짜&#x2F;시간 라이브러리로 사용중인 Moment.js 에서 사용중인 날짜 템플릿 패턴이 올바르게 적용되지 않은 상태로 코드가 작성되어 있었어요.</p>
<h4 id="문제에-대한-원인"><a href="#문제에-대한-원인" class="headerlink" title="문제에 대한 원인"></a>문제에 대한 원인</h4><p>프론트엔드 코드에서 Moment를 사용하여 예약 스케줄에 대한 날짜 정보를 다음과 같은 패턴으로 포맷팅을 하도록 되어있었어요.</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> dateFormat <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'yyyy-MM-DD HH:mm:ss.SSS'</span><span class="token punctuation">)</span></code></pre>

<p>위 코드의 문제점을 바로 알아차리신 분들이라면 공식 문서를 제대로 참고하는 프론트엔드 개발자라고 생각되는데요. <a href="https://momentjs.com/docs/#/displaying/format/">Moment.js의 공식 문서 상 날짜 포맷팅 패턴</a>을 살펴보면 yyyy 라는 표현은 Era Year로 되어있습니다. 현재 시스템은 다국어 지원을 위해서 영어, 한국어, 일본어를 선택할 수 있도록 제공하고 있는데요. 기본적으로는 영어와 한국어를 사용하게 되는데 문제가 발생했던 것은 <a href="https://jsfiddle.net/pcjrk2ob/3">일본어를 선택한 계정에서</a> 였습니다.</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'yyyy-MM-DD HH:mm:ss.SSS'</span><span class="token punctuation">)</span>
<span class="token string">"0004-10-10 17:03:28"</span></code></pre>

<p>신입 프론트엔드 개발자는 개발 환경에서 한국어로 선택된 계정에서 작업을 진행했고 요구사항을 처리하는 과정에서 위 포맷을 적용해도 정상적으로 의도한 날짜 포맷으로 변환되어 작업을 완료했다고 배포 목록에 포함되었을 것입니다.</p>
<h4 id="언어-또는-기술마다-날짜-표현-패턴이-다르다"><a href="#언어-또는-기술마다-날짜-표현-패턴이-다르다" class="headerlink" title="언어 또는 기술마다 날짜 표현 패턴이 다르다"></a>언어 또는 기술마다 날짜 표현 패턴이 다르다</h4><p>위 문제를 경험하고나서 찾아보니 언어마다 혹은 기술마다 날짜를 표현하는 포맷이 달랐는데요. 사용하는 기술에 대해서 좀 더 주의해야겠다는 생각을 가지게 된 것 같습니다.</p>
<ul>
<li><a href="https://docs.oracle.com/javase/8/docs/api/java/time/format/DateTimeFormatter.html#patterns">Java DateTimeFormatter</a> : yyyy-MM-dd HH:mm:ss.SSS</li>
<li><a href="https://www.postgresql.org/docs/current/functions-formatting.html#FUNCTIONS-FORMATTING-DATETIME-TABLE">PostgreSQL Date&#x2F;Time Formatting</a> : YYYY-MM-DD HH24:MI:SS.MS</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/migrate-to-java-time.html#java-time-migration-incompatible-date-formats">Elasticsearch date formats</a> : uuuu-MM-dd HH:mm:ss</li>
</ul>
<blockquote>
<p>개발자의 사소한 실수로부터 만들어진 버그지만 그 내면에는 알아야할 중요한 정보가 남아있습니다. 많은 개발자 분들이 자신이 한 실수에 대해서 공유하는 문화도 만들어지면 좋을 것 같네요. 그리고 이 사이드 이펙트를 만들어낸 것은 조직의 신입 프론트엔드 개발자이지만 코드를 검토해주지 않는 동료 개발자와 제대로 테스트되지 않은 채로 배포된 조직의 문제로 볼 수 있습니다. 조직 내 개발자들이 조금씩이나마 코드 리뷰를 할 수 있는 환경이 만들어지기를 바랍니다.</p>
</blockquote>
]]></content>
      <tags>
        <tag>Elasticsearch</tag>
        <tag>Java</tag>
        <tag>PostgreSQL</tag>
        <tag>Moment</tag>
      </tags>
  </entry>
  <entry>
    <title>Trace OAuth Requests</title>
    <url>/trace-oauth-requests/</url>
    <content><![CDATA[<blockquote>
<p>Failed to find access token</p>
</blockquote>
<p>OAuth API 요청 시 JdbcTokenStore에서 액세스 토큰을 찾을 수 없을 때 기록되는 INFO 레벨의 로그 입니다. 액세스 토큰을 찾을 수 없다는 이야기는 올바르지 않은 요청인데도 불구하고 INFO 레벨로 되어있는 부분에 대해서는 의아하긴 합니다만 위 정보만으로는 어떤 토큰에 의해서 어떠한 OAuth API에 대해 요청되었는지를 확인할 수 없습니다.</p>
<p>일반적으로 인프라 레벨에서 <a href="https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/application/load-balancer-access-logs.html">ELB</a> 또는 <a href="https://docs.nginx.com/nginx/admin-guide/monitoring/logging/#setting-up-the-access-log">Nginx</a>와 같은 프록시 단계에서 액세스 로그를 남기는데 대부분의 액세스 로그에서는 요청 헤더 정보를 상세하게 기록하지 않고 간결하게 남기도록 설정되므로 토큰 정보가 포함되는 Authorization 헤더를 확인할 수 없습니다.</p>
<h2 id="Bearer-Authentication"><a href="#Bearer-Authentication" class="headerlink" title="Bearer Authentication"></a>Bearer Authentication</h2><p>현재 시스템은 Spring Security OAuth 모듈을 통해 JDBC 기반의 Opaque 토큰으로 되어있는 Bearer 인증을 지원하는 OpenAPI를 제공하고 있습니다. 그러나, 일부 사용자들이 IoT 디바이스를 구현 시 OpenAPI를 사용할 때 잘못된 토큰을 사용하는 문제가 사업팀으로부터 리포트 되었는데 단순하게 잘못된 액세스 토큰이 전달되었다는 로그에 대해서 원인 파악을 요구하는데 불구하고 파악할 수 있는 정보가 남아있지 않았습니다.</p>
<p>사실 OpenAPI의 각 핸들러로 전달되는 부분에 대해서는 AOP가 적용되어 핸들러에 대한 파라미터 들과 클라이언트 아이디와 토큰 정보를 이미 엘라스틱서치에 API 로그로 저장하고 있었습니다. 다만 문제는 잘못된 토큰에 대한 요청은 스프링 시큐리티 필터 체인에 의해서 핸들러까지 진입하기 전에 오류 응답으로 처리되었기에 API 로그가 남지 않았다는 것이 파악되었습니다.</p>
<blockquote>
<p>어떠한 문제에 대해서 파악할 수 있는 정보는 남겨야하므로 인증된 사용자가 OpenAPI를 사용한 로그 외에 OAuth에 대한 모든 요청에 대해서는 별도로 남기도록 개선하고자 하였습니다.</p>
</blockquote>
<h3 id="OAuth2AuthenticationProcessingFilter"><a href="#OAuth2AuthenticationProcessingFilter" class="headerlink" title="OAuth2AuthenticationProcessingFilter"></a>OAuth2AuthenticationProcessingFilter</h3><pre class="language-java" data-language="java"><code class="language-java">eventPublisher<span class="token punctuation">.</span><span class="token function">publishAuthenticationFailure</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span>failed<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token keyword">new</span> <span class="token class-name">PreAuthenticatedAuthenticationToken</span><span class="token punctuation">(</span><span class="token string">"access-token"</span><span class="token punctuation">,</span> <span class="token string">"N/A"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>Bearer 토큰에 대한 인증을 처리하는 OAuth2AuthenticationProcessingFilter에서 AuthenticationEventPublisher를 사용하여 인증 성공이나 오류에 대한 이벤트를 발생시키므로 DefaultAuthenticationEventPublisher를 빈으로 등록하고 이벤트 리스너를 구현하면 어떤 토큰을 사용하여 요청했는지는 기록할 수 있는데 이벤트 리스너로 전달되는 이벤트 정보에는 요청과 응답에 대한 정보가 존재하지 않으므로 원하는 만큼의 정보를 로그로 기록할 수 없습니다.</p>
<blockquote>
<p>원하는 기능은 대부분 인터넷에 검색하면 나오기에 이리저리 찾아보았습니다.</p>
</blockquote>
<h3 id="AbstractRequestLoggingFilter"><a href="#AbstractRequestLoggingFilter" class="headerlink" title="AbstractRequestLoggingFilter"></a>AbstractRequestLoggingFilter</h3><p>AbstractRequestLoggingFilter.getMessagePayload 함수를 보면 내부적으로 ContentCachingRequestWrapper를 사용하는 것을 확인할 수 있는데 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/util/ContentCachingResponseWrapper.html">ContentCachingResponseWrapper</a>에 대해서 살펴보니 요청에 대한 응답을 내려준 이후에도 응답 페이로드를 읽을 수 있도록 지원한다는 내용을 확인했습니다.</p>
<blockquote>
<p>잘못된 토큰에 대한 요청의 응답으로 액세스 토큰 정보를 전달하므로 응답 페이로드를 가져올 수 있다면 사용된 토큰을 로그로써 확인할 수 있다는 이야기입니다.</p>
</blockquote>
<h3 id="HttpTraceFilter"><a href="#HttpTraceFilter" class="headerlink" title="HttpTraceFilter"></a>HttpTraceFilter</h3><p>Spring Boot Actuator 모듈을 사용하여 어드민 페이지를 구현해놓았기에 <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.tracing">HttpTraceEndpoint</a>를 통해서 일부 요청에 대한 트레이스 정보를 확인할 수 있는 점을 떠올려 HttpTraceFilter를 살펴보니 TraceableHttpServletRequest와 TraceableHttpServletResponse를 사용하여 요청과 응답에 대한 정보를 가져오는 것을 확인할 수 있었습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isRequestValid</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">TraceableHttpServletRequest</span> traceableRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TraceableHttpServletRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HttpTrace</span> trace <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tracer<span class="token punctuation">.</span><span class="token function">receivedRequest</span><span class="token punctuation">(</span>traceableRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>INTERNAL_SERVER_ERROR<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        status <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">TraceableHttpServletResponse</span> traceableResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TraceableHttpServletResponse</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span>status <span class="token operator">!=</span> response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">CustomStatusResponseWrapper</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> status<span class="token punctuation">)</span> <span class="token operator">:</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tracer<span class="token punctuation">.</span><span class="token function">sendingResponse</span><span class="token punctuation">(</span>trace<span class="token punctuation">,</span> traceableResponse<span class="token punctuation">,</span> request<span class="token operator">::</span><span class="token function">getUserPrincipal</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">getSessionId</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>repository<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>trace<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>단, TraceableHttpServletRequest와 TraceableHttpServletResponse는 final 키워드가 설정된 클래스이므로 다른 패키지에서 활용할 수 없습니다.</p>
</blockquote>
<h3 id="OAuthFilter"><a href="#OAuthFilter" class="headerlink" title="OAuthFilter"></a>OAuthFilter</h3><p>앞서 살펴본 클래스들을 종합하여 OAuth 요청과 응답에 대한 정보를 이벤트로 발생시키는 필터를 구현합니다. </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuthFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationEventPublisherAware</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AntPathMatcher</span> pathMatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HttpExchangeTracer</span> tracer<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DefaultTokenServices</span> defaultTokenServices<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ApplicationEventPublisher</span> applicationEventPublisher<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">OAuthFilter</span><span class="token punctuation">(</span><span class="token class-name">HttpTraceProperties</span> traceProperties<span class="token punctuation">,</span> <span class="token class-name">DefaultTokenServices</span> defaultTokenServices<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tracer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpExchangeTracer</span><span class="token punctuation">(</span>traceProperties<span class="token punctuation">.</span><span class="token function">getInclude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultTokenServices <span class="token operator">=</span> defaultTokenServices<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> requestURI <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> method <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> isApiV1 <span class="token operator">=</span> pathMatcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">"/oauth/v1/**"</span><span class="token punctuation">,</span> requestURI<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isApiV1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">TraceableHttpServletRequest</span> traceableRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TraceableHttpServletRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ContentCachingResponseWrapper</span> cachingResponseWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContentCachingResponseWrapper</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">HttpTrace</span> trace <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tracer<span class="token punctuation">.</span><span class="token function">receivedRequest</span><span class="token punctuation">(</span>traceableRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>INTERNAL_SERVER_ERROR<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> cachingResponseWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                status <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">TraceableHttpServletResponse</span> traceableResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TraceableHttpServletResponse</span><span class="token punctuation">(</span>
                        <span class="token punctuation">(</span>status <span class="token operator">!=</span> response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">CustomStatusResponseWrapper</span><span class="token punctuation">(</span>cachingResponseWrapper<span class="token punctuation">,</span> status<span class="token punctuation">)</span> <span class="token operator">:</span> cachingResponseWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>tracer<span class="token punctuation">.</span><span class="token function">sendingResponse</span><span class="token punctuation">(</span>trace<span class="token punctuation">,</span> traceableResponse<span class="token punctuation">,</span> request<span class="token operator">::</span><span class="token function">getUserPrincipal</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">getSessionId</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">String</span> clientId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationEventPublisher <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">String</span> tokenValue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">OAuth2AuthenticationDetails</span><span class="token punctuation">.</span>ACCESS_TOKEN_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">OAuth2Authentication</span> authentication <span class="token operator">=</span> defaultTokenServices<span class="token punctuation">.</span><span class="token function">loadAuthentication</span><span class="token punctuation">(</span>tokenValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        clientId <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getOAuth2Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvalidTokenException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
                    applicationEventPublisher<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OAuthTraceEvent</span><span class="token punctuation">(</span>trace<span class="token punctuation">,</span> traceableResponse<span class="token punctuation">.</span><span class="token function">getResponseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getSessionId</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setApplicationEventPublisher</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEventPublisher</span> applicationEventPublisher<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applicationEventPublisher <span class="token operator">=</span> applicationEventPublisher<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TraceableHttpServletRequest</span> <span class="token keyword">implements</span> <span class="token class-name">TraceableRequest</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">;</span>

        <span class="token class-name">TraceableHttpServletRequest</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>request <span class="token operator">=</span> request<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">URI</span> <span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> queryString <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>queryString<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> URI<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">StringBuffer</span> urlBuffer <span class="token operator">=</span> <span class="token function">appendQueryString</span><span class="token punctuation">(</span>queryString<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">URI</span><span class="token punctuation">(</span>urlBuffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">URISyntaxException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">String</span> encoded <span class="token operator">=</span> <span class="token class-name">UriUtils</span><span class="token punctuation">.</span><span class="token function">encodeQuery</span><span class="token punctuation">(</span>queryString<span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">StringBuffer</span> urlBuffer <span class="token operator">=</span> <span class="token function">appendQueryString</span><span class="token punctuation">(</span>encoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> URI<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>urlBuffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">private</span> <span class="token class-name">StringBuffer</span> <span class="token function">appendQueryString</span><span class="token punctuation">(</span><span class="token class-name">String</span> queryString<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"?"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>queryString<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">extractHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">getRemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">extractHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> names <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">getHeaderNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>names<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">String</span> name <span class="token operator">=</span> names<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                headers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> headers<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TraceableHttpServletResponse</span> <span class="token keyword">implements</span> <span class="token class-name">TraceableResponse</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HttpServletResponse</span> delegate<span class="token punctuation">;</span>

        <span class="token class-name">TraceableHttpServletResponse</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">extractHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">extractHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> name <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getHeaderNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                headers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> headers<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getResponseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token keyword">instanceof</span> <span class="token class-name">ContentCachingResponseWrapper</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token class-name">ContentCachingResponseWrapper</span> wrapper <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ContentCachingResponseWrapper</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">;</span>
                <span class="token keyword">int</span> status <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">getContentAsByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> buf<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">.</span>length<span class="token punctuation">,</span> wrapper<span class="token punctuation">.</span><span class="token function">getCharacterEncoding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                wrapper<span class="token punctuation">.</span><span class="token function">copyBodyToResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> body<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">CustomStatusResponseWrapper</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServletResponseWrapper</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> status<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">CustomStatusResponseWrapper</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>잘못된 토큰에 대한 응답 처리는 OAuth2AuthenticationProcessingFilter에서 OAuthException을 던지게 되면서 수행하므로 우리는 그전에 응답 페이로드를 캐시하여 가져올 수 있도록 ContentCachingResponseWrapper를 이후 필터로 전달했습니다. </p>
<h4 id="OAuthTraceEvent"><a href="#OAuthTraceEvent" class="headerlink" title="OAuthTraceEvent"></a>OAuthTraceEvent</h4><p>OAuthTraceEvent는 OAuth API에 대한 요청과 응답 정보에서 올바른 토큰으로 요청된 것은 클라이언트 아이디가 존재하므로 요청 헤더 중 Authorization에 포함된 토큰까지 로그로 저장할 필요는 없습니다. 토큰 자체를 제외하기 보다는 토큰의 일부를 마스킹 처리하는 방향으로 구현하였습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Getter</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuthTraceEvent</span> <span class="token keyword">extends</span> <span class="token class-name">ApplicationEvent</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HttpTrace<span class="token punctuation">.</span>Request</span> request<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HttpTrace<span class="token punctuation">.</span>Response</span> response<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HttpTrace<span class="token punctuation">.</span>Principal</span> principal<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HttpTrace<span class="token punctuation">.</span>Session</span> session<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> responseBody<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> clientId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeTaken<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> traceTimestamp<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">OAuthTraceEvent</span><span class="token punctuation">(</span><span class="token class-name">HttpTrace</span> trace<span class="token punctuation">,</span> <span class="token class-name">String</span> responseBody<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> clientId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>trace<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clientId <span class="token operator">=</span> clientId<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientId <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">""</span> <span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">protectAuthorization</span><span class="token punctuation">(</span>trace<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>timeTaken <span class="token operator">=</span> trace<span class="token punctuation">.</span><span class="token function">getTimeTaken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>request <span class="token operator">=</span> trace<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>response <span class="token operator">=</span> trace<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> trace<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>session <span class="token operator">=</span> trace<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>responseBody <span class="token operator">=</span> responseBody<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>traceTimestamp <span class="token operator">=</span> trace<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEpochMilli</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">protectAuthorization</span><span class="token punctuation">(</span><span class="token class-name">HttpTrace</span> trace<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientId <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">""</span> <span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> headers <span class="token operator">=</span> trace<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> authorization <span class="token operator">=</span> headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> authorization<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">String</span> s <span class="token operator">=</span> authorization<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"Bearer"</span><span class="token punctuation">)</span> <span class="token operator">||</span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"bearer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    s <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"(?&lt;=.&#123;19&#125;)."</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    authorization<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>이제 우리는 OAuthTraceEvent를 처리하는 이벤트 리스너에서 애플리케이션 로그 또는 엘라스틱서치에 저장하도록 구현하면 됩니다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://www.baeldung.com/spring-http-logging">Spring – Log Incoming Requests</a>  </li>
<li><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.tracing">Production-ready Features - 8. HTTP Tracing</a></li>
</ul>
]]></content>
      <tags>
        <tag>HttpTrace</tag>
        <tag>ContentCaching</tag>
      </tags>
  </entry>
  <entry>
    <title>원격 호스트로 파일 전송하기</title>
    <url>/transfer-files-to-remote/</url>
    <content><![CDATA[<p>웹 개발자가 백엔드 또는 프론트엔드 코드를 작성하고 서버를 실행할 수 있는 애플리케이션 빌드 파일과 프론트엔드 코드를 실행할 수 있도록 빌드된 에셋 파일들을 하나의 시스템으로써 배포하기 위해서 백엔드 개발자 또는 서버 엔지니어가 구성해놓은 인프라 환경에 있는 리눅스 서버에 파일을 전송해야 합니다. 조직 또는 시스템에 대한 인프라 구성에 따라서 여러가지 방식으로 빌드 파일을 전송할 수 있는데 개인적인 경험을 토대로 원격 호스트에 빌드 파일을 전달하는 방법에 대해서 정리하려고 합니다.</p>
<h4 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h4><p>웹 개발자 또는 서버 엔지니어가 원격 호스트에 파일을 전송하기 위해서는 SCP 또는 SFTP 명령어를 사용할 수 있으며 클라우드 서비스에서 제공하는 S3와 같은 서비스를 통해서도 외부 인터넷으로 접속이 불가능한 환경에서도 파일을 가져올 수 있습니다.</p>
<h4 id="SCP"><a href="#SCP" class="headerlink" title="SCP"></a>SCP</h4><p>SCP 명령어는 SSH 프로토콜을 사용하여 파일을 전송하는 방법으로써 SSH 접속이 가능한 리눅스 서버로 파일을 복사하기 위해서 사용됩니다.</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> C:\Users\Mambo\docker\nginx<span class="token punctuation">.</span>conf> <span class="token function">ls</span>

    디렉터리: C:\Users\Mambo\docker\nginx<span class="token punctuation">.</span>conf

Mode                 LastWriteTime         Length Name
<span class="token operator">--</span><span class="token operator">--</span>                 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>         <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">--</span>
d-<span class="token operator">--</span><span class="token operator">--</span>    2022-02-22  오전 6:49:27                static
<span class="token operator">-</span>a-<span class="token operator">--</span><span class="token operator">-</span>    2022-02-22  오전 6:49:27       19245297 demo-0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1-SNAPSHOT<span class="token punctuation">.</span>jar
<span class="token operator">-</span>a-<span class="token operator">--</span><span class="token operator">-</span>   2022-02-22  오후 11:26:45            473 docker-compose-local<span class="token punctuation">.</span>yaml
<span class="token operator">-</span>a-<span class="token operator">--</span><span class="token operator">-</span>   2022-02-22  오후 11:05:42            573 docker-compose<span class="token punctuation">.</span>yaml
<span class="token operator">-</span>a-<span class="token operator">--</span><span class="token operator">-</span>   2022-02-22  오후 11:26:28            241 localhost+3-key<span class="token punctuation">.</span>pem
<span class="token operator">-</span>a-<span class="token operator">--</span><span class="token operator">-</span>   2022-02-22  오후 11:26:28           1318 localhost+3<span class="token punctuation">.</span>pem
<span class="token operator">-</span>a-<span class="token operator">--</span><span class="token operator">-</span>    2022-05-21  오전 8:13:15           3017 nginx-local<span class="token punctuation">.</span>conf
<span class="token operator">-</span>a-<span class="token operator">--</span><span class="token operator">-</span>   2022-02-22  오후 11:05:40           2896 nginx<span class="token punctuation">.</span>conf
<span class="token operator">-</span>a-<span class="token operator">--</span><span class="token operator">-</span>    2022-02-22  오전 6:49:27           2036 README<span class="token punctuation">.</span>md
<span class="token operator">-</span>a-<span class="token operator">--</span><span class="token operator">-</span>    2022-02-22  오전 6:49:27           1436 server<span class="token punctuation">.</span>crt
<span class="token operator">-</span>a-<span class="token operator">--</span><span class="token operator">-</span>    2022-02-22  오전 6:49:27            246 server<span class="token punctuation">.</span>key

<span class="token comment"># SCP 명령어를 사용해서 로컬 컴퓨터에 있는 파일을 원격 호스트로 전송합니다.</span>
<span class="token function">PS</span> C:\Users\Mambo\docker\nginx<span class="token punctuation">.</span>conf> scp <span class="token punctuation">.</span><span class="token operator">/</span>demo-0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1-SNAPSHOT<span class="token punctuation">.</span>jar ubuntu@192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>0<span class="token punctuation">.</span>18:<span class="token operator">/</span>home/ubuntu/java/
ubuntu@192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>0<span class="token punctuation">.</span>18's password:
demo-0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1-SNAPSHOT<span class="token punctuation">.</span>jar                                                                                                                        100%   18MB  44<span class="token punctuation">.</span>0MB/s   00:00</code></pre>

<blockquote>
<p>제 로컬 컴퓨터에는 가상 환경 머신을 통해서 실행해놓은 우분투 리눅스(192.168.0.18)이 준비되어있으며 위와 같이 demo-0.0.1-SNAPSHOT.jar 라는 빌드 파일이 존재하여 이것을 SCP 명령어를 사용해서 원격 호스트의 사용자 홈 경로 하위의 java라는 폴더에 복사하였습니다.</p>
</blockquote>
<h4 id="SFTP"><a href="#SFTP" class="headerlink" title="SFTP"></a>SFTP</h4><p>일반적으로 FTP 프로토콜을 사용하여 서버와 클라이언트 간의 파일 전송을 수행하는데요. 실무에서는 SFTP를 사용하며 터미널 명령어보다는 <a href="https://filezilla-project.org/">파일질라(FileZilla)</a>와 같은 GUI를 제공하는 FTP 클라이언트를 사용하는 편입니다. SFTP는 서버와 클라이언트 방식이므로 SCP의 단일 명령어로 파일을 전송했던 것과 다르게 대화형 명령어를 사용하여 파일을 전송할 수 있습니다. </p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> C:\Users\Mambo\docker\nginx<span class="token punctuation">.</span>conf> sftp ubuntu@192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>0<span class="token punctuation">.</span>18
ubuntu@192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>0<span class="token punctuation">.</span>18 password:
Connected to ubuntu@192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>0<span class="token punctuation">.</span>18<span class="token punctuation">.</span>
sftp> lls

 C:\Users\Mambo\docker\nginx<span class="token punctuation">.</span>conf 디렉터리

2022-02-27  오전 10:59    &lt;<span class="token function">DIR</span>>          <span class="token punctuation">.</span>
2022-02-27  오전 10:59    &lt;<span class="token function">DIR</span>>          <span class="token punctuation">.</span><span class="token punctuation">.</span>
2022-02-22  오전 06:49        19<span class="token punctuation">,</span>245<span class="token punctuation">,</span>297 demo-0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1-SNAPSHOT<span class="token punctuation">.</span>jar
2022-02-22  오후 11:26               473 docker-compose-local<span class="token punctuation">.</span>yaml
2022-02-22  오후 11:05               573 docker-compose<span class="token punctuation">.</span>yaml
2022-02-22  오후 11:26               241 localhost+3-key<span class="token punctuation">.</span>pem
2022-02-22  오후 11:26             1<span class="token punctuation">,</span>318 localhost+3<span class="token punctuation">.</span>pem
2022-05-21  오전 08:13             3<span class="token punctuation">,</span>017 nginx-local<span class="token punctuation">.</span>conf
2022-02-22  오후 11:05             2<span class="token punctuation">,</span>896 nginx<span class="token punctuation">.</span>conf
2022-02-22  오전 06:49             2<span class="token punctuation">,</span>036 README<span class="token punctuation">.</span>md
2022-02-22  오전 06:49             1<span class="token punctuation">,</span>436 server<span class="token punctuation">.</span>crt
2022-02-22  오전 06:49               246 server<span class="token punctuation">.</span>key
2022-02-22  오전 06:49    &lt;<span class="token function">DIR</span>>          static
              10개 파일          19<span class="token punctuation">,</span>257<span class="token punctuation">,</span>533 바이트
               3개 디렉터리  51<span class="token punctuation">,</span>521<span class="token punctuation">,</span>728<span class="token punctuation">,</span>512 바이트 남음

<span class="token comment"># java 폴더로 이동한 후 파일을 복사합니다.</span>
sftp> cd java
sftp> put demo-0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1-SNAPSHOT<span class="token punctuation">.</span>jar
Uploading demo-0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1-SNAPSHOT<span class="token punctuation">.</span>jar to <span class="token operator">/</span>home/ubuntu/java/demo-0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1-SNAPSHOT<span class="token punctuation">.</span>jar
demo-0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1-SNAPSHOT<span class="token punctuation">.</span>jar                                                                                                                        100%   18MB  68<span class="token punctuation">.</span>8MB/s   00:00</code></pre>

<blockquote>
<p>로컬 컴퓨터에서 명령어를 수행하기 위해서 로컬(l)이 붙은 lls를 먼저 실행하여 로컬 컴퓨터에서 바라보는 경로를 확인하고 원격 호스트에 대한 명령어를 수행해서 파일을 복사했습니다. 그러면 SCP 명령어가 있는데도 불구하고 SFTP 프로토콜을 별도로 사용하는 이유는 무엇일까요?</p>
</blockquote>
<p>SFTP 프로토콜을 별도로 사용하는 이유에 대해서는 자세히 모릅니다. 다만, 개인적인 실무 경험을 토대로 이야기해보자면 배스천 호스트에 대한 SSH 접속 시 OTP로 2FA 인증을 요구하며 <a href="https://aws.amazon.com/ko/blogs/security/how-to-record-ssh-sessions-established-through-a-bastion-host/">배스천 호스트</a>에 대한 명령어 수행을 기록하기 위해서 SCP 명령어와 같이 인터랙션 세션이 아닌 직접 명령어를 수행하는 것은 제한되어 있을 수 있습니다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">    <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>

 /<span class="token comment">#######                        /##     /##</span>
<span class="token operator">|</span> <span class="token comment">##__  ##                      | ##    |__/</span>
<span class="token operator">|</span> <span class="token comment">##  \ ##  /######   /####### /######   /##  /######  /#######</span>
<span class="token operator">|</span> <span class="token comment">#######  |____  ## /##_____/|_  ##_/  | ## /##__  ##| ##__  ##</span>
<span class="token operator">|</span> <span class="token comment">##__  ##  /#######|  ######   | ##    | ##| ##  \ ##| ##  \ ##</span>
<span class="token operator">|</span> <span class="token comment">##  \ ## /##__  ## \____  ##  | ## /##| ##| ##  | ##| ##  | ##</span>
<span class="token operator">|</span> <span class="token comment">#######/|  ####### /#######/  |  ####/| ##|  ######/| ##  | ##</span>
<span class="token operator">|</span>_______/  <span class="token punctuation">\</span>_______/<span class="token operator">|</span>_______/    <span class="token punctuation">\</span>___/  <span class="token operator">|</span>__/ <span class="token punctuation">\</span>______/ <span class="token operator">|</span>__/  <span class="token operator">|</span>__/


<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
    <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
Verification code: ******
This bastion supports interactive sessions only. Do not supply a <span class="token builtin class-name">command</span></code></pre>

<p>이와 같은 인프라 환경에서는 SFTP 서버에 업로드되는 파일들은 배스천 호스트의 특정 경로에 마운트되어 SSH 접속을 수행한 후 SCP 명령어를 사용해서 실제 리눅스 서버로 파일을 전달할 수 있습니다. SFTP 명령어에 대한 더 자세한 내용을 알고싶은 경우 <a href="https://www.digitalocean.com/community/tutorials/how-to-use-sftp-to-securely-transfer-files-with-a-remote-server">How To Use SFTP to Securely Transfer Files with a Remote Server</a>를 참고하면 좋습니다.</p>
<h4 id="S3"><a href="#S3" class="headerlink" title="S3"></a>S3</h4><p>요즘에는 IDC와 같은 온프레미스 환경보다는 AWS와 같은 클라우드 서비스 환경에 인프라를 구성하는 경우가 많습니다. AWS 에서는 S3라는 스토리지 서비스를 제공하는데 S3 버킷에 대한 권한을 가지는 IAM의 자격증명을 사용해서 쉽게 파일을 업로드할 수 있고 EC2 인스턴스 역할에 S3 버킷에 대한 접근 권한을 부여해놓으면 EC2 인스턴스 내에서도 S3 명령어를 사용해서 파일을 가져올 수 있습니다. </p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token comment"># 로컬 컴퓨터에 있는 파일을 S3 버킷에 복사합니다.</span>
aws s3 <span class="token function">cp</span> demo-0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1-SNAPSHOT<span class="token punctuation">.</span>jar s3:<span class="token operator">/</span><span class="token operator">/</span>mambo<span class="token punctuation">.</span>kr/java/ <span class="token operator">--</span>profile mambo

<span class="token comment"># EC 인스턴스 내에서 S3 버킷에 있는 파일을 복사합니다.</span>
aws s3 <span class="token function">cp</span> s3:<span class="token operator">/</span><span class="token operator">/</span>mambo<span class="token punctuation">.</span>kr/java/demo-0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1-SNAPSHOT<span class="token punctuation">.</span>jar <span class="token punctuation">.</span><span class="token operator">/</span></code></pre>

<blockquote>
<p>현재 조직에서는 퍼블릭 액세스가 불가능한 버킷에 도메인 인증서 또는 일부 데이터베이스에 대한 패치 스크립트 등을 업로드하고 리눅스 서버에 접속하여 해당 파일들을 복사하여 사용하고 있습니다. 퍼블릭 액세스가 가능하도록 설정된 버킷에 파일을 업로드해두면 조직의 외부로 파일을 공유해야할 때 HTTP 엔드포인트를 전달할 수 있으므로 다양하게 활용할 수도 있습니다.</p>
</blockquote>
<p>이처럼 원격 호스트에 파일을 전송하는 방법은 인프라 구성에 따라서 다양하게 사용해야할 수 있습니다. IT 분야가 어려운 이유는 생각보다 다양한 부분에 대해서 정답이라는 방식이 없기 때문에 개발자마다 조직에서 어떠한 방식을 취하느냐에 따라 다양한 경험을 할 수 있다는 것에 있습니다.</p>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>S3</tag>
        <tag>SSH</tag>
        <tag>SCP</tag>
        <tag>SFTP</tag>
      </tags>
  </entry>
  <entry>
    <title>우분투 리눅스 서버 환경 구축하기</title>
    <url>/ubuntu-linux/</url>
    <content><![CDATA[<p>일반적으로 웹 개발자는 리눅스 서버 및 인프라 환경을 직접적으로 구축할 일은 없다고 말합니다. 그러나, 조직 규모에 따라 인프라 팀 또는 서버 엔지니어가 인프라를 구성할수도 있고 웹 개발자가 클라우드 서비스를 이용해서 간단하게 리눅스 서버를 실행할 수도 있습니다. 이전 회사의 서버 엔지니어이셨던 부장님이 현재 조직에 오기전까지는 사내 개발자들이 인프라를 작게나마 담당하고 있었습니다.</p>
<p>사내 인프라 환경을 마음껏 사용할 수 있는 조직이 아니고서야 리눅스 서버를 쉽게 실행해볼 수 있는 환경은 없기 때문에 웹 개발자가 로컬 컴퓨터에 가상 머신을 통해 우분투와 같은 리눅스 배포판을 설치할 수 있어야하며 이를 통해 리눅스 서버에 대한 경험을 학습해볼 수 있습니다. 실무에서 어느 정도 규모가 있는 기업에서는 CentOS와 같은 RHEL 기반의 리눅스 배포판을 사용하는 경우가 많은데 데비안 계열의 우분투 리눅스도 많이 발전하여 이제는 안정성 있는 LTS 버전을 제공하므로 최근에는 많이 활용되고 있습니다.</p>
<blockquote>
<p>CentOS EOL 문제로 인하여 실제로 CentOS 대체제 중 하나인 <a href="https://almalinux.org/">AlmaLinux</a>를 사용하여 인프라를 구성한 고객 환경도 있으며 일부 산업 업계에서는 리눅스 보다는 윈도우 서버를 사용하게 되는 환경도 존재합니다. 현재 조직에서 사용하는 시계열 데이터베이스도 <a href="https://aws.amazon.com/marketplace/pp/prodview-pscy5dov2ftms#pdp-overview">AWS 마켓플레이스에서 우분투 이미지로 제공</a>하고 있습니다.</p>
</blockquote>
<p>아무튼 많은 웹 개발자들도 집에서는 윈도우 OS가 설치된 컴퓨터를 사용하기 때문에 윈도우 10에서 <a href="https://www.virtualbox.org/">Oracle VM VirtualBox</a> 또는 <a href="https://learn.microsoft.com/ko-kr/windows/wsl/about">WSL2(Windows Subsystem for Linux 2)</a>를 사용하여 리눅스 서버 환경을 구축할 수 있다고 말할 수 있습니다. 단일 우분투 서버가 필요하다면 WSL2를 활성화하고 간단하게 우분투 리눅스를 실행할 수 있지만 다양한 우분투 버전 또는 다수의 우분투 리눅스가 필요하다고 생각된다면 가상 머신을 활용하는게 좋습니다.</p>
<h4 id="WSL2"><a href="#WSL2" class="headerlink" title="WSL2"></a>WSL2</h4><p><a href="https://aka.ms/wslstore">Microsoft Store</a>에서 다양한 리눅스 배포판을 설치할 수 있는데 CentOS는 인터넷 검색을 통해서 별도로 설치해야하므로 본 글의 목표인 데비안 계열의 <a href="https://www.microsoft.com/store/productId/9PN20MSR04DW">우분투 리눅스 배포판</a>을 선택하여 설치하기를 바랍니다. WSL2를 설치하기 전에 <a href="https://www.microsoft.com/store/productId/9N0DX20HK701">윈도우 터미널</a>을 먼저 설치하여 사용하는 것을 추천하며 컴퓨터에 윈도우 터미널을 설치하였다면 관리자 권한으로 실행한 후 아래의 명령어를 통해서 Windows System for Linux 기능을 활성화 해야합니다.</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell">dism<span class="token punctuation">.</span>exe <span class="token operator">/</span>online <span class="token operator">/</span><span class="token function">enable-feature</span> <span class="token operator">/</span>featurename:Microsoft-Windows-Subsystem-Linux <span class="token operator">/</span>all <span class="token operator">/</span>norestart
dism<span class="token punctuation">.</span>exe <span class="token operator">/</span>online <span class="token operator">/</span><span class="token function">enable-feature</span> <span class="token operator">/</span>featurename:VirtualMachinePlatform <span class="token operator">/</span>all <span class="token operator">/</span>norestart</code></pre>

<p><img data-src="/images/posts/ubuntu-linux/01.png"></p>
<p>위 명령어를 수행하여 WSL 기능을 활성화했다면 <a href="https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi">WSL2 리눅스 커널</a>을 다운로드하여 설치한 후 관리자 권한의 윈도우 터미널을 열고 WSL2 버전을 선택하면 끝입니다.</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell">wsl <span class="token operator">--</span><span class="token function">set-default</span><span class="token operator">-</span>version 2</code></pre>

<p><img data-src="/images/posts/ubuntu-linux/02.png"></p>
<blockquote>
<p>만약, WSL2를 사용하여 우분투 리눅스 배포판을 실행하는데 실패하였다면 다음의 가이드 문서를 따르기를 바란다.<br><a href="https://learn.microsoft.com/ko-kr/windows/terminal/install">Windows 터미널 설치 및 설정 시작</a><br><a href="https://learn.microsoft.com/ko-kr/windows/wsl/install?source=recommendations">WSL을 사용하여 Windows에 Linux 설치</a><br><a href="https://ubuntu.com/tutorials/install-ubuntu-on-wsl2-on-windows-10#1-overview">Install Ubuntu on WSL2 on Windows 10</a></p>
</blockquote>
<h4 id="VirtualBox"><a href="#VirtualBox" class="headerlink" title="VirtualBox"></a>VirtualBox</h4><p>WSL2를 사용해도 다양한 버전의 우분투 리눅스를 설치할 수 있지만 버츄얼박스와 같은 가상 머신으로 기본적인 리눅스 설정이 완료된 클린 버전을 만들어두고 이미지를 복제하여 리눅스 서버를 실행하는게 학습하는데 도움이 된다고 생각합니다. 먼저, <a href="https://www.virtualbox.org/wiki/Downloads">윈도우용 버츄얼박스</a>와 함께 <a href="https://ubuntu.com/download/server">우분투 서버 이미지</a>에 대한 ISO 파일을 다운로드하여 준비합니다.</p>
<p><img data-src="/images/posts/ubuntu-linux/03.png"><br><img data-src="/images/posts/ubuntu-linux/04.png"><br><img data-src="/images/posts/ubuntu-linux/05.png"></p>
<blockquote>
<p>가상 머신으로 우분투를 설치하는 경우에는 기본적인 데스크톱 이미지 대신에 서버 이미지를 사용하는 것이 좋습니다. 일반적이지 않은 폐쇄망 환경(아이피를 오픈하지 않는)에서 원격 데스크톱 환경이 필요한 경우에는 데스크톱을 설치하는 경우도 있는데 원격 데스크톱 연결에 대한 여러가지 문제가 있기 때문에 이러한 환경에서는 윈도우 서버를 사용하게 되는 편입니다.</p>
</blockquote>
<p>우분투 리눅스를 실행하기 위한 가상 머신은 최소한 메모리 1GB, 디스크 볼륨 30GB 로 선택하는 것을 추천하는데 이는 AWS 클라우드 서비스에서 제공하는 프리티어 사양과 동일하기 때문입니다. 또한 공유기를 사용하여 로컬 아이피를 할당받아 컴퓨터를 사용하고 있다면 네트워크 유형을 NAT가 아닌 호스트 어댑터로 변경하여 공유기에서 별도의 IP를 할당받도록 하는게 좋습니다.</p>
<p><img data-src="/images/posts/ubuntu-linux/06.png"></p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> C:\Users\Mambo> ssh ubuntu@192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>0<span class="token punctuation">.</span>31
The authenticity of host <span class="token string">'192.168.0.31 (192.168.0.31)'</span> can<span class="token string">'t be established.
ECDSA key fingerprint is SHA256:BJ3p2IZBDv3Im2I1Nsfj93KPSQcB4SAIxG9bOEbTPCU.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>0<span class="token punctuation">.</span>31<span class="token string">' (ECDSA) to the list of known hosts.
ubuntu@192.168.0.31'</span>s password:
Welcome to Ubuntu 22<span class="token punctuation">.</span>04<span class="token punctuation">.</span>1 LTS <span class="token punctuation">(</span>GNU/Linux 5<span class="token punctuation">.</span>15<span class="token punctuation">.</span>0-50-generic x86_64<span class="token punctuation">)</span>

 <span class="token operator">*</span> Documentation:  https:<span class="token operator">/</span><span class="token operator">/</span>help<span class="token punctuation">.</span>ubuntu<span class="token punctuation">.</span>com
 <span class="token operator">*</span> Management:     https:<span class="token operator">/</span><span class="token operator">/</span>landscape<span class="token punctuation">.</span>canonical<span class="token punctuation">.</span>com
 <span class="token operator">*</span> Support:        https:<span class="token operator">/</span><span class="token operator">/</span>ubuntu<span class="token punctuation">.</span>com/advantage

  System information as of Thu Oct 13 01:11:59 AM UTC 2022

  System load:  0<span class="token punctuation">.</span>6376953125       Processes:               104
  Usage of <span class="token operator">/</span>:   33<span class="token punctuation">.</span>0% of 13<span class="token punctuation">.</span>67GB   Users logged in:         0
  Memory usage: 22%                IPv4 address <span class="token keyword">for</span> enp0s3: 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>0<span class="token punctuation">.</span>31
  Swap usage:   0%


39 updates can be applied immediately<span class="token punctuation">.</span>
To see these additional updates run: apt list <span class="token operator">--</span>upgradable


Last login: Thu Oct 13 01:12:00 2022
To run a command as administrator <span class="token punctuation">(</span>user <span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> use <span class="token string">"sudo &lt;command>"</span><span class="token punctuation">.</span>
See <span class="token string">"man sudo_root"</span> <span class="token keyword">for</span> details<span class="token punctuation">.</span>

ubuntu@ubuntu:~$</code></pre>

<p>리눅스 서버가 준비되었다면 위와 같이 로컬 컴퓨터에서 SSH 접속을 시도해볼 수 있습니다. 언급하지 않은 부분이기에 우분투 리눅스를 설치할 때 OpenSSH를 함께 설치하는 옵션을 선택하지 않았다면 가상 머신 콘솔창에서 OpenSSH 서버 패키지를 설치해보는 경험을 할 수도 있습니다. 이제 우분투 리눅스를 어떻게 활용할 수 있는가는 우리가 무엇을 하고 싶은가에 달려있습니다. </p>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>Ubuntu</tag>
        <tag>WSL2</tag>
        <tag>VirtualBox</tag>
      </tags>
  </entry>
  <entry>
    <title>언더토우 임시 디렉토리 삭제 방지</title>
    <url>/undertow-temp-dir/</url>
    <content><![CDATA[<blockquote>
<p><a href="https://github.com/spring-projects/spring-boot/issues/9616">Tomcat does not create temporary directory used to store file uploads when it does not exist</a><br><a href="https://adunhansa.tistory.com/209">스프링 부트 파일 업로드 에러 The temporary upload location []  is not valid</a></p>
</blockquote>
<p>일반적으로 자주 발생하는 상황은 아니지만 아래와 같이 파일 업로드 시 임시 디렉토리에 대한 삭제 문제로 멀티파트 요청에 대해 임시적으로 저장하는 과정에서 <code>NoSuchFileException</code>이 발생할 수 있습니다. 리눅스 시스템에서 임시 디렉토리 경로에 존재하는 파일이나 디렉토리를 일정 기간 사용하지 않았을 경우 삭제하도록 되어있는 부분으로 인하여 애플리케이션 서버로 파일 업로드가 주기적으로 요청되지 않는 한 멀티파트에 대한 임시 파일이 만들어지지 않으므로 위 현상이 나타나게 됩니다.</p>
<p>언더토우에서는 MultiPartParserDefinition$MultiPartUploadHandler의 beginPart라는 함수에서 멀티파트 폼 데이터에 대해 임시 파일을 만들고 읽어들이도록 되어있습니다. 스프링 부트 기반의 애플리케이션 서버에서 멀티파트에 대한 로케이션 속성을 지정하지 않으면 언더토우는 서블릿 배포 시 시스템의 임시 디렉토리 경로에 멀티파트 업로드를 위한 폴더를 생성합니다.</p>
<p><a href="https://github.com/kdevkr/spring-demo-undertow">Spring Demo Undertow</a> 리파지토리를 클론하여 애플리케이션을 실행하면 다음과 같이 현재 실행중인 애플리케이션 서버에서 바라보는 파일 업로드 경로가 로그로 출력됩니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Current</span> temp dir<span class="token operator">:</span> <span class="token class-name">C</span><span class="token operator">:</span>\<span class="token class-name">Users</span>\<span class="token class-name">Mambo</span>\<span class="token class-name">AppData</span>\<span class="token class-name">Local</span>\<span class="token class-name">Temp</span>\undertow<span class="token punctuation">.</span><span class="token number">8080.5583604686546214060</span></code></pre>

<p>위 로그를 출력하는 MultipartCustomizer는 UndertowDeploymentInfoCustomizer 인터페이스를 구현한 클래스로 시스템 기본 임시 디렉토리를 사용하는 경우에 주기적인 스케줄로 파일 업로드 경로가 삭제되었는지를 확인하고 복구합니다. 멀티파트 요청에 대한 파일 업로드 경로를 별도로 지정하지 않은 리눅스 환경에서는 파일 업로드를 시도하는 경우에 따라 리눅스 시스템에서 파일 업로드를 위한 폴더를 삭제할 가능성을 내재하고 있으므로 애플리케이션을 재실행하지 않아도 자동적으로 처리하거나 삭제를 방지하는 것을 도와주는 트릭을 구현할 수 있습니다.</p>
<blockquote>
<p>멀티파트 요청이 정상적으로 수행하는 경우 만들어진 임시 파일이 자동적으로 삭제되므로 시스템 기본 임시 디렉토리를 사용하는 것보다는 별도의 파일 업로드 경로를 지정하고 주기적으로 삭제되지 않고 남아있는 파일들이 있는지 관리하는 것이 더 좋은 대안입니다.</p>
</blockquote>
]]></content>
      <tags>
        <tag>MultiPartParserDefinition</tag>
        <tag>MultipartConfigElement</tag>
        <tag>UndertowDeploymentInfoCustomizer</tag>
      </tags>
  </entry>
  <entry>
    <title>Tracing Handshake Websocket With Undertow</title>
    <url>/undertow-websocket-tracing/</url>
    <content><![CDATA[<blockquote>
<p>Handshake failed due to invalid Upgrade header: null</p>
</blockquote>
<p>본 글은 위와 같은 웹 소켓 연결 시에 애플리케이션 오류 로그가 발생한 건에 대한 관련 내용을 기록하기 위한 것 입니다. 이 오류 로그는 스프링 웹 소켓 모듈에서 DefaultHandshakeHandler를 통해 핸드쉐이크를 수행하는 과정에서 올바르지 않은 웹 소켓 연결에 대해 오류 로그로 기록하도록 되어있는데 Upgrade 헤더에 올바르지 않은 값이 전달되었다는 의미입니다.</p>
<blockquote>
<p>Connection: Upgrade<br>Upgrade: websocket</p>
</blockquote>
<p>일반적으로 웹 소켓 연결은 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Protocol_upgrade_mechanism">Protocol upgrade mechanism</a>으로 HTTP 통신에 대해 커넥션을 전환하는 과정을 거치게 되는데 서버에서는 웹소켓 엔드포인트에 해당하는 요청에 대해서는 Upgrade 헤더를 확인하고 websocket 이 전달되었는지를 확인합니다.</p>
<h2 id="웹소켓-프록시"><a href="#웹소켓-프록시" class="headerlink" title="웹소켓 프록시"></a>웹소켓 프록시</h2><p>시스템이 동작하는 인프라 환경은 AWS 클라우드 서비스로 구성되어 있습니다. 일반적으로 로드밸런싱을 위해서 사용하는 <a href="https://aws.amazon.com/ko/elasticloadbalancing/features/#Product_comparisons">Elastic Load Balancing 기능</a>에 따르면 ALB, NLB 모두 웹소켓을 지원한다고 되어있으므로 웹소켓 연결에 제한적인 환경은 아닙니다. 현재 조직에서 플랫폼으로써 제공하는 환경은 EC 키 기반의 인증서의 제약사항으로 NLB를 사용해서 TCP 프록시를 수행하고 SSL 오프로드는 Nginx에서 수행한 후 애플리케이션 서버로 트래픽이 전달되는 구조입니다.</p>
<p>다만, 위 문제가 발생했다고 안내된 특정 고객이 직접 구성하는 환경에서는 ELB 레벨에서 SSL 오프로드를 수행한 후의 트래픽만 Nginx로 전달되어 애플리케이션 서버로 프록시되므로 약간의 요청이 전달되는 방식이 다릅니다. 따라서, ELB 레벨에서 트래픽을 전달하는 과정에서 Upgrade 헤더가 유실될 가능성도 의심해볼 수 있습니다. </p>
<blockquote>
<p>각 환경의 Nginx에는 <a href="http://nginx.org/en/docs/http/websocket.html">Upgarde 헤더에 대한 프록시 구성</a>에 따라 Upgarde 헤더 값을 애플리케이션으로 전달되도록 $http_upgrade 변수가 설정되어 있습니다.</p>
</blockquote>
<h3 id="타임아웃"><a href="#타임아웃" class="headerlink" title="타임아웃"></a>타임아웃</h3><p>일반적으로 AWS 클라우드 환경에서 ELB를 사용할 때 웹소켓 연결 문제가 발생할 수 있습니다. 이는 <a href="https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/application/application-load-balancers.html#load-balancer-attributes">ELB 로드밸런서 속성</a>의 idle_timeout.timeout_seconds 기본값이 60초 이어서 발생하는 부분에 대해서는 타임아웃을 90초로 설정되어 웹 소켓 연결에 대한 부분은 정상적으로 유지하는 상태입니다.</p>
<blockquote>
<p>클라이언트의 초기 연결을 제외하고는 서버에서 1분마다 스케줄에 의해 어떠한 메시지를 전달하는데 서버가 전달하는 타이밍 상 60초 이내에 전달되는 트래픽이 없다고 판단되어 연결이 해지될 수 있습니다.</p>
</blockquote>
<h3 id="HTTP2"><a href="#HTTP2" class="headerlink" title="HTTP2"></a>HTTP2</h3><p>일반적인 웹 요청은 HTTP2로 연결될 수 있도록 지원하고 있는데 웹소켓에 대한 연결에 대해서는 HTTP 1.1의 업그레이드 매커니즘을 사용해야 합니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">curl --include \
     --no-buffer \
     --http1.1 \
     --location \
     --header &quot;Connection: Upgrade&quot; \
     --header &quot;Upgrade: websocket&quot; \
     --header &quot;Host: example.com&quot; \
     --header &quot;Origin: https:&#x2F;&#x2F;example.com&quot; \
     --header &quot;Sec-WebSocket-Key: SGVsbG8sIHdvcmxkIQ&#x3D;&#x3D;&quot; \
     --header &quot;Sec-WebSocket-Version: 13&quot; \
     https:&#x2F;&#x2F;example.com&#x2F;websocket&#x2F;server&#x2F;sessionid&#x2F;websocket</code></pre>

<p>그런데 위 cURL 명령어에서 –http1.1 옵션을 제외하면 Upgarde 헤더에 websocket에 전달되지 않는 상황이 발생함을 확인하였습니다. 결국 일반적인 브라우저를 통한 요청이 아니라 특정 클라이언트가 직접 웹소켓 연결을 시도할 가능성도 있다는 이야기 입니다.</p>
<blockquote>
<p><a href="https://github.com/websockets/wscat">wscat</a> 또는 <a href="https://learning.postman.com/docs/sending-requests/websocket/websocket/">postman</a> 으로도 웹 소켓 연결을 시도해보았지만 정상적으로 연결됨을 확인할 수 있었습니다.</p>
</blockquote>
<h2 id="스프링-웹-소켓"><a href="#스프링-웹-소켓" class="headerlink" title="스프링 웹 소켓"></a>스프링 웹 소켓</h2><p>시스템 입장에서는 올바르지 않은 웹소켓 연결이 요청되는 부분이므로 해당 오류 로그만으로는 어떻게 요청되었는가를 검토할 수 있는 방안이 없습니다. 스프링 웹 소켓 모듈에서 요청 정보를 기록할 수 있는 방안을 찾아보도록 합시다. </p>
<h3 id="RequestUpgradeStrategy"><a href="#RequestUpgradeStrategy" class="headerlink" title="RequestUpgradeStrategy"></a>RequestUpgradeStrategy</h3><p>RequestUpgradeStrategy는 HTTP 요청에 대해서 웹 소켓 연결로 업그레이드하기 위한 전략이며 언더토우를 사용하고 있다면 UndertowRequestUpgradeStrategy가 사용됩니다. </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomRequestUpgradeStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">UndertowRequestUpgradeStrategy</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">upgradeInternal</span><span class="token punctuation">(</span><span class="token class-name">ServerHttpRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServerHttpResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">String</span> selectedProtocol<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Extension</span><span class="token punctuation">></span></span> selectedExtensions<span class="token punctuation">,</span> <span class="token class-name">Endpoint</span> endpoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">HandshakeFailureException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// NOTE: 핸드쉐이크 과정에서 검증된 요청에 대해서 업그레이드를 수행한다.</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">upgradeInternal</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> selectedProtocol<span class="token punctuation">,</span> selectedExtensions<span class="token punctuation">,</span> endpoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>위 처럼 업그레이드를 수행하는 과정에서 요청과 응답에 대해 부가 처리를 수행할 수 있습니다만 DefaultHandshakeHandler 라는 클래스에서 upgradeInternal 함수가 호출되는 위치를 살펴보면 웹 소켓 연결 요청에 대해서 검증을 수행하고나서 마지막에 upgradeInternal 함수가 호출되므로 본 문제가 발생했을때는 요청 정보를 파악할 수 없습니다.</p>
<h3 id="DefaultHandshakeHandler"><a href="#DefaultHandshakeHandler" class="headerlink" title="DefaultHandshakeHandler"></a>DefaultHandshakeHandler</h3><p>DefaultHandshakeHandler는 스프링 웹 소켓 모듈에서 기본적으로 사용하는 웹 소켓 연결을 수행하는 핸들러로 HandshakeHandler로 등록된 빈이 없다면 내부적으로 DefaultHandshakeHandler를 생성하여 사용하도록 되어있습니다. 앞서 RequestUpgradeStrategy를 이용할 수 없는 이유를 확인하기 위해 핸드쉐이크를 수행하는 코드를 살펴보도록 하겠습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AbstractHandshakeHandler</span> <span class="token keyword">implements</span> <span class="token class-name">HandshakeHandler</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">doHandshake</span><span class="token punctuation">(</span><span class="token class-name">ServerHttpRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServerHttpResponse</span> response<span class="token punctuation">,</span>
			<span class="token class-name">WebSocketHandler</span> wsHandler<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> attributes<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">HandshakeFailureException</span> <span class="token punctuation">&#123;</span>

		<span class="token class-name">WebSocketHttpHeaders</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketHttpHeaders</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Processing request "</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" with headers="</span> <span class="token operator">+</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>GET <span class="token operator">!=</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>METHOD_NOT_ALLOWED<span class="token punctuation">)</span><span class="token punctuation">;</span>
				response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAllow</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singleton</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isErrorEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Handshake failed due to unexpected HTTP method: "</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"WebSocket"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>headers<span class="token punctuation">.</span><span class="token function">getUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token function">handleInvalidUpgradeHeader</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headers<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"Upgrade"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>headers<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"upgrade"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token function">handleInvalidConnectHeader</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isWebSocketVersionSupported</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token function">handleWebSocketVersionNotSupported</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isValidOrigin</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>FORBIDDEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token class-name">String</span> wsKey <span class="token operator">=</span> headers<span class="token punctuation">.</span><span class="token function">getSecWebSocketKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>wsKey <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isErrorEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Missing \"Sec-WebSocket-Key\" header"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">&#125;</span>
				response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>BAD_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HandshakeFailureException</span><span class="token punctuation">(</span>
					<span class="token string">"Response update failed during upgrade to WebSocket: "</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token class-name">String</span> subProtocol <span class="token operator">=</span> <span class="token function">selectProtocol</span><span class="token punctuation">(</span>headers<span class="token punctuation">.</span><span class="token function">getSecWebSocketProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wsHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebSocketExtension</span><span class="token punctuation">></span></span> requested <span class="token operator">=</span> headers<span class="token punctuation">.</span><span class="token function">getSecWebSocketExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebSocketExtension</span><span class="token punctuation">></span></span> supported <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestUpgradeStrategy<span class="token punctuation">.</span><span class="token function">getSupportedExtensions</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebSocketExtension</span><span class="token punctuation">></span></span> extensions <span class="token operator">=</span> <span class="token function">filterRequestedExtensions</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> requested<span class="token punctuation">,</span> supported<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Principal</span> user <span class="token operator">=</span> <span class="token function">determineUser</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> wsHandler<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Upgrading to WebSocket, subProtocol="</span> <span class="token operator">+</span> subProtocol <span class="token operator">+</span> <span class="token string">", extensions="</span> <span class="token operator">+</span> extensions<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>requestUpgradeStrategy<span class="token punctuation">.</span><span class="token function">upgrade</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> subProtocol<span class="token punctuation">,</span> extensions<span class="token punctuation">,</span> user<span class="token punctuation">,</span> wsHandler<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>AbstractHandshakeHandler 클래스에 대해 로그 레벨을 Trace로 설정하면 요청 정보를 로그로 기록할 수 있지만 모든 요청에 대해서 기록하므로 문제가 발생했을때만 요청 정보를 남길 수 없습니다.</p>
</blockquote>
<h4 id="AbstractHandshakeHandler-handleInvalidUpgradeHeader"><a href="#AbstractHandshakeHandler-handleInvalidUpgradeHeader" class="headerlink" title="AbstractHandshakeHandler.handleInvalidUpgradeHeader"></a>AbstractHandshakeHandler.handleInvalidUpgradeHeader</h4><p>앞서 doHandshake 함수를 살펴본 결과 Upgrade 헤더에 올바르지 않은 값이 전달되는 경우에는 handleInvalidUpgradeHeader 함수를 호출하는 것을 확인할 수 있습니다. 이제 우리는 handleInvalidUpgradeHeader 함수를 오버라이드 하여 요청 정보를 확인하고 오류 로그로 기록할 수 있는 위치를 알게 되었습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomHandshakeHandler</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultHandshakeHandler</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">handleInvalidUpgradeHeader</span><span class="token punctuation">(</span><span class="token class-name">ServerHttpRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServerHttpResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// NOTE: Upgrade 헤더에 올바르지 않은 값이 전달되었을때 호출된다.</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Method: &#123;&#125;, URI: &#123;&#125;, Principal: &#123;&#125;, Headers: &#123;&#125;"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMethodValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">handleInvalidUpgradeHeader</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>애플리케이션 레벨에서는 Upgrade 헤더에 올바르지 않은 값이 전달되는 경우에 대해서 원인을 파악하기는 어렵습니다. 그럼에도 불구하고 본 문제가 다시 발생했을 때 어떤 정보로 요청되었는지에 대한 로그가 기록되었으므로 원인 파악을 위한 실마리를 찾을 수 있는 방안을 마련할 수 있게 됩니다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Protocol_upgrade_mechanism">Protocol upgrade mechanism</a></li>
<li><a href="https://aws.amazon.com/ko/elasticloadbalancing/features/#Product_comparisons">Elastic Load Balancing 기능</a></li>
<li><a href="http://nginx.org/en/docs/http/websocket.html">WebSocket proxying</a></li>
</ul>
]]></content>
      <tags>
        <tag>Undertow</tag>
        <tag>WebSocket</tag>
      </tags>
  </entry>
  <entry>
    <title>유닉스 타임스탬프와 시간 정밀도</title>
    <url>/unix-timestamp/</url>
    <content><![CDATA[<p>각 나라에서 사용하는 표준 시간은 다르고 동일한 나라에서도 여러가지 시간 기준이 존재합니다. 그러나, 개발자들은 사람마다 다른 시간을 그대로 사용할 수 없으며 전세계적으로 사용되는 표준 시간으로 정의된 것을 따라야합니다. 세계협정시라고 부르는 UTC는 1970년 1월 1일을 기준으로 산정한 시간으로 보통 유닉스 시간 또는 유닉스 타임스탬프라고 합니다.</p>
<h3 id="유닉스-시간"><a href="#유닉스-시간" class="headerlink" title="유닉스 시간"></a>유닉스 시간</h3><p>기본적으로 타임스탬프에 대해서 초 단위로 세어지는 정수로 표현한 값을 유닉스 시간(Unix Epoch) 또는 유닉스 타임스탬프라고 합니다. PostgreSQL 에서는 타임스탬프 유형의 컬럼에 대해서 EPOCH 키워드를 통해서 초 단위로 환산된 유닉스 시간을 추출할 수 있도록 지원합니다.</p>
<ul>
<li><a href="https://www.epoch101.com/#epochConvertToReadable-Container">Convert Epoch&#x2F;Unix Timestamp</a></li>
<li><a href="https://it-tools.tech/date-converter">Date-time converter</a></li>
</ul>
<h3 id="타임스탬프-정밀도"><a href="#타임스탬프-정밀도" class="headerlink" title="타임스탬프 정밀도"></a>타임스탬프 정밀도</h3><p>유닉스 시간이 정의되고 시간이 흘러 현재는 타임스탬프가 초 단위가 아닌 밀리고 그리고 심지어는 나노초 까지의 단위로 타임스탬프 정밀도를 지원하게 됩니다. 사용하는 언어 또는 외부 솔루션에 따라서 정밀도 표현 지원이 다르며 심지어 시계열 데이터베이스인 KDB+ 에서의 <a href="https://code.kx.com/q4m3/2_Basic_Data_Types_Atoms/#25-temporal-data">시간 유형</a>은 1970년 1월 1일이 아닌 2000년 1월 1일을 기준의 나노초 정밀도를 가지는 타임스탬프를 지원합니다.</p>
<pre class="language-q" data-language="q"><code class="language-q"><span class="token datetime number">2000.01.01</span><span class="token verb operator">=</span><span class="token number">0</span>
<span class="token number">1b</span>

<span class="token punctuation">.</span>z<span class="token punctuation">.</span>p
<span class="token datetime number">2022.09.01</span>D<span class="token datetime number">21:38:52.940</span><span class="token number">328000</span></code></pre>

<p>타임스탬프를 스칼라 실수로 변환해보면 나노초 단위로 세어진 정수값으로 표현되므로 다른 시스템과 연계하기 위해 1970년 1월 1일 부터의 밀리초 단위로 세어지는 정수값으로 환산할 수 있습니다. (1 나노초는 10^6 밀리초 입니다.)</p>
<pre class="language-q" data-language="q"><code class="language-q"><span class="token keyword">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token symbol">`long</span><span class="token verb operator">$</span><span class="token datetime number">2022.09.01</span>D<span class="token datetime number">21:38:52.940</span><span class="token number">328000</span><span class="token punctuation">)</span><span class="token verb operator">-</span><span class="token symbol">`long</span><span class="token verb operator">$</span><span class="token datetime number">1970.01.01</span>D<span class="token datetime number">00:00</span><span class="token punctuation">)</span><span class="token verb operator">%</span><span class="token number">1e6</span>
<span class="token number">1662068332940</span></code></pre>

<p>현재 조직에서는 초 단위의 유닉스 시간이 아닌 밀리초로 환산한 정수값을 토대로 타임스탬프에 대한 데이터를 시스템 간 전달하고 있습니다. 대부분의 시스템은 여러가지 언어로 작성된 애플리케이션과 외부 솔루션과의 연계를 수행하며 동작하게 되므로 각 시스템에서 지원하는 타임스탬프의 정밀도 표현 차이로 인해서 약간의 차이가 발생할 수 있음을 고려해야할 수 있습니다.</p>
<h3 id="타임스탬프-표현"><a href="#타임스탬프-표현" class="headerlink" title="타임스탬프 표현"></a>타임스탬프 표현</h3><p>서버와 클라이언트 간 요청과 응답 시 전달되는 페이로드에 포함되는 타임스탬프는 어떻게 표현할 수 있을까요? 일반적으로 시스템 또는 개발자의 선호도에 따라서 UTC 기준의 Epoch라는 숫자 형태 또는 RFC 3339의 ISO 8601 형식으로 문자열 형태로 표현하게 됩니다. <a href="https://r.bluethl.net/how-to-design-better-apis#heading-2-use-iso-8601httpsenwikipediaorgwikiiso8601-utc-dates">더 나은 API 설계 시에는 ISO 8601 UTC</a>를 사용해야한다는 관점이 있지만 간을 문자열로 표현하는 것에는 <a href="https://engineering.fb.com/2022/07/25/production-engineering/its-time-to-leave-the-leap-second-in-the-past/">윤초 문제</a>가 포함되어있기 때문에 윤초를 무시한 밀리초 단위의 유닉스 시간을 사용할때에도 있습니다. 예를 들어, 유튜브의 경우 사용자의 이벤트 트래킹을 위해 로그 이벤트를 전송할 때에 밀리초 단위의 정수값을 전달하고 있습니다.</p>
]]></content>
      <tags>
        <tag>Unix Timestamp</tag>
        <tag>Unix Epoch</tag>
      </tags>
  </entry>
  <entry>
    <title>Unsupported allowDuplicateContentLengths in Spring Cloud Gateway of Hoxton Version</title>
    <url>/unsupported-allowduplicatecontentlength-in-spring-cloud-gateway-of-hoxton-version/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>오늘은 스프링 클라우드 게이트웨이에서 발생하는 Content-Length 헤더의 값이 단일이 아닌 복수로 지정될 때 발생하는 오류에 대해 다루어보려고 합니다.</p>
<h2 id="RFC-7230"><a href="#RFC-7230" class="headerlink" title="RFC 7230"></a>RFC 7230</h2><p><a href="https://datatracker.ietf.org/doc/html/rfc7230#section-3.3.2">RFC 7230 - 3.3.2. Content-Length</a>를 참고해보면 다른 헤더들과는 다르게 Content-Length 헤더는 단일로 구성되어야 한다고 규정합니다. 다만, 다음과 내용을 통해 Content-Length 헤더 값이 복수로 구성되는 경우는 수신자가 오류로 처리하거나 단일 값으로 처리해야한다고 설명하고 있습니다.</p>
<blockquote>
<p>If a message is received that has multiple Content-Length header fields with field-values consisting of the same decimal value, or a single Content-Length header field with a field value containing a list of identical decimal values (e.g., “Content-Length: 42, 42”), indicating that duplicate Content-Length header fields have been generated or combined by an upstream message processor, then the recipient MUST either reject the message as invalid or replace the duplicated field-values with a single valid Content-Length field containing that decimal value prior to determining the message body length or forwarding the message.</p>
</blockquote>
<h2 id="오류-및-원인-분석"><a href="#오류-및-원인-분석" class="headerlink" title="오류 및 원인 분석"></a>오류 및 원인 분석</h2><p>스프링 클라우드 게이트웨이에서 발생한 오류에 대한 내용은 <a href="https://github.com/spring-cloud/spring-cloud-gateway/issues/2465">Multiple Content-Length values found: [229455, 229455]</a>에서 확인할 수 있습니다.</p>
<p>모든 스프링 클라우드 게이트웨이 버전에서 발생하는 상황은 아니었으며 스프링 부트 2.3.x와 호환성이 검증된 스프링 클라우드 Hoxton 릴리즈 트레인으로 관리되는 스프링 클라우드 게이트웨이 서버에서 발생하였습니다. Content-Length 헤더 값이 복수로 지정되는 것은 브라우저에서 실행간으한 wav, mp3, webm 파일을 요청할 때 발생한 것으로 일반적인 curl 또는 Postman을 통해서는 정상적으로 응답이 수행되었습니다.</p>
<h3 id="HttpUtil-normalizeAndGetContentLength"><a href="#HttpUtil-normalizeAndGetContentLength" class="headerlink" title="HttpUtil#normalizeAndGetContentLength"></a>HttpUtil#normalizeAndGetContentLength</h3><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>IllegalArgumentException</span><span class="token operator">:</span> <span class="token class-name">Multiple</span> <span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Length</span> values found<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">229455</span><span class="token punctuation">,</span> <span class="token number">229455</span><span class="token punctuation">]</span>
	at <span class="token class-name"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span>HttpUtil</span><span class="token punctuation">.</span><span class="token function">normalizeAndGetContentLength</span><span class="token punctuation">(</span><span class="token class-name">HttpUtil</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">595</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>netty<span class="token operator">-</span>codec<span class="token operator">-</span>http<span class="token operator">-</span><span class="token number">4.1</span><span class="token number">.65</span><span class="token punctuation">.</span>Final<span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">4.1</span><span class="token number">.65</span><span class="token punctuation">.</span>Final<span class="token punctuation">]</span>
	<span class="token class-name">Suppressed</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span>FluxOnAssembly</span>$<span class="token class-name">OnAssemblyException</span><span class="token operator">:</span> 
<span class="token class-name">Error</span> has been observed at the following <span class="token function">site</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">:</span></code></pre>

<p>위 스택트레이스 내용에 따르면 Netty 라이브러리의 netty-codec-http 모듈에서 HttpUtil.normalizeAndGetContentLength 함수로 처리될 때 오류가 던져졌음을 확인할 수 있습니다. 또한, netty-codec-http 모듈의 <a href="https://github.com/netty/netty/blob/c08beb543a6b8db0c7f3cee225042361b4025e4c/codec-http/src/main/java/io/netty/handler/codec/http/HttpUtil.java#L555-L560">HttpUtil#normarlizeAndGetContentLength</a>에는 allowDuplicateContentLengths 파라미터를 통해 복수의 동일한 값이 지정되더라도 단일 값으로 처리되도록 구현되어있는 상태입니다.</p>
<h3 id="Reactor-Netty-HttpDecoderSpec"><a href="#Reactor-Netty-HttpDecoderSpec" class="headerlink" title="Reactor Netty - HttpDecoderSpec"></a>Reactor Netty - HttpDecoderSpec</h3><p>이미 allowDuplicateContentLengths 옵션을 지원하는데도 불구하고 스프링 클라우드 Hoxton 버전에서 의존하는 reactor-netty:0.9.x.RELEASE 에서는 HttpDecoderSpec 클래스가 allowDuplicateContentLengths 옵션을 지원하지 않았습니다.</p>
<p>더 자세한 정보를 찾아본 결과 HttpDecoderSpec에서 allowDuplicateContentLengths 옵션이 지원되는 것은 <a href="https://github.com/reactor/reactor-netty/pull/1638/commits/978ba8a737f26376d1caab4806e25420e7aac7b7">Add HttpDecoderSpec#allowDuplicateContentLengths(boolean) #1638</a>으로 처리되었으며 <a href="https://github.com/reactor/reactor-netty/releases/tag/v1.0.8">Reactor Netty 1.0.8</a>에서부터 추가되어 반영되었음을 확인할 수 있었습니다. 그러나 위 반영 내용은 Reactor Netty 0.9.x 사용자들을 위한 Dysprosium 릴리즈 트레인에서 <a href="https://github.com/reactor/reactor-netty/releases/tag/v0.9.25.RELEASE">Reactor Netty 0.9.25.RELEASE</a>로 릴리즈 계획이 종료되기까지 반영되지 않은 사항입니다. </p>
<blockquote>
<p>Reactor Netty 0.9.x 사용자들을 위해 allowDuplicateContentLengths 옵션 지원을 반영할 수 있는지 <a href="https://github.com/reactor/reactor-netty/issues/1942">allowDuplicateContentLengths for Reactor Netty 0.9.x users #1942</a> 이슈를 등록해두었습니다. 이 이슈가 처리되기전까지는 HttpDecoderSpec에서 allowDuplicateContentLengths 파라미터를 활성화할 수 없습니다.</p>
</blockquote>
<h2 id="해결방안"><a href="#해결방안" class="headerlink" title="해결방안"></a>해결방안</h2><p>Content-Length 헤더에 중복된 동일한 값이 설정되는 문제를 해결하기 위해서는 allowDuplicateContentLengths 옵션이 적용될 수 있도록 해야만합니다. 스프링 클라우드 게이트웨이 서버 스타터에서 자동 구성할 때 HttpClient에 대한 HttpClientCustomizer를 지원함에도 불구하고 의존하고 있는 HttpDecoderSpec에서 allowDuplicateContentLengths를 적용할 수 있어야만 합니다. 따라서, Reactor Netty 의존성 버전을 1.0.8 이상으로 변경할 수 밖에 없습니다.</p>
<h3 id="첫번째-시도-Reactor-Bom-변경"><a href="#첫번째-시도-Reactor-Bom-변경" class="headerlink" title="첫번째 시도 - Reactor Bom 변경"></a>첫번째 시도 - Reactor Bom 변경</h3><p>혹시나 Reactor Netty 의존성 버전을 변경하여 가능할지도 모른다는 생각으로 버전 업그레이드를 시도해보았습니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">ext <span class="token punctuation">&#123;</span>
    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'springCloudVersion'</span><span class="token punctuation">,</span> <span class="token string">'Hoxton.SR12'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'reactorNettyVersion'</span><span class="token punctuation">,</span> <span class="token string">'2020.0.8'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
dependencyManagement <span class="token punctuation">&#123;</span>
    imports <span class="token punctuation">&#123;</span>
        mavenBom <span class="token interpolation-string"><span class="token string">"org.springframework.cloud:spring-cloud-dependencies:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token expression">springCloudVersion</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"</span></span>
        mavenBom <span class="token interpolation-string"><span class="token string">"io.projectreactor:reactor-bom:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token expression">reactorNettyVersion</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"</span></span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>Reactor Netty 버전을 변경하기 위해 Reactor Bom을 적용해본 결과 다음과 같이 reactor.netty.tcp.ProxyProvider를 클래스로더에서 찾을 수 없는 상태가 되었습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>NoClassDefFoundError</span><span class="token operator">:</span> reactor<span class="token operator">/</span>netty<span class="token operator">/</span>tcp<span class="token operator">/</span><span class="token class-name">ProxyProvider</span>$<span class="token class-name">Builder</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Class</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethods0</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>na<span class="token operator">:</span>na<span class="token punctuation">]</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Class</span><span class="token punctuation">.</span><span class="token function">privateGetDeclaredMethods</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3166</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>na<span class="token operator">:</span>na<span class="token punctuation">]</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Class</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2309</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>na<span class="token operator">:</span>na<span class="token punctuation">]</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">463</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>spring<span class="token operator">-</span>core<span class="token operator">-</span><span class="token number">5.2</span><span class="token number">.15</span><span class="token punctuation">.</span>RELEASE<span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">5.2</span><span class="token number">.15</span><span class="token punctuation">.</span>RELEASE<span class="token punctuation">]</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">19</span> common frames omitted
<span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassNotFoundException</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">reactor<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>tcp<span class="token punctuation">.</span></span>ProxyProvider</span>$<span class="token class-name">Builder</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">jdk<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>loader<span class="token punctuation">.</span></span>BuiltinClassLoader</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">BuiltinClassLoader</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">581</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>na<span class="token operator">:</span>na<span class="token punctuation">]</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">jdk<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>loader<span class="token punctuation">.</span></span>ClassLoaders</span>$<span class="token class-name">AppClassLoader</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">ClassLoaders</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">178</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>na<span class="token operator">:</span>na<span class="token punctuation">]</span>
	at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassLoader</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">522</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>na<span class="token operator">:</span>na<span class="token punctuation">]</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">23</span> common frames omitted</code></pre>

<p>이러한 문제가 발생하는 이유는 <a href="https://github.com/reactor/reactor-netty/releases/tag/v1.0.0">Reactor Netty 1.0.0</a>에서부터 reactor.netty.tcp.ProxyProvider가 reactor.netty.transport.ProxyProvider로 변경되었기 때문입니다. 스프링 클라우드 Hoxton에서는 Reactor Netty 0.9.x의 클래스들을 사용하기 때문에 단순하게 Reactor Netty 의존성 버전을 변경할 수는 없습니다.</p>
<h3 id="두번째-시도-Spring-Cloud-버전-업그레이드"><a href="#두번째-시도-Spring-Cloud-버전-업그레이드" class="headerlink" title="두번째 시도 - Spring Cloud 버전 업그레이드"></a>두번째 시도 - Spring Cloud 버전 업그레이드</h3><p>Reactor Netty 1.0.8을 사용하기 위해서는 스프링 클라우드 2020.0.x aka Ilford 릴리즈 트레인의 스프링 클라우드와 함께 스프링 부트 2.4.x로 업그레이드해야합니다. 테스트 중인 프로젝트에서는 그래들 멀티 프로젝트로 구성되어 스프링 클라우드 게이트웨이 서버와 애플리케이션 서버가 동일한 스프링 부트 버전을 사용하고 있었습니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">plugins <span class="token punctuation">&#123;</span>
    id <span class="token string">'rog.springframework.boot'</span> version <span class="token string">'2.4.13'</span>
<span class="token punctuation">&#125;</span>
ext <span class="token punctuation">&#123;</span>
    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'springCloudVersion'</span><span class="token punctuation">,</span> <span class="token string">'2020.0.0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'reactorNettyVersion'</span><span class="token punctuation">,</span> <span class="token string">'2020.0.8'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
dependencyManagement <span class="token punctuation">&#123;</span>
    imports <span class="token punctuation">&#123;</span>
        mavenBom <span class="token interpolation-string"><span class="token string">"org.springframework.cloud:spring-cloud-dependencies:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token expression">springCloudVersion</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"</span></span>
        mavenBom <span class="token interpolation-string"><span class="token string">"io.projectreactor:reactor-bom:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token expression">reactorNettyVersion</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"</span></span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>스프링 부트 2.4 부터 변경된 사항에 대해서 검토하여야합니다.</p>
</blockquote>
<p>아쉽게도 스프링 부트 버전과 스프링 클라우드 버전을 업그레이드 하고나서는 Content-Length에 복수로 설정되던 파일들이 정상적으로 단일 값으로 처리되어 allowDuplicateContentLengths 적용이 필요하지 않은 상태가 되었습니다. 만약, allowDuplicateContentLengths 적용이 필요하다면 다음과 같이 HttpClientCustomzier를 통해 구성할 수 있습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyHttpClientCustomizer</span> <span class="token keyword">implements</span> <span class="token class-name">HttpClientCustomizer</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">HttpClient</span> <span class="token function">customize</span><span class="token punctuation">(</span><span class="token class-name">HttpClient</span> httpClient<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> httpClient<span class="token punctuation">.</span><span class="token function">httpResponseDecoder</span><span class="token punctuation">(</span>decoderSpec <span class="token operator">-></span> 
            decoderSpec
                <span class="token punctuation">.</span><span class="token function">allowDuplicateContentLengths</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>이 내용은 Okky 커뮤니티에 <a href="https://okky.kr/article/1122985">Spring Cloud Hoxton의 Spring Cloud Gateway에서는 allowDuplicateContentLengths을 지원하지 않음</a>로 공유되었음을 알려드리며 마치도록 하겠습니다.</p>
<p>감사합니다.</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/issues/1942">https://github.com/reactor/reactor-netty/issues/1942</a><br>Reactor Netty 측에 0.9.x 사용자들을 위해 수정 요청하였으나 업데이트 중단된 버전인 사유로 거부되었습니다.</p>
</blockquote>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7230">RFC 7230</a>  </li>
<li><a href="https://spring.io/projects/spring-cloud">Spring Cloud Release train Spring Boot compatibility</a></li>
<li><a href="https://github.com/spring-cloud/spring-cloud-gateway">spring-cloud&#x2F;spring-cloud-gateway</a></li>
<li><a href="https://github.com/reactor/reactor-netty/releases/tag/v1.0.8">Reactor Netty 1.0.8 Release</a></li>
</ul>
]]></content>
      <tags>
        <tag>Spring Cloud Gateway</tag>
        <tag>RFC 7230</tag>
        <tag>Reactor Netty</tag>
      </tags>
  </entry>
  <entry>
    <title>Webpack 5 기반의 Vue 개발 환경</title>
    <url>/webpack5-for-vue/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>오늘은 <strong>Webpack 5 기반의 Vue 개발 환경</strong>에 대해서 알아보는 시간을 가져보도록 하겠습니다.<br>본 글에서 설명한 내용에 대한 코드는 <a href="https://github.com/kdevkr/webpack5">kdevkr&#x2F;webpack5</a>에서 제공합니다.</p>
<h2 id="Webpack"><a href="#Webpack" class="headerlink" title="Webpack"></a>Webpack</h2><p>반드시 그런 것은 아니지만 많은 분들이 <a href="https://create-react-app.dev/">Create React App</a> 또는 <a href="https://cli.vuejs.org/">Vue CLI</a>라는 도구를 통해서 프론트엔드 개발 환경에 대한 기본 프리셋을 기반으로 학습을 시작하거나 개발 환경을 구축합니다. 이 도구들은 여러가지 사항에 대한 웹팩 구성을 기본적으로 제공함으로써 웹팩에 대한 내용을 알지 못하더라도 쉽게 리액트 또는 뷰에 대한 학습을 진행할 수 있게 도와주는 유용한 도구입니다. </p>
<p>그럼에도 불구하고, 실무 환경에서는 이 도구들을 사용하지 않고 직접 웹팩 설정에 대해 구성하여 사용합니다. 또한, Vue CLI는 안타깝게도 웹팩 4에 대한 구성을 제공하므로 이 도구로 만들어지는 환경은 무조건 웹팩 4로 제한되는 문제점을 가지고 있습니다. <a href="https://webpack.js.org/blog/2020-10-10-webpack-5-release/">2020년 10월에 릴리즈된 웹팩 5</a> 기반의 개발 환경을 만들기 위해서는 직접 웹팩 구성을 수행할 수 있어야만 합니다.</p>
<h3 id="요구사항"><a href="#요구사항" class="headerlink" title="요구사항"></a>요구사항</h3><p>시작하기에 앞서, 웹팩 5는 노드 10.13.0 이상의 버전을 요구하며 함께 개발 프록시 서버로 활용할 수 있는 webpack-dev-server@4 에서는 노드 12.13.0 이상을 요구합니다. </p>
<ul>
<li>Webpack5 required v10.13.0+</li>
<li>webpack-dev-server@4 v12.13.0+</li>
</ul>
<h4 id="프로젝트-노드-버전-제한"><a href="#프로젝트-노드-버전-제한" class="headerlink" title="프로젝트 노드 버전 제한"></a>프로젝트 노드 버전 제한</h4><p>위 요구사항에 따라 프로젝트에서 사용할 수 있는 노드 버전을 제한하는 것이 좋습니다. 제가 이전에 공유한 <a href="https://kdevkr.github.io/strict-nodejs-version-for-project/">프로젝트의 노드 버전 제한하기</a>를 참고하여 노드 엔진 버전을 12.13.0 이상으로 설정해두는 것을 추천하는 바입니다.</p>
<h3 id="커밋별로-확인하는-구성"><a href="#커밋별로-확인하는-구성" class="headerlink" title="커밋별로 확인하는 구성"></a>커밋별로 확인하는 구성</h3><p>각 커밋 단위의 Browser Files를 통해 어떻게 구성이 변화하는지를 참고하시면 좋습니다.</p>
<h4 id="Add-webpack-config-js-for-default-configuration"><a href="#Add-webpack-config-js-for-default-configuration" class="headerlink" title="Add webpack.config.js for default configuration"></a><a href="https://github.com/kdevkr/webpack5/commit/3f858c2702720088b8647bdb55a9f830d54a8d91">Add webpack.config.js for default configuration</a></h4><p>기본 구성을 위한 webpack.config.js 파일을 만들고 node-env 값에 따라 번들 파일명을 다르게 지정할 수 있음을 보여줍니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">npx webpack --node-env production # 모드를 지정하지 않았지만 node-env 값에 의해 처리됩니다.</code></pre>

<h4 id="Add-vue-loader"><a href="#Add-vue-loader" class="headerlink" title="Add vue-loader"></a><a href="https://github.com/kdevkr/webpack5/commit/3ca2fc1de5573ae339b0271ea482a73bf3dac397">Add vue-loader</a></h4><p>Vue SFC 파일을 처리하기 위한 vue-loader를 추가하고 Vue 개발 환경을 준비하고 간단한 샘플 HTML 파일을 만들어서 Vue 코드가 정상적으로 변환되었음을 확인합니다.</p>
<h4 id="Add-sass-postcss"><a href="#Add-sass-postcss" class="headerlink" title="Add sass, postcss"></a><a href="https://github.com/kdevkr/webpack5/commit/68ffce2b18c64e67b944a383b216c2e6fe784396">Add sass, postcss</a></h4><p>Vue SFC의 스타일 블록의 언어를 SCSS로 사용하기 위해서 sass 및 postcss에 대한 설정을 추가합니다. </p>
<h4 id="Add-stylelint"><a href="#Add-stylelint" class="headerlink" title="Add stylelint"></a><a href="https://github.com/kdevkr/webpack5/commit/7e1e00735738e9106033c6df675977846b159552">Add stylelint</a></h4><p>반드시 필요한 설정은 아니지만 CSS에 대한 린트를 적용하기 위해 stylelint를 postcss 플러그인으로 추가합니다.</p>
<h4 id="Add-eslint"><a href="#Add-eslint" class="headerlink" title="Add eslint"></a><a href="https://github.com/kdevkr/webpack5/commit/f7f566314fd675e18d3f7b3dd35283317c5891ae">Add eslint</a></h4><p>자바스크립트에 대한 린트를 적용하기 위해 eslint를 추가합니다.</p>
<h4 id="Add-babel"><a href="#Add-babel" class="headerlink" title="Add babel"></a><a href="https://github.com/kdevkr/webpack5/commit/c5211b28ab8176e8c5c9fb39c755083679cb24df">Add babel</a></h4><p>ES6+ 문법을 지원하지 않는 브라우저를 위해 ES5 문법으로 변환하기 위한 babel을 추가합니다. babel 7 부터는 폴리필 적용 방식이 변경되었음을 주의해야합니다. 바벨 폴리필에 대해서는 다음의 두 링크를 참고하시면 좋습니다.</p>
<ul>
<li><a href="https://poiemaweb.com/babel-polyfill">폐지된 @babel&#x2F;polyfill 대신 @babel&#x2F;plugin-transform-runtime을 사용해 폴리필 추가하기</a></li>
<li><a href="https://tech.kakao.com/2020/12/01/frontend-growth-02/">Babel7과 corejs3 설정으로 전역 오염 없는 폴리필 사용하기</a></li>
</ul>
<h4 id="Add-browserslist"><a href="#Add-browserslist" class="headerlink" title="Add browserslist"></a><a href="https://github.com/kdevkr/webpack5/commit/c911ef73aa85ebde4d9c738c07999300c05bfaf8">Add browserslist</a></h4><p>postcss의 autoprefixer 또는 babel에서 참고할 타겟 정보를 위해 browserslist를 추가합니다.</p>
<h4 id="Add-prettierrc"><a href="#Add-prettierrc" class="headerlink" title="Add prettierrc"></a><a href="https://github.com/kdevkr/webpack5/commit/b5c8e20ebdb2224f1268b431aafb82a6b49e7b3a">Add prettierrc</a></h4><p>불필요한 포맷팅을 방지하기 위한 prettier 옵션을 조정합니다.</p>
<h4 id="Add-asset"><a href="#Add-asset" class="headerlink" title="Add asset"></a><a href="https://github.com/kdevkr/webpack5/commit/1ba05ff066806fb2c7b59eace748e04e73756243">Add asset</a></h4><p>이미지 또는 폰트 등을 위한 에셋 모듈을 추가합니다.</p>
<h4 id="Apply-strict-npm-engines"><a href="#Apply-strict-npm-engines" class="headerlink" title="Apply strict npm engines"></a><a href="https://github.com/kdevkr/webpack5/commit/1b768c5881db9d8348d54f926a11e537a50050ac">Apply strict npm engines</a></h4><p>지금까지 설치된 패키지에서 최소로 요구하는 노드 버전을 명시하고 제한되도록 설정합니다.</p>
<h4 id="Apply-settings-for-vscode"><a href="#Apply-settings-for-vscode" class="headerlink" title="Apply settings for vscode"></a><a href="https://github.com/kdevkr/webpack5/commit/9008824470873ce172e52294ddac7eee8304c256">Apply settings for vscode</a></h4><p>VSCode를 사용하는 경우 저장될 때 ESLint가 동작하도록 설정합니다.</p>
<h4 id="Add-project-version-in-output-filename"><a href="#Add-project-version-in-output-filename" class="headerlink" title="Add project version in output filename"></a><a href="https://github.com/kdevkr/webpack5/commit/769171d627bb1f4bfbb4bacce62dc067ff9b617a">Add project version in output filename</a></h4><p>(Optional) package.json에 정의된 프로젝트 버전을 번들 파일명에 포함시킬 수 있음을 보여줍니다.</p>
<h4 id="Apply-optimization"><a href="#Apply-optimization" class="headerlink" title="Apply optimization"></a><a href="https://github.com/kdevkr/webpack5/commit/bab1505c643b4ae3ea5e7a86bdc90317f4afe470">Apply optimization</a></h4><p>프로덕션 환경을 위한 최적화 구성을 조정합니다.</p>
<h4 id="Add-manifest"><a href="#Add-manifest" class="headerlink" title="Add manifest"></a><a href="https://github.com/kdevkr/webpack5/commit/7d0cd27b85a8f1df757e16c3ddb6ad32b8f7b39e">Add manifest</a></h4><p>매니페스트 파일이 생성할 수 있도록 플러그인을 추가합니다. </p>
<pre class="language-sh" data-language="sh"><code class="language-sh">npx webpack --node-env production --env manifest</code></pre>

<h4 id="Add-bootstrap-vue"><a href="#Add-bootstrap-vue" class="headerlink" title="Add bootstrap-vue"></a><a href="https://github.com/kdevkr/webpack5/commit/c3da5f586c6ec368778e2c90478196e4af037a82">Add bootstrap-vue</a></h4><p>BootstrapVue를 추가해보고 <a href="https://kdevkr.github.io/no-emit-deprecation-warnings-of-dart-sass/">최신 버전의 Sass에서 출력되는 Deprecation 경고가 출력되지 않도록</a> 설정합니다.</p>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>Webpack5</tag>
      </tags>
  </entry>
  <entry>
    <title>HandlerInterceptor은 언제 사용하나요?</title>
    <url>/when-do-i-use-the-handler-interceptor/</url>
    <content><![CDATA[<p><img data-src="/../images/logo/spring.png#compact"></p>
<p>안녕하세요 Mambo입니다. 오늘은 스프링 MVC 모듈에 포함되어있는 HandlerInterceptor 인터페이스를 언제 사용하는가에 대해서 알아보겠습니다.</p>
<h2 id="HandlerInterceptor"><a href="#HandlerInterceptor" class="headerlink" title="HandlerInterceptor"></a>HandlerInterceptor</h2><blockquote>
<p>A HandlerInterceptor gets called before the appropriate HandlerAdapter triggers the execution of the handler itself. This mechanism can be used for a large field of preprocessing aspects, e.g. for authorization checks, or common handler behavior like locale or theme changes. Its main purpose is to allow for factoring out repetitive handler code.</p>
</blockquote>
<p><strong>HandlerInterceptor</strong>는 컨트롤러 핸들러 함수에 대한 전처리 동작을 수행할 수 있는 방법을 제공합니다. 필터도 전처리 동작을 수행할 수 있지만 web.xml에 정의되는 필터와 다르게 HandlerInterceptor는 애플리케이션 컨텍스트에서 관리하므로 요청 정보를 분석하여 사용자를 인증하거나 응답 뷰를 렌더링하기 전에 부가 데이터를 주입하는 동작을 수행할 수 있습니다.</p>
<p>예를 들어, 기본으로 제공되는 HandlerInterceptor 구현체인 <strong>LocaleChangeInterceptor</strong>는 로케일 파라미터에 따라 현재 로케일을 변경하는 동작을 수행하죠.</p>
<h3 id="정적-리소스-패턴-제외"><a href="#정적-리소스-패턴-제외" class="headerlink" title="정적 리소스 패턴 제외"></a>정적 리소스 패턴 제외</h3><p><strong>ResourceHandlerRegistry</strong>는 정적 리소스를 배포하기 위한 핸들러를 등록하는 것을 지원하는 클래스입니다. 이때, 리소스 핸들러가 처리할 경로를 매칭하기 위하여 AntPathMatcher 또는 PathPattern을 사용하게 되는데 Ant 스타일의 패턴 매칭을 사용하므로 특정 패턴을 제외하기 위한 Regex 같은 방식을 사용할 수 없습니다. </p>
<p>리소스 핸들러가 처리하는 경로에 대해서 특정 패턴을 제외하기 위해서는 해당 패턴을 처리하지 않도록 패턴별로 등록하여야합니다. 하지만, 이렇게 올바른 패턴마다 리소스 핸들러를 등록하는 것은 불편합니다.</p>
<pre class="language-java" data-language="java"><div class="caption"><span>ResourceHandlerRegistry</span></div><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addResourceHandlers</span><span class="token punctuation">(</span><span class="token class-name">ResourceHandlerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        registry<span class="token punctuation">.</span><span class="token function">addResourceHandler</span><span class="token punctuation">(</span><span class="token string">"/images/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addResourceLocations</span><span class="token punctuation">(</span><span class="token string">"classpath:/static/images/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>위 예시는 <strong>&#x2F;images&#x2F;</strong>** 패턴의 경로에 대해서 클래스패스의 <strong>static&#x2F;images</strong> 폴더에 있는 정적 리소스로 처리하기 위한 핸들러를 등록합니다. images 폴더에는 이미지 파일만 있다고 가정했으나 개발자의 실수로 images 폴더에 이미지가 아닌 동영상 파일이나 오디오 파일이 들어있다면 해당 리소스도 처리하게 됩니다.</p>
<p>이렇게 특정 패턴을 방지해야하는 경우에 HandlerInterceptor를 등록하여 요청을 분석하여 리소스를 응답하지 않도록 전처리 동작을 구현할 수 있습니다.</p>
<p>다음과 같이 <strong>이미지 파일 패턴이 아니라면 요청을 404 Not Found로 처리</strong>하는 동작을 수행할 수 있습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token function">onlyServeImagesHandlerInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">"/images/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addResourceHandlers</span><span class="token punctuation">(</span><span class="token class-name">ResourceHandlerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        registry<span class="token punctuation">.</span><span class="token function">addResourceHandler</span><span class="token punctuation">(</span><span class="token string">"/images/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addResourceLocations</span><span class="token punctuation">(</span><span class="token string">"classpath:/static/images/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">OnlyServeImagesHandlerInterceptor</span> <span class="token function">onlyServeImagesHandlerInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OnlyServeImagesHandlerInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">OnlyServeImagesHandlerInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> requestURI <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>requestURI<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">".*\\/.*\\.(jpg|jpeg|png|gif)"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">.</span>SC_NOT_FOUND<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>위 인터셉터가 정말로 이미지 파일에 대해서만 처리할 수 있게 사전 처리를 수행하는지 확인해보겠습니다.</p>
<p><img data-src="/images/posts/handler-interceptor-01.gif"></p>
<p>위 결과를 보면 이미지 파일은 정적 리소스로 배포되도록 처리되었지만 동영상 파일은 처리되지 않게 된걸 확인할 수 있습니다. </p>
<h3 id="뷰-응답-시-부가-정보-주입"><a href="#뷰-응답-시-부가-정보-주입" class="headerlink" title="뷰 응답 시 부가 정보 주입"></a>뷰 응답 시 부가 정보 주입</h3><p>두번째로는 뷰를 응답하는 핸들러 함수에 대하여 <strong>부가 정보를 주입</strong>하는데에 사용할 수 있습니다. </p>
<p>다음의 코드는 뷰를 응답하게되는 핸들러 함수에 사용 가능한 언어와 함께 현재 로케일에 대한 메시지 코드 목록을 주입하는 인터셉터 예시입니다.</p>
<pre class="language-java" data-language="java"><div class="caption"><span>InjectionLocalesInterceptor</span></div><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">InjectionLocalesInterceptor</span> <span class="token keyword">extends</span> <span class="token class-name">HandlerInterceptorAdapter</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">MessagePool</span> messagePool <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>modelAndView <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> messagePool <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Locale</span> locale <span class="token operator">=</span> messagePool<span class="token punctuation">.</span><span class="token function">getLocale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>locale <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                locale <span class="token operator">=</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">"lang"</span><span class="token punctuation">,</span> locale<span class="token punctuation">.</span><span class="token function">getLanguage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">"locale"</span><span class="token punctuation">,</span> locale<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">HandlerMethod</span> handlerMethod <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span> handler<span class="token punctuation">;</span>
                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> beanType <span class="token operator">=</span> handlerMethod<span class="token punctuation">.</span><span class="token function">getBeanType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Controller</span> controller <span class="token operator">=</span> beanType<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Controller</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>controller <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">"locales"</span><span class="token punctuation">,</span> messagePool<span class="token punctuation">.</span><span class="token function">getLocales</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">"messages"</span><span class="token punctuation">,</span> messagePool<span class="token punctuation">.</span><span class="token function">getMessagesInJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">postHandle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> modelAndView<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>이제 템플릿 엔진에서 주입된 부가 정보를 사용하여 렌더링을 할 수 있게 됩니다.</p>
<h3 id="인증을-위한-인터셉터"><a href="#인증을-위한-인터셉터" class="headerlink" title="인증을 위한 인터셉터"></a>인증을 위한 인터셉터</h3><p>또 다른 인터셉터의 활용 방안은 인증 처리입니다. 사용자에게 이메일 또는 카카오톡 메시지등을 발송하여 어떤 행동을 할 수 있는 링크를 주게 된다고 가정해보면 해당 링크를 통해 들어오는 사용자은 인증을 수행하기 전일 수 있습니다. 이때 주어지는 링크에 임시적으로 인증에 사용할 수 있는 만료성 토큰 파라미터를 포함시킴으로써 사용자를 인증하는 로직을 추가할 수 있습니다.</p>
<p><img data-src="https://s3.amazonaws.com/cdn.freshdesk.com/data/helpdesk/attachments/production/31015797034/original/89mawYXJeO_K082-5HF52bd73j_SN60nLQ.png" alt="코인원의 이메일 인증하기 버튼"></p>
<p>위 예시 이미지의 이메일 인증하기 버튼에 대한 링크에는 코인원에서 분석할 수 있는 어떠한 파라미터에 인증을 위한 식별 정보가 있을거라 추측합니다.</p>
<p>다음은 토큰 파라미터 유무를 확인하고 토큰 파라미터를 분석하여 인증을 수행하는 인터셉터 구현의 예시입니다.</p>
<pre class="language-java" data-language="java"><div class="caption"><span>TokenBasedAuthenticationInterceptor</span></div><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TokenBasedAuthenticationInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TOKEN_PARAMETER_NAME <span class="token operator">=</span> <span class="token string">"token"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> parameter <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>TOKEN_PARAMETER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>parameter <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>parameter<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// NOTE: 토큰 파라미터 분석 및 검증</span>
            <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token function">analyticsToken</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> valid <span class="token operator">=</span> <span class="token function">validateToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>valid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// NOTE: 토큰 기반 인증 처리</span>
                <span class="token function">authenticationByToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> valid<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><strong>일정 시간이 만료</strong>되면 해당 토큰으로는 인증할 수 없고 이미 인증을 수행하여 <strong>사용이 완료된 토큰</strong>으로 확인하는 것은 토큰 파라미터 분석 및 검증 로직에 포함될겁니다.</p>
<p>간단하게 HandlerInterceptor의 활용 방안 3가지를 확인해보았습니다. 애플리케이션 마다 요구사항이 다르고 무궁무진 하기 때문에 HandlerInterceptor는 더 다양한 방식으로 활용할 수 있을 겁니다. 이상으로 HandlerInterceptor은 언제 사용하나요?를 마치겠습니다. 감사합니다.</p>
]]></content>
      <tags>
        <tag>Spring MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>무중단 배포</title>
    <url>/zero-downtime-deplotment/</url>
    <content><![CDATA[<blockquote>
<p>네이버 또는 카카오톡 같은 규모의 컨텐츠 제공자(CP)들은 전기통신사업법 제22조 7에 의거하여 서비스 안정성을 확보해야할 의무가 있다.</p>
</blockquote>
<p>작은 규모의 조직에서 웹 애플리케이션으로 구성된 시스템을 개발하고 있지만 위와 같은 대규모 시스템을 다루지 않아서 경험할 수 없는 인프라 지식 중 하나는 운영중인 시스템에 대한 <strong>무중단 배포</strong>이다. 무중단 배포(Zero Downtime Deployment) 방식이란 운영중인 시스템을 이용하는 사용자가 최소한의 다운타임으로 배포 과정에서 서비스를 일시적으로 이용하지 못하는 상황이 최대한 발생하지 않도록 <strong>지속적인 사용자 경험을 제공하기 위한 것</strong>을 말한다.</p>
<p>현재 시스템은 특수한 분야의 기업들이 사용하는 것으로 일반적인 사용자가 이용하는 웹 서비스와는 성격이 다르기 때문에 정기적인 배포 일정으로 미리 시스템 점검을 예고하고 기업 고객들이 이용하지 않을 시간대에 시스템 변경사항을 배포하고 있다. 일부 고객은 보안 레벨 상 자체적으로 시스템에 대한 패치를 수행하고 있으며 우리는 해당 고객의 스테이징 환경에 미리 다음 버전의 시스템을 배포하고 있으므로 다운타임이 발생해도 괜찮은 배포 환경에 있다.</p>
<p>그럼에도 불구하고 무중단 배포에 대해서 미리 학습하고자 하는 것은 <strong>시스템의 운용 특성 상 다운타임을 최소화</strong>하여 기업 고객이 보유한 데이터를 기반으로 <strong>예상하지 못한 위험 감지를 즉각 제공해야할 의무</strong>가 있기 때문이다. 현재 조직이 자체적으로 AWS 클라우드 환경에 구성한 플랫폼은 <a href="/deploy-application-to-the-aws-elastic-beanstalk-java-se-platform-enviroment/">AWS Elastic Beanstalk의 Java SE 플랫폼을 사용하여 트래픽 분산 및 오토스케일링이 가능한 환경을 만들어두고 배포</a>하고 있다.</p>
<p><a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/using-features.deploy-existing-version.html">Elastic Beanstalk에서 지원하는 배포 정책</a>에는 무중단 배포 방식도 포함하고 있으므로 <a href="https://jojoldu.tistory.com/267">직접 배포 스크립트를 작성하여 무중단 배포를 수행하는 방법</a>을 시도할 필요는 없다. 그렇지만 Beanstalk을 사용하지 않는 환경도 있을 수 있기 때문에 시간이 많다면 <a href="https://stackoverflow.com/a/41881546">프로세스를 안전하게 종료하는 방법</a>과 함께 무중단 배포를 수행할 수 있는 배포 스크립트를 작성하는 것을 학습해봐도 좋을 듯 하다.</p>
]]></content>
      <tags>
        <tag>Beanstalk</tag>
        <tag>Zero Downtime</tag>
      </tags>
  </entry>
  <entry>
    <title>클라이언트 HTTP 요청부터 스프링 애플리케이션 응답하기까지의 과정</title>
    <url>/http-requests-from-client-to-response-from-spring/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다. 오늘은 <strong>클라이언트의 HTTP 요청부터 스프링 애플리케이션의 응답까지의 과정</strong> 에 대하여 이야기를 해보려고합니다. 제가 진행하는 공부방식 중 하나는 <a href="https://okky.kr/articles/questions">OKKY</a>에 올라오는 질문들을 살펴보면서 문제점을 파악하고 해결책을 찾아보는 과정을 진행하는 것입니다. 그런데 OKKY에 등록되는 질문들 중 대부분이 <code>AJAX</code>으로 데이터를 보내고 <code>스프링 컨트롤러</code>에서 데이터를 받는게 안된다는 유형이 많은 편입니다. 해당 질문 작성자들은 스프링 경험이 많지 않은 초보 개발자 이거나 스프링에 대한 이해없이 빠르게 예제를 통해 학습한 국비지원 수강생으로 보입니다.</p>
<blockquote>
<p>국비지원에 대한 비하로 느껴질 수 있으시겠습니다만, 스프링은 여러가지 프로그래밍 개념이 복합적으로 이루어진 프레임워크로 일반적으로 컴퓨터 공학과에서 배우는 전공 지식과는 별개로 쉽게 이해하기에는 어렵습니다. 그러니까 비전공자이기 때문에 어려운 것이 아니라 개념적으로 어려운 것이니 우울해하지 않으셔도 됩니다.</p>
</blockquote>
<p>4년 동안 스프링 기반으로 웹 애플리케이션을 개발하고 있는 저 또한 스프링을 제대로 이해하지는 못했습니다. 처음에 토비님이 작성하신 <code>토비의 스프링 3.1</code> 서적을 앞에서 읽다가 뒤부터 읽다가 이해가 안되서 대충이라도 최소한 4번은 읽은 것 같습니다. </p>
<p>그런데 앞서 언급한 질문들은 스프링의 개념을 이해를 못했다기보다는 HTTP 웹 요청 과정에 대한 이해가 부족하기 때문에 발생하는 문제라고 볼 수 있습니다. 스프링에 포함된 여러가지 모듈 중 웹 요청과 관련된 모듈은 <code>spring-web</code>과 <code>spring-webmvc</code> 인데요. 이 모듈들은 여러분이 스프링 기반의 웹 애플리케이션을 작성하는데 도움을 제공하는 클래스들이 포함되어있습니다. </p>
<p>이 글의 주요 내용인 클라이언트의 HTTP 요청부터 스프링 애플리케이션의 응답까지의 과정을 위 두개의 모듈이 제공하는 클래스들의 연관성을 찾아가면 쉽게 이해할 수 있습니다. 이 글을 통해 HTTP 요청과 응답 과정을 이해하신다면 제가 예전에 작성하였던 <a href="https://okky.kr/article/374594">초보 및 신입 개발자들을 위한 spring to ajax에 대한 정리</a>의 여러가지 케이스를 좀 더 쉽게 받아들일 수 있을거라 봅니다.</p>
<blockquote>
<p>관련 코드 : <a href="https://github.com/kdevkr/spring-demo-ajax">kdevkr&#x2F;spring-demo-ajax</a></p>
</blockquote>
<h2 id="HTTP-요청"><a href="#HTTP-요청" class="headerlink" title="HTTP 요청"></a>HTTP 요청</h2><p>먼저, 웹 브라우저와 같은 클라이언트에서 HTTP 요청을 수행하는 과정을 이해해야합니다. MDN 개발자 문서에서는 <a href="https://developer.mozilla.org/ko/docs/Web/HTTP/Messages">HTTP 메시지</a>에 대해 자세하게 설명해주고 있습니다.</p>
<h3 id="HTTP-메시지"><a href="#HTTP-메시지" class="headerlink" title="HTTP 메시지"></a>HTTP 메시지</h3><p><img data-src="https://mdn.mozillademos.org/files/13827/HTTPMsgStructure2.png" alt="출처 : MDN HTTP Messages"></p>
<p>위 그림에서처럼 여러분이 웹 브라우저를 통해 어떤 웹 사이트로 접근하는 것도 위와 같은 메시지를 요청하고 응답받습니다. 예를 들어, OKKY 사이트에 접속하기 위해서 <code>okky.kr</code> 주소를 입력하면 웹 브라우저가 대신해서 다음과 같은 정보로 HTTP 메시지를 보내고 응답을 받은 것을 브라우저에서 보여주는 것입니다.</p>
<p><img data-src="/images/posts/http-requests-responses/http-requests-responses-01.png" alt="[GET] okky.kr"></p>
<blockquote>
<p>지금 이 글을 보고 계시니까 이 과정은 다 이해하실테지요 :)</p>
</blockquote>
<h3 id="HTTP-Headers"><a href="#HTTP-Headers" class="headerlink" title="HTTP Headers"></a>HTTP Headers</h3><p>앞선 그림에서 웹 브라우저는 요청 헤더(Request Headers)에 무언가 많이 포함하고 있는 것을 볼 수 있을겁니다. 이 HTTP 요청 헤더는 HTTP 요청에 대한 부가정보를 제공한다고 볼 수 있는데요. 여러가지 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers">헤더</a>를 통해서 요청자를 식별할 수 있게 하거나 인증 정보를 포함하기도 하고 서버에게 요청에 대해 내가 응답받으려는 형태를 알려주기도 합니다.</p>
<p>Accept, Accept-Encoding, Accept-Language는 <a href="https://developer.mozilla.org/ko/docs/Web/HTTP/Content_negotiation">컨텐츠 협상(Content negotiation)</a>이라고 해서 HTTP 요청에 대하여 응답하는 서버가 어떤 형태로 내려주는게 가장 알맞는 것인지 알려주는 역할을 합니다. 그리고 HTTP 요청을 통해 데이터를 포함해서 보낼때 포함되는 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type">컨텐트 타입(Content-Type)</a>도 있고 파일 다운로드할 때 사용되는 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Disposition">Content-Disposition</a> 헤더도 있죠.</p>
<p>우선 기본적으로 알고 있어야하는 요청 헤더는 <code>Accept</code>, <code>Content-Type</code> 이라고 할 수 있습니다. Accept 헤더는 서버가 응답하기 위해 HTTP 메시지를 구성할 때 알맞는 형태로 제공해달라는 정보이고 Content-Type 헤더는 HTTP 메시지에 포함된 데이터가 어떤 형태로 구성되는지를 서버에게 알려주는 역할을 합니다. 따라서, 클라이언트에서 HTTP 요청할 때 HTTP 메시지에 포함되는 메시지 형태에 따라 Content-Type 헤더를 제공해야하고 서버로부터 특정 메시지 형태로 받고 싶다면 Accept 헤더에 알맞는 값을 지정해야하죠.</p>
<blockquote>
<p>위 예시에서 OKKY 서버는 웹 브라우저가 요청한 Accept 헤더 중 첫번째인 text&#x2F;html으로 HTTP 메시지를 응답했습니다.</p>
</blockquote>
<h4 id="Accept"><a href="#Accept" class="headerlink" title="Accept"></a>Accept</h4><p>Accept 헤더의 값은 <code>&lt;MIME_type&gt;/&lt;MIME_subtype&gt;</code> 형태로 구성하는데 대부분 <code>*/*</code> 으로 지정하여 서버가 알아서 응답 메시지 형태를 구성하거나 AJAX으로 요청하는 경우 <code>application/json</code>으로 설정하기도 하죠.</p>
<p>다음은 주로 사용되는 Accept 값이며 이외에도 많으니 한번 찾아보시는 것을 추천드립니다.</p>
<ul>
<li>text&#x2F;plain, text&#x2F;html, text&#x2F;css, text&#x2F;javascript</li>
<li>image&#x2F;png, image&#x2F;jpeg</li>
<li>application&#x2F;json, application&#x2F;xml, application&#x2F;octet-stream</li>
</ul>
<h4 id="Content-Type"><a href="#Content-Type" class="headerlink" title="Content-Type"></a>Content-Type</h4><p>Content-Type 헤더는 HTTP 메시지에 포함된 데이터의 형태를 알려주는 값이라고 했습니다. OKKY에 로그인하기 위해서 구글 OAuth 인증에 대한 HTTP 요청 정보를 확인해보면 다음과 같이 구성됨을 확인할 수 있습니다.</p>
<p><img data-src="/images/posts/http-requests-responses/http-requests-responses-02.png" alt="구글 계정으로 인증 시 요청 메시지"></p>
<p>구글 계정으로 인증 시 포함하는 요청 데이터가 <code>폼 데이터</code> 형태로 구성되어있다는 것을 알려주기 위해서 Content-Type에 <code>application/x-www-form-urlencoded</code>을 지정하였습니다.</p>
<p><img data-src="/images/posts/http-requests-responses/http-requests-responses-03.png" alt="구글 계정으로 인증 시 응답 메시지"></p>
<p>구글 인증 서버는 구글 계정 인증에 대한 결과가 JSON 형태의 문자열인 것을 알려주기 위해서 Content-Type에 <code>application/json</code>을 지정한 것을 확인할 수 있습니다. 이렇게 서버로 어떤 데이터가 포함되어야하는 요청이라면 요청 메시지를 구성하고 메시지 형태에 따라 Content-Type을 지정해야함을 알 수 있습니다.</p>
<h2 id="스프링-웹-모듈"><a href="#스프링-웹-모듈" class="headerlink" title="스프링 웹 모듈"></a>스프링 웹 모듈</h2><p>스프링 5부터는 리액티브 스택 기반의 애플리케이션을 작성할 수 있는 모듈이 있지만 일반적으로 사용되는 서블릿 기반의 <code>spring-webmvc</code> 모듈을 통해 HTTP 요청을 어떻게 처리하는지 알아보도록 합시다. 모듈 이름에서 확인할 수 있듯이 서블릿 기반의 웹 애플리케이션은 MVC 아키텍처 형태로 동작합니다. 스프링 웹 모듈에는 모든 HTTP 요청의 진입점이 되는 DispatcherServlet 클래스가 있으며 HTTP 요청에 대한 핸들러를 찾아 처리를 위임하게 됩니다.</p>
<h3 id="DispatcherServlet"><a href="#DispatcherServlet" class="headerlink" title="DispatcherServlet"></a>DispatcherServlet</h3><p>다음은 DispatcherServlet 클래스의 doDispatch 함수의 일부분입니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doDispatch</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// Determine handler for the current request.</span>
    mappedHandler <span class="token operator">=</span> <span class="token function">getHandler</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedHandler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">noHandlerFound</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Determine handler adapter for the current request.</span>
    <span class="token class-name">HandlerAdapter</span> ha <span class="token operator">=</span> <span class="token function">getHandlerAdapter</span><span class="token punctuation">(</span>mappedHandler<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>굉장히 단순한 코드라고 할 수 있는데요. 현재 처리중인 요청에 대한 핸들러가 존재하지 않는 경우 noHandlerFound 함수를 호출해서 오류를 발생시킬 지 404 NotFound 응답을 제공할지 결정하고 현재 요청을 처리할 수 있는 핸들러가 있다면 해당 핸들러에 대한 핸들러 어댑터를 찾아 처리를 수행하죠. 핸들러를 찾았지만 다시 핸들러 어댑터를 찾아 처리가 되도록하는 이유가 궁금하지 않으신가요? 그럼 핸들러 어댑터(HandlerAdapter)를 찾아가보도록 합시다.</p>
<h3 id="HandlerAdapter"><a href="#HandlerAdapter" class="headerlink" title="HandlerAdapter"></a>HandlerAdapter</h3><p>HandlerAdapter는 인터페이스로 추상화되어있으니 실제 동작을 수행하는 구현체를 찾아야 합니다.</p>
<p><img data-src="/images/posts/http-requests-responses/http-requests-responses-04.png" alt="HandlerAdapter 구현체"></p>
<p>다른 클래스와 달리 AbstractHandlerMethodAdapter는 추상클래스로 되어있으니 한번 더 클래스를 찾아봅니다.</p>
<p><img data-src="/images/posts/http-requests-responses/http-requests-responses-05.png" alt="RequestMappingHandlerAdapter"></p>
<p>한번이라도 스프링의 컨트롤러를 작성하신분들이라면 눈에 들어오는 것이 있습니다. 바로 <code>RequestMapping</code> 어노테이션입니다. RequestMappingHandlerAdapter 클래스의 주석을 살펴보면 핸들러 함수에 선언된 RequestMapping을 지원하는 AbstractHandlerMethodAdapter의 <code>확장</code>이라고 합니다. 그러니까 여러분이 @RequestMapping이나 @GetMapping, @PostMapping등의 어노테이션을 선언하여 컨트롤러의 핸들러 함수를 작성하면 RequestMappingHandlerAdapter를 통해 처리가 수행된다는 거죠.</p>
<p>직접 찾아보시는 분들이라면 RequestMappingHandlerAdapter의 수많은 함수 중에서 handleInternal으로 요청이 처리됨을 확인할 수 있을겁니다. 그리고 invokeHandlerMethod를 호출해서 여러분이 작성한 핸들러 함수를 실행합니다. </p>
<p><img data-src="/images/posts/http-requests-responses/http-requests-responses-06.png" alt="Spring 4.2+ invokeHandlerMethod"></p>
<blockquote>
<p>위 invokeHandlerMethod는 스프링 5 기준의 코드인데 스프링 4.2가 명시되어있는 것을 보면 이전에는 다른 함수를 호출했을 것 같습니다. 스프링 4.2 이전 버전으로 개발하고 있으신 분들이라면 직접 찾아보시기 바랍니다. 귀찮아요…ㅠㅠ</p>
</blockquote>
<p>RequestMappingHandlerAdapter는 스프링 3.1부터 추가되었으니 RequestMappingHandlerAdapter를 바로 찾으시면 됩니다. </p>
<p>여러분이 작성한 컨트롤러의 핸들러 함수를 호출하는 부분이므로 코드를 좀 자세히 보도록 하겠습니다.</p>
<pre class="language-java" data-language="java"><div class="caption"><span>invokeHandlerMethod</span></div><code class="language-java"><span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">ModelAndView</span> <span class="token function">invokeHandlerMethod</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
        <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">HandlerMethod</span> handlerMethod<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">ServletWebRequest</span> webRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServletWebRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">WebDataBinderFactory</span> binderFactory <span class="token operator">=</span> <span class="token function">getDataBinderFactory</span><span class="token punctuation">(</span>handlerMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ModelFactory</span> modelFactory <span class="token operator">=</span> <span class="token function">getModelFactory</span><span class="token punctuation">(</span>handlerMethod<span class="token punctuation">,</span> binderFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ServletInvocableHandlerMethod</span> invocableMethod <span class="token operator">=</span> <span class="token function">createInvocableHandlerMethod</span><span class="token punctuation">(</span>handlerMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>argumentResolvers <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            invocableMethod<span class="token punctuation">.</span><span class="token function">setHandlerMethodArgumentResolvers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>argumentResolvers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>returnValueHandlers <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            invocableMethod<span class="token punctuation">.</span><span class="token function">setHandlerMethodReturnValueHandlers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>returnValueHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        invocableMethod<span class="token punctuation">.</span><span class="token function">setDataBinderFactory</span><span class="token punctuation">(</span>binderFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        invocableMethod<span class="token punctuation">.</span><span class="token function">setParameterNameDiscoverer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>parameterNameDiscoverer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ModelAndViewContainer</span> mavContainer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndViewContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mavContainer<span class="token punctuation">.</span><span class="token function">addAllAttributes</span><span class="token punctuation">(</span><span class="token class-name">RequestContextUtils</span><span class="token punctuation">.</span><span class="token function">getInputFlashMap</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        modelFactory<span class="token punctuation">.</span><span class="token function">initModel</span><span class="token punctuation">(</span>webRequest<span class="token punctuation">,</span> mavContainer<span class="token punctuation">,</span> invocableMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mavContainer<span class="token punctuation">.</span><span class="token function">setIgnoreDefaultModelOnRedirect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ignoreDefaultModelOnRedirect<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">AsyncWebRequest</span> asyncWebRequest <span class="token operator">=</span> <span class="token class-name">WebAsyncUtils</span><span class="token punctuation">.</span><span class="token function">createAsyncWebRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        asyncWebRequest<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>asyncRequestTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">WebAsyncManager</span> asyncManager <span class="token operator">=</span> <span class="token class-name">WebAsyncUtils</span><span class="token punctuation">.</span><span class="token function">getAsyncManager</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        asyncManager<span class="token punctuation">.</span><span class="token function">setTaskExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>taskExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        asyncManager<span class="token punctuation">.</span><span class="token function">setAsyncWebRequest</span><span class="token punctuation">(</span>asyncWebRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        asyncManager<span class="token punctuation">.</span><span class="token function">registerCallableInterceptors</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>callableInterceptors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        asyncManager<span class="token punctuation">.</span><span class="token function">registerDeferredResultInterceptors</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deferredResultInterceptors<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>asyncManager<span class="token punctuation">.</span><span class="token function">hasConcurrentResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Object</span> result <span class="token operator">=</span> asyncManager<span class="token punctuation">.</span><span class="token function">getConcurrentResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mavContainer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ModelAndViewContainer</span><span class="token punctuation">)</span> asyncManager<span class="token punctuation">.</span><span class="token function">getConcurrentResultContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            asyncManager<span class="token punctuation">.</span><span class="token function">clearConcurrentResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">LogFormatUtils</span><span class="token punctuation">.</span><span class="token function">traceDebug</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> traceOn <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">String</span> formatted <span class="token operator">=</span> <span class="token class-name">LogFormatUtils</span><span class="token punctuation">.</span><span class="token function">formatValue</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token operator">!</span>traceOn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">"Resume with async result ["</span> <span class="token operator">+</span> formatted <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            invocableMethod <span class="token operator">=</span> invocableMethod<span class="token punctuation">.</span><span class="token function">wrapConcurrentResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        invocableMethod<span class="token punctuation">.</span><span class="token function">invokeAndHandle</span><span class="token punctuation">(</span>webRequest<span class="token punctuation">,</span> mavContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>asyncManager<span class="token punctuation">.</span><span class="token function">isConcurrentHandlingStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> <span class="token function">getModelAndView</span><span class="token punctuation">(</span>mavContainer<span class="token punctuation">,</span> modelFactory<span class="token punctuation">,</span> webRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        webRequest<span class="token punctuation">.</span><span class="token function">requestCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>아직까지 용도는 모르겠으나 핸들러 함수를 기반으로 WebDataBinderFactory, ModelFactory, ServletInvocableHandlerMethod를 구성하고 ServletInvocableHandlerMethod를 통해 ServletWebRequest와 ModelAndViewContainer로 핸들러 함수를 실행하고 처리하는 것을 확인할 수 있습니다.</p>
<p>처리하는 부분이 ServletInvocableHandlerMethod로 감싸져있는 것 같으니 다시 찾아가봅시다.</p>
<pre class="language-java" data-language="java"><div class="caption"><span>ServletInvocableHandlerMethod.invokeAndHandle</span></div><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invokeAndHandle</span><span class="token punctuation">(</span><span class="token class-name">ServletWebRequest</span> webRequest<span class="token punctuation">,</span> <span class="token class-name">ModelAndViewContainer</span> mavContainer<span class="token punctuation">,</span>
        <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> providedArgs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">Object</span> returnValue <span class="token operator">=</span> <span class="token function">invokeForRequest</span><span class="token punctuation">(</span>webRequest<span class="token punctuation">,</span> mavContainer<span class="token punctuation">,</span> providedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setResponseStatus</span><span class="token punctuation">(</span>webRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>returnValue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRequestNotModified</span><span class="token punctuation">(</span>webRequest<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">getResponseStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> mavContainer<span class="token punctuation">.</span><span class="token function">isRequestHandled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">disableContentCachingIfNecessary</span><span class="token punctuation">(</span>webRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mavContainer<span class="token punctuation">.</span><span class="token function">setRequestHandled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span><span class="token function">getResponseStatusReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        mavContainer<span class="token punctuation">.</span><span class="token function">setRequestHandled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    mavContainer<span class="token punctuation">.</span><span class="token function">setRequestHandled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>returnValueHandlers <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"No return value handlers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>returnValueHandlers<span class="token punctuation">.</span><span class="token function">handleReturnValue</span><span class="token punctuation">(</span>
                returnValue<span class="token punctuation">,</span> <span class="token function">getReturnValueType</span><span class="token punctuation">(</span>returnValue<span class="token punctuation">)</span><span class="token punctuation">,</span> mavContainer<span class="token punctuation">,</span> webRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token function">formatErrorForReturnValue</span><span class="token punctuation">(</span>returnValue<span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>invokeForRequest 함수로 요청을 처리하고 리턴된 값을 returnValueHandlers로 다시 처리하는 것을 확인할 수 있습니다. 코드의 순서를 볼때 invokeForRequest가 여러분이 작성한 핸들러 함수가 호출되는 부분이고 핸들러 함수에서 리턴한 값을 스프링에서 returnValueHandlers로 다시 처리하는 거라고 예상할 수 있습니다.</p>
<p>returnValueHandlers 유형을 찾아보면 <code>HandlerMethodReturnValueHandlerComposite</code>인 것을 확인할 수 있습니다. HandlerMethodReturnValueHandlerComposite는 <code>HandlerMethodReturnValueHandler</code> 구현체로 HandlerMethodReturnValueHandler의 목록을 통해 여러분이 핸들러 함수에서 리턴한 유형에 따라 HandlerMethodReturnValueHandler으로 처리하도록 구현되어있습니다.</p>
<pre class="language-java" data-language="java"><div class="caption"><span>HandlerMethodReturnValueHandlerComposite</span></div><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleReturnValue</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> returnValue<span class="token punctuation">,</span> <span class="token class-name">MethodParameter</span> returnType<span class="token punctuation">,</span>
        <span class="token class-name">ModelAndViewContainer</span> mavContainer<span class="token punctuation">,</span> <span class="token class-name">NativeWebRequest</span> webRequest<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">HandlerMethodReturnValueHandler</span> handler <span class="token operator">=</span> <span class="token function">selectHandler</span><span class="token punctuation">(</span>returnValue<span class="token punctuation">,</span> returnType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unknown return value type: "</span> <span class="token operator">+</span> returnType<span class="token punctuation">.</span><span class="token function">getParameterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    handler<span class="token punctuation">.</span><span class="token function">handleReturnValue</span><span class="token punctuation">(</span>returnValue<span class="token punctuation">,</span> returnType<span class="token punctuation">,</span> mavContainer<span class="token punctuation">,</span> webRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>그러면 여러분이 핸들러 함수에서 리턴한 값에 따라 처리를 담당하는 HandlerMethodReturnValueHandler 구현체가 있다는 것으로 이해할 수 있습니다. </p>
<h4 id="HandlerMethodReturnValueHandler"><a href="#HandlerMethodReturnValueHandler" class="headerlink" title="HandlerMethodReturnValueHandler"></a>HandlerMethodReturnValueHandler</h4><p>HandlerMethodReturnValueHandler 구현체를 찾아보면 다음과 같이 나옵니다.</p>
<p><img data-src="/images/posts/http-requests-responses/http-requests-responses-07.png" alt="HandlerMethodReturnValueHandler 구현체"></p>
<p>사실 HandlerMethodReturnValueHandler 구현체 목록은 스프링 공식 레퍼런스를 참고하시는 분들이라면 <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-return-types">Handler Methods Return Values</a>에서 확인하셨을 겁니다.</p>
<blockquote>
<p>이 글을 보는 대부분의 초보 개발자는 레퍼런스를 참고하지 않을 수 있습니다. 이게 바로 공식 레퍼런스를 참고하는 이유라고 할 수 있겠죠?</p>
</blockquote>
<p>간단하게 정리해보면 다음과 같습니다.</p>
<table>
<thead>
<tr>
<th align="left">Return Value</th>
<th align="left">HandlerMethodReturnValueHandler</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">String</td>
<td align="left">ViewNameMethodReturnValueHandler</td>
<td align="left">ViewResolver 구현체에 의해 View Name으로 처리</td>
</tr>
<tr>
<td align="left">View</td>
<td align="left">ViewMethodReturnValueHandler</td>
<td align="left">View 인스턴스로 렌더링</td>
</tr>
<tr>
<td align="left">Map</td>
<td align="left">MapMethodProcessor</td>
<td align="left">Map을 ModelAndView 속성으로 처리</td>
</tr>
<tr>
<td align="left">Model</td>
<td align="left">ModelMethodProcessor</td>
<td align="left">Model을 Map으로 변환하여 ModelAndView 속성으로 처리</td>
</tr>
<tr>
<td align="left">@ResponseBody</td>
<td align="left">AbstractMessageConverterMethodProcessor</td>
<td align="left">리턴 값을 HttpMessageConverter 구현체로 변환해서 응답</td>
</tr>
<tr>
<td align="left">void</td>
<td align="left">ModelAndViewMethodReturnValueHandler</td>
<td align="left">ServletResponse 또는 @ResponseStatus로 처리</td>
</tr>
<tr>
<td align="left">ModelAndView</td>
<td align="left">ModelAndViewMethodReturnValueHandler</td>
<td align="left">View, Model Attritube, Response Status로 처리</td>
</tr>
</tbody></table>
<p>여러분이 작성한 컨트롤러 핸들러 함수가 리턴한 값에 <code>@ResponseBody</code> 어노테이션을 명시하는 것은 <code>AbstractMessageConverterMethodProcessor</code>를 통해 메시지 컨버터로 변환해서 응답한다는 것을 의미합니다. 또한, @ResponseBody 없이 <code>Map</code>을 리턴한다는 것은 <code>MapMethodProcessor</code>을 통해 Map에 있는 값들을 ModelAndView의 애트리뷰트로 넣어서 응답한다는 것을 의미하죠.</p>
<p>결국 <code>@ResponseBody</code>를 사용한다는 것은 리턴 값에 대한 <code>메시지 컨버터</code>를 알고 있어야 한다는 것을 의미합니다. 예를 들어, OKKY에 공유한 <a href="https://okky.kr/article/387101">스프링 버전별 Jackson 관련 라이브러리 및 메시지 컨버터 정보</a>에 따르면 스프링 버전에 따라 JSON으로 변환하기 위한 메시지 컨버터 지원이 다르기 때문에 여러분이 사용중인 스프링 버전에 따라 라이브러리를 의존해야하고 알맞는 메시지 컨버터가 등록되어있어야함을 뜻합니다.</p>
<p><code>스프링 4 이상</code>의 버전을 사용중인데 대부분의 블로그에서 제시하는 <code>MappingJacksonHttpMessageConverter</code>는 미지원하기 때문에 <code>org.codehaus.jackson</code> 라이브러리를 의존성에 가지고 있다고 해도 메시지 컨버터는 등록되지 않습니다. 반대로 <code>스프링 4 미만</code>의 버전을 사용중인데 <code>MappingJackson2HttpMessageConverter</code>를 등록하고 <code>com.fasterxml.jackson.core</code> 라이브러리를 의존하는 것도 의미 없는 행위라고 할 수 있죠.</p>
<p>이렇게 스프링 버전에 따라 의존해야하는 라이브러리 버전이 존재함에 따라 의존성 라이브러리 버전을 관리하는 <a href="https://mvnrepository.com/artifact/org.springframework/spring-framework-bom"><br>Spring Framework (Bill of Materials)</a>을 제공하기도 합니다.</p>
<p>여기까지 확인한 바로는 HandlerAdapter로 여러분이 작성한 핸들러를 찾아 호출하고 핸들러 함수의 리턴값에 따라 HandlerMethodReturnValueHandler로 응답하는 것을 확인했습니다. 그런데 눈치 빠르신분들은 한가지 과정을 빼먹었다고 느끼실 것입니다. 바로 HTTP 요청에 포함된 데이터를 가져오는 부분인데 스프링에서는 <code>데이터 바인딩</code>이라고 부르는 과정입니다. 이 데이터 바인딩 과정은 RequestMappingHandlerAdapter의 invokeHandlerMethod에 이미 포함되어있습니다.</p>
<p>바로 WebDataBinderFactory를 만들고 ServletInvocableHandlerMethod에 setHandlerMethodArgumentResolvers로 HandlerMethodArgumentResolverComposite를 설정하는 부분입니다.</p>
<h4 id="WebDataBinder"><a href="#WebDataBinder" class="headerlink" title="WebDataBinder"></a>WebDataBinder</h4><p>WebDataBinder는 HTTP 요청 파라미터를 자바 빈즈 오브젝트로 데이터를 바인딩하는데 여러분이 HTTP 요청 시 데이터를 쿼리 파라미터로 전송하거나 폼 데이터 형식으로 보내는 경우 스프링은 WebDataBinder로 여러분의 도메인 클래스에 데이터를 주입합니다. 이때 <a href="https://www.oracle.com/java/technologies/javase/javabeans-spec.html">JavaBeans 스펙</a>에 따르므로 프로퍼티 표현식과 Getter, Setter에 따라 데이터를 바인딩합니다.</p>
<h4 id="HandlerMethodArgumentResolver"><a href="#HandlerMethodArgumentResolver" class="headerlink" title="HandlerMethodArgumentResolver"></a>HandlerMethodArgumentResolver</h4><p>HandlerMethodReturnValueHandler가 리턴 값에 따라 응답을 처리한다면 HandlerMethodArgumentResolver는 컨트롤러 핸들러 함수에 존재하는 매개변수 유형에 따라 데이터 주입을 해주는 역할을 수행합니다. HandlerMethodArgumentResolver도 인터페이스 이므로 실제로 동작을 수행하는 구현체를 찾아야합니다.</p>
<p>스프링 5 기준의 RequestMappingHandlerAdapter에는 기본적으로 적용되는 HandlerMethodArgumentResolver 목록이 있습니다.</p>
<pre class="language-java" data-language="java"><div class="caption"><span>RequestMappingHandlerAdapter.getDefaultArgumentResolvers</span></div><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HandlerMethodArgumentResolver</span><span class="token punctuation">></span></span> <span class="token function">getDefaultArgumentResolvers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HandlerMethodArgumentResolver</span><span class="token punctuation">></span></span> resolvers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Annotation-based argument resolution</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestParamMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestParamMapMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PathVariableMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PathVariableMapMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MatrixVariableMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MatrixVariableMapMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServletModelAttributeMethodProcessor</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestResponseBodyMethodProcessor</span><span class="token punctuation">(</span><span class="token function">getMessageConverters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestResponseBodyAdvice<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestPartMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token function">getMessageConverters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestResponseBodyAdvice<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestHeaderMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestHeaderMapMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServletCookieValueMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ExpressionValueMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SessionAttributeMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestAttributeMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Type-based argument resolution</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServletRequestMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServletResponseMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpEntityMethodProcessor</span><span class="token punctuation">(</span><span class="token function">getMessageConverters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestResponseBodyAdvice<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RedirectAttributesMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ModelMethodProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapMethodProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ErrorsMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SessionStatusMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UriComponentsBuilderMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KotlinDetector</span><span class="token punctuation">.</span><span class="token function">isKotlinPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContinuationHandlerMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Custom arguments</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getCustomArgumentResolvers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        resolvers<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token function">getCustomArgumentResolvers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Catch-all</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrincipalMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestParamMethodArgumentResolver</span><span class="token punctuation">(</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServletModelAttributeMethodProcessor</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> resolvers<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>여러분이 주로 사용하거나 대부분의 예제에서 사용하는 몇가지 HandlerMethodArgumentResolver 구현체는 다음과 같습니다.</p>
<table>
<thead>
<tr>
<th align="left">Argument Type</th>
<th align="left">HandlerMethodArgumentResolver</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">@RequestParam</td>
<td align="left">RequestParamMethodArgumentResolver</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">@PathVariable</td>
<td align="left">PathVariableMethodArgumentResolver</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">@ModelAttribute</td>
<td align="left">ServletModelAttributeMethodProcessor</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">@RequestBody</td>
<td align="left">RequestResponseBodyMethodProcessor</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">@RequestPart, MultipartFile, Part</td>
<td align="left">RequestPartMethodArgumentResolver</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">WebRequest, ServletRequest, MultipartRequest, InputStream</td>
<td align="left">ServletRequestMethodArgumentResolver</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">HttpSession, Principal, Locale, TimeZone, ZoneId</td>
<td align="left">ServletRequestMethodArgumentResolver</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">ServletResponse, OutputStream, Writer</td>
<td align="left">ServletResponseMethodArgumentResolver</td>
<td align="left"></td>
</tr>
</tbody></table>
<p>예를 들어, <code>@ModelAttribute</code>를 핸들러 함수 매개변수에 선언하는 것은 <code>ServletModelAttributeMethodProcessor</code>에 의해 WebDataBinder로 데이터 바인딩을 수행하는 것이며 <code>@RequestBody</code>를 핸들러 함수 매개변수에 선언하는 것은 <code>RequestResponseBodyMethodProcessor</code>에 의해 HTTP 요청 페이로드를 매개변수 형식으로 메시지 컨버터로 변환한다는 것을 의미합니다.</p>
<p>여기까지 확인함으로써 스프링 웹 애플리케이션에서 HTTP 요청을 처리할 핸들러 함수를 작성하는 것에 따라 어떻게 데이터 바인딩하고 리턴값에 따른 응답을 처리하는 지 알게되었습니다. 상세하게 알아본 것은 아니기 때문에 아쉬움이 있지만 요청과 응답 과정에서 사용되는 클래스만 알아도 무방합니다.</p>
<p>시간이 있다면 각 클래스가 어떤식으로 작성되어있는지를 확인해보시는 것도 여러분의 코드 작성 스타일에 도움이 됩니다. 스프링 프레임워크를 담당하는 개발자들은 여러분보다 확실히 뛰어난 개발자이고 정해진 스타일에 따라 코드를 작성합니다.</p>
<h2 id="요청-응답-케이스"><a href="#요청-응답-케이스" class="headerlink" title="요청 응답 케이스"></a>요청 응답 케이스</h2><p>그냥 마무리하기에는 아쉬움이 많으므로 OKKY에 올라오는 질문글 중 HTTP 요청과 응답에 대한 여러가지 케이스를 정리해보도록 하겠습니다.</p>
<h3 id="415-Unsupported-Media-Type"><a href="#415-Unsupported-Media-Type" class="headerlink" title="415 Unsupported Media Type"></a>415 Unsupported Media Type</h3><p>클라이언트 요청에 대하여 서버가 415 오류를 응답하는 경우 핸들러 함수가 클라이언트가 설정한 Content-Type 유형을 처리할 수 없는 것을 말합니다. </p>
<p><a href="https://okky.kr/article/558309">https://okky.kr/article/558309</a></p>
<p>위 질문글의 일차적인 문제점은 컨트롤러 핸들러 함수는 <code>application/x-www-form-urlencoded</code>를 처리하도록 작성해놓고 정작 클라이언트에서는 <code>application/json</code>으로 요청해버렸습니다. 그런데 Content-Type을 정상적으로 설정해도 또 다른 문제점을 내포하고 있었습니다. 이 글에서 다루었던 스프링 버전별 Jackson 라이브러리 의존성이 다르다는 부분입니다. 질문자는 스프링 4 이상부터 사용할 수 있는 Jackson 2 라이브러리를 추가하였고 vernum님이 남기신 링크로 해결하신 것 같아보이는데 해당 링크로 들어가보면 MappingJacksonHttpMessageConverter를 사용하고 org.codehaus.jackson 라이브러리를 의존성에 추가한 것을 확인할 수 있습니다.</p>
<h3 id="406-Not-Acceptable"><a href="#406-Not-Acceptable" class="headerlink" title="406 Not Acceptable"></a>406 Not Acceptable</h3><p>클라이언트 요청에 대하여 서버가 406 오류를 응답하는 경우 클라이언트가 지정한 Accept 헤더에 따라 서버에서 HTTP 메시지를 구성할 수 없음을 말합니다. </p>
<p><a href="https://okky.kr/article/876362">https://okky.kr/article/876362</a><br><a href="https://okky.kr/article/878053">https://okky.kr/article/878053</a><br><a href="https://okky.kr/article/878257">https://okky.kr/article/878257</a></p>
<p>위 질문자님은 무려 3번이나 406 오류에 대한 질문을 하지만 애초에 HTTP 요청과 응답에 대한 이해가 없었기 때문에 답변해주시는 분들이 뭐를 바꿔바라 이걸 지정해라해줘도 바꿔봤는데 안된다는 말만 되풀이하십니다.</p>
<p>핸들러 함수에서 System.out은 잘 출력된다는 것을 보면 핸들러 함수 리턴값을 HTTP 응답으로 변환할 때 클라이언트가 요청한 형식으로 바꾸지 못한다는 것을 예상할 수 있겠습니다. 이 글에서 @ResponseBody를 선언하면 응답 유형에 따른 메시지 컨버터를 찾아 응답으로 변환하는 것을 확인했었습니다. 그래서 메시지 컨버터가 잘 등록되어있는지를 의심해봐야합니다. 이분의 경우 <strong>Jackson 2 라이브러리를 의존</strong> 하고 메시지 컨버터로 <strong>MappingJacksonHttpMessageConverter</strong> 를 사용하고 있기 때문에 잘못된 구성을 하셔서 발생하셨을 겁니다. MappingJacksonHttpMessageConverter는 스프링 웹 모듈이 가지고 있기 때문에 오류는 나지 않겠지만 MappingJacksonHttpMessageConverter가 필요로 하는 Jackson 라이브러리가 없기 때문에 처리할 수 없습니다.</p>
<h3 id="데이터-바인딩-규칙"><a href="#데이터-바인딩-규칙" class="headerlink" title="데이터 바인딩 규칙"></a>데이터 바인딩 규칙</h3><p>스프링 뿐만 아니라 Jackson 이나 Lombok과 같은 라이브러리도 기본적으로 <code>JavaBeans</code> 스펙에 따라 동작합니다. 다시 말해서 HTTP 요청에 포함된 데이터를 자바 도메인 클래스에 주입하기 위한 <code>규칙</code>이 있다는 말인데요. </p>
<p>먼저, 다음 질문을 살펴봅시다.</p>
<p><a href="https://okky.kr/article/532781">https://okky.kr/article/532781</a></p>
<p>위 질문의 경우 @RequestBody 어노테이션을 지정해서 데이터 바인딩을 시도했으나 DTO에 데이터가 주입되지 않은 상황입니다. 그런데 DTO에는 필드명을 UpperCase로 작성하셨습니다. 그런데 Jackson 라이브러리는 기본적으로 일반적인 자바 네이밍 규칙에 따라 소문자로 시작하는 카멜 케이스로 데이터를 바인딩하도록 되어있습니다. 필드명을 바꿔서 해결하신지는 모르겠으나 만약, 필드명을 UpperCase로 하고 데이터 바인딩을 적용하고 싶다면 클래스 단위로 <code>@JsonNaming</code>을 선언하거나 필드에 <code>@JsonProperty</code>를 지정하시면 됩니다.</p>
<p>두번째 데이터 바인딩 규칙은 데이터가 포함되는 위치라고 할 수 있습니다. </p>
<p><a href="https://okky.kr/article/780096">https://okky.kr/article/780096</a></p>
<p>위 질문은 HTTP 요청 페이로드에 데이터를 포함시키고 @Modelattribute를 선언하여 데이터 바인딩을 시도하려고 하신 경우입니다. @Modelattribute는 URL에 포함되는 <code>쿼리 파라미터</code> 또는 <code>폼 데이터</code> 형식으로부터 데이터 바인딩을 수행하기 때문에 HTTP 요청 페이로드가 폼 데이터 형식이 아니므로 <code>@Modelattribute</code>로는 데이터 바인딩을 수행할 수 없습니다.</p>
<p>해당 질문자님도 정말로 @Modelattribute를 사용하고 싶었다면 클라이언트에서 Content-Type을 application&#x2F;json이 아닌 application&#x2F;x-www-form-urlencoded 형식으로 보내야겠죠?</p>
<h2 id="끝마치며"><a href="#끝마치며" class="headerlink" title="끝마치며"></a>끝마치며</h2><p>월요일부터 퇴근하고나서 짬짬히 작성한 글이므로 전체적으로 정리가 안되었을 수 있습니다. 이 부분은 양해해주시기 바라며 스프링 경험이 많지 않으신 개발자 분들에게 조금이나마 도움이 되었으면 하는 바램입니다. 이상으로 클라이언트 HTTP 요청부터 스프링 애플리케이션 응답하기까지의 과정을 마치도록 하겠습니다.</p>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>HTTP</tag>
        <tag>Content-Type</tag>
        <tag>MediaType</tag>
        <tag>MessageConverter</tag>
      </tags>
  </entry>
  <entry>
    <title>JSON Web Token</title>
    <url>/jwt/</url>
    <content><![CDATA[<p>최근 시스템에서 발송되는 특정 이메일에 포함되는 링크를 통해서 사용자가 관련된 페이지에 접근할 수 있도록 해달라는 요구사항이 있었습니다. 일반적으로 사용자가 이메일을 통해서 시스템에 접속하는 경우에는 자신의 계정과 비밀번호를 사용하여 시스템에 인증하기 전인 경우가 많습니다. 따라서, 이메일에 포함된 링크를 통해서 접근할 때 사용자 인증을 일시적으로 제공하는 방안을 도입해야합니다.</p>
<h2 id="Token-based-Authentication"><a href="#Token-based-Authentication" class="headerlink" title="Token-based Authentication"></a>Token-based Authentication</h2><p>토큰 기반 인증 매커니즘은 사용자 계정과 비밀번호를 입력하지 않아도 시스템을 이용할 수 있는 권한을 제공하기 위한 방식입니다. 여기서 토큰이라함은 시스템이 인식할 수 있는 문자열 데이터를 말합니다. 휴대폰 문자 인증이나 이메일로 발송되는 인증코드 또는 링크를 토큰이라 부를 수 있습니다.</p>
<p>현재 시스템은 Spring Security OAuth를 통해 클라이언트 크레덴셜 기반의 토큰으로 OpenAPI를 사용할 수 있도록 제공하고 있는데 JWT가 아닌 JdbcTokenStore를 사용하고 있기에 SecureRandomBytesKeyGenerator로 만들어지는 액세스 토큰을 사용하게 되어있습니다. 개발자 커뮤니티를 보면 세션 기반 인증 매커니즘이 아닌 토큰 기반으로 JWT를 발급하고 서버와 클라이언트가 통신할 때 JWT를 요청 헤더에 포함시켜 시스템에 대한 권한 및 인가를 수행할 수 있도록 구성하는 것 같습니다. </p>
<h3 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h3><p><a href="https://datatracker.ietf.org/doc/html/rfc7519">RFC7519</a>로 정의되어있는 JWT(JSON Web Token)은 사용자의 신원을 확인할 수 있는 정보를 Base64 인코딩으로 표현하면서 페이로드에 대한 전자서명을 통해서 인증 시스템에서 발급한 토큰을 신뢰할 수 있는지 검증하여 토큰에 포함된 정보를 토대로 권한 및 인가를 적용할 수 있습니다. JWT에 대해서는 아래의 링크를 통해서 간단하게 이해할 수 있습니다.</p>
<ul>
<li><a href="https://jwt.io/introduction">Introduction to JSON Web Tokens</a></li>
<li><a href="https://auth0.com/learn/json-web-tokens/">Get Started with JSON Web Tokens</a></li>
</ul>
<h3 id="URI-Query-String"><a href="#URI-Query-String" class="headerlink" title="URI Query String"></a>URI Query String</h3><p><em>JSON Web Token (JWT) is a compact claims representation format intended for space constrained environments such as HTTP Authorization headers and URI query parameters.</em></p>
<p>이메일에 포함되는 링크는 GET 요청을 수행하는 URL(URI + Query String)이므로 일반적으로 HTTP 통신 시 Authorization 또는 X-Auth-Token 헤더에 토큰을 포함하여 전달할 수 없습니다. JWT는 그 자체로 Base64 URL Safe로 인코딩되므로 쿼리 파라미터에 포함하여 전달할 수 있습니다.</p>
<h4 id="Token-Parameter"><a href="#Token-Parameter" class="headerlink" title="Token Parameter"></a>Token Parameter</h4><p>이메일에 포함되는 링크에 토큰 정보가 어떻게 담겨지는지 두가지 예시를 살펴보겠습니다. 첫번째는 이메일과 인증을 위한 토큰이 Path Variable 형태로 URI에 포함되는 방식이며, 두번째는 URI에 대한 쿼리 스트링으로 토큰 파라미터가 포함됨을 보여줍니다.</p>
<ul>
<li><a href="http://daily-devblog.com/api/regist/certify/kdevkr@gmail.com/$TOKEN">http://daily-devblog.com/api/regist/certify/kdevkr@gmail.com/$TOKEN</a></li>
<li><a href="https://careers.kakao.com/applicant/checkEmail?token=$TOKEN&amp;jobOfferId=P-1">https://careers.kakao.com/applicant/checkEmail?token=$TOKEN&amp;jobOfferId=P-1</a></li>
</ul>
<p><img data-src="/images/posts/jwt/01.png"></p>
<p>두번째처럼 이메일에 포함된 링크를 나중에 클릭하더라도 시스템에서 인식할 수 있는 토큰인지 만료되었는지를 판단하여 시스템에 대한 인가를 판단하게 됩니다. 여기서 확인할 수 있듯이 이메일에는 시스템에서 발급한 토큰이 링크에 포함되어 유지되므로 보안 상 만료 시간을 최소화하는 것이 좋습니다.</p>
<h3 id="Implementation-Sample"><a href="#Implementation-Sample" class="headerlink" title="Implementation Sample"></a>Implementation Sample</h3><p>이메일 링크에 포함된 토큰 파라미터에 따라 토큰 기반 인증 매커니즘을 수행하고 사용자 인증을 수행할 수 있는 방안을 적용해보도록 하겠습니다. 간단한 샘플 형태로 만들고 일련의 프로세스를 이해할 수 있도록 공유하고자함이니 코드를 그대로 사용하기에는 문제점이 있을 수 있습니다.</p>
<h4 id="Dependencies"><a href="#Dependencies" class="headerlink" title="Dependencies"></a>Dependencies</h4><p>우선 스프링 시큐리티 기반의 환경이라는 것을 기반으로 하며 JWT 발급과 검증을 위해서 사용할 <a href="https://github.com/jwtk/jjwt">Java JWT</a> 라이브러리와 JWT 발급 시 서명할 키 페어를 불러올 수 있도록 <a href="https://www.bouncycastle.org/">Bouncy Castle</a>를 의존성에 추가합니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>
    implementation <span class="token string">'com.google.code.gson:gson:2.9.0'</span>
    implementation <span class="token string">'io.jsonwebtoken:jjwt-api:0.11.5'</span>
    runtimeOnly <span class="token string">'io.jsonwebtoken:jjwt-impl:0.11.5'</span>
    runtimeOnly <span class="token string">'io.jsonwebtoken:jjwt-jackson:0.11.5'</span>
    implementation <span class="token string">'org.bouncycastle:bcprov-jdk18on:1.71'</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="Generate-EC-Key-Pair"><a href="#Generate-EC-Key-Pair" class="headerlink" title="Generate EC Key Pair"></a>Generate EC Key Pair</h4><p>본 샘플에서는 <a href="https://datatracker.ietf.org/doc/html/rfc7518#section-3">Cryptographic Algorithms for Digital Signatures and MACs</a> 목록 중에서 ES256이라는 서명 알고리즘을 사용하는 JWT 토큰을 발급하기 위해 P-256 곡선을 사용하는 EC 키 페어를 생성합니다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">openssl ecparam -name prime256v1 -genkey -noout -out ec-private.pem
openssl ec -in ec-private.pem -pubout -out ec-public.pem
openssl pkcs8 -topk8 -inform pem -in ec-private.pem -outform pem -nocrypt -out ec-private.pkcs8</code></pre>

<h4 id="Generate-JWT"><a href="#Generate-JWT" class="headerlink" title="Generate JWT"></a>Generate JWT</h4><p>JWT 발급을 위한 EC 키 페어를 준비했으므로 클래스패스로부터 키 페어를 불러오고 토큰 발급을 위한 유틸 클래스를 작성합니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>util</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token class-name">SignatureAlgorithm</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>bouncycastle<span class="token punctuation">.</span>util<span class="token punctuation">.</span>io<span class="token punctuation">.</span>pem<span class="token punctuation">.</span></span><span class="token class-name">PemReader</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ClassPathResource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StreamUtils</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">SecretKeySpec</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>bind<span class="token punctuation">.</span></span><span class="token class-name">DatatypeConverter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">StringReader</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">Key</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">KeyFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">PKCS8EncodedKeySpec</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">X509EncodedKeySpec</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentHashMap</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KeyUtil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">KeyUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Key</span><span class="token punctuation">></span></span> signingKeyStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Key</span><span class="token punctuation">></span></span> parseKeyStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Key</span> <span class="token function">parseKey</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span> signatureAlgorithm<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Key</span> key <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parseKeyStore<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>signatureAlgorithm<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            key <span class="token operator">=</span> parseKeyStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>signatureAlgorithm<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> key<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> content<span class="token punctuation">;</span>
            <span class="token class-name">PemReader</span> pemReader<span class="token punctuation">;</span>
            <span class="token class-name">X509EncodedKeySpec</span> spec<span class="token punctuation">;</span>
            <span class="token class-name">KeyFactory</span> kf<span class="token punctuation">;</span>

            <span class="token keyword">switch</span> <span class="token punctuation">(</span>signatureAlgorithm<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">case</span> HS256<span class="token operator">:</span>
                    content <span class="token operator">=</span> <span class="token class-name">StreamUtils</span><span class="token punctuation">.</span><span class="token function">copyToString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">"jwt/hs256/secret.key"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span><span class="token class-name">DatatypeConverter</span><span class="token punctuation">.</span><span class="token function">parseBase64Binary</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span> signatureAlgorithm<span class="token punctuation">.</span><span class="token function">getJcaName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> RS256<span class="token operator">:</span>
                    content <span class="token operator">=</span> <span class="token class-name">StreamUtils</span><span class="token punctuation">.</span><span class="token function">copyToString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">"jwt/rs256/rsa-public.pem"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pemReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PemReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    spec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">X509EncodedKeySpec</span><span class="token punctuation">(</span>pemReader<span class="token punctuation">.</span><span class="token function">readPemObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    kf <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"RSA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    key <span class="token operator">=</span> kf<span class="token punctuation">.</span><span class="token function">generatePublic</span><span class="token punctuation">(</span>spec<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> ES256<span class="token operator">:</span>
                    content <span class="token operator">=</span> <span class="token class-name">StreamUtils</span><span class="token punctuation">.</span><span class="token function">copyToString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">"jwt/es256/ec-public.pem"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pemReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PemReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    spec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">X509EncodedKeySpec</span><span class="token punctuation">(</span>pemReader<span class="token punctuation">.</span><span class="token function">readPemObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    kf <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"EC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Elliptic Curve</span>
                    key <span class="token operator">=</span> kf<span class="token punctuation">.</span><span class="token function">generatePublic</span><span class="token punctuation">(</span>spec<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">"Only support HS256, RS256, ES256"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        parseKeyStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>signatureAlgorithm<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> key<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Key</span> <span class="token function">signingKey</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span> signatureAlgorithm<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Key</span> key <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>signingKeyStore<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>signatureAlgorithm<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            key <span class="token operator">=</span> signingKeyStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>signatureAlgorithm<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> key<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> content<span class="token punctuation">;</span>
            <span class="token class-name">PemReader</span> pemReader<span class="token punctuation">;</span>
            <span class="token class-name">PKCS8EncodedKeySpec</span> spec<span class="token punctuation">;</span>
            <span class="token class-name">KeyFactory</span> kf<span class="token punctuation">;</span>

            <span class="token keyword">switch</span> <span class="token punctuation">(</span>signatureAlgorithm<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">case</span> HS256<span class="token operator">:</span>
                    content <span class="token operator">=</span> <span class="token class-name">StreamUtils</span><span class="token punctuation">.</span><span class="token function">copyToString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">"jwt/hs256/secret.key"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span><span class="token class-name">DatatypeConverter</span><span class="token punctuation">.</span><span class="token function">parseBase64Binary</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span> signatureAlgorithm<span class="token punctuation">.</span><span class="token function">getJcaName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> RS256<span class="token operator">:</span>
                    content <span class="token operator">=</span> <span class="token class-name">StreamUtils</span><span class="token punctuation">.</span><span class="token function">copyToString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">"jwt/rs256/rsa-private.pem"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pemReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PemReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    spec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PKCS8EncodedKeySpec</span><span class="token punctuation">(</span>pemReader<span class="token punctuation">.</span><span class="token function">readPemObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    kf <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"RSA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    key <span class="token operator">=</span> kf<span class="token punctuation">.</span><span class="token function">generatePrivate</span><span class="token punctuation">(</span>spec<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> ES256<span class="token operator">:</span>
                    content <span class="token operator">=</span> <span class="token class-name">StreamUtils</span><span class="token punctuation">.</span><span class="token function">copyToString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">"jwt/es256/ec-private.pkcs8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pemReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PemReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    spec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PKCS8EncodedKeySpec</span><span class="token punctuation">(</span>pemReader<span class="token punctuation">.</span><span class="token function">readPemObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    kf <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"EC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Elliptic Curve</span>
                    key <span class="token operator">=</span> kf<span class="token punctuation">.</span><span class="token function">generatePrivate</span><span class="token punctuation">(</span>spec<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">"Only support HS256, RS256, ES256"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        signingKeyStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>signatureAlgorithm<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> key<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>

<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>util</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>gson<span class="token punctuation">.</span></span><span class="token class-name">Gson</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>gson<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">TypeToken</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Type</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">Key</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">ZonedDateTime</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtUtil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> REGEX <span class="token operator">=</span> <span class="token string">"^[A-Za-z0-9-_=]+\\.[A-Za-z0-9-_=]+\\.?[A-Za-z0-9-_.+/=]*$"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Type</span> hashMapType <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypeToken</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HashMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">JwtUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isJwt</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> token <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>token<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> token<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>REGEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isValid</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isJwt</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">isValid</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token function">alg</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isValid</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">,</span> <span class="token class-name">String</span> alg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Key</span> publicKey <span class="token operator">=</span> <span class="token class-name">KeyUtil</span><span class="token punctuation">.</span><span class="token function">signingKey</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>alg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JwtParser</span> parser <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parserBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> parser<span class="token punctuation">.</span><span class="token function">isSigned</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">alg</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isJwt</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chunks <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\\."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> header <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getUrlDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>chunks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> headerMap <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> hashMapType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> headerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"alg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token class-name">String</span> subject<span class="token punctuation">,</span> <span class="token keyword">long</span> expires<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> claims<span class="token punctuation">,</span> <span class="token class-name">SignatureAlgorithm</span> signatureAlgorithm<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">long</span> issuedAt <span class="token operator">=</span> <span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">getTimeZone</span><span class="token punctuation">(</span><span class="token string">"UTC"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInstant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEpochMilli</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> expiration <span class="token operator">=</span> issuedAt <span class="token operator">+</span> expires<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Key</span> signingKey <span class="token operator">=</span> <span class="token class-name">KeyUtil</span><span class="token punctuation">.</span><span class="token function">signingKey</span><span class="token punctuation">(</span>signatureAlgorithm<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>signingKey <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JwtException</span><span class="token punctuation">(</span><span class="token string">"Not found signingKey for "</span> <span class="token operator">+</span> signatureAlgorithm<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setHeaderParam</span><span class="token punctuation">(</span><span class="token string">"typ"</span><span class="token punctuation">,</span> <span class="token string">"JWT"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setIssuer</span><span class="token punctuation">(</span><span class="token string">"JWT Sample Issuer"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>issuedAt<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>expiration<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span>signingKey<span class="token punctuation">,</span> signatureAlgorithm<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">addClaims</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedJwtException</span><span class="token punctuation">(</span><span class="token string">"Cannot generate jwt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Jws</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Claims</span><span class="token punctuation">></span></span> <span class="token function">parseClaims</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">parseClaims</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token function">alg</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Jws</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Claims</span><span class="token punctuation">></span></span> <span class="token function">parseClaims</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">,</span> <span class="token class-name">String</span> alg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Key</span> publicKey <span class="token operator">=</span> <span class="token class-name">KeyUtil</span><span class="token punctuation">.</span><span class="token function">signingKey</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>alg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JwtParser</span> parser <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parserBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> parser<span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>

<h4 id="Add-Token-Filter-in-SecurityFilterChain"><a href="#Add-Token-Filter-in-SecurityFilterChain" class="headerlink" title="Add Token Filter in SecurityFilterChain"></a>Add Token Filter in SecurityFilterChain</h4><p>시스템에서 발급된 토큰이 파라미터로 전달되었을 때 JWT를 검증하고 사용자 인증을 처리할 수 있는 필터를 작성하고 스프링 시큐리티 필터 체인에 등록합니다. </p>
<p><strong>TokenAuthenticationFilter.java</strong></p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>filter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">JwtUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token class-name">Claims</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token class-name">Jws</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token class-name">JwtException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">UsernamePasswordAuthenticationToken</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SecurityContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SecurityContextHolder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetails</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetailsService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AntPathMatcher</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">OncePerRequestFilter</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">FilterChain</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenAuthenticationFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ADDITIONAL_URI_PATTERN <span class="token operator">=</span> <span class="token string">"/users/&#123;username&#125;"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AntPathMatcher</span> pathMatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">TokenAuthenticationFilter</span><span class="token punctuation">(</span><span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userDetailsService <span class="token operator">=</span> userDetailsService<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">JwtUtil</span><span class="token punctuation">.</span><span class="token function">isJwt</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> requestURI <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> base64RequestURI <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getUrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>requestURI<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> redirectLoginUrl <span class="token operator">=</span> <span class="token string">"/login?redirect="</span> <span class="token operator">+</span> base64RequestURI<span class="token punctuation">;</span>

            <span class="token keyword">boolean</span> isValidToken<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                isValidToken <span class="token operator">=</span> <span class="token class-name">JwtUtil</span><span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isValidToken<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Jws</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Claims</span><span class="token punctuation">></span></span> claims <span class="token operator">=</span> <span class="token class-name">JwtUtil</span><span class="token punctuation">.</span><span class="token function">parseClaims</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Claims</span> body <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> subject <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pathMatcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>ADDITIONAL_URI_PATTERN<span class="token punctuation">,</span> requestURI<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        isValidToken <span class="token operator">=</span> <span class="token function">isValidWithVariables</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> requestURI<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>isValidToken<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> userDetailsService<span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">,</span> token<span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">SecurityContext</span> securityContext <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        securityContext<span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span>requestURI<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">JwtException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                isValidToken <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isValidToken<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// NOTE: If token expired or invalid, redirect for login page.</span>
                response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span>redirectLoginUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isValidWithVariables</span><span class="token punctuation">(</span><span class="token class-name">Claims</span> body<span class="token punctuation">,</span> <span class="token class-name">String</span> requestURI<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> variables <span class="token operator">=</span> pathMatcher<span class="token punctuation">.</span><span class="token function">extractUriTemplateVariables</span><span class="token punctuation">(</span>ADDITIONAL_URI_PATTERN<span class="token punctuation">,</span> requestURI<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> userId <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> variables<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> variables<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><strong>SecurityConfig.java</strong><br>간단한 샘플이므로 인메모리 사용자를 등록하는 스프링 시큐리티 환경을 구성합니다. </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">TokenAuthenticationFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">HttpSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableWebSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetails</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetailsService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>provisioning<span class="token punctuation">.</span></span><span class="token class-name">InMemoryUserDetailsManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span></span><span class="token class-name">SecurityFilterChain</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">UsernamePasswordAuthenticationFilter</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// https://docs.spring.io/spring-security/reference/servlet/authentication/passwords/in-memory.html</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetailsService</span> <span class="token function">users</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">UserDetails</span> mambo <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token string">"mambo"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"&#123;noop&#125;1234"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"USER"</span><span class="token punctuation">,</span> <span class="token string">"ADMIN"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryUserDetailsManager</span><span class="token punctuation">(</span>mambo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// https://docs.spring.io/spring-security/reference/servlet/configuration/java.html#jc-httpsecurity</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">filterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">,</span> <span class="token class-name">TokenAuthenticationFilter</span> tokenAuthenticationFilter<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/users/&#123;username&#125;/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>tokenAuthenticationFilter<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="Generate-JWT-Test"><a href="#Generate-JWT-Test" class="headerlink" title="Generate JWT Test"></a>Generate JWT Test</h4><p>테스트 코드를 통해서 토큰을 발급해보고 이메일에 포함될 링크처럼 토큰 파라미터에 토큰을 포함하여 브라우저 주소에 직접 입력해봅니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">class</span> <span class="token class-name">JwtUtilTest</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertDoesNotThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> subject <span class="token operator">=</span> <span class="token string">"mambo"</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> expires <span class="token operator">=</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMinutes</span><span class="token punctuation">(</span><span class="token number">3L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            claims<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">"mambo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> jwt <span class="token operator">=</span> <span class="token class-name">JwtUtil</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> expires<span class="token punctuation">,</span> claims<span class="token punctuation">,</span> <span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span>ES256<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"\nmambo.kr:8080/users/mambo?token=&#123;&#125;"</span><span class="token punctuation">,</span> jwt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>토큰이 발급되고나서 3분 이내에는 로그인 처리가 됨을 확인할 수 있지만 만료된 이후라면 올바르게 서명된 토큰일지라도 로그인 페이지로 리디렉션됨을 확인할 수 있습니다.</p>
<blockquote>
<p>본 글에서는 JWS으로만 구성된 JWT 토큰을 발급하여 신뢰할 수 있는 발급자로부터 서명된 것임을 증명하는 것을 기반으로 사용자 인증을 수행했습니다. 다만, JWT는 암호화되지 않은 상태로 이메일과 같은 곳에 노출되어있으므로 짧은 만료 시간을 두어 제한 시간내에만 인증할 수 있도록 하였습니다.<br>좀 더 시간이 주어진다면 JWS와 함께 JWE로 클레임 페이로드가 암호화된 JWT 토큰을 발급해볼 수 있는 것도 알아봐야할 것 같습니다. 본 글에서 사용했던 jjwt 라이브러리에서는 JWE를 지원하지 않으므로 <a href="https://connect2id.com/products/nimbus-jose-jwt">Nimbus JOSE + JWT</a>로 대체해야 합니다.</p>
</blockquote>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://docs.spring.io/spring-security/reference/servlet/configuration/java.html">Spring Security Docs</a></li>
<li><a href="https://jwt.io/">JWT Debugger</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7519">RFC7519</a></li>
<li><a href="https://jwt.io/introduction">Introduction to JSON Web Tokens</a></li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>KDB Tick</title>
    <url>/kdb-tick/</url>
    <content><![CDATA[<p>에너지 분야는 나노초 또는 밀리초 단위의 시계열 데이터가 빠르게 생성되는 특수한 시장입니다. 시계열 데이터는 금융(Financial) 시장에서부터 중요성이 부각되었으나 이제는 다양한 분야에서 발생하고 이를 활용한 많은 서비스가 만들어지고 있습니다. 최소한 초 단위로 만들어지는 시계열 데이터를 빠르게 등록하고 조회할 수 있는 것을 목적으로하는 시계열 데이터베이스의 입지도 중요해지고 있고 많은 오픈소스 시계열 데이터베이스 솔루션도 만들어지고 있습니다. 현재 조직에서는 해외 금융 분야에서 어느정도 입지를 보이고 있는 시계열 데이터베이스인 KDB+를 도입하여 서비스에 사용중입니다. 라이센스 비용이 생각보다 비싸기는 하지만 고객들이 보유하는 데이터를 빠르게 수집하고 등록하기 위해서는 어쩔수 없는 선택이기도 합니다. </p>
<h2 id="KDB"><a href="#KDB" class="headerlink" title="KDB+"></a>KDB+</h2><p><a href="https://kx.com/blog/what-makes-time-series-database-kdb-so-fast/">What Makes Time-Series Database kdb+ So Fast?</a>  </p>
<p>KX Systems의 블로그 또는 <a href="https://code.kx.com/q/">Kdb+ and q documentation</a> 사이트에서 제공하는 정보를 토대로 KDB+ 프로세스에 대해서 간단하게 이해하고 활용해볼 수 있습니다. 더 나아가서는 <a href="https://code.kx.com/q/wp/">White Paper</a>를 통해서 KDB+ 프로세스를 더 효율적으로 사용하기 위한 방안을 확인할 수 있습니다. 본 글에서는 KDB+ 시계열 데이터베이스를 사용하기 위해 최소한 알아야할 부분을 다룹니다.</p>
<h3 id="데이터베이스-구조"><a href="#데이터베이스-구조" class="headerlink" title="데이터베이스 구조"></a>데이터베이스 구조</h3><p>KDB+ 프로세스에서 데이터는 기본적으로 테이블이라는 변수에 저장되며 메모리에 유지됩니다. 그러나, 서버의 메모리 자원은 한정적이므로 모든 데이터를 메모리에 유지하기에는 현실적으로 불가능합니다. KDB+ 프로세스가 사용할 수 있는 메모리가 부족하게되면 <code>&#39;wsfull</code> 오류를 보고하고 프로세스는 종료됩니다. 프로세스가 종료되면 메모리에 저장된 데이터가 모두 유실되므로 이를 보완하기 위한 방법이 필요합니다.</p>
<p>KDB+ 시계열 데이터베이스는 서버 메모리 자원보다 큰 데이터를 저장하기 위해서 디스크 파일을 활용합니다. 테이블의 데이터 규모에 따라 단일 바이너리 파일로 기록하거나 테이블의 컬럼에 대한 데이터를 <a href="https://code.kx.com/q/database/#splayed-table">각 컬럼 이름을 가진 파일을 가지는 폴더</a>로 저장합니다. 더 나아가서는 <a href="https://code.kx.com/q4m3/14_Introduction_to_Kdb+/#1432-partition-domain">숫자 또는 날짜와 같은 가상의 파티션</a>을 두어서 더 효율적으로 사용자가 데이터를 쿼리할 수 있도록 지원합니다.</p>
<h4 id="스플레이-테이블"><a href="#스플레이-테이블" class="headerlink" title="스플레이 테이블"></a>스플레이 테이블</h4><p>스플레이 테이블(Splayed Table)는 심볼과 같은 기호가 없는 완전히 열거된 테이블이어야합니다. 테이블에 심볼 형식의 컬럼이 존재한다면 <a href="https://code.kx.com/q/kb/splayed-tables/#enumerating-symbol-columns">Enumerating symbol columns</a>에서처럼 심볼 데이터가 sym 파일이라고하는 별도의 파일에 열거된 상태로 테이블을 저장해야함을 인지해야합니다.</p>
<h4 id="파티션-테이블"><a href="#파티션-테이블" class="headerlink" title="파티션 테이블"></a>파티션 테이블</h4><p>일반적으로 KDB+ 프로세스에서 스플레이 테이블을 그대로 사용하기보다는 가상의 파티션 폴더 밑에 두어서 <a href="https://code.kx.com/q/database/#partitioned-table">파티션 테이블</a>을 구성하여 로드하도록 구성합니다. 파티션 테이블(Partitioned Table)은 KDB+ 시계열 데이터베이스에서 일반적으로 구성하는 티커플랜트 아키텍처에서 HDB 프로세스를 구성하기 위해서 사용하므로 반드시 이해해야할 부분입니다.</p>
<ul>
<li><a href="https://code.kx.com/q4m3/14_Introduction_to_Kdb%2B/#142-splayed-tables">Splayed Tables</a>  </li>
<li><a href="https://code.kx.com/q4m3/14_Introduction_to_Kdb+/#143-partitioned-tables">Partitioned Tables</a>  </li>
<li><a href="https://code.kx.com/q/wp/data-management/#attributes-on-splayed-partitioned-tables">Attributes on splayed partitioned tables</a></li>
</ul>
<blockquote>
<p>파티션 테이블의 각 스플레이 테이블에 `p# 또는 `g# 속성을 적용하여 저장하는 것은 파일 데이터를 로드하여 사용하는 HDB 프로세스에 대한 쿼리 최적화를 수행할 수 있도록 지원하는 부분으로 필요에 따라 적용해야할 수 있습니다.</p>
</blockquote>
<h3 id="프로세스-통신"><a href="#프로세스-통신" class="headerlink" title="프로세스 통신"></a>프로세스 통신</h3><p>KDB+ 시계열 데이터베이스는 사용자 요청을 순차적으로 처리하는 단일 스레드를 사용하는 프로세스입니다. 아키텍처적인 관점에서는 단일 프로세스를 실행하여 활용하기보다는 용도와 목적에 맞는 여러개의 프로세스를 실행하고 <a href="https://code.kx.com/q/learn/startingkdb/ipc/#interprocess-communications">프로세스 간 통신(IPC)</a>를 통해 서로 유기적인 요청과 응답을 통해 원하는 결과를 제공할 수 있도록 구성하게 됩니다.</p>
<p>일반적으로 다음과 같이 <a href="https://code.kx.com/q/ref/hopen/#one-shot-request">One-shot request</a> 형태로 사용할 수 있습니다.</p>
<pre class="language-q" data-language="q"><code class="language-q"><span class="token symbol">`::5011</span> <span class="token string">"trade"</span>
<span class="token symbol">`::5011</span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>trade<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token verb operator">::</span><span class="token punctuation">)</span></code></pre>

<blockquote>
<p>다른 프로세스로 다수의 요청을 수행하는 경우에는 hopen 및 hclose를 통해 명시적으로 소켓을 열고 닫는것이 더 효율적입니다. 장시간 소켓을 열어두고 사용하는 것은 다양한 문제를 야기한 경험이 있으므로 개인적으로 추천하지 않습니다.</p>
</blockquote>
<h2 id="틱-아키텍처"><a href="#틱-아키텍처" class="headerlink" title="틱 아키텍처"></a>틱 아키텍처</h2><p>KDB+ 시계열 데이터베이스를 학습하는 단계에서는 단일 프로세스로도 충분합니다. 그러나, 실제로 시스템을 운용하기 위해서는 다수의 프로세스로 구성된 <a href="https://code.kx.com/q/architecture/">아키텍처</a>를 도입해야할 필요성이 있습니다. KDB+ 시계열 데이터베이스 시스템을 구성하는 가장 일반적인 아키텍처는 티커플랜트이며 금융 시장에서 사용하기 용이하도록 구성됩니다.</p>
<h3 id="티커플랜트"><a href="#티커플랜트" class="headerlink" title="티커플랜트"></a>티커플랜트</h3><p>티커플랜트(Tickerplant)는 데이터를 수집하기 위한 진입점을 제공하는 프로세스로 데이터 등록 함수에 대한 요청을 <strong>TP 로그</strong> 파일에 기록하여 시스템이 예기치 않은 상황으로 문제가 발생했을 때 복구할 수 있는 방안을 제공합니다. 또한, <a href="https://cloud.google.com/pubsub/docs/overview?hl=ko">Pub&#x2F;Sub</a>으로 데이터 피드 구독자로 등록되어있는 프로세스로 등록된 데이터를 전달하고 삭제함으로써 티커플랜트가 메모리 사용을 최소화할 수 있도록하여 경량 프로세스로 구동됩니다.</p>
<h3 id="실시간-데이터"><a href="#실시간-데이터" class="headerlink" title="실시간 데이터"></a>실시간 데이터</h3><p>실시간 데이터베이스(Realtime DB) 프로세스는 티커플랜트 프로세스에 데이터 피드 구독자로 등록되는 클라이언트 중 하나이며 티커플랜트로부터 전달받은 데이터를 메모리에 유지합니다. 그리고 티커플랜트가 전달하는 <strong>EOH(End of hour) 또는 EOD(End of day)</strong> 이벤트를 받아서 메모리에 유지했던 데이터를 현재 시간 또는 일자에 대한 파티션 테이블로 기록하고 다시 티커플랜트로부터 데이터 수신이 가능하도록 준비합니다.</p>
<blockquote>
<p>EOH 또는 EOD 이벤트가 발생하는 시점에는 메모리에 있는 데이터를 파일로 저장해야하므로 데이터 규모에 따라 CPU 연산 및 디스크 I&#x2F;O 작업에 대한 부하가 야기될 수 있습니다. 따라서, 메모리에 상주되는 데이터의 규모를 예상하고 서버 성능을 결정해야합니다.<br>KDB+ 프로세스가 파일로 기록하는 것은 디스크 I&#x2F;O 성능에 의존하므로 RDB 프로세스에 대한 병목 현상을 최소화하기 위해서는 높은 I&#x2F;O 성능을 가지는 스토리지를 고려하는게 좋습니다.</p>
</blockquote>
<h3 id="과거-파티션-데이터"><a href="#과거-파티션-데이터" class="headerlink" title="과거 파티션 데이터"></a>과거 파티션 데이터</h3><p>과거 파티션 데이터베이스(Historical DB)는 RDB 프로세스가 파티션 테이블 형태의 폴더로 기록한 과거 데이터를 로드하여 사용자 쿼리에 대한 조회 및 결과를 제공할 수 있도록 지원합니다. 데이터 규모 및 서버 자원에 따라 시간 또는 일자별 파티션으로 구성되므로 시스템이 쿼리를 수행하기에 효율적인 구조를 가지도록 고려해야합니다. 예를 들어, 시간별 파티션을 구성하는 경우에는 원하는 기간에 대한 시간 폴더의 데이터만 활용하므로 메모리를 효율적으로 사용할 수 있습니다. 그러나, 사용자 쿼리에 대한 조회 범위가 많아질수록 디스크 I&#x2F;O 작업을 수행해야하는 비효율적인 부분으로 인해 오히려 조회 시간이 늘어날 수 있습니다.</p>
<blockquote>
<p>KDB+ 프로세스는 기본적으로 순차처리임을 인지해야하며 많은 파티션을 조회하는 쿼리가 자주 요청될 가능성이 있다면 하나의 프로세스에서 시간 및 일자별 파티션을 동시에 사용할 수 있도록 지원하지 않으므로 일자별 파티션을 구성하는 별도의 HDB 프로세스를 도입하는 것을 고려해야합니다.</p>
</blockquote>
<p>사용자 요청에 대한 쿼리가 여러개의 파티션을 조회해야하는 작업이라면 <a href="https://code.kx.com/q/basics/cmdline/#-s-secondary-threads">프로세스 실행 시 지정된 보조 스레드</a>를 통해서 파티션별 조회를 병렬로 수행하도록 프로시저를 작성하여 쿼리 소요 시간을 어느정도는 최적화할 수 있습니다. 꽤 많은 쿼리가 병렬 작업을 수행하는 코드를 도입함으로써 극단적으로 쿼리 수행시간이 줄어듬을 확인할 수 있었습니다. 일반적인 케이스를 예를 들자면 단일 스레드 및 순차 처리에 의해 200ms가 소요되는 프로시저가 병렬 연산 작업 및 비효율적인 반복 작업을 수행하는 방식을 개선하고서 30ms가 소요되도록 개선되었습니다.</p>
<blockquote>
<p>개인적인 쿼리 경험에 의하면 데이터 조회에 대한 반복 작업을 최소화하는 것을 고려하고 데이터 조회시에는 병렬 작업을 수행하는 것이 효율적인지를 검토하는게 좋습니다. 그리고 일반적으로 사용되는 키워드 보다 더 적은 시간이나 메모리를 사용할 수 있는 방식을 사용하는 것이 중요합니다.</p>
</blockquote>
<p>예를 들어, Left Join을 반복 수행해야하는 경우라면 다음과 같이 연결하여 수행하도록 작성할 수 있습니다.</p>
<pre class="language-q" data-language="q"><code class="language-q">R<span class="token verb operator">:</span>A <span class="token keyword">lj</span> B<span class="token punctuation">;</span>
R<span class="token verb operator">:</span>R <span class="token keyword">lj</span> C<span class="token punctuation">;</span>
R<span class="token verb operator">:</span>R <span class="token keyword">lj</span> D<span class="token punctuation">;</span>

R<span class="token verb operator">:</span><span class="token punctuation">(</span><span class="token keyword">lj</span><span class="token adverb function">/</span><span class="token punctuation">)</span><span class="token punctuation">(</span>A<span class="token punctuation">;</span>B<span class="token punctuation">;</span>C<span class="token punctuation">;</span>D<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<h2 id="장애-및-보완"><a href="#장애-및-보완" class="headerlink" title="장애 및 보완"></a>장애 및 보완</h2><p>이제까지 경험했던 장애 또는 현재 경험하고 있는 부분을 공유하고 어떻게 보완할 수 있을까를 정리합니다.</p>
<h3 id="순차-처리로-인한-병목-현상"><a href="#순차-처리로-인한-병목-현상" class="headerlink" title="순차 처리로 인한 병목 현상"></a>순차 처리로 인한 병목 현상</h3><p>KDB+ 프로세스는 기본적으로 싱글 스레드로 동작하므로 <code>모든 동기 요청을 순차적으로 처리한다는 제약</code>이 있습니다. 그래서 트랜잭션을 지원하지 않더라도 현재 사용자의 요청에 대한 작업 결과가 다음 요청에 반영됨을 보장합니다. 그러나, 현재 수행중인 요청에 대한 작업이 길어질수록 다른 요청이 대기해야하는 시간이 많아질 수 있습니다. KDB+ 프로세스의 구성이 복잡하고 각 요청에 대한 쿼리가 복잡해짐에 따라서 빠르게 요청되는 쿼리가 순차적으로 밀리는 현상으로 인하여 많은 어려움을 경험하고 있습니다. 사용자 요청에 대한 쿼리 최적화는 일시적인 대안일 뿐이며 결론적으로는 아키텍처적인 관점에서 다음의 정보를 고려해야합니다.</p>
<ul>
<li><a href="https://code.kx.com/q/kb/multithreaded-input/">Multithreaded input queue mode</a>  </li>
<li><a href="https://code.kx.com/q/kb/deferred-response/">Deferred response</a> </li>
<li><a href="https://code.kx.com/q/wp/gateway-design/">Common design principles for kdb+ gateways</a></li>
<li><a href="https://code.kx.com/q/wp/query-routing/">Query Routing: A kdb+ framework for a scalable, load balanced system</a></li>
</ul>
<blockquote>
<p>현재 조직에서는 위의 방안들은 검토하였으나 여러가지 제약이나 이해하기 힘든 부분으로 인하여 KDB+ 시스템을 구성하는 각 프로세스에 대한 의존성을 분산하는 작업을 먼저 시도해보기로 결정했습니다. 다수의 프로세스가 서로 유기적으로 통신하면서 발생하는 병목 현상을 최소화하도록 재구성하는게 목적입니다.</p>
</blockquote>
<h3 id="단일-디스크-I-x2F-O-작업으로-인한-병목-현상"><a href="#단일-디스크-I-x2F-O-작업으로-인한-병목-현상" class="headerlink" title="단일 디스크 I&#x2F;O 작업으로 인한 병목 현상"></a>단일 디스크 I&#x2F;O 작업으로 인한 병목 현상</h3><p>하나의 서버에 KDB+ 프로세스를 여러개 구성하더라도 특정 프로세스에서 디스크 I&#x2F;O 작업을 수행하는 경우 동일한 폴더나 파일에 대한 작업을 수행해야하는 경우 일시적으로 대기하는 병목 현상이 야기될 수 있습니다. 파티션에 저장된 데이터가 정렬되지 않았다거나 주요 컬럼에 속성이 부여되지 않은 부분을 위해 파티션을 보정하는 프로세스가 작업중일때 동일한 파티션 폴더를 로드해야하는 HDB 프로세스에서 사용자 요청에 대한 작업이 일시적으로 많이 소요되는 문제를 경험했습니다.</p>
<blockquote>
<p>티커플랜트 아키텍처에서는 현재 시간 또는 일자에 대한 시계열 데이터가 등록되어야하지만 과거에 대한 시계열 데이터가 실시간으로 등록됨에 따라 올바른 파티션으로 데이터를 병합하는 작업으로 인해 디스크 I&#x2F;O로 인한 병목 현상이 야기되고 있습니다. 데이터 연동을 시작한 특정 고객이 가지고 있던 과거 데이터를 한번에 등록하게 됨으로써 이로 인해 프로세스에 대한 요청이 느려짐이 보고되고 있습니다.</p>
</blockquote>
<h3 id="프로세스-의존성으로-인한-멈춤-현상"><a href="#프로세스-의존성으로-인한-멈춤-현상" class="headerlink" title="프로세스 의존성으로 인한 멈춤 현상"></a>프로세스 의존성으로 인한 멈춤 현상</h3><p><img data-src="https://code.kx.com/q/img/architecture.png"></p>
<p>KDB+ 시스템 아키텍처는 다수의 프로세스가 유기적으로 통신하며 시스템을 구성한다고 하였습니다. 간단하게 실행되었던 시스템이 여러가지 이유에 의해서 별도의 프로세스가 추가됨에 따라서 시간 또는 일자별 파티션을 사용하는 HDB 프로세스들이 하나의 RDB 프로세스와 동일한 별도의 프로세스를 의존함에 따라서 서로 요청이 병목되어 프로세스가 요청을 처리중인데도 불구하고 프로세스가 멈추는 것 같아 보이는 현상을 확인했습니다. 각 HDB 프로세스들이 실시간 데이터 조회를 위해서 실시간 데이터를 유지만하는 별도의 읽기 전용 RDB 프로세스를 의존하도록 재구성하였고 이러한 현상이 점차적으로 줄어들고 있습니다.</p>
<h3 id="EOH-다운타임"><a href="#EOH-다운타임" class="headerlink" title="EOH 다운타임"></a>EOH 다운타임</h3><p>티커플랜트는 시간 또는 일과가 종료되면 EOH 또는 EOD 이벤트를 데이터 피드 구독자에게 전달합니다. 그리고 특정 RDB 프로세스는 시간 또는 일과 데이터를 현재 파티션에 기록합니다. 프로세스에서 데이터를 파일로 기록하기전에 정렬을 시도하므로 데이터 규모와 서버 성능에 따라서 <a href="https://code.kx.com/q/wp/intraday-writedown/#downtime">Downtime</a>이 발생할 수 있습니다. 이러한 다운타임을 최소화하기 위해서 RDB 프로세스에서 데이터를 저장할때는 데이터 정렬이나 스플레이 테이블에 대한 속성 부여를 최소화하고 파티션 보정을 수행하는 별도의 프로세스를 두어서 파티션 데이터를 정렬하고 쿼리 최적화를 위한 컬럼에 속성을 부여하는 작업을 수행하도록 추가 구성했습니다.</p>
<blockquote>
<p>실시간 데이터에 과거의 시계열 데이터가 많이 존재할 수 있는 케이스가 발생하면서 파티션을 다시 보정하는 작업을 수행하는 프로세스에 대한 작업도 과중화되는 것을 확인하고 있습니다.</p>
</blockquote>
<hr>
<p>아무리 빠른 성능을 자랑하는 기술이어도 어떤 환경에서 사용되는지와 어떻게 구성하여 사용하는지에 따라서 많은 문제나 제약이 발생할 수 있습니다. 간단했던 시스템이 복잡해지면서 장애가 발생하면 그것을 보완하기 위하여 여러가지 시도를 해보아야합니다. 이전의 경험을 토대로 그럴리 없다, 그럴 가능성은 없다라는 관점은 우리를 힘들게할 수 있습니다. 기술을 사용하는 방식이 동일하지 않음을 인정하고 그것으로부터 야기되는 문제점은 없는지 지속적으로 검토해야합니다. 그것을 우리는 장애 대응 또는 후속 조치라고 말합니다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://kx.com/blog/what-makes-time-series-database-kdb-so-fast/">What Makes Time-Series Database kdb+ So Fast?</a></li>
<li><a href="https://code.kx.com/q/kb/kdb-tick/">Kdb+tick configuration</a>  </li>
<li><a href="https://code.kx.com/q/wp/rt-tick/">Building real-time tick subscribers</a></li>
<li><a href="https://github.com/kdevkr/kdb">Learning KDB+</a></li>
</ul>
]]></content>
      <tags>
        <tag>KDB+/q</tag>
        <tag>TP</tag>
      </tags>
  </entry>
  <entry>
    <title>MQTT Connection Lost</title>
    <url>/mqtt-connection-lost/</url>
    <content><![CDATA[<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Connection</span> lost <span class="token punctuation">(</span><span class="token number">32109</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>EOFException</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>eclipse<span class="token punctuation">.</span>paho<span class="token punctuation">.</span>client<span class="token punctuation">.</span>mqttv3<span class="token punctuation">.</span>internal<span class="token punctuation">.</span></span>CommsReceiver</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">CommsReceiver</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">197</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">750</span><span class="token punctuation">)</span>
<span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>EOFException</span>
	at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>DataInputStream</span><span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token class-name">DataInputStream</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">267</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>eclipse<span class="token punctuation">.</span>paho<span class="token punctuation">.</span>client<span class="token punctuation">.</span>mqttv3<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>wire<span class="token punctuation">.</span></span>MqttInputStream</span><span class="token punctuation">.</span><span class="token function">readMqttWireMessage</span><span class="token punctuation">(</span><span class="token class-name">MqttInputStream</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">92</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>eclipse<span class="token punctuation">.</span>paho<span class="token punctuation">.</span>client<span class="token punctuation">.</span>mqttv3<span class="token punctuation">.</span>internal<span class="token punctuation">.</span></span>CommsReceiver</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">CommsReceiver</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">137</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">1</span> more</code></pre>

<p>위 스택트레이스는 Paho Java Client를 사용하여 Mosquitto 브로커에 연결하고 난 후 어떠한 사유에 의해 연결이 해지되었을 때 발생하는 오류입니다. 조직 내 동료 개발자가 Mosquitto에 연결하고 나서 5분이 지나는 시점에 연결이 해지되는 증상이 있다며 이 문제를 경험했는지 도움을 요청하였으나 이전에 <a href="/spring-boot-integration-mqtt/">스프링 부트 MQTT 클라이언트 메시지 채널 구성하기</a> 또는 <a href="/connecting-with-mqtt-using-aws-iot-device-sdk/">AWS IoT Device SDK Java로 MQTT 연결하기</a>에서처럼 Paho Java Client 라이브러리를 사용하면서 연결이 해지되는 것을 경험해보지는 못했었습니다.</p>
<h2 id="MQTT-over-Websocket"><a href="#MQTT-over-Websocket" class="headerlink" title="MQTT over Websocket"></a>MQTT over Websocket</h2><p>조직 내 동료 개발자의 도움 요청으로 인해 리눅스 서버에 설치된 Mosquitto 버전은 2.0.14 이며 Paho Java Client 라이브러리는 1.2.5를 사용하고 있는 것으로 알게 되었습니다. 그리고 Mosquitto 연결 시에는 Websocket 프로토콜을 사용하고 있었습니다. </p>
<table>
<thead>
<tr>
<th>JDK</th>
<th>Paho Java Client</th>
<th>Mosquitto</th>
<th>EOF</th>
</tr>
</thead>
<tbody><tr>
<td>Java 1.8.0_144</td>
<td>1.2.5</td>
<td>2.0.14</td>
<td>💥</td>
</tr>
<tr>
<td>Temurin 1.8.0_345</td>
<td>1.1.0 ~ 1.2.5</td>
<td>2.0.14</td>
<td>💥</td>
</tr>
<tr>
<td>Temurin 11.0.16</td>
<td>1.1.0 ~ 1.2.5</td>
<td>2.0.14</td>
<td>💥</td>
</tr>
</tbody></table>
<p>JDK와 라이브러리 버전을 변경해가면서 테스트 해본 결과 일반적인 TCP 방식으로 연결 시에는 Mosquitto 버전과 상관없이 정상적으로 연결을 유지함을 보였으나 웹소켓 연결에 대해서는 리눅스 서버에 설치된 Mosquitto 2.0.14 브로커에 대해 일정 시간이 지나 연결이 해지됨을 확인할 수 있었습니다.</p>
<h3 id="Mosquitto-Version"><a href="#Mosquitto-Version" class="headerlink" title="Mosquitto Version"></a>Mosquitto Version</h3><p>위 문제가 발생했던 리눅스 서버에 Mosquitto 브로커는 도커 이미지로 구동된 상태라고 하였습니다. 그래서 로컬 컴퓨터 환경에서도 도커 컨테이너를 실행하여 간단하게 여러개의 버전을 테스트할 수 있으므로 도커 이미지를 변경하면서 웹 소켓 연결이 일정 시간 이후에 해지되는 증상이 나타나는지 체크해보았습니다. 테스트 버전은 <a href="https://mosquitto.org/blog/categories/releases/">Mosquitto Posts about Releases</a>에 따라 시도해보았으며 2.0.9와 2.0.11가 릴리즈될 때 1.6.x 마이너 버전도 패치되었기에 포함했습니다.</p>
<table>
<thead>
<tr>
<th>JDK</th>
<th>Paho Java Client</th>
<th>Mosquitto</th>
<th>EOF</th>
</tr>
</thead>
<tbody><tr>
<td>Temurin 11.0.16</td>
<td>1.2.5</td>
<td>2.0.15</td>
<td>💥</td>
</tr>
<tr>
<td>Temurin 11.0.16</td>
<td>1.2.5</td>
<td>2.0.14</td>
<td>💥</td>
</tr>
<tr>
<td>Temurin 11.0.16</td>
<td>1.2.5</td>
<td>2.0.13</td>
<td>💥</td>
</tr>
<tr>
<td>Temurin 11.0.16</td>
<td>1.2.5</td>
<td>2.0.12</td>
<td>💥</td>
</tr>
<tr>
<td>Temurin 11.0.16</td>
<td>1.2.5</td>
<td>2.0.11</td>
<td>💥</td>
</tr>
<tr>
<td>Temurin 11.0.16</td>
<td>1.2.5</td>
<td>2.0.10</td>
<td>OK</td>
</tr>
<tr>
<td>Temurin 11.0.16</td>
<td>1.2.5</td>
<td>2.0.9</td>
<td>OK</td>
</tr>
<tr>
<td>Temurin 11.0.16</td>
<td>1.2.5</td>
<td>1.6.15</td>
<td>💥</td>
</tr>
<tr>
<td>Temurin 11.0.16</td>
<td>1.2.5</td>
<td>1.6.14</td>
<td>OK</td>
</tr>
<tr>
<td>Temurin 11.0.16</td>
<td>1.2.5</td>
<td>1.6.9</td>
<td>OK</td>
</tr>
</tbody></table>
<blockquote>
<p>우분투 LTS 버전에 따른 Mosquitto 패키지 지원 버전은 다음의 링크에서 확인할 수 있습니다.<br><a href="https://packages.ubuntu.com/search?keywords=mosquitto">https://packages.ubuntu.com/search?keywords=mosquitto</a></p>
</blockquote>
<p>Mosquitto 버전별 테스트 결과 2021-06-08 자로 릴리즈된 2.0.11과 1.6.15 에서부터 웹소켓 연결이 해지되는 증상을 보였습니다. 동료 개발자에게는 Paho Java Client의 AutomaticReconnect 옵션과 MqttCallbackExtended 인터페이스로 연결 해지로 인해 재연결을 시도하고 나서 토픽을 다시 구독하는 방향으로 임시 조치해야할 것 같다고 전달한 상태이며 Mosquitto 브로커 버전을 다운그레이드 해야하는지에 대해서는 조직 내에서 검토하고 결정해야할 것 같습니다.</p>
<h2 id="테스트-환경"><a href="#테스트-환경" class="headerlink" title="테스트 환경"></a>테스트 환경</h2><p>처음에는 우분투 VM 이미지로 테스트하였으나 다양한 버전을 테스트해보기 위해서 도커 컨테이너 환경을 구성했습니다. </p>
<h3 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.8"</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">mosquitto</span><span class="token punctuation">:</span>
    <span class="token comment"># image: eclipse-mosquitto:1.6.15 # EOF</span>
    <span class="token comment"># image: eclipse-mosquitto:1.6.14 # OK</span>
    <span class="token comment"># image: eclipse-mosquitto:2.0.9 # OK</span>
    <span class="token comment"># image: eclipse-mosquitto:2.0.10 # OK</span>
    <span class="token comment"># image: eclipse-mosquitto:2.0.11 # EOF</span>
    <span class="token comment"># image: eclipse-mosquitto:2.0.12 # EOF</span>
    <span class="token comment"># image: eclipse-mosquitto:2.0.13 # EOF</span>
    <span class="token comment"># image: eclipse-mosquitto:2.0.14 # EOF</span>
    <span class="token comment"># image: eclipse-mosquitto:2.0.15 # EOF</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> eclipse<span class="token punctuation">-</span>mosquitto<span class="token punctuation">:</span>2.0.10
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> mosquitto
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"1883:1883"</span>
      <span class="token punctuation">-</span> <span class="token string">"9001:9001"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./mosquitto.conf<span class="token punctuation">:</span>/mosquitto/config/mosquitto.conf
      <span class="token punctuation">-</span> ./mosquitto.log<span class="token punctuation">:</span>/mosquitto/log/mosquitto.log
      <span class="token punctuation">-</span> mosquitto<span class="token punctuation">-</span>data<span class="token punctuation">:</span>/mosquitto/data
      <span class="token punctuation">-</span> ./passwd<span class="token punctuation">:</span>/mosquitto/config/passwd

<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  mosquitto<span class="token punctuation">-</span>data<span class="token punctuation">:</span></code></pre>

<h3 id="mosquitto-conf"><a href="#mosquitto-conf" class="headerlink" title="mosquitto.conf"></a>mosquitto.conf</h3><pre class="language-conf" data-language="conf"><code class="language-conf">persistence true
persistence_location &#x2F;mosquitto&#x2F;data&#x2F;
log_dest file &#x2F;mosquitto&#x2F;log&#x2F;mosquitto.log

port 1883

listener 9001
protocol websockets
allow_anonymous false
password_file &#x2F;mosquitto&#x2F;config&#x2F;passwd
set_tcp_nodelay true
socket_domain ipv4

log_type all
websockets_log_level 8</code></pre>

<details>
  <summary>테스트 로그</summary>
  
<h4 id="mosquitto-log"><a href="#mosquitto-log" class="headerlink" title="mosquitto.log"></a>mosquitto.log</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">1662725110</span>: New client connected from <span class="token number">192.168</span>.0.2:3326 as paho1668189895026200 <span class="token punctuation">(</span>p2, c1, k60, u<span class="token string">'mambo'</span><span class="token punctuation">)</span>.
<span class="token number">1662725110</span>: No will message specified.
<span class="token number">1662725110</span>: Sending CONNACK to paho1668189895026200 <span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">1662725110</span>: Received SUBSCRIBE from paho1668189895026200
<span class="token number">1662725110</span>:     <span class="token variable">$SYS</span>/broker/version <span class="token punctuation">(</span>QoS <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">1662725110</span>: paho1668189895026200 <span class="token number">0</span> <span class="token variable">$SYS</span>/broker/version
<span class="token number">1662725110</span>: Sending SUBACK to paho1668189895026200
<span class="token number">1662725110</span>: Sending PUBLISH to paho1668189895026200 <span class="token punctuation">(</span>d0, q0, r1, m0, <span class="token string">'$SYS/broker/version'</span>, <span class="token punctuation">..</span>. <span class="token punctuation">(</span><span class="token number">24</span> bytes<span class="token punctuation">))</span>
<span class="token number">1662725110</span>: Received SUBSCRIBE from paho1668189895026200
<span class="token number">1662725110</span>:     test/<span class="token comment"># (QoS 0)</span>
<span class="token number">1662725110</span>: paho1668189895026200 <span class="token number">0</span> test/<span class="token comment">#</span>
<span class="token number">1662725110</span>: Sending SUBACK to paho1668189895026200
<span class="token number">1662725170</span>: Received PINGREQ from paho1668189895026200
<span class="token number">1662725170</span>: Sending PINGRESP to paho1668189895026200
<span class="token number">1662725230</span>: Received PINGREQ from paho1668189895026200
<span class="token number">1662725230</span>: Sending PINGRESP to paho1668189895026200
<span class="token number">1662725290</span>: Received PINGREQ from paho1668189895026200
<span class="token number">1662725290</span>: Sending PINGRESP to paho1668189895026200
<span class="token number">1662725350</span>: Received PINGREQ from paho1668189895026200
<span class="token number">1662725350</span>: Sending PINGRESP to paho1668189895026200
<span class="token number">1662725410</span>: Client paho1668189895026200 closed its connection.</code></pre>

<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">1662727428</span>: lws_validity_cb: <span class="token punctuation">[</span>wsisrv<span class="token operator">|</span><span class="token number">0</span><span class="token operator">|</span>adopted<span class="token punctuation">]</span>: scheduling validity check
<span class="token number">1662727428</span>: rops_handle_POLLOUT_ws: issuing <span class="token function">ping</span> on wsi <span class="token punctuation">[</span>wsisrv<span class="token operator">|</span><span class="token number">0</span><span class="token operator">|</span>adopted<span class="token punctuation">]</span>: ws mqtt h2: <span class="token number">0</span>
<span class="token number">1662727428</span>: lws_issue_raw: ssl_capable_write <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> says <span class="token number">2</span>
<span class="token number">1662727428</span>: lws_issue_raw: ssl_capable_write <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> says <span class="token number">6</span>
<span class="token number">1662727428</span>: __lws_close_free_wsi: <span class="token punctuation">[</span>wsisrv<span class="token operator">|</span><span class="token number">0</span><span class="token operator">|</span>adopted<span class="token punctuation">]</span>: caller: close_and_handled
<span class="token number">1662727428</span>: __lws_close_free_wsi: <span class="token punctuation">[</span>wsisrv<span class="token operator">|</span><span class="token number">0</span><span class="token operator">|</span>adopted<span class="token punctuation">]</span>: end LRS_FLUSHING_BEFORE_CLOSE
<span class="token number">1662727428</span>: __lws_close_free_wsi: <span class="token function">shutdown</span> conn: <span class="token punctuation">[</span>wsisrv<span class="token operator">|</span><span class="token number">0</span><span class="token operator">|</span>adopted<span class="token punctuation">]</span> <span class="token punctuation">(</span>sk <span class="token number">12</span>, state 0x11e<span class="token punctuation">)</span>
<span class="token number">1662727428</span>: __lws_close_free_wsi: real just_kill_connection: <span class="token punctuation">[</span>wsisrv<span class="token operator">|</span><span class="token number">0</span><span class="token operator">|</span>adopted<span class="token punctuation">]</span> <span class="token punctuation">(</span>sockfd <span class="token number">12</span><span class="token punctuation">)</span>
<span class="token number">1662727428</span>: __lws_close_free_wsi: <span class="token punctuation">[</span>wsisrv<span class="token operator">|</span><span class="token number">0</span><span class="token operator">|</span>adopted<span class="token punctuation">]</span>: <span class="token assign-left variable">cce</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token number">1662727428</span>: Client paho1670208425870800 closed its connection.</code></pre>

<h4 id="Paho-Java-Client-log"><a href="#Paho-Java-Client-log" class="headerlink" title="Paho Java Client log"></a>Paho Java Client log</h4><pre class="language-bash" data-language="bash"><code class="language-bash">FINE: null: network <span class="token builtin class-name">read</span> message
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:09 AM org.eclipse.paho.client.mqttv3.internal.websocket.WebSocketReceiver run
FINE: null: network <span class="token builtin class-name">read</span> message
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.websocket.WebSocketReceiver run
FINE: null: network <span class="token builtin class-name">read</span> message
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.websocket.WebSocketReceiver run
FINE: null: network <span class="token builtin class-name">read</span> message
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.websocket.WebSocketReceiver stop
FINE: null: stopping
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.websocket.WebSocketReceiver stop
FINE: null: stopping
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.websocket.WebSocketReceiver stop
FINE: null: stopped
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.websocket.WebSocketReceiver stop
FINE: null: stopped
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsReceiver run
FINE: paho1622771147525800: Stopping due to IOException
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsReceiver run
FINE: paho1622771147525800: Stopping due to IOException
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientComms shutdownConnection
FINE: paho1622771147525800: <span class="token assign-left variable">state</span><span class="token operator">=</span>DISCONNECTING
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientComms shutdownConnection
FINE: paho1622771147525800: <span class="token assign-left variable">state</span><span class="token operator">=</span>DISCONNECTING
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsCallback stop
FINE: paho1622771147525800: stopping
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsCallback stop
FINE: paho1622771147525800: stopping
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsCallback stop
FINE: paho1622771147525800: notify workAvailable and <span class="token function">wait</span> <span class="token keyword">for</span> run
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsCallback stop
FINE: paho1622771147525800: notify workAvailable and <span class="token function">wait</span> <span class="token keyword">for</span> run
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsCallback stop
FINE: paho1622771147525800: stopped
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsCallback stop
FINE: paho1622771147525800: stopped
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsCallback run
FINE: paho1622771147525800: notify spaceAvailable
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsCallback run
FINE: paho1622771147525800: notify spaceAvailable
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsReceiver stop
FINE: paho1622771147525800: stopping
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsReceiver stop
FINE: paho1622771147525800: stopping
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsReceiver stop
FINE: paho1622771147525800: stopped
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsReceiver stop
FINE: paho1622771147525800: stopped
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.websocket.WebSocketReceiver stop
FINE: null: stopping
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.websocket.WebSocketReceiver stop
FINE: null: stopping
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.websocket.WebSocketReceiver stop
FINE: null: stopped
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.websocket.WebSocketReceiver stop
FINE: null: stopped
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsTokenStore quiesce
FINE: paho1622771147525800: <span class="token assign-left variable">resp</span><span class="token operator">=</span>Client is currently disconnecting <span class="token punctuation">(</span><span class="token number">32102</span><span class="token punctuation">)</span>
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsTokenStore quiesce
FINE: paho1622771147525800: <span class="token assign-left variable">resp</span><span class="token operator">=</span>Client is currently disconnecting <span class="token punctuation">(</span><span class="token number">32102</span><span class="token punctuation">)</span>
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientComms handleOldTokens
FINE: paho1622771147525800: <span class="token operator">></span>
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientComms handleOldTokens
FINE: paho1622771147525800: <span class="token operator">></span>
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientState resolveOldTokens
FINE: paho1622771147525800: reason Connection lost <span class="token punctuation">(</span><span class="token number">32109</span><span class="token punctuation">)</span> - java.io.EOFException
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientState resolveOldTokens
FINE: paho1622771147525800: reason Connection lost <span class="token punctuation">(</span><span class="token number">32109</span><span class="token punctuation">)</span> - java.io.EOFException
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsTokenStore getOutstandingTokens
FINE: paho1622771147525800: <span class="token operator">></span>
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsTokenStore getOutstandingTokens
FINE: paho1622771147525800: <span class="token operator">></span>
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientState disconnected
FINE: paho1622771147525800: disconnected
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientState disconnected
FINE: paho1622771147525800: disconnected
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientState clearState
FINE: paho1622771147525800: <span class="token operator">></span>
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientState clearState
FINE: paho1622771147525800: <span class="token operator">></span>
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsTokenStore <span class="token function">clear</span>
FINE: paho1622771147525800: <span class="token operator">></span> <span class="token number">0</span> tokens
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsTokenStore <span class="token function">clear</span>
FINE: paho1622771147525800: <span class="token operator">></span> <span class="token number">0</span> tokens
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsSender stop
FINE: paho1622771147525800: stopping sender
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsSender stop
FINE: paho1622771147525800: stopping sender
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientState notifyQueueLock
FINE: paho1622771147525800: notifying queueLock holders
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientState notifyQueueLock
FINE: paho1622771147525800: notifying queueLock holders
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsSender stop
FINE: paho1622771147525800: stopped
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsSender stop
FINE: paho1622771147525800: stopped
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientState get
FINE: paho1622771147525800: new work or <span class="token function">ping</span> arrived 
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.TimerPingSender stop
FINE: paho1622771147525800: stop
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientState get
FINE: paho1622771147525800: new work or <span class="token function">ping</span> arrived 
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientState get
FINE: paho1622771147525800: no outstanding flows and not connected
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientState get
FINE: paho1622771147525800: no outstanding flows and not connected
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.TimerPingSender stop
FINE: paho1622771147525800: stop
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsSender run
FINE: paho1622771147525800: get message returned null, stopping<span class="token punctuation">&#125;</span>
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsSender run
FINE: paho1622771147525800: get message returned null, stopping<span class="token punctuation">&#125;</span>
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsSender run
FINE: paho1622771147525800: <span class="token operator">&lt;</span>
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsSender run
FINE: paho1622771147525800: <span class="token operator">&lt;</span>
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientComms shutdownConnection
FINE: paho1622771147525800: <span class="token assign-left variable">state</span><span class="token operator">=</span>DISCONNECTED
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.ClientComms shutdownConnection
FINE: paho1622771147525800: <span class="token assign-left variable">state</span><span class="token operator">=</span>DISCONNECTED
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsCallback connectionLost
FINE: paho1622771147525800: call connectionLost
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsCallback connectionLost
FINE: paho1622771147525800: call connectionLost
Connection lost <span class="token punctuation">(</span><span class="token number">32109</span><span class="token punctuation">)</span> - java.io.EOFException
	at org.eclipse.paho.client.mqttv3.internal.CommsReceiver.run<span class="token punctuation">(</span>CommsReceiver.java:197<span class="token punctuation">)</span>
	at java.base/java.lang.Thread.run<span class="token punctuation">(</span>Thread.java:829<span class="token punctuation">)</span>
Caused by: java.io.EOFException
	at java.base/java.io.DataInputStream.readByte<span class="token punctuation">(</span>DataInputStream.java:272<span class="token punctuation">)</span>
	at org.eclipse.paho.client.mqttv3.internal.wire.MqttInputStream.readMqttWireMessage<span class="token punctuation">(</span>MqttInputStream.java:92<span class="token punctuation">)</span>
	at org.eclipse.paho.client.mqttv3.internal.CommsReceiver.run<span class="token punctuation">(</span>CommsReceiver.java:137<span class="token punctuation">)</span>
	<span class="token punctuation">..</span>. <span class="token number">1</span> <span class="token function">more</span>
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsReceiver run
FINE: paho1622771147525800: <span class="token operator">&lt;</span>
Sep 09, <span class="token number">2022</span> <span class="token number">8</span>:33:10 AM org.eclipse.paho.client.mqttv3.internal.CommsReceiver run
FINE: paho1622771147525800: <span class="token operator">&lt;</span></code></pre>
</details>

<h2 id="이슈-링크"><a href="#이슈-링크" class="headerlink" title="이슈 링크"></a>이슈 링크</h2><ul>
<li><a href="https://github.com/eclipse/mosquitto/issues/2631">Websocket connection lost with paho java client #2631</a></li>
<li><a href="https://github.com/eclipse/paho.mqtt.java/issues/960">Websocket connection lost with mosquitto 1.6.15 and 2.0.11+ #960</a></li>
</ul>
]]></content>
      <tags>
        <tag>Mosquitto</tag>
        <tag>Paho Java Client</tag>
      </tags>
  </entry>
  <entry>
    <title>PKI(Public Key Infrastructure)</title>
    <url>/pki/</url>
    <content><![CDATA[<blockquote>
<p>정보보안 전문가의 수준은 아닐지라도 웹 애플리케이션에서 사용되는 보안 기술에 대해서 어느정도 이해하고 있어야합니다. 이 글은 <a href="/ssl-certificate/">SSL 인증서</a>와 <a href="/mutual-tls/">Mutual TLS</a>에서 언급하거나 다루어본 X.509 인증서와 함께 공개키 기반 인증 구조라고 하는 PKI와 관련된 용어와 개념에 대해서 간단하게 알아봅니다.</p>
</blockquote>
<h2 id="X-509-Certificate"><a href="#X-509-Certificate" class="headerlink" title="X.509 Certificate"></a>X.509 Certificate</h2><p><em>A public key infrastructure (PKI) is a set of roles, policies, hardware, software and procedures needed to create, manage, distribute, use, store and revoke digital certificates and manage public-key encryption.</em></p>
<p>X.509는 <a href="https://datatracker.ietf.org/doc/html/rfc5280">RFC5280</a>로 정의되어있는 디지털 인증서(공개키 인증서)의 표준 형식입니다. 대부분의 웹 애플리케이션에 적용하는 HTTPS 프로토콜에서 TLS 핸드쉐이크를 위해서 사용되는 가장 일반적인 인증서 형식이기도 하듯이 전세계적으로 디지털 인증서라 함은 ITU-T X.509 표준 방식으로 작성된 X.509 인증서라고 할 수 있습니다. 국내에서 사용되던 <a href="https://ko.wikipedia.org/wiki/%EA%B3%B5%EB%8F%99%EC%9D%B8%EC%A6%9D%EC%84%9C">공동인증서(공인인증서)</a>도 공개키 기반 인증 기술을 활용해서 만든 디지털 인증서이지만 한국에서만 사용할 수 있는 인증서 형식이라는 점입니다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ubuntu@ubuntu:~/x509$ openssl x509 -in local.dev+1.pem -text -noout
Certificate:
    Data:
        Version: <span class="token number">3</span> <span class="token punctuation">(</span>0x2<span class="token punctuation">)</span>
        Serial Number:
            e5:29:9a:ba:66:<span class="token punctuation">..</span>.
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: O <span class="token operator">=</span> mkcert development CA, OU <span class="token operator">=</span> ubuntu@ubuntu, CN <span class="token operator">=</span> mkcert ubuntu@ubuntu
        Validity
            Not Before: Jul <span class="token number">12</span> <span class="token number">21</span>:55:43 <span class="token number">2022</span> GMT
            Not After <span class="token builtin class-name">:</span> Oct <span class="token number">12</span> <span class="token number">21</span>:55:43 <span class="token number">2024</span> GMT
        Subject: O <span class="token operator">=</span> mkcert development certificate, OU <span class="token operator">=</span> ubuntu@ubuntu
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                RSA Public-Key: <span class="token punctuation">(</span><span class="token number">2048</span> bit<span class="token punctuation">)</span>
                Modulus:
                    00:d8:c2:77:4f:4f:9d:1c:c2:70:b2:00:52:4f:e7:
                    <span class="token punctuation">..</span>.
                Exponent: <span class="token number">65537</span> <span class="token punctuation">(</span>0x10001<span class="token punctuation">)</span>
        X509v3 extensions:
            X509v3 Key Usage: critical
                Digital Signature, Key Encipherment
            X509v3 Extended Key Usage:
                TLS Web Server Authentication
            X509v3 Authority Key Identifier:
                keyid:3B:31:5D:2F:7C:D6:E6:E2:F5:9B:66:1D:E5:75:5C:11:C6:85:8C:6D

            X509v3 Subject Alternative Name:
                DNS:local.dev, DNS:localhost
    Signature Algorithm: sha256WithRSAEncryption
         <span class="token number">43</span>:e1:81:18:d5:04:ca:d4:73:68:85:4d:1d:d4:79:cb:02:0d:
         <span class="token punctuation">..</span>.</code></pre>

<p>위 예시는 로컬 호스트에서 사용할 수 있는 사설 인증서를 만드는 오픈소스 도구인 <a href="https://github.com/FiloSottile/mkcert">mkcert</a>를 통해 만들어진 X.509 인증서에 대한 정보를 openssl 도구로 인증서에 포함된 정보를 확인해본 것입니다. 인증서에 포함될 수 있는 필드들은 RFC5280 문서에 설명되어있는데 발급자(Issuer), 서명 알고리즘(Signature Algorithm), 소유자(Subject), 소유자의 공개키(Subject Public Key Info) 그리고 신원을 확인할 수 있는 부가 정보(Extensions)입니다. </p>
<p>HTTPS 프로토콜 통신에서 TLS 핸드쉐이킹 과정 중 클라이언트는 서버에서 제공한 X.509 인증서 정보를 확인하여 부가 정보 중 SAN(X509v3 Subject Alternative Name)에 입력된 정보를 토대로 브라우저에서 도메인이나 IP 주소에 대한 신원을 추가적으로 검증합니다. 예를 들어, 위 예시에서는 localhost와 local.dev라는 호스트를 신뢰할 수 있다고 판단할 수 있습니다.</p>
<blockquote>
<p>X.509 인증서는 상위 기관에서 소유자의 공개키를 전자서명한 것으로 암호화가 목적이 아닌 공개키에 대한 소유자의 신원을 검증하고자 함에 있습니다.</p>
</blockquote>
<h3 id="PEM-Format"><a href="#PEM-Format" class="headerlink" title="PEM Format"></a>PEM Format</h3><pre class="language-bash" data-language="bash"><code class="language-bash">ubuntu@ubuntu:~/x509$ openssl x509 -in local.dev+1.pem
-----BEGIN CERTIFICATE-----
MIIEDDCCAnSgAwIBAgIRAOUpmrpmzWKOajX3U1ze1McwDQYJKoZIhvcNAQELBQAw
VzEeMBwGA1UEChMVbWtjZXJ0IGRldmVsb3BtZW50IENBMRYwFAYDVQQLDA11YnVu
dHVAdWJ1bnR1MR0wGwYDVQQDDBRta2NlcnQgdWJ1bnR1QHVidW50dTAeFw0yMjA3
MTIyMTU1NDNaFw0yNDEwMTIyMTU1NDNaMEExJzAlBgNVBAoTHm1rY2VydCBkZXZl
bG9wbWVudCBjZXJ0aWZpY2F0ZTEWMBQGA1UECwwNdWJ1bnR1QHVidW50dTCCASIw
DQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBANjCd09PnRzCcLIAUk/nr27i2uvz
tXSF1vbwUby3dPWQcZuR3cLRvIeNv6oOMLnf9uGbI/pjlRcCoZwk+ETUZtVrsFsv
NZGCir34QbXkNb96/M8HSM3ZC9soeijU8NqoWDjr4LGtU+FX8pOOHbsjJoiyIH7l
g76EpOUrasnVmx6T8xoUlye2si0A+VbV/J6tlJXKix0qidliIiBIY2HWktN+HBIY
bttuRwXOK22i7KPwT/jURgZlcAq5Lmfu9+pTs5ak2jXSaneWLkKF0/9RxMy2jGKf
dTwYqU4ZjbZz1zXs+UeI7hgsPqprhnVBkDAejNrXNJ1O390IbwtgboJ/V6cCAwEA
AaNpMGcwDgYDVR0PAQH/BAQDAgWgMBMGA1UdJQQMMAoGCCsGAQUFBwMBMB8GA1Ud
IwQYMBaAFDsxXS981ubi9ZtmHeV1XBHGhYxtMB8GA1UdEQQYMBaCCWxvY2FsLmRl
doIJbG9jYWxob3N0MA0GCSqGSIb3DQEBCwUAA4IBgQBD4YEY1QTK1HNohU0d1HnL
Ag3Pm9bUJxGWw2bOAO+0Dgdau3Fn+72JPz7ZYGX3Deny01TYDEoeno7VOY+gq2u0
F4L1SBNWdXhdxxfj/4JK3r1FpmgmEpPOVyrO2KMWgPlNu4JV8jUc/OIOeKYe8S9V
ddM7VyRjZSCNKsI4kneeu/fZFXLMtWS8lcj/hubQdGYXuSaSZHihpTPvCR2XP6z+
NbeDndqo4YemGIUS2eyp4MQCwlR910FUv3NNgk43iJw368ma8p/jigQeUx9reyYK
ijxd/rbwmg9k5Mks+CgK7pi0Bd8uJxD5i9KgitDBetjoPbw8xIazDUbhtPofs3y8
HTGqR4kszm4JZMh0310Ff3hkqjXwT1oVEMrBUUUZrSBjuUEy7bujgu1JBV1f/j5l
LzS5dMOM68x7my7YVSUG+hbjeB9w9eZWLx/YZ707ssvAfKVvWoyKrwwlZTQRs7mI
HRcM9stz0/k/ZQZH0IBerjuPJ93BKH0wRYxU33i3htQ<span class="token operator">=</span>
-----END CERTIFICATE-----</code></pre>

<p>위 결과는 X.509 인증서가 실제로 파일에 저장된 형태를 보여주고 있습니다. 이와 같이 구성되는 방식을 PEM(Privacy Enhanced Mail)이라고 하는데 X.509 인증서를 저장하는 가장 일반적인 형식입니다. 바이너리 데이터로 저장되는 DER(Distinguished Encoding Representation)로도 저장할 수 있으나 시스템 간 안전하게 전달될 수 있도록 <a href="/base64/">Base64</a>로 인코딩되어 아스키 코드형태로 되어있는 PEM 형식이 선호되는 것 같습니다.</p>
<h3 id="Certificate-Profiles"><a href="#Certificate-Profiles" class="headerlink" title="Certificate Profiles"></a>Certificate Profiles</h3><pre class="language-bash" data-language="bash"><code class="language-bash">ubuntu@ubuntu:~/x509$ openssl s_client -showcerts -connect naver.com:443 <span class="token operator">&lt;</span>/dev/null
ubuntu@ubuntu:~/x509$ openssl x509 -in naver.com.pem -text -noout
Certificate:
    Data:
        Version: <span class="token number">3</span> <span class="token punctuation">(</span>0x2<span class="token punctuation">)</span>
        Serial Number:
            07:f2:85:21:53:b1:50:67:e3:c6:77:aa:3a:83:be:dd
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: C <span class="token operator">=</span> US, O <span class="token operator">=</span> DigiCert Inc, CN <span class="token operator">=</span> DigiCert TLS RSA SHA256 <span class="token number">2020</span> CA1
        Validity
            Not Before: May <span class="token number">23</span> 00:00:00 <span class="token number">2022</span> GMT
            Not After <span class="token builtin class-name">:</span> Jun  <span class="token number">7</span> <span class="token number">23</span>:59:59 <span class="token number">2023</span> GMT
        Subject: C <span class="token operator">=</span> KR, ST <span class="token operator">=</span> Gyeonggi-do, L <span class="token operator">=</span> Seongnam-si, O <span class="token operator">=</span> NAVER Corp., CN <span class="token operator">=</span> www.naver.net
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                RSA Public-Key: <span class="token punctuation">(</span><span class="token number">2048</span> bit<span class="token punctuation">)</span>
                Modulus:
                    00<span class="token punctuation">..</span>.
                Exponent: <span class="token number">65537</span> <span class="token punctuation">(</span>0x10001<span class="token punctuation">)</span>
        X509v3 extensions:
            X509v3 Authority Key Identifier:
                keyid:B7:6B:A2:EA:A8:AA:84:8C:79:EA:B4:DA:0F:98:B2:C5:95:76:B9:F4

            X509v3 Subject Key Identifier:
                F5:3C:13:14:C9:7B:15:36:50:8C:3E:89:40:EE:2C:E0:22:2F:9E:61
            X509v3 Subject Alternative Name:
                DNS:www.naver.net, DNS:www.naver.asia, DNS:www.naver.co, DNS:www.naver.kr, DNS:www.naver.co.kr, DNS:naver.com, DNS:naver.net, DNS:naver.asia, DNS:naver.co, DNS:naver.kr, DNS:naver.co.kr
            X509v3 Key Usage: critical
                Digital Signature, Key Encipherment
            X509v3 Extended Key Usage:
                TLS Web Server Authentication, TLS Web Client Authentication
            X509v3 CRL Distribution Points:

                Full Name:
                  URI:http://crl3.digicert.com/DigiCertTLSRSASHA2562020CA1-4.crl

                Full Name:
                  URI:http://crl4.digicert.com/DigiCertTLSRSASHA2562020CA1-4.crl

            X509v3 Certificate Policies:
                Policy: <span class="token number">2.23</span>.140.1.2.2
                  CPS: http://www.digicert.com/CPS

            Authority Information Access:
                OCSP - URI:http://ocsp.digicert.com
                CA Issuers - URI:http://cacerts.digicert.com/DigiCertTLSRSASHA2562020CA1-1.crt

            <span class="token punctuation">..</span>.
    Signature Algorithm: sha256WithRSAEncryption
         2e<span class="token punctuation">..</span>.</code></pre>

<p>네이버 사이트의 서버 인증서를 전달받은 후 X.509 인증서 정보를 조회해보면 네이버의 인증서를 발급한 기관은 DigiCert 이며 네이버 인증서에 포함되는 공개키를 sha256WithRSAEncryption 서명 알고리즘을 사용해서 전자 서명을 한 것을 확인할 수 있습니다.</p>
<ul>
<li>인증서 발급 기관(Issuer)</li>
<li>인증서 만료 기한(Validity) </li>
<li>공개키 소유자(Subject) </li>
<li>공개키(Subject Public Key Info)</li>
<li>서명 알고리즘(Signature Algorithm)</li>
<li>소유자 대체 이름(Subject Alternative Name)</li>
</ul>
<h2 id="PKCS"><a href="#PKCS" class="headerlink" title="PKCS"></a>PKCS</h2><p>PKCS(Public key Cryptography Standard)는 공개키 기반 인증 구조에서 안전하게 정보를 교환하기 위한 프로토콜입니다.</p>
<h3 id="PKCS-8"><a href="#PKCS-8" class="headerlink" title="PKCS#8"></a>PKCS#8</h3><p><a href="https://datatracker.ietf.org/doc/html/rfc5208">RFC5208</a>로 정의된 PKCS#8은 공개키 기반 인증 구조에서 사용되는 개인키를 표현하고 저장하기 위한 표준으로 앞서 X.509 인증서와 같이 PEM 형식으로 저장합니다. 지난 <a href="/mutual-tls/">Mutual TLS</a>에서는 자바 애플리케이션에서 PEM 형식의 클라이언트 인증서와 개인키를 통해 키 스토어를 만드는 과정에서 PKCS8EncodedKeySpec 이란 것을 사용했다는 것을 알 수 있습니다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ubuntu@ubuntu:~/x509$ openssl pkey -in local.dev+1-key.pem
-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDYwndPT50cwnCy
AFJP569u4trr87V0hdb28FG8t3T1kHGbkd3C0byHjb+qDjC53/bhmyP6Y5UXAqGc
JPhE1GbVa7BbLzWRgoq9+EG15DW/evzPB0jN2QvbKHoo1PDaqFg46+CxrVPhV/KT
jh27IyaIsiB+5YO+hKTlK2rJ1Zsek/MaFJcntrItAPlW1fyerZSVyosdKonZYiIg
SGNh1pLTfhwSGG7bbkcFzittouyj8E/41EYGZXAKuS5n7vfqU7OWpNo10mp3li5C
hdP/UcTMtoxin3U8GKlOGY22c9c17PlHiO4YLD6qa4Z1QZAwHoza1zSdTt/dCG8L
YG6Cf1enAgMBAAECggEAIehp2ZJOtY0FLBM4zR8lJmd+b6K0JAI72m1FnAvm0/NA
kmGDG1LL9ziJXwTRQoJykGBAhI7HZ84VkeOGot3HKGOsNtdvvc95/LW1Mcr9TXLj
0U8GaI0neaUfVvvYoZvsERt1DtZaZMnpPIPiyr9467FRvAgTT95YHTFphyFPHr0k
VlAd4qAbyIzOSiGmoBg2Krjk5dXW9Cg7YIxKNUXlxMHNlP3c9zxKyy7Cd3qcp4tF
zKxqiTXPEdOxw3b66P/2+RQWi6kCQfu2RINZLjzPBajjEYJ8/o8sVXDs1Bl6pPnp
YzMLjHapX8V+NuuG8r9O8Y28siO0NT+tpVnyJHUE4QKBgQDdTb7KJySyUYk+xySC
Pv3lpBucfnJDy7veWNdiu4KIMVtqnenPJATVE9ovdWFNNrr+1cLJG/uvM3AOSTLH
JRXHcFewm2ipxovgr6SKx65zevHbbVMcaDir3hdvh6h7qG/naURQlNz1xups68g8
9xvbBnFp/X4fTDto+QQUIR5hRQKBgQD6vlcYJUcG7rr6nOEacUtxvhE59qX5sWDC
AvrfP/IUjitsqiH9YRTkuUfYQXGQMMfpXCViZ/UVQEsiI4LMY3wM4pquWplZVn9C
eyrbgZn/QP2Bp1nExmL21HWGooBG6l2lxGM18lMIzY7vE5GMzGGkH8rRHqgkIAku
TIC5G/sl+wKBgQCGvXUyY87F+zrSzDEAVBYGIXrmN16exIaoA/Nvm7cH8PU13tui
UM3YZfPr/U2202HbEo88HxuIOos5R3vxIDU4bsAVOSnqZIZ50LcgAB/JE8v5y4BU
xWfrzJb8Qt5kG9O2U7NSVLCLvAazNoN+Cv4cxrl6zOpjZ+isKyE+mEOE+QKBgQC5
M1l09iOuFSp57OG+/CtzSaXDoFAbS05iPn055CtTz2Z3jnoogkpCXi+YpU3R6JXf
4TWjp5E4LxLPllcHy/tWMRF68mQNvnukiQCwvNsX09Lqrsb5NmbmVSqxVNlWh8i/
pXx53hBCkkGeiF+bFWKRLQJKz0/1zsu5LLxu/SHVfQKBgGuldPS/1zqt1eblPAeo
bBot1LMCxS8Bk6n1dMiWDM0+yANwh+tkA+MFyZTbdPjjf2e+RAXwUtsKLSvJha0E
XLEZPSQL7WDIleYVJ5oAX4nfHS4eNZzvxnL7bblcWtekrBNnHinKS+Cqd+ATLixL
nDpi0w+DTfQu93eKXg1NCYrg
-----END PRIVATE KEY-----

ubuntu@ubuntu:~/x509$ openssl pkey -in local.dev+1-key.pem -text -noout
RSA Private-Key: <span class="token punctuation">(</span><span class="token number">2048</span> bit, <span class="token number">2</span> primes<span class="token punctuation">)</span>
modulus:
    00<span class="token punctuation">..</span>.
<span class="token punctuation">..</span>.</code></pre>

<h3 id="PKCS-12"><a href="#PKCS-12" class="headerlink" title="PKCS#12"></a>PKCS#12</h3><p><a href="https://datatracker.ietf.org/doc/html/rfc7292">RFC7292</a>로 정의된 PKCS#12는 인증서와 개인키 등 공개키 기반 인증 구조에서 사용되는 다양한 항목들을 하나로 통합하여 교환하기 위한 정보 교환의 표준입니다. </p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ubuntu@ubuntu:~/x509$ openssl pkcs12 -in local.dev+1.pkcs12
Enter Import Password: mambo
Bag Attributes
    localKeyID: <span class="token number">16</span> CC 2D CE 9F D0 <span class="token number">52</span> C9 <span class="token number">72</span> <span class="token number">97</span> <span class="token number">90</span> DC EC AB DF <span class="token number">28</span> 0B EA B6 AA
<span class="token assign-left variable">subject</span><span class="token operator">=</span>O <span class="token operator">=</span> mkcert development certificate, OU <span class="token operator">=</span> ubuntu@ubuntu

<span class="token assign-left variable">issuer</span><span class="token operator">=</span>O <span class="token operator">=</span> mkcert development CA, OU <span class="token operator">=</span> ubuntu@ubuntu, CN <span class="token operator">=</span> mkcert ubuntu@ubuntu

-----BEGIN CERTIFICATE-----
MIIEDDCCAnSgAwIBAgIRAOUpmrpmzWKOajX3U1ze1McwDQYJKoZIhvcNAQELBQAw
VzEeMBwGA1UEChMVbWtjZXJ0IGRldmVsb3BtZW50IENBMRYwFAYDVQQLDA11YnVu
dHVAdWJ1bnR1MR0wGwYDVQQDDBRta2NlcnQgdWJ1bnR1QHVidW50dTAeFw0yMjA3
MTIyMTU1NDNaFw0yNDEwMTIyMTU1NDNaMEExJzAlBgNVBAoTHm1rY2VydCBkZXZl
bG9wbWVudCBjZXJ0aWZpY2F0ZTEWMBQGA1UECwwNdWJ1bnR1QHVidW50dTCCASIw
DQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBANjCd09PnRzCcLIAUk/nr27i2uvz
tXSF1vbwUby3dPWQcZuR3cLRvIeNv6oOMLnf9uGbI/pjlRcCoZwk+ETUZtVrsFsv
NZGCir34QbXkNb96/M8HSM3ZC9soeijU8NqoWDjr4LGtU+FX8pOOHbsjJoiyIH7l
g76EpOUrasnVmx6T8xoUlye2si0A+VbV/J6tlJXKix0qidliIiBIY2HWktN+HBIY
bttuRwXOK22i7KPwT/jURgZlcAq5Lmfu9+pTs5ak2jXSaneWLkKF0/9RxMy2jGKf
dTwYqU4ZjbZz1zXs+UeI7hgsPqprhnVBkDAejNrXNJ1O390IbwtgboJ/V6cCAwEA
AaNpMGcwDgYDVR0PAQH/BAQDAgWgMBMGA1UdJQQMMAoGCCsGAQUFBwMBMB8GA1Ud
IwQYMBaAFDsxXS981ubi9ZtmHeV1XBHGhYxtMB8GA1UdEQQYMBaCCWxvY2FsLmRl
doIJbG9jYWxob3N0MA0GCSqGSIb3DQEBCwUAA4IBgQBD4YEY1QTK1HNohU0d1HnL
Ag3Pm9bUJxGWw2bOAO+0Dgdau3Fn+72JPz7ZYGX3Deny01TYDEoeno7VOY+gq2u0
F4L1SBNWdXhdxxfj/4JK3r1FpmgmEpPOVyrO2KMWgPlNu4JV8jUc/OIOeKYe8S9V
ddM7VyRjZSCNKsI4kneeu/fZFXLMtWS8lcj/hubQdGYXuSaSZHihpTPvCR2XP6z+
NbeDndqo4YemGIUS2eyp4MQCwlR910FUv3NNgk43iJw368ma8p/jigQeUx9reyYK
ijxd/rbwmg9k5Mks+CgK7pi0Bd8uJxD5i9KgitDBetjoPbw8xIazDUbhtPofs3y8
HTGqR4kszm4JZMh0310Ff3hkqjXwT1oVEMrBUUUZrSBjuUEy7bujgu1JBV1f/j5l
LzS5dMOM68x7my7YVSUG+hbjeB9w9eZWLx/YZ707ssvAfKVvWoyKrwwlZTQRs7mI
HRcM9stz0/k/ZQZH0IBerjuPJ93BKH0wRYxU33i3htQ<span class="token operator">=</span>
-----END CERTIFICATE-----
Bag Attributes
    localKeyID: <span class="token number">16</span> CC 2D CE 9F D0 <span class="token number">52</span> C9 <span class="token number">72</span> <span class="token number">97</span> <span class="token number">90</span> DC EC AB DF <span class="token number">28</span> 0B EA B6 AA
Key Attributes: <span class="token operator">&lt;</span>No Attributes<span class="token operator">></span>
Enter PEM pass phrase: mambo
Verifying - Enter PEM pass phrase: mambo
-----BEGIN ENCRYPTED PRIVATE KEY-----
MIIFHDBOBgkqhkiG9w0BBQ0wQTApBgkqhkiG9w0BBQwwHAQIUCWpIEy8DAECAggA
MAwGCCqGSIb3DQIJBQAwFAYIKoZIhvcNAwcECAwP9e11T4W6BIIEyP1XL6GHaVmq
cgu+jiWoeopRciYOLS0MWB8Yzb/8Rslyx1l1MAluW+QP30qCbVhhO6l7ulziGC0h
RNNNittmdSrZKPbNtch8ZY0G/dWoMY9VfjJSdndbWwXv8zulRXMYiXeVME8MsmG5
HPTZyc785dVpeCYaFt6muWw2ABnP97ShSLdIRAeY2G6HDLnEz3/hjbYfE2UFF68i
k/wEEtK5f48XxM+PuyDKk4b3+qFfqVSRS6QbdCnrKVQfGqeiWQKOdt/FQZ82/xIq
lu3kVuXPmEaN8W62MK1vCocjm/AXJ6l01gUqL00a6ntdTdsCXA6g0qpcwZDd6/1g
VgsEK0Y1mbzfq1YS52zw+obHp6nIJpA7Fnllf6irT3mSyEIzorIZ4z4As6CA91Em
M4DjFJ6FlLpmVIofe0JlzGxTZ1yueWLZjGf+3sEImikF6ndzh+dCV0ox73h6g8Vs
D79MHkaZfuBL0ZrxyGSOomRO9WhRrjUihlgILLtMHStWDDTp4F194SiD2T+xC25L
uvpfQAmLYYL+otb9n2cv1thik/MjZCDk5duYcRDLUJ3G23MaHk6DC13JaDk925zF
hbnFCt1PTzvWZ+HjE1GEFiDr88YJkyLdI7VKTsMC/bcfAE7SrpaqX0cLVjnmlIQK
5ScNYvB+PxCJj95YZsVpZ8cw9V/NlkWT1kpSX//G8Wl4YKW0vM25aBCca2hFqbCD
C3/6vqqx4z8D+r3K8KRVV/7y94JaMoHjrvd1fjUDOQfuilh3bgfCmhuFS8IV/HjB
bkuPY/O8O8abcb16wTMReKqahpmFsdOwIC/2gqoTQbKp2xbtY+gcvcObsWQRMcMH
mrHx2vMO4Tr4BKgNBxz4Gv5KAE/Pa2Gvqs0O5xsLNxF1kMUyT5CkrAuUayvysGHv
Y98p7ORHFKfA+tFOxgf7jBrs6/BpQmZHrbOU4v4WplpcbUe9e31l11n8BkQ/qhcO
rtsxqcYub3PRXwpm68LhDacKTdtyVv/j6yYba/RbfSn8ZwZAiwS6oW69qa/JCtEC
iw0058pNxHujA/A4Ceb7G9uFPhNb2UfgwzmID5tzxOhQype0vi02Vc1sMZHAsmII
iIpJUmh37Td1VkxUg+3FspeOmw00z4WNkrf1SMpFabpySw4BXcJMDIOxYhQI/ij6
mPglTjvJHF6eMw53l84MJIUHFkQDGTX2eLZBW91lDxVxmMkt74G7rD9j6pfm/Eo5
gezjc9DcX3ot1T6Gv0rk0ilF3Vfuw5+f46ZtZBQqYlFalKgYVpelidv2y5kC7gEn
fabH93l9GFHU4OKT1IESwPt4E0pJttVfTAwx3dBT/h8BgfN3bOqM1EdZF0/KIoc1
NLl1H2o/EZ94Jig25N3jqJ7w0riNE3dE891Fu715nfEjfSxIpMKC78FR/J9qTXgu
6sUwNgCs/DdVqruOjwFKupNgQcj7fwSJtnyQGY9fpZjAG+e5MiPxNFDjaoLu8M7k
<span class="token number">5</span>+CGelITcwbq2U8InZIpZTOCLif3zuHg0hkf3GXCsAapfQnmovR/xjtJBWEZVw+Z
2otgK9OruIMuEwxzxX2awqI5zDN2yBCnP62eEYoJ+HKM21i/hexMF4jIh9H+H99W
<span class="token assign-left variable">oFgNCNUwDw6RXPEUEqnTzQ</span><span class="token operator">==</span>
-----END ENCRYPTED PRIVATE KEY-----</code></pre>

<h4 id="Convert-PEM-to-PKCS-12"><a href="#Convert-PEM-to-PKCS-12" class="headerlink" title="Convert PEM to PKCS#12"></a>Convert PEM to PKCS#12</h4><pre class="language-bash" data-language="bash"><code class="language-bash">ubuntu@ubuntu:~/x509$ openssl pkcs12 -export -in local.dev+1.pem -inkey local.dev+1-key.pem -out local.dev+1.pkcs12
Enter Export Password: mambo
Verifying - Enter Export Password: mambo</code></pre>

<h4 id="Convert-PKCS-12-to-JKS"><a href="#Convert-PKCS-12-to-JKS" class="headerlink" title="Convert PKCS#12 to JKS"></a>Convert PKCS#12 to JKS</h4><pre class="language-bash" data-language="bash"><code class="language-bash">ubuntu@ubuntu:~/x509$ keytool -importkeystore -srckeystore local.dev+1.pkcs12 -srcstoretype PKCS12 -deststoretype JKS -destkeystore local.dev+1.jks
Importing keystore local.dev+1.pkcs12 to local.dev+1.jks<span class="token punctuation">..</span>.
Enter destination keystore password: mambo
Re-enter new password: mambo
Enter <span class="token builtin class-name">source</span> keystore password: mambo
Entry <span class="token keyword">for</span> <span class="token builtin class-name">alias</span> <span class="token number">1</span> successfully imported.
Import <span class="token builtin class-name">command</span> completed:  <span class="token number">1</span> entries successfully imported, <span class="token number">0</span> entries failed or cancelled

Warning:
The JKS keystore uses a proprietary format. It is recommended to migrate to PKCS12 <span class="token function">which</span> is an industry standard <span class="token function">format</span> using <span class="token string">"keytool -importkeystore -srckeystore local.dev+1.jks -destkeystore local.dev+1.jks -deststoretype pkcs12"</span><span class="token builtin class-name">.</span></code></pre>

<p>Java KeyStore API에서는 PKCS#12를 기본 형식으로 사용하고 있습니다. 그래서 PKCS#12로 되어있는 파일을 그대로 KeyStore로 불러올 수 있으므로 굳이 JKS 형식의 파일로 변환할 필요는 없습니다. 오히려 마지막 경고 문구에서 알려주는 것처럼 JKS 형식으로 되어있는 키스토어 파일을 PKCS#12로 변환하는 방법을 아는게 좋습니다.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">ubuntu@ubuntu:~/x509$ keytool -importkeystore -srckeystore local.dev+1.jks -destkeystore local.dev+1.jks -deststoretype pkcs12
Enter <span class="token builtin class-name">source</span> keystore password: mambo
Entry <span class="token keyword">for</span> <span class="token builtin class-name">alias</span> <span class="token number">1</span> successfully imported.
Import <span class="token builtin class-name">command</span> completed:  <span class="token number">1</span> entries successfully imported, <span class="token number">0</span> entries failed or cancelled

Warning:
Migrated <span class="token string">"local.dev+1.jks"</span> to PKCS12. The JKS keystore is backed up as <span class="token string">"local.dev+1.jks.old"</span><span class="token builtin class-name">.</span></code></pre>

<h2 id="Links"><a href="#Links" class="headerlink" title="Links"></a>Links</h2><ul>
<li><a href="https://www.youtube.com/watch?v=t0F7fe5Alwg">Public Key Infrastructure PKI Concepts</a></li>
<li><a href="https://stackoverflow.com/a/7886248">Using openssl to get the certificate from a server</a></li>
<li><a href="https://stackoverflow.com/a/15144560">Converting PKCS#12 certificate into PEM using OpenSSL</a></li>
<li><a href="https://d2.naver.com/helloworld/197937">JCA로 이해하는 암호화와 보안</a></li>
<li><a href="https://d2.naver.com/helloworld/227016">JCA로 이해하는 암호화와 보안 2</a></li>
<li><a href="https://gruuuuu.github.io/security/what-is-x509/">호다닥 공부해보는 x509와 친구들</a></li>
</ul>
]]></content>
      <tags>
        <tag>X.509</tag>
        <tag>PKI</tag>
        <tag>PKCS#8</tag>
        <tag>PKCS#12</tag>
      </tags>
  </entry>
  <entry>
    <title>엔진엑스로 알아보는 리버스 프록시</title>
    <url>/reverse-proxy-using-nginx/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p><img data-src="https://digital.com/wp-content/uploads/what-is-nginx.png"></p>
<p>오늘은 웹 서비스 인프라에서 리버스 프록시 구성을 위해 사용되는 Nginx와 함께 리버스 프록시에 대해 알아보고자 합니다.</p>
<h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><p>Nginx는 정적 파일을 배포할 수 있는 HTTP 웹 서버입니다. 최근 애플리케이션 서버를 배포하는 경우 단독으로 구성하지 않고 Nginx를 함께 사용합니다. 아마존 웹 서비스의 Elastic Beanstalk 환경에서는 리버스 프록시 구성을 위하여 Nginx를 기본적으로 제공하고 있습니다. 이렇게 애플리케이션 서버 앞에서 먼저 트래픽을 처리하도록 구성하는 리버스 프록시를 사용하는 이유는 무엇일까요?</p>
<h3 id="리버스-프록시"><a href="#리버스-프록시" class="headerlink" title="리버스 프록시"></a>리버스 프록시</h3><p>리버스 프록시는 <strong>사용자의 요청에 대한 사후처리를 수행하여 애플리케이션 서버로 트래픽을 전달되도록 하는 것</strong>을 말합니다. 리버스 프록시 구성의 장점은 사용자에게 애플리케이션 서버가 실행되는 아이피 또는 포트를 공개하지 않거나 잘못된 요청을 애플리케이션 서버까지 전달되지 않도록하여 보호할 수 있습니다. </p>
<h3 id="로드-밸런싱"><a href="#로드-밸런싱" class="headerlink" title="로드 밸런싱"></a>로드 밸런싱</h3><p>리버스 프록시를 구성함으로써 사용자는 특정 애플리케이션 서버로 직접 요청하는 구조가 아니므로 동시에 발생하는 수 많은 웹 요청을 1개 이상으로 실행된 다수의 애플리케이션 서버로 <strong>로드밸런싱(트래픽을 분산)</strong> 함으로써 애플리케이션 서버에 대한 부하를 줄일 수 있습니다.</p>
<p>물론, 에픽 게임즈의 <a href="https://www.epicgames.com/fortnite/ko/news/postmortem-of-service-outage-at-3-4m-ccu">340만 동접자 이후 서비스 다운 관련 사후 분석 내용</a>처럼 리버스 프록시를 구성한다고해서 모든 트래픽을 감당할 수 있는 것은 아닙니다.</p>
<h3 id="SSL-오프로드"><a href="#SSL-오프로드" class="headerlink" title="SSL 오프로드"></a>SSL 오프로드</h3><p>Nginx로 리버스 프록시를 구성함으로써 수행할 수 있는 사후처리 중 하나는 <strong>SSL 오프로드</strong>입니다. 리버스 프록시를 수행하는 웹 서버에서 SSL 인증서를 관리하고 <a href="https://www.f5.com/services/resources/glossary/ssl-termination">SSL Termination</a>을 수행함으로써 애플리케이션 서버가 트래픽 암호화를 위해 수행하던 부하와 관리 포인트를 줄일 수 있습니다.</p>
<h3 id="정적-파일-캐시"><a href="#정적-파일-캐시" class="headerlink" title="정적 파일 캐시"></a>정적 파일 캐시</h3><p>애플리케이션 서버가 배포하는 정적 파일에 대해서 Nginx 자체적으로 캐시하여 정적 파일을 응답할 수 있습니다. 애플리케이션 서버로 전달되는 트래픽이 많아질 경우 정적 파일을 응답하기 위한 요청을 처리하는 것도 부담이 될 수 있습니다. 많은 트래픽을 적은 리소스를 사용하여 처리할 수 있는 웹 서버에서 정적 파일에 대한 요청을 처리하여 애플리케이션 서버의 부담을 줄일 수 있게 됩니다.</p>
<p>창천향로님의 <a href="https://jojoldu.tistory.com/60">Nginx Cache 문제 해결 시리즈</a>처럼 캐시를 잘 구성해야할 수 있습니다.</p>
<h2 id="Nginx-도커-컨테이너-학습"><a href="#Nginx-도커-컨테이너-학습" class="headerlink" title="Nginx 도커 컨테이너 학습"></a>Nginx 도커 컨테이너 학습</h2><p>도커는 어떠한 기술을 학습하기 위한 환경을 구성하기에 적합한 도구입니다. 도커를 사용하여 애플리케이션 서버와 함께 리버스 프록시를 구성하는 Nginx를 설정해보며 학습해보도록 하겠습니다.</p>
<p>저의 학습 환경은 다음과 같습니다. 환경이 다른 경우 다른 부분이 존재할 수 있으니 주의해야합니다. </p>
<ul>
<li>Docker version 20.10.8, build 3967b7d  </li>
<li>Nginx 1.21.3  </li>
<li>Amazon Corretto 11</li>
</ul>
<p>그리고 학습에 활용된 파일들은 <a href="https://github.com/kdevkr/nginx.conf">깃허브</a>에 공유되어있으니 참고하셔도 좋습니다.</p>
<h3 id="기본-컨테이너-환경"><a href="#기본-컨테이너-환경" class="headerlink" title="기본 컨테이너 환경"></a>기본 컨테이너 환경</h3><p>도커 컴포즈를 활용하여 스프링 부트 애플리케이션과 Nginx가 구동되도록 컨테이너 환경을 구성했습니다.</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.8'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span> 
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.21.3<span class="token punctuation">-</span>alpine
    <span class="token key atrule">ports</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token datetime number">80:80</span>
      <span class="token punctuation">-</span> 443<span class="token punctuation">:</span><span class="token number">443</span>
  <span class="token key atrule">app</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> amazoncorretto<span class="token punctuation">:</span>11<span class="token punctuation">-</span>alpine
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 8080<span class="token punctuation">:</span><span class="token number">8080</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'java -jar /etc/app.jar'</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./demo<span class="token punctuation">-</span>0.0.1<span class="token punctuation">-</span>SNAPSHOT.jar<span class="token punctuation">:</span>/etc/app.jar</code></pre>

<p>도커 컴포즈 명령어로 컨테이너 환경을 실행합니다.</p>
<pre class="language-ps" data-language="ps"><code class="language-ps">docker compose up -d
[+] Running 3&#x2F;3
 - Network nginx_default    Created
 - Container nginx_nginx_1  Started
 - Container nginx_app_1    Started</code></pre>

<p>제 컴퓨터 <strong>호스트 파일에 127.0.0.1에 대하여 mambo.kr가 지정</strong>되어있으므로 다음과 같이 Nginx가 80포트에 대한 요청에 대해 기본 페이지를 응답하였습니다.</p>
<p><img data-src="/images/posts/reverse-proxy-using-nginx/nginx-02.png"></p>
<h3 id="기본-Nginx-설정"><a href="#기본-Nginx-설정" class="headerlink" title="기본 Nginx 설정"></a>기본 Nginx 설정</h3><p>도커 컴포즈 명령어로 컨테이너 진입 후 기본으로 적용되어있는 Nginx 설정을 확인해보도록 하겠습니다.</p>
<pre class="language-ps" data-language="ps"><code class="language-ps">docker compose exec nginx sh
&#x2F; # cat &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</code></pre>

<p><img data-src="/images/posts/reverse-proxy-using-nginx/nginx-03.png"></p>
<p>80포트를 수신하는 웹 서버 설정은 <strong>&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;default.conf</strong>에 위치하고 있었습니다. 다음은 default.conf에 정의된 내용 중 일부입니다.</p>
<pre class="language-ps" data-language="ps"><code class="language-ps">&#x2F;etc&#x2F;nginx&#x2F;conf.d # cat default.conf
server &#123;
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    #access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;host.access.log  main;

    location &#x2F; &#123;
        root   &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;
        index  index.html index.htm;
    &#125;
    # ...
&#125;</code></pre>

<p>server 블록을 통해 80포트를 수신(listen)하였고 루트 경로(&#x2F;)에 대한 요청을 <strong>&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html에 위치한 index.html</strong>이라는 정적 파일을 응답하도록 정의되어있습니다. </p>
<h3 id="사용자-정의-Nginx-설정"><a href="#사용자-정의-Nginx-설정" class="headerlink" title="사용자 정의 Nginx 설정"></a>사용자 정의 Nginx 설정</h3><p>기본으로 적용되어있는 nginx.conf를 볼륨으로 지정하여 사용자 정의할 수 있도록 해보겠습니다. 도커 컴포즈 문서에 Nginx 서비스에 볼륨을 지정하여 로컬 파일로 저장되어있는 nginx.conf를 지정하겠습니다.</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.8'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span> 
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.21.3<span class="token punctuation">-</span>alpine
    <span class="token key atrule">ports</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token datetime number">80:80</span>
      <span class="token punctuation">-</span> 443<span class="token punctuation">:</span><span class="token number">443</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./nginx.conf<span class="token punctuation">:</span>/etc/nginx/nginx.conf
  <span class="token comment">#app:</span>
  <span class="token comment">#  ...</span></code></pre>

<p>호스트의 443포트를 Nginx 서비스에 바인딩하였으므로 443포트를 수신하도록 정의해보겠습니다.</p>
<pre class="language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">server_name</span> localhost 127.0.0.1 mambo.kr</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_certificate</span> /etc/nginx/server.crt</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_certificate_key</span> /etc/nginx/server.key</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_protocols</span> TLSv1.2 TLSv1.3</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_ciphers</span> HIGH:!aNULL:!MD5</span><span class="token punctuation">;</span>

        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
            <span class="token directive"><span class="token keyword">proxy_pass</span> http://app:8080</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token directive"><span class="token keyword">include</span> /etc/nginx/conf.d/*.conf</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>도커 컴포즈로 컨테이너 환경을 다시 실행하면 정상적으로…</p>
<pre class="language-ps" data-language="ps"><code class="language-ps">nginx: [emerg] no &quot;events&quot; section in configuration</code></pre>

<p>오류가 발생했네요. nginx.conf에 events 블록은 필수로 존재해야하는 듯 합니다.</p>
<h4 id="프로세스-및-처리-옵션"><a href="#프로세스-및-처리-옵션" class="headerlink" title="프로세스 및 처리 옵션"></a>프로세스 및 처리 옵션</h4><p>Nginx는 마스터 프로세스와 워커 프로세스로 구성되어 실제로 요청을 처리하는 것은 워커 프로세스가 담당합니다. 사용가능한 CPU 코어 수 만큼 워커 프로세스를 할당하는게 좋으며 워커 프로세스별로 사용할 수 있는 최대 열린 파일 개수 제한을 설정하는 것이 좋습니다.</p>
<pre class="language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">worker_processes</span> auto</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">worker_cpu_affinity</span> auto</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">worker_rlimit_nofile</span> <span class="token number">65536</span></span><span class="token punctuation">;</span>

<span class="token directive"><span class="token keyword">events</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">worker_connections</span> <span class="token number">1024</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">use</span> epoll</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">multi_accept</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><img data-src="/images/posts/reverse-proxy-using-nginx/nginx-01.png" alt="Optimizations - Event Models"></p>
<p>운영체제별 <a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/optimizations/#event-models">효율적인 연결 처리 방식</a>이 있으며 리눅스 커널 2.6+에서는 <strong>epoll</strong>을 사용할 수 있습니다.</p>
<p>Nginx 서비스 컨테이너가 정상적으로 실행되지 않은 상태이므로 도커 컴포즈로 컨테이너 환경을 실행해야합니다.</p>
<pre class="language-ps" data-language="ps"><code class="language-ps">docker compose up -d
[+] Running 2&#x2F;2
 - Container nginx_nginx_1  Started
 - Container nginx_app_1    Running</code></pre>

<p>잘 실행된것으로 보이니 <a href="https://mambo.kr으로/">https://mambo.kr으로</a> 접속해보도록 하겠습니다.</p>
<p><img data-src="/images/posts/reverse-proxy-using-nginx/nginx-04.png"></p>
<p>443 포트로 요청된 트래픽이 Nginx를 경유하여 8080포트로 실행된 애플리케이션 서버로 전달되고 응답을 받았습니다. 바로 이것을 <strong>리버스 프록시</strong>라고 합니다.</p>
<h4 id="리버스-프록시-1"><a href="#리버스-프록시-1" class="headerlink" title="리버스 프록시"></a>리버스 프록시</h4><p>리버스 프록시를 구성하면 애플리케이션 서버는 어디서 요청했는지에 대한 정보를 알 수 없습니다. 그래서 Nginx와 같은 리버시 프록시를 구성하는 웹 서버에서는 프록시 관련 헤더를 함께 전달하여 어디서 요청되었는지를 전달할 수 있도록 설정할 수 있습니다.</p>
<pre class="language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">server_name</span> localhost 127.0.0.1 mambo.kr</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_certificate</span> /etc/nginx/server.crt</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_certificate_key</span> /etc/nginx/server.key</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_protocols</span> TLSv1.2 TLSv1.3</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_ciphers</span> HIGH:!aNULL:!MD5</span><span class="token punctuation">;</span>

        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
            <span class="token directive"><span class="token keyword">proxy_pass</span> http://app:8080</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token directive"><span class="token keyword">include</span> /etc/nginx/conf.d/*.conf</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="웹소켓-프록시"><a href="#웹소켓-프록시" class="headerlink" title="웹소켓 프록시"></a>웹소켓 프록시</h4><p>HTTP 1.1 프로토콜은 Hop-By-Hop이라고 하는 Upgrade 헤더를 사용하여 커넥션을 변경하는 매커니즘을 제공합니다. <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Protocol_upgrade_mechanism#upgrading_to_a_websocket_connection">Upgrading to a WebSocket connection</a>과 <a href="http://nginx.org/en/docs/http/websocket.html">WebSocket proxying</a> 문서를 참고하여 다음과 같이 웹소켓 프록시에 대한 설정을 구성할 수 있습니다.</p>
<pre class="language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">location</span> /ws/</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://backend</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Connection <span class="token string">"upgrade"</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_read_timeout</span> <span class="token number">65s</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>프록시 서버는 기본적으로 60초 이내에 전달되는 데이터가 없는 경우 연결을 해지합니다. 예를 들어, 1분마다 웹소켓으로 전달되는 데이터가 있는 경우를 위해 proxy_read_timeout을 조정해야합니다.</p>
</blockquote>
<h4 id="이벤트-스트림-프록시"><a href="#이벤트-스트림-프록시" class="headerlink" title="이벤트 스트림 프록시"></a>이벤트 스트림 프록시</h4><p>리버스 프록시 구성에서 SSE(Server Sent Event)와 같은 이벤트 스트림을 사용하는 경우 버퍼링 옵션을 비활성화 해야합니다.</p>
<ul>
<li><a href="https://stackoverflow.com/questions/13672743/eventsource-server-sent-events-through-nginx">EventSource &#x2F; Server-Sent Events through Nginx</a></li>
<li><a href="https://serverfault.com/questions/801628/for-server-sent-events-sse-what-nginx-proxy-configuration-is-appropriate">For Server-Sent Events (SSE) what Nginx proxy configuration is appropriate?</a></li>
</ul>
<pre class="language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">proxy_buffering</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_cache</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="HTTPS-리다이렉트"><a href="#HTTPS-리다이렉트" class="headerlink" title="HTTPS 리다이렉트"></a>HTTPS 리다이렉트</h4><p>일반 HTTP를 사용하여 80포트로 요청한 것을 HTTPS를 사용하도록 유도하기 위해서 HTTPS 리다이렉트 응답을 적용할 수 있습니다.</p>
<pre class="language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> _</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> https://<span class="token variable">$host</span><span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="정적-파일-배포"><a href="#정적-파일-배포" class="headerlink" title="정적 파일 배포"></a>정적 파일 배포</h4><p>추가적으로 정적 파일이 포함된 폴더를 볼륨으로 지정하여 Nginx에서 정적 파일을 응답할 수 있도록 설정하겠습니다.</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.8'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span> 
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.21.3<span class="token punctuation">-</span>alpine
    <span class="token key atrule">ports</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token datetime number">80:80</span>
      <span class="token punctuation">-</span> 443<span class="token punctuation">:</span><span class="token number">443</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./nginx.conf<span class="token punctuation">:</span>/etc/nginx/nginx.conf
      <span class="token punctuation">-</span> ./server.crt<span class="token punctuation">:</span>/etc/nginx/server.crt
      <span class="token punctuation">-</span> ./server.key<span class="token punctuation">:</span>/etc/nginx/server.key
      <span class="token punctuation">-</span> ./static<span class="token punctuation">:</span>/etc/nginx/static</code></pre>

<pre class="language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">worker_processes</span> auto</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">worker_cpu_affinity</span> auto</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">worker_rlimit_nofile</span> <span class="token number">65536</span></span><span class="token punctuation">;</span>

<span class="token directive"><span class="token keyword">events</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">worker_connections</span> <span class="token number">1024</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">use</span> epoll</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">multi_accept</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">server_name</span> _</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> https://<span class="token variable">$host</span><span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">server_name</span> localhost 127.0.0.1 mambo.kr</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_certificate</span> /etc/nginx/server.crt</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_certificate_key</span> /etc/nginx/server.key</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_protocols</span> TLSv1.2 TLSv1.3</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_ciphers</span> HIGH:!aNULL:!MD5</span><span class="token punctuation">;</span>

        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
            <span class="token directive"><span class="token keyword">proxy_pass</span> http://app:8080</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token directive"><span class="token keyword">location</span> /dist/</span> <span class="token punctuation">&#123;</span>
            <span class="token directive"><span class="token keyword">alias</span> /etc/nginx/static/</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">limit_except</span> GET</span> <span class="token punctuation">&#123;</span>
                <span class="token directive"><span class="token keyword">deny</span> all</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token directive"><span class="token keyword">include</span> /etc/nginx/conf.d/*.conf</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><img data-src="/images/posts/reverse-proxy-using-nginx/nginx-05.png"></p>
<p>정적 파일까지 응답할 수 있도록 설정하였습니다.</p>
<h3 id="Nginx-설정-최적화"><a href="#Nginx-설정-최적화" class="headerlink" title="Nginx 설정 최적화"></a>Nginx 설정 최적화</h3><p>사용자 정의한 Nginx 설정만으로도 리버스 프록시 및 정적 파일을 배포하는데에는 문제가 없습니다. 그러나 Nginx에서는 더 효율적으로 동작할 수 있도록 다양한 옵션을 제공합니다. 여러가지 옵션들을 적용해보면서 최적화해보도록 합시다.</p>
<p>Nginx 설정 최적화에 대해서는 다음의 글을 참고하면 좋습니다.</p>
<ul>
<li><a href="https://github.com/denji/nginx-tuning/blob/master/README.md">NGINX Tuning For Best Performance</a>  </li>
<li><a href="https://couplewith.tistory.com/m/entry/%EA%BF%80%ED%8C%81-%EA%B3%A0%EC%84%B1%EB%8A%A5-Nginx%EB%A5%BC%EC%9C%84%ED%95%9C-%ED%8A%9C%EB%8B%9D-1-%EB%94%94%EC%8A%A4%ED%81%AC%EC%9D%98-IO-%EB%B3%91%EB%AA%A9-%EC%A4%84%EC%9D%B4%EA%B8%B0?category=212810">[꿀팁] 고성능 Nginx를위한 튜닝</a></li>
</ul>
<h4 id="TCP-옵션"><a href="#TCP-옵션" class="headerlink" title="TCP 옵션"></a>TCP 옵션</h4><p><a href="https://thoughts.t37.net/nginx-optimization-understanding-sendfile-tcp-nodelay-and-tcp-nopush-c55cdd276765">Nginx Optimization: understanding sendfile, tcp_nodelay and tcp_nopush</a>에서는 TCP 옵션을 지정하는 이유에 대해서 설명합니다. 네트워크 환경이 빠른 경우 TCP 스택에서 Nagle 알고리즘을 사용하는 것이 비효율적일 수 있다고 합니다.</p>
<pre class="language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">sendfile</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">tcp_nopush</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">tcp_nodelay</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="압축-옵션"><a href="#압축-옵션" class="headerlink" title="압축 옵션"></a>압축 옵션</h4><p>웹 요청에 대한 응답 데이터를 압축하는 것은 네트워크 비용을 줄이고 빠르게 응답할 수 있는 좋은 방법입니다. 서버 성능에 따라 압축 레벨을 최대한으로 지정하는 것이 좋습니다. 또한, 작은 크기에 데이터에 대하여 압축을 시도하는 것도 비효율적입니다.</p>
<pre class="language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">gzip</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_min_length</span> <span class="token number">1k</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_comp_level</span> <span class="token number">9</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_vary</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_disable</span> msie6</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_proxied</span> expired no-cache no-store private auth</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_types</span>
        <span class="token comment"># text/html is always compressed by HttpGzipModule</span>
        text/css
        text/javascript
        text/xml
        text/plain
        application/javascript
        application/json
        application/xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>일반적으로 텍스트 유형의 데이터를 압축하도록 지정합니다.</p>
<h4 id="로그-옵션"><a href="#로그-옵션" class="headerlink" title="로그 옵션"></a>로그 옵션</h4><p>모든 요청에 대해 액세스 로그를 저장하는 것은 비효율적으로 I&#x2F;O를 발생시킬 수 있습니다.</p>
<pre class="language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">error_log</span> /var/log/nginx/error.log crit</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">access_log</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">access_log</span> /var/log/nginx/access.log</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="보안-옵션"><a href="#보안-옵션" class="headerlink" title="보안 옵션"></a>보안 옵션</h4><p>많은 사람들이 server_tokens 옵션을 비활성화하여 응답 헤더에 Nginx 버전을 명시하지 않도록 권장합니다. 공격자는 Nginx의 특정 버전을 알 수 없으므로 더 많은 취약점에 대한 공격을 시도해야합니다.</p>
<pre class="language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">server_tokens</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="클라이언트-옵션"><a href="#클라이언트-옵션" class="headerlink" title="클라이언트 옵션"></a>클라이언트 옵션</h4><p>연결 유지 클라이언트 수와 최대 유지 시간 그리고 클라이언트 요청 크기를 조정할 수 있습니다.</p>
<pre class="language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">keepalive_timeout</span> <span class="token number">65</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">keepalive_requests</span> <span class="token number">10000</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">100m</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="리눅스-커널-파라미터"><a href="#리눅스-커널-파라미터" class="headerlink" title="리눅스 커널 파라미터"></a>리눅스 커널 파라미터</h4><p>Nginx 옵션을 지정하더라도 실제로 허용할 수 있는지 리눅스 커널 파라미터를 검토해야할 수 있습니다. </p>
<ul>
<li><a href="https://ma.ttias.be/linux-increase-ip_local_port_range-tcp-port-range/">Linux increase ip_local_port_range TCP port range</a></li>
<li><a href="https://couplewith.tistory.com/entry/%EA%BF%80%ED%8C%81-%EA%B3%A0%EC%84%B1%EB%8A%A5-Nginx%EB%A5%BC%EC%9C%84%ED%95%9C-%ED%8A%9C%EB%8B%9D-3-TCP-%EA%B4%80%EB%A0%A8-%EC%B2%98%EB%A6%AC%EB%9F%89-%EB%8A%98%EB%A6%AC%EA%B8%B0-%EB%A6%AC%EB%88%85%EC%8A%A4%EC%BB%A4%EB%84%90%ED%8A%9C%EB%8B%9D">TCP 관련 처리량 늘리기 - 리눅스 커널 튜닝</a></li>
</ul>
<h3 id="Nginx-설정-마무리"><a href="#Nginx-설정-마무리" class="headerlink" title="Nginx 설정 마무리"></a>Nginx 설정 마무리</h3><p>알아본 내용을 조합하면 다음과 같이 Nginx 설정을 정의할 수 있게 됩니다.</p>
<pre class="language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">user</span> nginx</span><span class="token punctuation">;</span>

<span class="token comment"># 프로세스 옵션</span>
<span class="token directive"><span class="token keyword">worker_processes</span> auto</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">worker_cpu_affinity</span> auto</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">worker_rlimit_nofile</span> <span class="token number">65536</span></span><span class="token punctuation">;</span>

<span class="token directive"><span class="token keyword">events</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">worker_connections</span> <span class="token number">1024</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">use</span> epoll</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">multi_accept</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token directive"><span class="token keyword">pid</span> /var/run/nginx.pid</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">error_log</span> /var/log/nginx/error.log crit</span><span class="token punctuation">;</span>
<span class="token comment">#thread_pool backend threads=32 max_queue=65536;</span>

<span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">include</span> /etc/nginx/mime.types</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">default_type</span> application/octet-stream</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">access_log</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">ssl_session_cache</span> shared:SSL:10m</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_session_timeout</span> <span class="token number">10m</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">upstream</span> backend</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">server</span> app:8080</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">keepalive</span> <span class="token number">128</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment"># HTTPS 리다이렉트</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">server_name</span> _</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> https://<span class="token variable">$host</span><span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment"># HTTPS 및 HTTP2 지원</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span> ssl http2</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">server_name</span> localhost 127.0.0.1 mambo.kr</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_certificate</span> /etc/nginx/server.crt</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_certificate_key</span> /etc/nginx/server.key</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_protocols</span> TLSv1.2 TLSv1.3</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_ciphers</span> HIGH:!aNULL:!MD5</span><span class="token punctuation">;</span>

        <span class="token comment"># 리버스 프록시</span>
        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
            <span class="token directive"><span class="token keyword">proxy_pass</span> http://backend</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_redirect</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_buffering</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>

            <span class="token comment">#aio threads=backend;</span>
            <span class="token directive"><span class="token keyword">access_log</span> /var/log/nginx/access.log</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment"># 리버스 웹소켓 프록시</span>
        <span class="token directive"><span class="token keyword">location</span> /ws/</span> <span class="token punctuation">&#123;</span>
            <span class="token directive"><span class="token keyword">proxy_pass</span> http://backend</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
            <span class="token comment"># hop-by-hop</span>
            <span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> Connection <span class="token string">"upgrade"</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_read_timeout</span> <span class="token number">65s</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token directive"><span class="token keyword">location</span> /dist/</span> <span class="token punctuation">&#123;</span>
            <span class="token directive"><span class="token keyword">alias</span> /etc/nginx/static/</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">limit_except</span> GET</span> <span class="token punctuation">&#123;</span>
                <span class="token directive"><span class="token keyword">deny</span> all</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment"># Optimization</span>
    <span class="token directive"><span class="token keyword">server_tokens</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">keepalive_timeout</span> <span class="token number">65s</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">100m</span></span><span class="token punctuation">;</span>

    <span class="token comment"># TCP 옵션</span>
    <span class="token directive"><span class="token keyword">sendfile</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">tcp_nopush</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">tcp_nodelay</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>

    <span class="token comment"># Gzip 압축 옵션</span>
    <span class="token directive"><span class="token keyword">gzip</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_min_length</span> <span class="token number">10k</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_comp_level</span> <span class="token number">9</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_vary</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_disable</span> msie6</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_proxied</span> expired no-cache no-store private auth</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_types</span>
        <span class="token comment"># text/html is always compressed</span>
        text/css
        text/javascript
        text/xml
        text/plain
        application/javascript
        application/json
        application/xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml</span><span class="token punctuation">;</span>

    <span class="token comment"># 파일 리스트 비활성화</span>
    <span class="token directive"><span class="token keyword">autoindex</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">include</span> /etc/nginx/conf.d/*.conf</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>도커 컴포즈를 사용하여 실행되어있는 Nginx 프로세스에 변경된 설정을 반영하면서 마치도록 하겠습니다.</p>
<pre class="language-ps" data-language="ps"><code class="language-ps">docker compose exec nginx nginx -t
nginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok
nginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful

docker compose exec nginx nginx -s reload
2021&#x2F;09&#x2F;25 09:38:03 [notice] 34#34: signal process started</code></pre>

<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>벨리데이션 오류 메시지가 사용자 언어로 처리되지 않은 이유</title>
    <url>/spring-validation/</url>
    <content><![CDATA[<blockquote>
<p>스프링 부트 애플리케이션에서 벨리데이션 오류 메시지가 사용자가 언어로 처리되지 않는 사유를 경험하여 이와 같은 문제가 발생한 이유에 대해서 알아보고 스프링에서 제공하는 벨리데이션에 대해서 정리한 글입니다.<br>관련 코드는 <a href="https://github.com/kdevkr/spring-demo-validation">spring-demo-validation</a>에서 확인할 수 있습니다.</p>
</blockquote>
<h2 id="자카르타-벨리데이션"><a href="#자카르타-벨리데이션" class="headerlink" title="자카르타 벨리데이션"></a>자카르타 벨리데이션</h2><p>스프링 부트 애플리케이션에서는 벨리데이션 스타터를 통해 <a href="https://beanvalidation.org/2.0/">자카르타 벨리데이션</a> 기반의 <a href="https://hibernate.org/validator/">하이버네이트 벨리데이터</a>를 사용하여 벨리데이션을 수행할 수 있는 기능을 제공합니다. 이 스타터가 포함되면 <strong>ValidationAutoConfiguration</strong>이라는 자동 구성 클래스를 통해 기본적인 벨리데이터(Validator)를 사용할 수 있도록 빈으로 등록해줍니다.</p>
<pre class="language-groovy" data-language="groovy"><code class="language-groovy">dependencies <span class="token punctuation">&#123;</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-validation'</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>그래서 스프링 부트 개발자들은 별도의 설정없이 컨트롤러 핸들러 함수에 전달되는 사용자 요청 정보를 간단하게 검증할 수 있게 됩니다. 또한, 하이버네이트 벨리데이터 라이브러리에는 벨리데이션을 위한 어노테이션에 대한 기본적인 <strong>벨리데이션 메시지 소스 번들</strong> 을 포함하고 있어 한국어나 영어와 같이 주요 국가에서 사용하는 언어에 대해서는 메시지를 처리하여 번역된 메시지를 사용자에게 제공할 수 있습니다.</p>
<p><img data-src="/images/posts/spring-validation/hibernate-validator-01.png" alt="org.hibernate.validator.ValidationMessages"></p>
<h3 id="유효성-검사"><a href="#유효성-검사" class="headerlink" title="유효성 검사"></a>유효성 검사</h3><p><a href="https://meetup.toast.com/posts/223">Validation 어디까지 해봤니?</a>에서 알 수 있듯이 자카르타 벨리데이션의 팩토리 함수를 통해 간단하게 벨리데이터를 생성하고 자바 빈 클래스에 저장된 정보가 올바른지 필드 검증을 쉽게 수행할 수 있습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginService</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token class-name">Account<span class="token punctuation">.</span>Login</span> login<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Validator</span> validator <span class="token operator">=</span> <span class="token class-name">Validation</span><span class="token punctuation">.</span><span class="token function">buildDefaultValidatorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConstraintViolation</span><span class="token punctuation">&lt;</span><span class="token class-name">Account<span class="token punctuation">.</span>Login</span><span class="token punctuation">></span><span class="token punctuation">></span></span> constraintViolations <span class="token operator">=</span> validator<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> constraintViolations<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="로케일-이슈"><a href="#로케일-이슈" class="headerlink" title="로케일 이슈"></a>로케일 이슈</h3><p>자카르타 벨리데이션의 팩토리 함수로 만들어지는 벨리데이터는 기본값으로 정의된 설정을 통해서 벨리데이션을 수행하기 때문에 <code>사용자의 언어 정보에 따라 벨리데이션에 대한 오류 메시지가 번역되지 않는 문제</code>가 있습니다. 이러한 문제는 고객의 요구사항에 의해서 CSV 또는 엑셀 파일을 업로드하여 웹 서비스를 이용할 때 필수로 등록되어야하는 과정을 벌크 형식으로 지원해야했고 구현 과정에서 애플리케이션 컨텍스트에 등록된 벨리데이터가 아닌 팩토리 함수로 만들어지는 벨리데이터를 사용해서 벨리데이션을 수행하면서 발견되었습니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">LoginController : [ConstraintViolationImpl&#123;interpolatedMessage&#x3D;&#39;공백일 수 없습니다&#39;, propertyPath&#x3D;loginId, rootBeanClass&#x3D;class com.example.springboot.bean.Account$Login, messageTemplate&#x3D;&#39;&#123;javax.validation.constraints.NotBlank.message&#125;&#39;&#125;]
LoginController : locale: en_US</code></pre>

<blockquote>
<p>위와 같이 로그인 요청 정보에 대한 벨리데이션을 수행하였고 로그인 요청을 한 사용자의 언어 정보와 함께 벨리데이션 오류에 대한 메시지를 출력해보면 사용자의 언어가 아니라 시스템 로케일 정보인 한국어로 메시지가 번역되어 처리되었음을 확인할 수 있습니다.</p>
</blockquote>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">MessageInterpolator</span> messageInterpolator <span class="token operator">=</span> <span class="token class-name">Validation</span><span class="token punctuation">.</span><span class="token function">byDefaultProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultMessageInterpolator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>messageInterpolator <span class="token keyword">instanceof</span> <span class="token class-name">ResourceBundleMessageInterpolator</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"defaultMessageInterpolator is ResourceBundleMessageInterpolator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token class-name">Validator</span> validator <span class="token operator">=</span> <span class="token class-name">Validation</span><span class="token punctuation">.</span><span class="token function">byDefaultProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">messageInterpolator</span><span class="token punctuation">(</span>messageInterpolator<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">buildValidatorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConstraintViolation</span><span class="token punctuation">&lt;</span><span class="token class-name">Account<span class="token punctuation">.</span>Login</span><span class="token punctuation">></span><span class="token punctuation">></span></span> constraintViolations <span class="token operator">=</span> validator<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>loginInfo<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>기본 메시지 인터폴레이터를 가져와서 ResourceBundleMessageInterpolator 클래스의 인스턴스인지를 비교해보면 위 로그가 출력되는 것을 확인할 수 있습니다. 그리고 동일하게 사용자 언어가 아닌 시스템 로케일을 기반으로 메시지가 처리됨을 보여줍니다.</p>
<pre class="language-none"><code class="language-none">LoginController : defaultMessageInterpolator is ResourceBundleMessageInterpolator
LoginController : [ConstraintViolationImpl&#123;interpolatedMessage&#x3D;&#39;공백일 수 없습니다&#39;, propertyPath&#x3D;loginId, rootBeanClass&#x3D;class com.example.springboot.bean.Account$Login, messageTemplate&#x3D;&#39;&#123;javax.validation.constraints.NotBlank.message&#125;&#39;&#125;]
LoginController : locale: en_US</code></pre>

<h2 id="사용자-언어-기반의-메시지-처리"><a href="#사용자-언어-기반의-메시지-처리" class="headerlink" title="사용자 언어 기반의 메시지 처리"></a>사용자 언어 기반의 메시지 처리</h2><p>기본 벨리데이터는 시스템 로케일을 기반으로 메시지가 처리됨을 확인하였으니 사용자의 언어 정보를 기반으로 메시지를 처리하기 위해서는 어떻게 하여야하는지 알아보도록 하겠습니다. <a href="https://docs.jboss.org/hibernate/validator/3.0/api/org/hibernate/validator/MessageInterpolator.html">MessageInterpolator</a> 인터페이스를 사용하여 메시지를 처리하도록 되어있기 때문에 사용자의 언어 정보를 사용하는 MessageInterpolator를 적용해야합니다.</p>
<p>스프링에서 사용자의 요청에 의한 스레드 내에서는 LocaleContextHolder 클래스를 통해 사용자의 로케일 정보를 쉽게 가져올 수 있도록 제공합니다. 그리고 이 클래스를 사용해서 로케일 정보를 가져와서 메시지를 처리하는 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/validation/beanvalidation/LocaleContextMessageInterpolator.html"><strong>LocaleContextMessageInterpolator</strong></a>를 제공하고 있습니다.</p>
<p>기본 메시지 인터폴레이터인 ResourceBundleMessageInterpolator를 LocaleContextMessageInterpolator의 생성자로 전달하여 MessageInterpolator를 대체하여 적용해보도록 하겠습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">MessageInterpolator</span> messageInterpolator <span class="token operator">=</span> <span class="token class-name">Validation</span><span class="token punctuation">.</span><span class="token function">byDefaultProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultMessageInterpolator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>messageInterpolator <span class="token keyword">instanceof</span> <span class="token class-name">ResourceBundleMessageInterpolator</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"defaultMessageInterpolator is ResourceBundleMessageInterpolator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

messageInterpolator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocaleContextMessageInterpolator</span><span class="token punctuation">(</span>messageInterpolator<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Validator</span> validator <span class="token operator">=</span> <span class="token class-name">Validation</span><span class="token punctuation">.</span><span class="token function">byDefaultProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">messageInterpolator</span><span class="token punctuation">(</span>messageInterpolator<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">buildValidatorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">getValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConstraintViolation</span><span class="token punctuation">&lt;</span><span class="token class-name">Account<span class="token punctuation">.</span>Login</span><span class="token punctuation">></span><span class="token punctuation">></span></span> constraintViolations <span class="token operator">=</span> validator<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>loginInfo<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>그리고 다시 사용자의 로그인 요청을 수행해보고 어떻게 벨리데이션 오류 메시지가 번역되는지 확인해보죠.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">LoginController : [ConstraintViolationImpl&#123;interpolatedMessage&#x3D;&#39;must not be blank&#39;, propertyPath&#x3D;loginId, rootBeanClass&#x3D;class com.example.springboot.bean.Account$Login, messageTemplate&#x3D;&#39;&#123;javax.validation.constraints.NotBlank.message&#125;&#39;&#125;]
LoginController : locale: en_US</code></pre>

<blockquote>
<p>앞선 과정을 통해서 벨리데이션에 대한 메시지 처리는 MessageInterpolator를 사용하므로 LocaleContextMessageInterpolator를 적용하면 스프링에서 관리하는 로케일 정보를 사용해서 메시지를 처리할 수 있음을 이해했습니다.</p>
</blockquote>
<h3 id="LocalValidatorFactoryBean"><a href="#LocalValidatorFactoryBean" class="headerlink" title="LocalValidatorFactoryBean"></a>LocalValidatorFactoryBean</h3><p><a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/validation/beanvalidation/LocalValidatorFactoryBean.html">LocalValidatorFactoryBean</a>는 벨리데이션 스타터에 의해서 자동으로 등록되는 벨리데이터입니다. 컨트롤러의 핸들러 함수로 전달되는 과정에서 이 벨리데이터를 통해서 사용자의 요청 정보를 검증하며 벨리데이션 오류 메시지를 제공하게 됩니다.</p>
<p>현재 조직에서는 오래전에 공유한 <a href="managing-i18n-messages-with-xml">XML로 다국어 메시지 관리하기</a>에서처럼 XML 파일을 기반으로 다국어 메시지 정보를 관리하고 있으며 이 메시지 소스를 사용하도록 자동 구성이 아닌 LocalValidatorFactoryBean를 직접 벨리데이터 빈으로 등록하여 사용하고 있습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">MessageSource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>validation<span class="token punctuation">.</span>beanvalidation<span class="token punctuation">.</span></span><span class="token class-name">LocalValidatorFactoryBean</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageConfig</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">LocalValidatorFactoryBean</span> <span class="token function">validator</span><span class="token punctuation">(</span><span class="token class-name">CustomMessageSource</span> customMessageSource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">LocalValidatorFactoryBean</span> factoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalValidatorFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setValidationMessageSource</span><span class="token punctuation">(</span>customMessageSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>위와 같이 LocalValidatorFactoryBean를 등록할 때 벨리데이션 메시지 소스를 지정하는 것은 하이버네이트 벨리데이터에 의해 클래스패스에 포함된 ValidationMessages를 사용하지 못한다는 내재된 결함을 가지게 됩니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">LoginController : [ConstraintViolationImpl&#123;interpolatedMessage&#x3D;&#39;javax.validation.constraints.NotBlank.message&#39;, propertyPath&#x3D;loginId, rootBeanClass&#x3D;class com.example.springboot.bean.Account$Login, messageTemplate&#x3D;&#39;&#123;javax.validation.constraints.NotBlank.message&#125;&#39;&#125;]
LoginController : locale: en_US</code></pre>

<blockquote>
<p>기본으로 사용되는 ValidationMessages 대신에 벨리데이션 메시지 소스를 지정하였기에 해당 메시지로 처리되지 않았습니다. 왜냐하면 JSR-303 어노테이션에 대한 메시지는 직접 정의하지 않았기 때문이죠.</p>
</blockquote>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">LocalValidatorFactoryBean</span> <span class="token function">validator</span><span class="token punctuation">(</span><span class="token class-name">CustomMessageSource</span> messageSource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">LocalValidatorFactoryBean</span> factoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalValidatorFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    factoryBean<span class="token punctuation">.</span><span class="token function">setValidationMessageSource</span><span class="token punctuation">(</span>messageSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">MessageInterpolator</span> defaultMessageInterpolator <span class="token operator">=</span> <span class="token class-name">Validation</span><span class="token punctuation">.</span><span class="token function">byDefaultProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultMessageInterpolator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LocaleContextMessageInterpolator</span> localeContextMessageInterpolator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocaleContextMessageInterpolator</span><span class="token punctuation">(</span>defaultMessageInterpolator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    factoryBean<span class="token punctuation">.</span><span class="token function">setMessageInterpolator</span><span class="token punctuation">(</span>localeContextMessageInterpolator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>현재 조직처럼 사용자 정의 메시지 소스를 벨리데이션 메시지 소스로도 사용하도록 지정하였다면 위와 같이 MessageInterpolator를 지정하는게 좋습니다. 이때에도 사용자의 언어 정보에 따라 메시지가 처리되도록 LocaleContextMessageInterpolator를 적용해야합니다.</p>
<h4 id="MessageInterpolatorFactory"><a href="#MessageInterpolatorFactory" class="headerlink" title="MessageInterpolatorFactory"></a>MessageInterpolatorFactory</h4><p>LocalValidatorFactoryBean을 자동 구성하는 ValidationAutoConfiguration 클래스를 살펴보면 LocaleContextMessageInterpolator이 아니라 스프링 부트에서 추가된 MessageInterpolatorFactory를 통해 MessageInterpolator를 가져와서 등록하는 것을 확인할 수 있습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ValidationAutoConfiguration</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">LocalValidatorFactoryBean</span> <span class="token function">defaultValidator</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">LocalValidatorFactoryBean</span> factoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalValidatorFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MessageInterpolatorFactory</span> interpolatorFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageInterpolatorFactory</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setMessageInterpolator</span><span class="token punctuation">(</span>interpolatorFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>이를 참고하여 사용자 정의 메시지 소스 번들을 벨리데이션 메시지 소스로 지정하였더라도 MessageInterpolatorFactory를 통해 ResourceBundleMessageInterpolator에 의해서 메시지가 번역되어 처리됨을 확인할 수 있습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">LocalValidatorFactoryBean</span> <span class="token function">validator</span><span class="token punctuation">(</span><span class="token class-name">CustomMessageSource</span> messageSource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">LocalValidatorFactoryBean</span> factoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalValidatorFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    factoryBean<span class="token punctuation">.</span><span class="token function">setValidationMessageSource</span><span class="token punctuation">(</span>messageSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">MessageInterpolatorFactory</span> messageInterpolatorFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageInterpolatorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    factoryBean<span class="token punctuation">.</span><span class="token function">setMessageInterpolator</span><span class="token punctuation">(</span>messageInterpolatorFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>그런데 앞선 자카르타 팩토리 함수에 의해 생성된 벨리데이터도 ResourceBundleMessageInterpolator를 사용하였는데 어떻게 LocalValidatorFactoryBean는 사용자 언어 정보에 따라 오류 메시지를 처리해주게 되는 것일까요?</p>
</blockquote>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">MessageInterpolator</span> targetInterpolator <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageInterpolator<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>targetInterpolator <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    targetInterpolator <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getDefaultMessageInterpolator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
configuration<span class="token punctuation">.</span><span class="token function">messageInterpolator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LocaleContextMessageInterpolator</span><span class="token punctuation">(</span>targetInterpolator<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>위 코드는 LocalValidatorFactoryBean이 빈으로 등록되고 난 후 afterPropertiesSet 함수에 의해 수행되는 코드 중 일부입니다. LocalValidatorFactoryBean을 빈으로 등록할 때 MessageInterpolatorFactory에 의해 가져온 ResourceBundleMessageInterpolator를 지정하였지만 이를 다시 LocaleContextMessageInterpolator로 변환하여 등록함을 확인할 수 있습니다. </p>
<p>결국 LocalValidatorFactoryBean을 빈으로 등록할 때는 다음과 같이 LocaleContextMessageInterpolator를 전달하지 않아도 됨을 의미합니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">LocalValidatorFactoryBean</span> <span class="token function">validator</span><span class="token punctuation">(</span><span class="token class-name">CustomMessageSource</span> messageSource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">LocalValidatorFactoryBean</span> factoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalValidatorFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    factoryBean<span class="token punctuation">.</span><span class="token function">setValidationMessageSource</span><span class="token punctuation">(</span>messageSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    factoryBean<span class="token punctuation">.</span><span class="token function">setMessageInterpolator</span><span class="token punctuation">(</span><span class="token class-name">Validation</span><span class="token punctuation">.</span><span class="token function">byDefaultProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultMessageInterpolator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="사용자-정의-메시지"><a href="#사용자-정의-메시지" class="headerlink" title="사용자 정의 메시지"></a>사용자 정의 메시지</h3><p>그렇다면 다음과 같이 ValidationMessages에 정의된 메시지 코드를 정의하면 어떻게 메시지가 처리될까요?</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>messages</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>javax.validation.constraints.NotBlank.message<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ko_KR</span><span class="token punctuation">></span></span><span class="token cdata">&lt;![CDATA[[사용자 정의] 공백일 수 없습니다]]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ko_KR</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>en_US</span><span class="token punctuation">></span></span><span class="token cdata">&lt;![CDATA[[Custom] must not be blank]]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>en_US</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>messages</span><span class="token punctuation">></span></span></code></pre>

<p>NotBlank에 대한 메시지를 정의했지만 ValidationMessages에 정의된 메시지로 처리됨을 확인할 수 있을겁니다. 이렇게 되는 이유는 setValidationMessageSource 함수 동작에 있습니다. setValidationMessageSource 함수의 코드를 살펴보면 파라미터로 전달된 메시지 소스를 기반으로 ResourceBundleMessageInterpolator를 만들어서 MessageInterpolator를 변경하도록 되어있기 때문입니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValidationMessageSource</span><span class="token punctuation">(</span><span class="token class-name">MessageSource</span> messageSource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>messageInterpolator <span class="token operator">=</span> <span class="token class-name">HibernateValidatorDelegate</span><span class="token punctuation">.</span><span class="token function">buildMessageInterpolator</span><span class="token punctuation">(</span>messageSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">HibernateValidatorDelegate</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">MessageInterpolator</span> <span class="token function">buildMessageInterpolator</span><span class="token punctuation">(</span><span class="token class-name">MessageSource</span> messageSource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResourceBundleMessageInterpolator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageSourceResourceBundleLocator</span><span class="token punctuation">(</span>messageSource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>결국 setValidationMessageSource와 setMessageInterpolator는 동시에 적용할 수 없으므로 사용자 정의 메시지 소스를 지정한 것이 의미없는 쓰레기 코드가 됩니다.</p>
</blockquote>
<p>스프링 부트 2.6.0 버전부터는 MessageInterpolatorFactory 생성자가 메시지 소스를 받을 수 있도록 수정되었고 생성자에 의해 전달된 메시지 소스가 있다면 MessageSourceMessageInterpolator로 변경하여주는 코드가 추가되어있습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">MessageInterpolator</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">MessageInterpolator</span> messageInterpolator <span class="token operator">=</span> <span class="token function">getMessageInterpolator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageSource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MessageSourceMessageInterpolator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageSource<span class="token punctuation">,</span> messageInterpolator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> messageInterpolator<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="사용자-정의-제약사항"><a href="#사용자-정의-제약사항" class="headerlink" title="사용자 정의 제약사항"></a>사용자 정의 제약사항</h3><p>사용자 정의 메시지 소스를 제공하더라도 메시지 패턴에서 {value}와 같은 파라미터 표현이 불가능합니다. 예를 들어, 다음과 같이 어떤 값에 대한 길이를 제한한다고 가정하여 @Min 어노테이션을 부여했다고 가정하겠습니다.</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>messages</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>javax.validation.constraints.Min.message<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ko_KR</span><span class="token punctuation">></span></span><span class="token cdata">&lt;![CDATA[(사용자 정의) &#123;value&#125; 보다 같거나 커야합니다]]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ko_KR</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>en_US</span><span class="token punctuation">></span></span><span class="token cdata">&lt;![CDATA[(Custom) must be greater than or equal to &#123;value&#125;]]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>en_US</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>messages</span><span class="token punctuation">></span></span></code></pre>

<p>사용자 정의 메시지에서 VailidationMessages에 정의된 것처럼 파라미터 표현을 사용해보겠습니다.</p>
<pre class="language-none"><code class="language-none">org.springframework.web.util.NestedServletException: Request processing failed; nested exception is javax.validation.ValidationException: HV000149: An exception occurred during message interpolation
...
Caused by: java.lang.IllegalArgumentException: can&#39;t parse argument number: value
	at java.base&#x2F;java.text.MessageFormat.makeFormat(MessageFormat.java:1451) ~[na:na]
	at java.base&#x2F;java.text.MessageFormat.applyPattern(MessageFormat.java:491) ~[na:na]
	at java.base&#x2F;java.text.MessageFormat.&lt;init&gt;(MessageFormat.java:390) ~[na:na]
...
Caused by: java.lang.NumberFormatException: For input string: &quot;value&quot;
	at java.base&#x2F;java.lang.NumberFormatException.forInputString(NumberFormatException.java:65) ~[na:na]
	at java.base&#x2F;java.lang.Integer.parseInt(Integer.java:652) ~[na:na]
	at java.base&#x2F;java.lang.Integer.parseInt(Integer.java:770) ~[na:na]
	at java.base&#x2F;java.text.MessageFormat.makeFormat(MessageFormat.java:1449) ~[na:na]</code></pre>

<blockquote>
<p>이러한 파라미터 표현은 Hibernate Validator에서 지원하는 표현식이므로 MessageFormat가 지원하는 표현식과는 다릅니다. MessageFormat는 {0}, {1} 이렇게 숫자 기반의 표현식을 지원하기 때문에 표현식 제약이 발생합니다. 아쉽지만 사용자 정의 메시지에서 파라미터 표현식을 사용하지 않을 수 밖에 없고 파라미터 표현식을 사용해야한다면 ValidationMessages 리소스 번들을 클래스패스에 재정의해서 사용할 수 밖에 없습니다. </p>
</blockquote>
<p>언어별 메시지가 정의된 프로퍼티 파일을 보완하고자 XML로 메시지를 정의하여 메시지 소스를 만들어서 사용했지만 의도하지 않은 제약이 생겨버렸습니다. 불편하더라도 벨리데이션 메시지는 프로퍼티 파일로 관리해서 ResourceBundleMessageInterpolator에 의해 처리되도록 해야할 것 같습니다.</p>
<p>감사합니다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="/managing-i18n-messages-with-xml">XML로 다국어 메시지 관리하기</a></li>
<li><a href="https://meetup.toast.com/posts/223">Validation 어디까지 해봤니?</a></li>
</ul>
]]></content>
      <tags>
        <tag>Jakarta Bean Validation</tag>
        <tag>Hibernate Validator</tag>
      </tags>
  </entry>
  <entry>
    <title>SSL 인증서</title>
    <url>/ssl-certificate/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>오늘은 웹사이트 접속 시 필수적으로 사용되는 HTTPS 그리고 SSL 인증서에 대해 이야기하려합니다. 회사에서 운영중인 웹 서비스를 HTTPS로 배포되고있으나 정작 SSL에 대한 부분은 머리속에서 복잡하게 얽혀 제대로 정리되지않은 상태입니다. 이 글을 작성하면서 얽혀있는 부분을 하나씩 풀어나가면서 SSL에 대한 개념을 확립해보고자 합니다.</p>
<h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2><p>일반 사람들이 브라우저를 이용해서 웹 사이트에 접속할 때 HTTPS가 적용되었는지에 대해서 신경쓰지 않습니다. 하지만, 애플리케이션 서버를 운영하는 사람들에게 HTTPS는 사용자의 민감한 정보를 암호화해서 위조 또는 변조되는 것을 방지할 수 있는 아주 중요한 표준 보안 기술입니다. </p>
<p>크롬과 같은 브라우저에서는 HTTPS와 같은 보안 프로토콜이 적용되었는지를 확인하고 사용자들에게 신뢰할 수 있는 사이트인지를 안내합니다. 브라우저 주소창 옆에 느낌표나 자물쇠 아이콘을 보신적 있으신가요? 여러분의 웹 사이트가 자물쇠 아이콘을 가진다면 보안 프로토콜을 사용하고 있으며 신뢰할 수 있는 사이트라고 할 수 있습니다.</p>
<p>HTTPS는 HTTP라는 전송 프로토콜과 함께 데이터를 암복호화하기 위한 보안 프로토콜을 같이 사용해야하기 때문에 추가적인 오버헤드가 발생하는 부분에 대해서는 감안해야합니다. 하지만, 최근 컴퓨터들의 CPU 성능이 좋아짐에 따라서 암복호화 걸리는 시간은 상당히 미미하며 네트워크 기술의 발전으로 레이턴시도 줄어들었기 때문에 HTTPS을 사용한다고해서 사용자가 요청하고 응답하기까지의 시간이 큰 차이를 보이지는 않습니다.</p>
<h3 id="TLS-핸드쉐이크"><a href="#TLS-핸드쉐이크" class="headerlink" title="TLS 핸드쉐이크"></a>TLS 핸드쉐이크</h3><p>HTTPS가 적용된 애플리케이션 서버와 통신하기 위해서는 클라이언트인 브라우저가 애플리케이션 서버와 TLS 핸드쉐이크 과정을 수행해야합니다.</p>
<p><img data-src="https://images.ctfassets.net/slt3lc6tev37/5aYOr5erfyNBq20X5djTco/3c859532c91f25d961b2884bf521c1eb/tls-ssl-handshake.png" alt="Cloudflare - What is a TLS handshake?"></p>
<p><strong>TLS 핸드쉐이크</strong>는 웹 요청에 대한 신뢰성 여부를 확인하거나 통신 데이터를 암복호화하기 위한 방식을 서로 교환하기 위해 수행하는 과정입니다. 위 클라우드플레어에서 설명하는 TLS 핸드쉐이크 과정을 살펴보면 애플리케이션 서버가 클라이언트에게 인증서(Certificate)를 제공하고 서로 암호화 방식(CipherSpec)을 교환하는 것을 확인할 수 있습니다.</p>
<p>크롬 브라우저의 개발자 도구 중 보안 탭에서 TLS 핸드쉐이크 과정에 의해 결정된 여러가지 사항들을 확인할 수 있습니다.</p>
<p><img data-src="/images/posts/ssl-certificate/ssl-certificate-01.png" alt="네이버 웹 사이트"></p>
<p><img data-src="/images/posts/ssl-certificate/ssl-certificate-02.png" alt="회사 웹 사이트"></p>
<p>네이버 웹 사이트는 <strong>DigiCert</strong>라는 인증기관에서 발행한 SSL 인증서를 제공하였고 <strong>TLS 1.3</strong> 버전과 함께 <strong><a href="https://en.wikipedia.org/wiki/Curve25519">X25519</a></strong> 방식으로 키를 교환하고 <strong>AES_256_GCM</strong>으로 암호화하며 회사에서 운영중인 웹 서비스는 네이버와 다르게 <strong>TLS 1.2</strong>, <strong>ECDHE_ECDSA</strong>, <strong>AES_128_GCM</strong>을 사용합니다. 여러분들도 HTTPS를 적용한 웹 사이트를 운영중이거나 궁금한 사이트가 있다면 어떤 사항으로 결정되었는지 확인해보시기 바랍니다. TLS 핸드쉐이크 과정에 의해 결정되는 사항들은 애플리케이션 서버가 지원하는 사항들과 클라이언트에 따라 다를 수 있습니다. 이제 우리는 이러한 사항들에 대해서 하나씩 알아보도록 하죠.</p>
<h3 id="TLS-버전"><a href="#TLS-버전" class="headerlink" title="TLS 버전"></a>TLS 버전</h3><p>TLS 버전은 TLS 핸드쉐이크 과정을 수행하는 방식을 말합니다. 당연스럽게도 버전이 높은 TLS 1.3이 TLS 1.2보다 효율적인 방식이라고 할 수 있습니다. 클라이언트는 애플리케이션 서버에서 지원하는 TLS 버전 중 가장 높은 버전으로 TLS 핸드쉐이크를 수행할 수 있습니다. 만약, 클라이언트가 TLS 1.1까지만 사용할 수 있는데 애플리케이션 서버가 TLS 1.2 이상을 요구한다면 일치하는 TLS 버전이 없기 때문에 애플리케이션 서버는 TLS 1.1을 사용하고자하는 클라이언트 요청을 거부하게 됩니다.</p>
<p>크롬 브라우저는 이미 <a href="https://www.chromestatus.com/feature/5759116003770368">TLS 1.0과 TLS 1.1 버전을 사용하지 않기 때문에</a> 여러분의 애플리케이션 서버는 최소한 TLS 1.2 버전을 사용할 수 있도록 지원해야합니다. </p>
<p><img data-src="/images/posts/ssl-certificate/ssl-certificate-12.png"></p>
<p>위는 회사에서 운영중인 애플리케이션 서버의 로그를 살펴본 경우로 <strong>SSLv3, TLSv1.0, TLS v1.1</strong>등의 TLS 버전을 사용하려는 클라이언트 요청이 거부된 것이 오류 로그로 출력된 상황을 보여줍니다. 이 애플리케이션 서버는 AWS Beanstalk와 함께 NLB(Network Load Balancer)를 사용하며 NLB는 TCP 트래픽에 대하여 분산된 애플리케이션 서버로 프록시되도록 구성했기때문에 L4 로드밸런서에서 TLS 핸드쉐이크가 처리되지 않았음을 보여주는 것이기도 합니다.</p>
<blockquote>
<p>NLB에서 TLS 핸드쉐이크를 수행하도록 설정할 수도 있으며 IT 인프라 상 TLS 핸드쉐이크를 애플리케이션 서버에서 수행하는 것이 잘못된 구성은 아닙니다.</p>
</blockquote>
<h4 id="HTTP-x2F-3-그리고-QUIC"><a href="#HTTP-x2F-3-그리고-QUIC" class="headerlink" title="HTTP&#x2F;3 그리고 QUIC"></a>HTTP&#x2F;3 그리고 QUIC</h4><p>통신 프로토콜에 대해서 관심이 있는 분들은 QUIC 이라고하는 전송 프로토콜에 대해서 들어보신 적 있으실 겁니다. TCP가 아닌 오버헤드가 적은 UDP를 사용하는 프로토콜로 구글 웹 사이트에 대해 TLS 핸드쉐이크 과정에 의해 결정된 사항을 확인해보면 다음과 같이 TLS가 아닌 QUIC을 사용한 것으로 확인할 수 있습니다.</p>
<p><img data-src="/images/posts/ssl-certificate/ssl-certificate-03.png"></p>
<p>QUIC은 TLS를 기본으로 사용하도록 되어있으며 TLS는 보안 프로토콜이기 때문에 HTTP가 아닌 전송 프로토콜과도 사용할 수 있다는 것을 보여주는 예 입니다. 구글 웹 사이트 뿐만 아니라 여러분이 라이브러리등 정적 컨텐츠를 받아오기 위해 사용하는 CDN 서버를 살펴보면 <strong>h3-29</strong>라고 하는 QUIC의 표준 이름을 확인할 수 있습니다.</p>
<p>아무튼 다시 TLS 버전에 대한 사항을 더 알아보도록 하겠습니다. 국내 개발자 커뮤니티 중 하나인 OKKY 사이트의 애플리케이션 서버에서 지원하는 TLS 버전을 확인해보기 위해 <a href="https://gf.dev/tls-test">Check TLS Version</a>을 수행해본 결과입니다.</p>
<p><img data-src="/images/posts/ssl-certificate/ssl-certificate-04.png"></p>
<p>TLS 1.3을 제외한 나머지 버전을 지원하는 것으로 리포트 되었습니다. 다시 말하지만 크롬 브라우저는 TLS 1.2 이상을 지원하기 때문에 애플리케이션 서버가 TLS 1.3을 지원하지 않더라도 아무런 문제가 없습니다. 사람들이 많이 사용하는 크롬 브라우저에서 TLS 1.2 지원하지않도록 발표하면 애플리케이션 서버에서 TLS 1.3을 지원하도록 변경하는 것은 불가피한 상황이긴 합니다. 물론, 회사에서 운영중인 애플리케이션 서버도 마찬가지인 상황입니다.</p>
<h3 id="암호화-스위트"><a href="#암호화-스위트" class="headerlink" title="암호화 스위트"></a>암호화 스위트</h3><p>암호화 스위트(Cipher Suite)는 <strong>키 교환</strong>, <strong>전자 서명</strong>, <strong>암호화</strong> 그리고 <strong>데이터 무결성</strong>에 대한 알고리즘을 조합한 암호화 방식을 지칭합니다. 앞서 TLS 핸드쉐이크 과정에서 결정된 사항 중 <strong>ECDHE_ECDSA</strong> 그리고 <strong>AES_128_GCM</strong>이 암호화 스위트라고 할 수 있습니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh"># [프로토콜]_[키 교환 알고리즘]_[전자 서명 알고리즘]_WITH_[암호화 알고리즘]_[데이터 무결성]
TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256</code></pre>

<p>암호화 스위트는 위와 같은 구조를 가지도록 조합된 문자열으로 표현하기 때문에 아래와 같이 다시 나열해보겠습니다.</p>
<ul>
<li>TLS : 프로토콜</li>
<li>ECDHE : 타원 곡선 디피 헬만 키 교환</li>
<li>ECDSA : 타원 곡선 디지털 서명</li>
<li>AES_128_GCM : 128 비트 블록 갈루와&#x2F;카운트 모드의 AES 암호화</li>
<li>SHA256 : 256비트 해시 알고리즘</li>
</ul>
<p>보안 전문가가 아니라면 ECDHE-ECDSA가 어떤 원리도 동작하는지까지는 알 필요는 없으며 어떻게 키 교환을 하고 어떤 방식으로 서명하며 어떻게 암호화하는지만 구분할 수 있으면 됩니다. 검색해보시더라도 보안 기술을 이해하기는 쉽지 않으실 겁니다. (우리의 시간은 소중하니까요…)</p>
<p>이러한 암호화 스위트는 <a href="https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/network/create-tls-listener.html">AWS의 ELB(Elastic Load Balancing)의 보안 정책</a>에서도 정책별 지원 여부를 확인할 수 있습니다. </p>
<p><img data-src="/images/posts/ssl-certificate/ssl-certificate-13.png" alt="ELB Security Policy"></p>
<h2 id="SSL-인증서"><a href="#SSL-인증서" class="headerlink" title="SSL 인증서"></a>SSL 인증서</h2><p>TLS 핸드쉐이크 과정에서 클라이언트가 애플리케이션 서버로부터 받는 SSL 인증서는 브라우저 해당 사이트를 신뢰할 수 있는지를 판단할 수 있는 중요한 사항입니다. 브라우저에서는 자체적으로 <strong>신뢰할 수 있는 인증 기관(CA)</strong> 에 대해 관리하거나 운영체제에 등록된 루트 인증 기관에 대한 정보를 활용해서 서버에서 제공하는 SSL 인증서가 신뢰할 수 있는 기관으로부터 발급된 것인지 확인하는 과정을 거치게 됩니다.</p>
<p>일반적으로 서버에서 제공받은 SSL 인증서는 루트 인증 기관(CA)에서 인증하는 <strong>중간 인증 기관(ICA)</strong> 으로부터 발급받은 인증서이며 이를 <strong>체인 인증서</strong>라고 합니다. <a href="https://sectigo.com/">Sectigo</a>와 <a href="https://www.digicert.com/kr/">DigiCert</a> 그리고 <a href="https://www.globalsign.com/en">GlobalSign</a>은 많이 사용되어지는 신뢰할 수 있는 루트 인증 기관입니다. </p>
<p>암호화 스위트 중 ECDSA와 같은 타원 곡선 디지털 서명으로 발급된 인증서를 <strong>ECC 인증서</strong>라고하며 일반적으로 많이 사용해왔던 RSA 기반의 인증서보다 트래픽이 많은 서비스에서 암복호화에 대한 부하를 줄이기 위해 사용하는 인증서입니다.</p>
<p>이 글에서는 타원 곡선형 서명 방식으로 발급하는 ECC 인증서를 만들어볼 예정입니다.</p>
<h3 id="자체-서명-인증서"><a href="#자체-서명-인증서" class="headerlink" title="자체 서명 인증서"></a>자체 서명 인증서</h3><p>자체 서명 인증서는 신뢰할 수 있는 인증 기관으로부터 발급받지 않고 직접 만드는 인증서를 말합니다. 애플리케이션 개발 단계에서 자체 서명 인증서를 발급하여 사용하는 것은 도메인을 구입하고 인증 기관으로부터 인증서를 받기까지의 과정을 당장 수행하지 않아도 되는 좋은 방법입니다.</p>
<p>보유중인 도메인이 있다면 <a href="https://letsencrypt.org/">Let’s Encrypt</a>을 통해 무료로 SSL 인증서를 발급받을수도 있습니다. 저는 보유중인 도메인이 없기 때문에 OpenSSL 또는 자바의 Keystore 도구를 사용해서 자체 서명 인증서를 만들어볼 예정입니다.</p>
<p>이 글에서는 인증 기관에서 애플리케이션 서버에 대한 인증서를 발급할 때 서명해주는 것과 동일하게 자체 서명 CA 인증서를 만들고 이것으로 서명된 서버 인증서를 발급하는 과정을 보여줍니다. 이 과정을 통해 여러분은 발급받은 SSL 서버 인증서가 어떤 과정을 거쳐 발급되었는지를 이해할 수 있습니다.</p>
<h4 id="자체-서명-CA-인증서-발급"><a href="#자체-서명-CA-인증서-발급" class="headerlink" title="자체 서명 CA 인증서 발급"></a>자체 서명 CA 인증서 발급</h4><p>먼저, 로컬 호스트에서는 신뢰할 수 있다고 보장하는 CA 인증서를 발급합니다. 인증서는 <a href="(https://www.sslcert.co.kr/guides/kb/54)">다양한 형식</a>으로 만들어질 수 있으나 OpenSSL 도구를 사용하여 인증서를 만들면 PEM 형식을 가지게 됩니다. 만약, 여러분이 인증 기관으로부터 발급받는 인증서 형식이 다르더라도 다른 형식의 인증서로 변환할 수 있으니 걱정하지 않으셔도 됩니다. 예를 들어, 발급된 PEM 형식의 서버 인증서를 스프링 애플리케이션에서 사용하기 위해 KeyStore 형식의 인증서로 변환해야하는 경우를 말합니다.</p>
<p>OpenSSL으로 자체 서명 CA 인증서를 만들기 위해서는 개인키와 인증서 서명 요청(CSR)을 먼저 생성해야합니다. 앞서 언급했던 것 처럼 일반적으로 발급하는 RSA 기반의 개인키가 아닌 ECC 인증서를 발급하기 위한 <strong>ECDSA 기반의 개인키</strong>를 만들겠습니다.</p>
<pre class="language-ps" data-language="ps"><div class="caption"><span>Windows Terminal</span></div><code class="language-ps"># ECDSA 기반의 개인키 생성
PS openssl ecparam -out ca.key -name prime256v1 -genkey

# 인증서 서명 요청(CSR) 생성
PS openssl req -new -sha256 -subj &#x2F;C&#x3D;KO&#x2F;ST&#x3D;None&#x2F;L&#x3D;None&#x2F;O&#x3D;None&#x2F;CN&#x3D;CA -key ca.key -out ca.csr</code></pre>

<p>위 명령어 예시에서 개인키를 만들때 사용된 <strong>prime256v1</strong>은 타원 곡선형 서명 방식을 지칭하는 이름입니다. 명령어를 수행하고나서 개인키와 인증서 서명 요청 파일이 만들어졌으면 다음의 명령어를 수행해서 자체 서명 CA 인증서를 발급합니다.</p>
<pre class="language-ps" data-language="ps"><div class="caption"><span>Windows Terminal</span></div><code class="language-ps">PS openssl x509 -req -sha256 -days 1095 -in ca.csr -signkey ca.key -out ca.crt
Signature ok
subject&#x3D;C &#x3D; KO, ST &#x3D; None, L &#x3D; None, O &#x3D; None, CN &#x3D; CA
Getting Private key</code></pre>

<p>-days 옵션으로 인해 만들어진 자체 서명 CA 인증서는 3년(1095일)까지 유효하게 됩니다. 일반적으로 인증 기관의 인증서는 서버 인증서보다 긴 만료일자를 가지게 됩니다. 서버 인증서 뿐만 아니라 루트 인증 기관의 CA 인증서가 언제 만료되는지를 확인하는 것도 중요합니다.</p>
<h4 id="자체-서명-서버-인증서-발급"><a href="#자체-서명-서버-인증서-발급" class="headerlink" title="자체 서명 서버 인증서 발급"></a>자체 서명 서버 인증서 발급</h4><p>자체 서명한 CA 인증서가 준비되었으니 CA 인증서로 서명한 서버 인증서를 발급합니다. CA 인증서를 만들때와 동일하게 개인키와 인증서 서명 요청 파일을 생성합니다.</p>
<pre class="language-ps" data-language="ps"><div class="caption"><span>Windows Terminal</span></div><code class="language-ps">PS openssl ecparam -out server.key -name prime256v1 -genkey
PS openssl req -new -sha256 -subj &#x2F;C&#x3D;KO&#x2F;ST&#x3D;None&#x2F;L&#x3D;None&#x2F;O&#x3D;None&#x2F;CN&#x3D;localhost -key server.key -out server.csr</code></pre>

<p>자체 서명 서버 인증서를 만들때는 CA 옵션을 사용해서 서버 인증서가 CA 인증서에 의해 서명되도록 해야합니다. </p>
<p>서버 인증서를 만들기에 앞서 주체 이름인 localhost 대신에 사용할 수 있는 식별 이름인 SAN(Subject Alternative Name)을 적용하기 위한 파일을 만듭니다. SAN을 적용해보는 이유는 하나의 인증서로 여러 도메인을 식별할 수 있음을 확인하기 위함입니다.</p>
<pre class="language-ext" data-language="ext"><div class="caption"><span>san.ext</span></div><code class="language-ext">authorityKeyIdentifier&#x3D;keyid,issuer
subjectAltName &#x3D; @alt_names

[alt_names]
IP.1 &#x3D; 127.0.0.1
DNS.1 &#x3D; localhost
DNS.2 &#x3D; mambo.kr</code></pre>

<p>인증 기관에서 발급하는 SSL 인증서는 유효 기간을 1년으로 설정하므로 398일 동안 유효하도록 만듭니다.</p>
<pre class="language-ps" data-language="ps"><div class="caption"><span>Windows Terminal</span></div><code class="language-ps"># 서버 인증서 발급
PS openssl x509 -req -sha256 -days 398 -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -extfile san.ext

# 서버 인증서 조회
PS openssl x509 -in server.crt -text -noout
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            66<span class="emoji" alias="ab" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f18e.png?v8">&#x1f18e;</span>bb:ed:19:f3:c7:37:9d:d6:5d:29:da:03:7d:b9:4f:53:7c:b7
        Signature Algorithm: ecdsa-with-SHA256
        Issuer: C &#x3D; KO, ST &#x3D; None, L &#x3D; None, O &#x3D; None, CN &#x3D; CA
        Validity
            Not Before: Aug 27 11:27:54 2021 GMT
            Not After : Sep 29 11:27:54 2022 GMT
        Subject: C &#x3D; KO, ST &#x3D; None, L &#x3D; None, O &#x3D; None, CN &#x3D; localhost
        Subject Public Key Info:
            Public Key Algorithm: id-ecPublicKey
                Public-Key: (256 bit)
                pub:
                    04:74:06:a3:39:91:2e:4b:cc:45:40:e8:b0:f8:a3:
                    96:69:91:66:ef:d3:b3:93:8d:e5:09:78:aa:a5:af:
                    67:9d:47:13:78:54:7e:d9:02:ba:e4:ca:aa:d4:9f:
                    8b:f3:be:d7:40:1e:f5:c4:8d:7a:23:5b:09:c3:57:
                    75:38:7e:4d:e6
                ASN1 OID: prime256v1
                NIST CURVE: P-256
        X509v3 extensions:
            X509v3 Authority Key Identifier:
                DirName:&#x2F;C&#x3D;KO&#x2F;ST&#x3D;None&#x2F;L&#x3D;None&#x2F;O&#x3D;None&#x2F;CN&#x3D;CA
                serial:5D:98:7B:BF:10:35:6B:9C:11:97:2C:AC:21:E3:28:C2:FF:AF:2D:3D

            X509v3 Subject Alternative Name:
                IP Address:127.0.0.1, DNS:localhost, DNS:mambo.kr
    Signature Algorithm: ecdsa-with-SHA256
         30:46:02:21:00:ce:5d:3a:68:e9:04:dc:a9:fd:e6:14:de:bb:
         11:5c:5a:a1:bf:b4:f9:1a:61:08:cd:da:47:d1:b4:68:80:81:
         d1:02:21:00:e7:a1:b4:cb:06:6d:ad:80:d3:89:09:c1:1e:ca:
         6e:c7:2e:14:fd:99:d9:df:44:14:cb:47:39:df:ea:5e:e0:1e</code></pre>

<p>인증서 정보를 확인하는 명령어를 실행하여 CA 인증서로 서명되었고 SAN이 설정되어있는 것을 확인했으므로 자체 서명 인증서 발급이 완료되었다고 할 수 있습니다.</p>
<h2 id="서버-인증서"><a href="#서버-인증서" class="headerlink" title="서버 인증서"></a>서버 인증서</h2><p>앞서, 애플리케이션 서버에서 사용할 자체 서명된 SSL 인증서를 발급했습니다. 웹 서비스를 HTTPS로 운영하기 위해서는 SSL 인증서를 <strong>애플리케이션 서버에 직접 등록</strong>하거나 <strong>Nginx와 같은 L7 로드밸런서에 SSL 인증서를 등록</strong>해야합니다. 스프링 부트 애플리케이션을 만들어서 SSL 인증서를 등록해보고 Nginx 서버를 추가로 구성하여 애플리케이션 서버가 아닌 로드밸런서에서 TLS 핸드쉐이킹을 수행함을 검증해봅니다.</p>
<h3 id="JKS-형식의-인증서로-변환"><a href="#JKS-형식의-인증서로-변환" class="headerlink" title="JKS 형식의 인증서로 변환"></a>JKS 형식의 인증서로 변환</h3><p>스프링 부트 애플리케이션에서 HTTPS를 활성화하기 위해서는 KeyStore 형식의 SSL 인증서를 사용해야합니다. 우리는 OpenSSL을 사용해서 PEM 형식의 인증서를 만들었기 때문에 KeyStore 형식의 인증서로 변환해야합니다. PEM 형식의 인증서를 KeyStore 형식으로 변환하기 위해서는 다음의 과정을 거쳐야합니다.</p>
<ol>
<li>PEM 인증서를 PFX 인증서로 변환</li>
<li>PFX 인증서를 JKS 인증서로 변환</li>
</ol>
<h4 id="PEM-인증서를-PFX-인증서로"><a href="#PEM-인증서를-PFX-인증서로" class="headerlink" title="PEM 인증서를 PFX 인증서로"></a>PEM 인증서를 PFX 인증서로</h4><p>OpenSSL을 사용해서 다음의 명령어를 수행하면 PEM 형식의 인증서를 PKCS12 형식의 인증서로 변환할 수 있습니다. PKCS12 형식의 인증서로 변환할 때 입력한 비밀번호는 KeyStore 형식의 인증서로 변환할 때 인증용으로 사용됩니다.</p>
<pre class="language-ps" data-language="ps"><div class="caption"><span>Windows Terminal</span></div><code class="language-ps">PS openssl pkcs12 -export -inkey server.key -in server.crt -out server.pfx
Enter Export Password: [비밀번호 입력:passwd]
Verifying - Enter Export Password: [비밀번호 입력:passwd]</code></pre>

<h4 id="PFX-인증서를-JKS-인증서로"><a href="#PFX-인증서를-JKS-인증서로" class="headerlink" title="PFX 인증서를 JKS 인증서로"></a>PFX 인증서를 JKS 인증서로</h4><p>자바의 Keytool 도구를 사용해서 PKCS12 형식의 인증서를 KeyStore 형식의 인증서로 변환할 수 있습니다.</p>
<pre class="language-ps" data-language="ps"><div class="caption"><span>Windows Terminal</span></div><code class="language-ps">PS keytool -importkeystore -srckeystore server.pfx -srcstoretype pkcs12 -destkeystore server.jks -deststoretype pkcs12
키 저장소 server.pfx을(를) server.jks(으)로 임포트하는 중...
대상 키 저장소 비밀번호 입력: [비밀번호 입력:passwd]
새 비밀번호 다시 입력: [비밀번호 입력:passwd]
소스 키 저장소 비밀번호 입력: [PFX 비밀번호 입력:passwd]
1 별칭에 대한 항목이 성공적으로 임포트되었습니다.
임포트 명령 완료: 성공적으로 임포트된 항목은 1개, 실패하거나 취소된 항목은 0개입니다.</code></pre>

<h3 id="스프링-부트-애플리케이션"><a href="#스프링-부트-애플리케이션" class="headerlink" title="스프링 부트 애플리케이션"></a>스프링 부트 애플리케이션</h3><p>KeyStore 형식의 서버 인증서가 준비되었으니 스프링 부트 애플리케이션을 만든 후 HTTPS로 실행하기 위한 프로퍼티를 설정하고 애플리케이션을 구동합니다.</p>
<pre class="language-properties" data-language="properties"><div class="caption"><span>application.properties</span></div><code class="language-properties"><span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8080</span>
<span class="token key attr-name">server.ssl.enabled</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token key attr-name">server.ssl.protocol</span><span class="token punctuation">=</span><span class="token value attr-value">TLS</span>
<span class="token key attr-name">server.ssl.enabled-protocols</span><span class="token punctuation">=</span><span class="token value attr-value">TLSv1.2,TLSv1.3</span>
<span class="token key attr-name">server.ssl.key-store</span><span class="token punctuation">=</span><span class="token value attr-value">classpath:cert/server.jks</span>
<span class="token key attr-name">server.ssl.key-store-password</span><span class="token punctuation">=</span><span class="token value attr-value">passwd</span>
<span class="token key attr-name">server.ssl.key-store-type</span><span class="token punctuation">=</span><span class="token value attr-value">pkcs12</span></code></pre>

<p><img data-src="/images/posts/ssl-certificate/ssl-certificate-06.png"></p>
<p>실행된 애플리케이션 서버는 자체 서명된 서버 인증서이기 때문에 발급자인 CA에 대한 정보를 브라우저가 확인할 수 없습니다. 따라서, 브라우저가 신뢰할 수 없는 사이트라고 알려주는 것은 당연한 부분으로 이 경고를 무시하고 접근할 수도 있지만 우리는 <strong>자체 서명 CA 인증서를 보유하고 있으므로 브라우저가 신뢰할 수 있는 기관으로 등록</strong>하겠습니다.</p>
<p><img data-src="/images/posts/ssl-certificate/ssl-certificate-07.png"></p>
<p><strong>설정 &gt; 개인정보 및 보안 &gt; 보안 &gt; 인증서 관리</strong>로 들어가서 자체 서명된 CA 인증서를 루트 인증 기관으로 등록할 수 있습니다.</p>
<p><img data-src="/images/posts/ssl-certificate/ssl-certificate-08.png"></p>
<p>루트 인증 기관 목록에 자체 서명 CA 인증서를 추가했으므로 다음과 같이 신뢰할 수 없던 애플리케이션 서버 인증서를 신뢰할 수 있게 됩니다. </p>
<p><img data-src="/images/posts/ssl-certificate/ssl-certificate-09.png" alt="127.0.0.1"><br><img data-src="/images/posts/ssl-certificate/ssl-certificate-10.png" alt="mambo.kr"></p>
<p>로컬호스트 대신에 SAN으로 지정하였던 127.0.0.1과 mambo.kr에 대해서도 신뢰하였습니다. 만약, 따라해보고 계시는 분들 중에서 여전히 신뢰할 수 없다고 나오는 경우 브라우저를 종료하고 다시 실행해보시기 바랍니다.</p>
<p>이제 Nginx을 추가적으로 구성하여 애플리케이션 서버가 아닌 Nginx에서 서버 인증서를 등록하여 TLS 핸드쉐이크를 수행하는 지 확인해보겠습니다. 실행했던 애플리케이션 서버는 종료합니다.</p>
<h3 id="PEM-형식의-인증서로-변환"><a href="#PEM-형식의-인증서로-변환" class="headerlink" title="PEM 형식의 인증서로 변환"></a>PEM 형식의 인증서로 변환</h3><p>인증 기관 대행 업체에서 발급해준 인증서가 KeyStore 형식의 인증서라면 PEM 형식의 인증서로 변환해야합니다. 이미 우리는 PEM 형식의 서버 인증서가 있는 상태이지만 없는 상태라고 가정하고 KeyStore 형식의 인증서를 PEM 형식으로 변환해봅니다.</p>
<p>변환 과정은 다음과 같이 KeyStore 인증서로 변환할 때의 반대 과정을 거칩니다.</p>
<ol>
<li>JKS 인증서를 PFX 인증서로 변환</li>
<li>PFX 인증서를 PEM 인증서로 변환</li>
</ol>
<pre class="language-ps" data-language="ps"><div class="caption"><span>Windows Terminal</span></div><code class="language-ps"># JKS 인증서를 PFX 인증서로 변환
PS keytool -importkeystore -srckeystore server.jks -destkeystore server.pfx -deststoretype pkcs12
키 저장소 server.jks을(를) server.pfx(으)로 임포트하는 중...
대상 키 저장소 비밀번호 입력: [비밀번호 입력:passwd]
새 비밀번호 다시 입력: [비밀번호 입력:passwd]
소스 키 저장소 비밀번호 입력: [JKS 비밀번호 입력:passwd]
1 별칭에 대한 항목이 성공적으로 임포트되었습니다.
임포트 명령 완료: 성공적으로 임포트된 항목은 1개, 실패하거나 취소된 항목은 0개입니다.

# PFX 인증서에서 PEM 형식의 인증서로 변환
PS openssl pkcs12 -in server.pfx -out server.crt -clcerts -nokeys
Enter Import Password: [PFX 비밀번호 입력:passwd]

# PFX 인증서에서 개인키 추출
PS openssl pkcs12 -in server.pfx -out server.key -nocerts
Enter Import Password: [PFX 비밀번호 입력:passwd]
Enter PEM pass phrase: [비밀번호 입력:passwd]
Verifying - Enter PEM pass phrase: [비밀번호 입력:passwd]</code></pre>

<p>PFX 인증서를 PEM 형식으로 변환하고나서는 부가적인 헤더가 들어가있으므로 PEM 형식에 관련된 부분만 별도로 다시 저장합니다. 예를 들어, 개인키의 경우 -----BEGIN PRIVATE KEY-----으로 시작해서 -----END PRIVATE KEY-----으로 끝나는 부분을 말합니다.</p>
<h3 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h3><p>Nginx와 애플리케이션 서버를 실행하는 환경은 도커 컴포즈로 실행하겠습니다. 먼저, 앞선 스프링 부트 애플리케이션을 실행가능한 JAR 파일로 패키징하여 준비합니다.</p>
<pre class="language-sh" data-language="sh"><div class="caption"><span>Windows Terminal</span></div><code class="language-sh">gradle bootJar
&gt; Task :compileJava UP-TO-DATE
&gt; Task :processResources UP-TO-DATE
&gt; Task :classes UP-TO-DATE
&gt; Task :bootJarMainClassName
&gt; Task :bootJar
# build&#x2F;libs&#x2F;demo-0.0.1-SNAPSHOT.jar</code></pre>

<p>그리고 다음의 도커 컴포즈 문서를 작성하고 패키징된 애플리케이션과 서버 인증서 그리고 개인키 파일을 복사합니다.</p>
<pre class="language-yaml" data-language="yaml"><div class="caption"><span>docker-compose.yaml</span></div><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.8'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span> 
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">ports</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token datetime number">80:80</span>
      <span class="token punctuation">-</span> 443<span class="token punctuation">:</span><span class="token number">443</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./nginx.conf<span class="token punctuation">:</span>/etc/nginx/nginx.conf
      <span class="token punctuation">-</span> ./server.crt<span class="token punctuation">:</span>/etc/nginx/server.crt
      <span class="token punctuation">-</span> ./server.key<span class="token punctuation">:</span>/etc/nginx/server.key
  <span class="token key atrule">app</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> adoptopenjdk/openjdk11
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'java -jar /etc/app.jar'</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./demo<span class="token punctuation">-</span>0.0.1<span class="token punctuation">-</span>SNAPSHOT.jar<span class="token punctuation">:</span>/etc/app.jar
</code></pre>

<p>도커 컴포즈가 참조하는 Nginx 설정 파일에 443 포트에 SSL을 활성화하고 SSL 인증서를 지정하도록 작성합니다.</p>
<pre class="language-conf" data-language="conf"><div class="caption"><span>nginx.conf</span></div><code class="language-conf">worker_processes auto;

events &#123;
    worker_connections  1024;
&#125;

http &#123;
    access_log      &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log;
    error_log       &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log;

    include         &#x2F;etc&#x2F;nginx&#x2F;mime.types;

    server &#123;
        listen              443 ssl;
        server_name         localhost 127.0.0.1 mambo.kr;
        ssl_certificate     &#x2F;etc&#x2F;nginx&#x2F;server.crt;
        ssl_certificate_key &#x2F;etc&#x2F;nginx&#x2F;server.key;
        ssl_protocols       TLSv1.2 TLSv1.3;
        ssl_ciphers         HIGH:!aNULL:!MD5;

        location &#x2F; &#123;
            proxy_pass         http:&#x2F;&#x2F;app:8080;
            proxy_redirect     off;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        &#125;
    &#125;

    keepalive_timeout  60;
    include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;
&#125;</code></pre>

<p>도커 컴포즈 명령어로 Nginx와 함께 애플리케이션을 구동합니다.</p>
<pre class="language-ps" data-language="ps"><div class="caption"><span>Windows Terminal</span></div><code class="language-ps">docker-compose up -d</code></pre>

<p>정상적으로 실행되었다면 Nginx의 443 포트를 통해 애플리케이션 서버와의 통신을 수행할 수 있습니다. 그리고 다음 처럼 TLS 핸드쉐이크 과정이 Nginx에 의해 제대로 수행되었음을 확인할 수 있습니다.</p>
<p><img data-src="/images/posts/ssl-certificate/ssl-certificate-11.png"></p>
<p>이상으로 SSL 인증서에 대한 정리를 마치도록 하겠습니다. </p>
<p>인프라 구조상 SSL 인증서를 어디에 등록하고 TLS 핸드쉐이킹 과정을 수행하는지도 중요한 부분일 수 있습니다. 운영중인 웹 서비스를 분산 애플리케이션으로 로드밸런싱을 수행하고 있다면 로드밸런싱을 수행하는 Nginx 또는 NLB에서 TLS 핸드쉐이킹을 수행할 수 있도록 SSL 인증서를 등록하는 것이 좋을 수 있습니다. 이렇게 구성하면 애플리케이션 서버에서 지원하지 않는 요청에 대해서 애플리케이션 서버까지 도달하지 않도록 하여 서버 부하를 방지할 수 있습니다. 물론, 로드밸런서에서 TLS 핸드쉐이크를 수행하므로 상대적으로 로드밸런서 서버의 부하가 커지는 것은 감안해야합니다.</p>
<p>감사합니다.</p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/network/create-tls-listener.html">Network Load Balancer를 위한 TLS 리스너</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/configuring-https-ssl.html">X509 인증서 생성 및 서명</a></li>
<li><a href="https://www.baeldung.com/java-keystore-convert-to-pem-format">Converting a Java Keystore Into PEM Format</a></li>
<li><a href="https://stackoverflow.com/questions/13732826/convert-pem-to-crt-and-key">Convert .pem to .crt and .key</a></li>
<li><a href="https://www.sslcert.co.kr/guides/SSL-Certificate-Convert-Format">Convert Certificate Format SSL 인증서 변환 가이드</a></li>
<li><a href="https://letsencrypt.org/ko/docs/certificates-for-localhost/">localhost를 위한 인증서</a></li>
</ul>
]]></content>
      <tags>
        <tag>TLS</tag>
        <tag>HTTPS</tag>
      </tags>
  </entry>
  <entry>
    <title>TLS 오프로드</title>
    <url>/tls-offload/</url>
    <content><![CDATA[<p>안녕하세요 Mambo 입니다.</p>
<p>오늘은 로드밸런서를 활용한 TLS 오프로드에 대해서 정리해보고자 합니다. 지난 <a href="../ssl-certificate">SSL 인증서</a>에서는 HTTPS를 웹 서비스에 적용하는 이유와 함께 SSL 인증서를 발급하고 TLS 핸드쉐이크를 어떤 방식으로 수행하는지를 확인했습니다. 이 글에서는 <strong>아마존 웹 서비스의 ELB(Elastic Load Balancing)에서 지원하는 TLS 핸드쉐이크 및 TLS 오프로딩 기능</strong>에 대해 알아보고 참고해야할 정보를 소개합니다.</p>
<h2 id="SSL-오프로드"><a href="#SSL-오프로드" class="headerlink" title="SSL 오프로드"></a>SSL 오프로드</h2><p><strong>TLS(SSL) 오프로드</strong>는 애플리케이션 서버에서 TLS 핸드쉐이크를 수행하지 않고 <strong>트래픽이 전달되기 전 로드밸런서에서 SSL 인증서를 관리하고 TLS 핸드쉐이크를 수행</strong>하는 것을 말합니다. 대부분의 웹 서비스는 애플리케이션 서버를 독립적으로 운용하지 않고 트래픽 규모에 따라 유연하게 확장하고 확장된 애플리케이션 서버에 트래픽을 균등하게 분산시키기 위하여 로드밸런서를 구성합니다. 아마존 웹 서비스의 ELB 로드밸런서 유형 중 NLB와 ALB는 SSL 인증서를 등록하고 클라이언트와 TLS 핸드쉐이크를 수행하여 트래픽이 EC2 인스턴스 또는 컨테이너로 전달하는 <strong>TLS 오프로딩 기능을 지원</strong>합니다.</p>
<h3 id="Mutual-TLS"><a href="#Mutual-TLS" class="headerlink" title="Mutual TLS"></a>Mutual TLS</h3><p>웹 서비스의 요구사항에 따라 애플리케이션 서버에서는 <strong>클라이언트의 X.509 인증서를 토대로 사용자 인증을 수행하고 요청을 처리</strong>할 수 있습니다. 이렇게 클라이언트와 애플리케이션 서버 모두 인증서를 전달하는 것을 <strong>Mutual TLS</strong>라고 합니다. 그리고 자바 기반의 애플리케이션 서버는 <strong>javax.servlet.request.X509Certificate</strong> 속성을 통해 <strong>X.509 인증서</strong>를 가져올 수 있습니다. </p>
<p>그러나 웹 요청이 로드밸런서에 의해 트래픽이 전달되는 경우 클라이언트 인증서를 포함하여 전달하는 것이 보장되지 않습니다. 일반적으로 Nginx를 로드밸런서를 사용하는 경우에는 요청 시 포함된 클라이언트의 인증서 정보가 <strong>X-SSL-CERT</strong>와 같은 <strong>비표준 헤더</strong>로 전달될 수 있도록 설정합니다. 이렇게 요청 헤더로 인증서를 애플리케이션 서버까지 전달하는 것은 애플리케이션 서버에서 클라이언트의 실제 아이피를 알기 위하여 사용되는 표준 헤더 <strong>X-Forwarded-For</strong>와 비슷한 목적으로 사용된다고 볼 수 있습니다.</p>
<h3 id="AWS-NLB"><a href="#AWS-NLB" class="headerlink" title="AWS NLB"></a>AWS NLB</h3><p>아마존 웹 서비스의 <a href="https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/network/introduction.html">NLB(Network Load Balancer)</a>는 <strong>L4 레벨의 ELB 로드밸런서 유형</strong>입니다. NLB는 L4 레벨에서 로드밸런싱을 수행하며 프로토콜과 포트를 기반으로 지정된 하나 이상의 대상 그룹으로 요청을 전달하기 때문에 대규모 트래픽을 빠르게 EC2 인스턴스로 전달되도록 지원합니다. </p>
<p><a href="https://aws.amazon.com/ko/elasticloadbalancing/features/#Product_comparisons">ELB의 로드밸런서 유형 비교</a>에서 나와있듯이 NLB는 TLS 오프로드를 지원하기 때문에 <strong>로드밸런서에 인증서를 등록하고 TLS 핸드쉐이크를 처리하도록 구성</strong>할 수 있게 됩니다. 다음과 같이 NLB의 리스너 설정 시 <strong>TLS 프로토콜</strong>을 선택하고 <strong>TLS 버전</strong>과 암호화 스위트 목록에 대한 <strong>보안 정책</strong> 그리고 <strong>SSL 인증서</strong>를 등록할 수 있습니다.</p>
<p><img data-src="/images/posts/tls-offload/tls-offload-01.png"></p>
<h4 id="ECC-인증서-미지원"><a href="#ECC-인증서-미지원" class="headerlink" title="ECC 인증서 미지원"></a>ECC 인증서 미지원</h4><p>TLS 오프로드를 지원한다고 나와있지만 <strong>모든 SSL 인증서를 지원하는 것은 아닙</strong>니다. 회사에서 사용중인 인증서와 같은 타원 곡선형 키를 사용하는 ECC 인증서를 등록하게 되면 아마존 웹 서비스로부터 알림을 받게되고 <strong>애플리케이션 서버로 트래픽이 전달되지 않는 상태</strong>가 될 수 있습니다.</p>
<p><img data-src="/images/posts/tls-offload/tls-offload-02.png"></p>
<p>NLB에 대한 리스너 설정 문서를 살펴보면 <strong>2048 이상의 비트를 사용하는 RSA 키 또는 EC 키로된 인증서를 지원하지 않는다</strong>라고 경고하고 있으며 문서를 살펴보기까지 이러한 정보를 확인할 수 있는 곳은 없었습니다.</p>
<p><img data-src="/images/posts/tls-offload/tls-offload-03.png"></p>
<p>의외로 많이 사용하고 있는 <strong>ECC 인증서에 대해서는 NLB에서 TLS 오프로드를 수행할 수 없기</strong> 때문에 애플리케이션 서버에서 SSL 인증서를 관리하고 TLS 핸드쉐이크를 수행해야합니다. 애플리케이션 서버 배포 시 Elastic Beanstalk을 사용하는 경우 <a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/java-se-platform.html">Java SE 플랫폼</a>을 통해 EC2 인스턴스에 <strong>Nginx를 활용하여 역방향 프록시를 구성</strong>할 수 있기 때문에 반드시 애플리케이션 서버에서 TLS 핸드쉐이크를 수행해야하는 것은 아닙니다.</p>
<blockquote>
<p>회사에서 운영중인 웹 서비스는 Nginx를 사용하지 않고 NLB에서 애플리케이션 서버로 트래픽이 전달되도록 구성했었지만 애플리케이션 서버 규모가 커짐으로 인하여 내부적으로 동작하는 작업이 많아짐에 따라 TLS 핸드쉐이크 부하를 애플리케이션 서버에서 분리하기 위하여 Nginx에서 TLS 오프로드를 수행하도록 전환할 예정입니다.</p>
</blockquote>
<h3 id="AWS-ALB"><a href="#AWS-ALB" class="headerlink" title="AWS ALB"></a>AWS ALB</h3><p>ECC 인증서를 지원하지 않는 NLB와 다르게 ALB(Application Load Balancer)는 <strong>4096 비트 키 길이의 RSA 인증서와 ECDSA로 서명된 EC 인증서를 지원</strong>합니다. <strong>회사에서 운영중인 웹 서비스를 NLB에서 ALB로 전환하지 않는 이유</strong>는 완전한 마이크로서비스 아키텍처가 아니므로 <strong>경로 기반</strong>으로 별도의 애플리케이션 서버로 전달해야하는 <strong>요구사항이 없기</strong> 때문입니다. 이러한 이유로 인해 빠르게 로드밸런서에서 애플리케이션 서버로 트래픽이 전달되도록 NLB를 사용하고 있습니다.</p>
<p>IT 분야는 시간이 지나면서 기술이 점차 발전하고 있습니다. 아마존 웹 서비스가 제공하는 서비스 기능도 발전하고 있음을 확인할 수 있는데 2019년에 작성된 <a href="https://lemontia.tistory.com/898">고정 세션 관련 글</a>에서는 NLB가 <strong>고정 세션 기능을 지원하지 않는다</strong>고 나와있지만 현재 ELB의 제품 비교표와 비교해보면 <strong>백엔드 암호화, 고정 세션 뿐만 아니라 다양한 기능을 지원</strong>하고 있습니다.</p>
<h4 id="ELB-TLSv1-3-미지원"><a href="#ELB-TLSv1-3-미지원" class="headerlink" title="ELB TLSv1.3 미지원"></a>ELB TLSv1.3 미지원</h4><p>아마존 웹 서비스의 ELB에서 TLS 오프로드 기능을 지원하지만 <a href="https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/application/create-https-listener.html#describe-ssl-policies">보안 정책</a>에 따라 TLS 핸드쉐이크를 수행하기 때문에 클라이언트는 TLS 1.3을 사용할 수 없습니다. <strong>TLS 1.3을 지원하기 위한 작업은 아직 진행중</strong>이므로 클라이언트에게 TLS 1.3을 지원하고자하는 경우에는 ELB에서 TLS 오프로드를 수행하도록 구성할 수 없고 NLB의 TCP 리스너를 설정하여 트래픽이 EC2 인스턴스로 전달되도록하고 <strong>EC2 인스턴스에 실행되어있는 Nginx를 통해 TLS 1.3을 사용할 수 있게 구성</strong>할 수 있습니다.</p>
<h2 id="Elastic-Beanstalk-TLS-오프로드"><a href="#Elastic-Beanstalk-TLS-오프로드" class="headerlink" title="Elastic Beanstalk TLS 오프로드"></a>Elastic Beanstalk TLS 오프로드</h2><p>ELB에서는 TLS 1.3을 지원하지 않으며 NLB에서는 ECC 인증서를 사용할 수 없다는 것을 알았으므로 <strong>Elastic Beanstalk</strong>으로 스프링 애플리케이션 배포 시 Nginx에서 SSL 인증서를 관리하고 <strong>클라이언트가 TLS 1.3 버전으로 TLS 핸드쉐이크를 수행할 수 있도록 할 수 있는가를 검증</strong>해보고 마무리 하겠습니다.</p>
<h3 id="Elastic-Beanstalk-Java-SE-플랫폼"><a href="#Elastic-Beanstalk-Java-SE-플랫폼" class="headerlink" title="Elastic Beanstalk Java SE 플랫폼"></a>Elastic Beanstalk Java SE 플랫폼</h3><p>스프링 애플리케이션을 배포하기 위해서는 Java SE 플랫폼 환경을 구성해야합니다. 이때, 샘플 애플리케이션으로 Beanstalk 환경을 시작하는 것이 좋습니다.</p>
<p><img data-src="/images/posts/tls-offload/tls-offload-04.png" alt="웹 서버 환경 선택"></p>
<p><img data-src="/images/posts/tls-offload/tls-offload-05.png" alt="샘플 애플리케이션으로 시작"></p>
<p>Beanstalk 환경 구성 시 로드밸런서를 설정하고 싶은 경우 <strong>추가 옵션 구성</strong>을 통해 사용자 정의 설정을 진행해야 합니다.</p>
<p><img data-src="/images/posts/tls-offload/tls-offload-06.png" alt="JVM 옵션 환경변수"></p>
<blockquote>
<p>배포하고 보니 오타가 있었네요 :)</p>
</blockquote>
<p><img data-src="/images/posts/tls-offload/tls-offload-07.png" alt="로드밸런싱 인스턴스"></p>
<p><img data-src="/images/posts/tls-offload/tls-offload-08.png" alt="NLB 선택 및 리스너 구성"></p>
<p>그리고 EC2 인스턴스 접근을 위한 키를 설정하는 등 부가 설정을 하고 환경을 생성하면 다음과 같이 샘플 애플리케이션이 배포되는 환경이 준비됩니다.</p>
<p><img data-src="/images/posts/tls-offload/tls-offload-09.png" alt="Java SE 플랫폼 환경 생성 완료"></p>
<blockquote>
<p>처음 환경을 구성할 때 오류가 발생하는 경우 Beanstalk에서는 환경 삭제 버튼이 활성화되지 않아 당황할 수 있으나 CloudFormation 서비스로 이동하여 Beanstalk 환경을 구성중인 스택을 삭제할 수 있습니다.</p>
</blockquote>
<h3 id="스프링-애플리케이션-패키징-및-Java-SE-플랫폼-확장"><a href="#스프링-애플리케이션-패키징-및-Java-SE-플랫폼-확장" class="headerlink" title="스프링 애플리케이션 패키징 및 Java SE 플랫폼 확장"></a>스프링 애플리케이션 패키징 및 Java SE 플랫폼 확장</h3><p>애플리케이션을 배포하기 위한 Java SE 플랫폼이 생성되었으니 스프링 애플리케이션을 패키징하여 <strong>Beanstalk에 배포하기 위한 소스 번들</strong> 파일을 만들어야 합니다. 소스 번들에는 패키징된 애플리케이션 Jar 파일과 함께 애플리케이션 실행를 위한 Procfile을 포함시켜야 합니다.</p>
<pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">task <span class="token function">procfile</span><span class="token punctuation">(</span>dependsOn<span class="token punctuation">:</span> bootJar<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    doFirst <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"build/libs"</span></span><span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">"Procfile"</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"web: java -Xmx1g -Dfile.encoding=UTF-8 -jar </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token expression">bootJar<span class="token punctuation">.</span>archiveName</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"</span></span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

task <span class="token function">awsbuild</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span> Zip<span class="token punctuation">,</span> dependsOn<span class="token punctuation">:</span> procfile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    from <span class="token punctuation">(</span><span class="token string">'.beanstalk/.ebextensions'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> into <span class="token string">'.ebextensions'</span> <span class="token punctuation">&#125;</span>
    from <span class="token punctuation">(</span><span class="token string">'.beanstalk/.platform'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> into <span class="token string">'.platform'</span> <span class="token punctuation">&#125;</span>
    from <span class="token punctuation">(</span><span class="token string">'build/libs'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">include</span><span class="token punctuation">(</span><span class="token string">'Procfile'</span><span class="token punctuation">)</span>
        <span class="token function">include</span><span class="token punctuation">(</span>bootJar<span class="token punctuation">.</span>archiveName<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    baseName <span class="token operator">=</span> <span class="token string">'beanstalk'</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>자세한 내용은 <a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/java-se-procfile.html">Procfile을 사용하여 애플리케이션 프로세스 구성</a>을 참고하세요. </p>
</blockquote>
<h4 id="Java-SE-플랫폼-확장-구성"><a href="#Java-SE-플랫폼-확장-구성" class="headerlink" title="Java SE 플랫폼 확장 구성"></a>Java SE 플랫폼 확장 구성</h4><p>Beanstalk는 <strong>.ebextensions</strong>와 <strong>.platform</strong>을 활용하여 EC2 인스턴스 환경을 확장할 수 있는 기능을 지원합니다. 우리는 HTTP로 실행되는 애플리케이션 서버와 함께 TLS 오프로드를 수행할 Nginx를 구성해야하므로 다음과 같이 <strong>구성 및 플랫폼 확장 파일을 생성</strong>합니다.</p>
<p><strong>Nginx에서 사용할 SSL 인증서 파일 생성</strong></p>
<pre class="language-yaml" data-language="yaml"><div class="caption"><span>beanstalk/.ebextensions/nginx-certificates.config</span></div><code class="language-yaml"><span class="token key atrule">files</span><span class="token punctuation">:</span>
    <span class="token key atrule">/etc/nginx/cert/server.crt</span><span class="token punctuation">:</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">"000400"</span>
        <span class="token key atrule">owner</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">group</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            -----BEGIN CERTIFICATE-----
            #### PROTECTED ####
            -----END CERTIFICATE-----</span>
    <span class="token key atrule">/etc/nginx/cert/server.key</span><span class="token punctuation">:</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">"000400"</span>
        <span class="token key atrule">owner</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">group</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            -----BEGIN EC PARAMETERS-----
            #### PROTECTED ####
            -----END EC PARAMETERS-----
            -----BEGIN EC PRIVATE KEY-----
            #### PROTECTED ####
            -----END EC PRIVATE KEY-----</span>
    <span class="token key atrule">/etc/nginx/cert/server-ca-bundle</span><span class="token punctuation">:</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token string">"000400"</span>
        <span class="token key atrule">owner</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">group</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            -----BEGIN CERTIFICATE-----
            #### PROTECTED ####
            -----END CERTIFICATE-----
            -----BEGIN CERTIFICATE-----
            #### PROTECTED ####
            -----END CERTIFICATE-----
            -----BEGIN CERTIFICATE-----
            #### PROTECTED ####
            -----END CERTIFICATE-----</span>

<span class="token key atrule">commands</span><span class="token punctuation">:</span>
    <span class="token key atrule">00-chain-ca-bundle</span><span class="token punctuation">:</span>
        <span class="token key atrule">cwd</span><span class="token punctuation">:</span> /etc/nginx/cert
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            cat server.crt server-ca-bundle > server-ca.pem
            chown nginx:nginx server-ca.pem
            chmod 400 server-ca.pem</span>
    <span class="token key atrule">99-remove-bak</span><span class="token punctuation">:</span>
        <span class="token key atrule">cwd</span><span class="token punctuation">:</span> /etc/nginx/cert
        <span class="token key atrule">command</span><span class="token punctuation">:</span> rm <span class="token punctuation">-</span>f <span class="token important">*.bak</span></code></pre>

<blockquote>
<p>회사 도메인에 대한 인증서이므로 인증서 내용은 마스킹 처리하였습니다.</p>
</blockquote>
<p><strong>Nginx 설정 파일 확장</strong></p>
<pre class="language-nginx" data-language="nginx"><div class="caption"><span>beanstalk/.platform/nginx/conf.d/elasticbeanstalk/00_application.conf</span></div><code class="language-nginx"><span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> https://<span class="token variable">$host</span><span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>기본으로 만들어지는 00_application.conf 파일은 80 포트에 대하여 5000 포트로 전달되도록 구성하므로 443 포트로 리다이렉트하도록 확장합니다.</p>
<pre class="language-nginx" data-language="nginx"><div class="caption"><span>beanstalk/.platform/nginx/nginx.conf</span></div><code class="language-nginx"><span class="token directive"><span class="token keyword">user</span>                    nginx</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">error_log</span>               /var/log/nginx/error.log warn</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">pid</span>                     /var/run/nginx.pid</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">worker_processes</span>        auto</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">worker_rlimit_nofile</span>    <span class="token number">32768</span></span><span class="token punctuation">;</span>

<span class="token directive"><span class="token keyword">events</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">use</span>  epoll</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">worker_connections</span>  <span class="token number">1024</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">include</span>         /etc/nginx/mime.types</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">default_type</span>    application/octet-stream</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">log_format</span>      main    <span class="token string">'<span class="token variable">$remote_addr</span> - <span class="token variable">$remote_user</span> [<span class="token variable">$time_local]</span> "<span class="token variable">$request</span>" '</span>
                            <span class="token string">'<span class="token variable">$status</span> <span class="token variable">$body_bytes_sent</span> "<span class="token variable">$http_referer</span>" '</span>
                            <span class="token string">'"<span class="token variable">$http_user_agent</span>" "<span class="token variable">$http_x_forwarded_for</span>"'</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">include</span> conf.d/*.conf</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">map</span> <span class="token variable">$http_upgrade</span> <span class="token variable">$connection_upgrade</span></span> <span class="token punctuation">&#123;</span>
      <span class="token directive"><span class="token keyword">default</span>     <span class="token string">"upgrade"</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">listen</span>                <span class="token number">80</span> default_server</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">access_log</span>            /var/log/nginx/access.log main</span><span class="token punctuation">;</span>

        <span class="token directive"><span class="token keyword">client_header_timeout</span> <span class="token number">60</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">client_body_timeout</span>   <span class="token number">60</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">keepalive_timeout</span>     <span class="token number">60</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">gzip</span>                  <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">gzip_comp_level</span>       <span class="token number">4</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">gzip_types</span>            text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript</span><span class="token punctuation">;</span>

        <span class="token comment"># Include the Elastic Beanstalk generated locations</span>
        <span class="token directive"><span class="token keyword">include</span> conf.d/elasticbeanstalk/*.conf</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">listen</span>                   <span class="token number">443</span> ssl default_server</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">server_name</span>              springboot</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_certificate</span>          /etc/nginx/cert/server-ca.pem</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_certificate_key</span>      /etc/nginx/cert/server.key</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_protocols</span>            TLSv1.2 TLSv1.3</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_ciphers</span>              HIGH:!aNULL:!MD5</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">ssl_verify_client</span>        optional_no_ca</span><span class="token punctuation">;</span>

        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
            <span class="token directive"><span class="token keyword">proxy_pass</span>          http://127.0.0.1:5000</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_http_version</span>  1.1</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span>    Connection          <span class="token variable">$connection_upgrade</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span>    Upgrade             <span class="token variable">$http_upgrade</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span>    Host                <span class="token variable">$host</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span>    X-Real-IP           <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span>    X-Forwarded-For     <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span>    X-SSL-CERT          <span class="token variable">$ssl_client_escaped_cert</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_buffering</span>     <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>자세한 내용은 <a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/platforms-linux-extend.html">Elastic Beanstalk Linux 플랫폼 확장</a>을 참고하세요. <a href="https://github.com/awsdocs/elastic-beanstalk-samples">elastic-beanstalk-samples</a>처럼 샘플 파일도 공유되어있습니다.</p>
</blockquote>
<p>이제 샘플 애플리케이션 대신 우리가 준비한 애플리케이션 소스 번들을 업로드하면 Benstalk 엔진이 소스 번들을 추출하고 애플리케이션을 실행하게 됩니다. Route 53으로 Beanstalk 환경 주소를 DNS로 연결하고 접속해보면 다음과 같이 TLS 핸드쉐이크가 수행되었음을 확인할 수 있습니다.</p>
<p><img data-src="/images/posts/tls-offload/tls-offload-10.png"></p>
<p>NLB는 트래픽을 EC2 인스턴스의 443 포트로 전달했을 뿐 TLS 오프로드는 Nginx에서 수행하는 것으로 구성했기 때문에 브라우저에서는 TLS 1.3 버전으로 TLS 핸드쉐이크를 수행했습니다. 이렇게 <strong>아마존 웹 서비스에서 TLS 1.3을 지원하기 위해서는 NLB의 TCP 리스너와 Nginx의 TLS 오프로드를 활용하면 가능함을 검증</strong>했습니다.</p>
<h4 id="트러블슈팅"><a href="#트러블슈팅" class="headerlink" title="트러블슈팅"></a>트러블슈팅</h4><p>Elastic Beanstalk로 애플리케이션 배포하는 과정에서 생각보다 오류가 많을 수 있습니다. 이 내용은 <strong>Benstalk에서 애플리케이션 배포 시 발생하는 여러가지 문제를 해결하는데 도움이 되는 항목</strong>을 정리한 것입니다. 따라해보는 분들에게 도움이 되셨으면 하는 바램으로 공유합니다.</p>
<table>
<thead>
<tr>
<th>경로</th>
<th>용도</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;etc&#x2F;nginx&#x2F;</td>
<td>Nginx 구성</td>
<td></td>
</tr>
<tr>
<td>&#x2F;var&#x2F;app&#x2F;current</td>
<td>애플리케이션 소스 번들 추출 경로</td>
<td></td>
</tr>
<tr>
<td>&#x2F;var&#x2F;log&#x2F;eb-engine.log</td>
<td>Beanstalk 로그</td>
<td></td>
</tr>
<tr>
<td>&#x2F;var&#x2F;log&#x2F;nginx</td>
<td>Nginx 로그</td>
<td></td>
</tr>
<tr>
<td>&#x2F;var&#x2F;log&#x2F;web.stdout.out</td>
<td>웹 애플리케이션 로그</td>
<td></td>
</tr>
</tbody></table>
<p><strong>Beanstalk 로그</strong>는 Beanstalk 엔진이 플랫폼 확장 파일들을 실행하고 성공했는지 여부를 기록합니다. 이 로그를 통해 어느 단계에서 오류가 발생하여 애플리케이션 배포 및 전환이 실패하였는지 확인할 수 있는 중요한 로그입니다. 그리고 나머지 항목을 통해 설정한 구성 및 확장 파일이 제대로 추출되어 복사되었는지 Nginx가 ELB에 의해 전달된 트래픽을 애플리케이션까지 전달할 수 있는지를 확인할 수 있습니다.</p>
<p>Nginx에 대해서 자세히 아는 것은 아니므로 설정 파일이 잘못된 부분이 있을 수 있으니 양해 바라며 잘못된 점은 패드백 주시면 감사하겠습니다.</p>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>Nginx</tag>
        <tag>TLS</tag>
        <tag>ELB</tag>
      </tags>
  </entry>
  <entry>
    <title>초보 개발자들을 위한 AJAX에 대한 정리</title>
    <url>/understanding-asynchronos-javascript-and-xml-with-spring/</url>
    <content><![CDATA[<blockquote>
<p>본 글은 <a href="https://github.com/kdevkr/spring-demo-ajax">https://github.com/kdevkr/spring-demo-ajax</a> 에서 제공했던 정보입니다.</p>
</blockquote>
<h2 id="들어가며"><a href="#들어가며" class="headerlink" title="들어가며"></a>들어가며</h2><blockquote>
<p><em>웹 서비스를 만들 때 자주 사용되는 비동기 통신 기술인 AJAX를 스프링 프레임워크와 연계하여 활용하는 다양한 방식에 대해서 알아보고자 합니다.</em>  </p>
</blockquote>
<p>XHR(XMLHttpRequest)를 직접적으로 이용하는 것보다는 JQuery에서 지원하는 AJAX(Asynchronos Javascript And XML)기능을 활용하도록 하는 것이 나을 것 같다는 생각입니다.</p>
<ul>
<li><a href="https://developer.mozilla.org/ko/docs/XMLHttpRequest">XMLHttpRequest, Mozilla Developer Network</a>  </li>
<li><a href="http://api.jquery.com/jquery.ajax/">Ajax, JQuery</a></li>
</ul>
<p>JQuery 이외에도 ajax를 지원하는 다양한 라이브러리가 존재합니다. 예를 들어, <a href="http://prototypejs.org/learn/introduction-to-ajax">Prototypejs</a>도 많이 사용되는 유틸성 라이브러리 중 하나입니다. 그러나 저와 같은 초보자 및 신입 개발자들은 JQuery에 익숙하므로 JQuery가 지원하는 Ajax 기능에 대해서 살펴보고자 합니다.</p>
<blockquote>
<p>Vue.js에서는 <a href="https://github.com/mzabriskie/axios">axios</a>를 선호한다고 합니다.  </p>
</blockquote>
<h2 id="JQuery-ajax"><a href="#JQuery-ajax" class="headerlink" title="JQuery.ajax"></a>JQuery.ajax</h2><p>제이쿼리에서 제공하는 함수는 다음과 같은 구조로 구성되어 있습니다. 물론 이외에도 생략된 다양한 프로퍼티들이 존재하므로 더 찾아보시면 좋을 것 같습니다. 아래의 형태는 아마도 자주 사용되는 프로퍼티만 모아놓은 부분이라고 할 수 있습니다.  </p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript">$<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">type</span>	<span class="token operator">:</span> <span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token comment">//요청 메소드 타입</span>
  <span class="token literal-property property">url</span>		<span class="token operator">:</span> <span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token comment">//요청 경로</span>
  <span class="token literal-property property">async</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//비동기 여부</span>
  <span class="token literal-property property">data</span>  <span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">key</span> <span class="token operator">:</span> value<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">//요청 시 포함되어질 데이터</span>
  <span class="token literal-property property">processData</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//데이터를 컨텐트 타입에 맞게 변환 여부</span>
  <span class="token literal-property property">cache</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//캐시 여부</span>
  <span class="token literal-property property">contentType</span> <span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> <span class="token comment">//요청 컨텐트 타입 "application/x-www-form-urlencoded; charset=UTF-8"</span>
  <span class="token literal-property property">dataType</span>	<span class="token operator">:</span> <span class="token string">"json"</span><span class="token punctuation">,</span> <span class="token comment">//응답 데이터 형식 명시하지 않을 경우 자동으로 추측</span>
  <span class="token function-variable function">beforeSend</span>  <span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">// XHR Header를 포함해서 HTTP Request를 하기전에 호출됩니다.</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">success</span>	<span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> status<span class="token punctuation">,</span> xhr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">// 정상적으로 응답 받았을 경우에는 success 콜백이 호출되게 됩니다.</span>
    <span class="token comment">// 이 콜백 함수의 파라미터에서는 응답 바디, 응답 코드 그리고 XHR 헤더를 확인할 수 있습니다.</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">error</span>	<span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">xhr<span class="token punctuation">,</span> status<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  	<span class="token comment">// 응답을 받지 못하였다거나 정상적인 응답이지만 데이터 형식을 확인할 수 없기 때문에 error 콜백이 호출될 수 있습니다.</span>
  	<span class="token comment">// 예를 들어, dataType을 지정해서 응답 받을 데이터 형식을 지정하였지만, 서버에서는 다른 데이터형식으로 응답하면  error 콜백이 호출되게 됩니다.</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">complete</span> <span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">xhr<span class="token punctuation">,</span> status</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">// success와 error 콜백이 호출된 후에 반드시 호출됩니다.</span>
    <span class="token comment">// try - catch - finally의 finally 구문과 동일합니다.</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<blockquote>
<p>여기서 잠깐! GET과 POST의 차이는 무엇인지 아시나요?  </p>
</blockquote>
<p>바로 데이터가 어디에 위치하는가에 있습니다. POST 요청시에 URL에 파라미터가 보이지 않는 이유는 데이터가 요청 바디에 포함되기 때문입니다. 그렇기 때문에 GET과 POST에 따라 데이터를 URL에 추가해야할지 요청 바디에 추가해야할지를 알고 있어야만 합니다.  </p>
<p>예를 들어, processData라는 속성은 GET 요청인데 data에 오브젝트가 지정될 경우에 요청하기전에 그 데이터를 파라미터 형식으로 URL에 추가해주는 역할을 하게 됩니다.</p>
<p>이외에도 JQuery에서는 <a href="https://api.jquery.com/category/ajax/">다양한 ajax 기능</a>을 제공하고 있습니다. 만약, 스프링 시큐리티를 적용해서 HTTP 통신시에 CSRF 토큰이 필요하다면 다음과 같이 XHR Header에 CSRF 토큰을 추가해서 보낼 수 있습니다.</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 스프링 시큐리티 태그라이브러리로 메타 태그에 토큰 정보를 적용했다는 가정입니다.</span>
<span class="token keyword">var</span> token <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"meta[name='_csrf']"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> header <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"meta[name='_csrf_header']"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
$<span class="token punctuation">.</span><span class="token function">ajaxSetup</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
   <span class="token function-variable function">beforeSend</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">xhr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<blockquote>
<p>JQuery.ajax에 대해서는 이 정도까지만 알아도 됩니다.</p>
</blockquote>
<h2 id="Spring-Controller"><a href="#Spring-Controller" class="headerlink" title="Spring Controller"></a>Spring Controller</h2><p>스프링 프레임워크에서는 ajax 통신을 위해서 스프링 @MVC로 다양한 어노테이션을 지원합니다. 다양한 어노테이션을 확인하면서 구조를 익혀보도록 하겠습니다. 스프링 애플리케이션은 기본적으로 뷰 리졸버를 통해서 요청에 대한 응답을 하게 됩니다. 일반적인 HTTP 요청의 경우에는 JstlView로써 응답을 하게 되지만, XHR 요청에 의해서 다양한 데이터 형식으로 응답하기 위한 메시지 컨버터라는 것을 지원합니다.  </p>
<pre class="language-text" data-language="text"><code class="language-text">Message Converter List
- StringHttpMessageConverter
- FormHttpMessageConverter
- ByteArrayMessageConverter
- MarshallingHttpMessageConverter
- MappingJacksonHttpMessageConverter
- MappingJackson2HttpMessageConverter
- SourceHttpMessageConverter
- BufferedImagedHttpMessageConverter</code></pre>

<blockquote>
<p>스프링의 <annotation-driven />은 많은 역할을 해주는데, 그 중 하나가 디폴트 메시지 컨버터를 등록해줍니다. 다만, MappingJacksonHttpMessageConverter는 jackson 라이브러리가 존재할때만 등록합니다.  </p>
</blockquote>
<p>우리가 AJAX를 이용할 때 데이터 형식을 JSON으로 많이 사용합니다. 따라서, List, Map등과 같은 오브젝트들을 JSON 형태로 응답하고 싶다면, ModelAndView를 이용하거나 메시지컨버터를 등록해야합니다.  </p>
<blockquote>
<p><em>본 문서에서는 ModelAndView로써 응답하는 방식은 설명하지 않겠습니다. <a href="http://www.nextree.co.kr/p11205/">여기서 확인하도록 합시다</a></em>  </p>
</blockquote>
<p>그러나 스프링 3 이상 부터는 jackson 라이브러리를 의존성으로 추가할 경우에 자동적으로 MappingJacksonHttpMessageConverter를 적용해줍니다.</p>
<blockquote>
<p>여기서 잠깐!<br>스프링 3.1.2 부터는 jackson 2.0을 지원하도록 추가되었습니다. jackson 2.0은 MappingJackson2HttpMessageConverter로 등록됩니다.<br>자세한 사항은 스프링 버전별 jackson 라이브러리 버전 항목에서 확인하시기 바랍니다.</p>
</blockquote>
<p>스프링 부트에서는 이러한 부분도 관리해주므로 추가적으로 jackson 라이브러리를 pom.xml에 추가할 필요가 없습니다.  </p>
<h3 id="스프링-버전별-사용되는-Jackson-Library"><a href="#스프링-버전별-사용되는-Jackson-Library" class="headerlink" title="스프링 버전별 사용되는 Jackson Library"></a>스프링 버전별 사용되는 Jackson Library</h3><p>스프링 3.0 이상부터는 jackson 관련 라이브러리에 따라 메시지 컨버터를 등록해줍니다.</p>
<h4 id="Spring-3-0-x"><a href="#Spring-3-0-x" class="headerlink" title="Spring 3.0.x"></a>Spring 3.0.x</h4><pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.codehaus.jackson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-mapper-asl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;org.codehaus.jackson&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>

<h4 id="Spring-3-1-2"><a href="#Spring-3-1-2" class="headerlink" title="Spring 3.1.2"></a>Spring 3.1.2</h4><blockquote>
<p>MappingJackson2HttpMessageConverter로 jackson 2.0을 지원합니다</p>
</blockquote>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.codehaus.jackson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-mapper-asl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;org.codehaus.jackson&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!-- Jackson 2.0 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;com.fasterxml.jackson&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-databind<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;com.fasterxml.jackson&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-annotations<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;com.fasterxml.jackson&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>

<h4 id="Spring-4-0-0"><a href="#Spring-4-0-0" class="headerlink" title="Spring 4.0.0"></a>Spring 4.0.0</h4><blockquote>
<p>GsonHttpMessageConverter 지원<br>MappingJacksonHttpMessageConverter 미지원  </p>
</blockquote>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- Jackson 2.0 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;com.fasterxml.jackson&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-databind<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;com.fasterxml.jackson&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-annotations<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;com.fasterxml.jackson&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!-- gson --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.google.code.gson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>gson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>

<blockquote>
<p><a href="https://github.com/spring-projects/spring-framework/wiki/Migrating-to-Spring-Framework-4.x#jackson-1819">https://github.com/spring-projects/spring-framework/wiki/Migrating-to-Spring-Framework-4.x#jackson-1819</a><br>위 문서에 따르면 스프링 4.1 부터는 org.codehaus.jackson(1.8 or 1.9)의 지원을 중단하였습니다.  </p>
</blockquote>
<ul>
<li>버전별 메시지 컨버터 지원표</li>
</ul>
<table>
<thead>
<tr>
<th align="center">Spring Version</th>
<th align="center">org.codehaus.jackson(1.8 or 1.9)</th>
<th align="center">com.fasterxml.jackson(2.0)</th>
<th align="center">gson</th>
</tr>
</thead>
<tbody><tr>
<td align="center">3.0.x</td>
<td align="center">MappingJacksonHttpMessageConverter</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">3.1.2</td>
<td align="center">MappingJacksonHttpMessageConverter</td>
<td align="center">MappingJackson2HttpMessageConverter</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">4.+</td>
<td align="center"></td>
<td align="center">MappingJackson2HttpMessageConverter</td>
<td align="center">GsonHttpMessageConverter</td>
</tr>
</tbody></table>
<h3 id="Annotations"><a href="#Annotations" class="headerlink" title="Annotations"></a>Annotations</h3><blockquote>
<p>그럼 이제 스프링 컨트롤러에서 사용되는 어노테이션들을 알아보겠습니다.</p>
</blockquote>
<h4 id="RequestMapping"><a href="#RequestMapping" class="headerlink" title="@RequestMapping"></a>@RequestMapping</h4><p>@RequestMapping에는 요청과 응답과 관련한 프로퍼티를 설정할 수 있습니다.  produces와 consumes는 확실히 알고 넘어가셔야 합니다.  </p>
<ul>
<li>method&#x3D;RequestMethod.GET<br>method는 어떠한 요청 타입을 처리할 것인가를 결정하는 부분입니다.</li>
<li>produces&#x3D;MediaType.APPLICATION_JSON_VALUE<br>produces는 어떠한 데이터 형식으로 응답할 것인가를 결정하는 부분입니다.</li>
<li>consumes&#x3D;MediaType.APPLICATION_JSON_VALUE<br>consumes는 어떠한 요청에 대해서 처리할 것인가를 결정하는 부분입니다.</li>
</ul>
<blockquote>
<p>produces와 consumes 프로퍼티는 Spring 3.1에서 부터 지원합니다.  </p>
</blockquote>
<h4 id="ModelAttribute-ReqeustParam"><a href="#ModelAttribute-ReqeustParam" class="headerlink" title="@ModelAttribute, @ReqeustParam"></a>@ModelAttribute, @ReqeustParam</h4><p>이 두개의 어노테이션은 GET과 DELETE 요청에서 활용할 수 있습니다. 그 이유는 파라미터 값을 확인해서 데이터를 바인딩해주기 때문입니다. @RequestParam은 request.getParameter()로써 가져오는 반면에 @ModelAttribute는 자바 클래스의 Getter, Setter에 의해 데이터를 바인딩시키는 것입니다. 그렇기 때문에 만약 객체 단위로 바인딩하고 싶다면 @ModelAttribute를  이용해야 한다는 것입니다.</p>
<blockquote>
<p><em>직접 확인하고 싶으시다면 본 프로젝트를 동작시켜 ajaxList와 ajaxListModel의 차이를 확인하시기 바랍니다.</em>  </p>
</blockquote>
<h4 id="RequestBody"><a href="#RequestBody" class="headerlink" title="@RequestBody"></a>@RequestBody</h4><p>이 어노테이션은 POST와 PUT 처럼 데이터가 HTTP 요청 바디에 포함되는 경우에 이를 확인해서 데이터를 바인딩 해줍니다. 이 어노테이션의 중요한 부분은 GET 요청과 같이 파라미터를 통해 제공되는 데이터는 바인딩할 수 없다는 점입니다.</p>
<blockquote>
<p><em>직접 확인하고 싶으시다면 본 프로젝트를 동작시켜 ajaxMap와 ajaxMapGet의 차이를 확인하시기 바랍니다. ajaxMapGet의 요청이 왜 실패하는지에 대해서 서버측 로그를 살펴보시기 바랍니다.</em>  </p>
</blockquote>
<h4 id="ResponseBody"><a href="#ResponseBody" class="headerlink" title="@ResponseBody"></a>@ResponseBody</h4><p>이 어노테이션은 응답되는 데이터에 대하여 등록된 메시지 컨버터를 통해 변환시켜 응답하게 됩니다. 따라서, 뷰에 모델로서 데이터를 추가시켜 응답하는 것이 아니라 데이터를 HTTP 본문으로 응답하게 된다는 것입니다.  </p>
<blockquote>
<p><em>ajaxList와 ajaxListNobody를 통해서 @ResponseBody가 있을 경우랑 없을 경우를 비교해보세요. 왜 @ResponseBody가 없을 때 ViewResolver를 찾는 것 같나요?</em>  </p>
</blockquote>
<h4 id="RestController"><a href="#RestController" class="headerlink" title="@RestController"></a>@RestController</h4><p>이 어노테이션은 스프링 4 부터 지원합니다. 해당 컨트롤러의 메소드들에 @ResponseBody 어노테이션을 적용합니다. 좀 더 편의성을 제공한다고 보시면 됩니다.  </p>
<h2 id="Test-Case"><a href="#Test-Case" class="headerlink" title="Test Case"></a>Test Case</h2><p>본 프로젝트에서 현재 진행한 테스트 케이스는 다음과 같습니다.  </p>
<h4 id="1-GET-ResponseBody와-ModelAttribute-RequestParm을-확인할-수-있는-케이스"><a href="#1-GET-ResponseBody와-ModelAttribute-RequestParm을-확인할-수-있는-케이스" class="headerlink" title="1. GET, @ResponseBody와 @ModelAttribute, @RequestParm을 확인할 수 있는 케이스"></a>1. GET, @ResponseBody와 @ModelAttribute, @RequestParm을 확인할 수 있는 케이스</h4><h4 id="2-GET-1번과-동일하나-ModelAttribute를-통해서-객체-단위로-바인딩하는-것을-확인할-수-있는-케이스"><a href="#2-GET-1번과-동일하나-ModelAttribute를-통해서-객체-단위로-바인딩하는-것을-확인할-수-있는-케이스" class="headerlink" title="2. GET, 1번과 동일하나 @ModelAttribute를 통해서 객체 단위로 바인딩하는 것을 확인할 수 있는 케이스"></a>2. GET, 1번과 동일하나 @ModelAttribute를 통해서 객체 단위로 바인딩하는 것을 확인할 수 있는 케이스</h4><h4 id="3-GET-1번과-동일하나-ResponseBody를-지정하지-않았을-경우를-확인할-수-있는-케이스"><a href="#3-GET-1번과-동일하나-ResponseBody를-지정하지-않았을-경우를-확인할-수-있는-케이스" class="headerlink" title="3. GET, 1번과 동일하나 @ResponseBody를 지정하지 않았을 경우를 확인할 수 있는 케이스"></a>3. GET, 1번과 동일하나 @ResponseBody를 지정하지 않았을 경우를 확인할 수 있는 케이스</h4><h4 id="4-PUT-ResponseBody와-RequestBody를-지정했을-경우를-확인할-수-있는-케이스"><a href="#4-PUT-ResponseBody와-RequestBody를-지정했을-경우를-확인할-수-있는-케이스" class="headerlink" title="4. PUT, @ResponseBody와 @RequestBody를 지정했을 경우를 확인할 수 있는 케이스"></a>4. PUT, @ResponseBody와 @RequestBody를 지정했을 경우를 확인할 수 있는 케이스</h4><h4 id="5-GET-4번과-동일하나-GET-요청에-RequestBody를-지정했을-경우를-확인할-수-있는-케이스"><a href="#5-GET-4번과-동일하나-GET-요청에-RequestBody를-지정했을-경우를-확인할-수-있는-케이스" class="headerlink" title="5. GET, 4번과 동일하나 GET 요청에 @RequestBody를 지정했을 경우를 확인할 수 있는 케이스"></a>5. GET, 4번과 동일하나 GET 요청에 @RequestBody를 지정했을 경우를 확인할 수 있는 케이스</h4><h4 id="6-POST-ResponseEntity를-통해서-HttpStatus도-지정할-수-있는-것을-확인하는-케이스"><a href="#6-POST-ResponseEntity를-통해서-HttpStatus도-지정할-수-있는-것을-확인하는-케이스" class="headerlink" title="6. POST, ResponseEntity를 통해서 HttpStatus도 지정할 수 있는 것을 확인하는 케이스"></a>6. POST, ResponseEntity를 통해서 HttpStatus도 지정할 수 있는 것을 확인하는 케이스</h4><h4 id="7-POST-6번과-동일하나-ResponseBody를-지정하지-않을-경우를-확인할-수-있는-케이스"><a href="#7-POST-6번과-동일하나-ResponseBody를-지정하지-않을-경우를-확인할-수-있는-케이스" class="headerlink" title="7. POST, 6번과 동일하나 @ResponseBody를 지정하지 않을 경우를 확인할 수 있는 케이스"></a>7. POST, 6번과 동일하나 @ResponseBody를 지정하지 않을 경우를 확인할 수 있는 케이스</h4><h4 id="8-POST-7번과-동일하나-URL에-파라미터를-함께-요청시에-RequestParam-지원여부를-확인할-수-있는-케이스"><a href="#8-POST-7번과-동일하나-URL에-파라미터를-함께-요청시에-RequestParam-지원여부를-확인할-수-있는-케이스" class="headerlink" title="8. POST, 7번과 동일하나 URL에 파라미터를 함께 요청시에 @RequestParam 지원여부를 확인할 수 있는 케이스"></a>8. POST, 7번과 동일하나 URL에 파라미터를 함께 요청시에 @RequestParam 지원여부를 확인할 수 있는 케이스</h4><blockquote>
<p><em>6번과 7번은 의아해하실 수 있으실 겁니다. 이와 관련된 정보는 <a href="http://okky.kr/article/311196">여기</a>에서 확인하실 수 있습니다. 간단히 말하면 ResponseEntity는 응답 헤더와 바디를 가지는 객체를 응답하는 것이라고 보면 됩니다.</em></p>
</blockquote>
<h2 id="마지막으로-초보자들이-잘못-사용하거나-접근하는-경우를-알아봅시다"><a href="#마지막으로-초보자들이-잘못-사용하거나-접근하는-경우를-알아봅시다" class="headerlink" title="마지막으로 초보자들이 잘못 사용하거나 접근하는 경우를 알아봅시다."></a>마지막으로 초보자들이 잘못 사용하거나 접근하는 경우를 알아봅시다.</h2><blockquote>
<p>Okky에서 Ajax 관련 질문이 올라온다면 지속적으로 추가하도록 하겠습니다.</p>
</blockquote>
<h4 id="1-저는-제대로-구현한-것-같은데-에러로-응답받습니다"><a href="#1-저는-제대로-구현한-것-같은데-에러로-응답받습니다" class="headerlink" title="1. 저는 제대로 구현한 것 같은데 에러로 응답받습니다."></a>1. 저는 제대로 구현한 것 같은데 에러로 응답받습니다.</h4><ul>
<li>dataType을 지정한 뒤 그 형식으로 응답하지 않는다면 정상적으로 응답해도 에러 콜백이 호출될 가능성이 있습니다. 예를 들어, 스프링 컨트롤러에서는 문자열이나 null을 응답하는데 ajax에서는 json으로 지정할 경우에는 서버에서는 정상적으로 응답되지만 클라이언트에서는 해당 데이터를 json으로 파싱할 수 없기 때문에 에러 콜백이 호출됩니다.</li>
</ul>
<blockquote>
<p>대부분의 Ajax 관련 질문은 여기에 해당되는 경우가 많았습니다. 단순히 error가 난다고 해서 정상적으로 응답받지 못했다고 판단하고 계셨습니다. 서버는 html문서를 응답하는데 ajax 데이터 형식이 json이면 오류가 난다는 것을 기억해주시기 바랍니다.</p>
</blockquote>
<h4 id="2-데이터를-서버에서-받아올-수-없습니다"><a href="#2-데이터를-서버에서-받아올-수-없습니다" class="headerlink" title="2. 데이터를 서버에서 받아올 수 없습니다."></a>2. 데이터를 서버에서 받아올 수 없습니다.</h4><ul>
<li>요청 메소드 타입이 GET일 때 processData를 false로 지정할 경우에는 데이터를 url에 직접 포함시켜줘야 합니다.  만약, POST같은 요청의 경우에는 데이터가 요청 바디에 포함되어져야 한다는 것을 잊지 마시기 바랍니다.</li>
</ul>
<blockquote>
<p>POST의 경우에도 url에 파라미터가 포함된다면 @RequestParam 어노테이션을 통해 받아올 수 있습니다.</p>
</blockquote>
<h4 id="3-GET-요청을-통해-보내는데-일정-데이터-크기이상-보내지지-않습니다"><a href="#3-GET-요청을-통해-보내는데-일정-데이터-크기이상-보내지지-않습니다" class="headerlink" title="3. GET 요청을 통해 보내는데 일정 데이터 크기이상 보내지지 않습니다."></a>3. GET 요청을 통해 보내는데 일정 데이터 크기이상 보내지지 않습니다.</h4><ul>
<li>브라우저별로 URL의 지원 크기가 다릅니다. 그렇기 때문에 POST로 요청 바디에 데이터를 포함시켜 보내는 이유도 바로 이 때문입니다. 물론 서버 측에서도 요청 바디에 대한 크기를 제한할 수 도 있습니다.</li>
</ul>
<blockquote>
<p>많은 신입 면접시에 GET과 POST의 차이를 묻는 이유이기도 합니다. 단순히 보안 때문에 구분해서 사용하는 것은 아니라는 점입니다.</p>
</blockquote>
<h4 id="4-406-Not-Acceptable-응답해요-ㅠㅠ-2017-02-14"><a href="#4-406-Not-Acceptable-응답해요-ㅠㅠ-2017-02-14" class="headerlink" title="4. 406 - Not Acceptable 응답해요 ㅠㅠ  [2017-02-14]"></a>4. 406 - Not Acceptable 응답해요 ㅠㅠ  [2017-02-14]</h4><ul>
<li>혹시 @ResponseBody로 List나 Map을 응답하고 계신가요? 응답하기 위해서는 annotation-driven 설정이 되어있어야 하고 요청하는 응답 데이터로 변환할 수 있도록 메시지 컨버터가 필요합니다.</li>
</ul>
<blockquote>
<p>스프링 버전에 따라서 다르겠지만 스프링 3 부터는 annotation-driven 설정을 하고 jackson 라이브러리르 추가한다면 디폴트 전략으로 메시지컨버터가 등록됩니다.  </p>
</blockquote>
<h4 id="5-MessageConverter를-이용하고-싶지-않아요-2017-04-20"><a href="#5-MessageConverter를-이용하고-싶지-않아요-2017-04-20" class="headerlink" title="5. MessageConverter를 이용하고 싶지 않아요 [2017-04-20]"></a>5. MessageConverter를 이용하고 싶지 않아요 [2017-04-20]</h4><ul>
<li>메시지 컨버터를 이용하지 않고도 JSON으로 응답할 수 있는 방법이 있습니다. 바로 ContentNegotiatingViewResolver를 이용하면 됩니다. 확장자를 이용하는 방식입니다.</li>
</ul>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">beans:</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.web.servlet.view.ContentNegotiatingViewResolver<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
	    <span class="token comment">&lt;!-- ViewResolver 우선순위 설정 --></span>
	    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">beans:</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>order<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
	    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">beans:</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mediaTypes<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
	        <span class="token comment">&lt;!-- 맵핑될 확장자 정의 --></span>
	        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">beans:</span>map</span><span class="token punctuation">></span></span>
	            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">beans:</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>json<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>application/json<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
	        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">beans:</span>map</span><span class="token punctuation">></span></span>
	    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">beans:</span>property</span><span class="token punctuation">></span></span>
	    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">beans:</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>defaultViews<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
	        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">beans:</span>list</span><span class="token punctuation">></span></span>
	            <span class="token comment">&lt;!-- JSON 요청을 처리할 뷰 --></span>
	            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">beans:</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.web.servlet.view.json.MappingJacksonJsonView<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
	        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">beans:</span>list</span><span class="token punctuation">></span></span>
	    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">beans:</span>property</span><span class="token punctuation">></span></span>
	    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">beans:</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ignoreAcceptHeader<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">beans:</span>bean</span><span class="token punctuation">></span></span></code></pre>

<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api/test.json"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">api</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ModelMap</span> map<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"Message Bean"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"response"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>ModelMap에 추가하여 JSON 형태로 출력할 수 있게 됩니다.</p>
</blockquote>
<p>참조 : <a href="http://ismydream.tistory.com/139">http://ismydream.tistory.com/139</a></p>
]]></content>
      <tags>
        <tag>Spring</tag>
        <tag>AJAX</tag>
      </tags>
  </entry>
  <entry>
    <title>초보가 이해하는 스프링 시큐리티</title>
    <url>/understanding-spring-security/</url>
    <content><![CDATA[<blockquote>
<p>본 글은 OKKY에 공유된 <a href="https://okky.kr/article/382738">초보가 이해하는 스프링 시큐리티</a> 입니다.</p>
</blockquote>
<h2 id="들어가며"><a href="#들어가며" class="headerlink" title="들어가며"></a>들어가며</h2><h2 id="스프링-시큐리티란-무엇인가"><a href="#스프링-시큐리티란-무엇인가" class="headerlink" title="스프링 시큐리티란 무엇인가?"></a>스프링 시큐리티란 무엇인가?</h2><p>스프링 시큐리티를 이해하기 위해서 스프링 시큐리티가 무엇인지를 알아야합니다. 스프링 시큐리티 레퍼런스에서는 자바 EE 기반의 엔터프라이즈 소프트웨어 애플리케이션을 위한 포괄적인 보안 서비스들을 제공하고 오픈 플랫폼이면서 자신만의 인증 매커니즘을 간단하게 만들 수 있다고 자랑(?)하고 있습니다.</p>
<p>하지만, 신입 개발자들 수준에서 스프링 시큐리티와 같은 보안 기술을 이해하기란 참 힘든 과정이라고 생각합니다.</p>
<blockquote>
<p>저만 이해하기 힘들 수 있어요 ㅠㅠ  </p>
</blockquote>
<p>스프링 시큐리티를 이해하기 위해서는 스프링 시큐리티가 애플리케이션 보안을 구성하는 두가지 영역에 대해서 알아야 합니다. 바로 인증(Authentication)과 권한(Authorization)이라는 것입니다. 이 두 영역은 스프링 시큐리티의 목표이기 때문에 반드시 이해하고 넘어가야 합니다. <code>인증</code>은 애플리케이션의 작업을 수행할 수 있는 주체(사용자)라고 주장할 수 있는 것을 말하며 권한은 인증된 주체가 애플리케이션의 동작을 수행할 수 있도록 허락되있는지를 결정하는 것을 말합니다. 따라서, 권한 승인이 필요한 부분으로 접근하려면 인증 과정을 통해 주체가 증명 되어야만 한다는 것입니다.   </p>
<p>앞서 스프링 시큐리티는 자신만의 인증 매커니즘을 간단하게 만들 수 있다고 자랑한다고 했는데요. 스프링 시큐리티는 이와 관련해서 인증 매커니즘과 관계없이 상당히 깊은 권한 부여를 제공하고 있습니다. 권한 부여에도 두가지 영역이 존재하는데 웹 요청 권한, 메소드 호출 및 도메인 인스턴스에 대한 접근 권한 부여입니다. 스프링 시큐리티는 이렇게 모든 중요한 영역에 필요한 기능을 제공하고 있습니다.</p>
<p><a href="http://zgundam.tistory.com/43">제타건담님의 글</a>에서는 로그인 화면을 통해서 아이디와 비밀번호를 입력받아 로그인하는 과정을 인증이라고 서술하고 있습니다. 이와 관련된 용어가 바로 HTTP 기본 인증(HTTP Basic Authentication) 매커니즘이라고 할 수 있습니다. 그리고 이 HTTP 기본 인증 매커니즘을 이용하는 방식이 바로 스프링 시큐리티 레퍼런스에서 설명하는 폼 기반 로그인이 됩니다.  </p>
<blockquote>
<p>아 물론, HTTP 기본 인증 &#x3D;&#x3D; 폼 기반 로그인이라는 말은 아닙니다. 폼 양식을 통한 로그인도 username과 password를 통해 인증하기 때문에 HTTP 기본 인증 매커니즘을 이용하는 방식이라고 이해할 수 있다는 것입니다.  </p>
</blockquote>
<p>실제로 <a href="http://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#basic">스프링 시큐리티 레퍼런스 문서의 Basic and Digest Authentication</a>에서는 다음을 언급하고 있습니다.  </p>
<p>Basic authentication is often used with stateless clients which pass their credentials on each request. It’s quite common to use it in combination with form-based authentication where an application is used through both a browser-based user interface and as a web-service.</p>
<blockquote>
<p>인증과 권한이라는 개념을 이해하셨다면 스프링 시큐리티에 대해서 배워보도록 하겠습니다.</p>
</blockquote>
<h3 id="스프링-시큐리티-시작하기"><a href="#스프링-시큐리티-시작하기" class="headerlink" title="스프링 시큐리티 시작하기"></a>스프링 시큐리티 시작하기</h3><p>스프링 시큐리티는 메이븐이나 그래들같은 빌드도구를 통해 쉽게 가져올 수 있습니다.  </p>
<h4 id="with-Maven"><a href="#with-Maven" class="headerlink" title="with Maven"></a>with Maven</h4><pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!-- ... other dependency elements ... --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-security-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.2.2.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-security-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.2.2.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></code></pre>

<h4 id="with-Gradle"><a href="#with-Gradle" class="headerlink" title="with Gradle"></a>with Gradle</h4><pre class="language-javascript" data-language="javascript"><code class="language-javascript">dependencies <span class="token punctuation">&#123;</span>
	compile <span class="token string">'org.springframework.security:spring-security-web:4.2.2.RELEASE'</span>
	compile <span class="token string">'org.springframework.security:spring-security-config:4.2.2.RELEASE'</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>저는 메이븐 대신 그래들을 사용해봤습니다.</p>
</blockquote>
<h3 id="Java-Configuration"><a href="#Java-Configuration" class="headerlink" title="Java Configuration"></a>Java Configuration</h3><p>스프링 시큐리티 레퍼런스에서는 자바 기반의 설정으로 설명하고 있습니다. 그 이유는 무엇일까요?  </p>
<p>스프링 프레임워크 3.1에서부터 어노테이션을 통한 자바 설정을 지원하기 때문에 스프링 시큐리티 3.2부터는 XML로 설정하지 않고도 간단하게 설정할 수 있도록 지원하기 때문입니다.  </p>
<p>원래 XML 기반의 설정에서는 web.xml에 org.springframework.web.filter.DelegatingFilterProxy라는 springSecurityFilterChain을 등록하는 것으로 시작합니다만, 자바 기반의 설정에서는 WebSecurityConfigurerAdapter를 상속받은 클래스에 @EnableWebSecurity 어노테이션을 명시하는 것만으로도 springSecurityFilterChain가 자동으로 포함되어집니다.    </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>그리고 포함된 springSecurityFilterChain을 등록하기 위해서는 AbstractSecurityWebApplicationInitializer를 상속받은 WebApplicationInitializer를 만들어두면 됩니다.  </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityWebApplicationInitializer</span>
	<span class="token keyword">extends</span> <span class="token class-name">AbstractSecurityWebApplicationInitializer</span> <span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>XML을 작성하는 것보다는 자바 기반의 구성이 더욱 쉽습니다.  </p>
</blockquote>
<p>그 다음에는 보통 스프링 MVC를 이용해서 애플리케이션을 구성하기 때문에 ApplicationIniticalizer에 WebSecurityConfigurerAdapter를 상속받은 클래스를 getRootConfigClasses() 메소드에 추가하는 것으로 스프링 시큐리티에 대한 기본적인 적용은 끝입니다.  </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationInitializer</span> <span class="token keyword">extends</span>
		<span class="token class-name">AbstractAnnotationConfigDispatcherServletInitializer</span> <span class="token punctuation">&#123;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getRootConfigClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token class-name">WebSecurityConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// ... other overrides ...</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>이로써 유추 해볼때, springSecurityFilterChain은 루트 컨텍스트에서 등록되어야하는 것을 알 수 있겠습니다. 각 필터에 대한 우선순위에 대해서도 추가적으로 알 필요성이 생기는 부분입니다.    </p>
</blockquote>
<h4 id="HttpSecurity"><a href="#HttpSecurity" class="headerlink" title="HttpSecurity"></a>HttpSecurity</h4><p>그리고나서 configure(HttpSecurity http) 메소드를 통해서 우리만의 인증 매커니즘을 구성해야합니다. 그런데 아직까지는 어떻게 구성해야할지 막막하기만 합니다. 관련된 정보를 좀더 찾아보도록 하겠습니다.  </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
	http<span class="token punctuation">.</span><span class="token function">httpBasic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/users/&#123;userId&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"@authenticationCheckHandler.checkUserId(authentication,#userId)"</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/admin/db/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"hasRole('ADMIN_MASTER') or hasRole('ADMIN') and hasRole('DBA')"</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/register/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"ANONYMOUS"</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">"email"</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span><span class="token function">successHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span><span class="token function">failureHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>뭐 사실상 별게 없습니다. HttpSecurity의 인스턴스를 통해 자신만의 인증 매커니즘을 만들 수 있는 것이라고 보면 됩니다. 대부분의 설정은 여기를 통하게 되니까요 .authorizeRequests()를 통해 요청에 대한 권한을 지정할 수 있게 되는 것 같습니다. 그리고 기본적인 형태의 <code>.anyRequest().authenticated()</code>라는 의미는 어떠한 요청이든지 인증되어야한다는 것이겟죠? .formLogin()은 폼을 통한 로그인을 이용한다는 의미이며, .loginPage(“&#x2F;login”)을 통해 로그인 페이지는 &#x2F;login 경로로 제공하며 &#x2F;login의 POST 요청이 바로 로그인 처리 과정이라는 것입니다.  </p>
<p>확장된 형태에서의 .antMatchers().hasRole() 또는 .antMatchers().access()는 해당 경로에 대해서 어떠한 권한을 가져야만 접근할 수 있는가를 표현하는 것입니다. 다음은 antMatchers() 다음으로 지정할 수 있는 항목들입니다.  </p>
<ul>
<li>anonymous()<br>인증되지 않은 사용자가 접근할 수 있습니다.  </li>
<li>authenticated()<br>인증된 사용자만 접근할 수 있습니다.  </li>
<li>fullyAuthenticated()<br>완전히 인증된 사용자만 접근할 수 있습니다(?)  </li>
<li>hasRole() or hasAnyRole()<br>특정 권한을 가지는 사용자만 접근할 수 있습니다.  </li>
<li>hasAuthority() or hasAnyAuthority()<br>특정 권한을 가지는 사용자만 접근할 수 있습니다.  </li>
<li>hasIpAddress()<br>특정 아이피 주소를 가지는 사용자만 접근할 수 있습니다.  </li>
<li>access()<br>SpEL 표현식에 의한 결과에 따라 접근할 수 있습니다.  </li>
<li>not()<br>접근 제한 기능을 해제합니다.   </li>
<li>permitAll() or denyAll()<br>접근을 전부 허용하거나 제한합니다.  </li>
<li>rememberMe()<br>리멤버 기능을 통해 로그인한 사용자만 접근할 수 있습니다.</li>
</ul>
<blockquote>
<p>Role은 역할이고 Authority는 권한이지만 사실은 표현의 차이입니다. Role은 “ADMIN”으로 표현하고 Authority는 “ROLE_ADMIN”으로 표기하는 것 뿐입니다. 실제로 hasRole()에 ROLE_ADMIN으로 표기하면 ROLE을 지우라는 에러를 볼수 있게 됩니다.  </p>
</blockquote>
<blockquote>
<p>스프링 시큐리티 태그 라이브러리 또한 SpEL 표현식을 사용할 수 있습니다. &lt;sec:authentication /&gt; 이렇게 말입니다.  </p>
</blockquote>
<h4 id="AuthenticationManagerBuilder"><a href="#AuthenticationManagerBuilder" class="headerlink" title="AuthenticationManagerBuilder"></a>AuthenticationManagerBuilder</h4><p>AuthenticationManagerBuilder를 통해 인증 객체를 만들 수 있도록 제공하고 있습니다. 아래는 스프링 시큐리티 레퍼런스에서 알려주는 방식인데 AuthenticationManagerBuilder를 메소드를 통해 주입받아 처리하는 방식입니다. WebSecurityConfigurerAdapter의 configure(AuthenticationManagerBuilder auth)를 오버라이딩하는 것에 대한 차이는 없습니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configureGlobal</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
	auth<span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"scott"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"tiger"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"ROLE_USER"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// TODO Auto-generated method stub</span>
	auth<span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"ADMIN"</span><span class="token punctuation">,</span> <span class="token string">"DBA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	auth<span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"scott"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"tiger"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"USER"</span><span class="token punctuation">,</span> <span class="token string">"SETTING"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>원하는 방식을 사용하면 됩니다. 하지만, 스프링 시큐리티 레퍼런스와 샘플을 만든 개발자가 왜 첫번째 방식으로 설명하는지에 대한 의미를 생각해봅시다.  </p>
<blockquote>
<p>아시는 분이 있다면 알려주시면 감사하겠습니다.  </p>
</blockquote>
<h3 id="스프링-시큐리티-속으로-들어가기"><a href="#스프링-시큐리티-속으로-들어가기" class="headerlink" title="스프링 시큐리티 속으로 들어가기"></a>스프링 시큐리티 속으로 들어가기</h3><p>지금까지 했던 설정들은 아주 기본적인 형태들이기 때문에 실제로 우리만의 인증 매커니즘으로 커스터마이징을 한 뒤 스프링 시큐리티에서 제공하는 부가적인 기능을 추가해야합니다.  </p>
<h4 id="Method-Security"><a href="#Method-Security" class="headerlink" title="Method Security"></a>Method Security</h4><p>스프링 시큐리티 2.0 에서부터 서비스 계층의 메소드에 보안을 추가할 수 있도록 지원합니다. @Secured 어노테이션 뿐만 아니라 JSR-250 어노테이션도 지원하도록 제공됩니다. 스프링 시큐리티 3.0에서는 표현 기반의 어노테이션을 사용할 수 있게 됩니다.  </p>
<p>우리는 Configuration 클래스에 @EnableGlobalMethodSecurity를 적용함으로써 어노테이션 기반의 보안을 활성화시킬 수 있습니다. 예를 들어, 스프링 시큐리티의 @Secured 어노테이션을 활성화시키려면 다음과 같이 구성하게 됩니다.  </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token punctuation">&#123;</span>
<span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>그리고나서 클래스 또는 인터페이스의 메소드에 @Secured 어노테이션을 추가하면 그에 따른 해당 메소드에 대한 액세스가 제한됩니다.  </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BankService</span> <span class="token punctuation">&#123;</span>

<span class="token annotation punctuation">@Secured</span><span class="token punctuation">(</span><span class="token string">"IS_AUTHENTICATED_ANONYMOUSLY"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Account</span> <span class="token function">readAccount</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Secured</span><span class="token punctuation">(</span><span class="token string">"IS_AUTHENTICATED_ANONYMOUSLY"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Account</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">findAccounts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Secured</span><span class="token punctuation">(</span><span class="token string">"ROLE_TELLER"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Account</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token class-name">Account</span> account<span class="token punctuation">,</span> <span class="token keyword">double</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>역할 단위로 제약조건을 지정할 수 있음을 알 수 있습니다.</p>
</blockquote>
<p>스프링 시큐리티 3.0부터 지원하는 표현식 기반의 문법을 사용하기 위해서는 다음과 같이 구성합니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MethodSecurityConfig</span> <span class="token punctuation">&#123;</span>
<span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span></code></pre>

<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BankService</span> <span class="token punctuation">&#123;</span>

<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"isAnonymous()"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Account</span> <span class="token function">readAccount</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"isAnonymous()"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Account</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">findAccounts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAuthority('ROLE_TELLER')"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Account</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token class-name">Account</span> account<span class="token punctuation">,</span> <span class="token keyword">double</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="Remember-Me"><a href="#Remember-Me" class="headerlink" title="Remember-Me"></a>Remember-Me</h4><p>리멤버-미 기능은 도대체 무엇일까요? 구글에 what is remember me 라는 키워드로 검색을 해보았습니다.</p>
<ul>
<li><a href="https://www.formsite.com/faq/general/What-does-Remember-Me-mean-on-the-Login-page.html">What-does-Remember-Me-mean-on-the-Login-page</a>  </li>
<li><a href="http://help.thunderbird.edu/portal-login/remember-me">What is “Remember Me” ?</a></li>
</ul>
<p>단순히 아이디를 기억해놓는 것이 아니라 로그인 정보를 유지하는 것을 말합니다.  </p>
<p>Do NOT use “Remember Me” on any public computer, on campus, in Internet cafe’s, or anywhere else where you cannot control access!</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
	http<span class="token punctuation">.</span><span class="token function">rememberMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rememberMeParameter</span><span class="token punctuation">(</span><span class="token string">"remember-me"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span>REMEMBER_ME_KEY<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rememberMeServices</span><span class="token punctuation">(</span><span class="token function">persistentTokenBasedRememberMeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">PersistentTokenBasedRememberMeServices</span> <span class="token function">persistentTokenBasedRememberMeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token class-name">PersistentTokenBasedRememberMeServices</span> persistentTokenBasedRememberMeServices <span class="token operator">=</span>
			<span class="token keyword">new</span> <span class="token class-name">PersistentTokenBasedRememberMeServices</span><span class="token punctuation">(</span>REMEMBER_ME_KEY<span class="token punctuation">,</span> userDetailsService<span class="token punctuation">,</span> <span class="token function">persistentTokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> persistentTokenBasedRememberMeServices<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">PersistentTokenRepository</span> <span class="token function">persistentTokenRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token class-name">TokenRepositoryImpl</span> tokenRepositoryImpl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenRepositoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> tokenRepositoryImpl<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>저는 영속성 기반의 리멤버-미 기능을 추가하였습니다. 이때, 리멤버-미 토큰을 저장할 수 있도록 TokenRepository 인터페이스를 구현해야하는데요. 일종의 서비스 객체라고 생각하시면 됩니다.  </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenRepositoryImpl</span>  <span class="token keyword">implements</span> <span class="token class-name">PersistentTokenRepository</span> <span class="token punctuation">&#123;</span>

	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">TokenRepository</span> tokenRepository<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createNewToken</span><span class="token punctuation">(</span><span class="token class-name">PersistentRememberMeToken</span> token<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// TODO Auto-generated method stub</span>
		<span class="token class-name">Token</span> newToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		newToken<span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		newToken<span class="token punctuation">.</span><span class="token function">setToken</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getTokenValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		newToken<span class="token punctuation">.</span><span class="token function">setLast_used</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		newToken<span class="token punctuation">.</span><span class="token function">setSeries</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getSeries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		tokenRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>newToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> series<span class="token punctuation">,</span> <span class="token class-name">String</span> tokenValue<span class="token punctuation">,</span> <span class="token class-name">Date</span> lastUsed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// TODO Auto-generated method stub</span>

		<span class="token class-name">Token</span> updateToken <span class="token operator">=</span> tokenRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>series<span class="token punctuation">)</span><span class="token punctuation">;</span>
		updateToken<span class="token punctuation">.</span><span class="token function">setToken</span><span class="token punctuation">(</span>tokenValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
		updateToken<span class="token punctuation">.</span><span class="token function">setLast_used</span><span class="token punctuation">(</span>lastUsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
		updateToken<span class="token punctuation">.</span><span class="token function">setSeries</span><span class="token punctuation">(</span>series<span class="token punctuation">)</span><span class="token punctuation">;</span>
		tokenRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>updateToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">PersistentRememberMeToken</span> <span class="token function">getTokenForSeries</span><span class="token punctuation">(</span><span class="token class-name">String</span> series<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// TODO Auto-generated method stub</span>
		<span class="token class-name">Token</span> token <span class="token operator">=</span> tokenRepository<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>series<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">PersistentRememberMeToken</span> persistentRememberMeToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PersistentRememberMeToken</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> series<span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">getLast_used</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> persistentRememberMeToken<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeUserTokens</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// TODO Auto-generated method stub</span>
		tokenRepository<span class="token punctuation">.</span><span class="token function">deleteByEmail</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><code>본 애플리케이션에서의 Email은 유니크한 속성을 가집니다.</code></p>
<h4 id="Password-Encoding"><a href="#Password-Encoding" class="headerlink" title="Password Encoding"></a>Password Encoding</h4><p>AuthenticationManagerBuilder.userDetailsService().passwordEncoder()를 통해 패스워드 암호화에 사용될 PasswordEncoder 구현체를 지정할 수 있습니다. PasswordEncoder 인터페이스는 다음과 같이 구성되어 있습니다.  </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PasswordEncoder</span> <span class="token punctuation">&#123;</span>

	<span class="token comment">/**
	 * Encode the raw password. Generally, a good encoding algorithm applies a SHA-1 or
	 * greater hash combined with an 8-byte or greater randomly generated salt.
	 */</span>
	<span class="token class-name">String</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span> rawPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * Verify the encoded password obtained from storage matches the submitted raw
	 * password after it too is encoded. Returns true if the passwords match, false if
	 * they do not. The stored password itself is never decoded.
	 *
	 * @param rawPassword the raw password to encode and match
	 * @param encodedPassword the encoded password from storage to compare with
	 * @return true if the raw password, after encoding, matches the encoded password from
	 * storage
	 */</span>
	<span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span> rawPassword<span class="token punctuation">,</span> <span class="token class-name">String</span> encodedPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<blockquote>
<p>단순히 인코딩하는 함수와 평문으로 제공되는 패스워드와 인코딩되어있는 패스워드(예를들어, 데이터베이스에 인코딩되어 저장되어 있는 패스워드)를 비교할 수 있습니다.  </p>
</blockquote>
<p>저는 PasswordEncoder 구현체인 BCryptPasswordEncoder를 지정했습니다. 당연히 직접 구현체를 만들어서 적용해도 됩니다! (아무래도 직접 만들어서 사용하는 것이 더 좋겟죠?)  </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// TODO Auto-generated method stub</span>
	auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>PasswordEncoder를 빈으로 등록해두면 다음과 같이 저장된 패스워드를 비교할 수 있습니다. 저장된 패스워드는 PasswordEncoder에 의해 암호화된 평문이기 때문입니다.</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"/users/&#123;userId&#125;"</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"#updateUser.email == authentication.name"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@ModelAttribute</span> <span class="token annotation punctuation">@Valid</span> <span class="token class-name">UserDTO<span class="token punctuation">.</span>Update</span> updateUser<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token class-name">User</span> currentUser <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>updateUser<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> currentUser<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Not password equals..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">//...</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="WebSecurity-Ignoring"><a href="#WebSecurity-Ignoring" class="headerlink" title="WebSecurity Ignoring"></a>WebSecurity Ignoring</h4><p>스프링 시큐리티 레퍼런스와는 달리 리소스와 관련해서는 <code>WebSecurity.ignoring()</code>를 이용해서 보안이 적용되지 않도록 할 수 있도록 지원합니다. 스프링 시큐리티 API 문서에서 확인할 수 있는데 레퍼런스에 설명이 없다는 것이 좀 아쉬운 부분입니다.  </p>
<p><code>음... permitAll과 ignoring의 차이가 있는가를 아시는분은 댓글 남겨주시기 바랍니다 ㅠㅠ</code>  </p>
<h4 id="Localization"><a href="#Localization" class="headerlink" title="Localization"></a>Localization</h4><p>스프링 시큐리티는 메시지에 대한 현지화를 지원합니다. 메시지 소스 관련 프로퍼티 파일들은 spring-security-core.jar에 포함 되어져있습니다.  </p>
<p>우리는 메시지 프로퍼티 파일들을 메시지소스로 등록하면 됩니다.  </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">WebMvcConfigurerAdapter</span> <span class="token punctuation">&#123;</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">MessageSource</span> <span class="token function">messageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token class-name">ResourceBundleMessageSource</span> messageSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceBundleMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		messageSource<span class="token punctuation">.</span><span class="token function">addBasenames</span><span class="token punctuation">(</span><span class="token string">"security/messages"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		messageSource<span class="token punctuation">.</span><span class="token function">setDefaultEncoding</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> messageSource<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">LocaleChangeInterceptor</span> <span class="token function">localeChangeInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token class-name">LocaleChangeInterceptor</span> localeChangeInterceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocaleChangeInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		localeChangeInterceptor<span class="token punctuation">.</span><span class="token function">setParamName</span><span class="token punctuation">(</span><span class="token string">"lang"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> localeChangeInterceptor<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">LocaleResolver</span> <span class="token function">localeResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token class-name">SessionLocaleResolver</span> localeResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionLocaleResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		localeResolver<span class="token punctuation">.</span><span class="token function">setDefaultLocale</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>KOREAN<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> localeResolver<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// TODO Auto-generated method stub</span>
		registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token function">localeChangeInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<blockquote>
<p>메시지 프로퍼티 파일들은 src&#x2F;main&#x2F;resource&#x2F;security 폴더에 위치하고 있습니다.</p>
</blockquote>
<h4 id="AuthenticationSuccessHandler-amp-AuthenticationFailureHandler"><a href="#AuthenticationSuccessHandler-amp-AuthenticationFailureHandler" class="headerlink" title="AuthenticationSuccessHandler &amp; AuthenticationFailureHandler"></a>AuthenticationSuccessHandler &amp; AuthenticationFailureHandler</h4><p>OKKY의 질문게시판에서 로그인 실패를 어떻게 체크하는가에 대해서 질문하는 글을 보았습니다. 저는 스프링 시큐리티에서 사용하는 AuthenticationFailureHandler 구현체를 상속받아서 처리하도록 하겠습니다.  </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthenticationSuccessHandlerImpl</span> <span class="token keyword">extends</span> <span class="token class-name">SavedRequestAwareAuthenticationSuccessHandler</span>  <span class="token punctuation">&#123;</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationSuccessHandlerImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
			<span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>
		logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Login Success... - &#123;&#125;"</span><span class="token punctuation">,</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span><span class="token string">"/?login"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>

<p>AuthenticationSuccessHandler 구현체에서는 로그인을 성공했을때 호출(인증 객체가 생성되어진 후)되기 때문에 Authentication 인스턴스 파라미터를 이용할 수 있습니다. authentication.getPrincipal()을 호출하게 되면 저 같은 경우에는 org.springframework.security.core.userdetails.User 가 아닌 com.kdev.app.security.userdetails.UserDetails를 이용할 수 있습니다.  </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthenticationFailureHandlerImpl</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleUrlAuthenticationFailureHandler</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationFailureHandlerImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">AuthenticationFailureHandlerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setDefaultFailureUrl</span><span class="token punctuation">(</span><span class="token string">"/login?error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
			<span class="token class-name">AuthenticationException</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>
		logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Login Failed... - &#123;&#125;"</span><span class="token punctuation">,</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"email"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>

<p>로그인 실패 시 SimpleUrlAuthenticationFailureHandler의 defaultFailureUrl를 지정하면 SPRING_SECURITY_LAST_EXCEPTION에 대한 정보를 가지면서 해당 경로로 이동하게 됩니다.  </p>
<p>AuthenticationException으로 로그인 실패의 이유도 체크할 수 있게 되죠  </p>
<h3 id="스프링-시큐리티-페이지"><a href="#스프링-시큐리티-페이지" class="headerlink" title="스프링 시큐리티 페이지"></a>스프링 시큐리티 페이지</h3><p>스프링 시큐리티에서 제공해주는 기본 로그인 페이지 대신에 우리만의 로그인 페이지를 만들어보도록 하겠습니다.  </p>
<pre class="language-markup" data-language="markup"><code class="language-markup">&lt;%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
&lt;%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec" %>
&lt;%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ko<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>IE=edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
	<span class="token comment">&lt;!--
		&lt;meta id="_csrf" name="_csrf" content="$&#123;_csrf.token&#125;" />
		&lt;meta id="_csrf_header" name="_csrf_header" content="$&#123;_csrf.headerName&#125;" />
	 --></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">sec:</span>csrfMetaTags</span> <span class="token punctuation">/></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Spring Security + JPA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">integrity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>page-header<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
	  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Login Page <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>small</span><span class="token punctuation">></span></span>with Bootstrap<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>small</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container-fluid<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/login<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
		&lt;%-- <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;_csrf.parameterName&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;_csrf.token&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span> --%>
		  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">sec:</span>csrfInput</span> <span class="token punctuation">/></span></span>
		  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>이메일<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Email<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>
		  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
		  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>비밀번호<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Password<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>
		  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
		  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>
		      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>remember-me<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span> Remember me
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>
		  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
		  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text-center<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
		  	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">c:</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;not empty SPRING_SECURITY_LAST_EXCEPTION&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
		  		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text-danger<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">c:</span>out</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;SPRING_SECURITY_LAST_EXCEPTION.message&#125;<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
		  		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">c:</span>remove</span> <span class="token attr-name">var</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SPRING_SECURITY_LAST_EXCEPTION<span class="token punctuation">"</span></span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>session<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
		  	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">c:</span>if</span><span class="token punctuation">></span></span>
		  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
		  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span>
		  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-default<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>로그인<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
		  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-default<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/register<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>회원가입<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--[if lt IE 9]>
   &lt;script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js">&lt;/script>
   &lt;script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js">&lt;/script>
&lt;![endif]--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js<span class="token punctuation">"</span></span> <span class="token attr-name">integrity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>

<p><code>SPRING_SECURITY_LAST_EXCEPTION</code>의 존재 여부에 따라서 스프링 시큐리티에서 발생하는 예외에 대한 메시지를 출력할 수 있습니다.  </p>
<blockquote>
<p>스프링 시큐리티 레퍼런스에서는 단순히 파라미터의 존재여부에 따라서 출력형태를 지정하고 있습니다. 이 부분도 참 아쉽습니다.  </p>
</blockquote>
<h3 id="UserDetails-amp-UserDetailsService"><a href="#UserDetails-amp-UserDetailsService" class="headerlink" title="UserDetails &amp; UserDetailsService"></a>UserDetails &amp; UserDetailsService</h3><p>아 죄송합니다. UserDetails 인터페이스에 대해서 설명을 안했네요 ㅠㅠ  </p>
<p>스프링 시큐리티는 사용자 정보를 UserDetails 구현체로 사용합니다. 그래서 스프링 시큐리티는 org.springframework.security.core.userdetails.User라는 클래스를 제공합니다. 그러나, 이름과 패스워드 그리고 권한들에 대한 필드만 존재하기 때문에 이메일 정보 또는 프로필 이미지 경로 등과 같은 부가적인 정보를 담을 수 없습니다.  </p>
<p>따라서, UserDetails 구현체를 직접 만들어야 합니다. org.springframework.security.core.userdetails.User 자체도 UserDetails 구현체이기 때문에 이를 상속받아서 구현해도 됩니다.  </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDetails</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span>User</span> <span class="token punctuation">&#123;</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4855890427225819382L</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> nickname<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">Date</span> createdAt<span class="token punctuation">;</span>


	<span class="token keyword">public</span> <span class="token class-name">UserDetails</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// TODO Auto-generated constructor stub</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token class-name">UserDetails</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">isAccountNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">isAccountNonLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">isCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">authorities</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>nickname <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>email <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>createdAt <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getCreatedAt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> id<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> nickname<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token class-name">String</span> nickname<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>nickname <span class="token operator">=</span> nickname<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> email<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEmail</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>email <span class="token operator">=</span> email<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">getCreatedAt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> createdAt<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCreatedAt</span><span class="token punctuation">(</span><span class="token class-name">Date</span> createdAt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>createdAt <span class="token operator">=</span> createdAt<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> <span class="token function">authorities</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// TODO Auto-generated method stub</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> authorities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		user<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>a <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
			authorities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> authorities<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token class-name">UserDetails</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> authorities<span class="token punctuation">,</span>
			<span class="token class-name">String</span> nickname<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>nickname <span class="token operator">=</span> nickname<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>email <span class="token operator">=</span> username<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token class-name">UserDetails</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token keyword">boolean</span> enabled<span class="token punctuation">,</span> <span class="token keyword">boolean</span> accountNonExpired<span class="token punctuation">,</span>
			<span class="token keyword">boolean</span> credentialsNonExpired<span class="token punctuation">,</span> <span class="token keyword">boolean</span> accountNonLocked<span class="token punctuation">,</span>
			<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// TODO Auto-generated constructor stub</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>그러면 우리는 Authentication.getPrincipal() 메소드를 통해 얻은 Principal 객체를 통해서도 부가적인 필드에 접근할 수 있습니다.  </p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">sec:</span>authentication</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>principal.email<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></code></pre>

<p>org.springframework.security.core.userdetails.UserDetailsService 구현체는 스프링 시큐리티 인증 시에 사용됩니다. UserRepository를 통해 영속성으로 저장된 인증정보를 검색한 후 존재하지 않다면 UsernameNotFoundException을 던지고 있다면 UserDetails 객체를 반환합니다.  </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDetailsService</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span>UserDetailsService</span> <span class="token punctuation">&#123;</span>

	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// TODO Auto-generated method stub</span>
		<span class="token class-name">User</span> user <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">findByEmail</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>kdev<span class="token punctuation">.</span>app<span class="token punctuation">.</span>security<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span>UserDetails</span> userDetails <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>kdev<span class="token punctuation">.</span>app<span class="token punctuation">.</span>security<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span>UserDetails</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> userDetails<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>그런데 좀 이상하다고 느껴집니다. 그러면 패스워드 검증은 언제하는것일까요? 바로 AuthenticationProvider 구현체에서 진행하게 됩니다. AuthenticationProvider 구현체에서는 authenticate() 메소드를 통해서 Authentication 객체(UsernamePasswordAuthentication)를 반환합니다. 즉, 반환하기 직전에 패스워드를 검증하는 것입니다.  </p>
<p>우리는 AuthenticationProvider를 직접적으로 구현하지 않았으니까 이 부분에 대해서 모르고 넘어갈 뻔 했습니다.</p>
<p><a href="http://syaku.tistory.com/286">샤쿠님의 스프링 시큐리티 커스텀 로그인</a>이라는 글에서 직접 AuthenticationProvider를 구현해서 사용하는 것을 확인할 수 있습니다.</p>
<h2 id="끝마치며"><a href="#끝마치며" class="headerlink" title="끝마치며"></a>끝마치며</h2><p>우리가 알아본 것 이외에도 스프링 시큐리티가 제공하는 기능들이 더 존재합니다. 예를 들어, 웹소켓, RESTful API등에도 보안을 적용할 수 있습니다.</p>
<p>공부하면서 알게된 부분인데, 스프링 프레임워크에서 제공하는 인-메모리 기반 인증 객체(inMemoryAuthentication())는 파라미터로 제공되는 UserDetails의 정보를 활용하여 User 객체를 생성하기 때문에 UserDetails의 구현체를 만든다 하더라도 의미가 없게 됩니다. 만약, 인 메모리 방식과 영속성 방식을 혼용해서 사용하고 싶다면 이 부분에 대해서 연구해볼 필요가 있겠습니다.  </p>
<p>다음은 스프링 시큐리티에 대해서 알아볼 때 좋은 포스트 및 동영상들입니다.  </p>
<ul>
<li><a href="http://syaku.tistory.com/278">샤쿠님의 스프링 시큐리티 커스텀 로그인</a>  </li>
<li><a href="http://zgundam.tistory.com/43">제타건담님의 스프링 시큐리티</a>  </li>
<li><a href="https://www.youtube.com/watch?v=C0BQplG7Epo&list=PLvudjKUrAA6bLu1CvgSPEKLhlIEIAJXjm">아라한사님의 스프링 시큐리티 따라해보기</a>  </li>
<li><a href="https://www.youtube.com/watch?v=AiDjJzMXWmM">백기선님의 스프링 시큐리티</a>  </li>
<li><a href="http://hamait.tistory.com/325">하마님의 스프링 시큐리티</a></li>
</ul>
<blockquote>
<p>아는게 없으니 쉽게 이해하지 못하는 부분이 많습니다. 많은 신입 개발자들을 응원합니다 ^ㅡ^  </p>
</blockquote>
]]></content>
      <tags>
        <tag>Spring</tag>
        <tag>Spring Security</tag>
      </tags>
  </entry>
  <entry>
    <title>AWS Elastic Beanstalk Java SE 플랫폼 환경으로 애플리케이션 배포하기</title>
    <url>/deploy-application-to-the-aws-elastic-beanstalk-java-se-platform-enviroment/</url>
    <content><![CDATA[<p><img data-src="/images/posts/beanstalk-java-se-platform/aws-elastic-beanstalk-logo.jpg#compact"></p>
<p>안녕하세요 Mambo 입니다. 이번 글은 AWS Elastic Beanstalk의 <code>Java SE 플랫폼 환경</code>을 사용하여 개발된 스프링 부트 애플리케이션을 배포하는 과정에 대해서 학습합니다. AWS를 사용중이라면 <code>Elastic Beanstalk</code> 서비스를 통해 애플리케이션이 실행되는 환경을 빠르고 쉽게 구성할 수 있으며 애플리케이션을 배포하고 환경 성능 지표에 따라 프로비저닝할 수 있는 기능을 적용할 수 있습니다.</p>
<p>저와 같이 Elastic Beanstalk 경험이 부족한 초보 개발자 또는 회사에서 서비스 배포를 담당하지 않는 개발자분들은 이 글을 통해 Elastic Beanstlak로 자바 웹 애플리케이션을 배포할 수 있는 환경을 구성하고 어떤 방식으로 애플리케이션을 배포할 수 있는지를 이해할 수 있을 것 입니다. </p>
<blockquote>
<p>개발 경력은 4년이 지났으나 애플리케이션 배포를 담당하는 것은 얼마되지 않았어요…</p>
</blockquote>
<h2 id="AWS-Elastic-Beanstalk"><a href="#AWS-Elastic-Beanstalk" class="headerlink" title="AWS Elastic Beanstalk"></a>AWS Elastic Beanstalk</h2><p>AWS에서 제공하는 <a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/Welcome.html">Elastic Beanstalk</a>서비스는 AWS 클라우드 환경에서 빠르게 애플리케이션을 배포하고 애플리케이션이 구동되는 환경을 쉽게 관리할 수 있는 AWS의 주요 서비스입니다. Beanstalk을 사용하면 Go, Java, Node.js, Python 등 다양한 언어로 개발된 애플리케이션을 배포할 수 있습니다.</p>
<p>이 글에서 배포할 애플리케이션 소스 코드는 깃허브 <a href="https://github.com/kdevkr/beanstalk-deploy-sample">beanstalk-deploy-sample</a>에 공유되어있으니 참고하시기를 바랍니다.</p>
<blockquote>
<p>엄청 간단한 애플리케이션이에요!</p>
</blockquote>
<h3 id="Java-SE-플랫폼"><a href="#Java-SE-플랫폼" class="headerlink" title="Java SE 플랫폼"></a>Java SE 플랫폼</h3><p>Elastic Beanstalk는 다양한 언어로 작성된 애플리케이션을 배포할 수 있게 여러 <a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/concepts.platforms.html">플랫폼 환경</a>을 지원합니다. 이 중에서 제가 준비한 애플리케이션을 배포할 수 있는 환경은 <a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/platforms/platforms-supported.html#platforms-supported.javase">Java SE 플랫폼</a>입니다.</p>
<blockquote>
<p>별도로 Tomcat 플랫폼이 존재하기는 하지만 이 글에서의 주요 관심사는 아니에요.</p>
</blockquote>
<p><a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/java-se-platform.html">Elastic Beanstalk Java SE 플랫폼</a>은 자체적으로 실행가능하도록 컴파일된 JAR 파일으로 애플리케이션을 실행할 수 있는 환경으로 제가 준비한 애플리케이션이 스프링 부트 기반으로 작성되어있으므로 이 환경이 애플리케이션을 배포할 수 있는 가장 적합한 환경입니다. 스프링 부트에서 제공하는 지원 중 하나는 <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/appendix-executable-jar-format.html">실행가능한 JAR 또는 WAR 파일</a>으로 패키징할 수 있는 부분입니다.</p>
<h4 id="기본-배포-유형"><a href="#기본-배포-유형" class="headerlink" title="기본 배포 유형"></a>기본 배포 유형</h4><p>Elastic Beanstalk의 Java SE 플랫폼 환경은 두가지 방식으로 환경에 업로드된 애플리케이션 파일을 배포할 수 있게 지원합니다. 기본적으로 배포되는 방식은 단일 파일로 자체적으로 실행가능하도록 컴파일된 JAR 파일을 이용하는 것으로 다음의 명령어를 수행하여 Java SE 플랫폼 환경에서 애플리케이션을 구동합니다.</p>
<pre class="language-sh" data-language="sh"><div class="caption"><span>기본 실행 명령어</span></div><code class="language-sh">java -jar application.jar</code></pre>

<p>위 명령에서 애플리케이션 파일명이 <code>application.jar</code>인 이유는 우리가 환경에 업로드한 애플리케이션 파일을 application.jar라는 이름으로 변경하기 때문이며 여러분이 어떤 파일의 이름으로 제공하든 상관이 없습니다.</p>
<h4 id="사용자-정의-배포"><a href="#사용자-정의-배포" class="headerlink" title="사용자 정의 배포"></a>사용자 정의 배포</h4><p>두번째는 다수의 컴파일된 JAR 또는 <code>Procfile</code>이라는 명령어 파일을 통해 애플리케이션을 실행할 수 있는 방식입니다. 이 방식을 사용하면 하나의 환경에서 여러개의 애플리케이션을 실행할 수 있거나 직접 실행할 수 있는 명령어를 정의하므로 JVM 옵션 또는 커맨드 라인 파라미터를 설정할 수 있습니다.</p>
<pre class="language-config" data-language="config"><div class="caption"><span>Procfile</span></div><code class="language-config">web: java -Dfile.encoding&#x3D;UTF-8 -Djava.net.preferIPv4Stack&#x3D;true -Xmx1g -jar app.jar</code></pre>

<p>이렇게 패키징된 JAR 파일과 Procfile을 묶어서 제공하는 파일을 Elastic Beanstalk에서는 소스 번들(Source Bundle)이라고 말합니다. 소스 번들 파일을 Java SE 플랫폼 환경에 업로드하여 배포하는 방식은 아마존 웹 서비스에서도 추천하는 방식입니다.</p>
<h3 id="Linux-플랫폼-확장"><a href="#Linux-플랫폼-확장" class="headerlink" title="Linux 플랫폼 확장"></a>Linux 플랫폼 확장</h3><p>소스 번들 파일로 사용자 정의 배포 방식을 사용하는 경우 .ebextensions, .platform이라는 폴더를 포함시켜 Java SE 플랫폼 환경에 대한 확장을 수행할 수 있도록 지원합니다. 플랫폼 확장에 대한 자세한 내용은 AWS Elastic Beanstalk 개발자 가이드의 <a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/platforms-linux-extend.html">Elastic Beanstalk Linux 플랫폼 확장</a>를 통해 확인할 수 있습니다.</p>
<p><a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/platforms-linux-extend.html#platforms-linux-extend.workflow">인스턴스 배포 워크플로우</a>를 참고하면 업로드된 소스 번들 파일을 통해 Elastic Beanstalk이 어떻게 애플리케이션을 배포하는지 확인할 수 있습니다. 플랫폼 확장을 통해 다음의 작업을 수행할 수 있습니다.</p>
<ul>
<li>애플리케이션 실행하기 전 명령어 수행</li>
<li>역방향 프록시 구성</li>
</ul>
<p>우아한 형제들 기술 블로그의 <a href="https://woowabros.github.io/woowabros/2017/08/07/ebextension.html">Elastic Beanstalk Configuration files(.ebextensions)</a>에서처럼 플랫폼 확장을 통해 모니터링 패키지를 설치하거나 로컬 타임을 변경할 수 있습니다.</p>
<h2 id="빌드부터-배포까지"><a href="#빌드부터-배포까지" class="headerlink" title="빌드부터 배포까지"></a>빌드부터 배포까지</h2><p>Elastic Beanstalk의 Java SE 플랫폼 환경에 대해서 알게되었으니 이제부터 제가 준비한 애플리케이션을 Java SE 플랫폼 환경에 배포하는 과정을 확인하면서 빌드부터 배포까지의 프로세스를 숙지해보도록 하겠습니다.</p>
<p>여러분들도 따라하고 싶다면 <a href="https://github.com/kdevkr/beanstalk-deploy-sample">kdevkr&#x2F;beanstalk-deploy-sample</a>을 참고하시기 바랍니다.</p>
<h3 id="실행가능한-JAR-파일-준비하기"><a href="#실행가능한-JAR-파일-준비하기" class="headerlink" title="실행가능한 JAR 파일 준비하기"></a>실행가능한 JAR 파일 준비하기</h3><p>스프링 부트는 그래들(Gradle) 또는 메이븐(Maven) 도구를 사용하여 실행가능한 JAR 또는 WAR 파일을 패키징할 수 있는 방법을 제공합니다. 저는 그래들을 빌드 도구로 사용하는 스프링 부트 프로젝트를 구성하여 다음과 같이 빌드 태스크에 <code>bootJar</code>와 <code>bootWar</code>가 포함되어있습니다. </p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/spring-boot-gradle-build-01.png"></p>
<p>실행가능한 JAR 파일로만 배포할 수 있는 것이 아님을 확인하기 위해 저는 bootWar 태스크로 애플리케이션을 실행가능한 WAR 파일로 패키징하겠습니다. 이 태스크로 패키징된 WAR 파일을 <code>build/libs</code> 폴더에 생성됩니다.</p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/spring-boot-gradle-build-02.png"></p>
<p>이렇게 패키징된 WAR 파일을 확인할 수 있으나 Java SE 플랫폼에 애플리케이션을 배포하는 방식 중 사용자 정의 배포 방식을 위해 생성된 WAR 파일과 함께 이 파일을 실행하는 명령어를 정의한 <code>Procfile</code>을 만들어 하나의 소스 번들로 만드는 과정을 진행하겠습니다.</p>
<p>소스 번들 파일을 만들기 위해서 build&#x2F;libs 폴더에 직접 Procfile을 생성하여 실행 명령어를 정의하면 안됩니다. build 폴더는 Git에서 무시되는 경로이며 clean 태스크에 의해서 쉽게 삭제될 수 있습니다. 가장 쉽게 떠오르는 방법은 프로젝트 루트 경로에 Procfile을 만들어서 build&#x2F;libs에 패키징된 WAR파일과 압축하는 것입니다.</p>
<p>다행히도 그래들 태스트 유형 중에서 아카이브(압축 파일)을 만들 수 있는 <a href="https://docs.gradle.org/current/userguide/working_with_files.html#sec:creating_archives_example">Zip</a> 태스크 유형이 있으므로 이 유형에 대한 태스크를 작성하여 소스 번들을 만드는 태스크를 수행하도록 하겠습니다.</p>
<p>먼저, 프로젝트 루트 경로에 <code>Procfile</code>을 만들어 애플리케이션 실행 명령어를 작성합니다.</p>
<pre class="language-config" data-language="config"><div class="caption"><span>Procfile</span></div><code class="language-config">web: java -Xmx1g -jar demo.war</code></pre>

<p>그리고 패키징된 WAR 파일과 Procfile을 압축한 파일을 생성하는 태스크를 작성합니다.</p>
<pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">task <span class="token function">zipSourceBundle</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span> Zip<span class="token punctuation">,</span> dependsOn<span class="token punctuation">:</span> <span class="token string">'bootWar'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    from <span class="token punctuation">(</span><span class="token string">'Procfile'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">include</span><span class="token punctuation">(</span><span class="token string">'Procfile'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    from <span class="token punctuation">(</span><span class="token string">'build/libs'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        println bootWar<span class="token punctuation">.</span>archiveName
        <span class="token function">include</span><span class="token punctuation">(</span>bootWar<span class="token punctuation">.</span>archiveName<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    baseName <span class="token operator">=</span> <span class="token string">'beanstalk'</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>작성된 zipSourceBundle 태스크를 수행하면 <code>build/distributions</code> 폴더에 <code>beanstalk.zip</code>이라는 소스 번들 파일이 생성됨을 확인할 수 있습니다.</p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/spring-boot-gradle-build-03.png"></p>
<p>그런데 말입니다. 만약, bootWar 태스크에 의해 만들어지는 파일명이 <code>demo.war</code>가 아니라면 어떻게 될까요? Procfile에 정의한 명령어와 일치하지 않아 애플리케이션을 배포하는 과정에서 오류가 발생할 것입니다. 이 문제를 해결할 수 있는 좋은 방법은 그래들 빌드 과정에서 Procfile을 생성하는 것입니다.</p>
<pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">task <span class="token function">procfile</span><span class="token punctuation">(</span>dependsOn<span class="token punctuation">:</span> <span class="token string">'bootWar'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    doFirst <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"build/libs"</span></span><span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">"Procfile"</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"web: java -Xmx1g -jar </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token expression">bootWar<span class="token punctuation">.</span>archiveName</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"</span></span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>작성된 procfile 태스크는 bootWar 태스크에 의해 만들어지는 WAR 파일명을 주입하여 Procfile을 build&#x2F;libs 위치에 생성합니다. 그리고 앞서 작성한 zipSourceBundle를 보완한 zipBeanstalk 태스크를 작성합니다. </p>
<pre class="language-groovy" data-language="groovy"><div class="caption"><span>build.gradle</span></div><code class="language-groovy">task <span class="token function">zipBeanstalk</span><span class="token punctuation">(</span>type<span class="token punctuation">:</span> Zip<span class="token punctuation">,</span> dependsOn<span class="token punctuation">:</span> <span class="token string">'procfile'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    from <span class="token punctuation">(</span><span class="token string">'build/libs'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        println bootWar<span class="token punctuation">.</span>archiveName
        <span class="token function">include</span><span class="token punctuation">(</span>bootWar<span class="token punctuation">.</span>archiveName<span class="token punctuation">)</span>
        <span class="token function">include</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">"Procfile"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    baseName <span class="token operator">=</span> <span class="token string">'beanstalk'</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>이제 zipBeanstalk 태스크를 수행하였더니 다음과 같이 애플리케이션 소스 번들 파일이 생성되었습니다.</p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/spring-boot-gradle-build-04.png"></p>
<p>그래들 빌드 시 프로젝트 버전(project.version)이 명시되어도 Procfile과 패키징된 WAR 파일명이 다른 경우가 발생하지 않습니다.</p>
<blockquote>
<p>프로젝트 버전을 명시하면 아카이브 파일명에 프로젝트 버전이 포함되요!</p>
</blockquote>
<p><img data-src="/images/posts/beanstalk-java-se-platform/spring-boot-gradle-build-05.png" alt="-Pversion=1.0.0"></p>
<blockquote>
<p>오옷! 좋아요.</p>
</blockquote>
<h3 id="Java-SE-플랫폼-환경-시작하기"><a href="#Java-SE-플랫폼-환경-시작하기" class="headerlink" title="Java SE 플랫폼 환경 시작하기"></a>Java SE 플랫폼 환경 시작하기</h3><p>애플리케이션 소스 번들 파일이 준비되었으므로 Elastic Beanstalk 서비스에서 자바 애플리케이션을 배포할 수 있는 환경을 생성합니다. 환경에 대한 이름, 도메인을 설정한 후 우리가 준비한 스프링 부트 애플리케이션은 자체적으로 실행되는 JAR로 컴파일된 애플리케이션이므로 <code>Java SE 플랫폼 환경</code>을 선택합니다.</p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-01.png" alt="웹 서버 환경 선택"></p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-02.png" alt="환경 및 도메인 설정"></p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-03.png" alt="Java SE 플랫폼 선택"></p>
<p>앞서 준비한 애플리케이션 소스 번들파일을 선택하여 업로드합니다. </p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-04.png"></p>
<p><strong>주의!</strong></p>
<p>위 화면에서 환경 생성 버튼을 누르면 기본으로 정의되어있는 인스턴스 프로파일이 구성된 Java SE 플랫폼 환경을 구성하여 애플리케이션을 배포할 수 있습니다. 그러나 주의해야될 사항은 다음 처럼 환경을 생성하고나서 <strong>변경할 수 없는 부분들이 있다</strong>는 점입니다.</p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-05.png"></p>
<p>기본 Java SE 플랫폼은 <strong>CLB(Classic Load Balancer)</strong> 를 로드밸런서로 사용하는데 환경이 생성된 이후에 로드 밸런서 유형을 변경하고자 구성 편집을 시도하였지만 유형을 변경하는 것을 제공하지 않습니다. 따라서, L7 레벨의 로드밸런서인 <strong>ALB(Application Load Balancer)</strong> 또는 L4 레벨의 <strong>NLB(Network Load Balancer)</strong> 를 환경에 대한 로드밸런서로 사용하기 위해서는 추가 옵션 구성 기능으로 사용자 정의 환경을 생성해야합니다.</p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-06.png" alt="기본 VPC를 지워서 VPC 환경이 없는 채로 만들어진..."></p>
<blockquote>
<p>aws ec2 create-default-vpc 명령으로 기본 VPC를 다시 만들수는 있다…</p>
</blockquote>
<p>Java SE 플랫폼에서 기본적으로 제공하는 Nginx 프록시 구성은 HTTP(80) 트래픽에 대해 5000 포트를 사용하는 애플리케이션으로 라우팅되도록 설정되어있습니다. Beanstalk에 의해 생성된 EC2 인스턴스에 접속해서 Nginx 설정 정보를 찾아보면 다음과 같이 <code>00_application.conf</code> 파일에 프록시 구성이 정의되어 있음을 확인할 수 있습니다.</p>
<pre class="language-sh" data-language="sh"><div class="caption"><span>/etc/nginx/conf.d/elasticbeanstalk/00_application.conf</span></div><code class="language-sh">[root@ip-172-31-40-185 ~]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;elasticbeanstalk&#x2F;00_application.conf 
location &#x2F; &#123;
    proxy_pass          http:&#x2F;&#x2F;127.0.0.1:5000;
    proxy_http_version  1.1;

    proxy_set_header    Connection          $connection_upgrade;
    proxy_set_header    Upgrade             $http_upgrade;
    proxy_set_header    Host                $host;
    proxy_set_header    X-Real-IP           $remote_addr;
    proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
&#125;</code></pre>

<p>그런데 제가 배포한 스프링 부트 애플리케이션은 별도로 실행되는 포트를 지정하지 않아 8080 포트를 할당합니다. </p>
<pre class="language-sh" data-language="sh"><code class="language-sh">[root@ip-172-31-40-185 ~]# netstat -tnlp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID&#x2F;Program name           
tcp6       0      0 :::8080                 :::*                    LISTEN      3512&#x2F;java </code></pre>

<p>Elastic Beanstalk은 5000 포트에 대한 애플리케이션 상태를 확인하므로 Elastic Beanstalk은 환경 상태를 올바르지 않다고 피드백하게 됩니다. 따라서, 로드밸런서가 트래픽을 애플리케이션으로 라우팅할 수 있도록 애플리케이션을 5000 포트로 할당하도록 해야합니다. 다만, 애플리케이션이 5000 포트를 사용하도록 애플리케이션 프로퍼티 중 <strong>server.port</strong> 를 5000으로 지정하고 다시 패키징하여 배포하는 것은 불편할 수 있습니다.</p>
<p>다시 패키징하지 않더라도 애플리케이션이 구동되는 포트를 변경할 수 있는 방법을 고려해보도록 하죠.</p>
<ol>
<li>기본 <a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/java-se-nginx.html">역방향 프록시 구성</a> 파일에 정의된 포트 변경</li>
</ol>
<ul>
<li>PORT 환경 속성으로 기본 애플리케이션이 수신 대기하는 포트를 재정의</li>
</ul>
<ol start="2">
<li>JVM 옵션을 지정하여 애플리케이션 실행 포트 변경</li>
</ol>
<p>1번 방법은 기본으로 정의되는 Nginx 프록시 구성을 변경하는 방법으로 <code>PORT</code>라는 환경 속성에 따라 00_application.conf의 내용을 정의합니다.</p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-07.png" alt="PORT 환경 속성 정의"></p>
<pre class="language-sh" data-language="sh"><div class="caption"><span>00_application.conf</span></div><code class="language-sh">[root@ip-172-31-40-185 ~]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;elasticbeanstalk&#x2F;00_application.conf 
location &#x2F; &#123;
    proxy_pass          http:&#x2F;&#x2F;127.0.0.1:8080;
    proxy_http_version  1.1;

    proxy_set_header    Connection          $connection_upgrade;
    proxy_set_header    Upgrade             $http_upgrade;
    proxy_set_header    Host                $host;
    proxy_set_header    X-Real-IP           $remote_addr;
    proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
&#125;</code></pre>

<blockquote>
<p>PORT 환경 속성에 따라 애플리케이션 프록시 포트가 변경되었어요!</p>
</blockquote>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-08.png"></p>
<p>스프링 부트 기반의 애플리케이션을 개발하는 개발자라면 환경 속성이라는 이름을 보고 스프링 부트가 지원하는 <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-external-config">외부화 구성(Externalized Configuration)</a>을 떠올랐을 수 있습니다. 외부화 구성 순서 5번 항목에 <code>OS 환경 변수</code>가 있는데 인텔리제이로 애플리케이션을 구동할 때 환경 변수를 지정하여 프로퍼티 값을 설정할 수 있는 것이 이 부분입니다.</p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/spring-boot-run-configuration-environment-variables.png"></p>
<p>이번에는 PORT 환경 속성이 아닌 <code>SERVER_PORT</code> 환경 속성에 5000을 설정하여 애플리케이션이 5000 포트로 구동되는지를 확인해봅시다.</p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-09.png" alt="SERVER_PORT 환경 속성"></p>
<pre class="language-sh" data-language="sh"><code class="language-sh">[root@ip-172-31-40-185 ~]# netstat -tnlp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID&#x2F;Program name              
tcp6       0      0 :::5000                 :::*                    LISTEN      6244&#x2F;java           </code></pre>

<blockquote>
<p>SERVER_PORT 환경 속성에 정의된 포트로 애플리케이션이 실행되었어요!</p>
</blockquote>
<h4 id="JVM-옵션-설정"><a href="#JVM-옵션-설정" class="headerlink" title="JVM 옵션 설정"></a>JVM 옵션 설정</h4><p>환경 속성을 통해 SERVER_PORT를 정의하여 애플리케이션 프로퍼티를 변경할 수 있지만 JVM 옵션으로 <code>server.port</code>에 대한 값으로 5000을 지정하는 것을 시도해보겠습니다. 일반적으로 JVM 옵션을 지정하기 위해서는 -Dserver.port와 같이 java 명령어를 수행할 때 지정해야합니다. 하지만 우리는 Procfile에 실행 명령어를 정의해놓았으므로 추가적인 JVM 옵션을 지정할 수 있는 방안이 없습니다.</p>
<p>Elastic Beanstalk에서 JVM 옵션을 지정하는 방법을 검색해보면 <a href="https://www.oracle.com/java/technologies/javase/envvars.html#gbmsy">JAVA_TOOL_OPTIONS</a> 환경 변수로 지정할 수 있음을 찾을 수 있습니다. JAVA_TOOL_OPTIONS 환경 변수 외에도 JVM 마다 JAVA_OPTS 또는 <a href="https://stackoverflow.com/questions/28327620/difference-between-java-options-java-tool-options-and-java-opts">_JAVA_OPTIONS</a>를 사용할 수 있습니다만 JAVA_TOOL_OPTIONS이 <code>JVMTI</code> 표준 스펙이므로 JAVA_TOOL_OPTIONS을 사용하여 JVM 옵션을 설정하는 게 올바른 방법입니다.</p>
<blockquote>
<p>Java SE 플랫폼 환경의 Correcto JDK는 _JAVA_OPTIONS 환경 속성도 적용되요!</p>
</blockquote>
<p>다음은 Elastic Beanstalk Java SE 플랫폼 환경에서 JAVA_TOOL_OPTIONS와 _JAVA_OPTIONS 환경 속성을 지정했을 때 적용 순서입니다.</p>
<pre class="language-sh" data-language="sh"><code class="language-sh">Mar  5 16:37:54 ip-172-31-40-185 web: Picked up JAVA_TOOL_OPTIONS: -Dserver.port&#x3D;5000
Mar  5 16:37:54 ip-172-31-40-185 web: Picked up _JAVA_OPTIONS: -Dserver.port&#x3D;5001

[root@ip-172-31-40-185 ~]# jps -v
3634 war -Dserver.port&#x3D;5000 -Xmx1g -Dserver.port&#x3D;5001
3740 Jps -Dapplication.home&#x3D;&#x2F;usr&#x2F;lib&#x2F;jvm&#x2F;java-11-amazon-corretto.x86_64 -Xms8m -Djdk.module.main&#x3D;jdk.jcmd</code></pre>

<p>JAVA_TOOL_OPTIONS 보다 _JAVA_OPTIONS 환경 속성이 나중에 적용되며 Procfile에 정의된 JVM 옵션과의 순서도 다른 것을 확인할 수 있습니다.</p>
<h3 id="추가-옵션-구성"><a href="#추가-옵션-구성" class="headerlink" title="추가 옵션 구성"></a>추가 옵션 구성</h3><p>기본으로 정의된 환경으로 시작하기보다는 <code>추가 옵션 구성</code> 기능을 통해 사용자 정의된 Java SE 플랫폼 환경을 구성하는 것이 좋습니다. 사전 설정을 통해 인스턴스 규모를 선택할 수 있으나 직접 환경 옵션을 정의하기 위해 <strong>사용자 지정 구성</strong> 을 선택합니다.</p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-10.png"></p>
<p>사용자 지정 구성 선택시 제공되는 기본 옵션은 다음과 같습니다. 몇가지 옵션에 대해서 수정을 해보도록 하죠.</p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-11.png"></p>
<h4 id="소프트웨어"><a href="#소프트웨어" class="headerlink" title="소프트웨어"></a>소프트웨어</h4><p>가장 먼저, 소프트웨어 옵션을 편집하여 기본으로 지정된 애플리케이션 프록시 포트에 맞게 실행될 수 있도록 SERVER_PORT 환경변수를 등록합니다.</p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-12.png"></p>
<h4 id="용량"><a href="#용량" class="headerlink" title="용량"></a>용량</h4><p>용량 옵션을 편집하여 Elastic Beanstalk이 EC2 인스턴스를 어떻게 실행하고 관리할지 설정할 수 있습니다. 기본 단일 인스턴스 환경은 로드밸런서를 사용할 수 없으므로 오토 스케일링 기능을 활성화하기 위하여 로드 밸런싱 수행 환경으로 변경합니다. 로드 밸런싱 수행 환경이지만 처음에는 <strong>단일 인스턴스</strong> 로 시작하기 위하여 인스턴스의 최대 크기를 1로 지정합니다.</p>
<p>만약, 여러분의 애플리케이션이 요구하는 메모리 크기와 CPU 성능이 있다면 인스턴스 유형을 변경합니다. 저는 간단한 애플리케이션을 배포하므로 기본으로 설정된 t2.micro를 사용하겠습니다.</p>
<blockquote>
<p>t2.micro는 1GB의 메모리 크기를 가집니다.</p>
</blockquote>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-13.png"></p>
<h4 id="로드밸런서"><a href="#로드밸런서" class="headerlink" title="로드밸런서"></a>로드밸런서</h4><p>용량 옵션에서 로드 밸런싱 환경을 선택하면 로드밸런서 옵션을 설정할 수 있게 활성화됩니다. </p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-14.png"></p>
<p>기본으로 지정된 로드밸런서는 L7 레벨의 ALB(Application Load Balancer)으로 변경할 필요는 없지만 회사에서는 빠른 트래픽 처리를 위해 L4 레벨의 NLB(Network Load Balancer)를 사용하므로 NLB로 지정하겠습니다. </p>
<p>각 로드밸런서가 지원하는 기능이 궁금하다면 <a href="https://aws.amazon.com/ko/elasticloadbalancing/features/">Elastic Load Balancing 기능</a>을 참고하세요. 로드밸런서가 트래픽을 처리하는 리스너와 프로세스를 설정할 수 있지만 여기서는 넘어가도록 하겠습니다.</p>
<h4 id="보안"><a href="#보안" class="headerlink" title="보안"></a>보안</h4><p>보안 옵션을 편집하여 EC2 인스턴스에 접근할 수 있는 권한을 설정할 수 있습니다. 키 페어를 지정하면 EC2 콘솔을 통해 연결할 수 있습니다.</p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-15.png"></p>
<h4 id="네트워크"><a href="#네트워크" class="headerlink" title="네트워크"></a>네트워크</h4><p>네트워크 옵션을 편집하여 VPC를 선택하고 로드밸런서와 인스턴스가 사용할 서브넷 대역을 설정할 수 있습니다. </p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-16.png"></p>
<p>이제 옵션 구성이 끝났으므로 환경 생성 버튼을 클릭하여 Elastic Beanstalk이 환경을 구성하는 것을 기다립니다. Elastic Beanstalk가 생성한 환경의 상태를 확인하고 애플리케이션으로 트래픽이 처리되는지를 확인하면 됩니다.</p>
<p>Elastic Beanstalk이 환경을 생성하는 것을 기다렸으나 제가 실수로 인스턴스 서브넷을 잘못 지정하여 인스턴스가 생성되지 못하였으나 Elastic Beanstalk는 환경 생성을 위해 상태를 계속 확인하고 기다리는 무한 루프 증상에 빠져버렸습니다.</p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-17.png"></p>
<p>인스턴스 서브넷을 올바르게 지정하기 위해서 환경 구성 페이지로 가보았지만 Elastic Beanstalk는 환경에 대한 이벤트를 수행하고 있어 어떠한 작업도 진행할 수 없습니다.</p>
<blockquote>
<p>이처럼 환경에 대한 작업이 수행되고 있을때는 어떠한 요청도 수행할 수 없는 단점이…</p>
</blockquote>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-18.png" alt="비활성화된 환경 작업"></p>
<h4 id="제대로-생성되지-않는-Beanstalk-환경-삭제하기"><a href="#제대로-생성되지-않는-Beanstalk-환경-삭제하기" class="headerlink" title="제대로 생성되지 않는 Beanstalk 환경 삭제하기"></a>제대로 생성되지 않는 Beanstalk 환경 삭제하기</h4><p>Elastic Beanstalk 서비스에서는 위 환경 생성 작업을 중지할 수 있는 방법이 없습니다. 다만, AWS 서비스 중 CloudFormation을 검색하여 들어가보면 Elastic Beanstalk 환경을 구성하는 스택을 찾을 수 있고 <code>CREATE_IN_PROGRESS</code> 상태에 머물러 있는 것을 확인할 수 있습니다. 이 스택을 선택하여 삭제하면 됩니다.</p>
<blockquote>
<p>Java SE 플랫폼 환경을 CloudFormation로 정의해서 구성하는군요?</p>
</blockquote>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-19.png"></p>
<p>Beanstalk 환경을 생성하는 스택이 삭제되어 Beanstalk 서비스로 다시 가보면 생성할 때 오류가 발생했던 환경이 삭제되고 있음을 확인할 수 있습니다. 다행입니다.</p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-20.png"></p>
<blockquote>
<p>단, 삭제된 환경 이름을 다시 사용하고 싶은 경우 1시간동안 기다려야해요…</p>
</blockquote>
<p>환경을 정상적으로 구성한 경우 다음과 같이 배포가 완료되었음을 확인할 수 있습니다.</p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-21.png"></p>
<blockquote>
<p>휴…</p>
</blockquote>
<h2 id="플랫폼-확장-구성"><a href="#플랫폼-확장-구성" class="headerlink" title="플랫폼 확장 구성"></a>플랫폼 확장 구성</h2><p>Elastic Beanstalk은 애플리케이션 소스 번들에 포함된 구성 및 플랫폼 파일을 통해 환경에 대한 구성을 확장하는 것을 지원합니다. 구성 파일은 <strong>.ebextensions</strong> 폴더, 플랫폼 파일은 <strong>.platform</strong> 폴더에 위치하게 됩니다. 저는 인프라에 대한 튜닝 방법에 대해서는 잘 모르기 때문에 인터넷에 공유된 내용을 소개하도록 하겠습니다.</p>
<h3 id="EC2-인스턴스-타임존-변경하기"><a href="#EC2-인스턴스-타임존-변경하기" class="headerlink" title="EC2 인스턴스 타임존 변경하기"></a>EC2 인스턴스 타임존 변경하기</h3><p>AWS의 <a href="https://github.com/awsdocs/elastic-beanstalk-samples/tree/main/configuration-files">elastic-beanstalk-samples&#x2F;configuration-files</a>에는 EC2 인스턴스의 타임존을 변경할 수 있는 구성 파일 예제(timezone-linux.config)가 있습니다.</p>
<pre class="language-config" data-language="config"><div class="caption"><span>.ebextensions/00-timezone-linux.config</span></div><code class="language-config">option_settings:
  - namespace: aws:elasticbeanstalk:application:environment
    option_name: TZ
    value: &quot;Asia&#x2F;Seoul&quot;

files:
  &quot;&#x2F;tmp&#x2F;set_timezone.sh&quot;:
    mode: &quot;000755&quot;
    owner: root
    group: root
    content: |
      #!&#x2F;bin&#x2F;bash
      NEWTIMEZONE&#x3D;&quot;$(&#x2F;opt&#x2F;elasticbeanstalk&#x2F;bin&#x2F;get-config environment -k TZ)&quot;
      if [ -z $NEWTIMEZONE ] ; then
          echo &quot;TZ&quot; environment property not set
          exit 1
      fi
      if [ ! -f &#x2F;usr&#x2F;share&#x2F;zoneinfo&#x2F;$NEWTIMEZONE ] ; then
          echo &#x2F;usr&#x2F;share&#x2F;zoneinfo&#x2F;$NEWTIMEZONE does not exist
          exit 1
      fi
      echo &#39;ZONE&#x3D;&quot;&#39;$NEWTIMEZONE&#39;&quot;&#39; &gt; &#x2F;etc&#x2F;sysconfig&#x2F;clock
      echo &#39;UTC&#x3D;true&#39; &gt;&gt; &#x2F;etc&#x2F;sysconfig&#x2F;clock
      ln -f -s &#x2F;usr&#x2F;share&#x2F;zoneinfo&#x2F;$NEWTIMEZONE &#x2F;etc&#x2F;localtime

commands:
  00-custom-timezone:
    command: &#x2F;tmp&#x2F;set_timezone.sh</code></pre>

<p>기존 예제와 다르게 ntpdate로 NTP 서버 동기화 명령어를 수행하지 않고 <a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/set-time.html">Linux 인스턴스의 시간 설정</a>에 따라 Amazon Time Sync Service와 동기화되는 시간을 그대로 사용하겠습니다.</p>
<p><img data-src="/images/posts/beanstalk-java-se-platform/beanstalk-environment-22.png" alt="TZ 환경속성"></p>
<pre class="language-sh" data-language="sh"><code class="language-sh">[root@ip-10-1-0-52 ~]# date
Sun Mar  7 13:58:57 KST 2021</code></pre>

<blockquote>
<p>명령어가 수행되어 한국 시간으로 표시된다.</p>
</blockquote>
<h3 id="Node-Exporter-에이전트-설치"><a href="#Node-Exporter-에이전트-설치" class="headerlink" title="Node Exporter 에이전트 설치"></a>Node Exporter 에이전트 설치</h3><p>OKKY에서 운영회원으로 활동중이신 창천향로님의 <a href="https://github.com/jojoldu/aws-beanstalk-tunning">AWS Beanstalk 성능 튜닝 시리즈</a>에서처럼 애플리케이션 성능 모니터링을 위한 APM 에이전트를 설치할 수도 있습니다. 저는 프로메테우스로 EC2 인스턴스에 대한 매트릭을 수집할 수 있도록 Beanstalk로 생성되는 EC2 인스턴스에 Node Exporter를 설치하고 실행하도록 확장 구성을 진행해보겠습니다.</p>
<p>먼저 Nginx 프록시 구성에 Node Exporter에 대한 프록시 구성 파일을 추가합니다.</p>
<pre class="language-conf" data-language="conf"><div class="caption"><span>.platform/nginx/conf.d/elasticbeanstalk/01_node_exporter.conf</span></div><code class="language-conf">location &#x2F;metrics &#123;
    proxy_pass          http:&#x2F;&#x2F;127.0.0.1:9100&#x2F;metrics;
    proxy_http_version  1.1;

    proxy_set_header    Connection          $connection_upgrade;
    proxy_set_header    Upgrade             $http_upgrade;
    proxy_set_header    Host                $host;
    proxy_set_header    X-Real-IP           $remote_addr;
    proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
&#125;</code></pre>

<p>역방향 프록시 구성을 통해 <code>/metrics</code>에 대한 트래픽을 Node Exporter로 라우팅할 수 있게 됩니다. 그럼 이제 Node Exporter를 설치하고 실행하는 구성 파일을 만듭니다.</p>
<pre class="language-config" data-language="config"><div class="caption"><span>.ebextensions/99-install-node-exporter.config</span></div><code class="language-config">commands:
  command block:
    cwd: &#x2F;home&#x2F;webapp
    command: |
      curl -L https:&#x2F;&#x2F;github.com&#x2F;prometheus&#x2F;node_exporter&#x2F;releases&#x2F;download&#x2F;v1.1.2&#x2F;node_exporter-1.1.2.linux-amd64.tar.gz | tar zxv
      cd node_exporter-1.1.2.linux-amd64
      nohup .&#x2F;node_exporter &gt; &#x2F;dev&#x2F;null 2&gt;&amp;1 &amp;</code></pre>

<p>여러가지 명령어를 하나로 합칠 수 있는 <code>command block</code>을 사용했으며 Node Exporter를 백그라운드로 실행하도록 하였습니다. 이제 이 파일들을 소스 번들에 포함하여 환경에 배포하면 다음과 같이 EC2 인스턴스에 대한 지표를 수집할 수 있게 됩니다.</p>
<h3 id="Beanstalk-배포-프로세스-확인"><a href="#Beanstalk-배포-프로세스-확인" class="headerlink" title="Beanstalk 배포 프로세스 확인"></a>Beanstalk 배포 프로세스 확인</h3><p>Elastic Beanstalk로 애플리케이션을 배포하기까지 문제가 발생했을때 어떤 부분을 체크해야하는지 알아보도록 하죠. </p>
<h4 id="로그"><a href="#로그" class="headerlink" title="로그"></a>로그</h4><p>가장 먼저 확인해야될 부분은 로그입니다.</p>
<pre class="language-sh" data-language="sh"><div class="caption"><span>/var/log</span></div><code class="language-sh">[root@ip-10-1-0-52 log]# ll -h
total 736K
drwx------ 3 root    root      17 Mar  7 11:58 amazon
-rw------- 1 root    root    8.3K Mar  7 11:58 boot.log
-rw------- 1 root    utmp     15K Mar  7 13:36 btmp
-rw-r--r-- 1 root    root    6.9K Mar  7 14:45 cfn-hup.log
-rw-r--r-- 1 root    root     23K Mar  7 14:04 cfn-init-cmd.log
-rw-r--r-- 1 root    root     14K Mar  7 14:04 cfn-init.log
-rw-r--r-- 1 root    root     39K Mar  7 14:04 cfn-wire.log
drwxr-xr-x 2 chrony  chrony     6 Mar  7 11:58 chrony
-rw-r--r-- 1 root    root     93K Mar  7 11:58 cloud-init.log
-rw-r--r-- 1 root    root    2.5K Mar  7 11:58 cloud-init-output.log
-rw------- 1 root    root    9.4K Mar  7 14:40 cron
-rw-r--r-- 1 root    root     27K Mar  7 11:58 dmesg
-rw-r--r-- 1 root    root       0 Mar  7 11:58 eb-cfn-init-call.log
-rw-r--r-- 1 root    root     41K Mar  7 11:58 eb-cfn-init.log
-rw-r--r-- 1 root    root    137K Mar  7 14:04 eb-engine.log
-rw-r--r-- 1 root    root    1.3K Mar  7 14:30 eb-publish.log
-rw-r--r-- 1 root    root     455 Mar  7 12:30 eb-tools.log
drwxr-xr-x 3 healthd healthd   39 Mar  7 12:00 healthd
-rw------- 1 root    root     204 Mar  7 11:58 maillog
-rw------- 1 root    root    205K Mar  7 14:47 messages
drwxr-xr-x 4 nginx   nginx     71 Mar  7 12:45 nginx
drwxr-xr-x 2 root    root       6 Mar  7 11:58 rotated
drwxr-xr-x 2 root    root      18 Mar  7 11:58 sa
-rw------- 1 root    root     41K Mar  7 14:32 secure
-rw------- 1 root    root     21K Mar  7 14:33 web.stdout.log
-rw-rw-r-- 1 root    utmp    7.9K Mar  7 14:32 wtmp
drwxr-xr-x 2 xray    xray       6 Feb 25 22:54 xray</code></pre>

<p>로그 파일들은 <strong>&#x2F;var&#x2F;log</strong> 폴더에 위치하게 되는데 주로 확인하는 로그는 <strong>eb-engine.log</strong> 와 <strong>web.stdout.log</strong> 입니다. </p>
<ul>
<li>eb-engine.log: Beanstalk 프로세스 로그</li>
<li>web.stdout.log: 현재 실행되고 있는 애플리케이션의 로그</li>
<li>cfn-init-cmd.log: .eb-extensions 구성 파일에 정의한 명령어를 수행한 로그</li>
</ul>
<h4 id="소스-번들-파일"><a href="#소스-번들-파일" class="headerlink" title="소스 번들 파일"></a>소스 번들 파일</h4><p>업로드된 소스 번들에 포함된 파일들은 Elastic Beanstalk에 의해서 다양한 위치로 복사됩니다. </p>
<p>먼저, 현재 배포되고 있는 애플리케이션에 대한 소스 번들 파일과 환경 속성이 정의된 파일은 &#x2F;opt&#x2F;elasticbeanstalk&#x2F;deployment에서 찾을 수 있습니다.</p>
<pre class="language-sh" data-language="sh"><div class="caption"><span>/opt/elasticbeanstalk/deployment</span></div><code class="language-sh">[root@ip-10-1-0-52 deployment]# ll -h
total 18M
-rw-r--r-- 1 root root  18M Mar  7 14:04 app_source_bundle
-rw-r--r-- 1 root root   92 Mar  7 14:04 app_version_manifest.json
-rw-r--r-- 1 root root 4.0K Mar  7 14:04 cfn-metadata-cache.json
-r-------- 1 root root  211 Mar  7 14:04 env</code></pre>

<p>그리고 소스 번들(app_source_bundle)에 포함된 WAR 파일과 Procfile은 &#x2F;var&#x2F;app&#x2F;current에 복사되어 실행합니다. 현재 배포되고 있는 애플리케이션이 제대로된 버전으로 실행되고 있는지 파악할 수 있겠습니다.</p>
<pre class="language-sh" data-language="sh"><div class="caption"><span>/var/app/current</span></div><code class="language-sh">[root@ip-10-1-0-52 current]# ll -h
total 20M
-rw-r--r-- 1 webapp webapp 20M Mar  7 14:02 demo-1.0.0.war
-rw-r--r-- 1 webapp webapp  36 Mar  7 14:02 Procfile</code></pre>

<p>플랫폼(.platform)에 추가된 프록시 구성파일은 해당 프록시 하위로 복사됩니다. 예를 들어, 앞서 작성해본 01_node_exporter.conf 프록시 구성 파일은 &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;elasticbeanstalk에 복사됩니다.</p>
<pre class="language-sh" data-language="sh"><div class="caption"><span>/etc/nginx/conf.d/elasticbeanstalk</span></div><code class="language-sh">[root@ip-10-1-0-52 elasticbeanstalk]# ll -h
total 12K
-rw-r--r-- 1 root   root   397 Mar  7 14:04 00_application.conf
-rw-r--r-- 1 webapp webapp 420 Mar  7 00:05 01_node_exporter.conf
-rw-r--r-- 1 root   root   215 Mar  7 14:04 healthd.conf</code></pre>

<p>&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;elasticbeanstalk 폴더에는 기본으로 제공되는 프록시 구성 파일과 함께 소스 번들에 포함된 프록시 구성 파일이 존재하는 것을 확인할 수 있습니다.</p>
<h2 id="끝마치며"><a href="#끝마치며" class="headerlink" title="끝마치며"></a>끝마치며</h2><p>실제로 실무에서 Elastic Beanstalk로 애플리케이션을 배포하는 것은 다양한 부분에서 검토를 진행해야합니다. 개발된 애플리케이션이 요구하는 최소 환경 사양에 따라 인스턴스 유형을 설정해야하며 서비스 구조에 따라 유연하게 트래픽을 처리할 수 있는 ALB를 적용할 지 빠른 트래픽 처리를 위해 NLB로 로드 밸런싱을 단순화 해야할지를 정해야할 수 있습니다. </p>
<p>Elastic Beanstalk로 애플리케이션을 배포하는 것이 쉽다는 장점은 있지만 <strong>문제가 발생했을때 해결하는 것이 쉽지 않다는 단점</strong> 이 분명히 존재합니다. 실제로 최근에 애플리케이션을 배포하는 과정에서 많은 변경사항들로 인하여 배포 전환이 용이하지 않아 별도로 환경을 구성하고 트래픽을 전환하는 과정을 수행하기도 했습니다. 실무에서 예기치 못하게 발생하는 문제들로 인하여 쉽게 배포되겠지라는 생각과 달리 배포가 쉽지 않아 작성해보았습니다. 이상으로 AWS Elastic Beanstalk Java SE 플랫폼 환경으로 애플리케이션 배포하기를 마치겠습니다.</p>
<p>감사합니다.</p>
]]></content>
      <tags>
        <tag>AWS</tag>
        <tag>Beanstalk</tag>
        <tag>Deployment</tag>
      </tags>
  </entry>
</search>
