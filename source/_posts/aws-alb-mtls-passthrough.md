---
title: AWS ALB ì—ì„œ mTLSë¥¼ ì§€ì›í•˜ì§€ ì•Šì•˜ë‹¤ê³ ?!
date: 2024-01-20T17:00+0900
tags:
- ALB
- Mutual TLS
- X-Amzn-Mtls-Clientcert
---

#### OpenADR ìš”ì²­ ì‹œ 451 ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤ ğŸ’¥

OpenADR í”„ë¡œí† ì½œì—ì„œ NOT_ALLOWED(451)ì€ ìš”ì²­ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì„ë•Œ ì‘ë‹µë˜ëŠ” ë©”ì‹œì§€ì´ë‹¤. ì²˜ìŒì—ëŠ” OpenADR í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ ì‹œ ì „ë‹¬í•œ ì¸ì¦ì„œê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì€ ê²ƒì„ ì²´í¬í–ˆìœ¼ë‚˜ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ í™•ì¸í•´ë³´ë‹ˆ ì¸ì¦ì„œê°€ ì„œë²„ê¹Œì§€ ì „ë‹¬ë˜ì§€ ì•ŠìŒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤. í•´ë‹¹ í…ŒìŠ¤íŠ¸ í™˜ê²½ì€ ê·¸ë™ì•ˆ ì¡°ì§ì—ì„œ êµ¬ì„±í•œ ì¸í”„ë¼ ë°©ì‹ì´ ì•„ë‹Œ ì¼ë³¸ ê³ ê° í™˜ê²½ì„ ìµœëŒ€í•œ ëª¨ë°©í•´ì„œ ë§Œë“  ì‹ ê·œ í™˜ê²½ì— í•´ë‹¹ëœë‹¤. í˜„ì¬ ì¡°ì§ì—ì„œ ì œê³µí•˜ëŠ” ì†”ë£¨ì…˜ì€ ì•„ë§ˆì¡´ ì›¹ ì„œë¹„ìŠ¤ì—ì„œ ì¸í”„ë¼ë¥¼ êµ¬ì„±í•˜ëŠ” ê²½ìš° Elastic Beanstalk ì™€ (ELB ì¤‘ L4ì— í•´ë‹¹í•˜ëŠ”) NLB ë¡œ êµ¬ì„±ëœë‹¤.

> ë¡œë“œë°¸ëŸ°ì„œë¥¼ ALBë¡œ êµ¬ì„±í•˜ì§€ ì•ŠëŠ” ì´ìœ ëŠ” ë¹ ë¥¸ íŠ¸ë˜í”½ ì „ë‹¬ê³¼ ì—ë„ˆì§€ ê´€ë ¨ ì‹œìŠ¤í…œ íŠ¹ì„± ìƒ ì™¸ë¶€ì—ì„œ ê³ ì •ë˜ì–´ì•¼í•˜ëŠ” ì•„ì´í”¼ê°€ í•„ìš”í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

#### AWS ALB ëŠ” mTLSë¥¼ ì§€ì›í•´ìš” ğŸŒ¼

2023ë…„ 12ì›”ì— [Application Load Balancer ìƒí˜¸ ì¸ì¦ ê¸°ëŠ¥](https://aws.amazon.com/ko/blogs/korea/mutual-authentication-for-application-load-balancer-to-reliably-verify-certificate-based-client-identities/)ì„ ì§€ì›í•˜ê²Œ ë˜ì—ˆê³  ì•„ë˜ì™€ ê°™ì´ [Application Load Balancerìš© HTTPS ë¦¬ìŠ¤ë„ˆ ìƒì„±](https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/application/create-https-listener.html)ë¬¸ì„œì—ëŠ” ê·¸ë™ì•ˆ ALB ì—ì„œ mTLS ì ìš©ì„ í•  ìˆ˜ ì—†ë‹¤ëŠ” ì •ë³´ê°€ ë‚¨ì•„ìˆëŠ” ê±¸ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ê³ ê° í™˜ê²½ê³¼ ë™ì¼í•œ ì¸í”„ë¼ë¥¼ êµ¬ì„±í•˜ë©´ì„œë„ ALB ì—ì„œ mTLSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ë¶€ë¶„ì— ì œì•½ì´ ìˆë‹¤ëŠ” ê²ƒì„ ì•Œì•„ì±„ì§€ ëª»í–ˆë‹¤.

![](/images/posts/aws-alb-mtls-passthrough/03.png)

##### ì›ë˜ëŠ” ì§€ì›í•˜ì§€ ì•Šì•˜ë‹¤ëŠ”ê±¸ ì•Œ ìˆ˜ ìˆëŠ” ìŠ¤íƒì˜¤ë²„í”Œë¡œìš° ë‹µë³€ ë§í¬

- [https://stackoverflow.com/a/41596778](https://stackoverflow.com/a/41596778)
- [https://stackoverflow.com/a/42027781](https://stackoverflow.com/a/42027781)

#### mTLS íŒ¨ìŠ¤ìŠ¤ë£¨ ì˜µì…˜

> ìƒí˜¸ ì¸ì¦ ì˜µì…˜ì€ ë‘ ê°€ì§€ê°€ ìˆìŠµë‹ˆë‹¤. **íŒ¨ìŠ¤ìŠ¤ë£¨** ì˜µì…˜ì„ ì„ íƒí•˜ë©´ HTTP í—¤ë”ë¥¼ ì‚¬ìš©í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° ë°›ì€ ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œ ì²´ì¸ì„ ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ ë³´ëƒ…ë‹ˆë‹¤. mTLSê°€ í™œì„±í™”ëœ Application Load BalancerëŠ” í•¸ë“œì…°ì´í¬ì—ì„œ í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œë¥¼ ê°€ì ¸ì˜¤ê³ , TLS ì—°ê²°ì„ ì„¤ì •í•œ ë‹¤ìŒ, HTTPS í—¤ë”ì— ìˆëŠ” ëª¨ë“  í•­ëª©ì„ ëŒ€ìƒ ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ ë³´ëƒ…ë‹ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ì€ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì¸ì¦í•˜ê¸° ìœ„í•´ í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œ ì²´ì¸ì„ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.

ìœ„ ë¬¸ì¥ìœ¼ë¡œë§Œ í•´ì„í•˜ë©´ ALB ì—ì„œ íŒ¨ìŠ¤ìŠ¤ë£¨ ì˜µì…˜ì„ ì ìš©í•œ ë’¤ ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ê¹Œì§€ í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ì„œê°€ ë„ë‹¬í•´ì•¼í•˜ì§€ë§Œ íŒ¨ìŠ¤ìŠ¤ë£¨ ì˜µì…˜ì„ í™œì„±í™”í•˜ì—¬ë„ í•´ë‹¹ ì¦ìƒì€ ë™ì¼í•˜ê²Œ ë°œìƒí–ˆë‹¤. ìµœê·¼ ê°±ì‹ ëœ í˜ì´ì§€ë¼ í•œêµ­ì–´ë¡œ ë²ˆì—­ì´ ë˜ì§€ ì•Šì€ [Mutual authentication with TLS in Application Load Balancer](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/mutual-authentication.html#mtls-http-headers)ë¥¼ ì°¸ê³ í•˜ë©´ `X-Amzn-Mtls-Clientcert` í—¤ë”ì˜ URL-encoded PEM í˜•íƒœì˜ ê°’ìœ¼ë¡œ ë¡œë“œë°¸ëŸ°ì„œì˜ ëŒ€ìƒìœ¼ë¡œ ì „ë‹¬ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

![](/images/posts/aws-alb-mtls-passthrough/01.png)
![](/images/posts/aws-alb-mtls-passthrough/02.png)

#### URL-encoded PEM with `+=/` as safe characters ë¡œ ì¸í•œ ì˜¤ë¥˜ âš¡ï¸

ì›ë˜ëŠ” NLBë¥¼ ì‚¬ìš©í•˜ë”ë¼ë„ AWS Elastic Beanstalk í™˜ê²½ì˜ Nginxì— ì „ë‹¬ë˜ëŠ” ì¸ì¦ì„œë¥¼ ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì „ë‹¬í•˜ê¸° ìœ„í•´ì„œ [$ssl_client_escaped_cert](https://nginx.org/en/docs/http/ngx_http_ssl_module.html?#var_ssl_client_escaped_cert) ë³€ìˆ˜ë¥¼ `X-SSL-CERT` í—¤ë”ì— í¬í•¨í•˜ì—¬ ì „ë‹¬í•˜ë©´ í—¤ë”ì˜ ê°’ì„ ì¶”ì¶œí•˜ì—¬ ì¸ì¦ì„œë¡œ ë³€í™˜í•˜ì—¬ ì‚¬ìš©í•˜ë„ë¡ ì¡°ì¹˜ë˜ì–´ ìˆì—ˆê¸°ì— `X-Amzn-Mtls-Clientcert` í—¤ë”ë¡œ ì „ë‹¬ë˜ëŠ” ì¸ì¦ì„œ ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ `X-SSL-CERT` í—¤ë”ì— ì „ë‹¬í•˜ëŠ” ì¡°ì¹˜ë¡œ í•´ê²°í•˜ë ¤ í–ˆìœ¼ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤. ì•Œê³ ë³´ë‹ˆ ì¼ë°˜ì ì¸ URL ì¸ì½”ë”©ì´ ì•„ë‹ˆë¼ +=/ ì™€ ê°™ì€ ì¼ë¶€ ë¬¸ìëŠ” ì¸ì½”ë”©ì—ì„œ ì œì™¸ë˜ì—ˆê¸° ë•Œë¬¸ì— ì½”ë“œì—ì„œ ì‚¬ìš©í•˜ê³  ìˆë˜ `URLDecoder`ë¡œ ë””ì½”ë”©í•˜ëŠ” ê²½ìš° ì˜¬ë°”ë¥´ì§€ ì•Šì€ ì¸ì¦ì„œê°€ ë˜ì–´ë²„ë¦¬ëŠ” ìƒí™©ì´ ë˜ì—ˆë‹¤.

> ìœ„ì™€ ê°™ì€ ìƒí™©ìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ìˆ˜ì •ì—†ì´ëŠ” ì¡°ì¹˜ê°€ ë¶ˆê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— X-SSL-CERT í—¤ë” ì´ì™¸ì— X-Amzn-Mtls-Clientcert ê°€ ìˆë‹¤ë©´ ì¸ì¦ì„œë¡œ ë³€í™˜í•˜ë„ë¡ í•˜ëŠ” ì½”ë“œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. ë˜í•œ, ê¸´ê¸‰í•œ ìƒí™©ì€ ì•„ë‹ˆì—ˆê¸°ì— ì˜ˆì •ëœ ë¦´ë¦¬ì¦ˆì— í¬í•¨í•´ì„œ ë°°í¬í•˜ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.

#### Tip. í´ë¼ì´ì–¸íŠ¸ ë˜ëŠ” ë¡œë“œë°¸ëŸ°ì„œì—ì„œ ì „ë‹¬í•œ ìš”ì²­ í—¤ë”ì˜ ê°’ì„ Nginxì—ì„œ ë‹¤ë¥¸ í—¤ë”ë¡œ ë°”ê¾¸ì–´ì„œ ì „ë‹¬í•˜ëŠ” ë°©ë²•

Nginx ì„¤ì •ì—ì„œ X-Amzn-Mtls-Clientcert í—¤ë”ì˜ ê°’ì„ X-SSL-CERT ìœ¼ë¡œ ì „ë‹¬í•˜ëŠ” ê²ƒì€ ì•„ë˜ì™€ ê°™ì´ í•  ìˆ˜ ìˆë‹¤.

```nginx.conf
server {
    underscores_in_headers on;
  
    location / {
        proxy_set_header X-SSL-CERT $http_x_amzn_mtls_clientcert;
    }
}
```

> í´ë¼ì´ì–¸íŠ¸ ë˜ëŠ” ë¡œë“œë°¸ëŸ°ì„œì—ì„œ ì „ë‹¬í•œ ì»¤ìŠ¤í…€ í—¤ë”ë¥¼ Nginx ì—ì„œ ë‹¤ì‹œ ì„¤ì •í•˜ì—¬ í¬í•¨ì‹œí‚¤ëŠ” ë°©ë²•ì„ ì°¾ê³  ìˆëŠ” ë¶„ì—ê²Œ ë„ì›€ì´ ë˜ê¸¸ ë°”ëë‹ˆë‹¤.

#### ê´€ë ¨ ë§í¬

- [Mutual authentication with TLS in Application Load Balancer](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/mutual-authentication.html)
- [Application Load Balancer ìƒí˜¸ ì¸ì¦ ê¸°ëŠ¥ â€“ ì¸ì¦ì„œ ê¸°ë°˜ í´ë¼ì´ì–¸íŠ¸ ID ì¸ì¦ ê°€ëŠ¥](https://aws.amazon.com/ko/blogs/korea/mutual-authentication-for-application-load-balancer-to-reliably-verify-certificate-based-client-identities/)
