---
title: AWS RDS μ¬λ΅μ° μΏΌλ¦¬ λ΅κ·Έμ μ»¤μ„ μ΄λ¦„ μ΄μ
date: 2024-06-20T22:00+09:00
tags:
- AWS RDS
- PostgreSQL
- Cursor
---

![](/images/posts/aws-rds-slow-query-with-cursor-name/01.png)

μ„ μ¤ν¬λ¦°μƒ·μ 14μ‹μ™€ 15μ‹ μ‚¬μ΄μ— RDS μ DB μΈμ¤ν„΄μ¤μ CPU λ¶€ν•κ°€ 90% μ΄μƒμ„ μ΄κ³Όν–λ‹¤. μ΄λ¬ν• μƒν™©μ κ²½μ° μ–΄λ–¤ νΈμ¤νΈμ—μ„ μν–‰ν• μΏΌλ¦¬κ°€ λ¬Έμ κ°€ λκ³  μλ”μ§€ μ•κΈ° μ„ν•΄μ„ AWS Aurora PostgreSQLμ ν΄λ¬μ¤ν„° λλ” μΈμ¤ν„΄μ¤ νλΌλ―Έν„°λ¥Ό λ³€κ²½ν•μ—¬ [μΏΌλ¦¬ λ΅κΉ…μ„ ν™μ„±ν™”](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/AuroraUserGuide/USER_LogAccess.Concepts.PostgreSQL.html#USER_LogAccess.Concepts.PostgreSQL.Query_Logging)ν•κ³  [log_min_duration_statement](https://docs.aws.amazon.com/ko_kr/prescriptive-guidance/latest/tuning-postgresql-parameters/log-min-duration-statement.html)μ— λ€ν• κ°’μ„ μ§€μ •ν•λ©΄ ν•΄λ‹Ή λ°€λ¦¬μ΄λ¥Ό μ΄κ³Όν•μ—¬ μν–‰ν• μΏΌλ¦¬μ— λ€ν• duration λ΅κ·Έλ¥Ό κΈ°λ΅ν•κ³  CloudWatchμ λ΅κ·Έ μΈμ‚¬μ΄νΈμ—μ„ ν™•μΈν•  μ μλ‹¤.

#### FETCH ALL IN \"rcursor\" π¤”

![](/images/posts/aws-rds-slow-query-with-cursor-name/02.png)

RDS μ½μ†”μ μ„±λ¥ κ°μ„  λ„μ°λ―Έμ—μ„ λ°μ΄ν„°λ² μ΄μ¤ λ΅λ“μ™€ μƒμ„ SQL μ •λ³΄λ¥Ό ν™•μΈν•  μ μλ”λ° μ„μ™€ κ°™μ΄ FETCH ALL IN \"rcursor\" κ°€ λ€λ¶€λ¶„μ λ΅λ“λ΅ κΈ°λ΅λμ–΄μλ” κ±Έ λ³Ό μ μλ‹¤. μ‹¤μ  SQLλ¥Ό ν™•μΈν•  μ μλ” κ²ƒλ“¤ μ΄μ™Έμ— `rcursor` λ€ κ²ƒμ€ λ„λ€μ²΄ λ¬΄μ—‡μ„ μλ―Έν•λ” κ²ƒμΈμ§€ μ•μ•„μ•Όν•  κ²ƒ κ°™λ‹¤. PL/pgSQL ν•¨μλ¥Ό μ‘μ„±ν•  λ• [Cursor](https://www.postgresql.org/docs/current/plpgsql-cursors.html)λ¥Ό μ„ μ–Έν•κ³  μ΅°νν• κ²°κ³Όλ¥Ό λ°ν™ν•  μ μλ‹¤. μΌλ°μ μΌλ΅ μ΄μ•ΌκΈ°ν•λ” ν”„λ΅μ‹μ € ν•¨μλ¥Ό μλ―Έν•λ©° μ• ν”λ¦¬μΌ€μ΄μ…μ—μ„ μ‚¬μ©μ¤‘μΈ λ€λ¶€λ¶„μ ν•¨μμ μ»¤μ„ μ΄λ¦„μ„ λ™μΌν•κ² μ§€μ •ν•μ—¬ μ„ μ–Έν–λ‹¤λ” κ²ƒμ„ μλ―Έν•λ‹¤.

κΈ°λ³Έμ μΌλ΅ μ»¤μ„ μ΄λ¦„μ„ μ§€μ •ν•μ§€ μ•μΌλ©΄ μλ™μΌλ΅ `<unnamed cursor 1>`μ™€ κ°™μ€ λλ¤ν• μ»¤μ„κ°€ λ§λ“¤μ–΄μ§€κ³  JDBC μ—μ„ SQL ν•¨μλ¥Ό νΈμ¶ν• κ²°κ³Όμ—μ„ μ»¤μ„ μ΄λ¦„μ„ κµ³μ΄ λ™μΌν•κ² μ§€μ •ν•  ν•„μ”λ” μ—†λ‹¤. λ”°λΌμ„, μ• ν”λ¦¬μΌ€μ΄μ…μ€ ν•¨μ μ •μ μ‹ μ–΄λ–¤ μ΄λ¦„μ μ»¤μ„λ¥Ό μ‚¬μ©ν•λ”μ§€μ— λ€ν•΄μ„λ” μƒκ΄€ν•μ§€ μ•μΌλ©° SQL ν•¨μλ¥Ό κ΄€λ¦¬ν•λ” κ°λ°μ νΉμ€ DBAκ°€ κ΄€λ¦¬ν•κΈ° μ„ν• μ΄λ¦„μΌ λΏμ΄λ‹¤. κ·Έλμ„ μ‰½κ² κ΄€λ¦¬ν•μ—¬ μ‚¬μ©ν•κΈ° μ„ν•΄ ν†µμΌν–λ κ²ƒμΌλ΅ μƒκ°λλ‹¤.

#### RDS λ¨λ‹ν„°λ§μ„ μ„ν• μ»¤μ„ μ΄λ¦„μ„ μ‚¬μ©ν•μ„Έμ”.

![](/images/posts/aws-rds-slow-query-with-cursor-name/03.png)

RDS λ¨λ‹ν„°λ§ λ° μ¬λ΅μ° μΏΌλ¦¬λ¥Ό ν™•μΈν•  μ μλ„λ΅ λ™μΌν• μ»¤μ„ μ΄λ¦„μ΄ μ•„λ‹ SQL ν•¨μλ³„ λ³„λ„μ μ»¤μ„ μ΄λ¦„μ„ μ •μν•μ—¬ κµ¬λ¶„ν•λ”κ² ν•„μ”ν•λ‹¤. SQL ν•¨μ μ‘μ„± μ‹ μ»¤μ„ μ΄λ¦„μ€ ν•¨μ μ΄λ¦„κ³Ό λ™μΌν•κ² ν•μ—¬ λ…ν™•ν κµ¬λ¶„ν•κΈ°λ΅ ν‘μν–κ³  μ„μ™€ κ°™μ΄ μ¤λ μν–‰λλ” μ¬λ΅μ° μΏΌλ¦¬λ¥Ό μ‰½κ² ν™•μΈν•  μ μλ‹¤. κΈ°μ΅΄μ—λ” κ°λ°μκ°€ μ¬λ΅μ° μΏΌλ¦¬λ¥Ό ν™•μΈν•  μ μλ„λ΅ μ• ν”λ¦¬μΌ€μ΄μ… μ„λ²„μ— λ΅κ·Έκ°€ μ¶λ ¥λλ„λ΅ ν–μ§€λ§ μ΄μ λ” κ°λ°μ λΏλ§ μ•„λ‹λΌ DB νΉμ€ μΈν”„λΌ μ—”μ§€λ‹μ–΄λ„ RDS λ¨λ‹ν„°λ§μΌλ΅ μ¬λ΅μ° μΏΌλ¦¬ κµ¬λ¶„μ΄ κ°€λ¥ν•λ„λ΅ λ³€κ²½ν•κ³  μλ‹¤.

```sh
# μ—¬λ¬λ¶„μ€ μ–΄λ–¤ μΏΌλ¦¬κ°€ 2μ΄λ‚ μ†μ”λ¬λ”μ§€ νμ•…ν•  μ μλ‚μ”?
LOG:  duration: 2217.321 ms  execute <unnamed>: FETCH ALL IN "rcursor"
```
