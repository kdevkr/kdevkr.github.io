<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png"><link rel="mask-icon" href="/images/favicon/favicon.ico" color="#222"><meta name="google-site-verification" content="LMcddVW6xLBS7X1htGQ3duOIEmVp4ljku8sd3UuIcBg"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Sans+KR:300,300italic,400,400italic,700,700italic%7CPretendard-Bold:300,300italic,400,400italic,700,700italic%7CPretendard-Medium:300,300italic,400,400italic,700,700italic%7CJetbrains+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-loading-bar.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"kdevkr.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.13.2","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"width":240,"scrollpercent":true,"b2t":true},"copycode":{"enable":false,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script><meta name="description" content="Failed to find access token  OAuth API 요청 시 JdbcTokenStore에서 액세스 토큰을 찾을 수 없을 때 기록되는 INFO 레벨의 로그 입니다. 액세스 토큰을 찾을 수 없다는 이야기는 올바르지 않은 요청인데도 불구하고 INFO 레벨로 되어있는 부분에 대해서는 의아하긴 합니다만 위 정보만으로는 어떤 토큰에 의해서 어떠한"><meta property="og:type" content="article"><meta property="og:title" content="Trace OAuth Requests"><meta property="og:url" content="https://kdevkr.github.io/trace-oauth-requests/index.html"><meta property="og:site_name" content="Mambo"><meta property="og:description" content="Failed to find access token  OAuth API 요청 시 JdbcTokenStore에서 액세스 토큰을 찾을 수 없을 때 기록되는 INFO 레벨의 로그 입니다. 액세스 토큰을 찾을 수 없다는 이야기는 올바르지 않은 요청인데도 불구하고 INFO 레벨로 되어있는 부분에 대해서는 의아하긴 합니다만 위 정보만으로는 어떤 토큰에 의해서 어떠한"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2022-08-09T15:00:00.000Z"><meta property="article:modified_time" content="2023-12-02T14:52:11.019Z"><meta property="article:author" content="Mambo"><meta property="article:tag" content="HttpTrace"><meta property="article:tag" content="ContentCaching"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://kdevkr.github.io/trace-oauth-requests/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://kdevkr.github.io/trace-oauth-requests/","path":"trace-oauth-requests/","title":"Trace OAuth Requests"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Trace OAuth Requests | Mambo</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-V8LF04VMBF"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-V8LF04VMBF","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="Mambo" type="application/atom+xml">
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope itemtype="http://schema.org/WebPage"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Mambo</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Today I Learned 🔥</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fas fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fas fa-archive fa-fw"></i>Archives<span class="badge">109</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fas fa-user fa-fw"></i>About</a></li></ul></nav></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Bearer-Authentication"><span class="nav-number">1.</span> <span class="nav-text">Bearer Authentication</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OAuth2AuthenticationProcessingFilter"><span class="nav-number">1.1.</span> <span class="nav-text">OAuth2AuthenticationProcessingFilter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AbstractRequestLoggingFilter"><span class="nav-number">1.2.</span> <span class="nav-text">AbstractRequestLoggingFilter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HttpTraceFilter"><span class="nav-number">1.3.</span> <span class="nav-text">HttpTraceFilter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OAuthFilter"><span class="nav-number">1.4.</span> <span class="nav-text">OAuthFilter</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EC%B0%B8%EA%B3%A0"><span class="nav-number">2.</span> <span class="nav-text">참고</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Mambo" src="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4"><p class="site-author-name" itemprop="name">Mambo</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">109</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-tags"><span class="site-state-item-count">164</span> <span class="site-state-item-name">tags</span></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/kdevkr" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kdevkr" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:kdevkr@gmail.com" title="E-Mail → mailto:kdevkr@gmail.com" rel="noopener" target="_blank"><i class="fas fa-envelope fa-fw"></i>E-Mail</a></span></div><div class="cc-license site-overview-item animated" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ko" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div><div class="back-to-top animated" role="button" aria-label="Back to top"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div class="sidebar-dimmer"></div></header><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://kdevkr.github.io/trace-oauth-requests/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars1.githubusercontent.com/u/17937604?s=460&v=4"><meta itemprop="name" content="Mambo"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Mambo"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Trace OAuth Requests | Mambo"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Trace OAuth Requests</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2022-08-10 00:00:00" itemprop="dateCreated datePublished" datetime="2022-08-10T00:00:00+09:00">2022-08-10</time></span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>Failed to find access token</p></blockquote><p>OAuth API 요청 시 JdbcTokenStore에서 액세스 토큰을 찾을 수 없을 때 기록되는 INFO 레벨의 로그 입니다. 액세스 토큰을 찾을 수 없다는 이야기는 올바르지 않은 요청인데도 불구하고 INFO 레벨로 되어있는 부분에 대해서는 의아하긴 합니다만 위 정보만으로는 어떤 토큰에 의해서 어떠한 OAuth API에 대해 요청되었는지를 확인할 수 없습니다.</p><p>일반적으로 인프라 레벨에서 <a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/application/load-balancer-access-logs.html">ELB</a> 또는 <a target="_blank" rel="noopener" href="https://docs.nginx.com/nginx/admin-guide/monitoring/logging/#setting-up-the-access-log">Nginx</a>와 같은 프록시 단계에서 액세스 로그를 남기는데 대부분의 액세스 로그에서는 요청 헤더 정보를 상세하게 기록하지 않고 간결하게 남기도록 설정되므로 토큰 정보가 포함되는 Authorization 헤더를 확인할 수 없습니다.</p><h2 id="Bearer-Authentication"><a href="#Bearer-Authentication" class="headerlink" title="Bearer Authentication"></a>Bearer Authentication</h2><p>현재 시스템은 Spring Security OAuth 모듈을 통해 JDBC 기반의 Opaque 토큰으로 되어있는 Bearer 인증을 지원하는 OpenAPI를 제공하고 있습니다. 그러나, 일부 사용자들이 IoT 디바이스를 구현 시 OpenAPI를 사용할 때 잘못된 토큰을 사용하는 문제가 사업팀으로부터 리포트 되었는데 단순하게 잘못된 액세스 토큰이 전달되었다는 로그에 대해서 원인 파악을 요구하는데 불구하고 파악할 수 있는 정보가 남아있지 않았습니다.</p><p>사실 OpenAPI의 각 핸들러로 전달되는 부분에 대해서는 AOP가 적용되어 핸들러에 대한 파라미터 들과 클라이언트 아이디와 토큰 정보를 이미 엘라스틱서치에 API 로그로 저장하고 있었습니다. 다만 문제는 잘못된 토큰에 대한 요청은 스프링 시큐리티 필터 체인에 의해서 핸들러까지 진입하기 전에 오류 응답으로 처리되었기에 API 로그가 남지 않았다는 것이 파악되었습니다.</p><blockquote><p>어떠한 문제에 대해서 파악할 수 있는 정보는 남겨야하므로 인증된 사용자가 OpenAPI를 사용한 로그 외에 OAuth에 대한 모든 요청에 대해서는 별도로 남기도록 개선하고자 하였습니다.</p></blockquote><h3 id="OAuth2AuthenticationProcessingFilter"><a href="#OAuth2AuthenticationProcessingFilter" class="headerlink" title="OAuth2AuthenticationProcessingFilter"></a>OAuth2AuthenticationProcessingFilter</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">eventPublisher.publishAuthenticationFailure(<span class="keyword">new</span> <span class="title class_">BadCredentialsException</span>(failed.getMessage(), failed),</span><br><span class="line">					<span class="keyword">new</span> <span class="title class_">PreAuthenticatedAuthenticationToken</span>(<span class="string">&quot;access-token&quot;</span>, <span class="string">&quot;N/A&quot;</span>));</span><br></pre></td></tr></table></figure><p>Bearer 토큰에 대한 인증을 처리하는 OAuth2AuthenticationProcessingFilter에서 AuthenticationEventPublisher를 사용하여 인증 성공이나 오류에 대한 이벤트를 발생시키므로 DefaultAuthenticationEventPublisher를 빈으로 등록하고 이벤트 리스너를 구현하면 어떤 토큰을 사용하여 요청했는지는 기록할 수 있는데 이벤트 리스너로 전달되는 이벤트 정보에는 요청과 응답에 대한 정보가 존재하지 않으므로 원하는 만큼의 정보를 로그로 기록할 수 없습니다.</p><blockquote><p>원하는 기능은 대부분 인터넷에 검색하면 나오기에 이리저리 찾아보았습니다.</p></blockquote><h3 id="AbstractRequestLoggingFilter"><a href="#AbstractRequestLoggingFilter" class="headerlink" title="AbstractRequestLoggingFilter"></a>AbstractRequestLoggingFilter</h3><p>AbstractRequestLoggingFilter.getMessagePayload 함수를 보면 내부적으로 ContentCachingRequestWrapper를 사용하는 것을 확인할 수 있는데 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/util/ContentCachingResponseWrapper.html">ContentCachingResponseWrapper</a>에 대해서 살펴보니 요청에 대한 응답을 내려준 이후에도 응답 페이로드를 읽을 수 있도록 지원한다는 내용을 확인했습니다.</p><blockquote><p>잘못된 토큰에 대한 요청의 응답으로 액세스 토큰 정보를 전달하므로 응답 페이로드를 가져올 수 있다면 사용된 토큰을 로그로써 확인할 수 있다는 이야기입니다.</p></blockquote><h3 id="HttpTraceFilter"><a href="#HttpTraceFilter" class="headerlink" title="HttpTraceFilter"></a>HttpTraceFilter</h3><p>Spring Boot Actuator 모듈을 사용하여 어드민 페이지를 구현해놓았기에 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.tracing">HttpTraceEndpoint</a>를 통해서 일부 요청에 대한 트레이스 정보를 확인할 수 있는 점을 떠올려 HttpTraceFilter를 살펴보니 TraceableHttpServletRequest와 TraceableHttpServletResponse를 사용하여 요청과 응답에 대한 정보를 가져오는 것을 확인할 수 있었습니다.</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span><br><span class="line">        <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isRequestValid(request)) &#123;</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">TraceableHttpServletRequest</span> <span class="variable">traceableRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TraceableHttpServletRequest</span>(request);</span><br><span class="line">    <span class="type">HttpTrace</span> <span class="variable">trace</span> <span class="operator">=</span> <span class="built_in">this</span>.tracer.receivedRequest(traceableRequest);</span><br><span class="line">    <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> HttpStatus.INTERNAL_SERVER_ERROR.value();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">        status = response.getStatus();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="type">TraceableHttpServletResponse</span> <span class="variable">traceableResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TraceableHttpServletResponse</span>(</span><br><span class="line">                (status != response.getStatus()) ? <span class="keyword">new</span> <span class="title class_">CustomStatusResponseWrapper</span>(response, status) : response);</span><br><span class="line">        <span class="built_in">this</span>.tracer.sendingResponse(trace, traceableResponse, request::getUserPrincipal,</span><br><span class="line">                () -&gt; getSessionId(request));</span><br><span class="line">        <span class="built_in">this</span>.repository.add(trace);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>단, TraceableHttpServletRequest와 TraceableHttpServletResponse는 final 키워드가 설정된 클래스이므로 다른 패키지에서 활용할 수 없습니다.</p></blockquote><h3 id="OAuthFilter"><a href="#OAuthFilter" class="headerlink" title="OAuthFilter"></a>OAuthFilter</h3><p>앞서 살펴본 클래스들을 종합하여 OAuth 요청과 응답에 대한 정보를 이벤트로 발생시키는 필터를 구현합니다.</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OAuthFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> <span class="keyword">implements</span> <span class="title class_">ApplicationEventPublisherAware</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AntPathMatcher</span> <span class="variable">pathMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathMatcher</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpExchangeTracer tracer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DefaultTokenServices defaultTokenServices;</span><br><span class="line">    <span class="keyword">private</span> ApplicationEventPublisher applicationEventPublisher;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OAuthFilter</span><span class="params">(HttpTraceProperties traceProperties, DefaultTokenServices defaultTokenServices)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.tracer = <span class="keyword">new</span> <span class="title class_">HttpExchangeTracer</span>(traceProperties.getInclude());</span><br><span class="line">        <span class="built_in">this</span>.defaultTokenServices = defaultTokenServices;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">        <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> request.getMethod();</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isApiV1</span> <span class="operator">=</span> pathMatcher.match(<span class="string">&quot;/oauth/v1/**&quot;</span>, requestURI);</span><br><span class="line">        <span class="keyword">if</span> (isApiV1) &#123;</span><br><span class="line">            <span class="type">TraceableHttpServletRequest</span> <span class="variable">traceableRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TraceableHttpServletRequest</span>(request);</span><br><span class="line">            <span class="type">ContentCachingResponseWrapper</span> <span class="variable">cachingResponseWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentCachingResponseWrapper</span>(response);</span><br><span class="line"></span><br><span class="line">            <span class="type">HttpTrace</span> <span class="variable">trace</span> <span class="operator">=</span> <span class="built_in">this</span>.tracer.receivedRequest(traceableRequest);</span><br><span class="line">            <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> HttpStatus.INTERNAL_SERVER_ERROR.value();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                filterChain.doFilter(request, cachingResponseWrapper);</span><br><span class="line">                status = response.getStatus();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="type">TraceableHttpServletResponse</span> <span class="variable">traceableResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TraceableHttpServletResponse</span>(</span><br><span class="line">                        (status != response.getStatus()) ? <span class="keyword">new</span> <span class="title class_">CustomStatusResponseWrapper</span>(cachingResponseWrapper, status) : cachingResponseWrapper);</span><br><span class="line">                <span class="built_in">this</span>.tracer.sendingResponse(trace, traceableResponse, request::getUserPrincipal,</span><br><span class="line">                        () -&gt; getSessionId(request));</span><br><span class="line"></span><br><span class="line">                <span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (applicationEventPublisher != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">tokenValue</span> <span class="operator">=</span> (String) request.getAttribute(OAuth2AuthenticationDetails.ACCESS_TOKEN_VALUE);</span><br><span class="line">                        <span class="type">OAuth2Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> defaultTokenServices.loadAuthentication(tokenValue);</span><br><span class="line">                        clientId = authentication.getOAuth2Request().getClientId();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InvalidTokenException ignored) &#123;&#125;</span><br><span class="line">                    applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">OAuthTraceEvent</span>(trace, traceableResponse.getResponseBody(), clientId));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            filterChain.doFilter(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getSessionId</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> (session != <span class="literal">null</span>) ? session.getId() : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher applicationEventPublisher)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.applicationEventPublisher = applicationEventPublisher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TraceableHttpServletRequest</span> <span class="keyword">implements</span> <span class="title class_">TraceableRequest</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> HttpServletRequest request;</span><br><span class="line"></span><br><span class="line">        TraceableHttpServletRequest(HttpServletRequest request) &#123;</span><br><span class="line">            <span class="built_in">this</span>.request = request;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getMethod</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.request.getMethod();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> URI <span class="title function_">getUri</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">queryString</span> <span class="operator">=</span> <span class="built_in">this</span>.request.getQueryString();</span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.hasText(queryString)) &#123;</span><br><span class="line">                <span class="keyword">return</span> URI.create(<span class="built_in">this</span>.request.getRequestURL().toString());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">StringBuffer</span> <span class="variable">urlBuffer</span> <span class="operator">=</span> appendQueryString(queryString);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">URI</span>(urlBuffer.toString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (URISyntaxException ex) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">encoded</span> <span class="operator">=</span> UriUtils.encodeQuery(queryString, StandardCharsets.UTF_8);</span><br><span class="line">                <span class="type">StringBuffer</span> <span class="variable">urlBuffer</span> <span class="operator">=</span> appendQueryString(encoded);</span><br><span class="line">                <span class="keyword">return</span> URI.create(urlBuffer.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> StringBuffer <span class="title function_">appendQueryString</span><span class="params">(String queryString)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.request.getRequestURL().append(<span class="string">&quot;?&quot;</span>).append(queryString);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">getHeaders</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> extractHeaders();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getRemoteAddress</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.request.getRemoteAddr();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">extractHeaders</span><span class="params">()</span> &#123;</span><br><span class="line">            Map&lt;String, List&lt;String&gt;&gt; headers = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">            Enumeration&lt;String&gt; names = <span class="built_in">this</span>.request.getHeaderNames();</span><br><span class="line">            <span class="keyword">while</span> (names.hasMoreElements()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> names.nextElement();</span><br><span class="line">                headers.put(name, Collections.list(<span class="built_in">this</span>.request.getHeaders(name)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> headers;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TraceableHttpServletResponse</span> <span class="keyword">implements</span> <span class="title class_">TraceableResponse</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> HttpServletResponse delegate;</span><br><span class="line"></span><br><span class="line">        TraceableHttpServletResponse(HttpServletResponse response) &#123;</span><br><span class="line">            <span class="built_in">this</span>.delegate = response;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStatus</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.delegate.getStatus();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">getHeaders</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> extractHeaders();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">extractHeaders</span><span class="params">()</span> &#123;</span><br><span class="line">            Map&lt;String, List&lt;String&gt;&gt; headers = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (String name : <span class="built_in">this</span>.delegate.getHeaderNames()) &#123;</span><br><span class="line">                headers.put(name, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="built_in">this</span>.delegate.getHeaders(name)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> headers;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getResponseBody</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.delegate <span class="keyword">instanceof</span> ContentCachingResponseWrapper) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="type">ContentCachingResponseWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> (ContentCachingResponseWrapper) <span class="built_in">this</span>.delegate;</span><br><span class="line">                <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> wrapper.getStatus();</span><br><span class="line">                <span class="type">byte</span>[] buf = wrapper.getContentAsByteArray();</span><br><span class="line">                <span class="keyword">if</span> (status != <span class="number">200</span> &amp;&amp; buf.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    body = <span class="keyword">new</span> <span class="title class_">String</span>(buf, <span class="number">0</span>, buf.length, wrapper.getCharacterEncoding());</span><br><span class="line">                &#125;</span><br><span class="line">                wrapper.copyBodyToResponse();</span><br><span class="line">                <span class="keyword">return</span> body;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">CustomStatusResponseWrapper</span> <span class="keyword">extends</span> <span class="title class_">HttpServletResponseWrapper</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> status;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">CustomStatusResponseWrapper</span><span class="params">(HttpServletResponse response, <span class="type">int</span> status)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(response);</span><br><span class="line">            <span class="built_in">this</span>.status = status;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStatus</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>잘못된 토큰에 대한 응답 처리는 OAuth2AuthenticationProcessingFilter에서 OAuthException을 던지게 되면서 수행하므로 우리는 그전에 응답 페이로드를 캐시하여 가져올 수 있도록 ContentCachingResponseWrapper를 이후 필터로 전달했습니다.</p><h4 id="OAuthTraceEvent"><a href="#OAuthTraceEvent" class="headerlink" title="OAuthTraceEvent"></a>OAuthTraceEvent</h4><p>OAuthTraceEvent는 OAuth API에 대한 요청과 응답 정보에서 올바른 토큰으로 요청된 것은 클라이언트 아이디가 존재하므로 요청 헤더 중 Authorization에 포함된 토큰까지 로그로 저장할 필요는 없습니다. 토큰 자체를 제외하기 보다는 토큰의 일부를 마스킹 처리하는 방향으로 구현하였습니다.</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OAuthTraceEvent</span> <span class="keyword">extends</span> <span class="title class_">ApplicationEvent</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpTrace.Request request;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpTrace.Response response;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpTrace.Principal principal;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpTrace.Session session;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String responseBody;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String clientId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> timeTaken;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> traceTimestamp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OAuthTraceEvent</span><span class="params">(HttpTrace trace, String responseBody, <span class="meta">@Nullable</span> String clientId)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(trace);</span><br><span class="line">        <span class="built_in">this</span>.clientId = clientId;</span><br><span class="line">        <span class="keyword">if</span> (clientId != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span> .equals(clientId)) &#123;</span><br><span class="line">            protectAuthorization(trace);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.timeTaken = trace.getTimeTaken();</span><br><span class="line">        <span class="built_in">this</span>.request = trace.getRequest();</span><br><span class="line">        <span class="built_in">this</span>.response = trace.getResponse();</span><br><span class="line">        <span class="built_in">this</span>.principal = trace.getPrincipal();</span><br><span class="line">        <span class="built_in">this</span>.session = trace.getSession();</span><br><span class="line">        <span class="built_in">this</span>.responseBody = responseBody;</span><br><span class="line">        <span class="built_in">this</span>.traceTimestamp = trace.getTimestamp().toEpochMilli();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">protectAuthorization</span><span class="params">(HttpTrace trace)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (clientId != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span> .equals(clientId)) &#123;</span><br><span class="line">            Map&lt;String, List&lt;String&gt;&gt; headers = trace.getRequest().getHeaders();</span><br><span class="line">            List&lt;String&gt; authorization = headers.get(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; authorization.size(); i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> authorization.get(i);</span><br><span class="line">                <span class="keyword">if</span> (s.startsWith(<span class="string">&quot;Bearer&quot;</span>) || s.startsWith(<span class="string">&quot;bearer&quot;</span>)) &#123;</span><br><span class="line">                    s = s.replaceAll(<span class="string">&quot;(?&lt;=.&#123;19&#125;).&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">                    authorization.set(i, s);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이제 우리는 OAuthTraceEvent를 처리하는 이벤트 리스너에서 애플리케이션 로그 또는 엘라스틱서치에 저장하도록 구현하면 됩니다.</p><h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul><li><a target="_blank" rel="noopener" href="https://www.baeldung.com/spring-http-logging">Spring – Log Incoming Requests</a></li><li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.tracing">Production-ready Features - 8. HTTP Tracing</a></li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/HttpTrace/" rel="tag"># HttpTrace</a> <a href="/tags/ContentCaching/" rel="tag"># ContentCaching</a></div><div class="post-nav"><div class="post-nav-item"><a href="/undertow-temp-dir/" rel="prev" title="언더토우 임시 디렉토리 삭제 방지"><i class="fa fa-chevron-left"></i> 언더토우 임시 디렉토리 삭제 방지</a></div><div class="post-nav-item"><a href="/undertow-websocket-tracing/" rel="next" title="Tracing Handshake Websocket With Undertow">Tracing Handshake Websocket With Undertow <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments giscus-container"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Mambo</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script src="/js/third-party/fancybox.js"></script><script src="/js/third-party/pace.js"></script><script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script><script>var options={bottom:"unset",right:"15px",left:"unset",time:"0.5s",mixColor:"transparent",backgroundColor:"transparent",buttonColorDark:"#100f2c",buttonColorLight:"#fff",saveInCookies:!0,label:"🌗",autoMatchOsTheme:!0};const darkmode=new Darkmode(options);window.darkmode=darkmode,darkmode.showWidget()</script><script class="next-config" data-name="giscus" type="application/json">{"enable":true,"repo":"kdevkr/kdevkr.github.io","repo_id":"MDEwOlJlcG9zaXRvcnkxNTQxNjA4OTA=","category":"Announcements","category_id":"DIC_kwDOCTBO-s4CYmQM","mapping":"pathname","reactions_enabled":1,"emit_metadata":1,"theme":"light","lang":"ko","crossorigin":"anonymous","input_position":"bottom","loading":"lazy"}</script><script>document.addEventListener("page:loaded",()=>{CONFIG.page.comments&&NexT.utils.loadComments(".giscus-container").then(()=>NexT.utils.getScript("https://giscus.app/client.js",{attributes:{async:!0,crossOrigin:"anonymous","data-repo":CONFIG.giscus.repo,"data-repo-id":CONFIG.giscus.repo_id,"data-category":CONFIG.giscus.category,"data-category-id":CONFIG.giscus.category_id,"data-mapping":CONFIG.giscus.mapping,"data-reactions-enabled":CONFIG.giscus.reactions_enabled,"data-emit-metadata":CONFIG.giscus.emit_metadata,"data-theme":CONFIG.giscus.theme,"data-lang":CONFIG.giscus.lang,"data-input-position":CONFIG.giscus.input_position,"data-loading":CONFIG.giscus.loading},parentNode:document.querySelector(".giscus-container")}))})</script></body></html>